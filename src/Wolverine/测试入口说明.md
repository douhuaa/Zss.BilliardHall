# Wolverine 项目测试入口说明

## 概述

本文档说明 Wolverine 项目的测试入口位置和运行方式。

## 测试项目位置

当前 Wolverine 项目包含 **1 个测试项目**：

### 1. Zss.BilliardHall.Wolverine.ServiceDefaults.Tests

**路径**: `src/Wolverine/Aspire/Zss.BilliardHall.Wolverine.ServiceDefaults.Tests/`

**项目文件**: `Zss.BilliardHall.Wolverine.ServiceDefaults.Tests.csproj`

**测试框架**: xUnit

**测试内容**: 
- ServiceDefaults 扩展方法集成测试
- Marten 配置测试
- OpenTelemetry 配置测试
- HealthChecks 配置测试
- Wolverine 默认配置测试

**包含的测试文件**:
1. `MartenExtensionsTests.cs` - Marten 扩展方法测试（7个测试用例）
2. `ServiceDefaultsIntegrationTests.cs` - ServiceDefaults 集成测试（12个测试用例）

## 测试用例列表

### MartenExtensionsTests (7个测试)
1. `AddMartenDefaults_WithValidConnectionString_ShouldRegisterMartenServices` - 验证使用有效连接字符串注册 Marten 服务
2. `AddMartenDefaults_WithMissingConnectionString_ShouldThrowInvalidOperationException` - 验证缺少连接字符串时抛出异常
3. `AddMartenDefaults_ShouldConfigureSchemaName` - 验证配置 Schema 名称为 "billiard"
4. `AddMartenDefaults_ShouldUseProvidedConnectionString` - 验证使用提供的连接字符串
5. `AddMartenDefaults_WithValidConfiguration_ShouldSucceed` - 验证有效配置成功
6. `AddMartenDefaults_WithEmptyConnectionString_ShouldThrowInvalidOperationException` - 验证空连接字符串时抛出异常
7. `AddMartenDefaults_ShouldConfigureLightweightSessions` - 验证配置轻量级会话

### ServiceDefaultsIntegrationTests (12个测试)
1. `AddServiceDefaults_ShouldRegisterAllRequiredServices` - 验证注册所有必需服务
2. `AddDefaultHealthChecks_ShouldRegisterSelfCheck` - 验证注册 "self" 健康检查
3. `AddDefaultHealthChecks_SelfCheck_ShouldReturnHealthy` - 验证 "self" 检查返回健康状态
4. `ConfigureOpenTelemetry_ShouldRegisterTracingAndMetrics` - 验证配置 OpenTelemetry 追踪和指标
5. `MapDefaultEndpoints_InDevelopment_ShouldMapHealthCheckEndpoints` - 验证开发环境映射健康检查端点
6. `MapDefaultEndpoints_InProduction_ShouldNotMapHealthCheckEndpoints` - 验证生产环境不映射健康检查端点
7. `AddServiceDefaults_ShouldConfigureHttpClientWithResilience` - 验证配置 HttpClient 弹性
8. `AddServiceDefaults_ShouldBeIdempotent` - 验证 AddServiceDefaults 幂等性
9. `AddWolverineDefaults_ShouldRegisterWolverineServices` - 验证注册 Wolverine 服务
10. `AddWolverineDefaults_ShouldEnableFluentValidation` - 验证启用 FluentValidation
11. `AddWolverineDefaults_WithServiceDefaults_ShouldWorkTogether` - 验证 ServiceDefaults 和 WolverineDefaults 协同工作
12. `AddWolverineDefaults_CalledMultipleTimes_ShouldThrow` - 验证多次调用 AddWolverineDefaults 抛出异常

**共计: 19 个测试用例**

## 如何运行测试

### 1. 运行所有测试

从 Wolverine 项目根目录运行：

```bash
cd src/Wolverine
dotnet test
```

### 2. 列出所有测试（不运行）

```bash
cd src/Wolverine
dotnet test --list-tests
```

### 3. 运行特定测试项目

```bash
cd src/Wolverine
dotnet test Aspire/Zss.BilliardHall.Wolverine.ServiceDefaults.Tests/Zss.BilliardHall.Wolverine.ServiceDefaults.Tests.csproj
```

### 4. 运行特定测试类

```bash
cd src/Wolverine
dotnet test --filter "FullyQualifiedName~MartenExtensionsTests"
```

### 5. 运行特定测试方法

```bash
cd src/Wolverine
dotnet test --filter "FullyQualifiedName=Zss.BilliardHall.Wolverine.ServiceDefaults.Tests.MartenExtensionsTests.AddMartenDefaults_WithValidConnectionString_ShouldRegisterMartenServices"
```

### 6. 运行测试并显示详细输出

```bash
cd src/Wolverine
dotnet test --verbosity normal
```

或者更详细：

```bash
cd src/Wolverine
dotnet test --verbosity detailed
```

## 测试项目依赖

测试项目依赖以下 NuGet 包：

- `Microsoft.NET.Test.Sdk` - .NET 测试 SDK
- `xunit` - xUnit 测试框架
- `xunit.runner.visualstudio` - Visual Studio 测试运行器
- `FluentAssertions` - 流畅断言库
- `Microsoft.AspNetCore.Mvc.Testing` - ASP.NET Core 测试支持
- `Marten` - Marten 文档数据库
- `WolverineFx.Http` - Wolverine HTTP 支持

## 项目引用

测试项目引用：

- `Zss.BilliardHall.Wolverine.ServiceDefaults` - 被测试的 ServiceDefaults 项目

## 未来测试计划

根据 `README.md` 中的待办事项，未来将添加以下测试：

### 阶段一：Bootstrapper 配置测试
- Wolverine 配置测试
- Marten 文档数据库配置测试
- Serilog 日志配置测试
- HTTP 端点扫描测试

### 阶段二：Members 模块测试
- RegisterMember 功能测试
- GetMember 查询测试
- MemberRegistered 事件测试

### 阶段三：其他模块测试
- Tables 模块测试
- Sessions 模块测试

### 阶段四：集成测试
- 创建集成测试项目
- 核心功能端到端测试
- 应用启动验证测试

## 测试最佳实践

参考以下开发规范：

- [代码风格规范](../../../doc/06_开发规范/代码风格.md)
- [FluentValidation集成指南](../../../doc/06_开发规范/FluentValidation集成指南.md)
- [单元测试计划](../../../doc/09_测试方案/单元测试计划.md)
- [集成测试计划](../../../doc/09_测试方案/集成测试计划.md)

### 测试命名规范

测试方法命名遵循模式：`MethodName_Condition_ExpectedResult`

示例：
- `AddMartenDefaults_WithValidConnectionString_ShouldRegisterMartenServices`
- `AddServiceDefaults_ShouldRegisterAllRequiredServices`

### 测试组织

- 使用 **Arrange-Act-Assert** 模式组织测试
- 每个测试聚焦单一功能点
- 使用 FluentAssertions 编写清晰的断言
- 添加中英文注释说明测试意图

## 持续集成

测试应该在 CI/CD 流程中自动运行。确保所有测试在合并前通过。

## 相关文档

- [Wolverine快速上手指南](../../../doc/03_系统架构设计/Wolverine快速上手指南.md)
- [Wolverine模块化架构蓝图](../../../doc/03_系统架构设计/Wolverine模块化架构蓝图.md)
- [ServiceDefaults集成指南](../../../doc/06_开发规范/ServiceDefaults集成指南.md)
- [测试方案文档](../../../doc/09_测试方案/)

---

**最后更新**: 2026-01-11  
**版本**: 1.0.0  
**状态**: 当前仅有 ServiceDefaults.Tests 项目，未来将扩展
