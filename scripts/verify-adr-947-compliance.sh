#!/bin/bash
# ADR-947 ä¸“ç”¨ Guardï¼šå…³ç³»å£°æ˜åŒºçš„ç»“æ„ä¸è§£æå®‰å…¨è§„åˆ™
# æ ¹æ® ADR-947 å®ç°äº”å¤§æ¡æ¬¾éªŒè¯

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
ADR_DIR="$REPO_ROOT/docs/adr"

echo "ğŸ” ADR-947 åˆè§„æ€§æ£€æŸ¥..."
echo ""

# å¯ç”¨è°ƒè¯•æ¨¡å¼
[ "${DEBUG:-}" = "1" ] && set -x

errors=0
warnings=0

# ============================================================================
# æ¡æ¬¾ 1ï¼šå”¯ä¸€é¡¶çº§å…³ç³»åŒºåŸåˆ™
# ============================================================================
echo "ğŸ“‹ æ£€æŸ¥æ¡æ¬¾ 1ï¼šå”¯ä¸€é¡¶çº§å…³ç³»åŒºåŸåˆ™..."

while IFS= read -r adr_file; do
    adr_name=$(basename "$adr_file")
    
    # è®¡ç®— "## å…³ç³»å£°æ˜" å‡ºç°æ¬¡æ•°ï¼ˆå¿…é¡»ç²¾ç¡®åŒ¹é…è¡Œé¦–ï¼‰
    count=$(grep -c "^## å…³ç³»å£°æ˜" "$adr_file" || true)
    
    if [ "$count" -gt 1 ]; then
        echo "âŒ è¿åæ¡æ¬¾ 1ï¼š$adr_name"
        echo "   å‘ç° $count ä¸ªé¡¶çº§å…³ç³»å£°æ˜åŒºï¼ˆåªå…è®¸ 1 ä¸ªï¼‰"
        echo "   ä¿®å¤ï¼šåˆ é™¤é‡å¤çš„ ## å…³ç³»å£°æ˜ï¼Œæ¨¡æ¿ç¤ºä¾‹ä½¿ç”¨ ### æˆ–æ›´ä½çº§åˆ«"
        echo ""
        ((errors++))
    fi
    
    # æ£€æŸ¥æ˜¯å¦åœ¨æ¨¡æ¿/ç¤ºä¾‹ä¸­ä½¿ç”¨äº† ## å…³ç³»å£°æ˜
    # æ£€æµ‹æ¨¡å¼ï¼šä»£ç å—å†…å‡ºç° "## å…³ç³»å£°æ˜"
    if grep -q '```.*## å…³ç³»å£°æ˜' "$adr_file"; then
        echo "âš ï¸  è­¦å‘Šæ¡æ¬¾ 1ï¼š$adr_name"
        echo "   ä»£ç å—ä¸­ä½¿ç”¨äº† ## å…³ç³»å£°æ˜ï¼ˆå»ºè®®ä½¿ç”¨å ä½ç¬¦æˆ–é™çº§ï¼‰"
        echo ""
        ((warnings++))
    fi
done < <(find "$ADR_DIR" -name "ADR-*.md" -not -name "README.md" -not -path "*/proposals/*" | sort)

# ============================================================================
# æ¡æ¬¾ 2ï¼šå…³ç³»åŒºè¾¹ç•Œå³æ ‡é¢˜è¾¹ç•Œ
# ============================================================================
echo "ğŸ“‹ æ£€æŸ¥æ¡æ¬¾ 2ï¼šå…³ç³»åŒºè¾¹ç•Œå³æ ‡é¢˜è¾¹ç•Œ..."

while IFS= read -r adr_file; do
    adr_name=$(basename "$adr_file")
    
    # æå–å…³ç³»å£°æ˜åŒºå†…å®¹
    if grep -q "^## å…³ç³»å£°æ˜" "$adr_file"; then
        # æ£€æŸ¥å…³ç³»åŒºå†…æ˜¯å¦åŒ…å«å­æ ‡é¢˜ï¼ˆ### æˆ– ####ï¼‰
        relation_section=$(sed -n '/^## å…³ç³»å£°æ˜/,/^## /p' "$adr_file")
        
        if echo "$relation_section" | grep -q "^###"; then
            echo "âŒ è¿åæ¡æ¬¾ 2ï¼š$adr_name"
            echo "   å…³ç³»å£°æ˜åŒºå†…åŒ…å«å­æ ‡é¢˜ï¼ˆ###ï¼‰"
            echo "   ä¿®å¤ï¼šå­æ ‡é¢˜åº”ç§»åˆ°å…³ç³»å£°æ˜åŒºå¤–"
            echo ""
            ((errors++))
        fi
        
        # æ£€æŸ¥å…³ç³»åŒºå†…æ˜¯å¦åŒ…å«è¯´æ˜æ€§æ®µè½ï¼ˆéåˆ—è¡¨çš„å¤šè¡Œæ–‡æœ¬ï¼‰
        # ç®€åŒ–æ£€æŸ¥ï¼šå¦‚æœæœ‰éåˆ—è¡¨ã€éç©ºè¡Œã€éæ ‡é¢˜çš„è¡Œè¶…è¿‡1è¡Œï¼Œè§†ä¸ºè¯´æ˜æ€§æ–‡æœ¬
        non_list_lines=$(echo "$relation_section" | grep -v "^[-*]" | grep -v "^$" | grep -v "^##" | grep -v "^\*\*" | wc -l)
        
        if [ "$non_list_lines" -gt 3 ]; then
            echo "âš ï¸  è­¦å‘Šæ¡æ¬¾ 2ï¼š$adr_name"
            echo "   å…³ç³»å£°æ˜åŒºå¯èƒ½åŒ…å«è¯´æ˜æ€§æ®µè½"
            echo "   å»ºè®®ï¼šä»…ä¿ç•™åˆ—è¡¨é¡¹ï¼ˆä¾èµ–ã€è¢«ä¾èµ–ã€æ›¿ä»£ã€è¢«æ›¿ä»£ã€ç›¸å…³ï¼‰"
            echo ""
            ((warnings++))
        fi
    fi
done < <(find "$ADR_DIR" -name "ADR-*.md" -not -name "README.md" -not -path "*/proposals/*" | sort)

# ============================================================================
# æ¡æ¬¾ 3ï¼šç¦æ­¢ ADR ç¼–å·å‡ºç°åœ¨éå£°æ˜è¯­ä¹‰ä¸­
# ============================================================================
echo "ğŸ“‹ æ£€æŸ¥æ¡æ¬¾ 3ï¼šç¦æ­¢ ADR ç¼–å·å‡ºç°åœ¨éå£°æ˜è¯­ä¹‰ä¸­..."

# ç®€åŒ–æ£€æŸ¥ï¼šä»…æ£€æŸ¥ç« èŠ‚æ ‡é¢˜ä¸­çš„ ADR ç¼–å·
while IFS= read -r adr_file; do
    adr_name=$(basename "$adr_file")
    
    # æ£€æŸ¥ç« èŠ‚æ ‡é¢˜ï¼ˆ### æˆ– ####ï¼‰ä¸­æ˜¯å¦åŒ…å«å…·ä½“ ADR ç¼–å·
    if grep -qE '^###.*ADR-[0-9]{1,4}\.' "$adr_file" 2>/dev/null; then
        echo "âš ï¸  è­¦å‘Šæ¡æ¬¾ 3ï¼š$adr_name"
        echo "   ç« èŠ‚æ ‡é¢˜ä¸­ä½¿ç”¨äº†å…·ä½“ ADR ç¼–å·ï¼ˆå»ºè®®ä½¿ç”¨æ¡æ¬¾ç¼–å·ï¼‰"
        echo ""
        ((warnings++))
    fi
done < <(find "$ADR_DIR" -name "ADR-*.md" -not -name "README.md" -not -path "*/proposals/*" 2>/dev/null | sort)

# ============================================================================
# æ¡æ¬¾ 4ï¼šç¦æ­¢åŒç¼–å·å¤šæ–‡æ¡£
# ============================================================================
echo "ğŸ“‹ æ£€æŸ¥æ¡æ¬¾ 4ï¼šç¦æ­¢åŒç¼–å·å¤šæ–‡æ¡£..."

# æå–æ‰€æœ‰ ADR æ–‡ä»¶çš„ç¼–å·ï¼ˆADR-XXXX éƒ¨åˆ†ï¼‰
declare -A adr_numbers

while IFS= read -r adr_file; do
    adr_name=$(basename "$adr_file" .md)
    # æå– ADR ç¼–å·ï¼ˆå¦‚ ADR-0001ï¼‰
    adr_num=$(echo "$adr_name" | grep -oE 'ADR-[0-9]+' || true)
    
    if [ -n "$adr_num" ]; then
        if [ -n "${adr_numbers[$adr_num]:-}" ]; then
            # å‘ç°é‡å¤ç¼–å·
            echo "âŒ è¿åæ¡æ¬¾ 4ï¼šé‡å¤çš„ ADR ç¼–å· $adr_num"
            echo "   æ–‡ä»¶ 1: $(basename "${adr_numbers[$adr_num]}")"
            echo "   æ–‡ä»¶ 2: $(basename "$adr_file")"
            echo "   ä¿®å¤ï¼šå°†è¡¥å……æ–‡æ¡£é‡å‘½åä¸ºæ–°ç¼–å·ï¼Œæˆ–åˆå¹¶åˆ°ä¸»æ–‡ä»¶"
            echo ""
            ((errors++))
        else
            adr_numbers[$adr_num]=$adr_file
        fi
    fi
done < <(find "$ADR_DIR" -name "ADR-*.md" -not -name "README.md" -not -path "*/proposals/*" | sort)

# ============================================================================
# æ¡æ¬¾ 5ï¼šç¦æ­¢æ˜¾å¼å¾ªç¯å£°æ˜
# ============================================================================
echo "ğŸ“‹ æ£€æŸ¥æ¡æ¬¾ 5ï¼šç¦æ­¢æ˜¾å¼å¾ªç¯å£°æ˜..."

# ä¸´æ—¶æ–‡ä»¶
TEMP_DIR=$(mktemp -d)
trap "rm -rf $TEMP_DIR" EXIT

DEPS_FILE="$TEMP_DIR/dependencies.txt"

# æå–æ‰€æœ‰ä¾èµ–å…³ç³»
while IFS= read -r adr_file; do
    adr_filename=$(basename "$adr_file" .md)
    adr_id=$(echo "$adr_filename" | grep -oE 'ADR-[0-9]+' || echo "")
    
    [ -z "$adr_id" ] && continue
    
    if grep -q "^## å…³ç³»å£°æ˜" "$adr_file"; then
        # æå– "ä¾èµ–ï¼ˆDepends Onï¼‰" åˆ—è¡¨ä¸­çš„ ADR ç¼–å·
        sed -n '/## å…³ç³»å£°æ˜/,/^##/p' "$adr_file" | \
            sed -n '/\*\*ä¾èµ–ï¼ˆDepends Onï¼‰\*\*/,/\*\*è¢«ä¾èµ–/p' | \
            { grep -oE 'ADR-[0-9]+' || true; } | \
            while read -r dep_id; do
                echo "$adr_id|$dep_id" >> "$DEPS_FILE"
            done
    fi
done < <(find "$ADR_DIR" -name "ADR-*.md" -not -name "README.md" -not -path "*/proposals/*" | sort)

# æ£€æµ‹ç®€å•çš„åŒå‘ä¾èµ–ï¼ˆA->B ä¸” B->Aï¼‰
if [ -f "$DEPS_FILE" ] && [ -s "$DEPS_FILE" ]; then
    while IFS='|' read -r from to; do
        [ -z "$from" ] && continue
        
        # æ£€æŸ¥æ˜¯å¦å­˜åœ¨åå‘ä¾èµ–
        if grep -q "^${to}|${from}$" "$DEPS_FILE"; then
            echo "âŒ è¿åæ¡æ¬¾ 5ï¼šæ£€æµ‹åˆ°æ˜¾å¼å¾ªç¯å£°æ˜"
            echo "   $from â†” $to (åŒå‘ä¾èµ–)"
            echo "   ä¿®å¤ï¼šä¿ç•™å•å‘ä¾èµ–ï¼Œå¦ä¸€ä¾§æ”¹ä¸ºç›¸å…³å…³ç³»"
            echo ""
            ((errors++))
        fi
    done < "$DEPS_FILE"
fi

# ============================================================================
# æ±‡æ€»æŠ¥å‘Š
# ============================================================================
echo "================================"
echo "æ£€æŸ¥å®Œæˆï¼"
echo ""

if [ $errors -gt 0 ]; then
    echo "âŒ ADR-947 åˆè§„æ€§æ£€æŸ¥å¤±è´¥ï¼šå‘ç° $errors ä¸ªé”™è¯¯"
    [ $warnings -gt 0 ] && echo "âš ï¸  å‘ç° $warnings ä¸ªè­¦å‘Š"
    echo ""
    echo "ä¿®å¤æŒ‡å—ï¼š"
    echo "1. æ¡æ¬¾ 1ï¼šç¡®ä¿æ¯ä¸ª ADR åªæœ‰ä¸€ä¸ª ## å…³ç³»å£°æ˜"
    echo "2. æ¡æ¬¾ 2ï¼šå…³ç³»åŒºå†…ä»…åŒ…å«åˆ—è¡¨ï¼Œä¸å«å­æ ‡é¢˜æˆ–æ®µè½"
    echo "3. æ¡æ¬¾ 3ï¼šéå…³ç³»åŒºä½¿ç”¨ ADR-#### å ä½ç¬¦"
    echo "4. æ¡æ¬¾ 4ï¼šåŒç¼–å·åªèƒ½æœ‰ä¸€ä¸ªæ–‡ä»¶"
    echo "5. æ¡æ¬¾ 5ï¼šé¿å…åŒå‘ä¾èµ–ï¼Œä½¿ç”¨å•å‘+ç›¸å…³å…³ç³»"
    echo ""
    echo "å‚è€ƒï¼šdocs/adr/governance/ADR-947-relationship-section-structure-parsing-safety.md"
    exit 1
else
    if [ $warnings -gt 0 ]; then
        echo "âš ï¸  ADR-947 åˆè§„æ€§æ£€æŸ¥é€šè¿‡ï¼ˆæœ‰ $warnings ä¸ªè­¦å‘Šï¼‰"
        echo ""
        echo "å»ºè®®æŸ¥çœ‹è­¦å‘Šå¹¶è€ƒè™‘ä¼˜åŒ–"
        exit 0
    else
        echo "âœ… ADR-947 åˆè§„æ€§æ£€æŸ¥é€šè¿‡"
        echo "   æ‰€æœ‰ ADR æ–‡æ¡£ç¬¦åˆå…³ç³»å£°æ˜åŒºç»“æ„ä¸è§£æå®‰å…¨è§„åˆ™"
        exit 0
    fi
fi
