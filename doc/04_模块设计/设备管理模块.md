---
title: "è®¾å¤‡ç®¡ç†æ¨¡å—"
description: "è‡ªåŠ©å°çƒç³»ç»Ÿè®¾å¤‡ç®¡ç†æ¨¡å—è¯¦ç»†è®¾è®¡è¯´æ˜"
version: "1.0.0"
author: "ç¡¬ä»¶æ¶æ„å¸ˆ"
maintainer: "ç¡¬ä»¶å¼€å‘å›¢é˜Ÿ"
created: "2024-01-01"
updated: "2024-01-15"
category: "æ¨¡å—è®¾è®¡"
level: "æ ¸å¿ƒ"
audience: ["ç¡¬ä»¶å¼€å‘å·¥ç¨‹å¸ˆ", "ç‰©è”ç½‘å·¥ç¨‹å¸ˆ"]
keywords: ["è®¾å¤‡ç®¡ç†", "ç‰©è”ç½‘", "MQTT", "è®¾å¤‡æ§åˆ¶"]
tags: ["device", "iot", "mqtt", "hardware"]
dependencies: ["å°çƒæ¡Œè®¡è´¹", "ç³»ç»Ÿæ¶æ„"]
estimated_reading_time: "14åˆ†é’Ÿ"
---

# 4.4 è®¾å¤‡ç®¡ç†æ¨¡å—

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“¦ æ¨¡å—è®¾è®¡](README.md) > ğŸ–¥ï¸ è®¾å¤‡ç®¡ç†æ¨¡å—

<!-- Keywords for Search -->
**å…³é”®è¯**: `è®¾å¤‡ç®¡ç†` `ç‰©è”ç½‘` `MQTT` `è®¾å¤‡æ§åˆ¶`

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

è®¾å¤‡ç®¡ç†æ¨¡å—è´Ÿè´£è‡ªåŠ©å°çƒç³»ç»Ÿä¸­æ‰€æœ‰ç¡¬ä»¶è®¾å¤‡çš„ç®¡ç†å’Œæ§åˆ¶ï¼ŒåŒ…æ‹¬å°çƒæ¡Œç¯å…‰æ§åˆ¶ã€ä¼ æ„Ÿå™¨æ•°æ®é‡‡é›†ã€è®¾å¤‡çŠ¶æ€ç›‘æ§ã€æ•…éšœè¯Šæ–­ç­‰åŠŸèƒ½ã€‚è¯¥æ¨¡å—æ˜¯è¿æ¥è½¯ä»¶ç³»ç»Ÿä¸ç¡¬ä»¶è®¾å¤‡çš„é‡è¦æ¡¥æ¢ã€‚

### æ ¸å¿ƒèŒè´£

- ğŸ® **è®¾å¤‡æ§åˆ¶**: å°çƒæ¡Œç¯å…‰ã€éŸ³å“ç­‰è®¾å¤‡çš„è¿œç¨‹æ§åˆ¶
- ğŸ“¡ **çŠ¶æ€ç›‘æ§**: å®æ—¶ç›‘æ§è®¾å¤‡è¿è¡ŒçŠ¶æ€å’Œå¥åº·çŠ¶å†µ  
- ğŸ”§ **æ•…éšœè¯Šæ–­**: è‡ªåŠ¨æ£€æµ‹è®¾å¤‡æ•…éšœå¹¶ç”Ÿæˆç»´ä¿®å·¥å•
- ğŸ“Š **æ•°æ®é‡‡é›†**: é‡‡é›†è®¾å¤‡è¿è¡Œæ•°æ®ç”¨äºåˆ†æä¼˜åŒ–
- ğŸŒ **åè®®é€‚é…**: æ”¯æŒå¤šç§ç‰©è”ç½‘é€šä¿¡åè®®

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—æ¶æ„å›¾

```mermaid
graph TB
    subgraph "è®¾å¤‡ç®¡ç†æ¨¡å—"
        subgraph "åº”ç”¨æœåŠ¡å±‚"
            AS1[è®¾å¤‡æ§åˆ¶æœåŠ¡]
            AS2[è®¾å¤‡ç›‘æ§æœåŠ¡]  
            AS3[æ•…éšœè¯Šæ–­æœåŠ¡]
            AS4[æ•°æ®é‡‡é›†æœåŠ¡]
        end
        
        subgraph "é¢†åŸŸæœåŠ¡å±‚"
            DS1[è®¾å¤‡å‘½ä»¤å¤„ç†å™¨]
            DS2[çŠ¶æ€ç›‘æ§å™¨]
            DS3[åè®®é€‚é…å™¨]
            DS4[æ•…éšœæ£€æµ‹å™¨]
        end
        
        subgraph "é¢†åŸŸæ¨¡å‹å±‚"
            E1[è®¾å¤‡å®ä½“]
            E2[è®¾å¤‡ç±»å‹å®ä½“]
            E3[è®¾å¤‡çŠ¶æ€å®ä½“]
            E4[æ•…éšœè®°å½•å®ä½“]
            VO1[è®¾å¤‡å‘½ä»¤å€¼å¯¹è±¡]
        end
        
        subgraph "åŸºç¡€è®¾æ–½å±‚"
            R1[è®¾å¤‡ä»“å‚¨]
            R2[çŠ¶æ€ä»“å‚¨]
            MQTT[MQTTå®¢æˆ·ç«¯]
            WS[WebSocketæœåŠ¡]
            CACHE[ç¼“å­˜æœåŠ¡]
        end
    end
    
    subgraph "ç¡¬ä»¶è®¾å¤‡å±‚"
        DEV1[å°çƒæ¡Œæ§åˆ¶å™¨]
        DEV2[ç¯å…‰æ§åˆ¶å™¨]
        DEV3[ä¼ æ„Ÿå™¨èŠ‚ç‚¹]
        DEV4[éŸ³å“æ§åˆ¶å™¨]
    end
    
    AS1 --> DS1
    AS2 --> DS2
    AS3 --> DS4
    AS4 --> DS3
    
    DS1 --> VO1
    DS2 --> E3
    DS3 --> E1
    DS4 --> E4
    
    E1 --> R1
    E3 --> R2
    
    DS3 --> MQTT
    DS1 --> WS
    DS2 --> CACHE
    
    MQTT --> DEV1
    MQTT --> DEV2
    MQTT --> DEV3
    MQTT --> DEV4
```

### è®¾å¤‡é€šä¿¡æµç¨‹

```mermaid
sequenceDiagram
    participant A as åº”ç”¨ç³»ç»Ÿ
    participant D as è®¾å¤‡ç®¡ç†
    participant M as MQTTä»£ç†
    participant H as ç¡¬ä»¶è®¾å¤‡
    
    A->>D: å‘é€è®¾å¤‡æ§åˆ¶æŒ‡ä»¤
    D->>D: éªŒè¯æŒ‡ä»¤å‚æ•°
    D->>M: å‘å¸ƒMQTTæ¶ˆæ¯
    M->>H: è½¬å‘æ§åˆ¶æŒ‡ä»¤
    H->>H: æ‰§è¡Œè®¾å¤‡æ“ä½œ
    H->>M: ä¸ŠæŠ¥æ‰§è¡Œç»“æœ
    M->>D: æ¥æ”¶çŠ¶æ€åé¦ˆ
    D->>D: æ›´æ–°è®¾å¤‡çŠ¶æ€
    D-->>A: è¿”å›æ“ä½œç»“æœ
    
    loop å¿ƒè·³ç›‘æ§
        H->>M: å‘é€å¿ƒè·³æ•°æ®
        M->>D: è½¬å‘å¿ƒè·³ä¿¡æ¯
        D->>D: æ›´æ–°åœ¨çº¿çŠ¶æ€
    end
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒå®ä½“

#### è®¾å¤‡å®ä½“ (Device)

```csharp
public class Device : AuditedAggregateRoot<Guid>
{
    public string DeviceId { get; set; }
    public string DeviceName { get; set; }
    public DeviceType Type { get; set; }
    public Guid? TableId { get; set; }
    public string SerialNumber { get; set; }
    public string ModelNumber { get; set; }
    public string FirmwareVersion { get; set; }
    public string HardwareVersion { get; set; }
    public DeviceStatus Status { get; set; }
    public bool IsOnline { get; set; }
    public DateTime? LastHeartbeatTime { get; set; }
    public string Location { get; set; }
    public DateTime InstallationDate { get; set; }
    public string ConfigurationJson { get; set; }
    
    // å¯¼èˆªå±æ€§
    public BilliardTable Table { get; set; }
    public ICollection<DeviceStatusLog> StatusLogs { get; set; }
    public ICollection<DeviceFault> Faults { get; set; }
}

public enum DeviceType
{
    LightController = 1,    // ç¯å…‰æ§åˆ¶å™¨
    SensorNode = 2,        // ä¼ æ„Ÿå™¨èŠ‚ç‚¹
    AudioController = 3,   // éŸ³å“æ§åˆ¶å™¨
    TableController = 4,   // å°çƒæ¡Œæ§åˆ¶å™¨
    Gateway = 5           // ç½‘å…³è®¾å¤‡
}

public enum DeviceStatus
{
    Normal = 1,      // æ­£å¸¸
    Warning = 2,     // è­¦å‘Š
    Error = 3,       // é”™è¯¯
    Maintenance = 4, // ç»´æŠ¤ä¸­
    Offline = 5      // ç¦»çº¿
}
```

#### è®¾å¤‡çŠ¶æ€æ—¥å¿—å®ä½“ (DeviceStatusLog)

```csharp
public class DeviceStatusLog : CreationAuditedEntity<Guid>
{
    public Guid DeviceId { get; set; }
    public DeviceStatus Status { get; set; }
    public DeviceStatus? PreviousStatus { get; set; }
    public string StatusData { get; set; }
    public string EventType { get; set; }
    public string EventDescription { get; set; }
    public DateTime EventTime { get; set; }
    public string AdditionalData { get; set; }
    
    // å¯¼èˆªå±æ€§
    public Device Device { get; set; }
}
```

#### è®¾å¤‡æ•…éšœè®°å½•å®ä½“ (DeviceFault)

```csharp
public class DeviceFault : AuditedAggregateRoot<Guid>
{
    public Guid DeviceId { get; set; }
    public string FaultCode { get; set; }
    public string FaultTitle { get; set; }
    public string FaultDescription { get; set; }
    public FaultLevel Level { get; set; }
    public FaultStatus Status { get; set; }
    public DateTime OccurredTime { get; set; }
    public DateTime? ResolvedTime { get; set; }
    public string ResolvedBy { get; set; }
    public string ResolutionNotes { get; set; }
    public bool AutoResolved { get; set; }
    
    // å¯¼èˆªå±æ€§
    public Device Device { get; set; }
    public ICollection<MaintenanceRecord> MaintenanceRecords { get; set; }
}

public enum FaultLevel
{
    Low = 1,      // ä½çº§æ•…éšœ
    Medium = 2,   // ä¸­çº§æ•…éšœ
    High = 3,     // é«˜çº§æ•…éšœ
    Critical = 4  // ä¸¥é‡æ•…éšœ
}

public enum FaultStatus
{
    Open = 1,        // æœªå¤„ç†
    InProgress = 2,  // å¤„ç†ä¸­
    Resolved = 3,    // å·²è§£å†³
    Closed = 4       // å·²å…³é—­
}
```

---

## ğŸ”§ æ¥å£è®¾è®¡

### è®¾å¤‡æ§åˆ¶æ¥å£

```csharp
public interface IDeviceControlAppService : IApplicationService
{
    Task<DeviceCommandResult> SendCommandAsync(SendDeviceCommandDto input);
    Task<DeviceStatusDto> GetDeviceStatusAsync(Guid deviceId);
    Task<List<DeviceDto>> GetDevicesByTableAsync(Guid tableId);
    Task<List<DeviceDto>> GetDevicesByTypeAsync(DeviceType type);
    Task<bool> TestDeviceConnectionAsync(Guid deviceId);
}
```

### è®¾å¤‡ç›‘æ§æ¥å£

```csharp
public interface IDeviceMonitoringAppService : IApplicationService
{
    Task<DeviceHealthDto> GetDeviceHealthAsync(Guid deviceId);
    Task<List<DeviceStatusLogDto>> GetStatusHistoryAsync(GetStatusHistoryDto input);
    Task<DeviceStatisticsDto> GetDeviceStatisticsAsync(GetStatisticsDto input);
    Task<List<OfflineDeviceDto>> GetOfflineDevicesAsync();
    Task<AlertDto> CreateDeviceAlertAsync(CreateAlertDto input);
}
```

### æ•…éšœç®¡ç†æ¥å£

```csharp
public interface IDeviceFaultAppService : IApplicationService
{
    Task<List<DeviceFaultDto>> GetActiveFaultsAsync();
    Task<DeviceFaultDto> ReportFaultAsync(ReportFaultDto input);
    Task<DeviceFaultDto> ResolveFaultAsync(Guid faultId, ResolveFaultDto input);
    Task<List<DeviceFaultDto>> GetFaultHistoryAsync(GetFaultHistoryDto input);
    Task<FaultStatisticsDto> GetFaultStatisticsAsync();
}
```

---

## ğŸŒ é€šä¿¡åè®®è®¾è®¡

### MQTTæ¶ˆæ¯æ ¼å¼

```json
{
  "topic": "billiard/table/{tableId}/light/control",
  "payload": {
    "messageId": "msg_20240115_001",
    "timestamp": 1705123456789,
    "command": "turn_on",
    "parameters": {
      "brightness": 80,
      "color": "white",
      "duration": 3600
    }
  }
}
```

### è®¾å¤‡çŠ¶æ€ä¸ŠæŠ¥

```json
{
  "topic": "billiard/device/{deviceId}/status",
  "payload": {
    "deviceId": "light_ctrl_001",
    "timestamp": 1705123456789,
    "status": {
      "online": true,
      "working": true,
      "brightness": 80,
      "temperature": 45.2,
      "voltage": 220.1,
      "current": 0.8
    },
    "metrics": {
      "uptime": 86400,
      "workingHours": 8.5,
      "errorCount": 0
    }
  }
}
```

### æ•…éšœå‘Šè­¦æ¶ˆæ¯

```json
{
  "topic": "billiard/device/{deviceId}/fault",
  "payload": {
    "deviceId": "light_ctrl_001",
    "faultCode": "ERR_001",
    "faultTitle": "è¿‡æ¸©å‘Šè­¦",
    "description": "è®¾å¤‡æ¸©åº¦è¶…è¿‡å®‰å…¨é˜ˆå€¼",
    "level": "High",
    "occurredTime": 1705123456789,
    "additionalData": {
      "temperature": 85.5,
      "threshold": 80.0
    }
  }
}
```

---

## âš™ï¸ è®¾å¤‡æ§åˆ¶é€»è¾‘

### å°çƒæ¡Œç¯å…‰æ§åˆ¶

```csharp
public class LightController : IDeviceController
{
    public async Task<DeviceCommandResult> TurnOnAsync(Guid tableId, LightControlParameters parameters)
    {
        var device = await GetLightDeviceByTableAsync(tableId);
        if (device == null)
        {
            return DeviceCommandResult.Failed("æœªæ‰¾åˆ°ç¯å…‰è®¾å¤‡");
        }
        
        var command = new DeviceCommand
        {
            DeviceId = device.DeviceId,
            Command = "turn_on",
            Parameters = JsonSerializer.Serialize(parameters)
        };
        
        return await SendCommandAsync(command);
    }
    
    public async Task<DeviceCommandResult> TurnOffAsync(Guid tableId)
    {
        var device = await GetLightDeviceByTableAsync(tableId);
        if (device == null)
        {
            return DeviceCommandResult.Failed("æœªæ‰¾åˆ°ç¯å…‰è®¾å¤‡");
        }
        
        var command = new DeviceCommand
        {
            DeviceId = device.DeviceId,
            Command = "turn_off"
        };
        
        return await SendCommandAsync(command);
    }
}
```

### æ•…éšœè‡ªåŠ¨æ£€æµ‹

```csharp
public class FaultDetectionService
{
    public async Task DetectFaultsAsync()
    {
        var devices = await _deviceRepository.GetActiveDevicesAsync();
        
        foreach (var device in devices)
        {
            // æ£€æµ‹è®¾å¤‡ç¦»çº¿
            if (await IsDeviceOfflineAsync(device))
            {
                await CreateFaultAsync(device.Id, "OFFLINE", "è®¾å¤‡ç¦»çº¿", FaultLevel.High);
            }
            
            // æ£€æµ‹è®¾å¤‡è¿‡æ¸©
            if (await IsDeviceOverheatedAsync(device))
            {
                await CreateFaultAsync(device.Id, "OVERHEAT", "è®¾å¤‡è¿‡æ¸©", FaultLevel.High);
            }
            
            // æ£€æµ‹é€šä¿¡å¼‚å¸¸
            if (await HasCommunicationErrorAsync(device))
            {
                await CreateFaultAsync(device.Id, "COMM_ERROR", "é€šä¿¡å¼‚å¸¸", FaultLevel.Medium);
            }
        }
    }
}
```

---

## ğŸ“Š è®¾å¤‡ç›‘æ§

### å®æ—¶ç›‘æ§é¢æ¿

```mermaid
graph LR
    A[è®¾å¤‡ç›‘æ§é¢æ¿] --> B[åœ¨çº¿è®¾å¤‡ç»Ÿè®¡]
    A --> C[è®¾å¤‡çŠ¶æ€åˆ†å¸ƒ]
    A --> D[æ•…éšœè®¾å¤‡åˆ—è¡¨]
    A --> E[æ€§èƒ½æŒ‡æ ‡å›¾è¡¨]
    
    B --> B1[æ€»è®¾å¤‡æ•°]
    B --> B2[åœ¨çº¿è®¾å¤‡æ•°]
    B --> B3[ç¦»çº¿è®¾å¤‡æ•°]
    
    C --> C1[æ­£å¸¸çŠ¶æ€]
    C --> C2[è­¦å‘ŠçŠ¶æ€]
    C --> C3[æ•…éšœçŠ¶æ€]
    
    D --> D1[æ•…éšœç±»å‹]
    D --> D2[æ•…éšœæ—¶é—´]
    D --> D3[å¤„ç†çŠ¶æ€]
    
    E --> E1[è®¾å¤‡æ¸©åº¦]
    E --> E2[åŠŸè€—ç»Ÿè®¡]
    E --> E3[å·¥ä½œæ—¶é•¿]
```

### å‘Šè­¦è§„åˆ™

| æŒ‡æ ‡ç±»å‹ | é˜ˆå€¼ | å‘Šè­¦çº§åˆ« | å¤„ç†æ–¹å¼ |
|----------|------|----------|----------|
| è®¾å¤‡ç¦»çº¿ | >30ç§’æ— å¿ƒè·³ | é«˜çº§ | ç«‹å³é€šçŸ¥ |
| è®¾å¤‡è¿‡æ¸© | >80Â°C | é«˜çº§ | è‡ªåŠ¨å…³é—­ |
| ç”µå‹å¼‚å¸¸ | <200Væˆ–>240V | ä¸­çº§ | è®°å½•æ—¥å¿— |
| é€šä¿¡è¶…æ—¶ | >5ç§’æ— å“åº” | ä½çº§ | é‡è¯•è¿æ¥ |

---

## ğŸ”§ ç»´æŠ¤ç®¡ç†

### é¢„é˜²æ€§ç»´æŠ¤

```csharp
public class PreventiveMaintenanceService
{
    public async Task ScheduleMaintenanceAsync()
    {
        var devices = await _deviceRepository.GetDevicesForMaintenanceAsync();
        
        foreach (var device in devices)
        {
            var maintenanceSchedule = CalculateMaintenanceSchedule(device);
            
            if (maintenanceSchedule.IsOverdue)
            {
                await CreateMaintenanceTaskAsync(device, maintenanceSchedule);
            }
        }
    }
    
    private MaintenanceSchedule CalculateMaintenanceSchedule(Device device)
    {
        var workingHours = CalculateWorkingHours(device);
        var lastMaintenance = GetLastMaintenanceDate(device);
        
        return new MaintenanceSchedule
        {
            DeviceId = device.Id,
            NextMaintenanceDate = CalculateNextMaintenanceDate(workingHours, lastMaintenance),
            MaintenanceType = DetermineMaintenanceType(workingHours),
            IsOverdue = DateTime.Now > CalculateNextMaintenanceDate(workingHours, lastMaintenance)
        };
    }
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### æ•°æ®ç¼“å­˜ç­–ç•¥

```csharp
// è®¾å¤‡çŠ¶æ€ç¼“å­˜ï¼ˆ1åˆ†é’Ÿï¼‰
[CachePut(CacheNames.DeviceStatus, "{deviceId}", Duration = 60)]
public async Task<DeviceStatusDto> GetDeviceStatusAsync(Guid deviceId)

// è®¾å¤‡é…ç½®ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
[CachePut(CacheNames.DeviceConfig, "{deviceId}", Duration = 1800)]
public async Task<DeviceConfigDto> GetDeviceConfigAsync(Guid deviceId)
```

### æ¶ˆæ¯å¤„ç†ä¼˜åŒ–

- ğŸ“¨ **æ‰¹é‡å¤„ç†**: å¿ƒè·³æ¶ˆæ¯æ‰¹é‡å…¥åº“ï¼Œå‡å°‘æ•°æ®åº“å‹åŠ›
- ğŸ”„ **å¼‚æ­¥å¤„ç†**: æ•…éšœæ£€æµ‹å’Œå‘Šè­¦é€šçŸ¥å¼‚æ­¥å¤„ç†
- ğŸ“Š **æ•°æ®å‹ç¼©**: å†å²æ•°æ®å®šæœŸå‹ç¼©å­˜å‚¨
- ğŸš€ **è¿æ¥æ± **: MQTTè¿æ¥æ± ç®¡ç†ï¼Œæé«˜å¹¶å‘æ€§èƒ½

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **ä¸Šçº§æ–‡æ¡£**: [æ¨¡å—è®¾è®¡æ€»è§ˆ](README.md)
- **å…³è”æ–‡æ¡£**: [å°çƒæ¡Œè®¡è´¹æ¨¡å—](å°çƒæ¡Œè®¡è´¹æ¨¡å—.md) | [æŠ¥è¡¨ä¸ç»Ÿè®¡æ¨¡å—](æŠ¥è¡¨ä¸ç»Ÿè®¡æ¨¡å—.md)
- **æŠ€æœ¯æ–‡æ¡£**: [MQTTåè®®æ–‡æ¡£](../08_é…ç½®ç®¡ç†/æ¶ˆæ¯é˜Ÿåˆ—.md)
- **è¿”å›**: [é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md)

---

*æœ€åæ›´æ–°: 2024-01-15 | ç‰ˆæœ¬: v1.0.0*
