---
title: "ä¼šå‘˜ç®¡ç†æ¨¡å—ï¼ˆMembersï¼‰"
description: "åŸºäº Wolverine å‚ç›´åˆ‡ç‰‡æ¶æ„çš„ä¼šå‘˜ç®¡ç†æ¨¡å—è®¾è®¡"
version: "3.0.0"
author: "æ¶æ„å›¢é˜Ÿ"
maintainer: "åç«¯å¼€å‘å›¢é˜Ÿ"
created: "2024-01-15"
updated: "2024-01-15"
category: "æ¨¡å—è®¾è®¡"
level: "æ ¸å¿ƒ"
audience: ["åç«¯å¼€å‘å·¥ç¨‹å¸ˆ", "ä¸šåŠ¡åˆ†æå¸ˆ"]
keywords: ["ä¼šå‘˜ç®¡ç†", "Members", "Wolverine", "å‚ç›´åˆ‡ç‰‡", "CQRS"]
tags: ["member", "user", "points", "authentication", "vertical-slice", "wolverine"]
dependencies: ["ç³»ç»Ÿæ¶æ„è®¾è®¡", "Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾"]
estimated_reading_time: "20åˆ†é’Ÿ"
architecture: "Wolverine + å‚ç›´åˆ‡ç‰‡"
---

# ä¼šå‘˜ç®¡ç†æ¨¡å—ï¼ˆMembersï¼‰

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“¦ æ¨¡å—è®¾è®¡](README.md) > ğŸƒ ä¼šå‘˜ç®¡ç†æ¨¡å—

<!-- Keywords for Search -->
**å…³é”®è¯**: `Members` `ä¼šå‘˜ç®¡ç†` `ç”¨æˆ·ç³»ç»Ÿ` `ç§¯åˆ†ä½“ç³»` `Wolverine` `å‚ç›´åˆ‡ç‰‡`

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

ä¼šå‘˜ç®¡ç†æ¨¡å—ï¼ˆMembersï¼‰æ˜¯è‡ªåŠ©å°çƒç³»ç»Ÿçš„æ ¸å¿ƒç”¨æˆ·æ¨¡å—ï¼Œé‡‡ç”¨ **Wolverine + å‚ç›´åˆ‡ç‰‡æ¶æ„**ã€‚è´Ÿè´£ä¼šå‘˜æ³¨å†Œã€èµ„æ–™ç®¡ç†ã€ä½™é¢å……å€¼ã€ç§¯åˆ†ç®¡ç†ã€ç­‰çº§ä½“ç³»ç­‰åŠŸèƒ½ã€‚

### æ ¸å¿ƒèŒè´£

- ğŸ” **ä¼šå‘˜æ³¨å†Œä¸è®¤è¯**: æ³¨å†Œæ–°ä¼šå‘˜ã€OpenIddict è®¤è¯é›†æˆ
- ğŸ’° **ä½™é¢ç®¡ç†**: å……å€¼ã€æ‰£å‡ã€ä½™é¢æŸ¥è¯¢
- ğŸ¯ **ç§¯åˆ†ç³»ç»Ÿ**: ç§¯åˆ†è·å–ã€æ¶ˆè´¹ã€å…‘æ¢ç®¡ç†
- ğŸ† **ä¼šå‘˜ç­‰çº§ä½“ç³»**: ç­‰çº§åˆ’åˆ†ã€æƒç›Šç®¡ç†ã€è‡ªåŠ¨å‡çº§
- ğŸ‘¤ **èµ„æ–™ç®¡ç†**: æ›´æ–°èµ„æ–™ã€æŸ¥è¯¢ä¼šå‘˜ä¿¡æ¯

### æ¶æ„å‚è€ƒ

> ğŸ“š **å®Œæ•´æ¶æ„å®ç°**: [Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)
> 
> ğŸ“š **æ¨¡å—è¾¹ç•Œå®šä¹‰**: [ç³»ç»Ÿæ¨¡å—åˆ’åˆ† - Members æ¨¡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#7-members-æ¨¡å—ä¼šå‘˜ä½“ç³»)

---

## ğŸ—ï¸ æ¨¡å—ç»“æ„ï¼ˆå‚ç›´åˆ‡ç‰‡ï¼‰

### ç›®å½•ç»„ç»‡

```
src/Modules/Members/
â”œâ”€â”€ RegisterMember/
â”‚   â”œâ”€â”€ RegisterMember.cs              # Command å®šä¹‰
â”‚   â”œâ”€â”€ RegisterMemberHandler.cs       # Handler å®ç°
â”‚   â”œâ”€â”€ RegisterMemberEndpoint.cs      # HTTP ç«¯ç‚¹
â”‚   â””â”€â”€ RegisterMemberValidator.cs     # éªŒè¯å™¨ï¼ˆFluentValidationï¼‰
â”‚
â”œâ”€â”€ UpdateMemberProfile/
â”‚   â”œâ”€â”€ UpdateMemberProfile.cs
â”‚   â”œâ”€â”€ UpdateMemberProfileHandler.cs
â”‚   â””â”€â”€ UpdateMemberProfileEndpoint.cs
â”‚
â”œâ”€â”€ TopUpBalance/
â”‚   â”œâ”€â”€ TopUpBalance.cs
â”‚   â”œâ”€â”€ TopUpBalanceHandler.cs
â”‚   â””â”€â”€ TopUpBalanceEndpoint.cs
â”‚
â”œâ”€â”€ DeductBalance/
â”‚   â”œâ”€â”€ DeductBalance.cs                # å†…éƒ¨å‘½ä»¤ï¼ˆä¸æš´éœ² HTTPï¼‰
â”‚   â””â”€â”€ DeductBalanceHandler.cs
â”‚
â”œâ”€â”€ AwardPoints/
â”‚   â”œâ”€â”€ AwardPoints.cs
â”‚   â””â”€â”€ AwardPointsHandler.cs
â”‚
â”œâ”€â”€ GetMember/
â”‚   â”œâ”€â”€ GetMember.cs                    # Query
â”‚   â”œâ”€â”€ GetMemberHandler.cs
â”‚   â””â”€â”€ GetMemberEndpoint.cs
â”‚
â”œâ”€â”€ GetMemberBalance/
â”‚   â”œâ”€â”€ GetMemberBalance.cs
â”‚   â””â”€â”€ GetMemberBalanceHandler.cs
â”‚
â”œâ”€â”€ Events/
â”‚   â”œâ”€â”€ MemberRegistered.cs            # ä¼šå‘˜å·²æ³¨å†Œäº‹ä»¶
â”‚   â”œâ”€â”€ BalanceToppedUp.cs             # ä½™é¢å·²å……å€¼äº‹ä»¶
â”‚   â”œâ”€â”€ BalanceDeducted.cs             # ä½™é¢å·²æ‰£å‡äº‹ä»¶
â”‚   â”œâ”€â”€ PointsAwarded.cs               # ç§¯åˆ†å·²èµ é€äº‹ä»¶
â”‚   â””â”€â”€ MemberTierUpgraded.cs          # ä¼šå‘˜ç­‰çº§å·²å‡çº§äº‹ä»¶
â”‚
â”œâ”€â”€ Handlers/
â”‚   â””â”€â”€ PaymentCompletedHandler.cs     # ç›‘å¬ PaymentCompleted äº‹ä»¶ â†’ è®¡ç®—ç§¯åˆ†
â”‚
â”œâ”€â”€ Member.cs                           # èšåˆæ ¹
â”œâ”€â”€ MemberTier.cs                       # æšä¸¾ï¼šä¼šå‘˜ç­‰çº§
â””â”€â”€ MembersModule.cs                    # æ¨¡å—æ ‡è®°ï¼ˆå¯é€‰ï¼‰
```

### æ¶æ„åŸåˆ™

- âœ… **ä¸€ä¸ªåŠŸèƒ½ = ä¸€ä¸ªæ–‡ä»¶å¤¹**: å¦‚ `RegisterMember/` åŒ…å«è¯¥åŠŸèƒ½çš„æ‰€æœ‰ä»£ç 
- âœ… **Handler å³åº”ç”¨æœåŠ¡**: ä¸å†æœ‰ `IMemberAppService`
- âœ… **ç›´æ¥ä½¿ç”¨ Marten**: ä¸ä½¿ç”¨ `IRepository<Member>`
- âœ… **äº‹ä»¶é©±åŠ¨é€šä¿¡**: é€šè¿‡ Wolverine æ¶ˆæ¯æ€»çº¿å‘å¸ƒ/è®¢é˜…äº‹ä»¶

---

## ğŸ“Š é¢†åŸŸæ¨¡å‹

### Memberï¼ˆèšåˆæ ¹ï¼‰

```csharp
public class Member
{
    public Guid Id { get; set; }
    public string Name { get; set; }
    public string Phone { get; set; }
    public string Email { get; set; }
    public MemberTier Tier { get; set; }
    public decimal Balance { get; set; }
    public int Points { get; set; }
    public DateTimeOffset RegisteredAt { get; set; }
    public DateTimeOffset? LastActiveAt { get; set; }

    // é¢†åŸŸæ–¹æ³•
    public void TopUp(decimal amount)
    {
        if (amount <= 0)
            throw new InvalidOperationException("å……å€¼é‡‘é¢å¿…é¡»å¤§äº0");
        
        Balance += amount;
    }

    public void Deduct(decimal amount)
    {
        if (amount <= 0)
            throw new InvalidOperationException("æ‰£å‡é‡‘é¢å¿…é¡»å¤§äº0");
        
        if (Balance < amount)
            throw new InvalidOperationException("ä½™é¢ä¸è¶³");
        
        Balance -= amount;
    }

    public void AwardPoints(int points)
    {
        if (points <= 0)
            throw new InvalidOperationException("ç§¯åˆ†å¿…é¡»å¤§äº0");
        
        Points += points;
        CheckTierUpgrade(); // æ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§
    }

    private void CheckTierUpgrade()
    {
        var newTier = Points switch
        {
            >= 10000 => MemberTier.Platinum,
            >= 5000 => MemberTier.Gold,
            >= 1000 => MemberTier.Silver,
            _ => MemberTier.Regular
        };

        if (newTier > Tier)
        {
            Tier = newTier;
        }
    }
}
```

### MemberTierï¼ˆæšä¸¾ï¼‰

```csharp
public enum MemberTier
{
    Regular = 1,   // æ™®é€šä¼šå‘˜
    Silver = 2,    // é“¶å¡ä¼šå‘˜
    Gold = 3,      // é‡‘å¡ä¼šå‘˜
    Platinum = 4   // ç™½é‡‘ä¼šå‘˜
}
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½åˆ‡ç‰‡

### 1. RegisterMemberï¼ˆæ³¨å†Œä¼šå‘˜ï¼‰

#### Command å®šä¹‰

```csharp
// RegisterMember.cs
namespace Zss.BilliardHall.Modules.Members.RegisterMember;

public sealed record RegisterMember(
    string Name,
    string Phone,
    string Email,
    string Password
);
```

#### Handler å®ç°

```csharp
// RegisterMemberHandler.cs
namespace Zss.BilliardHall.Modules.Members.RegisterMember;

public sealed class RegisterMemberHandler
{
    public async Task<Result<Guid>> Handle(
        RegisterMember command,
        IDocumentSession session,
        IPasswordHasher passwordHasher,
        IMessageBus bus,
        ILogger<RegisterMemberHandler> logger,
        CancellationToken ct = default)
    {
        // 1. æ£€æŸ¥æ‰‹æœºå·æ˜¯å¦å·²æ³¨å†Œ
        var existing = await session
            .Query<Member>()
            .FirstOrDefaultAsync(m => m.Phone == command.Phone, ct);

        if (existing != null)
            return Result.Fail<Guid>("æ‰‹æœºå·å·²æ³¨å†Œ");

        // 2. åˆ›å»ºä¼šå‘˜
        var member = new Member
        {
            Id = Guid.NewGuid(),
            Name = command.Name,
            Phone = command.Phone,
            Email = command.Email,
            Tier = MemberTier.Regular,
            Balance = 0,
            Points = 0,
            RegisteredAt = DateTimeOffset.UtcNow
        };

        // 3. æŒä¹…åŒ–
        session.Store(member);
        await session.SaveChangesAsync(ct);

        // 4. å‘å¸ƒäº‹ä»¶
        await bus.PublishAsync(new MemberRegistered(
            member.Id,
            member.Name,
            member.Phone,
            member.RegisteredAt
        ), ct);

        logger.LogInformation(
            "ä¼šå‘˜æ³¨å†ŒæˆåŠŸ: {MemberId}, æ‰‹æœºå·: {Phone}",
            member.Id,
            member.Phone
        );

        return Result.Ok(member.Id);
    }
}
```

#### HTTP ç«¯ç‚¹

```csharp
// RegisterMemberEndpoint.cs
namespace Zss.BilliardHall.Modules.Members.RegisterMember;

public sealed class RegisterMemberEndpoint
{
    [WolverinePost("/api/members/register")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    public static async Task<IResult> Post(
        RegisterMemberRequest request,
        IMessageBus bus)
    {
        var command = new RegisterMember(
            request.Name,
            request.Phone,
            request.Email,
            request.Password
        );

        var result = await bus.InvokeAsync<Result<Guid>>(command);

        return result.IsSuccess
            ? Results.Ok(new { memberId = result.Value })
            : Results.BadRequest(new { error = result.Error });
    }

    public sealed record RegisterMemberRequest(
        string Name,
        string Phone,
        string Email,
        string Password
    );
}
```

#### éªŒè¯å™¨

```csharp
// RegisterMemberValidator.cs
namespace Zss.BilliardHall.Modules.Members.RegisterMember;

public sealed class RegisterMemberValidator : AbstractValidator<RegisterMember>
{
    public RegisterMemberValidator()
    {
        RuleFor(x => x.Name)
            .NotEmpty().WithMessage("å§“åä¸èƒ½ä¸ºç©º")
            .MaximumLength(50).WithMessage("å§“åä¸èƒ½è¶…è¿‡50ä¸ªå­—ç¬¦");

        RuleFor(x => x.Phone)
            .NotEmpty().WithMessage("æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")
            .Matches(@"^1[3-9]\d{9}$").WithMessage("æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®");

        RuleFor(x => x.Email)
            .EmailAddress().WithMessage("é‚®ç®±æ ¼å¼ä¸æ­£ç¡®")
            .When(x => !string.IsNullOrEmpty(x.Email));

        RuleFor(x => x.Password)
            .NotEmpty().WithMessage("å¯†ç ä¸èƒ½ä¸ºç©º")
            .MinimumLength(6).WithMessage("å¯†ç è‡³å°‘6ä¸ªå­—ç¬¦");
    }
}
```

---

### 2. TopUpBalanceï¼ˆä½™é¢å……å€¼ï¼‰

#### Command å®šä¹‰

```csharp
// TopUpBalance.cs
namespace Zss.BilliardHall.Modules.Members.TopUpBalance;

public sealed record TopUpBalance(
    Guid MemberId,
    decimal Amount,
    string PaymentMethod
);
```

#### Handler å®ç°

```csharp
// TopUpBalanceHandler.cs
namespace Zss.BilliardHall.Modules.Members.TopUpBalance;

public sealed class TopUpBalanceHandler
{
    [Transactional]
    public async Task<Result> Handle(
        TopUpBalance command,
        IDocumentSession session,
        IMessageBus bus,
        ILogger<TopUpBalanceHandler> logger,
        CancellationToken ct = default)
    {
        // 1. åŠ è½½ä¼šå‘˜
        var member = await session.LoadAsync<Member>(command.MemberId, ct);
        if (member == null)
            return Result.Fail("ä¼šå‘˜ä¸å­˜åœ¨");

        // 2. å……å€¼
        var oldBalance = member.Balance;
        member.TopUp(command.Amount);

        // 3. æŒä¹…åŒ–
        session.Store(member);
        await session.SaveChangesAsync(ct);

        // 4. å‘å¸ƒäº‹ä»¶
        await bus.PublishAsync(new BalanceToppedUp(
            member.Id,
            command.Amount,
            oldBalance,
            member.Balance,
            DateTimeOffset.UtcNow
        ), ct);

        logger.LogInformation(
            "ä¼šå‘˜å……å€¼æˆåŠŸ: {MemberId}, é‡‘é¢: {Amount:F2}, ä½™é¢: {Balance:F2}",
            member.Id,
            command.Amount,
            member.Balance
        );

        return Result.Ok();
    }
}
```

---

### 3. DeductBalanceï¼ˆæ‰£å‡ä½™é¢ï¼‰

> âš ï¸ **å†…éƒ¨å‘½ä»¤**: æ­¤å‘½ä»¤ä¸æš´éœ² HTTP ç«¯ç‚¹ï¼Œä»…ä¾›å…¶ä»–æ¨¡å—é€šè¿‡æ¶ˆæ¯æ€»çº¿è°ƒç”¨

```csharp
// DeductBalance.cs
namespace Zss.BilliardHall.Modules.Members.DeductBalance;

public sealed record DeductBalance(
    Guid MemberId,
    decimal Amount,
    string Reason  // æ‰£å‡åŸå› ï¼ˆå¦‚ï¼šæ”¯ä»˜è®¢å•ã€æ¶ˆè´¹ç­‰ï¼‰
);
```

```csharp
// DeductBalanceHandler.cs
namespace Zss.BilliardHall.Modules.Members.DeductBalance;

public sealed class DeductBalanceHandler
{
    [Transactional]
    public async Task<Result> Handle(
        DeductBalance command,
        IDocumentSession session,
        IMessageBus bus,
        ILogger<DeductBalanceHandler> logger,
        CancellationToken ct = default)
    {
        var member = await session.LoadAsync<Member>(command.MemberId, ct);
        if (member == null)
            return Result.Fail("ä¼šå‘˜ä¸å­˜åœ¨");

        // æ‰£å‡ï¼ˆä¼šæ£€æŸ¥ä½™é¢æ˜¯å¦è¶³å¤Ÿï¼‰
        try
        {
            var oldBalance = member.Balance;
            member.Deduct(command.Amount);

            session.Store(member);
            await session.SaveChangesAsync(ct);

            await bus.PublishAsync(new BalanceDeducted(
                member.Id,
                command.Amount,
                oldBalance,
                member.Balance,
                command.Reason,
                DateTimeOffset.UtcNow
            ), ct);

            logger.LogInformation(
                "ä¼šå‘˜ä½™é¢æ‰£å‡æˆåŠŸ: {MemberId}, é‡‘é¢: {Amount:F2}, åŸå› : {Reason}",
                member.Id,
                command.Amount,
                command.Reason
            );

            return Result.Ok();
        }
        catch (InvalidOperationException ex)
        {
            return Result.Fail(ex.Message);
        }
    }
}
```

---

### 4. GetMemberï¼ˆæŸ¥è¯¢ä¼šå‘˜ä¿¡æ¯ï¼‰

```csharp
// GetMember.cs
namespace Zss.BilliardHall.Modules.Members.GetMember;

public sealed record GetMember(Guid MemberId);

public sealed record MemberDto(
    Guid Id,
    string Name,
    string Phone,
    string Email,
    MemberTier Tier,
    decimal Balance,
    int Points,
    DateTimeOffset RegisteredAt
);
```

```csharp
// GetMemberHandler.cs
namespace Zss.BilliardHall.Modules.Members.GetMember;

public sealed class GetMemberHandler
{
    public async Task<Result<MemberDto>> Handle(
        GetMember query,
        IDocumentSession session,
        CancellationToken ct = default)
    {
        var member = await session.LoadAsync<Member>(query.MemberId, ct);
        
        if (member == null)
            return Result.Fail<MemberDto>("ä¼šå‘˜ä¸å­˜åœ¨");

        var dto = new MemberDto(
            member.Id,
            member.Name,
            member.Phone,
            member.Email,
            member.Tier,
            member.Balance,
            member.Points,
            member.RegisteredAt
        );

        return Result.Ok(dto);
    }
}
```

```csharp
// GetMemberEndpoint.cs
namespace Zss.BilliardHall.Modules.Members.GetMember;

public sealed class GetMemberEndpoint
{
    [WolverineGet("/api/members/{memberId:guid}")]
    public static async Task<IResult> Get(
        Guid memberId,
        IMessageBus bus)
    {
        var result = await bus.InvokeAsync<Result<MemberDto>>(
            new GetMember(memberId)
        );

        return result.IsSuccess
            ? Results.Ok(result.Value)
            : Results.NotFound(new { error = result.Error });
    }
}
```

---

## ğŸ”” é¢†åŸŸäº‹ä»¶

### MemberRegisteredï¼ˆä¼šå‘˜å·²æ³¨å†Œï¼‰

```csharp
// Events/MemberRegistered.cs
namespace Zss.BilliardHall.Modules.Members.Events;

public sealed record MemberRegistered(
    Guid MemberId,
    string Name,
    string Phone,
    DateTimeOffset RegisteredAt
);
```

**è®¢é˜…è€…ç¤ºä¾‹**ï¼ˆå…¶ä»–æ¨¡å—ï¼‰:
```csharp
// åœ¨å…¶ä»–æ¨¡å—ä¸­ç›‘å¬
public class MemberRegisteredHandler
{
    public async Task Handle(
        MemberRegistered @event,
        ILogger<MemberRegisteredHandler> logger)
    {
        // å‘é€æ¬¢è¿é‚®ä»¶ã€çŸ­ä¿¡ç­‰
        logger.LogInformation(
            "æ–°ä¼šå‘˜æ³¨å†Œ: {MemberName}, æ‰‹æœºå·: {Phone}",
            @event.Name,
            @event.Phone
        );
    }
}
```

### BalanceToppedUpï¼ˆä½™é¢å·²å……å€¼ï¼‰

```csharp
// Events/BalanceToppedUp.cs
namespace Zss.BilliardHall.Modules.Members.Events;

public sealed record BalanceToppedUp(
    Guid MemberId,
    decimal Amount,
    decimal OldBalance,
    decimal NewBalance,
    DateTimeOffset ToppedUpAt
);
```

### BalanceDeductedï¼ˆä½™é¢å·²æ‰£å‡ï¼‰

```csharp
// Events/BalanceDeducted.cs
namespace Zss.BilliardHall.Modules.Members.Events;

public sealed record BalanceDeducted(
    Guid MemberId,
    decimal Amount,
    decimal OldBalance,
    decimal NewBalance,
    string Reason,
    DateTimeOffset DeductedAt
);
```

---

## ğŸ”— è·¨æ¨¡å—é€šä¿¡

### ç›‘å¬å¤–éƒ¨äº‹ä»¶

#### PaymentCompletedHandlerï¼ˆç›‘å¬æ”¯ä»˜å®Œæˆäº‹ä»¶ï¼‰

```csharp
// Handlers/PaymentCompletedHandler.cs
namespace Zss.BilliardHall.Modules.Members.Handlers;

public sealed class PaymentCompletedHandler
{
    public async Task Handle(
        PaymentCompleted @event,  // æ¥è‡ª Payments æ¨¡å—
        IDocumentSession session,
        IMessageBus bus,
        ILogger<PaymentCompletedHandler> logger,
        CancellationToken ct = default)
    {
        if (@event.MemberId == null)
            return; // æ•£å®¢ï¼Œæ— éœ€å¤„ç†

        // è®¡ç®—ç§¯åˆ†ï¼ˆæ¶ˆè´¹ 1 å…ƒ = 1 ç§¯åˆ†ï¼‰
        var points = (int)Math.Floor(@event.Amount);

        // å‘é€èµ é€ç§¯åˆ†å‘½ä»¤
        await bus.InvokeAsync(new AwardPoints(
            @event.MemberId.Value,
            points,
            $"æ¶ˆè´¹èµ é€ï¼šè®¢å• {@event.OrderId}"
        ), ct);

        logger.LogInformation(
            "æ”¯ä»˜å®Œæˆï¼Œèµ é€ç§¯åˆ†: {MemberId}, ç§¯åˆ†: {Points}",
            @event.MemberId,
            points
        );
    }
}
```

### è¢«å…¶ä»–æ¨¡å—è°ƒç”¨

å…¶ä»–æ¨¡å—é€šè¿‡æ¶ˆæ¯æ€»çº¿è°ƒç”¨ Members æ¨¡å—çš„å‘½ä»¤ï¼š

```csharp
// åœ¨ Payments æ¨¡å—ä¸­æ‰£å‡ä¼šå‘˜ä½™é¢
public class ProcessPaymentHandler
{
    public async Task Handle(
        ProcessPayment command,
        IMessageBus bus)
    {
        if (command.PaymentMethod == PaymentMethod.MemberBalance)
        {
            // è°ƒç”¨ Members æ¨¡å—æ‰£å‡ä½™é¢
            var result = await bus.InvokeAsync<Result>(
                new DeductBalance(
                    command.MemberId,
                    command.Amount,
                    $"æ”¯ä»˜è®¢å•: {command.OrderId}"
                )
            );

            if (!result.IsSuccess)
            {
                // å¤„ç†ä½™é¢ä¸è¶³ç­‰é”™è¯¯
                throw new PaymentException(result.Error);
            }
        }
    }
}
```

---

## ğŸ§ª æµ‹è¯•ç¤ºä¾‹

### å•å…ƒæµ‹è¯•

```csharp
public class RegisterMemberHandlerTests
{
    [Fact]
    public async Task Should_Register_Member_Successfully()
    {
        // Arrange
        await using var store = DocumentStore.For(opts =>
        {
            opts.Connection(ConnectionSource.InMemoryConnectionString);
            opts.AutoCreateSchemaObjects = AutoCreate.All;
        });

        await using var session = store.LightweightSession();
        var bus = Substitute.For<IMessageBus>();
        var passwordHasher = Substitute.For<IPasswordHasher>();
        var logger = Substitute.For<ILogger<RegisterMemberHandler>>();

        var handler = new RegisterMemberHandler();
        var command = new RegisterMember(
            "å¼ ä¸‰",
            "13800138000",
            "zhangsan@example.com",
            "password123"
        );

        // Act
        var result = await handler.Handle(
            command,
            session,
            passwordHasher,
            bus,
            logger
        );

        // Assert
        result.IsSuccess.Should().BeTrue();
        result.Value.Should().NotBeEmpty();

        var member = await session.LoadAsync<Member>(result.Value);
        member.Should().NotBeNull();
        member.Name.Should().Be("å¼ ä¸‰");
        member.Phone.Should().Be("13800138000");
        member.Tier.Should().Be(MemberTier.Regular);
        member.Balance.Should().Be(0);
    }

    [Fact]
    public async Task Should_Fail_When_Phone_Already_Registered()
    {
        // Arrange
        await using var store = DocumentStore.For(opts =>
        {
            opts.Connection(ConnectionSource.InMemoryConnectionString);
            opts.AutoCreateSchemaObjects = AutoCreate.All;
        });

        await using var session = store.LightweightSession();

        // é¢„å…ˆåˆ›å»ºä¸€ä¸ªä¼šå‘˜
        var existingMember = new Member
        {
            Id = Guid.NewGuid(),
            Phone = "13800138000",
            Name = "å·²å­˜åœ¨çš„ä¼šå‘˜"
        };
        session.Store(existingMember);
        await session.SaveChangesAsync();

        var handler = new RegisterMemberHandler();
        var command = new RegisterMember(
            "å¼ ä¸‰",
            "13800138000",  // ç›¸åŒæ‰‹æœºå·
            "zhangsan@example.com",
            "password123"
        );

        // Act
        var result = await handler.Handle(
            command,
            session,
            Substitute.For<IPasswordHasher>(),
            Substitute.For<IMessageBus>(),
            Substitute.For<ILogger<RegisterMemberHandler>>()
        );

        // Assert
        result.IsSuccess.Should().BeFalse();
        result.Error.Should().Contain("å·²æ³¨å†Œ");
    }
}
```

---

## ğŸ“ å¼€å‘è§„èŒƒ

### å‘½åçº¦å®š

- Command: åŠ¨è¯ + åè¯ï¼ˆ`RegisterMember`, `TopUpBalance`ï¼‰
- Query: Get/Find/List + åè¯ï¼ˆ`GetMember`, `ListMembers`ï¼‰
- Event: åè¯ + åŠ¨è¯è¿‡å»å¼ï¼ˆ`MemberRegistered`, `BalanceToppedUp`ï¼‰
- Handler: æ¶ˆæ¯å + Handlerï¼ˆ`RegisterMemberHandler`ï¼‰

### éªŒè¯è§„åˆ™

- ä½¿ç”¨ FluentValidation è¿›è¡Œè¾“å…¥éªŒè¯
- Handler ä¸­åªå¤„ç†ä¸šåŠ¡è§„åˆ™éªŒè¯
- é¢†åŸŸæ¨¡å‹ä¸­åŒ…å«ä¸å˜é‡éªŒè¯ï¼ˆå¦‚ `Deduct` æ–¹æ³•æ£€æŸ¥ä½™é¢ï¼‰

### æ—¥å¿—è§„èŒƒ

```csharp
// âœ… ç»“æ„åŒ–æ—¥å¿—
logger.LogInformation(
    "ä¼šå‘˜æ³¨å†ŒæˆåŠŸ: {MemberId}, æ‰‹æœºå·: {Phone}",
    member.Id,
    member.Phone
);

// âŒ é¿å…å­—ç¬¦ä¸²æ‹¼æ¥
logger.LogInformation($"ä¼šå‘˜æ³¨å†ŒæˆåŠŸ: {member.Id}");
```

### é”™è¯¯å¤„ç†

- ä½¿ç”¨ `Result<T>` ç±»å‹è¿”å›ç»“æœ
- é¢†åŸŸå¼‚å¸¸ç”¨ `InvalidOperationException`
- ä¸åœ¨ Handler ä¸­ç›´æ¥æŠ›å‡ºä¸šåŠ¡å¼‚å¸¸ï¼ˆè¿”å› Result.Failï¼‰

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒæ¶æ„

- **[Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)** â­â­â­
- **[ç³»ç»Ÿæ¨¡å—åˆ’åˆ† - Members](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#7-members-æ¨¡å—ä¼šå‘˜ä½“ç³»)** â­â­
- **[Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—.md)** â­â­â­

### ç›¸å…³æ¨¡å—

- **Payments æ¨¡å—**: æ”¯ä»˜å®Œæˆåè®¡ç®—ç§¯åˆ†
- **Sessions æ¨¡å—**: æ•£å®¢ vs. ä¼šå‘˜æ—¶æ®µç®¡ç†
- **Billing æ¨¡å—**: ä¼šå‘˜æŠ˜æ‰£è®¡ç®—

### å†å²æ–‡æ¡£

- **[ä¼šå‘˜ç®¡ç†æ¨¡å— v1ï¼ˆlegacyï¼‰](legacy/ä¼šå‘˜ç®¡ç†æ¨¡å—_v1.md)**: åŸºäº ABP åˆ†å±‚æ¶æ„çš„æ—§ç‰ˆæœ¬æ–‡æ¡£ï¼Œä»…ä¾›å‚è€ƒ

---

*æœ€åæ›´æ–°: 2024-01-15 | ç‰ˆæœ¬: v3.0.0 | æ¶æ„: Wolverine + å‚ç›´åˆ‡ç‰‡*
