# çº§è”æ¶ˆæ¯ä¸å‰¯ä½œç”¨å®è·µæŒ‡å—

> **ç›®æ ‡è¯»è€…**: æ‰€æœ‰ä½¿ç”¨ Wolverine Handler å¼€å‘çš„å›¢é˜Ÿæˆå‘˜
>
> **é˜…è¯»æ—¶é—´**: 20 åˆ†é’Ÿ
>
> **å‰ç½®è¦æ±‚**: 
> - ç†Ÿæ‚‰ Wolverine Handler åŸºç¡€
> - äº†è§£å‚ç›´åˆ‡ç‰‡æ¶æ„
> - é˜…è¯»è¿‡ [Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)

---

## ä¸€ã€è®¾è®¡ç›®æ ‡ä¸é€‚ç”¨èŒƒå›´

### 1.1 è®¾è®¡ç›®æ ‡

æœ¬æ–‡æ¡£ä½œä¸º Zss.BilliardHall åœ¨"è½¬å‘ Wolverine + Marten å‚ç›´åˆ‡ç‰‡æ¶æ„"è¿‡ç¨‹ä¸­çš„å®è·µè§„èŒƒï¼Œèšç„¦ä¸¤ä¸ªèƒ½åŠ›ï¼š

- **çº§è”æ¶ˆæ¯ï¼ˆCascading Messagesï¼‰**ï¼šç”¨è¿”å›å€¼é©±åŠ¨ `PublishAsync`ï¼Œè®© Handler æ›´çº¯ã€æ›´æ˜“æµ‹ã€‚
- **å‰¯ä½œç”¨ï¼ˆSide Effects / Storage Side Effectsï¼‰**ï¼šå°†"å¯¹å¤–éƒ¨ä¸–ç•ŒåŠ¨æ‰‹"çš„ IO ä» Handler ä¸­å‰¥ç¦»å‡ºå»ã€‚

**ç›®æ ‡**ï¼šè®©å‚ç›´åˆ‡ç‰‡é‡Œçš„ Handler åªåš"å†³ç­–å’Œç¼–æ’"ï¼Œè€Œé"åˆåšå†³ç­–åˆåš IO"ï¼Œé™ä½å¤æ‚åº¦ã€æå‡å¯æµ‹è¯•æ€§ã€‚

åœ¨ Wolverine + Marten å‚ç›´åˆ‡ç‰‡ä¸­ï¼Œæˆ‘ä»¬å¸Œæœ›è¾¾åˆ°ï¼š

- **Handler æ›´"å‡½æ•°å¼"**ï¼š
  - è¾“å…¥ï¼šCommand / Event / è¯·æ±‚ DTO
  - è¾“å‡ºï¼šé¢†åŸŸç»“æœ + éœ€è¦å‘é€çš„æ¶ˆæ¯ / å‰¯ä½œç”¨æè¿°
- **IO éƒ½é€šè¿‡ Wolverine çš„è¿è¡Œæ—¶å®Œæˆ**ï¼š
  - çº§è”æ¶ˆæ¯ï¼šç”± Wolverine è‡ªåŠ¨ `PublishAsync`
  - å‰¯ä½œç”¨ï¼šé€šè¿‡ `ISideEffect` / `IStorageAction<T>` / `UnitOfWork<T>` æ‰§è¡Œ
- **å•å…ƒæµ‹è¯•åªä¾èµ–å†…å­˜å¯¹è±¡**ï¼Œä¸ä¾èµ–æ¶ˆæ¯æ€»çº¿ã€æ•°æ®åº“ã€æ–‡ä»¶ç³»ç»Ÿã€‚

### 1.2 é€‚ç”¨èŒƒå›´

æœ¬æ–‡æ¡£é€‚ç”¨äºï¼š

- æ‰€æœ‰ Wolverine å‚ç›´åˆ‡ç‰‡æ¨¡å—ï¼ˆå¦‚ `Members`, `Sessions`, `Billing` ç­‰ï¼‰ã€‚
- æ‰€æœ‰ Handler ç±»å‹ï¼š
  - æ¶ˆæ¯ Handlerï¼ˆmessage handlersï¼‰
  - Wolverine HTTP Endpoint Handlerï¼ˆASP.NET Core é›†æˆï¼‰

---

## äºŒã€æ¦‚å¿µé€Ÿè§ˆ

### 2.1 çº§è”æ¶ˆæ¯ï¼ˆCascading Messagesï¼‰

**å«ä¹‰**ï¼š
- Handler æ–¹æ³•çš„**è¿”å›å€¼**ä¼šè¢« Wolverine è‡ªåŠ¨è§†ä¸º"éœ€è¦å‘å¸ƒçš„æ¶ˆæ¯"ã€‚
- ç›¸å½“äºéšå¼æ‰§è¡Œ `IMessageBus.PublishAsync()`ã€‚

**ç‰¹ç‚¹**ï¼š
- åœ¨**åŸå§‹æ¶ˆæ¯æˆåŠŸå¤„ç†ä¸”äº‹åŠ¡æäº¤å**å‘é€ã€‚
- ä¸åŸå§‹æ¶ˆæ¯çš„å¤„ç†æœ‰ç‹¬ç«‹é‡è¯•é€»è¾‘ã€‚

**å¸¸è§è¿”å›ç±»å‹**ï¼š
- å•ä¸ªæ¶ˆæ¯ç±»å‹ï¼š`MyEvent`
- `object`ï¼ˆæ¡ä»¶åˆ†æ”¯è¿”å›ä¸åŒç±»å‹ï¼‰
- `IEnumerable<object>` / `object[]` / `IAsyncEnumerable<object>`
- C# Tupleï¼š`(Message1, Message2)`
- `OutgoingMessages`ï¼šå¢å¼ºç‰ˆé›†åˆï¼ˆæ”¯æŒå»¶è¿Ÿã€è°ƒåº¦ã€RespondToSender ç­‰ï¼‰

### 2.2 å‰¯ä½œç”¨ï¼ˆSide Effectsï¼‰

**é€šç”¨å‰¯ä½œç”¨**ï¼š
- å®ç° `ISideEffect` æ¥å£ï¼Œæä¾› `Execute` / `ExecuteAsync(...)` æ–¹æ³•ã€‚
- ç”¨äºè¡¨è¾¾å¤–éƒ¨ IOï¼ˆæ–‡ä»¶ã€å¤–éƒ¨ HTTPã€é˜Ÿåˆ—ç­‰ï¼‰ã€‚

**å­˜å‚¨å‰¯ä½œç”¨ï¼ˆStorage Side Effectsï¼‰**ï¼š
- é€šè¿‡è¿”å› `IStorageAction<T>` / `UnitOfWork<T>` è¡¨è¾¾"å¯¹æ•°æ®åº“çš„å†™å…¥è®¡åˆ’"ã€‚
- Wolverine + Marten / EF Core / RavenDB è‡ªåŠ¨æ‰§è¡Œè¿™äº› actionï¼Œå¹¶åŒ…è£¹äº‹åŠ¡ã€‚

---

## ä¸‰ã€Handler èŒè´£çº¦æŸï¼ˆå¼ºåˆ¶è§„èŒƒï¼‰

### 3.1 Handler å…è®¸åšçš„äº‹ï¼ˆç™½åå•ï¼‰

åœ¨ Wolverine å‚ç›´åˆ‡ç‰‡ä¸­ï¼ŒHandler åº”**åªåš**ä»¥ä¸‹äº‹æƒ…ï¼š

- **åŠ è½½é¢†åŸŸå¯¹è±¡ / æ–‡æ¡£**ï¼š
  - `IDocumentSession.LoadAsync<T>` / `QueryAsync<T>`ï¼ˆæˆ– storage side effect è‡ªåŠ¨æ³¨å…¥å®ä½“ï¼‰
- **è°ƒç”¨é¢†åŸŸå¯¹è±¡æ–¹æ³•**ï¼š
  - å¦‚ `member.TopUp(...)`, `member.Deduct(...)`, `member.AwardPoints(...)`
- **æŠŠå˜æ›´å†™å›æŒä¹…åŒ–**ï¼š
  - è¦ä¹ˆ `session.Store(entity)`ï¼ˆé…åˆ `[Transactional]`ï¼‰
  - è¦ä¹ˆè¿”å› `IStorageAction<T> / UnitOfWork<T>`ï¼ˆstorage side effectï¼‰
- **å†³å®šè¦è¿”å›çš„**ï¼š
  - é¢†åŸŸç»“æœï¼ˆå¦‚ `Result` / DTOï¼‰
  - çº§è”æ¶ˆæ¯ï¼ˆäº‹ä»¶ï¼‰
  - å‰¯ä½œç”¨ï¼ˆ`ISideEffect` / storage side effectï¼‰

### 3.2 Handler ç¦æ­¢åšçš„äº‹ï¼ˆé»‘åå•ï¼‰

- âŒ **åœ¨ Handler ä¸­ç›´æ¥å†™å¤æ‚ä¸šåŠ¡ if/else**ï¼ˆåº”æ”¾åˆ°èšåˆæ ¹ / å€¼å¯¹è±¡ / Domain Serviceï¼‰ã€‚
- âŒ **åœ¨ Handler ä¸­ç›´æ¥è°ƒç”¨å¤–éƒ¨ IO**ï¼š
  - å¤–éƒ¨ HTTP API / SDK
  - æ–‡ä»¶ç³»ç»Ÿ / Redis / MQ ç­‰
  - åº”é€šè¿‡ `ISideEffect` æŠ½å–ã€‚
- âŒ **åœ¨ Handler ä¸­åˆ°å¤„ `logger.LogInformation/Warning/Error`**ï¼š
  - é™¤éæ˜¯è¾¹ç•Œæ—¥å¿—ï¼ˆå¦‚"å®ä½“ä¸å­˜åœ¨"ã€"å¤–éƒ¨ä¾èµ–æ•…éšœ"ï¼‰ã€‚
  - ä¸šåŠ¡å¤±è´¥è¯·é€šè¿‡ `Result` / é”™è¯¯ç è¡¨è¾¾ã€‚
- âŒ **è‡ªå·±æ˜¾å¼åˆ›å»ºäº‹åŠ¡ / æ‰‹åŠ¨ `SaveChanges`**ï¼š
  - ç»Ÿä¸€äº¤ç»™ Wolverine `[Transactional]` æˆ– storage side effect å¤„ç†ã€‚

---

## å››ã€çº§è”æ¶ˆæ¯å®è·µè§„èŒƒ

### 4.1 åŸºæœ¬æ¨¡å¼ï¼šç”¨è¿”å›å€¼ä»£æ›¿ `PublishAsync`

ä»¥ Members æ¨¡å—ä¸­çš„å……å€¼ä¸ºä¾‹ï¼š  
**ç›®æ ‡**ï¼šå®Œæˆä½™é¢å……å€¼é€»è¾‘ï¼Œå¹¶å‘å¸ƒ `BalanceToppedUp` äº‹ä»¶ã€‚

#### âŒ ä¸æ¨èå†™æ³•ï¼ˆæ‰‹åŠ¨ PublishAsyncï¼‰ï¼š

```csharp
public sealed class TopUpBalanceHandler
{
    [Transactional]
    public async Task<Result> Handle(
        TopUpBalance command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        var member = await session.LoadAsync<Member>(command.MemberId, ct);
        if (member is null)
            return Result.NotFound(nameof(Member), command.MemberId);

        var result = member.TopUp(command.Amount);
        if (result.IsFailure)
            return result;

        session.Store(member);

        await bus.PublishAsync(new BalanceToppedUp(
            member.Id,
            command.Amount,
            DateTimeOffset.UtcNow
        ), ct);

        return Result.Success();
    }
}
```

#### âœ… æ¨èå†™æ³•ï¼ˆçº§è”æ¶ˆæ¯ï¼‰ï¼š

```csharp
public sealed class TopUpBalanceHandler
{
    [Transactional]
    public async Task<(Result Result, BalanceToppedUp? Event)> Handle(
        TopUpBalance command,
        IDocumentSession session,
        CancellationToken ct = default)
    {
        var member = await session.LoadAsync<Member>(command.MemberId, ct);
        if (member is null)
            return (Result.NotFound(nameof(Member), command.MemberId), null);

        var result = member.TopUp(command.Amount);
        if (result.IsFailure)
            return (result, null);

        session.Store(member);

        var @event = new BalanceToppedUp(
            member.Id,
            command.Amount,
            DateTimeOffset.UtcNow
        );

        // Wolverine ä¼šè‡ªåŠ¨å°† BalanceToppedUp è§†ä¸ºçº§è”æ¶ˆæ¯å‘é€
        return (Result.Success(), @event);
    }
}
```

**è¦ç‚¹**ï¼š

- Handler è¿”å› tupleï¼š`(Result, BalanceToppedUp?)`
- å•å…ƒæµ‹è¯•å¯ä»¥ï¼š
  - æ–­è¨€ `Result`
  - æ–­è¨€è¿”å›çš„äº‹ä»¶å¯¹è±¡å†…å®¹
- Wolverine åœ¨åŸå§‹æ¶ˆæ¯æˆåŠŸå¤„ç†åï¼Œä¼šè‡ªåŠ¨å‘å¸ƒ `BalanceToppedUp`ã€‚
- Handler ä¸å†éœ€è¦æ³¨å…¥ `IMessageBus`ï¼Œæµ‹è¯•æ›´ç®€å•ã€‚

### 4.2 å¤šäº‹ä»¶åœºæ™¯ï¼šä½¿ç”¨ `OutgoingMessages` / å¤šè¿”å›é¡¹

å½“éœ€è¦å‘å¤šä¸ªäº‹ä»¶ / ä¸åŒç±»å‹æ¶ˆæ¯æ—¶ï¼Œæ¨èä½¿ç”¨ `OutgoingMessages`ï¼š

```csharp
public sealed class DeductBalanceHandler
{
    [Transactional]
    public async Task<(Result Result, OutgoingMessages Messages)> Handle(
        DeductBalance command,
        IDocumentSession session,
        CancellationToken ct = default)
    {
        var member = await session.LoadAsync<Member>(command.MemberId, ct);
        if (member is null)
            return (Result.NotFound(nameof(Member), command.MemberId), new OutgoingMessages());

        var result = member.Deduct(command.Amount);
        if (result.IsFailure)
            return (result, new OutgoingMessages());

        session.Store(member);

        var messages = new OutgoingMessages
        {
            new BalanceDeducted(member.Id, command.Amount, DateTimeOffset.UtcNow),
        };

        // ä¾‹å¦‚ï¼š1 å°æ—¶åå‘èµ·ä¸€æ¬¡å¯¹è´¦ä»»åŠ¡
        messages.Delay(
            new StartReconciliation(member.Id),
            1.Hours()
        );

        return (Result.Success(), messages);
    }
}
```

**ä¼˜åŠ¿**ï¼š

- é›†ä¸­æè¿°æ‰€æœ‰å¾…å‘é€æ¶ˆæ¯ï¼›
- æ”¯æŒï¼š
  - `RespondToSender(message)`
  - `Delay(message, TimeSpan)`
  - `Schedule(message, DateTimeOffset)`
- ä¾¿äºæµ‹è¯•æ—¶ä¸€æ¬¡æ€§æ–­è¨€æ‰€æœ‰çº§è”æ¶ˆæ¯ã€‚

### 4.3 æ¡ä»¶çº§è”æ¶ˆæ¯ï¼šè¿”å› `object` / `IEnumerable<object>`

å½“è¿”å›æ¶ˆæ¯ç±»å‹ä¸ç¡®å®šæ—¶ï¼Œå¯ä»¥è®© Handler è¿”å› `object`ï¼š

```csharp
public sealed class AwardPointsHandler
{
    [Transactional]
    public async Task<object?> Handle(
        AwardPoints command,
        IDocumentSession session,
        CancellationToken ct = default)
    {
        var member = await session.LoadAsync<Member>(command.MemberId, ct);
        if (member is null)
            return new MemberNotFound(command.MemberId);

        var result = member.AwardPoints(command.Points);
        if (result.IsFailure)
            return new PointsAwardFailed(command.MemberId, result.Error);

        session.Store(member);

        return new PointsAwarded(member.Id, command.Points, DateTimeOffset.UtcNow);
    }
}
```

**æ³¨æ„**ï¼š

- è¿”å› `null` â†’ Wolverine å¿½ç•¥ï¼Œä¸å‘é€æ¶ˆæ¯ã€‚
- å»ºè®®ï¼š**å°½é‡ç”¨æ˜ç¡®çš„äº‹ä»¶ç±»å‹å’Œ tuple**ï¼Œ`object` ä»…ç”¨äºç¡®å®éœ€è¦å¤šç§åˆ†æ”¯ç±»å‹ã€éš¾ä»¥ç»Ÿä¸€ç­¾åçš„æƒ…å†µã€‚

### 4.4 Request/Reply ä¸çº§è”æ¶ˆæ¯çš„å…³ç³»

- è‹¥ä¸Šæ¸¸ç”¨ `InvokeAsync<TResponse>()` å‘èµ·è¯·æ±‚ï¼š
  - Handler è¿”å›çš„ `TResponse` **ä¸ä¼š**è¢«å½“æˆæ™®é€šçº§è”æ¶ˆæ¯å¹¿æ’­ï¼›
  - åªä¼šä½œä¸º"å›å¤"å›åˆ°è°ƒç”¨æ–¹ã€‚
- é€‚ç”¨åœºæ™¯ï¼š
  - å†…éƒ¨å‘½ä»¤ï¼Œå¦‚ `DeductBalance` è¢« Billing æ¨¡å—ç”¨ `InvokeAsync<Result>` è°ƒç”¨ï¼›
  - å¸Œæœ›æ‹¿åˆ°ç»“æœï¼Œä½†ä¸å¹¿æ’­åˆ°æ€»çº¿ã€‚

---

## äº”ã€å‰¯ä½œç”¨å®è·µè§„èŒƒï¼ˆSide Effectsï¼‰

### 5.1 é€šç”¨ `ISideEffect`ï¼šå¤–éƒ¨ IO ç»Ÿä¸€å°è£…

**åœºæ™¯**ï¼šæ³¨å†Œä¼šå‘˜åå‘é€æ¬¢è¿çŸ­ä¿¡ã€‚

#### SideEffect å®šä¹‰ï¼š

```csharp
public class SendWelcomeSms : ISideEffect
{
    public Guid MemberId { get; }
    public string Phone { get; }

    public SendWelcomeSms(Guid memberId, string phone)
    {
        MemberId = memberId;
        Phone = phone;
    }

    // Wolverine ä¼šè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•
    public async Task ExecuteAsync(
        ISmsClient smsClient,
        ILogger<SendWelcomeSms> logger,
        CancellationToken ct = default)
    {
        await smsClient.SendAsync(Phone, "æ¬¢è¿åŠ å…¥å°çƒä¿±ä¹éƒ¨ï¼", ct);
        logger.LogInformation("å‘é€æ¬¢è¿çŸ­ä¿¡æˆåŠŸ {MemberId} {Phone}", MemberId, Phone);
    }
}
```

#### Handler ä¸­è¿”å› SideEffectï¼š

```csharp
public sealed class RegisterMemberHandler
{
    [Transactional]
    public async Task<(Result Result, SendWelcomeSms? SideEffect)> Handle(
        RegisterMember command,
        IDocumentSession session,
        CancellationToken ct = default)
    {
        var existing = await session
            .Query<Member>()
            .SingleOrDefaultAsync(x => x.Phone == command.Phone, ct);

        if (existing is not null)
            return (Result.Failure(MemberErrors.PhoneAlreadyExists), null);

        var member = Member.Register(command.Name, command.Phone);
        session.Store(member);

        var effect = new SendWelcomeSms(member.Id, member.Phone);

        // SideEffect ç”± Wolverine è°ƒç”¨ ExecuteAsync
        return (Result.Success(), effect);
    }
}
```

**ä¼˜ç‚¹**ï¼š

- Handler ä¸ä¾èµ– `ISmsClient`ã€ä¸ç›´æ¥è°ƒç”¨ HTTPï¼›
- æµ‹è¯• Handler æ—¶ï¼Œåªéœ€æ–­è¨€æ˜¯å¦è¿”å› `SendWelcomeSms`ï¼›
- `ISmsClient` çš„æµ‹è¯•æ”¾åœ¨å•ç‹¬çš„é›†æˆæµ‹è¯•é‡Œã€‚

> **æ³¨æ„**ï¼šè¿”å›ç±»å‹ä¸èƒ½æ˜¯ `ISideEffect` æ¥å£ï¼Œå¿…é¡»æ˜¯å…·ä½“ç±»å‹ï¼ˆWolverine æ–‡æ¡£è¦æ±‚ï¼‰ã€‚

### 5.2 å­˜å‚¨å‰¯ä½œç”¨ï¼š`IStorageAction<T>` / `UnitOfWork<T>`

åœ¨ Marten é›†æˆä¸­ï¼Œå¯ä»¥ç”¨å­˜å‚¨å‰¯ä½œç”¨æ›¿ä»£æ˜¾å¼ `IDocumentSession.Store`ã€‚

#### å•å®ä½“å†™å…¥ç¤ºä¾‹ï¼ˆç§¯åˆ†å‘æ”¾ï¼‰ï¼š

```csharp
public static class AwardPointsHandler
{
    public static IStorageAction<Member> Handle(
        AwardPoints command,
        Member? member,         // å¯é€šè¿‡ Marten æ³¨å…¥å½“å‰æ–‡æ¡£
        IClock clock)
    {
        if (member is null)
        {
            // ä»€ä¹ˆéƒ½ä¸åš
            return Storage.Nothing<Member>();
        }

        var result = member.AwardPoints(command.Points, clock.UtcNow);
        if (result.IsFailure)
        {
            return Storage.Nothing<Member>();
        }

        // Store å¯¹äº Marten = upsert
        return Storage.Store(member);
    }
}
```

#### æ‰¹é‡å†™å…¥ç¤ºä¾‹ï¼ˆæ‰¹é‡åˆ›å»º Todoï¼Œä»…ä½œæ¼”ç¤ºï¼‰ï¼š

```csharp
public record StoreMany(string[] Adds);

public static class StoreManyHandler
{
    public static UnitOfWork<Todo> Handle(StoreMany command)
    {
        var uow = new UnitOfWork<Todo>();

        foreach (var add in command.Adds)
        {
            uow.Insert(new Todo { Id = add });
        }

        return uow;
    }
}
```

**ç‰¹ç‚¹**ï¼š

- Handler åªè¡¨è¾¾"åº”å¯¹å“ªäº›å®ä½“æ‰§è¡Œä»€ä¹ˆæ“ä½œ"ï¼›
- Wolverine + Marten ä¼šè‡ªåŠ¨ï¼š
  - åœ¨æ­£ç¡®çš„ Session ä¸Šæ‰§è¡Œ `Insert` / `Update` / `Store` / `Delete`ï¼›
  - åŒ…è£¹äº‹åŠ¡ã€‚

åœ¨ Billiard é¡¹ç›®ä¸­ï¼Œå¯ä»¥è€ƒè™‘å¯¹**å¤æ‚èšåˆå†™æ¨¡å‹**ä¼˜å…ˆä½¿ç”¨ storage side effect æ¨¡å¼ï¼Œç®€åŒ– Handler é€»è¾‘ã€‚

---

## å…­ã€ä¸æµ‹è¯•ç­–ç•¥çš„è¡”æ¥

### 6.1 å•å…ƒæµ‹è¯•

**é’ˆå¯¹ Handler**ï¼š

**Arrange**ï¼š
- æ„é€  Commandï¼›
- å‡†å¤‡èšåˆæ ¹ï¼ˆå¯ç”¨å†…å­˜å¯¹è±¡ï¼Œæˆ– stub å‡º `Member` å®ä¾‹ï¼‰ã€‚

**Act**ï¼š
- ç›´æ¥è°ƒç”¨ Handler æ–¹æ³•ï¼Œä¸éœ€è¦çœŸå® IMessageBusã€æ•°æ®åº“ã€çŸ­ä¿¡æœåŠ¡ã€‚

**Assert**ï¼š
- æ–­è¨€è¿”å›çš„ `Result` / DTOï¼›
- æ–­è¨€è¿”å›çš„çº§è”æ¶ˆæ¯ï¼ˆäº‹ä»¶ï¼‰å¯¹è±¡ï¼›
- æ–­è¨€è¿”å›çš„ `ISideEffect` / `IStorageAction<T>` ç±»å‹å’Œå†…å®¹ã€‚

**ç¤ºä¾‹**ï¼š

```csharp
[Fact]
public async Task TopUpBalance_ShouldReturnSuccessAndEvent_WhenMemberExists()
{
    // Arrange
    var member = new Member { Id = Guid.NewGuid(), Balance = 100 };
    var command = new TopUpBalance(member.Id, 50);
    var session = A.Fake<IDocumentSession>();
    A.CallTo(() => session.LoadAsync<Member>(member.Id, A<CancellationToken>._))
        .Returns(member);

    var handler = new TopUpBalanceHandler();

    // Act
    var (result, @event) = await handler.Handle(command, session);

    // Assert
    result.IsSuccess.Should().BeTrue();
    @event.Should().NotBeNull();
    @event!.MemberId.Should().Be(member.Id);
    @event.Amount.Should().Be(50);
    member.Balance.Should().Be(150);
}
```

**é’ˆå¯¹èšåˆæ ¹ï¼ˆé¢†åŸŸæ¨¡å‹ï¼‰**ï¼š

- ç‹¬ç«‹æµ‹è¯• `Member.Deduct`, `Member.TopUp`, `Member.AwardPoints` ç­‰æ–¹æ³•ï¼›
- ä¸æ¶‰åŠä»»ä½• Wolverine/Marten ç±»å‹ï¼Œä»…çº¯ C# é€»è¾‘ã€‚

### 6.2 é›†æˆæµ‹è¯•

- å¯¹äºè·¨æ¨¡å— / ç«¯åˆ°ç«¯éªŒè¯ï¼š
  - é€šè¿‡ Testcontainers èµ· PostgreSQLï¼›
  - å¯åŠ¨ Bootstrapper / æŸä¸ªæ¨¡å—çš„ Hostï¼›
  - å‘é€ HTTP / æ¶ˆæ¯ï¼Œè§‚å¯Ÿæ•°æ®åº“ã€æ¶ˆæ¯æ€»çº¿è¡Œä¸ºã€‚
- ç‰¹åˆ«æ³¨æ„ï¼š
  - SideEffect å’Œçº§è”æ¶ˆæ¯çš„"çœŸæ­£ IO"è¡Œä¸ºï¼Œå±äºé›†æˆæµ‹è¯•è´£ä»»ï¼›
  - Handler å±‚å•å…ƒæµ‹è¯•åªå…³æ³¨"è¿”å›å€¼æ­£ç¡®è¡¨è¾¾äº†è¦åšçš„äº‹"ã€‚

---

## ä¸ƒã€Code Review æ£€æŸ¥æ¸…å•

åœ¨ Wolverine å‚ç›´åˆ‡ç‰‡ç›¸å…³ PR ä¸­ï¼ŒReviewer åº”è‡³å°‘æ£€æŸ¥ï¼š

### 7.1 çº§è”æ¶ˆæ¯ç›¸å…³

- [ ] Handler æœªæ˜¾å¼è°ƒç”¨ `IMessageBus.PublishAsync`ï¼ˆé™¤éæœ‰ç‰¹æ®ŠåŸå› ï¼‰
- [ ] ä½¿ç”¨è¿”å›å€¼è¡¨è¾¾çº§è”æ¶ˆæ¯ï¼ˆtuple / OutgoingMessages / objectï¼‰
- [ ] è¿”å›å€¼ç±»å‹æ˜ç¡®ï¼ˆä¼˜å…ˆä½¿ç”¨å…·ä½“äº‹ä»¶ç±»å‹è€Œé objectï¼‰
- [ ] å¤±è´¥è·¯å¾„è¿”å› null æˆ–ç©º OutgoingMessagesï¼ˆä¸å‘é€æ¶ˆæ¯ï¼‰

### 7.2 å‰¯ä½œç”¨ç›¸å…³

- [ ] Handler æœªç›´æ¥è°ƒç”¨å¤–éƒ¨ IOï¼ˆHTTPã€æ–‡ä»¶ã€é˜Ÿåˆ—ç­‰ï¼‰ï¼Œæ­¤ç±»é€»è¾‘ä»¥ `ISideEffect` è¡¨è¾¾
- [ ] SideEffect ç±»å‹ä¸ºå…·ä½“ç±»ï¼ˆéæ¥å£ï¼‰
- [ ] SideEffect åŒ…å«å¿…è¦çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆIDã€å‚æ•°ç­‰ï¼‰
- [ ] å¦‚ä½¿ç”¨å­˜å‚¨å‰¯ä½œç”¨ï¼šæŒä¹…åŒ–æ“ä½œä»¥ `IStorageAction<T>` / `UnitOfWork<T>` è¡¨è¾¾ï¼Œæœªæ‰‹åŠ¨ SaveChanges

### 7.3 Handler èŒè´£

- [ ] Handler ä¸­çš„ä¸šåŠ¡è§„åˆ™ä¸»è¦ä½“ç°åœ¨èšåˆæ ¹ / å€¼å¯¹è±¡æ–¹æ³•ä¸­ï¼Œè€Œé Handler å†… if/else
- [ ] Handler ä¸åŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼ˆåº”å§”æ‰˜ç»™é¢†åŸŸå¯¹è±¡ï¼‰
- [ ] ä½¿ç”¨ `[Transactional]` è‡ªåŠ¨äº‹åŠ¡ç®¡ç†
- [ ] æœªæ‰‹åŠ¨åˆ›å»ºäº‹åŠ¡æˆ–è°ƒç”¨ SaveChanges

### 7.4 æµ‹è¯•è¦†ç›–

- [ ] å•å…ƒæµ‹è¯•è¦†ç›–äº†ï¼š
  - Handler è¿”å›å€¼ï¼ˆResult + çº§è”æ¶ˆæ¯ / å‰¯ä½œç”¨ï¼‰
  - èšåˆæ ¹æ ¸å¿ƒä¸šåŠ¡è§„åˆ™
- [ ] é›†æˆæµ‹è¯•è¦†ç›–äº†ï¼š
  - çº§è”æ¶ˆæ¯çš„å®é™…å‘å¸ƒ
  - å‰¯ä½œç”¨çš„å®é™…æ‰§è¡Œ

---

## å…«ã€æ‰©å±•ä¸åç»­å®è·µå»ºè®®

### 8.1 æ¨¡å—å¤åˆ¶æ¨¡æ¿

å»ºè®®ä» Members æ¨¡å—ä¸­æŒ‘é€‰ä¸€ä¸ª"ç¤ºèŒƒåˆ‡ç‰‡"ï¼ˆå¦‚ RegisterMember + AwardPointsï¼‰ï¼Œæ•´ç†ä¸º"å‚ç›´åˆ‡ç‰‡æ¨¡æ¿"ï¼ŒåŒ…æ‹¬ï¼š

- Command / Handler / Endpoint æ ‡å‡†ç»“æ„
- çº§è”æ¶ˆæ¯è¿”å›æ¨¡å¼
- å‰¯ä½œç”¨å°è£…ç¤ºä¾‹
- å•å…ƒæµ‹è¯•æ¨¡æ¿

### 8.2 ç»Ÿä¸€é”™è¯¯æ¨¡å‹

å°† `Result` / é”™è¯¯ç ç»Ÿä¸€ä¸ºä¸€ä¸ªåº“ï¼ŒHandler è¿”å›å’Œé¢†åŸŸæ–¹æ³•è¿”å›ä¿æŒä¸€è‡´ï¼š

- ä½¿ç”¨ `Result.Success()` / `Result.Fail()` è¡¨è¾¾æ“ä½œç»“æœ
- ä½¿ç”¨ç»“æ„åŒ–é”™è¯¯ç ï¼ˆå¦‚ `MemberErrors.PhoneAlreadyExists`ï¼‰
- å¤±è´¥æ—¶ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œè€Œæ˜¯è¿”å› Result

### 8.3 æ–‡æ¡£è¡¥å……

åœ¨ `doc/06_å¼€å‘è§„èŒƒ/` ä¸‹æŒç»­å®Œå–„ï¼š

- ã€ŠWolverine å‰¯ä½œç”¨ä¸å­˜å‚¨ SideEffect å®è·µã€‹ï¼ˆæœ¬æ–‡æ¡£ï¼‰
- ã€ŠWolverine çº§è”æ¶ˆæ¯ä¸è¿”å›å€¼è§„èŒƒã€‹ï¼ˆæœ¬æ–‡æ¡£ï¼‰
- æŒç»­æ›´æ–°ç¤ºä¾‹å’Œæœ€ä½³å®è·µ

### 8.4 å·¥å…·æ”¯æŒ

è€ƒè™‘æ·»åŠ ï¼š

- Roslyn Analyzerï¼šæ£€æµ‹ Handler ä¸­ç›´æ¥è°ƒç”¨ `PublishAsync`
- Code Snippetsï¼šå¿«é€Ÿç”Ÿæˆçº§è”æ¶ˆæ¯ / å‰¯ä½œç”¨æ¨¡æ¿
- é¡¹ç›®æ¨¡æ¿ï¼šä¸€é”®ç”Ÿæˆæ ‡å‡†å‚ç›´åˆ‡ç‰‡ç»“æ„

---

## ä¹ã€å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: ä»€ä¹ˆæ—¶å€™ä½¿ç”¨çº§è”æ¶ˆæ¯ï¼Œä»€ä¹ˆæ—¶å€™ä½¿ç”¨ PublishAsyncï¼Ÿ

**A**: ç»å¤§å¤šæ•°æƒ…å†µä½¿ç”¨çº§è”æ¶ˆæ¯ï¼ˆè¿”å›å€¼ï¼‰ã€‚åªæœ‰ä»¥ä¸‹ç‰¹æ®Šæƒ…å†µè€ƒè™‘ `PublishAsync`ï¼š

- éœ€è¦åœ¨äº‹åŠ¡å¤–å‘é€æ¶ˆæ¯ï¼ˆæå°‘è§ï¼‰
- éœ€è¦ç«‹å³å‘é€æ¶ˆæ¯è€Œéç­‰å¾…äº‹åŠ¡æäº¤
- é—ç•™ä»£ç é‡æ„è¿‡æ¸¡æœŸ

### Q2: çº§è”æ¶ˆæ¯ä¼šå’ŒåŸå§‹æ¶ˆæ¯åœ¨åŒä¸€ä¸ªäº‹åŠ¡å—ï¼Ÿ

**A**: ä¸ä¼šã€‚çº§è”æ¶ˆæ¯åœ¨**åŸå§‹æ¶ˆæ¯çš„äº‹åŠ¡æäº¤å**æ‰å‘é€ï¼Œæœ‰ç‹¬ç«‹çš„é‡è¯•é€»è¾‘ã€‚è¿™ä¿è¯äº†ï¼š

- åŸå§‹æ¶ˆæ¯å¤„ç†å¤±è´¥æ—¶ï¼Œä¸ä¼šå‘é€çº§è”æ¶ˆæ¯
- çº§è”æ¶ˆæ¯å‘é€å¤±è´¥ä¸ä¼šå½±å“åŸå§‹æ¶ˆæ¯
- ç¬¦åˆæœ€ç»ˆä¸€è‡´æ€§æ¨¡å‹

### Q3: Handler è¿”å› tuple ä¼šè®©ä»£ç å˜å¤æ‚å—ï¼Ÿ

**A**: ä¸ä¼šã€‚ç›¸æ¯”æ³¨å…¥ `IMessageBus` å¹¶æ‰‹åŠ¨è°ƒç”¨ `PublishAsync`ï¼š

- ä»£ç è¡Œæ•°ç›¸åŒæˆ–æ›´å°‘
- æµ‹è¯•æ›´ç®€å•ï¼ˆä¸éœ€è¦ mock IMessageBusï¼‰
- è¯­ä¹‰æ›´æ¸…æ™°ï¼ˆè¿”å›å€¼å°±æ˜¯"è®¡åˆ’è¦åšçš„äº‹"ï¼‰

### Q4: ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ ISideEffectï¼Œä»€ä¹ˆæ—¶å€™ç›´æ¥è°ƒç”¨å¤–éƒ¨æœåŠ¡ï¼Ÿ

**A**: åˆ¤æ–­æ ‡å‡†ï¼š

- âœ… ä½¿ç”¨ ISideEffectï¼šå‘é€çŸ­ä¿¡ã€é‚®ä»¶ã€è°ƒç”¨ç¬¬ä¸‰æ–¹ APIã€æ–‡ä»¶æ“ä½œ
- âŒ ç›´æ¥è°ƒç”¨ï¼šè¯»å–é…ç½®ã€è·å–å½“å‰æ—¶é—´ï¼ˆæ³¨å…¥ IClockï¼‰ã€å†™æ—¥å¿—ï¼ˆILoggerï¼‰

åŸåˆ™ï¼šå‡¡æ˜¯"å¯¹å¤–éƒ¨ä¸–ç•Œæœ‰å‰¯ä½œç”¨"çš„æ“ä½œï¼Œéƒ½åº”è¯¥å°è£…ä¸º ISideEffectã€‚

### Q5: å­˜å‚¨å‰¯ä½œç”¨ï¼ˆIStorageActionï¼‰ç›¸æ¯” [Transactional] æœ‰ä»€ä¹ˆä¼˜åŠ¿ï¼Ÿ

**A**: å­˜å‚¨å‰¯ä½œç”¨é€‚ç”¨äºï¼š

- æ›´ç»†ç²’åº¦çš„æ§åˆ¶ï¼ˆå¦‚æ¡ä»¶æ€§å†™å…¥ï¼‰
- æ‰¹é‡æ“ä½œï¼ˆUnitOfWorkï¼‰
- éœ€è¦è¿”å›å­˜å‚¨æ“ä½œæœ¬èº«ä½œä¸º"è®¡åˆ’"

`[Transactional]` é€‚ç”¨äºï¼š

- å¸¸è§„ CRUD æ“ä½œ
- ç®€å•çš„é¢†åŸŸå¯¹è±¡æŒä¹…åŒ–
- å›¢é˜Ÿæ›´ç†Ÿæ‚‰çš„æ¨¡å¼

**å»ºè®®**ï¼šä¼˜å…ˆä½¿ç”¨ `[Transactional]`ï¼Œåœ¨éœ€è¦æ›´å¤šæ§åˆ¶æ—¶å†ä½¿ç”¨å­˜å‚¨å‰¯ä½œç”¨ã€‚

---

## åã€ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´å†…å®¹ |
|------|------|----------|
| 1.0.0 | 2026-01-12 | åˆå§‹ç‰ˆæœ¬ï¼Œè¦†ç›–çº§è”æ¶ˆæ¯ä¸å‰¯ä½œç”¨å®Œæ•´å®è·µè§„èŒƒ |

---

## ç›¸å…³æ–‡æ¡£

- [Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)
- [Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—.md)
- [ä¼šå‘˜ç®¡ç†æ¨¡å—](../04_æ¨¡å—è®¾è®¡/ä¼šå‘˜ç®¡ç†æ¨¡å—.md)
- [æ‰“çƒæ—¶æ®µæ¨¡å—](../04_æ¨¡å—è®¾è®¡/æ‰“çƒæ—¶æ®µæ¨¡å—.md)
- [Sagaä½¿ç”¨æŒ‡å—](./Sagaä½¿ç”¨æŒ‡å—.md)
- [FluentValidationé›†æˆæŒ‡å—](./FluentValidationé›†æˆæŒ‡å—.md)
- [åˆ‡ç‰‡çº¦æŸ](./åˆ‡ç‰‡çº¦æŸ.md)

---

ğŸ’¡ **æ ¸å¿ƒåŸåˆ™**ï¼šHandler æ˜¯"å†³ç­–è€…"ï¼Œä¸æ˜¯"æ‰§è¡Œè€…"ã€‚é€šè¿‡çº§è”æ¶ˆæ¯å’Œå‰¯ä½œç”¨ï¼Œè®© Handler ä¸“æ³¨äºä¸šåŠ¡ç¼–æ’ï¼ŒIO äº¤ç»™ Wolverine è¿è¡Œæ—¶ã€‚
