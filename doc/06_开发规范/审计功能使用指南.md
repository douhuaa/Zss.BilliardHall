---
title: "审计功能使用指南"
description: "Wolverine 模块审计追踪功能的使用说明"
version: "1.0.0"
author: "架构团队"
created: "2026-01-12"
updated: "2026-01-12"
category: "开发规范"
level: "推荐"
audience: ["后端开发工程师"]
keywords: ["审计", "audit", "tracking", "时间戳"]
tags: ["audit", "tracking", "best-practices"]
---

# 审计功能使用指南

## 概述

本文档说明如何在 Wolverine 模块中使用审计功能来跟踪实体的创建和修改历史。

## 审计接口

系统提供三个级别的审计接口，位于 `BuildingBlocks/Core/IAuditedEntity.cs`：

### 1. ICreationAuditedEntity - 创建审计

记录实体创建时间：

```csharp
public interface ICreationAuditedEntity
{
    DateTimeOffset CreatedAt { get; }
}
```

### 2. IModificationAuditedEntity - 修改审计

记录实体最后修改时间：

```csharp
public interface IModificationAuditedEntity
{
    DateTimeOffset? UpdatedAt { get; }
}
```

### 3. IFullAuditedEntity - 完整审计

记录时间戳和用户信息：

```csharp
public interface IFullAuditedEntity : ICreationAuditedEntity, IModificationAuditedEntity
{
    string? CreatedBy { get; }
    string? UpdatedBy { get; }
}
```

## 使用方式

### 实现完整审计

```csharp
public class Member : IFullAuditedEntity
{
    // 业务属性
    public Guid Id { get; private set; }
    public string Name { get; private set; }
    
    // 审计属性
    public DateTimeOffset CreatedAt { get; private set; }
    public DateTimeOffset? UpdatedAt { get; private set; }
    public string? CreatedBy { get; private set; }
    public string? UpdatedBy { get; private set; }
    
    // 业务方法应调用 UpdateAuditInfo()
    public void UpdateProfile(string name)
    {
        Name = name;
        UpdateAuditInfo();  // 自动更新 UpdatedAt
    }
    
    // 辅助方法
    public void UpdateAuditInfo(string? userId = null)
    {
        UpdatedAt = DateTimeOffset.UtcNow;
        if (!string.IsNullOrEmpty(userId))
        {
            UpdatedBy = userId;
        }
    }
    
    public void SetCreator(string userId)
    {
        CreatedBy = userId;
    }
}
```

### 在 Handler 中设置创建人

```csharp
[Transactional]
public async Task<Result> Handle(
    RegisterMember command,
    IDocumentSession session,
    ClaimsPrincipal? user,  // 从 HTTP 上下文注入
    CancellationToken ct)
{
    var member = Member.CreateInstance(command);
    
    // 设置创建人（如果有认证用户）
    if (user?.Identity?.IsAuthenticated == true)
    {
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (!string.IsNullOrEmpty(userId))
        {
            member.SetCreator(userId);
        }
    }
    
    session.Store(member);
    return Result.Success();
}
```

### 在 Handler 中更新修改人

```csharp
[Transactional]
public async Task<Result> Handle(
    UpdateMemberProfile command,
    IDocumentSession session,
    ClaimsPrincipal? user,
    CancellationToken ct)
{
    var member = await session.LoadAsync<Member>(command.MemberId, ct);
    if (member is null) return Result.NotFound();
    
    member.UpdateProfile(command.Name);
    
    // 设置修改人
    if (user?.Identity?.IsAuthenticated == true)
    {
        var userId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        member.UpdateAuditInfo(userId);
    }
    else
    {
        member.UpdateAuditInfo();  // 无用户信息，只更新时间
    }
    
    session.Store(member);
    return Result.Success();
}
```

## 最佳实践

### ✅ 推荐做法

1. **使用 UTC 时间**：所有时间戳使用 `DateTimeOffset.UtcNow`
2. **在业务方法中调用**：所有修改实体状态的方法应调用 `UpdateAuditInfo()`
3. **可选用户信息**：支持匿名操作，用户信息可选
4. **只读属性**：审计字段使用 `private set` 防止外部篡改
5. **在创建时设置**：`CreatedAt` 在实体创建时自动设置

### ❌ 避免做法

1. **不要在查询中修改**：只读查询不应触发审计更新
2. **不要使用本地时间**：避免时区混淆
3. **不要暴露可写属性**：审计字段不应有 public setter
4. **不要忘记调用**：业务方法修改状态后忘记调用 `UpdateAuditInfo()`

## 与 Marten 集成

审计字段作为文档属性自动存储在 Marten 中，无需额外配置：

```json
{
  "Id": "guid-value",
  "Name": "张三",
  "CreatedAt": "2026-01-12T10:00:00Z",
  "UpdatedAt": "2026-01-12T15:30:00Z",
  "CreatedBy": "user-123",
  "UpdatedBy": "user-456"
}
```

## 查询审计信息

### 查询最近修改的实体

```csharp
var recentlyUpdated = await session
    .Query<Member>()
    .Where(m => m.UpdatedAt != null && m.UpdatedAt > DateTime.UtcNow.AddDays(-7))
    .OrderByDescending(m => m.UpdatedAt)
    .ToListAsync(ct);
```

### 查询特定用户创建的实体

```csharp
var membersByUser = await session
    .Query<Member>()
    .Where(m => m.CreatedBy == userId)
    .ToListAsync(ct);
```

## 测试示例

```csharp
[Fact]
public void UpdateProfile_ShouldUpdateAuditInfo()
{
    // Arrange
    var member = Member.CreateInstance(...);
    var beforeUpdate = DateTimeOffset.UtcNow;

    // Act
    member.UpdateProfile("新名字");

    // Assert
    member.UpdatedAt.Should().NotBeNull();
    member.UpdatedAt.Should().BeOnOrAfter(beforeUpdate);
}

[Fact]
public void UpdateAuditInfo_WithUserId_ShouldSetUpdatedBy()
{
    // Arrange
    var member = Member.CreateInstance(...);
    const string userId = "user-123";

    // Act
    member.UpdateAuditInfo(userId);

    // Assert
    member.UpdatedAt.Should().NotBeNull();
    member.UpdatedBy.Should().Be(userId);
}
```

## 扩展到其他实体

当创建新的聚合根时，按以下步骤添加审计功能：

1. 实现 `IFullAuditedEntity` 接口
2. 添加四个审计属性（CreatedAt, UpdatedAt, CreatedBy, UpdatedBy）
3. 在构造函数/工厂方法中设置 `CreatedAt`
4. 在所有业务方法中调用 `UpdateAuditInfo()`
5. 复制 `UpdateAuditInfo()` 和 `SetCreator()` 辅助方法
6. 添加单元测试验证审计功能

## 参考示例

完整实现参考：`src/Wolverine/Modules/Members/Member.cs`

单元测试参考：`src/Wolverine/Bootstrapper.Tests/Members/MemberTests.cs`

---

## 相关文档

- [Wolverine模块化架构蓝图](../03_系统架构设计/Wolverine模块化架构蓝图.md)
- [会员管理模块](../04_模块设计/会员管理模块.md)
- [代码风格](代码风格.md)
