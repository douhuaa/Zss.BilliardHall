---
title: "å…³é”®è¡¨è¯´æ˜"
description: "æ ¸å¿ƒä¸šåŠ¡è¡¨è¯¦ç»†è®¾è®¡è¯´æ˜å’Œä¸šåŠ¡é€»è¾‘åˆ†æ"
section: "5.3"
version: "1.0.0"
author: "ä¸šåŠ¡åˆ†æå¸ˆ"
maintainer: "å¼€å‘å·¥ç¨‹å¸ˆ"
created: "2024-01-01"
updated: "2024-01-15"
category: "æ•°æ®åº“è®¾è®¡"
level: "å¿…è¯»"
audience: ["å¼€å‘å·¥ç¨‹å¸ˆ", "æµ‹è¯•å·¥ç¨‹å¸ˆ", "ä¸šåŠ¡åˆ†æå¸ˆ"]
keywords: ["å…³é”®è¡¨", "ä¸šåŠ¡é€»è¾‘", "æ•°æ®æ¨¡å‹", "å®ä½“å…³ç³»", "ä¸šåŠ¡è§„åˆ™", "æ•°æ®ä¸€è‡´æ€§"]
tags: ["business-logic", "data-model", "core-tables", "entity-relationships"]
status: "å®Œæˆ"
dependencies: ["05_æ•°æ®åº“è®¾è®¡/è¡¨ç»“æ„å®šä¹‰.md"]
related_docs: ["05_æ•°æ®åº“è®¾è®¡/æ•°æ®è¿ç§»æ–¹æ¡ˆ.md", "05_æ•°æ®åº“è®¾è®¡/ç´¢å¼•ä¸ä¼˜åŒ–.md"]
reading_time: "35åˆ†é’Ÿ"
difficulty: "ä¸­çº§"
---

# 5.3 å…³é”®è¡¨è¯´æ˜

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“Š æ•°æ®åº“è®¾è®¡](README.md) > ğŸ’¡ å…³é”®è¡¨è¯´æ˜

<!-- Keywords for Search -->
**å…³é”®è¯**: `å…³é”®è¡¨` `ä¸šåŠ¡é€»è¾‘` `æ•°æ®æ¨¡å‹` `å®ä½“å…³ç³»` `ä¸šåŠ¡è§„åˆ™` `æ•°æ®ä¸€è‡´æ€§`

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜è‡ªåŠ©å°çƒç³»ç»Ÿä¸­çš„å…³é”®è¡¨è®¾è®¡æ€è·¯ã€ä¸šåŠ¡é€»è¾‘å’Œä½¿ç”¨åœºæ™¯ï¼ŒåŸºäº EF Core Code First æ–¹å¼å®ç°ã€‚

> ğŸ’¡ **ç›¸å…³ç« èŠ‚**ï¼š
> - å®ä½“ç±»å®šä¹‰å’Œæ•°æ®åº“æ˜ å°„è¯·å‚è€ƒ [5.2 è¡¨ç»“æ„å®šä¹‰](è¡¨ç»“æ„å®šä¹‰.md)
> - æ•°æ®åº“è¿ç§»å’Œç‰ˆæœ¬ç®¡ç†è¯·å‚è€ƒ [5.5 æ•°æ®è¿ç§»æ–¹æ¡ˆ](æ•°æ®è¿ç§»æ–¹æ¡ˆ.md)
> - æ€§èƒ½ä¼˜åŒ–ç­–ç•¥è¯·å‚è€ƒ [5.4 ç´¢å¼•ä¸ä¼˜åŒ–](ç´¢å¼•ä¸ä¼˜åŒ–.md)

## æ ¸å¿ƒä¸šåŠ¡è¡¨è¯¦ç»†è¯´æ˜

### 1. é—¨åº—è¡¨ (Stores)

#### ä¸šåŠ¡ä½œç”¨
- æ”¯æŒå¤šé—¨åº—ç®¡ç†ï¼Œæ¯ä¸ªé—¨åº—ç‹¬ç«‹è¿è¥
- ä½œä¸ºçƒå°ã€è®¾å¤‡ã€å‘˜å·¥ç­‰èµ„æºçš„ç®¡ç†è¾¹ç•Œ
- æä¾›é—¨åº—åŸºæœ¬ä¿¡æ¯å’Œè¥ä¸šæ—¶é—´ç®¡ç†

#### å…³é”®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡è§„åˆ™ |
|-------|------|------|----------|
| Name | string(100) | é—¨åº—åç§° | å¿…å¡«ï¼ŒåŒä¸€è¿è¥å•†ä¸‹ä¸é‡å¤ |
| Address | string(500) | è¯¦ç»†åœ°å€ | ç”¨äºå¯¼èˆªå’Œé…é€ |
| ContactPhone | string(20) | è”ç³»ç”µè¯ | å®¢æœå’Œç´§æ€¥è”ç³» |
| Status | enum | è¥ä¸šçŠ¶æ€ | Active/Inactive/Maintenance |
| OpenTime | TimeSpan | å¼€å§‹è¥ä¸šæ—¶é—´ | ç”¨äºè‡ªåŠ¨å¼€å°é™åˆ¶ |
| CloseTime | TimeSpan | ç»“æŸè¥ä¸šæ—¶é—´ | ç”¨äºè‡ªåŠ¨å…³å°å’Œç»“ç®— |

#### å…³è”å…³ç³»
```csharp
// ä¸€å¯¹å¤šå…³ç³»
public virtual ICollection<BilliardTable> Tables { get; set; }  // é—¨åº—ä¸‹çš„çƒå°
public virtual ICollection<Device> Devices { get; set; }        // é—¨åº—è®¾å¤‡
public virtual ICollection<Employee> Employees { get; set; }    // é—¨åº—å‘˜å·¥
```

#### ä½¿ç”¨åœºæ™¯
1. **é—¨åº—ç­›é€‰**ï¼šç”¨æˆ·é€‰æ‹©å°±è¿‘é—¨åº—
2. **è¥ä¸šæ§åˆ¶**ï¼šæ ¹æ®è¥ä¸šæ—¶é—´è‡ªåŠ¨å¯åœæœåŠ¡
3. **è®¾å¤‡ç®¡ç†**ï¼šæŒ‰é—¨åº—ç®¡ç†è®¾å¤‡å’Œçƒå°
4. **æ•°æ®éš”ç¦»**ï¼šå¤šé—¨åº—æ•°æ®æƒé™éš”ç¦»

### 2. çƒå°è¡¨ (BilliardTables)

#### ä¸šåŠ¡ä½œç”¨
- å°çƒå…çš„æ ¸å¿ƒèµ„äº§ï¼Œæ‰¿è½½ç”¨æˆ·æ¶ˆè´¹çš„ç‰©ç†è½½ä½“
- ç®¡ç†çƒå°çŠ¶æ€ï¼Œç¡®ä¿èµ„æºåˆç†åˆ†é…
- è®°å½•è®¾å¤‡å¥åº·çŠ¶æ€å’ŒæœåŠ¡è´¨é‡

#### å…³é”®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡è§„åˆ™ |
|-------|------|------|----------|
| TableNumber | string(20) | å°å· | é—¨åº—å†…å”¯ä¸€ï¼Œå¦‚"001"ã€"VIP-A" |
| Status | enum | å°å­çŠ¶æ€ | Available/Occupied/Reserved/Maintenance/OutOfOrder |
| Type | enum | çƒå°ç±»å‹ | Standard/Snooker/Americanï¼Œå½±å“å®šä»· |
| HourlyRate | decimal(18,2) | å°æ—¶åŸºç¡€ä»·æ ¼ | åŸºå‡†å®šä»·ï¼Œå¯è¢«ä¿ƒé”€è§„åˆ™è¦†ç›– |
| IsOnline | bool | è®¾å¤‡åœ¨çº¿çŠ¶æ€ | ç¦»çº¿æ—¶ä¸å¯å¼€å° |
| LastHeartbeatTime | DateTime? | æœ€åå¿ƒè·³æ—¶é—´ | ç”¨äºåˆ¤æ–­è®¾å¤‡æ•…éšœ |

#### çŠ¶æ€è½¬æ¢é€»è¾‘

```mermaid
stateDiagram-v2
    [*] --> Available : åˆå§‹çŠ¶æ€
    Available --> Reserved : é¢„çº¦
    Available --> Occupied : å¼€å°
    Reserved --> Occupied : é¢„çº¦å¼€å°
    Reserved --> Available : å–æ¶ˆé¢„çº¦
    Occupied --> Available : ç»“æŸä¼šè¯
    Available --> Maintenance : ç»´æŠ¤
    Maintenance --> Available : ç»´æŠ¤å®Œæˆ
    Available --> OutOfOrder : æ•…éšœ
    OutOfOrder --> Available : ä¿®å¤å®Œæˆ
```

#### å…³é”®ä¸šåŠ¡è§„åˆ™
1. **åŸå­æ€§å¼€å°**ï¼šçŠ¶æ€ä» Available -> Occupied å¿…é¡»åŸå­æ“ä½œ
2. **è®¾å¤‡å…³è”**ï¼šç¦»çº¿è®¾å¤‡ä¸å¯å¼€å°
3. **æ—¶é—´é™åˆ¶**ï¼šè¶…æ—¶æœªæ”¯ä»˜è‡ªåŠ¨é‡Šæ”¾
4. **ç»´æŠ¤çª—å£**ï¼šè¥ä¸šæ—¶é—´å¤–å¯è¿›å…¥ç»´æŠ¤çŠ¶æ€

### 3. ç”¨æˆ·è¡¨ (Users)

#### ä¸šåŠ¡ä½œç”¨
- ç”¨æˆ·èº«ä»½ç®¡ç†å’Œä¼šå‘˜ä½“ç³»æ ¸å¿ƒ
- è®°å½•ç”¨æˆ·æ¶ˆè´¹è¡Œä¸ºå’Œåå¥½
- æ”¯æŒç²¾å‡†è¥é”€å’Œå®¢æˆ·æœåŠ¡

#### å…³é”®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡è§„åˆ™ |
|-------|------|------|----------|
| Phone | string(50) | æ‰‹æœºå· | å”¯ä¸€æ ‡è¯†ï¼Œæ³¨å†Œç™»å½•å‡­è¯ |
| NickName | string(50) | æ˜µç§° | æ˜¾ç¤ºåç§°ï¼Œå¯é‡å¤ |
| Balance | decimal(18,2) | è´¦æˆ·ä½™é¢ | å……å€¼å’Œæ¶ˆè´¹çš„åŸºç¡€ |
| PlayCount | int | æ¸¸æˆæ¬¡æ•° | ç”¨æˆ·æ´»è·ƒåº¦æŒ‡æ ‡ |
| TotalPlayMinutes | int | æ€»æ¸¸æˆæ—¶é•¿ | ç”¨æˆ·ç²˜æ€§æŒ‡æ ‡ |
| TotalSpent | decimal(18,2) | ç´¯è®¡æ¶ˆè´¹ | ç”¨æˆ·ä»·å€¼åˆ†å±‚ |

#### ç”¨æˆ·çŠ¶æ€ç®¡ç†

```csharp
public enum UserStatus
{
    Active = 1,    // æ­£å¸¸ç”¨æˆ·ï¼Œå¯æ­£å¸¸æ¶ˆè´¹
    Inactive = 0,  // éæ´»è·ƒç”¨æˆ·ï¼Œéœ€è¦æ¿€æ´»
    Blocked = 2    // è¢«å°ç¦ç”¨æˆ·ï¼Œç¦æ­¢æ¶ˆè´¹
}
```

#### ä¸šåŠ¡è§„åˆ™
1. **æ‰‹æœºå·å”¯ä¸€æ€§**ï¼šé˜²æ­¢é‡å¤æ³¨å†Œ
2. **ä½™é¢éè´Ÿ**ï¼šæ‰£è´¹å‰æ£€æŸ¥ä½™é¢å……è¶³
3. **çŠ¶æ€æ§åˆ¶**ï¼šè¢«å°ç¦ç”¨æˆ·æ— æ³•å¼€å°
4. **æ•°æ®ç»Ÿè®¡**ï¼šå®æ—¶æ›´æ–°ç”¨æˆ·ç”»åƒæ•°æ®

### 4. å°çƒä¼šè¯è¡¨ (TableSessions)

#### ä¸šåŠ¡ä½œç”¨
- è®°å½•æ¯æ¬¡å°çƒæœåŠ¡çš„å®Œæ•´ç”Ÿå‘½å‘¨æœŸ
- è®¡è´¹è®¡ç®—çš„åŸºç¡€æ•°æ®
- ä¸šåŠ¡åˆ†æå’Œç”¨æˆ·è¡Œä¸ºåˆ†æçš„æ ¸å¿ƒæ•°æ®

#### å…³é”®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡è§„åˆ™ |
|-------|------|------|----------|
| SessionToken | string(36) | ä¼šè¯æ ‡è¯† | å”¯ä¸€æ ‡è¯†ï¼Œé˜²æ­¢é‡å¤æ“ä½œ |
| StartTime | DateTime | å¼€å§‹æ—¶é—´ | è®¡è´¹èµ·ç‚¹ï¼Œç²¾ç¡®åˆ°ç§’ |
| EndTime | DateTime? | ç»“æŸæ—¶é—´ | è®¡è´¹ç»ˆç‚¹ï¼Œnullè¡¨ç¤ºè¿›è¡Œä¸­ |
| PlayMinutes | int | å®é™…æ¸¸æˆæ—¶é•¿ | å»é™¤æš‚åœæ—¶é—´çš„å‡€æ—¶é•¿ |
| HourlyRate | decimal(18,2) | å½“æ—¶ä»·æ ¼ | å¿«ç…§ä»·æ ¼ï¼Œä¸å—åç»­è°ƒä»·å½±å“ |
| TotalAmount | decimal(18,2) | åŸå§‹é‡‘é¢ | åŸºç¡€è®¡è´¹é‡‘é¢ |
| DiscountAmount | decimal(18,2) | ä¼˜æƒ é‡‘é¢ | å„ç§æŠ˜æ‰£ä¼˜æƒ æ€»é¢ |
| FinalAmount | decimal(18,2) | æœ€ç»ˆé‡‘é¢ | å®é™…æ”¶è´¹é‡‘é¢ |

#### ä¼šè¯çŠ¶æ€ç®¡ç†

```csharp
public enum SessionStatus
{
    Active = 1,      // è¿›è¡Œä¸­ï¼Œæ­£åœ¨è®¡è´¹
    Completed = 2,   // å·²å®Œæˆï¼Œæ­£å¸¸ç»“æŸ
    Cancelled = 3,   // å·²å–æ¶ˆï¼Œå¼‚å¸¸ç»“æŸ
    Paused = 4       // æš‚åœä¸­ï¼Œæš‚åœè®¡è´¹
}
```

#### è®¡è´¹é€»è¾‘ç¤ºä¾‹

```csharp
public void UpdateBilling()
{
    if (Status != SessionStatus.Active) return;
    
    var currentTime = DateTime.Now;
    PlayMinutes = (int)(currentTime - StartTime).TotalMinutes;
    
    // åŸºç¡€é‡‘é¢è®¡ç®—
    TotalAmount = (decimal)PlayMinutes / 60 * HourlyRate;
    
    // åº”ç”¨ä¼˜æƒ è§„åˆ™
    DiscountAmount = CalculateDiscount();
    
    // æœ€ç»ˆé‡‘é¢
    FinalAmount = TotalAmount - DiscountAmount;
}
```

### 5. æ”¯ä»˜è®¢å•è¡¨ (PaymentOrders)

#### ä¸šåŠ¡ä½œç”¨
- ç®¡ç†æ‰€æœ‰æ”¯ä»˜ç›¸å…³çš„äº¤æ˜“è®°å½•
- å¯¹æ¥ç¬¬ä¸‰æ–¹æ”¯ä»˜å¹³å°çš„ä¸­é—´å±‚
- æ”¯æŒé€€æ¬¾ã€å¯¹è´¦ç­‰è´¢åŠ¡æ“ä½œ

#### å…³é”®å­—æ®µè¯´æ˜

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ä¸šåŠ¡è§„åˆ™ |
|-------|------|------|----------|
| OrderNo | string(32) | ç³»ç»Ÿè®¢å•å· | å”¯ä¸€ï¼Œæ ¼å¼ï¼šyyyyMMddHHmmss + 6ä½éšæœºæ•° |
| PaymentType | enum | æ”¯ä»˜ç±»å‹ | SessionPayment/Recharge/Refund |
| PaymentMethod | enum | æ”¯ä»˜æ–¹å¼ | WeChatPay/Alipay/Balance/Cash |
| Amount | decimal(18,2) | æ”¯ä»˜é‡‘é¢ | å®é™…æ”¯ä»˜é‡‘é¢ |
| ThirdPartyOrderNo | string(100) | ç¬¬ä¸‰æ–¹è®¢å•å· | å¾®ä¿¡ã€æ”¯ä»˜å®è¿”å›çš„è®¢å•å· |
| CallbackData | string | å›è°ƒæ•°æ® | å®Œæ•´çš„æ”¯ä»˜å›è°ƒä¿¡æ¯ï¼Œç”¨äºå¯¹è´¦ |

#### æ”¯ä»˜çŠ¶æ€æµè½¬

```mermaid
stateDiagram-v2
    [*] --> Pending : åˆ›å»ºè®¢å•
    Pending --> Paid : æ”¯ä»˜æˆåŠŸ
    Pending --> Failed : æ”¯ä»˜å¤±è´¥
    Pending --> Cancelled : è¶…æ—¶å–æ¶ˆ
    Paid --> Refunded : ç”³è¯·é€€æ¬¾
```

#### å¹‚ç­‰æ€§è®¾è®¡

```csharp
public async Task<PaymentResult> ProcessPaymentAsync(string orderNo, PaymentCallbackData callback)
{
    // å¹‚ç­‰æ€§æ£€æŸ¥
    var existingOrder = await _repository.FirstOrDefaultAsync(x => x.OrderNo == orderNo);
    if (existingOrder?.Status == PaymentStatus.Paid)
    {
        return PaymentResult.AlreadyProcessed(existingOrder);
    }
    
    // å¤„ç†æ”¯ä»˜é€»è¾‘...
}
```

### 6. è®¡è´¹å¿«ç…§è¡¨ (BillingSnapshots)

#### ä¸šåŠ¡ä½œç”¨
- è®°å½•è®¡è´¹è¿‡ç¨‹ä¸­çš„å…³é”®æ—¶ç‚¹æ•°æ®
- æ”¯æŒè®¡è´¹è§„åˆ™å˜æ›´åçš„å†å²æ•°æ®è¿½æº¯
- ä¸ºè®¡è´¹çº çº·æä¾›è¯¦ç»†çš„è®¡ç®—ä¾æ®

#### å¿«ç…§è§¦å‘æ—¶æœº
1. ä¼šè¯å¼€å§‹æ—¶åˆ›å»ºåˆå§‹å¿«ç…§
2. ä»·æ ¼è§„åˆ™å˜æ›´æ—¶åˆ›å»ºå¿«ç…§
3. åº”ç”¨ä¼˜æƒ æ—¶åˆ›å»ºå¿«ç…§
4. ä¼šè¯ç»“æŸæ—¶åˆ›å»ºæœ€ç»ˆå¿«ç…§

#### æ•°æ®ç»“æ„ç¤ºä¾‹

```json
{
  "pricingRules": {
    "baseRate": 30.00,
    "peakHourMultiplier": 1.2,
    "memberDiscount": 0.15,
    "appliedPromotions": [
      {
        "name": "æ–°ç”¨æˆ·é¦–å•ç«‹å‡",
        "discount": 5.00
      }
    ]
  }
}
```

### 7. è®¾å¤‡ç®¡ç†è¡¨ (Devices & DeviceHeartbeats)

#### è®¾å¤‡è¡¨ (Devices)
- ç®¡ç†é—¨åº—å†…æ‰€æœ‰æ™ºèƒ½è®¾å¤‡
- æ”¯æŒè®¾å¤‡è¿œç¨‹æ§åˆ¶å’ŒçŠ¶æ€ç›‘æ§
- ä¸ºè®¾å¤‡æ•…éšœé¢„è­¦æä¾›åŸºç¡€æ•°æ®

#### è®¾å¤‡å¿ƒè·³è¡¨ (DeviceHeartbeats)
- è®°å½•è®¾å¤‡å®æ—¶çŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡
- æ”¯æŒè®¾å¤‡å¥åº·ç›‘æ§å’Œæ•…éšœé¢„è­¦
- æ•°æ®é‡å¤§ï¼Œéœ€è¦è€ƒè™‘åˆ†åŒºå’Œå½’æ¡£ç­–ç•¥

#### å¿ƒè·³æ•°æ®ç¤ºä¾‹

```json
{
  "voltage": 12.5,
  "temperature": 35.2,
  "signalStrength": -45,
  "memoryUsage": 0.68,
  "cpuUsage": 0.23,
  "lastError": null
}
```

## æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 1. äº‹åŠ¡è¾¹ç•Œè®¾è®¡

```csharp
[UnitOfWork]
public async Task<SessionResult> StartSessionAsync(StartSessionRequest request)
{
    using var uow = _unitOfWorkManager.Begin(requiresNew: true, isTransactional: true);
    
    try
    {
        // 1. æ£€æŸ¥çƒå°çŠ¶æ€
        var table = await _tableRepository.GetAsync(request.TableId);
        if (table.Status != TableStatus.Available)
            throw new BusinessException("çƒå°ä¸å¯ç”¨");
        
        // 2. åŸå­æ€§æ›´æ–°çƒå°çŠ¶æ€
        table.Status = TableStatus.Occupied;
        await _tableRepository.UpdateAsync(table);
        
        // 3. åˆ›å»ºä¼šè¯è®°å½•
        var session = new TableSession
        {
            UserId = request.UserId,
            TableId = request.TableId,
            StartTime = DateTime.Now,
            Status = SessionStatus.Active,
            SessionToken = Guid.NewGuid().ToString("N"),
            HourlyRate = table.HourlyRate
        };
        
        await _sessionRepository.InsertAsync(session);
        
        // 4. åˆ›å»ºåˆå§‹è®¡è´¹å¿«ç…§
        var snapshot = CreateInitialBillingSnapshot(session);
        await _billingRepository.InsertAsync(snapshot);
        
        await uow.CompleteAsync();
        return SessionResult.Success(session);
    }
    catch (Exception ex)
    {
        await uow.RollbackAsync();
        throw;
    }
}
```

### 2. å¹¶å‘æ§åˆ¶

```csharp
// ä½¿ç”¨ä¹è§‚é”é˜²æ­¢å¹¶å‘å¼€å°
public class BilliardTable : FullAuditedAggregateRoot<long>
{
    [ConcurrencyCheck]
    public string ConcurrencyStamp { get; set; }
    
    // å…¶ä»–å±æ€§...
}

// æ›´æ–°æ—¶æ£€æŸ¥å¹¶å‘æ ‡è®°
var table = await _repository.GetAsync(tableId);
table.Status = TableStatus.Occupied;
table.ConcurrencyStamp = Guid.NewGuid().ToString();

try
{
    await _repository.UpdateAsync(table);
}
catch (DbUpdateConcurrencyException)
{
    throw new BusinessException("çƒå°çŠ¶æ€å·²è¢«å…¶ä»–æ“ä½œä¿®æ”¹ï¼Œè¯·é‡è¯•");
}
```

## æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. ç´¢å¼•è®¾è®¡åŸåˆ™

```sql
-- å¤åˆç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX IX_TableSessions_Table_Status_StartTime 
ON TableSessions (TableId, Status, StartTime);

-- åŒ…å«åˆ—ç´¢å¼•å‡å°‘å›è¡¨
CREATE INDEX IX_PaymentOrders_User_Status_Amount 
ON PaymentOrders (UserId, Status) 
INCLUDE (Amount, CreationTime);
```

### 2. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

```csharp
public async Task<PagedResultDto<SessionDto>> GetUserSessionsAsync(GetUserSessionsInput input)
{
    var query = await _repository.GetQueryableAsync();
    
    // é¿å…ä½¿ç”¨ Skip/Takeï¼Œä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ
    query = query.Where(x => x.UserId == input.UserId)
                 .Where(x => x.Id > input.LastId)  // æ¸¸æ ‡åˆ†é¡µ
                 .OrderBy(x => x.Id)
                 .Take(input.MaxResultCount);
    
    var sessions = await query.ToListAsync();
    return new PagedResultDto<SessionDto>(sessions.Count, 
        ObjectMapper.Map<List<SessionDto>>(sessions));
}
```

### 3. è¯»å†™åˆ†ç¦»

```csharp
// å†™æ“ä½œä½¿ç”¨ä¸»åº“
[UnitOfWork]
public async Task CreateSessionAsync(TableSession session)
{
    await _sessionRepository.InsertAsync(session);
}

// è¯»æ“ä½œä½¿ç”¨ä»åº“
[DisableAuditing]
public async Task<List<SessionStatDto>> GetSessionStatsAsync(DateTime date)
{
    var query = await _sessionRepository.WithDetailsAsync();
    // æ ‡è®°ä¸ºåªè¯»æŸ¥è¯¢ï¼Œè·¯ç”±åˆ°ä»åº“
    return await query.AsNoTracking()
                     .Where(x => x.StartTime.Date == date.Date)
                     .Select(x => new SessionStatDto { /* ... */ })
                     .ToListAsync();
}
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### åŒçº§æ–‡æ¡£
- [5.1 æ¦‚å¿µæ¨¡å‹ï¼ˆER å›¾ï¼‰](æ¦‚å¿µæ¨¡å‹_ERå›¾.md)
- [5.2 è¡¨ç»“æ„å®šä¹‰](è¡¨ç»“æ„å®šä¹‰.md)
- [5.4 ç´¢å¼•ä¸ä¼˜åŒ–](ç´¢å¼•ä¸ä¼˜åŒ–.md)
- [5.5 æ•°æ®è¿ç§»æ–¹æ¡ˆ](æ•°æ®è¿ç§»æ–¹æ¡ˆ.md)
- [5.6 EF Core å¼€å‘å·¥ä½œæµç¨‹](EFCoreå¼€å‘å·¥ä½œæµç¨‹.md)

### è¿”å›ä¸Šçº§
- [ğŸ”™ æ•°æ®åº“è®¾è®¡æ€»è§ˆ](README.md)
- [ğŸ  é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md)

### ç›¸å…³ç« èŠ‚
- [2. éœ€æ±‚è§„æ ¼è¯´æ˜](../02_éœ€æ±‚è§„æ ¼è¯´æ˜/README.md)
- [4. æ¨¡å—è®¾è®¡è¯´æ˜](../04_æ¨¡å—è®¾è®¡è¯´æ˜/README.md)
- [9. æµ‹è¯•æ–¹æ¡ˆ](../09_æµ‹è¯•æ–¹æ¡ˆ/README.md)
