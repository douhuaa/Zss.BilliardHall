---
title: "业务流程图设计"
version: "1.0.0"
author: "业务分析师"
maintainer: "业务分析师"
created: "2024-01-15"
updated: "2024-01-15"
category: "业务流程"
audience: ["业务分析师", "产品经理", "需求分析师", "开发工程师"]
difficulty: "中级"
estimated_reading_time: "18分钟"
dependencies: ["功能需求", "用例图"]
related_docs: ["功能需求", "用例图", "系统架构设计"]
tags: ["业务流程", "流程图", "业务逻辑", "系统交互", "工作流"]
keywords: ["业务流程图", "开台流程", "支付流程", "会员流程", "设备控制流程", "异常处理"]
---

# 🧭 导航路径
[🏠 首页](../自助台球系统项目文档.md) > [📋 第二章：需求规格说明书](README.md) > [🔄 业务流程图](业务流程图.md)

# 🔄 2.4 业务流程图设计

## 🎯 业务流程概述

业务流程图详细描绘了自助台球系统的核心业务流程，展示了用户操作、系统响应和业务规则的完整交互过程，是系统设计和开发的重要参考。

## 🏓 1. 核心业务流程总览

```mermaid
graph TD
    A[用户到店] --> B[扫码/选台]
    B --> C{用户身份}
    C -->|注册用户| D[直接开台]
    C -->|新用户| E[快速注册]
    C -->|游客| F[游客开台]
    
    E --> D
    F --> D
    D --> G[开始计时]
    G --> H[游戏过程]
    
    H --> I{需要续时?}
    I -->|是| J[在线续时]
    I -->|否| K[准备结束]
    
    J --> H
    K --> L[关台结算]
    L --> M[支付费用]
    M --> N[结束离店]
```

## 🔑 2. 用户注册与登录流程

### 2.1 微信授权登录流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant MP as 小程序
    participant WX as 微信服务器
    participant SYS as 系统后端
    participant DB as 数据库
    
    U->>MP: 点击微信登录
    MP->>WX: 获取授权码
    WX->>MP: 返回code
    MP->>SYS: 发送code + 用户信息
    SYS->>WX: 验证code获取openid
    WX->>SYS: 返回用户标识
    
    alt 新用户
        SYS->>DB: 创建用户记录
        DB->>SYS: 返回用户ID
        SYS->>MP: 返回Token + 新用户标识
        MP->>U: 显示欢迎页面
    else 老用户
        SYS->>DB: 更新登录时间
        SYS->>MP: 返回Token + 用户信息
        MP->>U: 显示主页面
    end
```

### 2.2 游客模式流程

```mermaid
flowchart TD
    A[用户选择游客模式] --> B[系统生成临时ID]
    B --> C[设置游客权限]
    C --> D{是否需要手机号}
    D -->|开台需要| E[输入手机号验证]
    D -->|暂不需要| F[直接进入系统]
    E --> G[发送验证码]
    G --> H[验证成功]
    H --> F
    F --> I[游客功能受限使用]
    I --> J{是否升级为正式用户}
    J -->|是| K[完善注册信息]
    J -->|否| L[继续游客模式]
```

## 🎮 3. 开台业务流程

### 3.1 标准开台流程

```mermaid
graph TD
    A[用户扫码/选台] --> B{验证球台状态}
    B -->|空闲| C[检查用户权限]
    B -->|占用| D[提示选择其他球台]
    B -->|维护| E[显示维护信息]
    
    C --> F{检查付费方式}
    F -->|有余额| G[创建游戏会话]
    F -->|余额不足| H[引导充值]
    F -->|无付费方式| I[绑定支付方式]
    
    H --> J[完成充值]
    I --> K[绑定成功]
    J --> G
    K --> G
    
    G --> L[球台状态更新为占用]
    L --> M[控制灯光开启]
    M --> N[开始计时计费]
    N --> O[发送开台成功通知]
    O --> P[显示游戏界面]
```

### 3.2 会员开台增强流程

```mermaid
sequenceDiagram
    participant U as 会员用户
    participant SYS as 系统
    participant DB as 数据库
    participant DEV as 设备控制器
    participant PAY as 支付系统
    
    U->>SYS: 扫码开台
    SYS->>DB: 查询会员等级和权益
    DB->>SYS: 返回会员信息
    
    alt VIP会员
        SYS->>SYS: 应用VIP折扣
        SYS->>U: 显示折扣价格
    else 普通会员
        SYS->>SYS: 应用会员折扣
        SYS->>U: 显示会员价格
    end
    
    U->>SYS: 确认开台
    SYS->>PAY: 预授权/扣费
    PAY->>SYS: 支付确认
    SYS->>DB: 创建会话记录
    SYS->>DEV: 发送开灯指令
    DEV->>SYS: 确认灯光开启
    SYS->>U: 开台成功通知
```

## 💳 4. 支付与结算流程

### 4.1 标准支付流程

```mermaid
graph TD
    A[用户发起支付] --> B{选择支付方式}
    
    B -->|微信支付| C1[调用微信支付API]
    B -->|支付宝| C2[调用支付宝API]
    B -->|余额支付| C3[扣除账户余额]
    
    C1 --> D1[微信支付确认]
    C2 --> D2[支付宝支付确认]
    C3 --> D3[余额扣除成功]
    
    D1 --> E[更新支付状态]
    D2 --> E
    D3 --> E
    
    E --> F[记录支付日志]
    F --> G[发送支付成功通知]
    G --> H[更新业务状态]
    
    C1 --> X1[支付失败]
    C2 --> X2[支付失败]
    C3 --> X3[余额不足]
    
    X1 --> Y[显示错误信息]
    X2 --> Y
    X3 --> Z[引导充值]
```

### 4.2 分摊付费流程

```mermaid
sequenceDiagram
    participant P1 as 发起者
    participant P2 as 参与者2
    participant P3 as 参与者N
    participant SYS as 系统
    participant PAY as 支付系统
    
    P1->>SYS: 发起分摊付费
    SYS->>SYS: 生成分摊会话
    SYS->>P1: 返回分摊链接/二维码
    
    P1->>P2: 分享分摊链接
    P1->>P3: 分享分摊链接
    
    P2->>SYS: 点击链接确认参与
    P3->>SYS: 点击链接确认参与
    
    SYS->>P1: 所有人确认，开始扣费
    SYS->>P2: 扣费通知
    SYS->>P3: 扣费通知
    
    par 并发扣费
        SYS->>PAY: P1支付请求
        SYS->>PAY: P2支付请求
        SYS->>PAY: P3支付请求
    end
    
    PAY->>SYS: 所有支付确认
    SYS->>P1: 分摊成功通知
    SYS->>P2: 分摊成功通知
    SYS->>P3: 分摊成功通知
```

## 🔧 5. 设备控制流程

### 5.1 设备控制与监控流程

```mermaid
graph TD
    A[系统发送控制指令] --> B[消息队列]
    B --> C[设备网关接收]
    C --> D{设备在线状态}
    
    D -->|在线| E[转发到具体设备]
    D -->|离线| F[指令缓存]
    
    E --> G[设备执行指令]
    G --> H[返回执行结果]
    H --> I[状态同步到系统]
    
    F --> J[设备恢复在线]
    J --> K[执行缓存指令]
    K --> G
    
    I --> L{执行成功?}
    L -->|成功| M[更新设备状态]
    L -->|失败| N[记录异常日志]
    
    N --> O[发送告警通知]
    O --> P[转入维护模式]
```

### 5.2 设备故障处理流程

```mermaid
flowchart TD
    A[设备心跳检测] --> B{心跳正常?}
    B -->|正常| C[继续监控]
    B -->|异常| D[触发告警]
    
    D --> E[发送故障通知]
    E --> F[自动切换维护模式]
    F --> G[影响用户使用?]
    
    G -->|是| H[用户强制关台]
    G -->|否| I[后台静默处理]
    
    H --> J[自动退费处理]
    J --> K[发送道歉通知]
    
    I --> L[维护人员处理]
    K --> L
    L --> M[故障修复]
    M --> N[设备测试]
    N --> O{测试通过?}
    
    O -->|通过| P[恢复正常状态]
    O -->|失败| L
    
    P --> Q[发送恢复通知]
```

## 🏪 6. 会员管理流程

### 6.1 会员升级流程

```mermaid
graph TD
    A[用户消费/积分变化] --> B[系统计算积分]
    B --> C{达到升级条件?}
    
    C -->|是| D[执行升级逻辑]
    C -->|否| E[继续累积]
    
    D --> F[更新会员等级]
    F --> G[激活新权益]
    G --> H[发送升级通知]
    H --> I[更新用户界面]
    
    I --> J[赠送升级礼包]
    J --> K[记录升级日志]
```

### 6.2 积分兑换流程

```mermaid
sequenceDiagram
    participant U as 用户
    participant SYS as 系统
    participant DB as 数据库
    participant GIFT as 礼品库存
    
    U->>SYS: 查看可兑换商品
    SYS->>DB: 查询用户积分
    SYS->>GIFT: 查询商品库存
    SYS->>U: 显示可兑换列表
    
    U->>SYS: 选择兑换商品
    SYS->>DB: 验证积分是否足够
    SYS->>GIFT: 验证库存是否充足
    
    alt 条件满足
        SYS->>DB: 扣除用户积分
        SYS->>GIFT: 减少商品库存
        SYS->>DB: 记录兑换历史
        SYS->>U: 兑换成功通知
    else 条件不满足
        SYS->>U: 兑换失败提示
    end
```

## 📊 7. 数据统计与报表流程

### 7.1 实时数据处理流程

```mermaid
graph TD
    A[业务事件发生] --> B[事件数据采集]
    B --> C[数据验证与清洗]
    C --> D[实时计算处理]
    
    D --> E[更新实时指标]
    D --> F[存储到数据仓库]
    
    E --> G[推送到监控系统]
    F --> H[定时批量处理]
    
    G --> I[实时大屏显示]
    H --> J[生成分析报表]
```

### 7.2 定期报表生成流程

```mermaid
sequenceDiagram
    participant CRON as 定时任务
    participant SYS as 报表系统
    participant DB as 数据库
    participant CACHE as 缓存
    participant EMAIL as 邮件系统
    
    CRON->>SYS: 触发报表生成
    SYS->>DB: 查询业务数据
    DB->>SYS: 返回数据集
    
    SYS->>SYS: 数据分析和计算
    SYS->>CACHE: 缓存报表结果
    
    SYS->>EMAIL: 发送报表邮件
    EMAIL->>SYS: 发送确认
    
    Note over SYS: 报表包括：营收、用户活跃度、设备使用率等
```

## ⚠️ 8. 异常处理流程

### 8.1 系统异常处理流程

```mermaid
graph TD
    A[检测到异常] --> B{异常类型判断}
    
    B -->|业务异常| C[记录业务日志]
    B -->|系统异常| D[记录系统日志]
    B -->|网络异常| E[网络重试机制]
    
    C --> F[友好错误提示]
    D --> G[发送告警通知]
    E --> H{重试成功?}
    
    H -->|成功| I[继续正常流程]
    H -->|失败| J[降级处理]
    
    F --> K[用户自主处理]
    G --> L[技术人员介入]
    J --> M[离线模式]
    
    L --> N[问题修复]
    M --> O[恢复后数据同步]
```

### 8.2 支付异常处理流程

```mermaid
flowchart TD
    A[支付异常] --> B{异常类型}
    
    B -->|网络超时| C[发起查询]
    B -->|余额不足| D[提示充值]
    B -->|支付失败| E[重试支付]
    B -->|重复支付| F[幂等性检查]
    
    C --> G{查询结果}
    G -->|支付成功| H[更新订单状态]
    G -->|支付失败| I[重新支付]
    G -->|查询失败| J[人工核实]
    
    E --> K{重试次数}
    K -->|<3次| E
    K -->|>=3次| L[支付失败处理]
    
    F --> M[防重复扣费]
    M --> N[返回原支付结果]
```

## 📋 流程优化建议

### 关键性能指标 (KPI)
- **开台成功率**: ≥ 99.5%
- **支付成功率**: ≥ 99.9%
- **平均开台时间**: ≤ 30秒
- **设备响应时间**: ≤ 2秒
- **用户投诉率**: ≤ 0.1%

### 持续改进计划
1. **用户体验优化**: 基于用户行为数据优化操作流程
2. **异常处理增强**: 完善异常情况的自动化处理
3. **性能监控**: 建立完整的业务流程性能监控体系
4. **智能化升级**: 引入AI辅助的智能推荐和预测

## 🔗 相关文档
- [功能需求](功能需求.md) - 详细功能需求说明
- [用例图](用例图.md) - 系统用例建模
- [非功能需求](非功能需求.md) - 性能和质量要求
- [系统架构设计](../03_系统架构设计/README.md) - 技术架构支撑
