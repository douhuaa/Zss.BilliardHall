# Wolverine 核心架构原则

> **定位**: Wolverine 架构的核心原则与设计理念
> 
> **适用范围**: 所有使用 Wolverine 框架的项目

---

## 一、核心原则

### 原则 1: 100% 垂直切片（Vertical Slice）

**禁止传统分层**:
- ❌ 不要 `Application` / `Domain` / `Infrastructure` 分层
- ❌ 分层只会稀释 Wolverine 的优势
- ✅ 按业务能力组织代码，而非技术层次

**理由**:
- Wolverine 的约定机制在切片架构中效果最佳
- 减少跨层跳转，加快开发速度
- 功能变更限制在单个切片内，降低影响范围

### 原则 2: 一个 Use Case = 一个文件夹

**文件夹结构**:
```
CreateOrder/
├── CreateOrder.cs              # Command 定义
├── CreateOrderEndpoint.cs      # HTTP 端点
├── CreateOrderHandler.cs       # 业务处理器
├── CreateOrderValidator.cs     # 输入验证（可选）
└── OrderCreated.cs            # 领域事件
```

**原则**:
- Command + Handler + Endpoint + Validator + Event 放在一起
- 代码聚合度 > 复用洁癖
- 新人只需打开一个文件夹即可理解完整流程

### 原则 3: 通信方式分离

| 场景 | 使用方式 | 示例 |
|------|---------|------|
| 同步外部请求 | HTTP Endpoint | 用户点击"开台"按钮 |
| 内部业务编排 | Command Bus | 开台后触发计费初始化 |
| 跨服务异步 | Message Queue | 支付成功后通知订单服务 |

**反模式**:
- ❌ 所有操作都用 Message（过度异步）
- ❌ 所有操作都用 HTTP（紧耦合）

### 原则 4: Handler 就是 Application Service

**不再需要传统 Service 层**:
```csharp
// ❌ 传统方式
public class TableAppService
{
    public async Task<Guid> StartSession(StartSessionDto dto) { }
}

// ✅ Wolverine 方式
public class StartSessionHandler
{
    public async Task<Result<Guid>> Handle(
        StartSessionCommand command,
        IDocumentSession session)
    {
        // 业务逻辑直接在 Handler 中
    }
}
```

**Handler 是一等公民**:
- 自动依赖注入（方法参数）
- 自动事务管理
- 自动 Unit of Work
- 自动 Outbox 模式

---

## 二、Wolverine 的核心优势

### 2.1 约定优于配置

**自动发现 Handler**:
```csharp
// 只要方法名是 Handle/HandleAsync，Wolverine 自动发现
public class CreateOrderHandler
{
    public async Task<Guid> Handle(CreateOrder command, IDocumentSession session)
    {
        // 实现逻辑
    }
}
```

**自动依赖注入**:
```csharp
// 第一个参数是消息，后续参数自动注入
public async Task<TResult> Handle(
    TCommand command,           // 第一个：消息
    IDocumentSession session,   // 自动注入
    ILogger logger,             // 自动注入
    CancellationToken ct)       // 自动注入
```

### 2.2 内置 Outbox 模式

**消息持久化**:
```csharp
[Transactional]
public async Task Handle(CreateOrder cmd, IMessageBus bus)
{
    // 1. 保存实体
    var order = new Order { /* ... */ };
    session.Store(order);
    
    // 2. 发布事件（自动持久化到 Outbox）
    await bus.PublishAsync(new OrderCreated(order.Id));
    
    // 3. 事务提交后，消息才会发送
}
```

### 2.3 统一的消息抽象

**本地消息 = 远程消息**:
```csharp
// 本地调用
await bus.InvokeAsync(new CalculateBill(sessionId));

// 远程调用（只需配置，代码不变）
opts.PublishMessage<CalculateBill>()
    .ToRabbitQueue("billing-queue");
```

---

## 三、架构约束（必须遵守）

### 约束 1: 模块边界

**严格隔离**:
- ✅ 模块间只能通过消息通信
- ❌ 禁止跨模块直接数据库访问
- ❌ 禁止创建 Shared Service 层

**理由**: 保证模块独立演化，避免隐式耦合

### 约束 2: 领域模型位置

**聚合根**:
- ✅ 每个模块有自己的聚合根
- ✅ 聚合根包含业务方法，不是贫血模型
- ❌ 禁止跨模块共享聚合根

**示例**:
```csharp
// Tables 模块的聚合根
public class Table
{
    public Guid Id { get; private set; }
    public TableStatus Status { get; private set; }
    
    // 业务方法
    public void Reserve(Guid reservationId, Guid memberId, TimeSpan duration)
    {
        if (Status != TableStatus.Available)
            throw new InvalidOperationException("台球桌不可用");
            
        Status = TableStatus.Reserved;
        // ...
    }
}
```

### 约束 3: 持久化方式

**直接使用 Marten/EF Core**:
- ✅ Handler 直接注入 `IDocumentSession` 或 `DbContext`
- ❌ 禁止创建 Repository 接口
- ❌ 禁止创建 UnitOfWork 接口

**理由**: Wolverine 的 `[Transactional]` 特性已提供 UoW，Repository 只是多余抽象

---

## 四、关键设计决策

### 决策 1: 选择垂直切片而非分层

**背景**: 传统分层架构在业务变更时需要修改多层

**决策**: 采用垂直切片，每个功能独立演化

**权衡**: 接受适度代码重复，换取功能独立性

### 决策 2: Handler 作为 Application Service

**背景**: 传统架构需要单独的 Application Service 层

**决策**: Handler 本身就是 Application Service，无需额外层

**权衡**: 依赖 Wolverine 约定，团队需学习成本

### 决策 3: 消息驱动的模块通信

**背景**: 模块间直接调用导致紧耦合

**决策**: 统一使用消息通信（同步/异步）

**权衡**: 消息跟踪复杂度提高，但模块独立性增强

---

## 五、参考资源

### 相关文档
- [解决方案结构设计](./02_解决方案结构设计.md) - 项目级别的目录组织
- [模块设计指南](./03_模块设计指南.md) - 单个模块的结构规范
- [垂直切片架构说明](../垂直切片架构说明.md) - 垂直切片的详细说明

### 外部资源
- [Wolverine Documentation](https://wolverine.netlify.app/)
- [Vertical Slice Architecture - Jimmy Bogard](https://www.jimmybogard.com/vertical-slice-architecture/)

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2024-01-15 | 从 Wolverine模块化架构蓝图 拆分 |

---

**最后更新**: 2024-01-15  
**负责人**: 架构团队  
**审核状态**: ✅ 已审核
