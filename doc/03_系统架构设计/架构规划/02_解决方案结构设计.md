# 解决方案结构设计

> **定位**: Wolverine 项目的解决方案级别目录组织
> 
> **适用范围**: 新建项目或重构现有项目

---

## 一、Solution 结构

```text
src/
├── Bootstrapper/                   # 启动 & 组合根
│   ├── Program.cs                  # 应用入口
│   ├── WolverineExtensions.cs      # Wolverine 配置
│   ├── PersistenceExtensions.cs    # Marten/持久化配置
│   └── MessagingExtensions.cs      # 消息传输配置
│
├── Modules/                        # 业务模块（主战场）
│   ├── Tables/                     # 台球桌管理
│   ├── Sessions/                   # 打球时段
│   ├── Orders/                     # 消费订单
│   ├── Payments/                   # 支付对账
│   ├── Members/                    # 会员体系
│   └── Devices/                    # 硬件集成
│
├── BuildingBlocks/                 # 共享基础设施（极度克制）
│   ├── Contracts/                  # 跨模块契约
│   │   ├── IIntegrationEvent.cs    # 集成事件标记接口
│   │   └── Result.cs               # 统一结果类型
│   ├── Behaviors/                  # Wolverine 中间件
│   │   ├── ValidationBehavior.cs   # 验证中间件
│   │   ├── LoggingBehavior.cs      # 日志中间件
│   │   └── TransactionBehavior.cs  # 事务中间件
│   ├── Exceptions/                 # 共享异常类型
│   │   ├── DomainException.cs
│   │   └── NotFoundException.cs
│   └── Clock/                      # 时间抽象
│       ├── IClock.cs
│       └── SystemClock.cs
│
└── Tests/                          # 测试项目
    ├── Tables.Tests/
    ├── Sessions.Tests/
    ├── Payments.Tests/
    └── Integration.Tests/
```

---

## 二、关键设计原则

### 2.1 Bootstrapper

**职责**:
- 唯一职责：启动与组合根
- 不包含业务逻辑
- 扫描并注册所有模块

**示例**:
```csharp
// Program.cs
var builder = WebApplication.CreateBuilder(args);

// 添加 Marten
builder.Services.AddMarten(opts =>
{
    opts.Connection(connectionString);
    opts.IntegrateWithWolverine();
});

// 添加 Wolverine
builder.Host.UseWolverine(opts =>
{
    opts.PersistMessagesWithMarten();
    opts.Discovery.IncludeAssembly(typeof(Program).Assembly);
});

var app = builder.Build();
app.MapWolverineEndpoints();
app.Run();
```

### 2.2 Modules

**职责**:
- 每个模块代表一个业务能力（Bounded Context）
- 模块间低耦合，通过消息通信
- 模块内高内聚，按功能组织切片

**模块边界判定**:
1. 有清晰的业务能力边界（Tables 管理桌台，Sessions 管理时段）
2. 可以独立演化（修改 Sessions 不影响 Payments）
3. 有自己的数据模型（Table、Session、Payment 是不同实体）
4. 团队可以独立工作（不同开发者负责不同模块）

### 2.3 BuildingBlocks

**极度克制原则**:
- **只放跨模块不可避免的东西**
- 不要创建 `Shared.Core` 大杂烩
- 宁可重复代码，不要过早抽象

**允许共享的类型**:
1. **契约** (Contracts): 接口定义、结果类型
2. **行为** (Behaviors): Wolverine 中间件
3. **异常** (Exceptions): 框架级异常
4. **工具** (Utilities): 时间抽象、ID 生成器

**禁止共享的类型**:
- ❌ 业务逻辑（Service、Helper、Manager）
- ❌ 领域模型（聚合根、实体、值对象）
- ❌ 数据访问（Repository、DbContext）

---

## 三、推荐模块拆分（自助台球系统）

### 3.1 Tables 模块

**职责**: 台球桌生命周期管理

**Use Cases**:
```
Tables/
├── ReserveTable/       # 预订台球桌
├── ReleaseTable/       # 释放台球桌
├── GetTable/           # 查询台球桌信息
├── ListTables/         # 列出台球桌
└── UpdateTableStatus/  # 更新台球桌状态
```

### 3.2 Sessions 模块

**职责**: 打球时段管理

**Use Cases**:
```
Sessions/
├── StartSession/       # 开始打球
├── EndSession/         # 结束打球
├── PauseSession/       # 暂停计时
├── ResumeSession/      # 恢复计时
└── Sagas/
    └── TableSessionSaga.cs  # 会话生命周期编排
```

### 3.3 Billing 模块

**职责**: 计费规则与账单生成

**Use Cases**:
```
Billing/
├── CalculateBill/      # 计算账单
├── GenerateInvoice/    # 生成发票
└── ApplyDiscount/      # 应用优惠
```

### 3.4 Payments 模块

**职责**: 支付与对账

**Use Cases**:
```
Payments/
├── ProcessPayment/     # 处理支付
├── RefundPayment/      # 退款
├── ReconcilePayments/  # 对账
└── GetPaymentHistory/  # 支付历史
```

### 3.5 Members 模块

**职责**: 会员体系管理

**Use Cases**:
```
Members/
├── RegisterMember/     # 注册会员
├── TopUpBalance/       # 充值
├── GetMemberProfile/   # 查询会员信息
└── UpdateMemberTier/   # 更新会员等级
```

### 3.6 Devices 模块

**职责**: 硬件设备集成

**Use Cases**:
```
Devices/
├── ControlDoorLock/    # 门禁控制
├── ControlLighting/    # 灯光控制
└── GetDeviceStatus/    # 设备状态查询
```

---

## 四、不推荐的拆分方式

### 4.1 过度拆分

❌ **错误示例**:
```text
Modules/
├── TableReservation/        # 太细粒度
├── TableRelease/
├── TableStatusQuery/
```

**问题**: 功能过于细碎，导致模块爆炸

### 4.2 过度合并

❌ **错误示例**:
```text
Modules/
├── Billing/                 # 太大，职责混乱
│   ├── Sessions/
│   ├── Payments/
│   └── Invoices/
```

**问题**: 模块边界模糊，职责不清

### 4.3 技术拆分

❌ **错误示例**:
```text
Modules/
├── Commands/                # 按技术层拆分，错误！
├── Queries/
└── Events/
```

**问题**: 违背垂直切片原则，回到传统分层

---

## 五、配置示例

### 5.1 模块化配置（可选）

```csharp
// WolverineExtensions.cs
public static class WolverineExtensions
{
    public static IHostBuilder AddWolverineModules(
        this IHostBuilder host,
        IConfiguration configuration)
    {
        return host.UseWolverine(opts =>
        {
            opts.PersistMessagesWithMarten();
            opts.Discovery.IncludeAssembly(typeof(Program).Assembly);
            
            // Tables 模块配置
            opts.PublishMessage<TableReserved>()
                .ToLocalQueue("sessions");
            
            // Payments 模块配置
            opts.PublishMessage<PaymentCompleted>()
                .ToLocalQueue("billing");
            
            // 全局策略
            opts.Policies.AutoApplyTransactions();
            opts.Policies.UseDurableLocalQueues();
        });
    }
}

// Program.cs 中使用
builder.Host.AddWolverineModules(builder.Configuration);
```

---

## 六、参考资源

### 相关文档
- [核心架构原则](./01_核心架构原则.md) - 架构的核心原则
- [模块设计指南](./03_模块设计指南.md) - 单个模块的结构规范
- [系统模块划分](../系统模块划分.md) - 模块职责与边界

### 外部资源
- [Wolverine Documentation](https://wolverine.netlify.app/)
- [Modular Monolith Architecture](https://www.kamilgrzybek.com/design/modular-monolith-primer/)

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2024-01-15 | 从 Wolverine模块化架构蓝图 拆分 |

---

**最后更新**: 2024-01-15  
**负责人**: 架构团队  
**审核状态**: ✅ 已审核
