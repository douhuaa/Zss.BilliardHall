# 模块设计指南

> **定位**: 单个 Wolverine 模块的"黄金结构"
> 
> **适用范围**: 设计和实现业务模块

---

## 一、模块目录组织

### 1.1 推荐结构（功能 < 10 个）

**扁平化组织**:
```text
Modules/Tables/
├── ReserveTable/
│   ├── ReserveTable.cs          # Command
│   ├── ReserveTableEndpoint.cs  # HTTP 端点
│   └── ReserveTableHandler.cs   # Handler
├── ReleaseTable/
│   ├── ReleaseTable.cs
│   └── ReleaseTableHandler.cs
├── GetTable/
│   ├── GetTable.cs
│   └── GetTableHandler.cs
├── Table.cs                     # 聚合根
├── TableStatus.cs               # 枚举/值对象
└── TablesModule.cs              # 模块注册标记
```

**特点**:
- 简单直观
- 适合小型模块
- 快速定位功能

### 1.2 推荐结构（功能 > 10 个）

**分组组织**:
```text
Modules/Tables/
├── Commands/                    # 写操作
│   ├── ReserveTable/
│   │   ├── ReserveTable.cs
│   │   ├── ReserveTableEndpoint.cs
│   │   └── ReserveTableHandler.cs
│   ├── ReleaseTable/
│   └── UpdateTableStatus/
│
├── Queries/                     # 读操作
│   ├── GetTable/
│   │   ├── GetTable.cs
│   │   ├── GetTableEndpoint.cs
│   │   └── GetTableHandler.cs
│   └── ListTables/
│
├── Events/                      # 领域事件
│   ├── TableReserved.cs
│   ├── TableReleased.cs
│   └── TableStatusChanged.cs
│
├── Domain/                      # 模块内领域模型
│   ├── Table.cs                 # 聚合根
│   ├── TableStatus.cs           # 枚举/值对象
│   └── TableType.cs
│
└── TablesModule.cs              # 模块注册标记
```

**特点**:
- CQRS 清晰分离
- 适合大型模块
- 便于团队协作

---

## 二、完整 Slice 的标准形态

### 2.1 Command 定义

```csharp
namespace Zss.BilliardHall.Modules.Tables.ReserveTable;

/// <summary>
/// 预订台球桌命令
/// </summary>
public sealed record ReserveTable(
    Guid TableId,
    Guid MemberId,
    TimeSpan Duration
);
```

**规范**:
- 使用 `record` 类型（不可变）
- 命名：动词 + 名词（ReserveTable, CreateOrder）
- 只包含必要数据，不包含业务逻辑
- 添加 XML 文档注释

### 2.2 HTTP Endpoint

```csharp
namespace Zss.BilliardHall.Modules.Tables.ReserveTable;

/// <summary>
/// 预订台球桌端点
/// </summary>
public sealed class ReserveTableEndpoint
{
    /// <summary>
    /// 预订台球桌
    /// </summary>
    [WolverinePost("/api/tables/{tableId:guid}/reserve")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    public static ReserveTable Post(
        Guid tableId,
        ReserveTableRequest request
    ) => new(tableId, request.MemberId, request.Duration);

    public sealed record ReserveTableRequest(
        Guid MemberId,
        TimeSpan Duration
    );
}
```

**规范**:
- Endpoint **只做映射**，不写业务逻辑
- 不校验（Wolverine 会触发 Validator）
- 不访问数据库
- 使用 Wolverine 特性标记路由
- 支持路由参数与请求体分离

### 2.3 Handler（核心业务）

```csharp
namespace Zss.BilliardHall.Modules.Tables.ReserveTable;

/// <summary>
/// 预订台球桌处理器
/// </summary>
public sealed class ReserveTableHandler
{
    /// <summary>
    /// 处理预订台球桌命令
    /// </summary>
    [Transactional]
    public async Task<Result<Guid>> Handle(
        ReserveTable command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        // 1. 加载聚合根
        var table = await session
            .LoadAsync<Table>(command.TableId, ct)
            ?? throw new NotFoundException("台球桌不存在");

        // 2. 业务规则校验
        if (table.Status != TableStatus.Available)
            return Result.Fail<Guid>("台球桌不可用");

        // 3. 执行业务操作
        var reservationId = Guid.NewGuid();
        table.Reserve(reservationId, command.MemberId, command.Duration);

        // 4. 持久化（Marten 自动保存）
        session.Store(table);

        // 5. 发布领域事件
        await bus.PublishAsync(
            new TableReserved(command.TableId, command.MemberId),
            ct
        );

        return Result.Ok(reservationId);
    }
}
```

**Wolverine 的杀手锏**:
- ✅ 自动事务（`[Transactional]` 特性）
- ✅ 自动 Unit of Work
- ✅ 自动 Outbox（事件持久化）
- ✅ 不需要 Repository 接口
- ✅ 不需要手动 `SaveChanges()`

### 2.4 验证器（可选）

```csharp
namespace Zss.BilliardHall.Modules.Tables.ReserveTable;

/// <summary>
/// 预订台球桌验证器
/// </summary>
public sealed class ReserveTableValidator : AbstractValidator<ReserveTable>
{
    public ReserveTableValidator()
    {
        RuleFor(x => x.TableId)
            .NotEmpty()
            .WithMessage("台球桌ID不能为空");

        RuleFor(x => x.MemberId)
            .NotEmpty()
            .WithMessage("会员ID不能为空");

        RuleFor(x => x.Duration)
            .GreaterThan(TimeSpan.Zero)
            .WithMessage("预订时长必须大于0");

        RuleFor(x => x.Duration)
            .LessThanOrEqualTo(TimeSpan.FromHours(8))
            .WithMessage("预订时长不能超过8小时");
    }
}
```

### 2.5 领域事件

```csharp
namespace Zss.BilliardHall.Modules.Tables.Events;

/// <summary>
/// 台球桌已预订事件
/// </summary>
public sealed record TableReserved(
    Guid TableId,
    Guid MemberId,
    DateTimeOffset ReservedAt
)
{
    public TableReserved(Guid tableId, Guid memberId)
        : this(tableId, memberId, DateTimeOffset.UtcNow)
    {
    }
}
```

**事件规范**:
- 命名：名词 + 动词过去式（TableReserved, OrderCreated）
- 表示已发生的事实
- 不可变（record）
- 包含时间戳（UTC）

### 2.6 事件处理器

```csharp
namespace Zss.BilliardHall.Modules.Sessions.Handlers;

/// <summary>
/// 响应台球桌预订事件
/// </summary>
public sealed class TableReservedHandler
{
    /// <summary>
    /// 台球桌预订后自动创建会话
    /// </summary>
    public async Task Handle(
        TableReserved @event,
        IDocumentSession session,
        ILogger<TableReservedHandler> logger,
        CancellationToken ct = default)
    {
        // 创建打球会话
        var tableSession = new TableSession
        {
            Id = Guid.NewGuid(),
            TableId = @event.TableId,
            MemberId = @event.MemberId,
            StartTime = @event.ReservedAt,
            Status = SessionStatus.Active
        };

        session.Store(tableSession);
        await session.SaveChangesAsync(ct);

        logger.LogInformation(
            "已为台球桌 {TableId} 创建会话 {SessionId}",
            @event.TableId,
            tableSession.Id
        );
    }
}
```

---

## 三、聚合根设计

### 3.1 聚合根示例

```csharp
namespace Zss.BilliardHall.Modules.Tables;

/// <summary>
/// 台球桌聚合根
/// </summary>
public class Table
{
    public Guid Id { get; private set; }
    public string Name { get; private set; } = string.Empty;
    public TableStatus Status { get; private set; }
    public Guid? CurrentReservationId { get; private set; }
    
    /// <summary>
    /// 预订台球桌
    /// </summary>
    public void Reserve(Guid reservationId, Guid memberId, TimeSpan duration)
    {
        if (Status != TableStatus.Available)
            throw new InvalidOperationException("台球桌不可用");
            
        Status = TableStatus.Reserved;
        CurrentReservationId = reservationId;
    }
    
    /// <summary>
    /// 释放台球桌
    /// </summary>
    public void Release()
    {
        if (Status == TableStatus.Available)
            throw new InvalidOperationException("台球桌已经是可用状态");
            
        Status = TableStatus.Available;
        CurrentReservationId = null;
    }
}

/// <summary>
/// 台球桌状态
/// </summary>
public enum TableStatus
{
    Available,   // 可用
    Reserved,    // 已预订
    InUse,       // 使用中
    Maintenance  // 维护中
}
```

**设计原则**:
- 聚合根包含业务方法，不是贫血模型
- 使用 `private set` 保护状态
- 业务规则在领域方法中验证
- 不直接暴露集合（使用只读集合）

---

## 四、模块复杂度信号

### 4.1 警告信号

**文件数量**:
- ⚠️ 功能超过 20 个：考虑拆分模块
- ⚠️ 单个 Handler 超过 50 行：考虑引入领域服务
- ⚠️ 需要注入 5+ 个依赖：Handler 职责过重

**解决方案**:
1. **拆分模块**: 将大模块拆成多个小模块
2. **引入领域服务**: 复杂逻辑下沉到领域层
3. **使用 Saga**: 跨步骤流程用 Saga 编排

### 4.2 模块拆分示例

**拆分前**:
```text
Billing/                        # 职责混乱
├── CalculateBill/
├── ProcessPayment/
├── RefundPayment/
├── GenerateInvoice/
└── ReconcilePayments/
```

**拆分后**:
```text
Billing/                        # 计费规则
├── CalculateBill/
└── GenerateInvoice/

Payments/                       # 支付对账
├── ProcessPayment/
├── RefundPayment/
└── ReconcilePayments/
```

---

## 五、参考资源

### 相关文档
- [核心架构原则](./01_核心架构原则.md) - 架构的核心原则
- [完整切片实现指南](./04_完整切片实现指南.md) - 代码模板与示例
- [跨模块通信指南](./06_跨模块通信指南.md) - 模块间通信方式

### 外部资源
- [Wolverine Documentation](https://wolverine.netlify.app/)
- [Feature Folders](https://www.youtube.com/watch?v=yF6VL35l914)

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2024-01-15 | 从 Wolverine模块化架构蓝图 拆分 |

---

**最后更新**: 2024-01-15  
**负责人**: 架构团队  
**审核状态**: ✅ 已审核
