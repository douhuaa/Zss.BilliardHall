# 技术选型

## 1. 技术栈总览

本项目采用基于 .NET 9 的现代化技术栈，使用垂直切片架构（Vertical Slice Architecture）和 Wolverine + Marten 作为核心框架。

### 1.1 技术选型一览表

| 层次 | 技术 | 版本 | 选择理由 |
|------|------|------|----------|
| **运行时** | .NET | 9.0 | 最新的 LTS 版本，性能优异，跨平台 |
| **架构模式** | 垂直切片架构 | - | 功能内聚，开发效率高 |
| **消息处理** | Wolverine | 3.x | 现代化的命令/查询处理，内置消息总线 |
| **数据访问** | Marten | 7.x | PostgreSQL 文档数据库，支持事件溯源 |
| **数据库** | PostgreSQL | 16+ | 开源、稳定、JSONB 支持 |
| **认证授权** | OpenIddict | 5.x | OIDC 标准实现 |
| **API 风格** | REST + Minimal API | - | 简洁、高性能 |
| **日志** | Serilog | 4.x | 结构化日志，丰富的 Sink |
| **测试** | xUnit + Shouldly | - | .NET 主流测试框架 |
| **容器化** | Docker | - | 统一部署环境 |
| **编排** | .NET Aspire | 9.x | 云原生应用编排 |

## 2. 核心技术选择

### 2.1 架构模式：垂直切片架构

**选择理由**:
- ✅ **功能内聚**: 每个业务功能的代码集中在一个切片中，易于理解和维护
- ✅ **独立演化**: 不同功能可以独立修改、测试、部署
- ✅ **减少耦合**: 避免传统分层架构中的跨层依赖
- ✅ **提高效率**: 新增功能无需修改多个层次，开发速度快
- ✅ **简化测试**: 减少 Mock，每个切片可独立测试

**对比传统分层架构**:

| 维度 | 垂直切片架构 | ABP 分层架构 |
|------|-------------|-------------|
| 代码组织 | 按功能（Features/） | 按层次（Domain/Application/） |
| 变更范围 | 单个切片 | 跨多层 |
| 学习曲线 | 较低（功能独立） | 较高（需理解分层） |
| 适用场景 | 快速迭代的业务系统 | 复杂领域模型 |

详见：[垂直切片架构说明](垂直切片架构说明.md)

### 2.2 消息处理：Wolverine

**技术介绍**:
Wolverine 是 JasperFx 生态系统的一部分，提供现代化的命令/查询处理和消息总线。

**选择理由**:
- ✅ **约定优于配置**: 自动发现处理器，无需显式注册
- ✅ **自动依赖注入**: 方法参数自动注入，简化代码
- ✅ **持久化消息**: 与 Marten 集成，支持收件箱/发件箱模式
- ✅ **消息传输**: 支持进程内和跨进程通信（RabbitMQ、Azure Service Bus）
- ✅ **后台任务**: 内置调度器，支持延迟和定时任务
- ✅ **性能优异**: 编译时代码生成，避免反射

**核心功能**:
```csharp
// 命令处理
public class CreateMemberHandler
{
    public async Task<MemberCreated> Handle(
        CreateMemberCommand command,
        IDocumentSession session)
    {
        var member = new Member { /* ... */ };
        session.Store(member);
        return new MemberCreated(member.Id);
    }
}

// 使用消息总线
var result = await bus.InvokeAsync<MemberCreated>(
    new CreateMemberCommand("张三", "138...")
);
```

详见：[Wolverine 框架介绍](Wolverine框架介绍.md)

**替代方案对比**:

| 框架 | 优势 | 劣势 | 选择场景 |
|------|------|------|----------|
| **Wolverine** | 功能全面、性能高、持久化 | 生态较新 | ✅ 本项目 |
| MediatR | 简单、社区成熟 | 仅进程内、无持久化 | 简单应用 |
| MassTransit | 强大的消息传输 | 复杂、重量级 | 微服务架构 |

### 2.3 数据访问：Marten

**技术介绍**:
Marten 是基于 PostgreSQL 的文档数据库和事件存储库，利用 JSONB 提供 NoSQL 般的灵活性，同时保留 ACID 事务。

**选择理由**:
- ✅ **文档模型**: POCO 对象直接存储为 JSON，无需复杂的 ORM 映射
- ✅ **强类型查询**: 完整的 LINQ 支持，编译时检查
- ✅ **事件溯源**: 内置事件存储，天然支持审计
- ✅ **性能优异**: PostgreSQL JSONB 索引，查询速度快
- ✅ **ACID 事务**: 完整的事务支持，保证数据一致性
- ✅ **Wolverine 集成**: 与 Wolverine 无缝集成，自动事务管理

**核心功能**:
```csharp
// 存储文档
var member = new Member { Id = Guid.NewGuid(), Name = "张三" };
session.Store(member);
await session.SaveChangesAsync();

// LINQ 查询
var members = await session.Query<Member>()
    .Where(m => m.Level == MembershipLevel.Premium)
    .OrderBy(m => m.Name)
    .ToListAsync();

// 事件溯源
session.Events.StartStream<TableSession>(
    sessionId,
    new SessionStarted(sessionId, tableId, DateTime.UtcNow)
);
```

详见：[Marten 数据访问](Marten数据访问.md)

**替代方案对比**:

| 技术 | 优势 | 劣势 | 选择场景 |
|------|------|------|----------|
| **Marten** | 灵活、性能高、事件溯源 | 仅 PostgreSQL | ✅ 本项目 |
| EF Core | 成熟、多数据库 | ORM 复杂、性能较低 | 复杂关系模型 |
| Dapper | 轻量、性能好 | 无变更跟踪、手动 SQL | 性能敏感场景 |

### 2.4 数据库：PostgreSQL

**选择理由**:
- ✅ **开源免费**: 无许可证费用
- ✅ **JSONB 支持**: Marten 的基础，高性能文档存储
- ✅ **ACID 事务**: 强一致性保证
- ✅ **全文搜索**: 内置 FTS 功能
- ✅ **丰富的索引**: GIN、GiST、BRIN 等多种索引类型
- ✅ **成熟稳定**: 久经考验的企业级数据库

**版本要求**: PostgreSQL 16+ (推荐使用最新稳定版)

**替代方案**:
- SQL Server: 需要许可证，但 Windows 环境集成好
- MySQL: 较轻量，但 JSON 支持不如 PostgreSQL
- MongoDB: 纯文档数据库，但缺乏 ACID 保证

### 2.5 认证授权：OpenIddict

**选择理由**:
- ✅ **OIDC 标准**: 完整实现 OpenID Connect 和 OAuth 2.0
- ✅ **灵活配置**: 支持多种授权流程
- ✅ **ASP.NET Core 集成**: 与 .NET 生态无缝集成
- ✅ **Token 管理**: 内置 Token 生命周期管理
- ✅ **多租户支持**: 适合 SaaS 应用

**授权流程**:
- 前端 SPA: Authorization Code + PKCE
- 后端 API: JWT Bearer Token
- 服务间通信: Client Credentials

**替代方案**:
- IdentityServer: 功能更全，但商业版需付费
- Auth0 / Azure AD B2C: SaaS 服务，但依赖外部系统

## 3. 辅助技术

### 3.1 日志：Serilog

**选择理由**:
- 结构化日志，易于查询和分析
- 丰富的 Sink（控制台、文件、Elasticsearch、Seq）
- 与 ASP.NET Core 无缝集成

**配置示例**:
```csharp
builder.Host.UseSerilog((context, configuration) =>
{
    configuration
        .ReadFrom.Configuration(context.Configuration)
        .Enrich.FromLogContext()
        .Enrich.WithMachineName()
        .WriteTo.Console()
        .WriteTo.File("logs/log-.txt", rollingInterval: RollingInterval.Day);
});
```

### 3.2 API 文档：Swagger / OpenAPI

**选择理由**:
- 自动生成 API 文档
- 提供交互式测试界面
- 支持客户端代码生成

### 3.3 测试框架

**单元测试**:
- xUnit: .NET 社区标准
- Shouldly: 流畅的断言语法
- NSubstitute: 简洁的 Mock 框架

**集成测试**:
- Alba: Wolverine 生态的 HTTP 测试库
- Testcontainers: 容器化的测试数据库

### 3.4 编排：.NET Aspire

**选择理由**:
- 云原生应用编排
- 本地开发体验优秀
- 统一配置管理
- 内置监控和遥测

**项目结构**:
```
Zss.BilliardHall.AppHost/        # Aspire 编排项目
Zss.BilliardHall.ServiceDefaults/ # 共享配置
Zss.BilliardHall.HttpApi/         # API 服务
```

## 4. 开发工具

| 工具 | 用途 |
|------|------|
| Visual Studio 2022 / Rider | IDE |
| Docker Desktop | 容器化 |
| pgAdmin / DBeaver | PostgreSQL 管理 |
| Postman / Insomnia | API 测试 |
| Seq | 日志聚合和查询 |

## 5. 技术决策记录

### 5.1 为什么选择垂直切片架构而非传统分层？

**背景**: 项目需要快速迭代和交付业务功能。

**决策**: 采用垂直切片架构。

**理由**:
1. **业务驱动**: 台球厅管理系统功能相对独立（会员、台球桌、支付），适合按功能切片
2. **团队规模**: 中小型团队（3-8人），垂直切片降低沟通成本
3. **快速交付**: 新功能开发无需修改多层，减少变更范围
4. **简化测试**: 每个切片可独立测试，提高测试效率

**权衡**: 可能存在适度的代码重复，但团队认为这是可接受的。

### 5.2 为什么选择 Marten 而非 EF Core？

**背景**: 需要灵活的数据模型和审计能力。

**决策**: 采用 Marten 作为主要数据访问层。

**理由**:
1. **灵活性**: 业务模型变化频繁，文档模型比关系模型更灵活
2. **审计需求**: 需要完整的操作历史，事件溯源是天然的解决方案
3. **性能**: PostgreSQL JSONB 查询性能优秀，满足并发需求
4. **简化开发**: 无需复杂的 ORM 映射配置

**权衡**: 仅支持 PostgreSQL，但这符合项目需求。

### 5.3 为什么选择 Wolverine 而非 MediatR？

**背景**: 需要消息持久化和跨进程通信能力。

**决策**: 采用 Wolverine。

**理由**:
1. **持久化**: 支付、计费等关键操作需要消息持久化，保证不丢失
2. **事务集成**: 与 Marten 的事务集成是开箱即用的
3. **功能全面**: 支持后台任务、定时任务，无需额外引入 Hangfire 等
4. **性能**: 编译时代码生成，性能优于基于反射的 MediatR

**权衡**: Wolverine 相对较新，但文档完善，社区活跃。

## 6. 未来技术规划

### 6.1 短期（3-6个月）
- [ ] 集成消息队列（RabbitMQ）用于跨服务通信
- [ ] 添加分布式缓存（Redis）
- [ ] 引入全文搜索（PostgreSQL FTS 或 Elasticsearch）

### 6.2 中期（6-12个月）
- [ ] 微服务拆分（如支付服务独立）
- [ ] 引入 API 网关（YARP）
- [ ] 实时通信（SignalR）

### 6.3 长期（12个月+）
- [ ] 多租户支持（SaaS 化）
- [ ] 数据分析平台集成
- [ ] AI 辅助功能（智能推荐、预测）

## 7. 技术风险评估

| 技术 | 风险 | 缓解措施 |
|------|------|----------|
| Wolverine | 生态较新，社区相对小 | 紧密跟踪官方文档，参与社区讨论 |
| Marten | 仅支持 PostgreSQL | 确认 PostgreSQL 满足所有需求 |
| 垂直切片架构 | 团队需要适应新模式 | 代码审查，分享最佳实践 |

## 8. 技术培训计划

| 阶段 | 内容 | 时长 |
|------|------|------|
| 第一周 | .NET 9 新特性、Minimal API | 2天 |
| 第二周 | Wolverine 基础、消息处理模式 | 3天 |
| 第三周 | Marten 文档存储、LINQ 查询 | 3天 |
| 第四周 | 垂直切片架构、实战演练 | 2天 |

---

**最后更新**: 2024-01-15  
**负责人**: 架构团队  
**审核状态**: 已批准
