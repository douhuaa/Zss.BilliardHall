---
title: "ç³»ç»Ÿæ¨¡å—åˆ’åˆ†"
description: "è‡ªåŠ©å°çƒç³»ç»Ÿæ¨¡å—è®¾è®¡ä¸èŒè´£è¾¹ç•Œå®šä¹‰"
section: "3.3"
version: "1.0.0"
author: "æ¶æ„å¸ˆ"
maintainer: "æ¶æ„å¸ˆ"
created: "2024-01-15"
updated: "2024-01-15"
category: "ç³»ç»Ÿæ¶æ„"
level: "å¿…è¯»"
audience: ["æ¶æ„å¸ˆ", "å¼€å‘å·¥ç¨‹å¸ˆ", "é¡¹ç›®ç»ç†"]
keywords: ["æ¨¡å—è®¾è®¡", "èŒè´£è¾¹ç•Œ", "æ¥å£å®šä¹‰", "é¢†åŸŸåˆ’åˆ†"]
tags: ["module-design", "domain-boundary", "interface-design"]
status: "å®Œæˆ"
dependencies: ["æ€»ä½“æ¶æ„å›¾", "æŠ€æœ¯é€‰å‹"]
related_docs: ["æ€»ä½“æ¶æ„å›¾.md", "å¤–éƒ¨æ¥å£.md", "è®¾è®¡åŸåˆ™.md"]
---

# âš™ï¸ 3.3 ç³»ç»Ÿæ¨¡å—åˆ’åˆ†

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡](README.md) > âš™ï¸ ç³»ç»Ÿæ¨¡å—åˆ’åˆ†

<!-- Keywords for Search -->
**å…³é”®è¯**: `æ¨¡å—è®¾è®¡` `èŒè´£è¾¹ç•Œ` `æ¥å£å®šä¹‰` `é¢†åŸŸåˆ’åˆ†`

## ğŸ¯ æ¨¡å—è®¾è®¡æ¦‚è¿°

åŸºäº**é¢†åŸŸé©±åŠ¨è®¾è®¡(DDD)**å’Œ**ABPæ¡†æ¶**ï¼Œå°†è‡ªåŠ©å°çƒç³»ç»Ÿåˆ’åˆ†ä¸º8ä¸ªæ ¸å¿ƒä¸šåŠ¡æ¨¡å—å’Œ3ä¸ªåŸºç¡€æ”¯æ’‘æ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—èŒè´£æ¸…æ™°ã€è¾¹ç•Œæ˜ç¡®ã€ä½è€¦åˆé«˜å†…èšã€‚

## ğŸ—ï¸ æ¨¡å—æ€»è§ˆæ¶æ„

```mermaid
graph TB
    subgraph "è¡¨ç°å±‚æ¨¡å—"
        UI1[ç®¡ç†åå°æ¨¡å—]
        UI2[ç”¨æˆ·ç«¯H5æ¨¡å—]
        UI3[è®¾å¤‡ç»ˆç«¯æ¨¡å—]
        UI4[ç§»åŠ¨ç«¯å°ç¨‹åº]
    end
    
    subgraph "æ ¸å¿ƒä¸šåŠ¡æ¨¡å—"
        BM1[ç”¨æˆ·ç®¡ç†æ¨¡å—<br/>UserManagement]
        BM2[å°çƒæ¡Œç®¡ç†æ¨¡å—<br/>TableManagement]
        BM3[ä¼šè¯ç®¡ç†æ¨¡å—<br/>SessionManagement]
        BM4[è®¡è´¹ç»“ç®—æ¨¡å—<br/>BillingManagement]
        BM5[æ”¯ä»˜ç®¡ç†æ¨¡å—<br/>PaymentManagement]
        BM6[è®¾å¤‡ç®¡ç†æ¨¡å—<br/>DeviceManagement]
        BM7[é¢„çº¦ç®¡ç†æ¨¡å—<br/>ReservationManagement]
        BM8[æŠ¥è¡¨ç»Ÿè®¡æ¨¡å—<br/>ReportingManagement]
    end
    
    subgraph "åŸºç¡€æ”¯æ’‘æ¨¡å—"
        SM1[æƒé™ç®¡ç†æ¨¡å—<br/>PermissionManagement]
        SM2[ç³»ç»Ÿé…ç½®æ¨¡å—<br/>SettingManagement]
        SM3[å®¡è®¡æ—¥å¿—æ¨¡å—<br/>AuditingManagement]
    end
    
    subgraph "å…¬å…±æœåŠ¡æ¨¡å—"
        CM1[é€šçŸ¥æœåŠ¡æ¨¡å—<br/>NotificationService]
        CM2[æ–‡ä»¶æœåŠ¡æ¨¡å—<br/>FileService]
        CM3[ç¼“å­˜æœåŠ¡æ¨¡å—<br/>CacheService]
        CM4[äº‹ä»¶æ€»çº¿æ¨¡å—<br/>EventBusService]
    end
    
    UI1 --> BM1
    UI2 --> BM2
    UI3 --> BM6
    
    BM1 --> SM1
    BM2 --> BM3
    BM3 --> BM4
    BM4 --> BM5
    BM6 --> CM1
    BM7 --> BM2
    BM8 --> SM3
    
    BM1 -.-> CM3
    BM2 -.-> CM4
    BM5 -.-> CM2
    
    style BM1 fill:#e3f2fd
    style BM2 fill:#f1f8e9
    style BM3 fill:#fff3e0
    style BM4 fill:#fce4ec
    style BM5 fill:#e8f5e8
```

## ğŸ“‹ 1. æ ¸å¿ƒä¸šåŠ¡æ¨¡å—è¯¦è¿°

### 1.1 ç”¨æˆ·ç®¡ç†æ¨¡å— (UserManagement)

**æ¨¡å—èŒè´£**:
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æ³¨é”€
- ç”¨æˆ·ä¿¡æ¯ç®¡ç†å’Œç»´æŠ¤
- ä¼šå‘˜ç­‰çº§å’Œæƒç›Šç®¡ç†
- ç”¨æˆ·ä½™é¢å’Œæ¶ˆè´¹è®°å½•

**æ ¸å¿ƒå®ä½“**:
```csharp
// ç”¨æˆ·èšåˆæ ¹
public class User : FullAuditedAggregateRoot<Guid>
{
    public string UserName { get; set; }
    public string PhoneNumber { get; set; }
    public decimal Balance { get; set; }
    public UserType UserType { get; set; }
    public DateTime? LastLoginTime { get; set; }
}

// ä¼šå‘˜ä¿¡æ¯
public class Membership : Entity<Guid>
{
    public Guid UserId { get; set; }
    public MembershipLevel Level { get; set; }
    public DateTime ExpireDate { get; set; }
    public decimal DiscountRate { get; set; }
}
```

**å…³é”®æ¥å£**:
```csharp
public interface IUserAppService : IApplicationService
{
    Task<UserDto> GetAsync(Guid id);
    Task<UserDto> CreateAsync(CreateUserDto input);
    Task<UserDto> UpdateAsync(Guid id, UpdateUserDto input);
    Task<decimal> GetBalanceAsync(Guid userId);
    Task ChargeBalanceAsync(Guid userId, decimal amount);
}
```

**æ•°æ®è¡¨**:
- `Users` - ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
- `UserMemberships` - ä¼šå‘˜ä¿¡æ¯
- `UserBalanceRecords` - ä½™é¢å˜åŠ¨è®°å½•

### 1.2 å°çƒæ¡Œç®¡ç†æ¨¡å— (TableManagement)

**æ¨¡å—èŒè´£**:
- å°çƒæ¡ŒçŠ¶æ€ç®¡ç†(ç©ºé—²/ä½¿ç”¨ä¸­/ç»´æŠ¤ç­‰)
- å°çƒæ¡ŒåŸºæœ¬ä¿¡æ¯ç»´æŠ¤
- å°çƒæ¡Œä½¿ç”¨ç»Ÿè®¡
- å°çƒæ¡Œåˆ†é…å’Œé‡Šæ”¾

**çŠ¶æ€æœºè®¾è®¡**:
```mermaid
stateDiagram-v2
    [*] --> Available
    Available --> Reserved : é¢„çº¦
    Available --> InUse : ç›´æ¥å¼€å°
    Reserved --> InUse : åˆ°åº—å¼€å°
    Reserved --> Available : é¢„çº¦è¿‡æœŸ
    InUse --> PendingPayment : ç”³è¯·ç»“æŸ
    PendingPayment --> Available : æ”¯ä»˜å®Œæˆ
    Available --> Maintenance : ç»´æŠ¤
    Maintenance --> Available : ç»´æŠ¤å®Œæˆ
    InUse --> Offline : è®¾å¤‡å¼‚å¸¸
    Offline --> Available : æ•…éšœä¿®å¤
```

**æ ¸å¿ƒå®ä½“**:
```csharp
public class BilliardTable : FullAuditedAggregateRoot<int>
{
    public string Code { get; set; } // å°çƒæ¡Œç¼–å·
    public Guid StoreId { get; set; } // æ‰€å±é—¨åº—
    public TableStatus Status { get; set; } // å½“å‰çŠ¶æ€
    public Guid? CurrentSessionId { get; set; } // å½“å‰ä¼šè¯
    public DateTime? LastUsedTime { get; set; } // æœ€åä½¿ç”¨æ—¶é—´
    public bool IsActive { get; set; } // æ˜¯å¦å¯ç”¨
    
    // çŠ¶æ€è½¬æ¢æ–¹æ³•
    public void StartSession(Guid sessionId)
    {
        if (Status != TableStatus.Available && Status != TableStatus.Reserved)
            throw new BusinessException("å°çƒæ¡Œå½“å‰çŠ¶æ€ä¸å…è®¸å¼€å°");
            
        Status = TableStatus.InUse;
        CurrentSessionId = sessionId;
        LastUsedTime = Clock.Now;
        
        AddLocalEvent(new TableSessionStartedEto(Id, sessionId));
    }
}
```

**å…³é”®æ¥å£**:
```csharp
public interface ITableAppService : IApplicationService
{
    Task<PagedResultDto<BilliardTableDto>> GetListAsync(GetTableListDto input);
    Task<BilliardTableDto> GetAsync(int id);
    Task<List<BilliardTableDto>> GetAvailableTablesAsync(Guid storeId);
    Task StartSessionAsync(int tableId, StartSessionDto input);
    Task EndSessionAsync(int tableId);
}
```

**æ•°æ®è¡¨**:
- `BilliardTables` - å°çƒæ¡ŒåŸºæœ¬ä¿¡æ¯
- `TableStatusLogs` - å°çƒæ¡ŒçŠ¶æ€å˜æ›´æ—¥å¿—

### 1.3 ä¼šè¯ç®¡ç†æ¨¡å— (SessionManagement)

**æ¨¡å—èŒè´£**:
- å¼€å°ä¼šè¯åˆ›å»ºå’Œç®¡ç†
- ä¼šè¯çŠ¶æ€è·Ÿè¸ª
- ä¼šè¯æ—¶é•¿è®¡ç®—
- ä¼šè¯ç»“æŸå¤„ç†

**æ ¸å¿ƒå®ä½“**:
```csharp
public class TableSession : FullAuditedAggregateRoot<Guid>
{
    public Guid UserId { get; set; } // ç”¨æˆ·ID
    public int TableId { get; set; } // å°çƒæ¡ŒID
    public Guid StoreId { get; set; } // é—¨åº—ID
    public SessionStatus Status { get; set; } // ä¼šè¯çŠ¶æ€
    public DateTime StartTime { get; set; } // å¼€å§‹æ—¶é—´
    public DateTime? EndTime { get; set; } // ç»“æŸæ—¶é—´
    public int DurationMinutes => CalculateDuration(); // æ—¶é•¿(åˆ†é’Ÿ)
    public decimal TotalAmount { get; set; } // æ€»è´¹ç”¨
    public string SessionToken { get; set; } // ä¼šè¯ä»¤ç‰Œ(é˜²é‡å¤)
    
    // ä¸šåŠ¡æ–¹æ³•
    public void EndSession()
    {
        if (Status != SessionStatus.Active)
            throw new BusinessException("ä¼šè¯çŠ¶æ€ä¸å…è®¸ç»“æŸ");
            
        Status = SessionStatus.PendingPayment;
        EndTime = Clock.Now;
        
        AddLocalEvent(new SessionEndRequestedEto(Id, UserId, TotalAmount));
    }
    
    private int CalculateDuration()
    {
        var endTime = EndTime ?? Clock.Now;
        return (int)Math.Ceiling((endTime - StartTime).TotalMinutes);
    }
}
```

**ä¼šè¯çŠ¶æ€æµè½¬**:
```mermaid
graph LR
    A[Active è¿›è¡Œä¸­] --> B[PendingPayment å¾…æ”¯ä»˜]
    B --> C[Completed å·²å®Œæˆ]
    B --> D[Cancelled å·²å–æ¶ˆ]
    A --> D
    
    style A fill:#4caf50
    style B fill:#ff9800
    style C fill:#2196f3
    style D fill:#f44336
```

### 1.4 è®¡è´¹ç»“ç®—æ¨¡å— (BillingManagement)

**æ¨¡å—èŒè´£**:
- å®æ—¶è®¡è´¹è§„åˆ™ç®¡ç†
- è´¹ç”¨è®¡ç®—å’Œå¿«ç…§
- ä¼˜æƒ åˆ¸å’ŒæŠ˜æ‰£å¤„ç†
- è®¡è´¹å†å²è®°å½•

**è®¡è´¹è§„åˆ™è®¾è®¡**:
```csharp
public class PricingRule : Entity<Guid>
{
    public string Name { get; set; } // è§„åˆ™åç§°
    public Guid? StoreId { get; set; } // é—¨åº—ID(å…¨å±€è§„åˆ™ä¸ºnull)
    public PricingType Type { get; set; } // å®šä»·ç±»å‹
    public string RuleConfig { get; set; } // è§„åˆ™é…ç½®JSON
    public TimeSpan? ValidFrom { get; set; } // ç”Ÿæ•ˆæ—¶é—´
    public TimeSpan? ValidTo { get; set; } // å¤±æ•ˆæ—¶é—´
    public bool IsActive { get; set; }
}

// è®¡è´¹å¿«ç…§
public class BillingSnapshot : Entity<Guid>
{
    public Guid SessionId { get; set; }
    public int OriginalMinutes { get; set; } // åŸå§‹æ—¶é•¿
    public decimal BaseAmount { get; set; } // åŸºç¡€è´¹ç”¨
    public string AppliedRules { get; set; } // åº”ç”¨è§„åˆ™JSON
    public decimal DiscountAmount { get; set; } // æŠ˜æ‰£é‡‘é¢
    public decimal FinalAmount { get; set; } // æœ€ç»ˆé‡‘é¢
    public DateTime CreatedTime { get; set; }
}
```

**è®¡è´¹ç®—æ³•**:
```csharp
public interface IBillingService : IDomainService
{
    Task<BillingResult> CalculateBillingAsync(Guid sessionId);
    Task<BillingSnapshot> CreateSnapshotAsync(Guid sessionId);
}

public class BillingService : DomainService, IBillingService
{
    public async Task<BillingResult> CalculateBillingAsync(Guid sessionId)
    {
        var session = await _sessionRepository.GetAsync(sessionId);
        var rules = await GetApplicableRulesAsync(session);
        
        var result = new BillingResult
        {
            SessionId = sessionId,
            OriginalMinutes = session.DurationMinutes,
            BaseAmount = CalculateBaseAmount(session.DurationMinutes, rules)
        };
        
        // åº”ç”¨æŠ˜æ‰£å’Œä¼˜æƒ åˆ¸
        result.FinalAmount = ApplyDiscounts(result.BaseAmount, session.UserId);
        
        return result;
    }
}
```

### 1.5 æ”¯ä»˜ç®¡ç†æ¨¡å— (PaymentManagement)

**æ¨¡å—èŒè´£**:
- æ”¯ä»˜è®¢å•åˆ›å»ºå’Œç®¡ç†
- å¤šæ¸ é“æ”¯ä»˜å¯¹æ¥
- æ”¯ä»˜çŠ¶æ€è·Ÿè¸ª
- é€€æ¬¾å¤„ç†

**æ”¯ä»˜æµç¨‹è®¾è®¡**:
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant A as æ”¯ä»˜æ¨¡å—
    participant P as æ”¯ä»˜ç½‘å…³
    participant B as è®¡è´¹æ¨¡å—
    
    U->>A: å‘èµ·æ”¯ä»˜è¯·æ±‚
    A->>B: è·å–è®¡è´¹ä¿¡æ¯
    B-->>A: è¿”å›è´¹ç”¨æ˜ç»†
    A->>A: åˆ›å»ºæ”¯ä»˜è®¢å•
    A->>P: è°ƒç”¨æ”¯ä»˜æ¥å£
    P-->>A: è¿”å›æ”¯ä»˜é“¾æ¥
    A-->>U: è¿”å›æ”¯ä»˜é¡µé¢
    
    P->>A: æ”¯ä»˜å›è°ƒé€šçŸ¥
    A->>A: æ›´æ–°è®¢å•çŠ¶æ€
    A->>B: å®Œæˆè®¡è´¹ç»“ç®—
    A-->>P: ç¡®è®¤å›è°ƒ
```

**æ ¸å¿ƒå®ä½“**:
```csharp
public class PaymentOrder : FullAuditedAggregateRoot<Guid>
{
    public string OrderNo { get; set; } // è®¢å•å·
    public Guid UserId { get; set; } // ç”¨æˆ·ID
    public Guid? SessionId { get; set; } // å…³è”ä¼šè¯
    public PaymentType Type { get; set; } // æ”¯ä»˜ç±»å‹
    public decimal Amount { get; set; } // æ”¯ä»˜é‡‘é¢
    public PaymentStatus Status { get; set; } // æ”¯ä»˜çŠ¶æ€
    public PaymentChannel Channel { get; set; } // æ”¯ä»˜æ¸ é“
    public string ThirdPartyOrderNo { get; set; } // ç¬¬ä¸‰æ–¹è®¢å•å·
    public DateTime? PaidTime { get; set; } // æ”¯ä»˜æ—¶é—´
    public string CallbackData { get; set; } // å›è°ƒæ•°æ®
    
    // æ”¯ä»˜æˆåŠŸå¤„ç†
    public void MarkAsPaid(string thirdPartyOrderNo, string callbackData)
    {
        if (Status != PaymentStatus.Pending)
            throw new BusinessException("è®¢å•çŠ¶æ€ä¸å…è®¸æ”¯ä»˜");
            
        Status = PaymentStatus.Paid;
        ThirdPartyOrderNo = thirdPartyOrderNo;
        CallbackData = callbackData;
        PaidTime = Clock.Now;
        
        AddLocalEvent(new PaymentCompletedEto(Id, UserId, Amount));
    }
}
```

### 1.6 è®¾å¤‡ç®¡ç†æ¨¡å— (DeviceManagement)

**æ¨¡å—èŒè´£**:
- è®¾å¤‡ä¿¡æ¯ç®¡ç†
- è®¾å¤‡çŠ¶æ€ç›‘æ§
- è®¾å¤‡æ§åˆ¶æŒ‡ä»¤
- è®¾å¤‡å‘Šè­¦å¤„ç†

**è®¾å¤‡ç±»å‹è®¾è®¡**:
```csharp
public class Device : FullAuditedAggregateRoot<Guid>
{
    public Guid StoreId { get; set; } // æ‰€å±é—¨åº—
    public int? TableId { get; set; } // å…³è”å°çƒæ¡Œ
    public string SerialNumber { get; set; } // è®¾å¤‡åºåˆ—å·
    public DeviceType Type { get; set; } // è®¾å¤‡ç±»å‹
    public string Name { get; set; } // è®¾å¤‡åç§°
    public DeviceStatus Status { get; set; } // è®¾å¤‡çŠ¶æ€
    public string FirmwareVersion { get; set; } // å›ºä»¶ç‰ˆæœ¬
    public DateTime? LastHeartbeatTime { get; set; } // æœ€åå¿ƒè·³æ—¶é—´
    public string LastHeartbeatData { get; set; } // å¿ƒè·³æ•°æ®
    
    // æ›´æ–°å¿ƒè·³
    public void UpdateHeartbeat(string data)
    {
        LastHeartbeatTime = Clock.Now;
        LastHeartbeatData = data;
        
        // åˆ¤æ–­è®¾å¤‡çŠ¶æ€
        if (Status == DeviceStatus.Offline)
        {
            Status = DeviceStatus.Online;
            AddLocalEvent(new DeviceOnlineEto(Id));
        }
    }
}

// è®¾å¤‡å¿ƒè·³è®°å½•
public class DeviceHeartbeat : Entity<Guid>
{
    public Guid DeviceId { get; set; }
    public DateTime Timestamp { get; set; }
    public string MetricsData { get; set; } // JSONæ ¼å¼çš„æŒ‡æ ‡æ•°æ®
}
```

**è®¾å¤‡æ§åˆ¶æ¥å£**:
```csharp
public interface IDeviceControlService : IDomainService
{
    Task<DeviceCommandResult> SendCommandAsync(Guid deviceId, DeviceCommand command);
    Task<bool> CheckDeviceStatusAsync(Guid deviceId);
    Task ProcessHeartbeatAsync(Guid deviceId, string data);
}
```

### 1.7 é¢„çº¦ç®¡ç†æ¨¡å— (ReservationManagement)

**æ¨¡å—èŒè´£**:
- é¢„çº¦æ—¶æ®µç®¡ç†
- é¢„çº¦å†²çªæ£€æµ‹
- é¢„çº¦è½¬å¼€å°å¤„ç†
- é¢„çº¦è¿‡æœŸå¤„ç†

**é¢„çº¦å®ä½“è®¾è®¡**:
```csharp
public class Reservation : FullAuditedAggregateRoot<Guid>
{
    public Guid UserId { get; set; } // é¢„çº¦ç”¨æˆ·
    public int TableId { get; set; } // é¢„çº¦å°çƒæ¡Œ
    public DateTime ReservationTime { get; set; } // é¢„çº¦æ—¶é—´
    public int DurationMinutes { get; set; } // é¢„çº¦æ—¶é•¿
    public ReservationStatus Status { get; set; } // é¢„çº¦çŠ¶æ€
    public decimal DepositAmount { get; set; } // æŠ¼é‡‘é‡‘é¢
    public DateTime ExpireTime { get; set; } // è¿‡æœŸæ—¶é—´
    public Guid? SessionId { get; set; } // è½¬æ¢çš„ä¼šè¯ID
    
    // é¢„çº¦è½¬å¼€å°
    public void ConvertToSession(Guid sessionId)
    {
        if (Status != ReservationStatus.Confirmed)
            throw new BusinessException("é¢„çº¦çŠ¶æ€ä¸å…è®¸å¼€å°");
            
        Status = ReservationStatus.Used;
        SessionId = sessionId;
        
        AddLocalEvent(new ReservationUsedEto(Id, UserId, TableId));
    }
}
```

**å†²çªæ£€æµ‹ç®—æ³•**:
```csharp
public class ReservationConflictChecker : IDomainService
{
    public async Task<bool> HasConflictAsync(int tableId, DateTime startTime, int durationMinutes)
    {
        var endTime = startTime.AddMinutes(durationMinutes);
        
        var conflictingReservations = await _reservationRepository
            .Where(r => r.TableId == tableId)
            .Where(r => r.Status == ReservationStatus.Confirmed)
            .Where(r => r.ReservationTime < endTime && 
                       r.ReservationTime.AddMinutes(r.DurationMinutes) > startTime)
            .AnyAsync();
            
        return conflictingReservations;
    }
}
```

### 1.8 æŠ¥è¡¨ç»Ÿè®¡æ¨¡å— (ReportingManagement)

**æ¨¡å—èŒè´£**:
- ç»è¥æ•°æ®ç»Ÿè®¡
- ç”¨æˆ·è¡Œä¸ºåˆ†æ
- è®¾å¤‡ä½¿ç”¨åˆ†æ
- è´¢åŠ¡æŠ¥è¡¨ç”Ÿæˆ

**æŠ¥è¡¨ç±»å‹è®¾è®¡**:
```csharp
public abstract class BaseReport : Entity<Guid>
{
    public string ReportName { get; set; }
    public ReportType Type { get; set; }
    public DateTime ReportDate { get; set; }
    public Guid? StoreId { get; set; } // nullè¡¨ç¤ºå…¨å±€æŠ¥è¡¨
    public string ReportData { get; set; } // JSONæ ¼å¼æ•°æ®
    public DateTime CreatedTime { get; set; }
}

// æ—¥è¥ä¸šæŠ¥è¡¨
public class DailyOperationReport : BaseReport
{
    public int TotalSessions { get; set; } // æ€»ä¼šè¯æ•°
    public decimal TotalRevenue { get; set; } // æ€»æ”¶å…¥
    public int ActiveTables { get; set; } // æ´»è·ƒå°çƒæ¡Œæ•°
    public double AverageSessionDuration { get; set; } // å¹³å‡ä¼šè¯æ—¶é•¿
    public int NewUsers { get; set; } // æ–°ç”¨æˆ·æ•°
}
```

## ğŸ”§ 2. åŸºç¡€æ”¯æ’‘æ¨¡å—

### 2.1 æƒé™ç®¡ç†æ¨¡å— (PermissionManagement)

**åŸºäºABPæƒé™ç³»ç»Ÿ**:
```csharp
public class BilliardHallPermissions
{
    public const string GroupName = "BilliardHall";
    
    public static class Users
    {
        public const string Default = GroupName + ".Users";
        public const string Create = Default + ".Create";
        public const string Edit = Default + ".Edit";
        public const string Delete = Default + ".Delete";
    }
    
    public static class Tables
    {
        public const string Default = GroupName + ".Tables";
        public const string Manage = Default + ".Manage";
        public const string Control = Default + ".Control";
    }
}
```

### 2.2 ç³»ç»Ÿé…ç½®æ¨¡å— (SettingManagement)

**é…ç½®å®šä¹‰**:
```csharp
public class BilliardHallSettingDefinitionProvider : SettingDefinitionProvider
{
    public override void Define(ISettingDefinitionContext context)
    {
        context.Add(
            new SettingDefinition(
                BilliardHallSettings.DefaultSessionTimeoutMinutes,
                "30",
                displayName: L("é»˜è®¤ä¼šè¯è¶…æ—¶æ—¶é—´(åˆ†é’Ÿ)"),
                description: L("ç”¨æˆ·æ— æ“ä½œè‡ªåŠ¨ç»“æŸä¼šè¯çš„æ—¶é—´")
            ).WithProviders(
                DefaultValueSettingValueProvider.ProviderName,
                ConfigurationSettingValueProvider.ProviderName,
                GlobalSettingValueProvider.ProviderName,
                TenantSettingValueProvider.ProviderName
            )
        );
    }
}
```

### 2.3 å®¡è®¡æ—¥å¿—æ¨¡å— (AuditingManagement)

**åŸºäºABPå®¡è®¡ç³»ç»Ÿ**:
```csharp
[Audited]
public class TableSession : FullAuditedAggregateRoot<Guid>
{
    // è‡ªåŠ¨è®°å½•åˆ›å»ºæ—¶é—´ã€åˆ›å»ºäººã€ä¿®æ”¹æ—¶é—´ã€ä¿®æ”¹äººç­‰ä¿¡æ¯
}

// è‡ªå®šä¹‰å®¡è®¡å±æ€§
public class BilliardHallAuditPropertySetter : IAbpAuditPropertySetter
{
    public void SetCreationProperties(object targetObject)
    {
        AuditPropertySetterExtensions.SetCreationProperties(
            _abpSession,
            targetObject,
            _tenantId,
            _userId
        );
    }
}
```

## ğŸŒ 3. å…¬å…±æœåŠ¡æ¨¡å—

### 3.1 é€šçŸ¥æœåŠ¡æ¨¡å— (NotificationService)

**é€šçŸ¥ç±»å‹æ”¯æŒ**:
```csharp
public interface INotificationService : IDomainService
{
    Task SendSmsAsync(string phoneNumber, string message);
    Task SendEmailAsync(string email, string subject, string body);
    Task SendPushNotificationAsync(Guid userId, string title, string content);
    Task SendInAppNotificationAsync(Guid userId, string message);
}

// é€šçŸ¥æ¨¡æ¿
public class NotificationTemplate : Entity<Guid>
{
    public string Name { get; set; }
    public NotificationType Type { get; set; }
    public string Subject { get; set; }
    public string Content { get; set; }
    public string Variables { get; set; } // å¯ç”¨å˜é‡JSON
}
```

### 3.2 äº‹ä»¶æ€»çº¿æ¨¡å— (EventBusService)

**åŸºäºABPäº‹ä»¶æ€»çº¿**:
```csharp
// é¢†åŸŸäº‹ä»¶
public class SessionStartedEto
{
    public Guid SessionId { get; set; }
    public Guid UserId { get; set; }
    public int TableId { get; set; }
    public DateTime StartTime { get; set; }
}

// äº‹ä»¶å¤„ç†å™¨
public class SessionStartedEventHandler : 
    IDistributedEventHandler<SessionStartedEto>,
    ITransientDependency
{
    public async Task HandleEventAsync(SessionStartedEto eventData)
    {
        // å‘é€å¼€å°é€šçŸ¥
        await _notificationService.SendInAppNotificationAsync(
            eventData.UserId,
            $"å°çƒæ¡Œ {eventData.TableId} å¼€å°æˆåŠŸ"
        );
        
        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        await _statisticsService.IncrementSessionCountAsync();
    }
}
```

## ğŸ”„ 4. æ¨¡å—é—´äº¤äº’è®¾è®¡

### 4.1 æ ¸å¿ƒä¸šåŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·ç«¯
    participant UM as ç”¨æˆ·æ¨¡å—
    participant TM as å°çƒæ¡Œæ¨¡å—
    participant SM as ä¼šè¯æ¨¡å—
    participant BM as è®¡è´¹æ¨¡å—
    participant PM as æ”¯ä»˜æ¨¡å—
    participant DM as è®¾å¤‡æ¨¡å—
    
    U->>UM: ç”¨æˆ·ç™»å½•
    UM-->>U: è¿”å›ç”¨æˆ·ä¿¡æ¯
    
    U->>TM: è¯·æ±‚å¼€å°
    TM->>SM: åˆ›å»ºä¼šè¯
    SM->>DM: æ§åˆ¶è®¾å¤‡å¼€å¯
    DM-->>SM: è®¾å¤‡æ§åˆ¶æˆåŠŸ
    SM-->>TM: ä¼šè¯åˆ›å»ºæˆåŠŸ
    TM-->>U: å¼€å°æˆåŠŸ
    
    U->>SM: è¯·æ±‚ç»“æŸä¼šè¯
    SM->>BM: è®¡ç®—è´¹ç”¨
    BM-->>SM: è¿”å›è´¹ç”¨ä¿¡æ¯
    SM->>PM: åˆ›å»ºæ”¯ä»˜è®¢å•
    PM-->>SM: è¿”å›æ”¯ä»˜ä¿¡æ¯
    SM-->>U: è¿”å›æ”¯ä»˜é“¾æ¥
    
    U->>PM: å®Œæˆæ”¯ä»˜
    PM->>SM: æ›´æ–°ä¼šè¯çŠ¶æ€
    SM->>TM: é‡Šæ”¾å°çƒæ¡Œ
    TM->>DM: æ§åˆ¶è®¾å¤‡å…³é—­
    DM-->>TM: è®¾å¤‡æ§åˆ¶æˆåŠŸ
    PM-->>U: æ”¯ä»˜å®Œæˆ
```

### 4.2 äº‹ä»¶é©±åŠ¨æ¶æ„

```mermaid
graph LR
    subgraph "äº‹ä»¶å‘å¸ƒè€…"
        E1[ç”¨æˆ·äº‹ä»¶]
        E2[å°çƒæ¡Œäº‹ä»¶]
        E3[ä¼šè¯äº‹ä»¶]
        E4[æ”¯ä»˜äº‹ä»¶]
    end
    
    subgraph "äº‹ä»¶æ€»çº¿"
        EB[Event Bus<br/>RabbitMQ]
    end
    
    subgraph "äº‹ä»¶å¤„ç†å™¨"
        H1[é€šçŸ¥å¤„ç†å™¨]
        H2[ç»Ÿè®¡å¤„ç†å™¨]
        H3[æ—¥å¿—å¤„ç†å™¨]
        H4[è®¾å¤‡æ§åˆ¶å¤„ç†å™¨]
    end
    
    E1 --> EB
    E2 --> EB
    E3 --> EB
    E4 --> EB
    
    EB --> H1
    EB --> H2
    EB --> H3
    EB --> H4
```

### 4.3 ä¾èµ–å…³ç³»å›¾

```mermaid
graph TD
    subgraph "åº”ç”¨å±‚"
        APP1[ç”¨æˆ·åº”ç”¨æœåŠ¡] --> DOM1[ç”¨æˆ·é¢†åŸŸ]
        APP2[å°çƒæ¡Œåº”ç”¨æœåŠ¡] --> DOM2[å°çƒæ¡Œé¢†åŸŸ]
        APP3[æ”¯ä»˜åº”ç”¨æœåŠ¡] --> DOM3[æ”¯ä»˜é¢†åŸŸ]
    end
    
    subgraph "é¢†åŸŸå±‚"
        DOM1 --> REPO1[ç”¨æˆ·ä»“å‚¨æ¥å£]
        DOM2 --> REPO2[å°çƒæ¡Œä»“å‚¨æ¥å£]
        DOM3 --> REPO3[æ”¯ä»˜ä»“å‚¨æ¥å£]
        
        DOM2 --> DOM1
        DOM3 --> DOM2
    end
    
    subgraph "åŸºç¡€è®¾æ–½å±‚"
        REPO1 --> EF[EF Core]
        REPO2 --> EF
        REPO3 --> EF
        
        EF --> DB[(MySQL)]
    end
```

## ğŸ“Š 5. æ¨¡å—æ¥å£è§„èŒƒ

### 5.1 åº”ç”¨æœåŠ¡æ¥å£è§„èŒƒ

```csharp
// æ ‡å‡†CRUDæ¥å£
public interface IStandardAppService<TEntityDto, TKey, TGetListInput, TCreateInput, TUpdateInput>
    : IApplicationService
{
    Task<TEntityDto> GetAsync(TKey id);
    Task<PagedResultDto<TEntityDto>> GetListAsync(TGetListInput input);
    Task<TEntityDto> CreateAsync(TCreateInput input);
    Task<TEntityDto> UpdateAsync(TKey id, TUpdateInput input);
    Task DeleteAsync(TKey id);
}

// ä¸šåŠ¡æ¥å£ç¤ºä¾‹
public interface ITableAppService : IApplicationService
{
    // æŸ¥è¯¢æ¥å£
    Task<BilliardTableDto> GetAsync(int id);
    Task<PagedResultDto<BilliardTableDto>> GetListAsync(GetTableListDto input);
    Task<List<BilliardTableDto>> GetAvailableTablesAsync(Guid storeId);
    
    // ä¸šåŠ¡æ“ä½œæ¥å£
    Task<StartSessionResultDto> StartSessionAsync(StartSessionDto input);
    Task EndSessionAsync(EndSessionDto input);
    Task<TableStatusDto> GetTableStatusAsync(int tableId);
}
```

### 5.2 é¢†åŸŸæœåŠ¡æ¥å£è§„èŒƒ

```csharp
public interface IBillingDomainService : IDomainService
{
    Task<BillingResult> CalculateAsync(Guid sessionId);
    Task<List<PricingRule>> GetApplicableRulesAsync(Guid storeId, DateTime dateTime);
    Task<decimal> ApplyDiscountAsync(decimal baseAmount, Guid userId);
}
```

### 5.3 æ•°æ®ä¼ è¾“å¯¹è±¡(DTO)è§„èŒƒ

```csharp
// è¾“å…¥DTO
public class CreateUserDto
{
    [Required]
    [StringLength(50)]
    public string UserName { get; set; }
    
    [Required]
    [Phone]
    public string PhoneNumber { get; set; }
    
    [Range(0, double.MaxValue)]
    public decimal InitialBalance { get; set; }
}

// è¾“å‡ºDTO
public class UserDto : AuditedEntityDto<Guid>
{
    public string UserName { get; set; }
    public string PhoneNumber { get; set; }
    public decimal Balance { get; set; }
    public UserType UserType { get; set; }
    public MembershipDto Membership { get; set; }
}

// æŸ¥è¯¢DTO
public class GetUserListDto : PagedAndSortedResultRequestDto
{
    public string Filter { get; set; }
    public UserType? UserType { get; set; }
    public DateTime? CreatedFrom { get; set; }
    public DateTime? CreatedTo { get; set; }
}
```

## ğŸ” 6. æ¨¡å—è´¨é‡ä¿è¯

### 6.1 å•å…ƒæµ‹è¯•è§„èŒƒ

```csharp
[Collection(BilliardHallTestConsts.CollectionDefinitionName)]
public class UserAppServiceTests : BilliardHallApplicationTestBase
{
    private readonly IUserAppService _userAppService;
    
    public UserAppServiceTests()
    {
        _userAppService = GetRequiredService<IUserAppService>();
    }
    
    [Fact]
    public async Task Should_Create_User_With_Valid_Data()
    {
        // Arrange
        var createDto = new CreateUserDto
        {
            UserName = "test_user",
            PhoneNumber = "13800138000",
            InitialBalance = 100m
        };
        
        // Act
        var result = await _userAppService.CreateAsync(createDto);
        
        // Assert
        result.ShouldNotBeNull();
        result.UserName.ShouldBe(createDto.UserName);
        result.Balance.ShouldBe(createDto.InitialBalance);
    }
}
```

### 6.2 é›†æˆæµ‹è¯•è§„èŒƒ

```csharp
[Collection(BilliardHallTestConsts.CollectionDefinitionName)]
public class SessionIntegrationTests : BilliardHallWebTestBase
{
    [Fact]
    public async Task Should_Complete_Full_Session_Workflow()
    {
        // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
        var user = await CreateTestUserAsync();
        
        // åˆ›å»ºæµ‹è¯•å°çƒæ¡Œ
        var table = await CreateTestTableAsync();
        
        // å¼€å§‹ä¼šè¯
        var session = await StartSessionAsync(user.Id, table.Id);
        session.Status.ShouldBe(SessionStatus.Active);
        
        // ç»“æŸä¼šè¯
        await EndSessionAsync(session.Id);
        
        // éªŒè¯çŠ¶æ€
        var updatedSession = await GetSessionAsync(session.Id);
        updatedSession.Status.ShouldBe(SessionStatus.PendingPayment);
    }
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æ€»ä½“æ¶æ„å›¾](æ€»ä½“æ¶æ„å›¾.md) - ç³»ç»Ÿæ•´ä½“æ¶æ„è®¾è®¡
- [æŠ€æœ¯é€‰å‹](æŠ€æœ¯é€‰å‹.md) - æŠ€æœ¯æ ˆé€‰æ‹©è¯´æ˜  
- [å¤–éƒ¨æ¥å£](å¤–éƒ¨æ¥å£.md) - ç¬¬ä¸‰æ–¹ç³»ç»Ÿé›†æˆæ¥å£
- [è®¾è®¡åŸåˆ™](è®¾è®¡åŸåˆ™.md) - æ¨¡å—è®¾è®¡åŸåˆ™å’Œçº¦æŸ

---

ğŸ’¡ **è¯´æ˜**: æ¨¡å—åˆ’åˆ†å°†æ ¹æ®ä¸šåŠ¡å‘å±•è¿›è¡Œè°ƒæ•´ï¼Œè¯·åŠæ—¶å…³æ³¨æ¨¡å—è¾¹ç•Œçš„å˜åŒ–å’Œæ¥å£çš„ç‰ˆæœ¬æ¼”è¿›ã€‚
