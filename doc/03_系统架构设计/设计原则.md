---
title: "å…³é”®è®¾è®¡åŸåˆ™"
description: "è‡ªåŠ©å°çƒç³»ç»Ÿæ¶æ„è®¾è®¡åŸåˆ™ä¸æœ€ä½³å®è·µ"
section: "3.5"
version: "1.0.0"
author: "æ¶æ„å¸ˆ"
maintainer: "æ¶æ„å¸ˆ"
created: "2024-01-15"
updated: "2024-01-15"
category: "ç³»ç»Ÿæ¶æ„"
level: "å¿…è¯»"
audience: ["æ¶æ„å¸ˆ", "å¼€å‘å·¥ç¨‹å¸ˆ", "æŠ€æœ¯ä¸»ç®¡"]
keywords: ["è®¾è®¡åŸåˆ™", "DDD", "ABPæ¡†æ¶", "æ¶æ„çº¦æŸ", "æœ€ä½³å®è·µ"]
tags: ["design-principles", "ddd", "abp-framework", "best-practices"]
status: "å®Œæˆ"
dependencies: ["æŠ€æœ¯é€‰å‹", "ç³»ç»Ÿæ¨¡å—åˆ’åˆ†"]
related_docs: ["æŠ€æœ¯é€‰å‹.md", "ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md", "æ€»ä½“æ¶æ„å›¾.md"]
---

# ğŸ—ï¸ 3.5 å…³é”®è®¾è®¡åŸåˆ™

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡](README.md) > ğŸ—ï¸ å…³é”®è®¾è®¡åŸåˆ™

<!-- Keywords for Search -->
**å…³é”®è¯**: `è®¾è®¡åŸåˆ™` `DDD` `ABPæ¡†æ¶` `æ¶æ„çº¦æŸ` `æœ€ä½³å®è·µ`

## ğŸ¯ è®¾è®¡åŸåˆ™æ¦‚è¿°

åŸºäºå¤šå¹´ä¼ä¸šçº§å¼€å‘ç»éªŒå’Œä¸šç•Œæœ€ä½³å®è·µï¼Œç»“åˆè‡ªåŠ©å°çƒç³»ç»Ÿçš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œåˆ¶å®šä»¥ä¸‹æ¶æ„è®¾è®¡åŸåˆ™ã€‚è¿™äº›åŸåˆ™å°†æŒ‡å¯¼æ•´ä¸ªç³»ç»Ÿçš„è®¾è®¡ã€å¼€å‘å’Œç»´æŠ¤å·¥ä½œã€‚

## ğŸ›ï¸ æ ¸å¿ƒè®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (Single Responsibility Principle)

**åŸåˆ™è¯´æ˜**: æ¯ä¸ªç±»ã€æ¨¡å—æˆ–æœåŠ¡åªè´Ÿè´£ä¸€ä¸ªæ˜ç¡®å®šä¹‰çš„èŒè´£

**åº”ç”¨å®è·µ**:
```csharp
// âœ… å¥½çš„è®¾è®¡ - èŒè´£å•ä¸€
public class BillingCalculator : IDomainService
{
    public async Task<BillingResult> CalculateAsync(Guid sessionId)
    {
        // åªè´Ÿè´£è®¡è´¹è®¡ç®—é€»è¾‘
    }
}

public class PaymentProcessor : IDomainService
{
    public async Task<PaymentResult> ProcessAsync(PaymentOrder order)
    {
        // åªè´Ÿè´£æ”¯ä»˜å¤„ç†é€»è¾‘
    }
}

// âŒ ä¸å¥½çš„è®¾è®¡ - èŒè´£æ··ä¹±
public class BillingAndPaymentService : IDomainService
{
    public async Task<BillingResult> CalculateAndPayAsync(Guid sessionId)
    {
        // æ—¢è´Ÿè´£è®¡è´¹åˆè´Ÿè´£æ”¯ä»˜ï¼ŒèŒè´£ä¸æ¸…
    }
}
```

### 2. å¼€é—­åŸåˆ™ (Open-Closed Principle)

**åŸåˆ™è¯´æ˜**: å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­

**åº”ç”¨å®è·µ**:
```csharp
// å®šä»·è§„åˆ™ç­–ç•¥æ¥å£
public interface IPricingStrategy
{
    Task<decimal> CalculateAsync(PricingContext context);
    bool IsApplicable(PricingContext context);
}

// æ—¶é•¿è®¡è´¹ç­–ç•¥
public class HourlyPricingStrategy : IPricingStrategy
{
    public async Task<decimal> CalculateAsync(PricingContext context)
    {
        return context.Minutes * context.HourlyRate / 60;
    }
    
    public bool IsApplicable(PricingContext context)
    {
        return context.PricingType == PricingType.Hourly;
    }
}

// åŒ…å°è®¡è´¹ç­–ç•¥ - æ‰©å±•æ–°åŠŸèƒ½æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç 
public class PackagePricingStrategy : IPricingStrategy
{
    public async Task<decimal> CalculateAsync(PricingContext context)
    {
        return context.PackagePrice;
    }
    
    public bool IsApplicable(PricingContext context)
    {
        return context.PricingType == PricingType.Package;
    }
}
```

### 3. ä¾èµ–å€’ç½®åŸåˆ™ (Dependency Inversion Principle)

**åŸåˆ™è¯´æ˜**: é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œä¸¤è€…éƒ½åº”è¯¥ä¾èµ–æŠ½è±¡

**åº”ç”¨å®è·µ**:
```csharp
// æŠ½è±¡æ¥å£
public interface IPaymentGateway
{
    Task<PaymentResult> ProcessPaymentAsync(PaymentRequest request);
}

// åº”ç”¨æœåŠ¡ä¾èµ–æŠ½è±¡ï¼Œä¸ä¾èµ–å…·ä½“å®ç°
public class PaymentAppService : ApplicationService
{
    private readonly IPaymentGateway _paymentGateway; // ä¾èµ–æŠ½è±¡
    
    public PaymentAppService(IPaymentGateway paymentGateway)
    {
        _paymentGateway = paymentGateway;
    }
    
    public async Task<PaymentDto> CreatePaymentAsync(CreatePaymentDto input)
    {
        // ä½¿ç”¨æŠ½è±¡æ¥å£ï¼Œä¸å…³å¿ƒå…·ä½“å®ç°
        var result = await _paymentGateway.ProcessPaymentAsync(
            ObjectMapper.Map<PaymentRequest>(input));
        return ObjectMapper.Map<PaymentDto>(result);
    }
}

// å…·ä½“å®ç°
public class AlipayGateway : IPaymentGateway, ITransientDependency
{
    public async Task<PaymentResult> ProcessPaymentAsync(PaymentRequest request)
    {
        // æ”¯ä»˜å®å…·ä½“å®ç°
    }
}
```

## ğŸ—ï¸ æ¶æ„è®¾è®¡åŸåˆ™

### 1. é¢†åŸŸé©±åŠ¨è®¾è®¡ (Domain-Driven Design)

**æ ¸å¿ƒç†å¿µ**: å°†å¤æ‚çš„ä¸šåŠ¡é€»è¾‘å°è£…åœ¨é¢†åŸŸå±‚ï¼Œä¿æŒä¸šåŠ¡é€»è¾‘çš„çº¯å‡€æ€§

**å±‚æ¬¡ç»“æ„**:
```mermaid
graph TB
    subgraph "DDDåˆ†å±‚æ¶æ„"
        UI[ç”¨æˆ·ç•Œé¢å±‚<br/>Controllers, ViewModels]
        APP[åº”ç”¨å±‚<br/>Application Services, DTOs]
        DOM[é¢†åŸŸå±‚<br/>Entities, Value Objects, Domain Services]
        INFRA[åŸºç¡€è®¾æ–½å±‚<br/>Repositories, External Services]
    end
    
    UI --> APP
    APP --> DOM
    DOM --> INFRA
    INFRA -.-> DOM
    
    style DOM fill:#ff6b6b,color:white
```

**å®ç°ç¤ºä¾‹**:
```csharp
// é¢†åŸŸå®ä½“ - åŒ…å«ä¸šåŠ¡é€»è¾‘
public class TableSession : FullAuditedAggregateRoot<Guid>
{
    // ä¸šåŠ¡å±æ€§
    public Guid UserId { get; private set; }
    public int TableId { get; private set; }
    public SessionStatus Status { get; private set; }
    public DateTime StartTime { get; private set; }
    public DateTime? EndTime { get; private set; }
    
    // ä¸šåŠ¡æ–¹æ³• - å°è£…ä¸šåŠ¡è§„åˆ™
    public void EndSession(IBillingService billingService)
    {
        // ä¸šåŠ¡è§„åˆ™éªŒè¯
        if (Status != SessionStatus.Active)
            throw new BusinessException("åªæœ‰è¿›è¡Œä¸­çš„ä¼šè¯æ‰èƒ½ç»“æŸ");
            
        if (DateTime.UtcNow - StartTime < TimeSpan.FromMinutes(1))
            throw new BusinessException("ä¼šè¯æ—¶é—´è¿‡çŸ­ï¼Œä¸èƒ½ç»“æŸ");
        
        // çŠ¶æ€å˜æ›´
        Status = SessionStatus.PendingPayment;
        EndTime = DateTime.UtcNow;
        
        // å‘å¸ƒé¢†åŸŸäº‹ä»¶
        AddLocalEvent(new SessionEndedDomainEvent(Id, UserId, CalculateDuration()));
    }
    
    // é¢†åŸŸè®¡ç®—
    public int CalculateDuration()
    {
        var endTime = EndTime ?? DateTime.UtcNow;
        return (int)Math.Ceiling((endTime - StartTime).TotalMinutes);
    }
}

// é¢†åŸŸæœåŠ¡ - è·¨èšåˆçš„ä¸šåŠ¡é€»è¾‘
public class BillingDomainService : DomainService
{
    public async Task<decimal> CalculateSessionBillingAsync(
        TableSession session, 
        List<PricingRule> rules)
    {
        // å¤æ‚çš„è®¡è´¹é€»è¾‘
        var baseAmount = CalculateBaseAmount(session, rules);
        var discountAmount = await CalculateDiscountAsync(session.UserId);
        return Math.Max(0, baseAmount - discountAmount);
    }
}
```

### 2. CQRS (Command Query Responsibility Segregation)

**åŸåˆ™è¯´æ˜**: å‘½ä»¤å’ŒæŸ¥è¯¢åˆ†ç¦»ï¼Œè¯»å†™æ“ä½œä½¿ç”¨ä¸åŒçš„æ¨¡å‹

**åº”ç”¨åœºæ™¯**:
```csharp
// å‘½ä»¤ - ç”¨äºä¿®æ”¹æ•°æ®
public class StartSessionCommand
{
    public Guid UserId { get; set; }
    public int TableId { get; set; }
    public string SessionToken { get; set; } // å¹‚ç­‰æ€§ä¿è¯
}

// å‘½ä»¤å¤„ç†å™¨
public class StartSessionCommandHandler : ICommandHandler<StartSessionCommand>
{
    public async Task HandleAsync(StartSessionCommand command)
    {
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        var session = new TableSession(command.UserId, command.TableId);
        await _sessionRepository.InsertAsync(session);
    }
}

// æŸ¥è¯¢ - ç”¨äºè¯»å–æ•°æ®ï¼Œå¯ä»¥è·¨èšåˆæŸ¥è¯¢
public class GetActiveSessionsQuery
{
    public Guid? UserId { get; set; }
    public int? StoreId { get; set; }
    public DateTime? FromDate { get; set; }
}

// æŸ¥è¯¢å¤„ç†å™¨ - å¯ä»¥ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œä¸é€šè¿‡é¢†åŸŸæ¨¡å‹
public class GetActiveSessionsQueryHandler : IQueryHandler<GetActiveSessionsQuery, List<SessionDto>>
{
    public async Task<List<SessionDto>> HandleAsync(GetActiveSessionsQuery query)
    {
        return await (from s in _dbContext.TableSessions
                     join t in _dbContext.BilliardTables on s.TableId equals t.Id
                     join u in _dbContext.Users on s.UserId equals u.Id
                     where s.Status == SessionStatus.Active
                     select new SessionDto
                     {
                         Id = s.Id,
                         TableCode = t.Code,
                         UserName = u.UserName,
                         StartTime = s.StartTime,
                         DurationMinutes = EF.Functions.DateDiffMinute(s.StartTime, DateTime.UtcNow)
                     }).ToListAsync();
    }
}
```

### 3. äº‹ä»¶é©±åŠ¨æ¶æ„ (Event-Driven Architecture)

**åŸåˆ™è¯´æ˜**: é€šè¿‡äº‹ä»¶å®ç°æ¨¡å—é—´çš„æ¾è€¦åˆé€šä¿¡

**äº‹ä»¶è®¾è®¡**:
```csharp
// é¢†åŸŸäº‹ä»¶
public class SessionStartedDomainEvent : DomainEvent
{
    public Guid SessionId { get; set; }
    public Guid UserId { get; set; }
    public int TableId { get; set; }
    public DateTime StartTime { get; set; }
}

// é›†æˆäº‹ä»¶ - è·¨è¾¹ç•Œä¸Šä¸‹æ–‡
public class SessionStartedIntegrationEvent : IntegrationEvent
{
    public Guid SessionId { get; set; }
    public Guid UserId { get; set; }
    public int TableId { get; set; }
    public DateTime StartTime { get; set; }
}

// äº‹ä»¶å¤„ç†å™¨
public class SessionStartedEventHandler : 
    ILocalEventHandler<SessionStartedDomainEvent>,
    IDistributedEventHandler<SessionStartedIntegrationEvent>
{
    // é¢†åŸŸå†…äº‹ä»¶å¤„ç†
    public async Task HandleEventAsync(SessionStartedDomainEvent eventData)
    {
        // æ›´æ–°å°çƒæ¡ŒçŠ¶æ€
        await _tableManager.UpdateStatusAsync(eventData.TableId, TableStatus.InUse);
        
        // å‘å¸ƒé›†æˆäº‹ä»¶
        await _distributedEventBus.PublishAsync(
            ObjectMapper.Map<SessionStartedIntegrationEvent>(eventData));
    }
    
    // è·¨è¾¹ç•Œäº‹ä»¶å¤„ç†
    public async Task HandleEventAsync(SessionStartedIntegrationEvent eventData)
    {
        // å‘é€é€šçŸ¥
        await _notificationService.NotifySessionStartedAsync(eventData.UserId);
        
        // è®°å½•ç»Ÿè®¡æ•°æ®
        await _statisticsService.RecordSessionStartAsync(eventData.TableId);
    }
}
```

## ğŸ”’ å®‰å…¨è®¾è®¡åŸåˆ™

### 1. çºµæ·±é˜²å¾¡ (Defense in Depth)

**åŸåˆ™è¯´æ˜**: å¤šå±‚å®‰å…¨é˜²æŠ¤ï¼Œé¿å…å•ç‚¹æ•…éšœ

**é˜²æŠ¤å±‚æ¬¡**:
```mermaid
graph TB
    subgraph "å¤šå±‚å®‰å…¨æ¶æ„"
        CDN[CDNé˜²æŠ¤å±‚<br/>DDoSé˜²æŠ¤ã€IPé»‘åå•]
        WAF[WAFåº”ç”¨é˜²ç«å¢™<br/>SQLæ³¨å…¥ã€XSSé˜²æŠ¤]
        GATEWAY[APIç½‘å…³<br/>é™æµã€è®¤è¯ã€é‰´æƒ]
        APP[åº”ç”¨å±‚<br/>ä¸šåŠ¡æƒé™ã€æ•°æ®éªŒè¯]
        DATA[æ•°æ®å±‚<br/>åŠ å¯†å­˜å‚¨ã€è®¿é—®æ§åˆ¶]
    end
    
    CDN --> WAF
    WAF --> GATEWAY
    GATEWAY --> APP
    APP --> DATA
    
    style CDN fill:#ff9999
    style WAF fill:#ffcc99
    style GATEWAY fill:#99ccff
    style APP fill:#99ff99
    style DATA fill:#cc99ff
```

### 2. æœ€å°æƒé™åŸåˆ™ (Principle of Least Privilege)

**å®ç°æ–¹å¼**:
```csharp
// æƒé™å®šä¹‰
public class BilliardHallPermissions
{
    // ç”¨æˆ·ç®¡ç†æƒé™
    public static class Users
    {
        public const string Default = "BilliardHall.Users";
        public const string Create = Default + ".Create";
        public const string Edit = Default + ".Edit";
        public const string Delete = Default + ".Delete";
        public const string ViewSensitiveInfo = Default + ".ViewSensitiveInfo";
    }
}

// æƒé™æ§åˆ¶
[AbpAuthorize(BilliardHallPermissions.Users.ViewSensitiveInfo)]
public async Task<UserDetailDto> GetUserDetailAsync(Guid id)
{
    // åªæœ‰å…·å¤‡æ•æ„Ÿä¿¡æ¯æŸ¥çœ‹æƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®
    var user = await _userRepository.GetAsync(id);
    return ObjectMapper.Map<UserDetailDto>(user);
}

// æ•°æ®è¿‡æ»¤
[AbpMvcAuthorize]
public async Task<PagedResultDto<UserDto>> GetUsersAsync(GetUsersInput input)
{
    var query = await _userRepository.GetQueryableAsync();
    
    // éç®¡ç†å‘˜åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ•°æ®
    if (!await _permissionChecker.IsGrantedAsync(BilliardHallPermissions.Users.Default))
    {
        query = query.Where(u => u.Id == AbpSession.UserId);
    }
    
    return await query.ToPagedResultAsync(input);
}
```

### 3. è¾“å…¥éªŒè¯åŸåˆ™

**éªŒè¯ç­–ç•¥**:
```csharp
// DTOéªŒè¯
public class CreateUserDto : IValidatableObject
{
    [Required(ErrorMessage = "ç”¨æˆ·åä¸èƒ½ä¸ºç©º")]
    [StringLength(50, MinimumLength = 2, ErrorMessage = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨2-50ä¸ªå­—ç¬¦ä¹‹é—´")]
    public string UserName { get; set; }
    
    [Required(ErrorMessage = "æ‰‹æœºå·ä¸èƒ½ä¸ºç©º")]
    [RegularExpression(@"^1[3-9]\d{9}$", ErrorMessage = "æ‰‹æœºå·æ ¼å¼ä¸æ­£ç¡®")]
    public string PhoneNumber { get; set; }
    
    [Range(0, 10000, ErrorMessage = "ä½™é¢å¿…é¡»åœ¨0-10000ä¹‹é—´")]
    public decimal InitialBalance { get; set; }
    
    public IEnumerable<ValidationResult> Validate(ValidationContext validationContext)
    {
        // è‡ªå®šä¹‰éªŒè¯é€»è¾‘
        if (UserName?.ToLower().Contains("admin") == true)
        {
            yield return new ValidationResult(
                "ç”¨æˆ·åä¸èƒ½åŒ…å«adminå…³é”®å­—", 
                new[] { nameof(UserName) });
        }
    }
}

// ä¸šåŠ¡è§„åˆ™éªŒè¯
public class UserManager : DomainService
{
    public async Task<User> CreateAsync(string userName, string phoneNumber)
    {
        // é‡å¤æ€§æ£€æŸ¥
        if (await _userRepository.AnyAsync(u => u.UserName == userName))
            throw new BusinessException("ç”¨æˆ·åå·²å­˜åœ¨");
            
        if (await _userRepository.AnyAsync(u => u.PhoneNumber == phoneNumber))
            throw new BusinessException("æ‰‹æœºå·å·²è¢«æ³¨å†Œ");
        
        // åˆ›å»ºç”¨æˆ·
        return new User(GuidGenerator.Create(), userName, phoneNumber);
    }
}
```

## ğŸš€ æ€§èƒ½è®¾è®¡åŸåˆ™

### 1. ç¼“å­˜ä¼˜å…ˆåŸåˆ™

**ç¼“å­˜ç­–ç•¥**:
```csharp
public class TableAppService : ApplicationService
{
    [AbpCache] // ABPç¼“å­˜æ‹¦æˆªå™¨
    public virtual async Task<List<BilliardTableDto>> GetAvailableTablesAsync(Guid storeId)
    {
        var tables = await _tableRepository.GetListAsync(
            t => t.StoreId == storeId && t.Status == TableStatus.Available);
        return ObjectMapper.Map<List<BilliardTableDto>>(tables);
    }
    
    // æ‰‹åŠ¨ç¼“å­˜æ§åˆ¶
    public async Task<BilliardTableDto> GetTableAsync(int tableId)
    {
        var cacheKey = $"table:{tableId}";
        
        return await _distributedCache.GetOrAddAsync(
            cacheKey,
            async () =>
            {
                var table = await _tableRepository.GetAsync(tableId);
                return ObjectMapper.Map<BilliardTableDto>(table);
            },
            TimeSpan.FromMinutes(10) // ç¼“å­˜10åˆ†é’Ÿ
        );
    }
}
```

### 2. å¼‚æ­¥ä¼˜å…ˆåŸåˆ™

**å¼‚æ­¥å®ç°**:
```csharp
// å¼‚æ­¥æ–¹æ³•è®¾è®¡
public class SessionAppService : ApplicationService
{
    public async Task<SessionDto> StartSessionAsync(StartSessionDto input)
    {
        // å¼‚æ­¥æ“ä½œï¼Œä¸é˜»å¡çº¿ç¨‹
        var session = await _sessionManager.StartAsync(input.UserId, input.TableId);
        
        // å¼‚æ­¥å‘é€é€šçŸ¥ï¼Œä¸ç­‰å¾…ç»“æœ
        _ = Task.Run(async () => 
        {
            await _notificationService.SendSessionStartNotificationAsync(session.Id);
        });
        
        return ObjectMapper.Map<SessionDto>(session);
    }
    
    // æ‰¹é‡æ“ä½œå¼‚æ­¥åŒ–
    public async Task<List<SessionDto>> GetActiveSessionsAsync()
    {
        var sessions = await _sessionRepository
            .Where(s => s.Status == SessionStatus.Active)
            .Include(s => s.Table)
            .Include(s => s.User)
            .ToListAsync(); // EF Coreå¼‚æ­¥æŸ¥è¯¢
            
        return ObjectMapper.Map<List<SessionDto>>(sessions);
    }
}
```

### 3. æ•°æ®åº“ä¼˜åŒ–åŸåˆ™

**æŸ¥è¯¢ä¼˜åŒ–**:
```csharp
// ä½¿ç”¨ç´¢å¼•
[Index(nameof(UserId), nameof(Status))] // å¤åˆç´¢å¼•
public class TableSession : FullAuditedAggregateRoot<Guid>
{
    public Guid UserId { get; set; }
    public SessionStatus Status { get; set; }
}

// é¿å…N+1æŸ¥è¯¢
public async Task<List<SessionWithDetailsDto>> GetSessionsWithDetailsAsync()
{
    return await (from s in _dbContext.TableSessions
                 join t in _dbContext.BilliardTables on s.TableId equals t.Id
                 join u in _dbContext.Users on s.UserId equals u.Id
                 select new SessionWithDetailsDto
                 {
                     SessionId = s.Id,
                     TableCode = t.Code,
                     UserName = u.UserName,
                     StartTime = s.StartTime,
                     Status = s.Status
                 }).ToListAsync();
}

// åˆ†é¡µæŸ¥è¯¢
public async Task<PagedResultDto<SessionDto>> GetPagedSessionsAsync(PagedResultRequestDto input)
{
    var query = await _sessionRepository.GetQueryableAsync();
    
    var totalCount = await query.CountAsync();
    var sessions = await query
        .OrderByDescending(s => s.CreationTime)
        .PageBy(input) // ABPåˆ†é¡µæ‰©å±•
        .ToListAsync();
        
    return new PagedResultDto<SessionDto>(totalCount, 
        ObjectMapper.Map<List<SessionDto>>(sessions));
}
```

## ğŸ”§ å¼€å‘è§„èŒƒåŸåˆ™

### 1. ä»£ç æ•´æ´åŸåˆ™

**å‘½åè§„èŒƒ**:
```csharp
// âœ… å¥½çš„å‘½å - è¡¨æ„æ¸…æ™°
public class TableSessionManager : DomainService
{
    public async Task<TableSession> StartSessionAsync(Guid userId, int tableId)
    {
        var table = await _tableRepository.GetAsync(tableId);
        if (!table.IsAvailable())
            throw new BusinessException("å°çƒæ¡Œä¸å¯ç”¨");
            
        return await CreateSessionAsync(userId, tableId);
    }
}

// âŒ ä¸å¥½çš„å‘½å - å«ä¹‰æ¨¡ç³Š
public class TSMgr : DomainService
{
    public async Task<TS> Start(Guid u, int t)
    {
        var tb = await _repo.Get(t);
        if (!tb.OK())
            throw new BusinessException("ä¸å¯ç”¨");
            
        return await Create(u, t);
    }
}
```

### 2. é”™è¯¯å¤„ç†åŸåˆ™

**å¼‚å¸¸å¤„ç†ç­–ç•¥**:
```csharp
// ä¸šåŠ¡å¼‚å¸¸
public class InsufficientBalanceException : BusinessException
{
    public InsufficientBalanceException(decimal required, decimal available) 
        : base($"ä½™é¢ä¸è¶³ã€‚éœ€è¦ï¼š{required:C}ï¼Œå¯ç”¨ï¼š{available:C}")
    {
        Data["RequiredAmount"] = required;
        Data["AvailableAmount"] = available;
    }
}

// å¼‚å¸¸å¤„ç†
public async Task<PaymentDto> CreatePaymentAsync(CreatePaymentDto input)
{
    try
    {
        var user = await _userRepository.GetAsync(input.UserId);
        if (user.Balance < input.Amount)
            throw new InsufficientBalanceException(input.Amount, user.Balance);
            
        var payment = await _paymentManager.CreateAsync(input);
        return ObjectMapper.Map<PaymentDto>(payment);
    }
    catch (BusinessException)
    {
        throw; // ä¸šåŠ¡å¼‚å¸¸ç›´æ¥æŠ›å‡º
    }
    catch (Exception ex)
    {
        Logger.LogError(ex, "åˆ›å»ºæ”¯ä»˜è®¢å•å¤±è´¥ï¼š{UserId}, {Amount}", input.UserId, input.Amount);
        throw new BusinessException("ç³»ç»Ÿå¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### 3. æ—¥å¿—è®°å½•åŸåˆ™

**ç»“æ„åŒ–æ—¥å¿—**:
```csharp
public class PaymentAppService : ApplicationService
{
    public async Task<PaymentDto> ProcessPaymentAsync(ProcessPaymentDto input)
    {
        using var activity = Logger.BeginScope(new Dictionary<string, object>
        {
            ["UserId"] = input.UserId,
            ["OrderId"] = input.OrderId,
            ["Amount"] = input.Amount,
            ["Channel"] = input.Channel
        });
        
        Logger.LogInformation("å¼€å§‹å¤„ç†æ”¯ä»˜è¯·æ±‚");
        
        try
        {
            var result = await _paymentService.ProcessAsync(input);
            Logger.LogInformation("æ”¯ä»˜å¤„ç†æˆåŠŸï¼š{PaymentId}", result.Id);
            return ObjectMapper.Map<PaymentDto>(result);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "æ”¯ä»˜å¤„ç†å¤±è´¥");
            throw;
        }
    }
}
```

## ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§åŸåˆ™

### 1. å¥åº·æ£€æŸ¥è®¾è®¡

```csharp
public class BilliardHallHealthCheck : IHealthCheck
{
    private readonly ITableRepository _tableRepository;
    private readonly IDistributedCache _distributedCache;
    
    public async Task<HealthCheckResult> CheckHealthAsync(
        HealthCheckContext context, 
        CancellationToken cancellationToken = default)
    {
        try
        {
            // æ£€æŸ¥æ•°æ®åº“è¿æ¥
            await _tableRepository.CountAsync();
            
            // æ£€æŸ¥ç¼“å­˜è¿æ¥
            await _distributedCache.SetStringAsync("health_check", "ok", cancellationToken);
            
            return HealthCheckResult.Healthy("æ‰€æœ‰ä¾èµ–æœåŠ¡æ­£å¸¸");
        }
        catch (Exception ex)
        {
            return HealthCheckResult.Unhealthy("ä¾èµ–æœåŠ¡å¼‚å¸¸", ex);
        }
    }
}
```

### 2. æŒ‡æ ‡ç›‘æ§è®¾è®¡

```csharp
public class SessionMetricsService : ITransientDependency
{
    private readonly IMetrics _metrics;
    
    public async Task RecordSessionStart(Guid sessionId, int tableId)
    {
        _metrics.Increment("sessions.started", tags: new[] 
        { 
            $"table:{tableId}"
        });
        
        _metrics.Gauge("sessions.active", GetActiveSessionCount());
    }
    
    public async Task RecordSessionDuration(TimeSpan duration)
    {
        _metrics.Timing("sessions.duration", duration.TotalMilliseconds);
    }
}
```

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æŠ€æœ¯é€‰å‹](æŠ€æœ¯é€‰å‹.md) - æŠ€æœ¯æ ˆé€‰æ‹©ä¾æ®
- [ç³»ç»Ÿæ¨¡å—åˆ’åˆ†](ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md) - æ¨¡å—è®¾è®¡å®è·µ
- [æ€»ä½“æ¶æ„å›¾](æ€»ä½“æ¶æ„å›¾.md) - æ¶æ„å›¾è§£è¯´æ˜
- [å¤–éƒ¨æ¥å£](å¤–éƒ¨æ¥å£.md) - æ¥å£è®¾è®¡è§„èŒƒ

---

ğŸ’¡ **è¯´æ˜**: è®¾è®¡åŸåˆ™æ˜¯æ¶æ„è®¾è®¡çš„æŒ‡å¯¼æ€æƒ³ï¼Œåº”è¯¥åœ¨æ•´ä¸ªå¼€å‘è¿‡ç¨‹ä¸­æŒç»­éµå¾ªå’Œä¼˜åŒ–ã€‚éšç€ç³»ç»Ÿæ¼”è¿›ï¼ŒåŸåˆ™ä¹Ÿå¯èƒ½éœ€è¦é€‚å½“è°ƒæ•´ã€‚
