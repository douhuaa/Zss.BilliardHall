# 测试编写指令

> ⚖️权威声明: 若本文档与 ADR 正文冲突，以 ADR 正文为准。
> 基于 base.instructions.md 

## 适用范围

测试编写与维护

## 权威依据

* ADR-0000：架构测试与 CI 治理元规则
* ADR-0001：模块化单体与垂直切片架构
* ADR-0005：应用内交互模型与执行边界

---

## 引用优先级

ADR 正文 > 架构测试 > Copilot Prompts

---

## 架构测试（最高优先级）

* 架构测试 **只验证 ADR 正文中标注【必须架构测试覆盖】的条款**
* 测试失败必须引用 **ADR 正文 + 具体章节**
* ❌ 禁止为“让代码通过”而修改 / 弱化 / 注释架构测试

📌 测试位置：`src/tests/ArchitectureTests/ADR/`

---

## 测试组织规则

* 测试结构 **必须镜像源代码结构**
* 一个用例一个测试目录
* 测试项目按模块拆分

📌 依据：ADR-0001

---

## 单元测试硬约束

### Handler 测试

* ✅ 只测试行为，不测试实现细节
* ❌ 不验证 Repository / EventBus 的调用顺序
* ❌ 不在测试中重现业务逻辑

### 领域模型测试

* ✅ 所有业务规则必须有测试
* ✅ 验证状态变化和领域事件
* ❌ 不通过 Handler 间接测试领域逻辑

---

## 集成测试边界

* ✅ 覆盖关键端到端路径
* ❌ 不测试所有分支
* ❌ 不替代单元测试

---

## 危险信号（发现即 Blocked）

* 🚩 为通过架构测试而改测试
* 🚩 注释 / 移除架构测试
* 🚩 测试直接依赖其他模块的内部类型
* 🚩 Handler 测试断言过多实现细节
* 🚩 用集成测试代替领域/Handler 测试

处理方式：

* 标记 ⚠️ **Blocked**
* 引用 ADR 正文章节
* 引导查阅 prompts
* 不给变通方案

---

## 测试失败处理规则

### 架构测试失败

1. 不修改测试
2. 引用失败信息
3. 对应 ADR 正文定位违规点
4. 修复代码

### 其他测试失败

* 优先修复代码
* 仅在测试本身错误时修改测试

---

## 覆盖率原则

* 不追求百分比
* 覆盖：

  * 领域业务规则
  * Handler 编排流程
  * 边界与异常路径
* 可跳过：

  * DTO
  * 纯样板代码

---

## 三态输出规则

所有诊断必须使用：

* ✅ Allowed
* ⚠️ Blocked
* ❓ Uncertain

并注明：**以 ADR-0007 和相关 ADR 正文为最终权威**

---

## 参考

* `docs/copilot/architecture-test-failures.md`
* `docs/copilot/adr-XXXX.prompts.md`

---

### 🔚 直说一句

> **测试指令的职责不是教人“怎么写测试”，
> 而是确保“测试不会破坏架构治理”。**

