# GitHub Copilot 指令

⚠️ 本文档不具备裁决力。所有架构决策以对应 ADR 正文为准。

本目录包含基于角色的 GitHub Copilot 指令，以确保与项目架构治理保持一致的行为。

## 目的

这些指令文件定义了**Copilot 在此仓库中的个性和行为边界**。它们回答："你是什么样的助手？"

这与 `docs/copilot/` 不同，后者包含**详细的工作手册**，回答："你如何帮助完成特定任务？"

## 结构

```
.github/instructions/
  ├─ base.instructions.md                 ← 核心行为（始终激活）
  ├─ backend.instructions.md              ← 后端开发
  ├─ testing.instructions.md              ← 测试编写
  ├─ documentation.instructions.md        ← 文档编写
  └─ architecture-review.instructions.md  ← PR 评审（最高风险）
```

## 工作原理

### 基础指令（始终激活）

`base.instructions.md` 建立 Copilot 的基本行为：

- 尊重 ADR 作为宪法级法律
- 将架构测试视为硬性约束
- 绝不发明规则或绕过 CI
- 放大理解能力，不替代理解

### 角色特定指令（根据上下文）

根据你的工作内容应用额外指令：

| 工作内容...         | 额外指令                                  |
|-----------------|---------------------------------------|
| Handler、用例、领域模型 | `backend.instructions.md`             |
| 单元测试、集成测试       | `testing.instructions.md`             |
| ADR、指南、Prompt   | `documentation.instructions.md`       |
| PR 评审、架构评估      | `architecture-review.instructions.md` |

## 指令系统职责分层

本章节明确 Instructions、Prompts、ADR 三者的职责边界和引用关系。

### 职责定位

| 层级 | 位置 | 职责 | 内容 | 变更频率 |
|------|------|------|------|---------|
| **宪法层** | `docs/adr/` | 架构决策记录 | 裁决型约束条款 | 极少，需架构委员会批准 |
| **行为层** | `.github/instructions/` | Agent 角色边界 | 禁止/允许的行为边界 | 很少，随架构原则变化 |
| **辅导层** | `docs/copilot/` | 场景实施指南 | "如何做"的具体方案 | 随团队经验演进 |
| **执行层** | `ArchitectureTests` | 自动化验证 | 可执行的测试代码 | 跟随 ADR 演进 |

### 核心原则

1. **Instructions 不含实施细节**
   - 只声明"禁止什么"、"允许什么"的边界
   - 不包含代码示例、具体步骤、场景解法
   - 所有"如何做"细节一律指向 Prompts

2. **Prompts 不做裁决**
   - 提供场景化的实施指南和代码示例
   - 不能作为架构裁决的依据
   - 与 ADR 冲突时，以 ADR 为准

3. **引用必须有层级**
   - 裁决必须引用 ADR 正文及章节
   - 实施引用 Prompts 文件
   - Instructions 不引用 Prompts 做裁决

4. **Agent 权限仅参考 ADR-007**
   - Instructions 中关于 Agent 行为的描述仅做跳转引用
   - 不在 Instructions 中内联复述 ADR-007 内容
   - 所有三态输出、禁止行为等规则完全遵循 ADR-007

### 与 docs/copilot/ 的关系

这两个系统协同工作但目的不同：

| `.github/instructions/` | `docs/copilot/`  |
|-------------------------|------------------|
| Copilot **是谁**          | Copilot **如何**工作 |
| 行为边界                   | 场景实施             |
| 禁止/允许什么                | 具体怎么做            |
| 不含代码示例                  | 包含代码示例           |
| 很少变更                    | 随经验演进            |

### 示例

**Instructions 说**：
> "禁止跨模块直接依赖。详细实施方案参阅 `docs/copilot/adr-001.prompts.md`"

**Prompts 说**：
> "当开发者想访问另一个模块时：
> - ✅ 使用领域事件：`await _eventBus.Publish(...)`
> - ✅ 使用契约：`await _queryBus.Send(...)`
> - ✅ 使用原始类型：`Guid memberId`
> - ❌ 不要使用直接引用"

### 引用路径图

```
开发者请求 
    ↓
Copilot (Instructions) 
    ↓
判定：是否违反边界？
    ├─ 是 → 引用 ADR 正文 + 章节（裁决依据）
    │        ↓
    │      引导查阅 Prompts（实施方案）
    │
    └─ 否 → 引导查阅 Prompts（实施指南）
             ↓
          提供代码示例和步骤
```

### 内容迁移原则

从 Instructions 移至 Prompts 的内容：
- ✅ 代码示例和实现模式
- ✅ "如何做XX"的步骤说明
- ✅ 场景化的决策树
- ✅ 具体的修复方案

Instructions 保留的内容：
- ✅ "禁止XX"、"允许XX"的边界声明
- ✅ 危险信号检查清单
- ✅ 引用路径和优先级
- ✅ ADR-007 的跳转链接（不内联复述）

## 何时更新

### 更新基础指令的时机：

- 项目采用新架构原则
- 基本约束发生变化
- 出现新的"绝不做这个"规则

### 更新角色特定指令的时机：

- 某个模式变得足够常见需要正式化
- 角色边界需要澄清
- 风险等级发生变化

### 不要更新的情况：

- 具体示例（放入 `docs/copilot/`）
- 临时例外
- 个别用例

## 三层架构治理

```
┌─────────────────────────────────────────────────┐
│ 第 1 层：ADR（docs/adr/）                        │
│ - 宪法级法律                                     │
│ - 架构决策记录                                   │
│ - 最高权威                                       │
└─────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────┐
│ 第 2 层：指令（.github/instructions/）          │
│ - Copilot 的个性                                 │
│ - 行为边界                                       │
│ - "我是什么样的助手？"                           │
└─────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────┐
│ 第 3 层：Prompt（docs/copilot/）                │
│ - 详细工作手册                                   │
│ - 场景特定指导                                   │
│ - "我如何处理情况 X？"                           │
└─────────────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────────────┐
│ 执行：ArchitectureTests                          │
│ - 自动化验证                                     │
│ - CI/CD 门禁                                     │
│ - 不可协商                                       │
└─────────────────────────────────────────────────┘
```

## 使用指南

### 对于开发者

与 Copilot 交互时：

1. Copilot 将自动遵循这些指令
2. 如果需要具体帮助，参考相关的 `docs/copilot/` 文件
3. 如果 Copilot 显得过于谨慎，这是有意为之——它在保护架构

### 对于维护者

更新指令时：

1. 确保所有文件之间的一致性
2. 更新版本号和日期
3. 测试变更不与现有 ADR 冲突
4. 在 PR 中记录重大变更

## 关键原则

> **Copilot 放大理解能力，不替代理解**

这些指令确保 Copilot：

- ✅ 帮助你更快理解 ADR
- ✅ 更早捕获违规
- ✅ 建议合规解决方案
- ❌ 不让你绕过学习
- ❌ 不替代人工判断
- ❌ 不覆盖架构测试

## 快速参考

| 场景              | 查看文件                                  |
|-----------------|---------------------------------------|
| "我能在模块中做 X 吗？"  | `backend.instructions.md`             |
| "我应该如何测试这个？"    | `testing.instructions.md`             |
| "我应该如何记录这个？"    | `documentation.instructions.md`       |
| "这个 PR 架构上合理吗？" | `architecture-review.instructions.md` |
| "核心规则是什么？"      | `base.instructions.md`                |

对于详细的"如何做"指导，始终参考 `docs/copilot/` 文件。

## 版本

当前版本：1.0
最后更新：2026-01-21

对这些指令的更改应该是罕见且深思熟虑的，因为它们定义了 Copilot 在此仓库中的基本行为。
