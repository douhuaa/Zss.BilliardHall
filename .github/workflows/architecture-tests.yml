name: Architecture Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

permissions:
  contents: read
  checks: write
  actions: read
  pull-requests: write

jobs:
  architecture-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.*' # æ¨èä½¿ç”¨é€šé…ç¬¦ï¼Œæå‡å…¼å®¹æ€§

      - name: Restore dependencies
        run: dotnet restore

      - name: Build solution
        run: dotnet build --no-restore --configuration Release

      - name: Validate ADR Consistency
        run: |
          echo "::group::ADR ç¼–å·/ç›®å½•/å†…å®¹ä¸€è‡´æ€§éªŒè¯"
          chmod +x ./scripts/validate-adr-consistency.sh
          ./scripts/validate-adr-consistency.sh
          echo "::endgroup::"

      - name: Validate Three-Way Mapping
        run: |
          echo "::group::ADR/æµ‹è¯•/Prompt ä¸‰ä½ä¸€ä½“æ˜ å°„éªŒè¯"
          chmod +x ./scripts/validate-three-way-mapping.sh
          ./scripts/validate-three-way-mapping.sh
          echo "::endgroup::"

      - name: Validate ADR-Test Mapping (Legacy)
        run: |
          echo "::group::ADR-æµ‹è¯•æ˜ å°„ä¸€è‡´æ€§éªŒè¯ï¼ˆä¼ ç»Ÿï¼‰"
          chmod +x ./scripts/validate-adr-test-mapping.sh
          ./scripts/validate-adr-test-mapping.sh
          echo "::endgroup::"

      - name: Run architecture tests
        run: |
          echo "::group::Architecture Tests Execution"
          dotnet test src/tests/ArchitectureTests \
            --no-build \
            --configuration Release \
            --verbosity normal \
            --logger "trx;LogFileName=architecture-test-results.trx" \
            --logger "console;verbosity=detailed" \
            --collect:"XPlat Code Coverage"
          echo "::endgroup::"
        env:
          Configuration: Release

      - name: Generate test report
        if: always() && (github.event.pull_request == null || github.event.pull_request.head.repo.full_name == github.repository)
        uses: dorny/test-reporter@v1
        with:
          name: Architecture Tests Report
          path: '**/architecture-test-results.trx'
          reporter: dotnet-trx
          fail-on-error: true
        timeout-minutes: 5 # å¢åŠ è¶…æ—¶é™åˆ¶ï¼Œé˜²æ­¢å¡æ­»

      - name: Publish test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: architecture-test-results
          path: |
            **/architecture-test-results.trx
            **/TestResults/

      - name: Check architecture compliance
        if: failure()
        run: |
          echo "::group::âŒ Architecture Tests Failed"
          echo ""
          echo "âš ï¸ æ¶æ„æµ‹è¯•å¤±è´¥æ£€æµ‹åˆ°è¿è§„è¡Œä¸º"
          echo ""
          echo "ğŸ“‹ å¦‚ä½•ä½¿ç”¨ Copilot è¯Šæ–­å’Œä¿®å¤ï¼š"
          echo ""
          echo "1ï¸âƒ£ æŸ¥çœ‹è¯¦ç»†çš„æµ‹è¯•å¤±è´¥æ—¥å¿—ï¼ˆåœ¨ä¸Šæ–¹ 'Run architecture tests' æ­¥éª¤ä¸­ï¼‰"
          echo ""
          echo "2ï¸âƒ£ å°†å¤±è´¥æ—¥å¿—å¤åˆ¶ç»™ GitHub Copilotï¼Œå¹¶è¯¢é—®ï¼š"
          echo "   \"è¯·æ ¹æ®ä»¥ä¸‹æ¶æ„æµ‹è¯•å¤±è´¥æ—¥å¿—ï¼Œè§£é‡Šè¿è§„åŸå› å¹¶æä¾›ä¿®å¤å»ºè®®\""
          echo ""
          echo "3ï¸âƒ£ Copilot ä¼šå‚è€ƒä»¥ä¸‹èµ„æºæä¾›è§£é‡Šï¼š"
          echo "   - docs/copilot/README.md - Copilot è§’è‰²å®šä½"
          echo "   - docs/copilot/adr-XXXX.prompts.md - å„ ADR çš„æç¤ºè¯åº“"
          echo "   - docs/copilot/architecture-test-failures.md - å¤±è´¥è§£é‡ŠæŒ‡å—"
          echo ""
          echo "4ï¸âƒ£ æ ¹æ® Copilot çš„å»ºè®®ä¿®å¤ä»£ç "
          echo ""
          echo "5ï¸âƒ£ æœ¬åœ°éªŒè¯ä¿®å¤ï¼š"
          echo "   dotnet test src/tests/ArchitectureTests/"
          echo ""
          echo "ğŸ“š ç›¸å…³èµ„æºï¼š"
          echo "   - Copilot æ²»ç†ä½“ç³»ï¼šhttps://github.com/${{ github.repository }}/blob/main/docs/copilot/README.md"
          echo "   - æ¶æ„æµ‹è¯•å¤±è´¥æŒ‡å—ï¼šhttps://github.com/${{ github.repository }}/blob/main/docs/copilot/architecture-test-failures.md"
          echo "   - PR æ¨¡æ¿ï¼šhttps://github.com/${{ github.repository }}/blob/main/.github/PULL_REQUEST_TEMPLATE.md"
          echo "   - ä¸‹è½½æµ‹è¯•æŠ¥å‘Šï¼šhttps://github.com/${{ github.repository }}/actions/artifacts"
          echo ""
          echo "::endgroup::"
          exit 1

      - name: Comment on PR with Copilot guidance
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const comment = `## âŒ æ¶æ„æµ‹è¯•å¤±è´¥\n\nâš ï¸ æœ¬ PR çš„æ¶æ„æµ‹è¯•æœªé€šè¿‡ï¼Œæ£€æµ‹åˆ°æ¶æ„è¿è§„è¡Œä¸ºã€‚\n\n### ğŸ“‹ ä½¿ç”¨ Copilot è¯Šæ–­å’Œä¿®å¤\n\n#### 1ï¸âƒ£ æŸ¥çœ‹å¤±è´¥æ—¥å¿—\nç‚¹å‡»ä¸Šæ–¹ \"Run architecture tests\" æ­¥éª¤æŸ¥çœ‹è¯¦ç»†çš„å¤±è´¥ä¿¡æ¯ã€‚\n\n#### 2ï¸âƒ£ è¯¢é—® Copilot\nå°†å¤±è´¥æ—¥å¿—å¤åˆ¶ç»™ GitHub Copilotï¼Œå¹¶è¯¢é—®ï¼š\n\n\`\`\`\nè¯·æ ¹æ®ä»¥ä¸‹æ¶æ„æµ‹è¯•å¤±è´¥æ—¥å¿—ï¼Œè§£é‡Šè¿è§„åŸå› å¹¶æä¾›ä¿®å¤å»ºè®®\n\n[ç²˜è´´å¤±è´¥æ—¥å¿—]\n\`\`\`\n\n#### 3ï¸âƒ£ Copilot å‚è€ƒèµ„æº\nCopilot ä¼šåŸºäºä»¥ä¸‹èµ„æºä¸ºä½ æä¾›è¯¦ç»†è§£é‡Šï¼š\n- [Copilot æ²»ç†ä½“ç³»](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/copilot/README.md)\n- [ADR æç¤ºè¯åº“](https://github.com/${context.repo.owner}/${context.repo.repo}/tree/main/docs/copilot)\n- [æ¶æ„æµ‹è¯•å¤±è´¥è§£é‡ŠæŒ‡å—](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/copilot/architecture-test-failures.md)\n\n#### 4ï¸âƒ£ ä¿®å¤å¹¶éªŒè¯\næ ¹æ® Copilot çš„å»ºè®®ä¿®å¤ä»£ç åï¼Œåœ¨æœ¬åœ°è¿è¡Œï¼š\n\n\`\`\`bash\ndotnet test src/tests/ArchitectureTests/\n\`\`\`\n\n### ğŸ“š ç›¸å…³ ADR\n\n- [ADR-0001: æ¨¡å—åŒ–å•ä½“ä¸å‚ç›´åˆ‡ç‰‡æ¶æ„](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md)\n- [ADR-0002: Platform / Application / Host ä¸‰å±‚å¯åŠ¨ä½“ç³»](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/adr/constitutional/ADR-0002-platform-application-host-bootstrap.md)\n- [ADR-0003: å‘½åç©ºé—´ä¸é¡¹ç›®è¾¹ç•Œè§„èŒƒ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/adr/constitutional/ADR-0003-namespace-rules.md)\n- [ADR-0004: ä¸­å¤®åŒ…ç®¡ç†ï¼ˆCPMï¼‰è§„èŒƒ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/adr/constitutional/ADR-0004-Cpm-Final.md)\n- [ADR-0005: åº”ç”¨å†…äº¤äº’æ¨¡å‹ä¸æ‰§è¡Œè¾¹ç•Œ](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/adr/constitutional/ADR-0005-Application-Interaction-Model-Final.md)\n\n---\n\nğŸ’¡ **æç¤º**ï¼šè®°å¾—åœ¨ PR æè¿°ä¸­å®Œæˆ \"Copilot å‚ä¸æ£€æŸ¥æ¸…å•\"ã€‚\n`;
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } catch (error) {
              console.error('PR è¯„è®ºå¤±è´¥:', error);
            }

      - name: Architecture compliance summary
        if: success()
        run: |
          echo "::group::âœ… Architecture Compliance Summary"
          echo ""
          echo "ğŸ‰ æ‰€æœ‰æ¶æ„æµ‹è¯•é€šè¿‡ï¼"
          echo ""
          echo "âœ… æœ¬ PR ç¬¦åˆä»¥ä¸‹æ¶æ„å†³ç­–è®°å½•ï¼ˆADRï¼‰ï¼š"
          echo "   - ADR-0001: æ¨¡å—åŒ–å•ä½“ä¸å‚ç›´åˆ‡ç‰‡æ¶æ„"
          echo "   - ADR-0002: Platform / Application / Host ä¸‰å±‚å¯åŠ¨ä½“ç³»"
          echo "   - ADR-0003: å‘½åç©ºé—´ä¸é¡¹ç›®è¾¹ç•Œè§„èŒƒ"
          echo "   - ADR-0004: ä¸­å¤®åŒ…ç®¡ç†ï¼ˆCPMï¼‰è§„èŒƒ"
          echo "   - ADR-0005: åº”ç”¨å†…äº¤äº’æ¨¡å‹ä¸æ‰§è¡Œè¾¹ç•Œ"
          echo ""
          echo "ğŸ’¡ æç¤ºï¼šåœ¨ PR ä¸­å‹¾é€‰ 'Copilot å‚ä¸æ£€æŸ¥æ¸…å•'"
          echo ""
          echo "::endgroup::"
