name: Architecture Violations Scanner

# æ ¹æ® ADR-0000.Y ç ´ä¾‹æˆæœ¬ç®¡ç†ï¼Œå®šæœŸæ‰«æè¿‡æœŸç ´ä¾‹
# æ¯æœˆç¬¬ä¸€å¤©è‡ªåŠ¨è¿è¡Œï¼Œå‘ç°è¿‡æœŸç ´ä¾‹åˆ™æ„å»ºå¤±è´¥

on:
  schedule:
    # æ¯æœˆç¬¬ä¸€å¤© UTC 00:00 è¿è¡Œ
    - cron: '0 0 1 * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    paths:
      - 'docs/summaries/arch-violations.md'
      - '.github/workflows/arch-violations-scanner.yml'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  scan-violations:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Scan for overdue violations
        id: scan
        run: |
          python3 << 'EOF'
          import re
          import sys
          from datetime import datetime

          # è¯»å– arch-violations.md
          try:
              with open('docs/governance/arch-violations.md', 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print("âŒ arch-violations.md æ–‡ä»¶ä¸å­˜åœ¨")
              sys.exit(1)

          # æå–ç‰ˆæœ¬å·ï¼ˆå‡è®¾æ ¼å¼ä¸º vX.Y.Zï¼‰
          def parse_version(version_str):
              """è§£æç‰ˆæœ¬å·å­—ç¬¦ä¸²ï¼Œè¿”å› (major, minor, patch) å…ƒç»„"""
              match = re.match(r'v?(\d+)\.(\d+)\.(\d+)', version_str.strip())
              if match:
                  return tuple(map(int, match.groups()))
              return None

          # æ¨¡æ‹Ÿå½“å‰ç‰ˆæœ¬ï¼ˆå®é™…åº”ä» Directory.Build.props æˆ–å…¶ä»–åœ°æ–¹è¯»å–ï¼‰
          # ä¸ºæ¼”ç¤ºç›®çš„ï¼Œä½¿ç”¨å›ºå®šç‰ˆæœ¬
          CURRENT_VERSION = (2, 0, 0)  # v2.0.0

          # æŸ¥æ‰¾æ´»è·ƒç ´ä¾‹ï¼ˆçŠ¶æ€ä¸º ğŸš§ Activeï¼‰
          active_pattern = r'\|\s*([A-Z]+-\d+)\s*\|\s*([^\|]+)\|\s*([^\|]+)\|\s*([^\|]+)\|\s*([^\|]+)\|\s*(v[\d\.]+)\s*\|\s*([^\|]+)\|\s*([^\|]+)\|\s*([^\|]+)\|\s*ğŸš§\s*\|'

          overdue_violations = []
          lines = content.split('\n')

          for line_num, line in enumerate(lines, 1):
              match = re.search(active_pattern, line)
              if match:
                  violation_id = match.group(1).strip()
                  due_version_str = match.group(6).strip()
                  due_version = parse_version(due_version_str)

                  if due_version and due_version <= CURRENT_VERSION:
                      overdue_violations.append({
                          'id': violation_id,
                          'due_version': due_version_str,
                          'line': line_num,
                          'content': line.strip()
                      })

          # è¾“å‡ºç»“æœ
          if overdue_violations:
              print("âŒ å‘ç°è¿‡æœŸç ´ä¾‹ï¼š")
              print("")
              for v in overdue_violations:
                  print(f"  - {v['id']} (åˆ°æœŸç‰ˆæœ¬: {v['due_version']}, è¡Œ: {v['line']})")
              print("")
              print(f"å½“å‰ç‰ˆæœ¬: v{'.'.join(map(str, CURRENT_VERSION))}")
              print("")
              print("æ ¹æ® ADR-0000.Yï¼Œè¿‡æœŸç ´ä¾‹å¿…é¡»å¿è¿˜æˆ–ç”³è¯·å»¶æœŸã€‚")
              print("")

              # è®¾ç½® GitHub Actions è¾“å‡º
              with open('overdue_violations.txt', 'w') as f:
                  for v in overdue_violations:
                      f.write(f"{v['id']}\n")

              sys.exit(1)
          else:
              print("âœ… æœªå‘ç°è¿‡æœŸç ´ä¾‹")
              sys.exit(0)
          EOF

      - name: Create Issue for overdue violations
        if: failure() && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let violations = [];
            try {
              const content = fs.readFileSync('overdue_violations.txt', 'utf8');
              violations = content.trim().split('\n').filter(v => v);
            } catch (error) {
              console.log('æ— æ³•è¯»å–è¿‡æœŸç ´ä¾‹åˆ—è¡¨');
            }

            if (violations.length > 0) {
              const body = `## âš ï¸ å‘ç°è¿‡æœŸæ¶æ„ç ´ä¾‹

            æ ¹æ® [ADR-0000.Y ç ´ä¾‹æˆæœ¬ç®¡ç†](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/adr/governance/ADR-0000-architecture-tests.md)ï¼Œä»¥ä¸‹ç ´ä¾‹å·²è¿‡æœŸï¼š

            ${violations.map(v => `- ${v}`).join('\n')}

            ### ğŸ“‹ å¿…é¡»è¡ŒåŠ¨

            1. **å¿è¿˜æŠ€æœ¯å€º**ï¼šä¿®å¤è¿è§„ä»£ç ï¼Œç§»é™¤ç ´ä¾‹
            2. **ç”³è¯·å»¶æœŸ**ï¼šå¦‚æœ‰æŠ€æœ¯éšœç¢ï¼Œæä¾›å»¶æœŸç†ç”±å¹¶é‡æ–°å®¡æ‰¹ï¼ˆæœ€å¤šå»¶æœŸ 2 æ¬¡ï¼‰

            ### ğŸ“š ç›¸å…³èµ„æº

            - [arch-violations.md](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/summaries/arch-violations.md)
            - [ADR-0000ï¼šæ¶æ„æµ‹è¯•ä¸ CI æ²»ç†å®ªæ³•](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/adr/governance/ADR-0000-architecture-tests.md)

            ### â° æˆªæ­¢æ—¶é—´

            - å¿…é¡»åœ¨ 7 å¤©å†…å®Œæˆå¿è¿˜æˆ–å»¶æœŸç”³è¯·
            - å¦åˆ™å°†è§¦å‘å¼ºåˆ¶æ¶æ„å®¡æŸ¥

            ---

            **è‡ªåŠ¨ç”Ÿæˆäº**: ${new Date().toISOString()}
            `;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `[ARCH-VIOLATION] å‘ç° ${violations.length} ä¸ªè¿‡æœŸæ¶æ„ç ´ä¾‹`,
                body: body,
                labels: ['architecture', 'tech-debt', 'urgent']
              });
            }

      - name: Report scan results
        if: always()
        run: |
          echo "::group::æ¶æ„ç ´ä¾‹æ‰«æç»“æœ"
          if [ -f overdue_violations.txt ]; then
            echo "âŒ å‘ç°è¿‡æœŸç ´ä¾‹ï¼Œè¯¦è§ä¸Šæ–¹æ—¥å¿—"
            echo ""
            echo "æ ¹æ® ADR-0000.Yï¼š"
            echo "- è¿‡æœŸç ´ä¾‹å¿…é¡»ç«‹å³å¿è¿˜æˆ–ç”³è¯·å»¶æœŸ"
            echo "- å»¶æœŸéœ€ Tech Lead/æ¶æ„å¸ˆé‡æ–°å®¡æ‰¹"
            echo "- æœ€å¤šå»¶æœŸ 2 æ¬¡"
            echo "- è¶…è¿‡ 2 æ¬¡å¿…é¡»å¼ºåˆ¶å¿è¿˜"
          else
            echo "âœ… æ‰€æœ‰æ¶æ„ç ´ä¾‹å‡åœ¨æœ‰æ•ˆæœŸå†…"
          fi
          echo "::endgroup::"
