# 架构违规记录表（Architecture Violations Registry）

**版本**：2.0  
**最后更新**：2026-01-25  
**治理依据**：ADR-900.Y 破例成本管理

---

## 核心变更（v2.0）

**新增强制字段（ADR-900.Y）**：
- **到期版本号**（vX.Y.Z）：不可使用日期
- **偿还负责人**（@username）：必须具体人员
- **偿还计划**：具体步骤和时间表
- **CI 监控**：自动扫描，过期即失败构建

**目的**：防止技术债累积成坟场

---

## 破例记录模板

| ID | ADR | 规则 | 违规位置 | 原因 | 到期版本 | 负责人 | 偿还计划 | 审批人 | 状态 |
|-----|-----|------|---------|------|---------|--------|---------|--------|------|
| ARCH-XXX | ADR-XXX.Y | 规则描述 | 文件/类 | 技术原因 | vX.Y.Z | @user | 计划 | @reviewer | 状态 |

**状态说明**：
- 🚧 Active：生效中，在到期版本前有效
- ✅ Resolved：已偿还，技术债清零
- ⏰ Overdue：已过期，CI 应失败构建
- 🔄 Extended：已延期（最多 2 次，需重新审批）

---

## CI 自动监控机制（ADR-900.Y）

**扫描频率**：每月第一次构建（建议第 1 天）

**强制逻辑**：
```bash
for violation in active_violations:
    if current_version >= violation.due_version:
        if violation.status == "🚧 Active":
            fail_build("发现过期破例: {violation.id}")
            exit 1
```

**强制行动**：
- 发现过期破例 → **构建失败**
- 必须偿还或申请延期（需重新审批）
- 延期次数不超过 2 次
- 超过 2 次 → 视为技术债失控，必须强制偿还

**延期审批要求**：
1. 提供延期原因（技术障碍、依赖阻塞）
2. 重新评估偿还计划和资源
3. Tech Lead/架构师重新审批
4. 记录延期次数和原因

---

## 当前活跃破例

> 当前系统中的架构破例，尚未归还

| ID | ADR | 规则 | 违规位置 | 原因 | 到期版本 | 负责人 | 偿还计划 | 审批人 | 状态 |
|-----|-----|------|---------|------|---------|--------|---------|--------|------|
| 示例 | ADR-005.3 | 模块间异步 | Members→Orders | 遗留迁移 | v2.1.0 | @dev1 | Q1 事件化 | @arch | 🚧 |

### 示例详细记录（教学用途）

**ID**: ARCH-001  
**违反 ADR**: ADR-005.3（模块间默认异步通信）  
**规则编号**: ADR-005.3

**违规详情**：
```
Members 模块的 CreateOrderHandler 直接注入 Orders 模块的 IPointsQuery，
进行同步查询验证会员积分。
违反"模块间默认异步"原则。
```

**理由**：遗留代码，异步重构成本高，实时验证积分是业务必需

**到期版本**：v2.1.0  
**负责人**：@developer-name  
**审批人**：@architect-name  
**审批日期**：2026-01-15

**偿还计划**：
1. **v2.0**：实现积分本地缓存（Read Model）
2. **v2.0**：通过事件保持缓存同步
3. **v2.1**：替换同步调用为缓存查询
4. **v2.1**：删除直接依赖，完成偿还

**状态**：🚧 Active

**状态更新**：
- 2026-01-15: 破例批准
- 2026-01-20: 缓存设计完成
- 待实施...

---

## 已归还破例

> 已偿还的技术债，历史审计记录

| ID | ADR | 描述 | 批准日期 | 归还日期 | 归还方式 | 归还人 |
|-----|-----|------|---------|---------|----------|--------|
| ARCH-000 | ADR-001 | Members 引用 Orders | 2025-12-01 | 2025-12-15 | 契约移至 Platform | @dev2 |

---

## 延期记录

> 所有延期申请记录（最多 2 次）

| ID | 原到期版本 | 新到期版本 | 延期原因 | 延期次数 | 审批人 | 审批日期 |
|-----|----------|----------|---------|---------|--------|---------|
| - | - | - | - | - | - | - |

---

## 破例审批流程

1. **发现需破例** → 创建临时 Issue
2. **评估替代方案** → 记录评估结果
3. **准备破例申请** → 填写完整模板
4. **获得审批** → Tech Lead/架构师批准
5. **记录此文档** → 立即更新（含到期版本）
6. **代码标注** → 添加 `// ARCH-EXCEPTION: ADR-XXX.Y`
7. **实施缓解** → 降低风险
8. **跟踪偿还** → 定期更新状态
9. **完成偿还** → 移至已归还区
10. **清理标注** → 删除临时标记

---

## 版本历史

| 版本 | 日期 | 变更说明 | 修订人 |
|-----|------|---------|--------|
| 2.0 | 2026-01-25 | 增加到期版本号、CI 监控、延期限制（ADR-900.Y） | GitHub Copilot |
| 1.0 | 2026-01-20 | 初始版本 | GitHub Copilot |

---

**警告**：未记录破例 = 未授权违规。技术债必须偿还，否则系统慢性死亡。

**治理原则**：破例不是逃避，而是债务。所有债务都有利息（CI 成本），必须按时偿还。
