# PR #176 架构问题修复路线图

**创建日期**：2026-01-26  
**当前状态**：验证脚本已修复，待修复实际架构问题

---

## 📋 执行摘要

验证脚本修复后，发现了系统性的架构文档问题：
- **循环依赖**：5个实际循环（涉及~10个ADR）
- **关系不一致**：123个问题（涉及66个ADR）  
- **版本缺失**：42个问题（38个警告 + 4个错误）

**预估总工作量**：15-23小时  
**建议分阶段执行**：分3-4个PR完成

---

## 🎯 阶段1：快速修复（1-2小时）

### 任务1.1：修复ADR-940文档结构

**问题**：ADR-940包含示例模板，导致脚本误识别为自循环

**位置**：`docs/adr/governance/ADR-940-adr-relationship-traceability-management.md`

**修复方案A - 修改文档**（推荐）：
```markdown
# 第48行，将示例模板标题改为：
### 关系声明章节格式示例（非实际关系）

或者在代码块外添加注释：
<!-- 以下为示例，非实际关系声明 -->
```

**修复方案B - 改进脚本**：
修改检测脚本，跳过标记为"示例"的章节。

**预期结果**：消除ADR-940的自循环报告

### 任务1.2：检查并修复ADR-0005自引用

**问题**：检测到ADR-0005自循环，需确认是否为文档错误

**步骤**：
1. 检查ADR-0005关系声明部分
2. 确认是否真的引用自己
3. 如果是误报，分析原因
4. 如果是真实问题，移除自引用

---

## 🔄 阶段2：解决循环依赖（2-4小时）

### 循环2.1：ADR-0001 ↔ ADR-0006

**循环**：
- ADR-0001（核心架构）依赖 ADR-0006（术语宪法）
- ADR-0006（术语宪法）依赖 ADR-0001（术语参考）

**分析**：
- ADR-0001需要术语定义来描述架构
- ADR-0006需要引用核心架构来解释术语

**解决方案**（选择一个）：

**方案A**：改为"相关"关系（推荐）
- 将ADR-0006对ADR-0001的依赖改为"相关"
- 理由：术语宪法并不真正"依赖"核心架构，只是相关

**方案B**：单向依赖
- 只保留ADR-0001依赖ADR-0006
- 移除ADR-0006对ADR-0001的依赖
- 理由：术语是基础，架构基于术语

**方案C**：提取公共术语
- 创建ADR-0006.1：基础术语（无依赖）
- ADR-0001和ADR-0006都依赖ADR-0006.1

### 循环2.2：ADR-0008 ↔ ADR-0900

**循环**：
- ADR-0008（文档宪法）依赖 ADR-0900（ADR流程）
- ADR-0900（ADR流程）依赖 ADR-0008（文档规范）

**解决方案**（推荐）：
- 审查是否为真实依赖
- 可能将一方改为"相关"关系
- 或明确依赖方向：ADR-0900依赖ADR-0008（流程基于规范）

### 循环2.3：ADR-0900 ↔ ADR-980

**循环**：
- ADR-0940依赖ADR-0900
- ADR-0900依赖ADR-980

**解决方案**：
- 审查依赖方向
- 明确是单向还是相关关系

---

## 🔗 阶段3：修复关系一致性（4-8小时）

### 策略：自动化 + 人工审查

#### 步骤3.1：创建自动修复脚本

创建Python脚本自动添加缺失关系：

```python
# 伪代码
def fix_relationships():
    issues = parse_consistency_check()
    
    # 去重
    issues = deduplicate(issues)
    
    # 按ADR分组
    by_adr = group_by_adr(issues)
    
    # 自动添加
    for adr, fixes in by_adr.items():
        add_missing_relationships(adr, fixes)
    
    # 生成审查报告
    generate_review_report()
```

#### 步骤3.2：批量处理

**优先级分组**：

1. **核心层ADR**（7个）- 手工审查
   - ADR-0000 到 ADR-0008
   
2. **治理层ADR**（4个）- 半自动
   - ADR-0900, 0910, 0920, 0930

3. **其他层ADR**（55个）- 自动修复
   - 结构层、运行层、技术层

#### 步骤3.3：验证修复

```bash
# 每批修复后运行
./scripts/check-relationship-consistency.sh

# 检查是否引入新的循环依赖
./scripts/detect-circular-dependencies.sh
```

### 预期结果

- ✅ 所有关系双向一致
- ✅ 无新增循环依赖
- ✅ 验证通过率提升

---

## 📋 阶段4：补充版本号（1-2小时）

### 任务4.1：补充测试文件版本号

**需要修改**：约38个测试文件

**格式**：
```csharp
// Version: X.Y
// ADR: ADR-XXXX
// Last Updated: YYYY-MM-DD
public class ADR_XXXX_Architecture_Tests
{
    // ...
}
```

**版本号规则**：
- 与对应ADR版本号一致
- 如ADR无版本号，使用1.0

### 任务4.2：补充Prompt文件版本号

**需要修改**：约38个Prompt文件

**格式**：
```markdown
**版本**：X.Y  
**对应 ADR**：ADR-XXXX-title
**最后更新**：YYYY-MM-DD
```

### 任务4.3：修复版本不一致

**4个不一致的情况**：
- 手工同步版本号
- 确保ADR、测试、Prompt三者版本号一致

---

## 📊 进度追踪

### 已完成 ✅

- [x] 修复验证脚本（3个）
- [x] 问题分析和分类
- [x] 创建修复路线图

### 待执行

**阶段1**：快速修复
- [ ] 修复ADR-940文档结构
- [ ] 检查ADR-0005自引用

**阶段2**：循环依赖
- [ ] 解决ADR-0001↔0006循环
- [ ] 解决ADR-0008↔0900循环
- [ ] 解决ADR-0900↔980循环

**阶段3**：关系一致性
- [ ] 创建自动修复脚本
- [ ] 修复核心层ADR（7个）
- [ ] 修复治理层ADR（4个）
- [ ] 批量修复其他ADR（55个）
- [ ] 验证修复结果

**阶段4**：版本号
- [ ] 补充测试文件版本号（38个）
- [ ] 补充Prompt文件版本号（38个）
- [ ] 修复版本不一致（4个）

---

## 🎯 成功标准

### 验证通过率目标

| 当前 | 目标 |
|------|------|
| 90% (29/32) | 100% (32/32) |

### 具体检查项

- [ ] ✅ 关系双向一致性检查通过
- [ ] ✅ 循环依赖检测通过
- [ ] ✅ 版本同步验证通过

### 质量标准

- [ ] 无新增架构违规
- [ ] 所有关系有明确理由
- [ ] 版本号规范统一
- [ ] CI全部通过

---

## ⚠️ 风险与注意事项

### 风险1：引入新的循环依赖

**缓解措施**：
- 每次批量修复后运行循环依赖检测
- 人工审查核心ADR的关系修改

### 风险2：修复遗漏或错误

**缓解措施**：
- 分阶段小批量修复
- 每阶段验证测试
- 保持Git提交细粒度，便于回滚

### 风险3：时间投入过大

**缓解措施**：
- 优先完成阶段1（快速见效）
- 阶段2-4可分多个PR
- 考虑自动化工具投入产出比

---

## 📚 相关文档

- [脚本修复总结](./pr176-verification-scripts-fixed.md)
- [ADR-940：关系管理宪法](../adr/governance/ADR-940-adr-relationship-traceability-management.md)
- [ADR-980：生命周期同步](../adr/governance/ADR-980-adr-lifecycle-synchronization.md)

---

## 🔄 更新日志

| 日期 | 版本 | 变更 |
|------|------|------|
| 2026-01-26 | 1.0 | 初始路线图 |

---

**维护**：Copilot Agent  
**状态**：📋 Planning（计划中）  
**下一步**：执行阶段1快速修复
