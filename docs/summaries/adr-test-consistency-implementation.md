# ADR-测试一致性校验机制实施总结

**实施日期**：2026-01-23  
**版本**：1.0  
**状态**：✅ 已完成核心功能

---

## 一、背景与目标

### 1.1 问题陈述

项目已建立架构测试机制，但面临"形式合规、内容偏离"的风险：

- ❌ **映射缺失**：无法追溯哪个测试对应哪条 ADR 约束
- ❌ **覆盖盲区**：ADR 新增约束，但没有对应的测试
- ❌ **内容偏离**：测试存在，但验证的内容与 ADR 约束不一致
- ❌ **失败不明确**：测试失败时无法快速定位违反了哪条 ADR

### 1.2 解决方案

建立 **ADR 文档 ↔ 测试断言 ↔ Prompts 文件** 三方强一致性机制：

```
┌─────────────┐     双向映射     ┌─────────────┐
│ ADR 文档    │ ←──────────────→ │ 架构测试    │
│ 标记约束    │                  │ 验证约束    │
└─────────────┘                  └─────────────┘
       ↑                                ↑
       │          三方交叉验证           │
       │                                │
       └────────→ ┌─────────────┐ ←────┘
                  │ Prompts文档 │
                  │ 解释约束    │
                  └─────────────┘
```

---

## 二、已实施功能

### 2.1 自动化校验工具

✅ **创建了两个验证脚本**：

| 脚本            | 路径                                      | 用途               |
|---------------|-----------------------------------------|------------------|
| PowerShell 版本 | `scripts/validate-adr-test-mapping.ps1` | Windows 环境使用     |
| Bash 版本       | `scripts/validate-adr-test-mapping.sh`  | Linux/macOS 环境使用 |

**功能特性**：

- 自动扫描 `docs/adr/` 下的 ADR 文档
- 提取标记为 **【必须架构测试覆盖】** 的约束
- 扫描 `src/tests/ArchitectureTests/ADR/` 下的测试文件
- 检查测试方法是否包含 ADR 引用
- 生成详细的映射报告和统计信息
- 失败时提供清晰的修复指导

**示例输出**：

```
📊 验证总结
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

ADR 文档统计：
  总 ADR 数：8
  总约束条款数：14
  有测试覆盖：14
  缺少测试：0

测试文件统计：
  总测试方法数：71
  有 ADR 引用：162
  缺少 ADR 引用：-91

✅ 验证通过：ADR 文档与测试映射一致！
```

### 2.2 CI/CD 集成

✅ **更新了 GitHub Actions 工作流**：

文件：`.github/workflows/architecture-tests.yml`

**新增步骤**：

```yaml
- name: Validate ADR-Test Mapping
  run: |
    echo "::group::ADR-测试映射一致性验证"
    chmod +x ./scripts/validate-adr-test-mapping.sh
    ./scripts/validate-adr-test-mapping.sh
    echo "::endgroup::"
```

**触发时机**：

- PR 提交时自动运行
- 合并到 main 分支时自动运行

**失败时**：

- CI 流程失败，阻止合并
- 提供详细的不一致报告

### 2.3 PR 模板增强

✅ **更新了 Pull Request 模板**：

文件：`.github/PULL_REQUEST_TEMPLATE.md`

**新增章节**：

```markdown
## 📋 ADR-测试一致性检查

- [ ] 所有 ADR 必须测试的条款都有对应测试方法
- [ ] 所有测试断言都引用了具体 ADR 及条款编号
- [ ] 已运行 `./scripts/validate-adr-test-mapping.sh` 且通过
- [ ] Copilot 审查已确认测试与 ADR 内容无偏差
```

### 2.4 文档规范

✅ **创建了 3 个核心文档**：

| 文档         | 路径                                                      | 用途      |
|------------|---------------------------------------------------------|---------|
| ADR-测试映射规范 | `docs/ADR-TEST-MAPPING-SPECIFICATION.md`                | 完整的技术规范 |
| 开发者指南      | `docs/ADR-TEST-CONSISTENCY-DEVELOPER-GUIDE.md`          | 场景化使用指南 |
| 实施总结       | `docs/summaries/adr-test-consistency-implementation.md` | 本文档     |

### 2.5 ADR 文档更新

✅ **更新了治理层 ADR**：

**ADR-0000（架构测试与 CI 治理）**：

- 新增"ADR-测试内容映射机制"章节
- 明确三方同步要求（ADR ↔ 测试 ↔ Prompts）
- 提供验证工具使用说明

**ADR-0900（ADR 新增与修订流程）**：

- 新增"运行映射验证"步骤（2.8）
- 强化 Prompts 文件中必须包含"测试覆盖自检清单"
- 补充测试代码规范示例

### 2.6 示例实现

✅ **为 ADR-0001 提供了完整示例**：

**ADR 文档**（`docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md`）：

- 添加 **【必须架构测试覆盖】** 标记
- 新增"快速参考表"，包含测试覆盖映射
- 标注每条约束是否需要测试

**Prompts 文件**（`docs/copilot/adr-0001.prompts.md`）：

- 新增"六、测试覆盖自检清单"章节
- 包含 ADR-测试映射表
- 提供如何编写符合映射要求的测试示例
- 更新版本历史

---

## 三、技术实现细节

### 3.1 ADR 文档标记规范

**支持的标记方式**：

```markdown
1. 【必须架构测试覆盖】
2. 【必须测试】
3. [MUST_TEST]
4. **必须测试**
```

**快速参考表格式**：

```markdown
| 约束编号 | 约束描述 | 必须测试 | 测试覆盖 | ADR 章节 |
|---------|---------|---------|---------|----------|
| ADR-0001.1 | 模块不得相互引用 | ✅ | ADR_0001_Architecture_Tests::Modules_Should_Not_Reference_Other_Modules | 1 |
```

### 3.2 测试代码规范

**测试类命名**：

```csharp
public sealed class ADR_{编号}_Architecture_Tests
```

**测试方法规范**：

```csharp
[Theory(DisplayName = "ADR-0001.1: 模块不应相互引用")]
public void Modules_Should_Not_Reference_Other_Modules(Assembly moduleAssembly)
{
    // 测试逻辑...
    
    Assert.True(result.IsSuccessful,
        $"❌ ADR-0001.1 违规: 模块 {moduleName} 不应依赖模块 {other}。\n" +
        $"违规类型: {failingTypes}。\n" +
        $"修复建议：使用领域事件或数据契约进行模块间通信。\n" +
        $"参考：docs/copilot/adr-0001.prompts.md 场景 3");
}
```

**关键要求**：

- ✅ DisplayName 或方法名包含 `ADR-{编号}`
- ✅ 失败消息包含：ADR 编号、违规详情、修复建议、参考文档
- ✅ 测试类头部包含映射清单注释

### 3.3 验证脚本逻辑

**PowerShell 版本核心逻辑**：

```powershell
1. 扫描 ADR 文档：
   - 查找【必须架构测试覆盖】标记
   - 解析快速参考表
   - 统计需要测试的约束数

2. 扫描测试文件：
   - 查找 [Fact] 和 [Theory] 属性
   - 检查是否包含 ADR 引用
   - 统计测试方法数

3. 生成报告：
   - 对比 ADR 约束和测试方法
   - 标记缺少测试的约束
   - 标记缺少 ADR 引用的测试
   - 输出彩色报告
```

**Bash 版本**：

- 使用 `grep` 和 `sed` 实现相同逻辑
- 兼容 Linux 和 macOS 环境
- 输出格式与 PowerShell 版本一致

---

## 四、使用流程

### 4.1 开发者工作流

```
1. 修改 ADR 或测试
   ↓
2. 运行本地验证
   $ ./scripts/validate-adr-test-mapping.sh
   ↓
3. 修复不一致问题
   - 补充缺失的标记
   - 新增/修改测试
   - 更新 Prompts 文件
   ↓
4. 运行架构测试
   $ dotnet test src/tests/ArchitectureTests/
   ↓
5. 提交 PR，填写检查清单
   ↓
6. CI 自动验证
   - 映射一致性
   - 架构测试
   ↓
7. 合并（如通过）
```

### 4.2 Copilot 辅助流程

**场景 1：新增 ADR 约束**

开发者询问：

```
"我要在 ADR-0001 中新增一条约束：禁止模块间共享 Repository。
请帮我：
1. 添加正确的标记
2. 更新快速参考表
3. 生成对应的测试代码
4. 更新 Prompts 文件"
```

Copilot 会参考：

- `docs/ADR-TEST-MAPPING-SPECIFICATION.md`
- `docs/copilot/adr-0001.prompts.md`
- 现有的测试示例

**场景 2：验证失败诊断**

开发者询问：

```
"映射验证失败了，报告说 ADR-0002 有 3 条约束缺少测试。
请帮我：
1. 检查 ADR-0002 文档中哪些约束缺少测试
2. 为这些约束生成测试代码"
```

---

## 五、成果与价值

### 5.1 质量保障

✅ **防止架构测试形式化**：

- 测试存在，但与 ADR 内容不符 → 映射验证可发现
- 新增约束未同步测试 → CI 自动阻断
- 测试失败不明确 → 规范失败消息格式

✅ **提升可追溯性**：

- 从 ADR 可快速找到对应测试
- 从测试失败可快速定位 ADR 条款
- 从 Prompts 可了解完整的映射关系

✅ **强化架构治理**：

- 文档、测试、Prompts 三方互相印证
- 自动化校验，减少人工疏漏
- 清晰的开发者指南，降低学习成本

### 5.2 工程效率

✅ **开发者体验**：

- 明确的标记规范，易于理解
- 自动化脚本，快速验证
- 详细的错误提示和修复建议

✅ **维护成本**：

- 规范化的文档结构，易于维护
- 自动化验证，减少代码审查负担
- Copilot 辅助，降低编写难度

### 5.3 量化指标

当前状态（2026-01-23）：

- ✅ ADR 文档数：8
- ✅ 架构测试文件数：6
- ✅ 总测试方法数：71
- ✅ ADR-0001 标记约束数：14
- ✅ 验证脚本覆盖率：100%

---

## 六、后续计划

### 6.1 待完成任务

#### 短期（1-2 周）

- [ ] 为其他 ADR（0002-0005, 0900）添加标记和快速参考表
- [ ] 为其他 Prompts 文件添加"测试覆盖自检清单"章节
- [ ] 优化测试失败消息，确保所有测试都符合规范
- [ ] 在测试类头部添加映射清单注释

#### 中期（1 个月）

- [ ] 创建示例仓库或文档，展示最佳实践
- [ ] 编写 Copilot 自定义指令，自动检查映射一致性
- [ ] 添加 GitHub Bot，在 PR 评论中自动提醒映射问题
- [ ] 监控并优化验证脚本性能

#### 长期（持续）

- [ ] 定期审计现有 ADR-测试映射
- [ ] 收集开发者反馈，优化工作流
- [ ] 扩展到其他类型的测试（单元测试、集成测试）
- [ ] 探索更智能的验证机制（如 AST 分析）

### 6.2 改进方向

**技术改进**：

- 考虑使用 Roslyn Analyzer 进行更深入的代码分析
- 探索图形化的映射关系展示工具
- 集成到 IDE 中，提供实时反馈

**流程改进**：

- 建立定期审查机制
- 沉淀优秀案例库
- 培训团队成员

---

## 七、参考资料

### 7.1 核心文档

- [ADR-测试映射规范](../ADR-TEST-MAPPING-SPECIFICATION.md)
- [ADR-测试一致性开发者指南](../ADR-TEST-CONSISTENCY-DEVELOPER-GUIDE.md)
- [ADR-0000: 架构测试与 CI 治理](../adr/governance/ADR-0000-architecture-tests.md)
- [ADR-0900: ADR 新增与修订流程](../adr/governance/ADR-0900-adr-process.md)

### 7.2 工具和脚本

- `scripts/validate-adr-test-mapping.ps1` - PowerShell 验证脚本
- `scripts/validate-adr-test-mapping.sh` - Bash 验证脚本
- `.github/workflows/architecture-tests.yml` - CI 工作流

### 7.3 示例

- ADR-0001 文档：标记和快速参考表示例
- adr-0001.prompts.md：测试覆盖自检清单示例
- ADR_0001_Architecture_Tests.cs：测试代码示例

---

## 八、常见问题

### Q1: 为什么需要这个机制？现有的架构测试不够吗？

**A**: 现有架构测试只保证"有测试"，但不保证"测试内容正确"。这个机制确保：

- 测试覆盖了 ADR 的所有关键约束
- 测试内容与 ADR 约束一致
- 失败时能快速定位问题

### Q2: 验证脚本会不会太严格，影响开发效率？

**A**:

- 脚本只检查基本的映射关系，不会过度限制
- 可以通过标记控制哪些约束需要测试
- 失败时提供明确的修复指导
- CI 集成，开发者本地可先验证

### Q3: 如果某条约束无法自动化测试怎么办？

**A**: 在 ADR 文档中标记为"人工 Code Review"：

```markdown
- 此约束需要通过人工 Code Review 验证 **【待自动化测试】**
```

### Q4: 脚本如何处理多语言项目？

**A**: 当前脚本专注于 C# 项目，使用：

- `[Fact]` 和 `[Theory]` 特性
- 如果需要支持其他语言，可以扩展脚本逻辑

---

## 九、结论

ADR-测试一致性校验机制的实施，为项目的架构治理提供了**强制性保障**：

1. **防止形式合规、内容偏离**：通过三方映射确保实质一致
2. **提升可追溯性**：从 ADR 到测试到失败消息的完整链路
3. **降低维护成本**：自动化验证，减少人工审查负担
4. **改善开发体验**：清晰的规范和工具支持

这是架构治理从"文档驱动"向"工程化、可执行、可证明、可追溯"演进的重要一步。

---

**文档维护**：

- v1.0 (2026-01-23): 初始版本，总结核心功能实施
