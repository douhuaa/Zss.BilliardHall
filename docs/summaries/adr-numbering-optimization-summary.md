# ADR 分层治理与编号命名优化实施总结

**实施日期**：2026-01-22  
**版本**：1.0  
**状态**：✅ 已完成

---

## 一、背景与动机

### 1.1 现状问题

在优化前，项目已建立了宪法层（ADR-0000~0005）架构治理体系，但存在以下问题：

1. **编号体系不清晰**：所有 ADR 采用连续编号（0000, 0001, ...），无法从编号直观判断层级和性质
2. **文件组织扁平化**：所有 ADR 文件位于同一目录，随着 ADR 数量增长难以管理
3. **认知负担**：新成员需要阅读文档才能理解 ADR 的层级关系
4. **扩展性不足**：未来新增 ADR 无明确的编号规划

### 1.2 优化目标

1. **认知一致性增强**：编号即层级，一眼识别 ADR 性质
2. **快速定位能力**：通过目录结构和编号段快速找到相关 ADR
3. **防腐能力提升**：清晰的分层为版本演进、迁移、废弃提供结构化支持
4. **演进空间充足**：每个层级预留足够的编号空间

---

## 二、解决方案设计

### 2.1 编号分段体系

| 层级      | 编号范围                | 目录                | 说明            | 当前状态     |
|---------|---------------------|-------------------|---------------|----------|
| **宪法层** | `ADR-0001~0009`     | `constitutional/` | 系统根基/不可推翻约束   | ✅ 5个 ADR |
| **结构层** | `ADR-100~199`       | `structure/`      | 模块静态边界/组织细化   | 🔜 未来扩展  |
| **运行层** | `ADR-200~299`       | `runtime/`        | 运行/交互/协议/事件   | 🔜 未来扩展  |
| **技术层** | `ADR-300~399`       | `technical/`      | 技术选型/具体落地     | 🔜 未来扩展  |
| **治理层** | `ADR-0000, 900~999` | `governance/`     | 治理/破例/流程/变更管理 | ✅ 2个 ADR |

**特殊编号处理**：

- `ADR-0000`：架构测试元规则，保持原编号（治理层核心，特殊地位）
- `ADR-900`：ADR 流程管理（原 ADR-0000A，重新编号）

### 2.2 目录层级结构

```
docs/adr/
├── README.md                          # 主索引，包含编号段映射表
├── constitutional/                    # 宪法层 ADR
│   ├── README.md
│   ├── ADR-0001-modular-monolith-vertical-slice-architecture.md
│   ├── ADR-0002-platform-application-host-bootstrap.md
│   ├── ADR-0003-namespace-rules.md
│   ├── ADR-0004-Cpm-Final.md
│   ├── ADR-0005-Application-Interaction-Model-Final.md
│   ├── ADR-905-enforcement-level-classification.md
│   └── ARCHITECTURE-CONSTITUTIONAL-LAYER.md
├── governance/                        # 治理层 ADR
│   ├── README.md
│   ├── ADR-0000-architecture-tests.md
│   └── ADR-900-adr-process.md
├── structure/                         # 结构层（未来扩展）
│   └── README.md
├── runtime/                           # 运行层（未来扩展）
│   └── README.md
└── technical/                         # 技术层（未来扩展）
    └── README.md
```

---

## 三、实施过程

### 3.1 实施步骤

#### 阶段 1：规划与设计（已完成）

- ✅ 分析现有 ADR 结构
- ✅ 确认编号分段规则
- ✅ 设计目录层级结构

#### 阶段 2：创建新目录结构（已完成）

- ✅ 创建 5 个层级目录
- ✅ 为每个目录编写详细的 README.md
- ✅ 说明每个层级的定位、编号规则、未来规划

#### 阶段 3：文件迁移与重命名（已完成）

- ✅ 使用 `git mv` 迁移文件（保留 Git 历史）
- ✅ ADR-0000A 重新编号为 ADR-900
- ✅ 所有宪法层 ADR 迁移到 `constitutional/`
- ✅ 所有治理层 ADR 迁移到 `governance/`

#### 阶段 4：更新文档引用（已完成）

- ✅ 更新主 README.md
  - 添加编号分段映射表
  - 更新可视化图表
  - 更新快速导航
  - 新增 FAQ（为什么分段、ADR-0000 为何不调整等）
  - 更新版本历史
- ✅ 更新 ADR-900 文档内容
- ✅ 更新所有 Copilot prompts 文件
- ✅ 更新其他文档（architecture-guide.md, ci-cd-guide.md 等）

#### 阶段 5：更新架构测试（已完成）

- ✅ 修改 ADR_0000_Architecture_Tests.cs
  - 支持递归搜索子目录中的 ADR 文件
  - 添加 ADR-900 到免测试白名单（流程 ADR 无需架构测试）
- ✅ 运行测试验证：**81/81 全部通过**

#### 阶段 6：文档完善（已完成）

- ✅ 所有链接已验证
- ✅ 所有路径已更新

#### 阶段 7：验证与测试（已完成）

- ✅ 架构测试通过
- ✅ 文档链接正确
- ✅ Copilot prompts 同步

### 3.2 技术细节

#### 文件迁移命令

```bash
# 使用 git mv 保留历史
git mv docs/adr/ADR-0001-*.md docs/adr/constitutional/
git mv docs/adr/ADR-0000A-adr-process.md docs/adr/governance/ADR-900-adr-process.md
```

#### 批量更新引用

```bash
# 更新所有 copilot prompts 中的路径
for file in docs/copilot/adr-*.prompts.md; do
  sed -i 's|../adr/ADR-0001-|../adr/constitutional/ADR-0001-|g' "$file"
  sed -i 's|../adr/ADR-0000-|../adr/governance/ADR-0000-|g' "$file"
  # ... 更多替换
done
```

#### 架构测试更新

```csharp
// 支持递归搜索
Directory.GetFiles(adrDirectory, AdrFilePattern, SearchOption.AllDirectories)

// 添加白名单
private static readonly HashSet<string> AdrWithoutTests = new(StringComparer.OrdinalIgnoreCase)
{
    "ADR-900-adr-process"  // 流程规范，无需架构测试
};
```

---

## 四、成果与价值

### 4.1 直接成果

| 指标       | 优化前    | 优化后          | 提升    |
|----------|--------|--------------|-------|
| ADR 目录结构 | 扁平（1层） | 分层（2层）       | +100% |
| 编号体系清晰度  | 无分段    | 5个层级分段       | 质的提升  |
| 未来扩展空间   | 不明确    | 400+ 编号预留    | 充足    |
| 文档链接正确性  | -      | 100%         | 完整验证  |
| 架构测试通过率  | -      | 100% (81/81) | 全部通过  |

### 4.2 业务价值

#### 1. 认知清晰度提升

- **快速识别**：通过编号段一眼看出 ADR 层级（宪法/治理/结构/运行/技术）
- **降低学习成本**：新成员无需阅读大量文档即可理解架构体系
- **一致性增强**：所有人对 ADR 层级有统一认知

#### 2. 维护效率提升

- **快速定位**：根据编号段和目录结构快速找到相关 ADR
- **分类管理**：不同层级的 ADR 分开管理，职责清晰
- **批量操作**：可按目录批量处理某一层级的 ADR

#### 3. 演进支持增强

- **充足空间**：每个层级100个编号，支持长期演进
- **结构化迁移**：废弃/替换 ADR 时有明确的层级归属
- **版本控制**：通过目录和编号段实现版本化管理

#### 4. 治理能力提升

- **自动化友好**：工具可通过编号段识别 ADR 类型
- **报告生成**：按层级生成架构健康度报告
- **违规追踪**：破例记录可精确到层级和编号段

### 4.3 长期影响

1. **为未来自动化打基础**
  - 编号分段体系便于工具自动分类和分析
  - 目录结构支持脚本批量处理
  - 架构可视化工具可利用层级信息

2. **为知识图谱准备**
  - 清晰的层级关系便于构建 ADR 知识图谱
  - 编号段可作为图谱节点的分类标签
  - 便于 AI 工具理解和推荐相关 ADR

3. **为审计和合规服务**
  - 外部审计人员可快速理解架构体系
  - 合规检查可按层级展开
  - 架构演进历史清晰可追溯

---

## 五、经验教训

### 5.1 成功经验

1. **使用 git mv 保留历史**
  - 文件迁移保留完整的 Git 历史
  - 便于追溯文档演变过程

2. **批量操作自动化**
  - 使用 sed、bash 循环批量更新引用
  - 减少手动修改错误

3. **架构测试先行**
  - 先验证架构测试支持新结构
  - 确保变更不破坏现有约束

4. **分阶段实施**
  - 逐步推进，每个阶段验证
  - 降低风险，便于回滚

### 5.2 注意事项

1. **特殊编号处理**
  - ADR-0000 保持原编号（特殊地位）
  - ADR-900 豁免架构测试（流程 ADR）

2. **链接更新全面性**
  - 不仅更新 ADR 文档本身
  - 还需更新 copilot prompts、测试、其他文档

3. **向后兼容性**
  - 架构测试需适配新结构
  - 所有工具脚本需验证兼容性

---

## 六、后续计划

### 6.1 短期（1个月内）

- [ ] 创建自动化脚本验证文档链接完整性
- [ ] 编写 ADR 编号分配指南
- [ ] 培训团队成员使用新编号体系

### 6.2 中期（3个月内）

- [ ] 根据实际需要新增结构层/运行层/技术层 ADR
- [ ] 建立 ADR 健康度监控看板
- [ ] 优化 Copilot prompts 适配新结构

### 6.3 长期（6个月+）

- [ ] 开发架构可视化工具利用层级信息
- [ ] 构建 ADR 知识图谱
- [ ] 引入 AI 工具推荐相关 ADR

---

## 七、参考资料

### 7.1 相关文档

- [ADR 主索引](../adr/README.md)
- [ADR-900：ADR 新增与修订流程](../adr/governance/ADR-900-adr-process.md)
- [宪法层说明](../adr/constitutional/ARCHITECTURE-CONSTITUTIONAL-LAYER.md)

### 7.2 实施提交

- 初始化计划：commit 78ab201
- 目录结构创建：commit 6f4dd2f
- 架构测试更新：commit 7be7d8e

---

## 八、总结

本次 ADR 分层治理与编号命名优化是一次**系统性、前瞻性**的架构治理能力提升：

1. ✅ **编号体系清晰化**：5个层级分段，400+编号预留
2. ✅ **目录结构层级化**：分层管理，职责清晰
3. ✅ **文档引用一致化**：所有链接同步更新
4. ✅ **架构测试适配化**：81/81全部通过
5. ✅ **向后兼容保障化**：工具、测试、文档全面验证

这不仅解决了当前的认知和管理问题，更为未来的架构演进、自动化治理、知识图谱构建打下了坚实基础。

**关键价值**：**认知清晰 → 维护高效 → 演进有序 → 治理可控**

---

**文档版本**：1.0  
**最后更新**：2026-01-22  
**维护者**：架构团队
