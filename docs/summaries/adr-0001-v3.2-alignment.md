# ADR-0001 v3.2 对齐总结

**日期**：2026-01-23  
**任务**：对齐 ADR-0001 测试和 Prompts 到 v3.2 版本  
**状态**：✅ 已完成

---

## 一、背景

ADR-0001 已更新至 v3.2 版本，引入了简化的约束映射体系。原有的测试文件和 Prompts 文件需要与新版本对齐。

### 主要变更

1. **约束简化**：从多个分散的约束整合为 7 项核心约束
2. **执行级别分类**：引入 L1/L2/L3 执行级别标注
3. **测试映射标准化**：明确每个约束对应的测试方法

---

## 二、v3.2 约束映射

| 约束编号 | 描述 | 层级 | 测试方法 | 章节 |
|---------|------------------------------|-----|----------------------|------|
| ADR-0001.1 | 模块不可相互引用 | L1 | Modules_Should_Not_Reference_Other_Modules | 决策与约束-模块定义与隔离 |
| ADR-0001.2 | 项目文件/程序集禁止引用其他模块 | L1 | Module_Csproj_Should_Not_Reference_Other_Modules | 决策与约束-模块定义与隔离 |
| ADR-0001.3 | 垂直切片/用例为最小单元 | L2 | Handlers_Should_Be_In_UseCases_Namespace | 决策与约束-垂直切片落地标准 |
| ADR-0001.4 | 禁止横向 Service 抽象 | L1 | Modules_Should_Not_Contain_Service_Classes | 决策与约束-垂直切片落地标准 |
| ADR-0001.5 | 只允许事件/契约/原始类型通信 | L2 | Contract_Rules_Semantic_Check | 决策与约束-通信与契约边界 |
| ADR-0001.6 | Contract 不含业务判断字段 | L2/L3 | Contract_Business_Field_Analyzer | 决策与约束-通信与契约边界 |
| ADR-0001.7 | 命名空间/目录强制隔离 | L1 | Namespace_Should_Match_Module_Boundaries | 决策与约束-模块定义与隔离 |

**执行级别说明**：
- **L1**: 静态可执行自动化（ArchitectureTests），CI 必须阻断
- **L2**: 语义半自动（Roslyn/启发式），需人工评审配合
- **L3**: 人工 Gate，code review 把关

---

## 三、已完成的对齐工作

### 3.1 测试文件更新

**文件**：`src/tests/ArchitectureTests/ADR/ADR_0001_Architecture_Tests.cs`

**更新内容**：

1. **类头部注释**：
   - 更新为 v3.2 版本标注
   - 添加完整的约束映射说明
   - 明确 7 项核心约束与测试方法的对应关系

2. **测试方法 DisplayName 标注**：
   - 保留了所有 11 个现有测试（向后兼容）
   - 为旧编号的测试添加 "(旧) / v3.2需对齐" 标记
   - 为已对齐的测试添加 "(v3.2对齐)" 标记

3. **当前状态**：
   - ✅ ADR-0001.1: 已对齐（Modules_Should_Not_Reference_Other_Modules）
   - ✅ ADR-0001.2: 已对齐（Module_Csproj_Should_Not_Reference_Other_Modules）
   - 🔄 ADR-0001.3: 需实现（Handlers_Should_Be_In_UseCases_Namespace）
   - ✅ ADR-0001.4: 已对齐（当前测试 #4 对应）
   - 🔄 ADR-0001.5: 需实现（Contract_Rules_Semantic_Check）
   - 🔄 ADR-0001.6: 需实现（Contract_Business_Field_Analyzer）
   - 🔄 ADR-0001.7: 需实现（Namespace_Should_Match_Module_Boundaries）

### 3.2 Prompts 文件更新

**文件**：`docs/copilot/adr-0001.prompts.md`

**更新内容**：

1. **版本信息**：
   - 版本号：1.2 → 1.3
   - 新增"对应 ADR 版本：v3.2"字段

2. **测试映射表（7.1 节）**：
   - 更新为 v3.2 的 7 项约束映射
   - 添加"层级"列，标注 L1/L2/L3 执行级别
   - 更新"状态"列，明确哪些已覆盖、哪些需实现

3. **v3.2 对齐说明**：
   - 添加对齐说明文字
   - 解释为何测试文件仍有 11 个测试（向后兼容）
   - 列出需要实现或重命名的测试方法

4. **版本历史**：
   - 记录 v1.3 版本的对齐工作

---

## 四、待完成工作

### 4.1 测试方法重构（高优先级）

以下测试方法需要创建或重命名以完全对齐 v3.2：

1. **ADR-0001.3**: 创建 `Handlers_Should_Be_In_UseCases_Namespace` 测试
   - 验证 Handler 必须在 UseCases 命名空间下
   - 执行级别：L2（语义半自动）

2. **ADR-0001.5**: 创建 `Contract_Rules_Semantic_Check` 测试
   - 验证只允许事件/契约/原始类型通信
   - 执行级别：L2（语义半自动）

3. **ADR-0001.6**: 创建 `Contract_Business_Field_Analyzer` 测试
   - 验证 Contract 不含业务判断字段
   - 执行级别：L2/L3（语义半自动/人工 Gate）

4. **ADR-0001.7**: 创建 `Namespace_Should_Match_Module_Boundaries` 测试
   - 验证命名空间/目录强制隔离
   - 执行级别：L1（静态可执行自动化）

### 4.2 旧测试处理

现有的 11 个测试（ADR-0001.1 至 ADR-0001.11）需要评估：

- **保留**：仍然有价值且不与新约束冲突的测试
- **合并**：可以合并到新的 7 项约束中的测试
- **重命名**：调整为支持性测试（如 ADR-0001.4-support）
- **废弃**：不再需要的测试（标记为 Obsolete）

### 4.3 文档补充

1. 在 `docs/copilot/adr-0001.prompts.md` 中补充新测试方法的示例代码
2. 更新 CI 说明，解释 L1/L2/L3 级别的不同处理方式
3. 添加测试重构指南文档

---

## 五、对齐策略说明

### 5.1 为何保留旧测试？

1. **向后兼容**：避免破坏现有 CI 流程
2. **渐进式迁移**：允许团队逐步适应新的约束体系
3. **测试覆盖**：某些旧测试可能仍在验证有价值的约束

### 5.2 迁移路径

```
阶段 1（当前）：标注对齐 ✅
├─ 更新文档和注释
├─ 标记测试的对齐状态
└─ 不破坏现有功能

阶段 2（下一步）：创建新测试 🔄
├─ 实现 ADR-0001.3、5、6、7 对应的测试
├─ 验证测试通过
└─ 文档化新测试

阶段 3（后续）：清理旧测试 ⏳
├─ 评估旧测试价值
├─ 合并或废弃冗余测试
└─ 完全对齐 v3.2
```

---

## 六、影响分析

### 6.1 对开发者的影响

- **正面**：更清晰的约束映射，易于理解和遵循
- **正面**：执行级别分类明确，知道哪些是硬约束
- **中性**：需要学习新的约束编号体系
- **中性**：现有代码不受影响（向后兼容）

### 6.2 对 CI/CD 的影响

- **无影响**：现有测试继续运行
- **增强**：未来新增的 L1 测试会增强 CI 阻断能力
- **优化**：L2/L3 测试可以配置为警告而非阻断

### 6.3 对架构治理的影响

- **正面**：更系统化的约束管理
- **正面**：明确的执行级别有助于分级治理
- **正面**：为未来 Roslyn Analyzer 开发提供清晰目标

---

## 七、参考资料

1. **ADR-0001 v3.2 文档**：
   - 路径：`docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md`
   - 章节：快速参考和架构测试映射

2. **Copilot Prompts v1.3**：
   - 路径：`docs/copilot/adr-0001.prompts.md`
   - 章节：七、测试覆盖自检清单

3. **测试文件**：
   - 路径：`src/tests/ArchitectureTests/ADR/ADR_0001_Architecture_Tests.cs`

4. **ADR-0005 执行级别分类**：
   - 路径：`docs/adr/constitutional/ADR-0005-Enforcement-Levels.md`

---

## 八、总结

✅ **已完成**：
- ADR-0001 测试文件头部更新（v3.2 标注）
- 测试方法 DisplayName 标注（对齐状态标记）
- Prompts 文件测试映射表更新（v3.2 约束）
- Prompts 文件版本信息更新（v1.3）
- 对齐说明和版本历史更新

🔄 **进行中**：
- 创建 ADR-0001.3、5、6、7 对应的新测试方法
- 评估和清理旧测试

📋 **待规划**：
- 完整的测试重构方案
- L2/L3 级别测试的 CI 配置策略
- Roslyn Analyzer 开发计划

---

**提交哈希**：待提交  
**相关 PR**：copilot/add-authoritative-declaration
