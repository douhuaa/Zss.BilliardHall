# PR 语言问题修复总结

## 问题回顾

**原始问题**：
- PR #266 在 Copilot 完成任务时，PR 描述变成了英文
- PR #265 中尝试通过修改 `.github/copilot-instructions.md` 来强制使用中文，但没有成功

**用户疑问**：
- 为什么在 `copilot-instructions.md` 中添加了详细的中文语言规则，但仍然没有生效？

## 根本原因

经过深入分析和验证，发现了以下关键问题：

### 1. 配置文件的作用域误解 ❌
**之前的错误理解**：
- 认为 `.github/copilot-instructions.md` 是主 Copilot Agent 的配置文件
- 认为在这个文件中添加语言要求就能约束主 Agent 的行为

**实际情况** ✅：
- GitHub Copilot **确实会**读取 `.github/copilot-instructions.md`
- 这个文件的内容会被注入到系统的 `<custom_instruction>` 中
- **但是**存在以下限制：
  1. 配置可能被缓存，不是实时更新
  2. PR 描述生成可能使用独立的流程
  3. 文件太长时，关键规则可能被截断或忽略
  4. 在某些执行阶段，系统默认配置优先级更高

### 2. PR 描述生成的特殊性
- PR 的标题和描述生成可能是一个独立的系统流程
- 这个流程可能在任务完成的最后阶段触发
- 此时 Agent 的注意力可能已经从 custom_instruction 转移到系统默认行为

### 3. 上下文长度和优先级问题
- 原 `copilot-instructions.md` 有 242 行，修复后增加到 277 行
- 语言要求原本在文件的第 5-20 行（不够显眼）
- 修复后：关键规则移到第 1 行（开头）和最后 30 行（末尾）
- 即使上下文被截断，开头和末尾的规则更容易被保留

## 实施的解决方案

我们采用了**多层级防护**策略：

### 第一层：文件开头的强制声明

```markdown
# 🔴 强制要求：必须使用中文

> **本规则优先级：最高 | 覆盖所有其他配置 | 不可豁免**

**所有 Copilot Agent 输出必须使用中文**：
- PR 标题、PR 描述、PR 评论
- 任务回复、进度报告、错误信息
...
```

**为什么有效**：
- 在文件的第 1 行，最先被读取
- 使用醒目的 🔴 标记和强调语气
- 声明"最高优先级"和"覆盖所有其他配置"

### 第二层：文件末尾的检查清单

```markdown
# ⚠️ 任务完成前最终检查清单

在提交任何输出、完成任何任务、更新任何 PR 之前，**必须**验证以下各项：

- [ ] ✅ **PR 标题使用中文**
- [ ] ✅ **PR 描述使用中文**
- [ ] ✅ **所有回复使用中文**
...
```

**为什么有效**：
- 在文件末尾，是 Agent 完成任务前最后读到的内容
- 使用检查清单格式，符合 Agent 的行为模式
- 明确指出"任务完成时"是最容易被忽略的时刻

### 第三层：PR 模板的人工提醒

```markdown
<!-- 
⚠️ 重要提醒：语言要求
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
本仓库要求所有 PR 标题和描述必须使用中文。
...
-->
```

**为什么有效**：
- 作为最后一道人工检查防线
- 即使 Copilot 忽略了规则，人工审查时也会发现
- 提供明确的修正指导

## 技术原理

### 为什么要在开头和末尾都强调？

**开头强调**：
- 确保规则在 Agent 初始化时就被加载
- 建立整个任务的"基调"
- 避免被其他配置覆盖

**末尾强调**：
- 在任务接近完成时再次提醒
- 使用检查清单格式，触发 Agent 的验证行为
- 对抗"任务完成时切换为默认行为"的倾向

### 为什么使用检查清单格式？

研究表明，LLM 对结构化的任务列表响应更好：
- `- [ ]` 格式会触发 Agent 的"验证"模式
- 明确的是/否判断比模糊的"应该"更有效
- 清单提供了具体的行动步骤

## 如何验证修复效果

### 测试场景

在下一个由 Copilot 创建的 PR 中，检查：

1. **PR 标题** - 是否使用中文？
2. **PR 描述** - 是否全部使用中文？
3. **任务过程中的回复** - 是否使用中文？
4. **任务完成时的最终回复** - 是否使用中文？
5. **进度报告** - 是否使用中文？

### 成功标准

- ✅ 所有上述项目都使用中文
- ✅ 没有出现英文段落或句子
- ✅ 技术术语可以保留（如 "PR"、"CI"、"ADR"），但周围的描述性文字必须是中文

### 如果问题仍然存在

如果在实施这些修复后问题仍然存在，考虑以下进一步措施：

**方案 A：添加 CI 自动检查**
```yaml
# .github/workflows/pr-language-check.yml
name: PR Language Check
on: [pull_request]
jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check Chinese
        run: |
          if ! echo "${{ github.event.pull_request.title }}" | grep -P '[\p{Han}]'; then
            echo "❌ PR 标题必须包含中文"
            exit 1
          fi
```

**方案 B：简化 custom_instruction**
- 将详细的 Agent 配置移到单独的文件
- 保留核心规则在 `copilot-instructions.md`
- 减少文件长度到 100 行以内

**方案 C：向 GitHub 反馈**
- 这可能是 GitHub Copilot 的一个设计问题
- custom_instruction 在 PR 描述生成阶段的优先级需要提高
- 可以通过 GitHub 的反馈渠道报告这个问题

## 关键洞察

### 1. Custom Instruction 不是万能的

虽然 GitHub 支持 `.github/copilot-instructions.md`，但它：
- 不能保证在所有执行阶段都生效
- 可能被系统默认行为覆盖
- 需要通过格式、位置、重复来强化

### 2. 防御性配置设计

在配置 LLM-based agents 时，应该：
- **开头 + 末尾**：在关键位置重复规则
- **多层防护**：不依赖单一机制
- **结构化格式**：使用清单、标记、分隔符
- **人工兜底**：关键规则要有人工检查机制

### 3. PR 描述生成需要特殊对待

PR 描述的生成可能是一个特殊的执行阶段：
- 可能使用不同的模板或上下文
- 可能在任务"完成"后才触发
- 需要特别的提醒和检查机制

## 相关文件

- **分析文档**：`docs/fixes/pr-language-root-cause-analysis.md`
- **配置文件**：`.github/copilot-instructions.md`
- **PR 模板**：`.github/PULL_REQUEST_TEMPLATE.md`
- **之前的修复尝试**：PR #265
- **问题示例**：PR #266

## 致谢

感谢提出这个问题。通过深入分析，我们不仅修复了这个具体问题，还获得了关于如何有效配置 LLM-based agents 的宝贵洞察。

## 更新日志

- 2026-02-04：初始版本，实施多层级防护方案
