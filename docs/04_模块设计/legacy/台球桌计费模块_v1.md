---
title: "å°çƒæ¡Œè®¡è´¹æ¨¡å—"
description: "è‡ªåŠ©å°çƒç³»ç»Ÿå°çƒæ¡Œè®¡è´¹æ¨¡å—è¯¦ç»†è®¾è®¡è¯´æ˜"
version: "2.0.0"
author: "ä¸šåŠ¡æ¶æ„å¸ˆ"
maintainer: "åç«¯å¼€å‘å›¢é˜Ÿ"
created: "2024-01-01"
updated: "2024-01-15"
category: "æ¨¡å—è®¾è®¡"
level: "æ ¸å¿ƒ"
audience: ["åç«¯å¼€å‘å·¥ç¨‹å¸ˆ", "ä¸šåŠ¡åˆ†æå¸ˆ"]
keywords: ["è®¡è´¹æ¨¡å—", "å°çƒæ¡Œç®¡ç†", "è®¡æ—¶ç®—æ³•", "ä»·æ ¼ç­–ç•¥", "Wolverine", "å‚ç›´åˆ‡ç‰‡"]
tags: ["billing", "table", "pricing", "timing", "vertical-slice"]
dependencies: ["è®¾å¤‡ç®¡ç†", "ä¼šå‘˜ç®¡ç†"]
estimated_reading_time: "18åˆ†é’Ÿ"
architecture_status: "æ¶æ„å®ç°å·²æ›´æ–°è‡³ Wolverine"
---

# 4.2 å°çƒæ¡Œè®¡è´¹æ¨¡å—ï¼ˆSessions + Billingï¼‰

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“¦ æ¨¡å—è®¾è®¡](README.md) > ğŸ’° å°çƒæ¡Œè®¡è´¹æ¨¡å—

<!-- Keywords for Search -->
**å…³é”®è¯**: `è®¡è´¹æ¨¡å—` `å°çƒæ¡Œç®¡ç†` `è®¡æ—¶ç®—æ³•` `ä»·æ ¼ç­–ç•¥` `Wolverine` `å‚ç›´åˆ‡ç‰‡`

---

> ## âš ï¸ æ¶æ„å®ç°è¯´æ˜
> 
> æœ¬æ–‡æ¡£æè¿°å°çƒæ¡Œè®¡è´¹æ¨¡å—çš„**ä¸šåŠ¡éœ€æ±‚å’ŒåŠŸèƒ½è¯´æ˜**ã€‚
> 
> **æ¶æ„å®ç°å·²è¿ç§»è‡³ Wolverine + å‚ç›´åˆ‡ç‰‡æ¶æ„**ï¼Œå¹¶æ‹†åˆ†ä¸º **Sessions** å’Œ **Billing** ä¸¤ä¸ªç‹¬ç«‹æ¨¡å—ã€‚
> 
> ### ğŸ“š å®é™…æ¶æ„å®ç°è¯·å‚è€ƒï¼š
> 
> 1. **[Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)** â­â­â­
>    - æŸ¥çœ‹ Sessions å’Œ Billing æ¨¡å—çš„å®Œæ•´å‚ç›´åˆ‡ç‰‡å®ç°æ–¹å¼
> 
> 2. **[ç³»ç»Ÿæ¨¡å—åˆ’åˆ†](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md)** â­â­
>    - [Sessions æ¨¡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#4-sessions-æ¨¡å—æ‰“çƒæ—¶æ®µ) - æ‰“çƒæ—¶æ®µç®¡ç†
>    - [Billing æ¨¡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#5-billing-æ¨¡å—è®¡è´¹ç®¡ç†) - è®¡è´¹è§„åˆ™ä¸è´¦å•
> 
> 3. **[Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—.md)** â­â­â­
>    - å¦‚ä½•å®ç°è®¡è´¹ç›¸å…³åŠŸèƒ½ï¼ˆStartSessionã€CalculateBill ç­‰ï¼‰
> 
> ### ğŸ”„ æ¨¡å—æ‹†åˆ†è¯´æ˜ï¼š
> 
> | åŸæ¨¡å—ï¼ˆæœ¬æ–‡æ¡£ï¼‰ | æ–°æ¨¡å— | èŒè´£ |
> |----------------|--------|------|
> | å°çƒæ¡Œè®¡è´¹æ¨¡å— | **Sessions** | æ‰“çƒæ—¶æ®µï¼ˆå¼€å°/å…³å°/æš‚åœ/æ¢å¤ï¼‰+ TableSessionSaga |
> | å°çƒæ¡Œè®¡è´¹æ¨¡å— | **Billing** | è®¡è´¹è§„åˆ™ã€ä»·æ ¼è®¡ç®—ã€è´¦å•ç”Ÿæˆ |
> 
> ### ğŸ“ æ–°æ¶æ„ç›®å½•ç»“æ„ï¼š
> 
> ```
> src/Modules/Sessions/
> â”œâ”€â”€ StartSession/
> â”‚   â”œâ”€â”€ StartSession.cs
> â”‚   â”œâ”€â”€ StartSessionHandler.cs
> â”‚   â””â”€â”€ StartSessionEndpoint.cs
> â”œâ”€â”€ EndSession/
> â”œâ”€â”€ PauseSession/
> â”œâ”€â”€ ResumeSession/
> â”œâ”€â”€ Sagas/
> â”‚   â””â”€â”€ TableSessionSaga.cs      # æ—¶æ®µç”Ÿå‘½å‘¨æœŸç®¡ç†
> â””â”€â”€ TableSession.cs              # èšåˆæ ¹
> 
> src/Modules/Billing/
> â”œâ”€â”€ CalculateBill/
> â”‚   â”œâ”€â”€ CalculateBill.cs
> â”‚   â””â”€â”€ CalculateBillHandler.cs
> â”œâ”€â”€ ApplyDiscount/
> â”œâ”€â”€ GenerateInvoice/
> â””â”€â”€ Bill.cs                      # èšåˆæ ¹
> ```
> 
> ### ğŸ”„ æ¶æ„å˜æ›´è¦ç‚¹ï¼š
> 
> | æ—§æ¶æ„ï¼ˆæœ¬æ–‡æ¡£ï¼‰ | æ–°æ¶æ„ï¼ˆWolverineï¼‰ | è¯´æ˜ |
> |----------------|-------------------|------|
> | è®¡è´¹æœåŠ¡ (BillingAppService) | CalculateBillHandler | æŒ‰åŠŸèƒ½åˆ‡ç‰‡ |
> | è®¡è´¹å¼•æ“ (BillingEngine) | CalculateBillHandler å†…è” | ä¸å†å•ç‹¬åˆ†å±‚ |
> | æ—¶é—´ç®¡ç†å™¨ | TableSessionSaga | ä½¿ç”¨ Saga ç®¡ç†ç”Ÿå‘½å‘¨æœŸ |
> | ä»“å‚¨ (Repository) | IDocumentSession (Marten) | ç›´æ¥ä½¿ç”¨ Marten |

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

å°çƒæ¡Œè®¡è´¹æ¨¡å—æ˜¯è‡ªåŠ©å°çƒç³»ç»Ÿçš„æ ¸å¿ƒä¸šåŠ¡æ¨¡å—ï¼Œè´Ÿè´£å°çƒæ¡Œçš„è®¡è´¹è§„åˆ™ç®¡ç†ã€å®æ—¶è®¡æ—¶è®¡è´¹ã€å¥—é¤ä»·æ ¼ä½“ç³»ã€å¼‚å¸¸å¤„ç†ç­‰åŠŸèƒ½ã€‚è¯¥æ¨¡å—ç¡®ä¿è®¡è´¹çš„å‡†ç¡®æ€§å’Œå…¬å¹³æ€§ï¼Œæ”¯æŒå¤šç§è®¡è´¹æ¨¡å¼å’Œçµæ´»çš„ä»·æ ¼ç­–ç•¥ã€‚

### æ ¸å¿ƒèŒè´£

- â° **ç²¾å‡†è®¡æ—¶**: æ¯«ç§’çº§è®¡æ—¶ç²¾åº¦ï¼Œç¡®ä¿è®¡è´¹å‡†ç¡®æ€§
- ğŸ’° **è®¡è´¹ç®—æ³•**: æ”¯æŒæŒ‰æ—¶é•¿ã€æŒ‰å±€æ•°ç­‰å¤šç§è®¡è´¹æ¨¡å¼
- ğŸ“¦ **å¥—é¤ç®¡ç†**: åŒ…æ—¶å¥—é¤ã€ä¼šå‘˜å¥—é¤ã€æ´»åŠ¨å¥—é¤
- ğŸ¯ **ä»·æ ¼ç­–ç•¥**: åˆ†æ—¶æ®µå®šä»·ã€èŠ‚å‡æ—¥å®šä»·ã€ä¼šå‘˜æŠ˜æ‰£
- âš ï¸ **å¼‚å¸¸å¤„ç†**: è®¾å¤‡æ•…éšœã€ç½‘ç»œæ–­çº¿ç­‰å¼‚å¸¸åœºæ™¯å¤„ç†

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—æ¶æ„å›¾

```mermaid
graph TB
    subgraph "è®¡è´¹æ¨¡å—"
        subgraph "åº”ç”¨æœåŠ¡å±‚"
            AS1[è®¡è´¹æœåŠ¡]
            AS2[å°çƒæ¡ŒæœåŠ¡]
            AS3[å¥—é¤æœåŠ¡]
            AS4[å®šä»·æœåŠ¡]
        end
        
        subgraph "é¢†åŸŸæœåŠ¡å±‚"
            DS1[è®¡è´¹å¼•æ“]
            DS2[ä»·æ ¼è®¡ç®—å™¨]
            DS3[æ—¶é—´ç®¡ç†å™¨]
            DS4[å¥—é¤å¤„ç†å™¨]
        end
        
        subgraph "é¢†åŸŸæ¨¡å‹å±‚"
            E1[å°çƒæ¡Œå®ä½“]
            E2[è®¡è´¹ä¼šè¯å®ä½“]
            E3[å¥—é¤å®ä½“]
            E4[ä»·æ ¼è§„åˆ™å®ä½“]
            VO1[è®¡è´¹å¿«ç…§å€¼å¯¹è±¡]
        end
        
        subgraph "åŸºç¡€è®¾æ–½å±‚"
            R1[å°çƒæ¡Œä»“å‚¨]
            R2[è®¡è´¹ä¼šè¯ä»“å‚¨]
            R3[å¥—é¤ä»“å‚¨]
            T1[å®šæ—¶ä»»åŠ¡]
            C1[ç¼“å­˜æœåŠ¡]
        end
    end
    
    AS1 --> DS1
    AS2 --> DS2
    AS3 --> DS4
    AS4 --> DS2
    
    DS1 --> E2
    DS1 --> VO1
    DS2 --> E4
    DS3 --> E2
    DS4 --> E3
    
    E1 --> R1
    E2 --> R2
    E3 --> R3
    E4 --> R3
    
    R1 --> C1
    R2 --> C1
    T1 --> DS1
```

### è®¡è´¹ä¸šåŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant T as å°çƒæ¡ŒæœåŠ¡
    participant B as è®¡è´¹å¼•æ“
    participant P as ä»·æ ¼è®¡ç®—å™¨
    participant D as è®¾å¤‡ç®¡ç†
    participant S as æ”¯ä»˜æ¨¡å—
    
    U->>T: è¯·æ±‚å¼€å°
    T->>B: åˆ›å»ºè®¡è´¹ä¼šè¯
    B->>P: è·å–å½“å‰ä»·æ ¼
    P-->>B: è¿”å›ä»·æ ¼è§„åˆ™
    B->>D: å‘é€å¼€å°æŒ‡ä»¤
    D-->>B: ç¡®è®¤è®¾å¤‡çŠ¶æ€
    B-->>T: è¿”å›ä¼šè¯ä¿¡æ¯
    T-->>U: å¼€å°æˆåŠŸ
    
    loop è®¡è´¹å¾ªç¯
        B->>B: æ›´æ–°è®¡è´¹æ—¶é•¿
        B->>P: è®¡ç®—å½“å‰è´¹ç”¨
        P-->>B: è¿”å›è´¹ç”¨é‡‘é¢
        B->>B: ä¿å­˜è®¡è´¹å¿«ç…§
    end
    
    U->>T: è¯·æ±‚ç»“å°
    T->>B: ç»“æŸè®¡è´¹ä¼šè¯
    B->>P: è®¡ç®—æœ€ç»ˆè´¹ç”¨
    P-->>B: è¿”å›æœ€ç»ˆé‡‘é¢
    B->>S: å‘èµ·æ”¯ä»˜è¯·æ±‚
    B->>D: å‘é€å…³å°æŒ‡ä»¤
    D-->>B: ç¡®è®¤è®¾å¤‡å…³é—­
    B-->>T: è¿”å›ç»“å°ä¿¡æ¯
    T-->>U: ç»“å°æˆåŠŸ
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒå®ä½“

#### å°çƒæ¡Œå®ä½“ (BilliardTable)

```csharp
public class BilliardTable : AuditedAggregateRoot<Guid>
{
    public string TableNumber { get; set; }
    public TableType Type { get; set; }
    public TableStatus Status { get; set; }
    public Guid? CurrentSessionId { get; set; }
    public DateTime? LastMaintenanceTime { get; set; }
    public string Location { get; set; }
    public string Description { get; set; }
    public bool IsActive { get; set; }
    
    // å¯¼èˆªå±æ€§
    public ICollection<BillingSession> BillingSessions { get; set; }
    public ICollection<TableMaintenance> MaintenanceRecords { get; set; }
}

public enum TableType
{
    Standard = 1,     // æ ‡å‡†å°
    Professional = 2, // ä¸“ä¸šå°
    VIP = 3          // VIPå°
}

public enum TableStatus
{
    Available = 1,    // å¯ç”¨
    InUse = 2,       // ä½¿ç”¨ä¸­
    Maintenance = 3,  // ç»´æŠ¤ä¸­
    OutOfService = 4  // åœç”¨
}
```

#### è®¡è´¹ä¼šè¯å®ä½“ (BillingSession)

```csharp
public class BillingSession : AuditedAggregateRoot<Guid>
{
    public Guid TableId { get; set; }
    public Guid UserId { get; set; }
    public string SessionToken { get; set; }
    public SessionStatus Status { get; set; }
    public DateTime StartTime { get; set; }
    public DateTime? EndTime { get; set; }
    public int PlayTimeMinutes { get; set; }
    public decimal HourlyRate { get; set; }
    public decimal TotalAmount { get; set; }
    public decimal DiscountAmount { get; set; }
    public decimal FinalAmount { get; set; }
    public BillingMode BillingMode { get; set; }
    public Guid? PackageId { get; set; }
    
    // å¯¼èˆªå±æ€§
    public BilliardTable Table { get; set; }
    public User User { get; set; }
    public Package Package { get; set; }
    public ICollection<BillingSnapshot> Snapshots { get; set; }
}

public enum SessionStatus
{
    Active = 1,      // è¿›è¡Œä¸­
    Paused = 2,      // æš‚åœ
    Completed = 3,   // å·²å®Œæˆ
    Cancelled = 4,   // å·²å–æ¶ˆ
    Exception = 5    // å¼‚å¸¸
}

public enum BillingMode
{
    Hourly = 1,      // æŒ‰å°æ—¶è®¡è´¹
    Package = 2,     // å¥—é¤è®¡è´¹
    Membership = 3   // ä¼šå‘˜è®¡è´¹
}
```

#### è®¡è´¹å¿«ç…§å®ä½“ (BillingSnapshot)

```csharp
public class BillingSnapshot : CreationAuditedEntity<Guid>
{
    public Guid SessionId { get; set; }
    public DateTime SnapshotTime { get; set; }
    public int ElapsedMinutes { get; set; }
    public decimal CurrentAmount { get; set; }
    public decimal HourlyRate { get; set; }
    public string PricingRuleSnapshot { get; set; }
    public SnapshotType Type { get; set; }
    
    // å¯¼èˆªå±æ€§
    public BillingSession Session { get; set; }
}

public enum SnapshotType
{
    Regular = 1,     // å®šæ—¶å¿«ç…§
    RateChange = 2,  // è´¹ç‡å˜æ›´
    Pause = 3,       // æš‚åœ
    Resume = 4,      // æ¢å¤
    Manual = 5       // æ‰‹åŠ¨å¿«ç…§
}
```

#### å¥—é¤å®ä½“ (Package)

```csharp
public class Package : AuditedAggregateRoot<Guid>
{
    public string Name { get; set; }
    public string Description { get; set; }
    public PackageType Type { get; set; }
    public decimal Price { get; set; }
    public int DurationMinutes { get; set; }
    public int ValidityDays { get; set; }
    public MemberLevel? RequiredMemberLevel { get; set; }
    public DateTime? StartDate { get; set; }
    public DateTime? EndDate { get; set; }
    public bool IsActive { get; set; }
    public int SortOrder { get; set; }
    
    // å¯¼èˆªå±æ€§
    public ICollection<PackageTableType> ApplicableTableTypes { get; set; }
    public ICollection<BillingSession> Sessions { get; set; }
}

public enum PackageType
{
    TimeBased = 1,   // è®¡æ—¶å¥—é¤
    Unlimited = 2,   // ä¸é™æ—¶å¥—é¤
    Membership = 3   // ä¼šå‘˜å¥—é¤
}
```

### å®ä½“å…³ç³»å›¾

```mermaid
erDiagram
    BilliardTable ||--o{ BillingSession : hosts
    User ||--o{ BillingSession : creates
    BillingSession ||--o{ BillingSnapshot : has
    Package ||--o{ BillingSession : applies
    PricingRule ||--o{ BillingSession : governs
    
    BilliardTable {
        guid Id PK
        string TableNumber
        int Type
        int Status
        guid CurrentSessionId
        datetime LastMaintenanceTime
        string Location
    }
    
    BillingSession {
        guid Id PK
        guid TableId FK
        guid UserId FK
        datetime StartTime
        datetime EndTime
        int PlayTimeMinutes
        decimal TotalAmount
        int BillingMode
    }
    
    BillingSnapshot {
        guid Id PK
        guid SessionId FK
        datetime SnapshotTime
        int ElapsedMinutes
        decimal CurrentAmount
        decimal HourlyRate
    }
    
    Package {
        guid Id PK
        string Name
        decimal Price
        int DurationMinutes
        int ValidityDays
        datetime StartDate
    }
```

---

## ğŸ”§ æ¥å£è®¾è®¡

### å°çƒæ¡Œç®¡ç†æ¥å£

```csharp
public interface IBilliardTableAppService : IApplicationService
{
    Task<PagedResultDto<BilliardTableDto>> GetTablesAsync(GetTablesDto input);
    Task<BilliardTableDto> GetTableAsync(Guid tableId);
    Task<BilliardTableDto> CreateTableAsync(CreateTableDto input);
    Task<BilliardTableDto> UpdateTableAsync(Guid tableId, UpdateTableDto input);
    Task<TableStatusDto> GetTableStatusAsync(Guid tableId);
    Task SetTableMaintenanceAsync(Guid tableId, bool maintenance);
}
```

### è®¡è´¹ç®¡ç†æ¥å£

```csharp
public interface IBillingAppService : IApplicationService
{
    Task<BillingSessionDto> StartBillingAsync(StartBillingDto input);
    Task<BillingSessionDto> EndBillingAsync(EndBillingDto input);
    Task<BillingSessionDto> PauseBillingAsync(Guid sessionId);
    Task<BillingSessionDto> ResumeBillingAsync(Guid sessionId);
    Task<CurrentBillingDto> GetCurrentBillingAsync(Guid sessionId);
    Task<List<BillingSnapshotDto>> GetBillingHistoryAsync(Guid sessionId);
    Task<BillingStatisticsDto> GetBillingStatisticsAsync(GetStatisticsDto input);
}
```

### å¥—é¤ç®¡ç†æ¥å£

```csharp
public interface IPackageAppService : IApplicationService
{
    Task<List<PackageDto>> GetAvailablePackagesAsync(GetPackagesDto input);
    Task<PackageDto> GetPackageAsync(Guid packageId);
    Task<PackageDto> CreatePackageAsync(CreatePackageDto input);
    Task<PackageDto> UpdatePackageAsync(Guid packageId, UpdatePackageDto input);
    Task DeletePackageAsync(Guid packageId);
    Task<bool> ValidatePackageAsync(Guid packageId, Guid tableId);
}
```

---

## âš™ï¸ è®¡è´¹ç®—æ³•

### åŸºç¡€è®¡è´¹ç®—æ³•

```csharp
public class BillingCalculator
{
    public decimal CalculateAmount(BillingSession session, DateTime currentTime)
    {
        var elapsedTime = currentTime - session.StartTime;
        var totalMinutes = (int)Math.Ceiling(elapsedTime.TotalMinutes);
        
        switch (session.BillingMode)
        {
            case BillingMode.Hourly:
                return CalculateHourlyAmount(totalMinutes, session.HourlyRate);
            
            case BillingMode.Package:
                return CalculatePackageAmount(session.PackageId, totalMinutes);
            
            case BillingMode.Membership:
                return CalculateMembershipAmount(session.UserId, totalMinutes);
            
            default:
                throw new BusinessException("ä¸æ”¯æŒçš„è®¡è´¹æ¨¡å¼");
        }
    }
    
    private decimal CalculateHourlyAmount(int minutes, decimal hourlyRate)
    {
        // ä¸è¶³ä¸€å°æ—¶æŒ‰ä¸€å°æ—¶è®¡ç®—
        var hours = Math.Ceiling(minutes / 60.0);
        return (decimal)hours * hourlyRate;
    }
}
```

### åˆ†æ—¶æ®µå®šä»·

```csharp
public class TimeBasedPricingRule
{
    public List<PricingPeriod> PricingPeriods { get; set; }
    
    public decimal GetHourlyRate(DateTime dateTime, TableType tableType)
    {
        var currentTime = dateTime.TimeOfDay;
        var dayOfWeek = dateTime.DayOfWeek;
        
        var period = PricingPeriods
            .FirstOrDefault(p => p.IsApplicable(currentTime, dayOfWeek, tableType));
            
        return period?.HourlyRate ?? GetDefaultRate(tableType);
    }
}

public class PricingPeriod
{
    public TimeSpan StartTime { get; set; }
    public TimeSpan EndTime { get; set; }
    public DayOfWeek[] ApplicableDays { get; set; }
    public TableType[] ApplicableTableTypes { get; set; }
    public decimal HourlyRate { get; set; }
    public bool IsHoliday { get; set; }
}
```

---

## ğŸ“‹ ä¸šåŠ¡è§„åˆ™

### è®¡è´¹è§„åˆ™

| å°çƒæ¡Œç±»å‹ | å¹³æ—¥ä»·æ ¼ | å‘¨æœ«ä»·æ ¼ | ä¼šå‘˜æŠ˜æ‰£ |
|------------|----------|----------|----------|
| æ ‡å‡†å° | 30å…ƒ/å°æ—¶ | 40å…ƒ/å°æ—¶ | 9æŠ˜ |
| ä¸“ä¸šå° | 50å…ƒ/å°æ—¶ | 60å…ƒ/å°æ—¶ | 85æŠ˜ |
| VIPå° | 80å…ƒ/å°æ—¶ | 100å…ƒ/å°æ—¶ | 8æŠ˜ |

### æ—¶æ®µè§„åˆ™

- ğŸŒ… **æ—©é—´æ—¶æ®µ** (09:00-12:00): 8æŠ˜ä¼˜æƒ 
- ğŸŒ **åˆé—´æ—¶æ®µ** (12:00-18:00): æ ‡å‡†ä»·æ ¼
- ğŸŒ™ **æ™šé—´æ—¶æ®µ** (18:00-22:00): æ ‡å‡†ä»·æ ¼  
- ğŸŒƒ **æ·±å¤œæ—¶æ®µ** (22:00-24:00): 1.2å€ä»·æ ¼

### å¥—é¤è§„åˆ™

**æ—¶é•¿å¥—é¤**:
- ğŸ“¦ 2å°æ—¶å¥—é¤ï¼š9æŠ˜ä¼˜æƒ 
- ğŸ“¦ 4å°æ—¶å¥—é¤ï¼š85æŠ˜ä¼˜æƒ 
- ğŸ“¦ å…¨å¤©å¥—é¤ï¼š8æŠ˜ä¼˜æƒ 

**ä¼šå‘˜å¥—é¤**:
- ğŸ† æœˆåº¦å¥—é¤ï¼š30å°æ—¶æ¸¸æˆæ—¶é•¿
- ğŸ† å­£åº¦å¥—é¤ï¼š100å°æ—¶æ¸¸æˆæ—¶é•¿
- ğŸ† å¹´åº¦å¥—é¤ï¼š500å°æ—¶æ¸¸æˆæ—¶é•¿

---

## âš ï¸ å¼‚å¸¸å¤„ç†

### å¼‚å¸¸åœºæ™¯å¤„ç†

```mermaid
graph TD
    A[è®¡è´¹å¼‚å¸¸] --> B{å¼‚å¸¸ç±»å‹}
    
    B --> C[è®¾å¤‡æ•…éšœ]
    B --> D[ç½‘ç»œæ–­çº¿]
    B --> E[ç³»ç»Ÿå´©æºƒ]
    B --> F[ç”¨æˆ·å¼‚å¸¸é€€å‡º]
    
    C --> G[æš‚åœè®¡è´¹]
    D --> H[ç¼“å­˜è®¡è´¹æ•°æ®]
    E --> I[ä»å¿«ç…§æ¢å¤]
    F --> J[æŒ‰æœ€åå¿«ç…§ç»“ç®—]
    
    G --> K[æ•…éšœä¿®å¤åæ¢å¤]
    H --> L[ç½‘ç»œæ¢å¤ååŒæ­¥]
    I --> M[æ•°æ®å®Œæ•´æ€§æ£€æŸ¥]
    J --> N[å‘é€è´¦å•ç¡®è®¤]
```

### è¡¥å¿æœºåˆ¶

```csharp
public class BillingCompensation
{
    // è®¾å¤‡æ•…éšœè¡¥å¿
    public async Task CompensateForDeviceFailure(Guid sessionId)
    {
        var session = await _sessionRepository.GetAsync(sessionId);
        var failureTime = await GetDeviceFailureTime(session.TableId);
        
        // ä»æ•…éšœæ—¶é—´ç‚¹æš‚åœè®¡è´¹
        await PauseBillingFromTime(sessionId, failureTime);
        
        // å‘é€æ•…éšœé€šçŸ¥
        await _notificationService.NotifyDeviceFailure(session.UserId);
    }
    
    // ç½‘ç»œæ–­çº¿è¡¥å¿
    public async Task CompensateForNetworkIssue(Guid sessionId)
    {
        var session = await _sessionRepository.GetAsync(sessionId);
        var lastSnapshot = await GetLastValidSnapshot(sessionId);
        
        // æŒ‰æœ€åæœ‰æ•ˆå¿«ç…§è®¡è´¹
        session.EndTime = lastSnapshot.SnapshotTime;
        session.TotalAmount = lastSnapshot.CurrentAmount;
        
        await _sessionRepository.UpdateAsync(session);
    }
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥

```csharp
// å°çƒæ¡ŒçŠ¶æ€ç¼“å­˜ï¼ˆå®æ—¶æ›´æ–°ï¼‰
[CachePut(CacheNames.TableStatus, "{tableId}", Duration = 60)]
public async Task<TableStatus> GetTableStatusAsync(Guid tableId)

// ä»·æ ¼è§„åˆ™ç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
[CachePut(CacheNames.PricingRules, Duration = 3600)]
public async Task<List<PricingRule>> GetPricingRulesAsync()

// å½“å‰è®¡è´¹ç¼“å­˜ï¼ˆ5åˆ†é’Ÿï¼‰
[CachePut(CacheNames.CurrentBilling, "{sessionId}", Duration = 300)]
public async Task<CurrentBillingDto> GetCurrentBillingAsync(Guid sessionId)
```

### è®¡è´¹å¿«ç…§ç­–ç•¥

- â° **å®šæ—¶å¿«ç…§**: æ¯5åˆ†é’Ÿè‡ªåŠ¨ä¿å­˜è®¡è´¹å¿«ç…§
- ğŸ”„ **å˜æ›´å¿«ç…§**: ä»·æ ¼è§„åˆ™å˜æ›´æ—¶ç«‹å³ä¿å­˜å¿«ç…§
- â¸ï¸ **æ“ä½œå¿«ç…§**: æš‚åœ/æ¢å¤æ“ä½œæ—¶ä¿å­˜å¿«ç…§
- ğŸ“Š **å…³é”®æ—¶åˆ»**: æ•´ç‚¹æ—¶åˆ»å¼ºåˆ¶ä¿å­˜å¿«ç…§

---

## ğŸ“ˆ ç›‘æ§æŒ‡æ ‡

### ä¸šåŠ¡æŒ‡æ ‡

- ğŸ’° æ—¥å‡è®¡è´¹é‡‘é¢
- â° å¹³å‡æ¸¸æˆæ—¶é•¿  
- ğŸ“¦ å¥—é¤ä½¿ç”¨ç‡
- ğŸ¯ è®¡è´¹å‡†ç¡®ç‡

### æŠ€æœ¯æŒ‡æ ‡

- âš¡ è®¡è´¹è®¡ç®—å“åº”æ—¶é—´
- ğŸ“Š å¿«ç…§ä¿å­˜æˆåŠŸç‡
- ğŸ”„ ç¼“å­˜å‘½ä¸­ç‡
- âš ï¸ å¼‚å¸¸å¤„ç†æˆåŠŸç‡

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **ä¸Šçº§æ–‡æ¡£**: [æ¨¡å—è®¾è®¡æ€»è§ˆ](README.md)
- **å…³è”æ–‡æ¡£**: [è®¾å¤‡ç®¡ç†æ¨¡å—](è®¾å¤‡ç®¡ç†æ¨¡å—.md) | [æ”¯ä»˜æ¨¡å—](æ”¯ä»˜æ¨¡å—.md)
- **æŠ€æœ¯æ–‡æ¡£**: [å®šæ—¶ä»»åŠ¡è®¾è®¡](../08_é…ç½®ç®¡ç†/å®šæ—¶ä»»åŠ¡.md)
- **è¿”å›**: [é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md)

---

*æœ€åæ›´æ–°: 2024-01-15 | ç‰ˆæœ¬: v1.0.0*
