---
title: "å°çƒæ¡Œè®¡è´¹æ¨¡å—ï¼ˆSessions + Billingï¼‰"
description: "åŸºäº Wolverine å‚ç›´åˆ‡ç‰‡æ¶æ„çš„æ‰“çƒæ—¶æ®µä¸è®¡è´¹ç®¡ç†æ¨¡å—è®¾è®¡"
version: "2.0.0"
author: "æ¶æ„å›¢é˜Ÿ"
maintainer: "åç«¯å¼€å‘å›¢é˜Ÿ"
created: "2024-01-15"
updated: "2024-01-15"
category: "æ¨¡å—è®¾è®¡"
level: "æ ¸å¿ƒ"
audience: ["åç«¯å¼€å‘å·¥ç¨‹å¸ˆ", "ä¸šåŠ¡åˆ†æå¸ˆ"]
keywords: ["Sessions", "Billing", "è®¡è´¹", "æ—¶æ®µç®¡ç†", "Wolverine", "å‚ç›´åˆ‡ç‰‡"]
tags: ["sessions", "billing", "pricing", "timing", "vertical-slice", "wolverine"]
dependencies: ["ç³»ç»Ÿæ¶æ„è®¾è®¡", "Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾"]
estimated_reading_time: "25åˆ†é’Ÿ"
architecture: "Wolverine + å‚ç›´åˆ‡ç‰‡"
---

# å°çƒæ¡Œè®¡è´¹æ¨¡å—ï¼ˆSessions + Billingï¼‰

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“¦ æ¨¡å—è®¾è®¡](README.md) > ğŸ’° å°çƒæ¡Œè®¡è´¹æ¨¡å—

<!-- Keywords for Search -->
**å…³é”®è¯**: `Sessions` `Billing` `è®¡è´¹æ¨¡å—` `æ—¶æ®µç®¡ç†` `Wolverine` `å‚ç›´åˆ‡ç‰‡`

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

å°çƒæ¡Œè®¡è´¹æ¨¡å—åœ¨ Wolverine æ¶æ„ä¸‹æ‹†åˆ†ä¸º **Sessions**ï¼ˆæ‰“çƒæ—¶æ®µï¼‰å’Œ **Billing**ï¼ˆè®¡è´¹ç®¡ç†ï¼‰ä¸¤ä¸ªç‹¬ç«‹æ¨¡å—ï¼Œé‡‡ç”¨ **Wolverine + å‚ç›´åˆ‡ç‰‡æ¶æ„**ã€‚

### æ¨¡å—æ‹†åˆ†è¯´æ˜

åŸå°çƒæ¡Œè®¡è´¹æ¨¡å—å·²æ‹†åˆ†ä¸ºä¸¤ä¸ªç‹¬ç«‹æ¨¡å—ï¼š

| æ¨¡å— | èŒè´£ | æ ¸å¿ƒåŠŸèƒ½ |
|------|------|---------|
| **Sessions** | æ‰“çƒæ—¶æ®µç®¡ç† | å¼€å§‹æ—¶æ®µã€æš‚åœ/æ¢å¤ã€ç»“æŸæ—¶æ®µã€æ—¶é•¿è®¡ç®— |
| **Billing** | è®¡è´¹è§„åˆ™ä¸è´¦å• | è´¦å•è®¡ç®—ã€ä»·æ ¼ç­–ç•¥ã€ä¼˜æƒ åˆ¸ç®¡ç†ã€å‘ç¥¨ç”Ÿæˆ |

### æ¶æ„å‚è€ƒ

> ğŸ“š **å®Œæ•´æ¶æ„å®ç°**: [Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)
> 
> ğŸ“š **æ¨¡å—è¾¹ç•Œå®šä¹‰**: 
> - [ç³»ç»Ÿæ¨¡å—åˆ’åˆ† - Sessions æ¨¡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#4-sessions-æ¨¡å—æ‰“çƒæ—¶æ®µ)
> - [ç³»ç»Ÿæ¨¡å—åˆ’åˆ† - Billing æ¨¡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#5-billing-æ¨¡å—è®¡è´¹ç®¡ç†)

---

## ğŸ—ï¸ Sessions æ¨¡å—ç»“æ„

### ç›®å½•ç»„ç»‡

\`\`\`
src/Modules/Sessions/
â”œâ”€â”€ StartSession/
â”‚   â”œâ”€â”€ StartSession.cs                # Command
â”‚   â”œâ”€â”€ StartSessionHandler.cs         # Handler
â”‚   â”œâ”€â”€ StartSessionEndpoint.cs        # HTTP Endpoint
â”‚   â””â”€â”€ StartSessionValidator.cs       # Validator
â”‚
â”œâ”€â”€ EndSession/
â”‚   â”œâ”€â”€ EndSession.cs
â”‚   â”œâ”€â”€ EndSessionHandler.cs
â”‚   â””â”€â”€ EndSessionEndpoint.cs
â”‚
â”œâ”€â”€ PauseSession/
â”‚   â”œâ”€â”€ PauseSession.cs
â”‚   â”œâ”€â”€ PauseSessionHandler.cs
â”‚   â””â”€â”€ PauseSessionEndpoint.cs
â”‚
â”œâ”€â”€ ResumeSession/
â”‚   â”œâ”€â”€ ResumeSession.cs
â”‚   â”œâ”€â”€ ResumeSessionHandler.cs
â”‚   â””â”€â”€ ResumeSessionEndpoint.cs
â”‚
â”œâ”€â”€ ExtendSession/
â”‚   â”œâ”€â”€ ExtendSession.cs
â”‚   â”œâ”€â”€ ExtendSessionHandler.cs
â”‚   â””â”€â”€ ExtendSessionEndpoint.cs
â”‚
â”œâ”€â”€ GetSession/
â”‚   â”œâ”€â”€ GetSession.cs                  # Query
â”‚   â”œâ”€â”€ GetSessionHandler.cs
â”‚   â””â”€â”€ GetSessionEndpoint.cs
â”‚
â”œâ”€â”€ GetActiveSessionByTable/
â”‚   â”œâ”€â”€ GetActiveSessionByTable.cs
â”‚   â””â”€â”€ GetActiveSessionByTableHandler.cs
â”‚
â”œâ”€â”€ GetSessionHistory/
â”‚   â”œâ”€â”€ GetSessionHistory.cs
â”‚   â””â”€â”€ GetSessionHistoryHandler.cs
â”‚
â”œâ”€â”€ Events/
â”‚   â”œâ”€â”€ SessionStarted.cs              # æ—¶æ®µå·²å¼€å§‹
â”‚   â”œâ”€â”€ SessionEnded.cs                # æ—¶æ®µå·²ç»“æŸ
â”‚   â”œâ”€â”€ SessionPaused.cs               # æ—¶æ®µå·²æš‚åœ
â”‚   â””â”€â”€ SessionResumed.cs              # æ—¶æ®µå·²æ¢å¤
â”‚
â”œâ”€â”€ Sagas/
â”‚   â””â”€â”€ TableSessionSaga.cs            # æ—¶æ®µç”Ÿå‘½å‘¨æœŸç®¡ç†
â”‚
â”œâ”€â”€ TableSession.cs                     # èšåˆæ ¹
â”œâ”€â”€ PauseRecord.cs                      # å€¼å¯¹è±¡ï¼šæš‚åœè®°å½•
â”œâ”€â”€ SessionStatus.cs                    # æšä¸¾
â””â”€â”€ SessionsModule.cs                   # æ¨¡å—æ ‡è®°
\`\`\`

---

## ğŸ’» Sessions æ¨¡å—åŠŸèƒ½åˆ‡ç‰‡

### 1. StartSessionï¼ˆå¼€å§‹æ—¶æ®µï¼‰

#### Command å®šä¹‰

\`\`\`csharp
public sealed record StartSession(
    Guid TableId,
    Guid? MemberId,           // ä¼šå‘˜IDï¼ˆæ•£å®¢ä¸ºnullï¼‰
    string? CustomerName      // æ•£å®¢å§“åï¼ˆå¯é€‰ï¼‰
);
\`\`\`

#### Handler å®ç°

\`\`\`csharp
public sealed class StartSessionHandler
{
    [Transactional]
    public async Task<Result<Guid>> Handle(
        StartSession command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        // 1. éªŒè¯æ¡Œå°æ˜¯å¦å¯ç”¨
        var table = await session.LoadAsync<Table>(command.TableId, ct);
        if (table == null)
            return Result.Fail<Guid>("Tables:TableNotFound", "æ¡Œå°ä¸å­˜åœ¨");
        
        if (table.Status != TableStatus.Available)
            return Result.Fail<Guid>("Tables:TableUnavailable", "æ¡Œå°ä¸å¯ç”¨");
        
        // 2. æ£€æŸ¥æ˜¯å¦å·²æœ‰æ´»è·ƒæ—¶æ®µ
        var existingSession = await session.Query<TableSession>()
            .FirstOrDefaultAsync(s => s.TableId == command.TableId && 
                                     (s.Status == SessionStatus.Active || s.Status == SessionStatus.Paused), ct);
        
        if (existingSession != null)
            return Result.Fail<Guid>("Sessions:SessionAlreadyActive", "è¯¥æ¡Œå°å·²æœ‰æ´»è·ƒæ—¶æ®µ");
        
        // 3. åˆ›å»ºæ–°æ—¶æ®µ
        var tableSession = new TableSession
        {
            Id = Guid.NewGuid(),
            TableId = command.TableId,
            MemberId = command.MemberId,
            CustomerName = command.CustomerName,
            Status = SessionStatus.Active,
            StartTime = DateTimeOffset.UtcNow,
            PauseRecords = new List<PauseRecord>(),
            CreatedAt = DateTimeOffset.UtcNow
        };
        
        session.Store(tableSession);
        await session.SaveChangesAsync(ct);
        
        // 4. å‘å¸ƒäº‹ä»¶
        await bus.PublishAsync(new SessionStarted(
            tableSession.Id,
            command.TableId,
            command.MemberId,
            tableSession.StartTime
        ), ct);
        
        // 5. å‘é€å‘½ä»¤åˆ° Tables æ¨¡å—æ ‡è®°æ¡Œå°ä¸ºå ç”¨
        await bus.InvokeAsync(new ReserveTable(command.TableId, tableSession.Id), ct);
        
        return Result.Ok(tableSession.Id);
    }
}
\`\`\`

#### HTTP Endpoint

\`\`\`csharp
public sealed class StartSessionEndpoint
{
    [WolverinePost("/api/sessions/start")]
    public static StartSession Post(StartSessionRequest request)
        => new(request.TableId, request.MemberId, request.CustomerName);
}

public sealed record StartSessionRequest(
    Guid TableId,
    Guid? MemberId,
    string? CustomerName
);
\`\`\`

#### Validator

\`\`\`csharp
public sealed class StartSessionValidator : AbstractValidator<StartSession>
{
    public StartSessionValidator()
    {
        RuleFor(x => x.TableId)
            .NotEmpty().WithMessage("TableId ä¸èƒ½ä¸ºç©º");
        
        When(x => x.MemberId == null, () =>
        {
            RuleFor(x => x.CustomerName)
                .NotEmpty().WithMessage("æ•£å®¢å¿…é¡»æä¾›å§“å")
                .MaximumLength(50).WithMessage("å§“åä¸èƒ½è¶…è¿‡50å­—ç¬¦");
        });
    }
}
\`\`\`

---

### 2. EndSessionï¼ˆç»“æŸæ—¶æ®µï¼‰

#### Command å®šä¹‰

\`\`\`csharp
public sealed record EndSession(Guid SessionId);
\`\`\`

#### Handler å®ç°

\`\`\`csharp
public sealed class EndSessionHandler
{
    [Transactional]
    public async Task<Result> Handle(
        EndSession command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        var tableSession = await session.LoadAsync<TableSession>(command.SessionId, ct);
        if (tableSession == null)
            return Result.Fail("Sessions:SessionNotFound", "æ—¶æ®µä¸å­˜åœ¨");
        
        if (tableSession.Status == SessionStatus.Ended || tableSession.Status == SessionStatus.Completed)
            return Result.Fail("Sessions:SessionAlreadyEnded", "æ—¶æ®µå·²ç»“æŸ");
        
        // è®¡ç®—æ€»æ—¶é•¿ï¼ˆæ‰£é™¤æš‚åœæ—¶é—´ï¼‰
        tableSession.EndTime = DateTimeOffset.UtcNow;
        tableSession.Status = SessionStatus.Ended;
        tableSession.CalculatedDuration = CalculateBillableDuration(tableSession);
        
        session.Store(tableSession);
        await session.SaveChangesAsync(ct);
        
        // å‘å¸ƒäº‹ä»¶
        await bus.PublishAsync(new SessionEnded(
            tableSession.Id,
            tableSession.TableId,
            tableSession.CalculatedDuration
        ), ct);
        
        // å‘é€å‘½ä»¤åˆ° Tables æ¨¡å—é‡Šæ”¾æ¡Œå°
        await bus.InvokeAsync(new ReleaseTable(tableSession.TableId), ct);
        
        return Result.Ok();
    }
    
    private TimeSpan CalculateBillableDuration(TableSession session)
    {
        var totalDuration = session.EndTime!.Value - session.StartTime;
        var pausedDuration = session.PauseRecords
            .Where(p => p.ResumedAt.HasValue)
            .Sum(p => (p.ResumedAt!.Value - p.PausedAt).TotalMilliseconds);
        
        return totalDuration - TimeSpan.FromMilliseconds(pausedDuration);
    }
}
\`\`\`

---

### 3. PauseSession / ResumeSessionï¼ˆæš‚åœ/æ¢å¤ï¼‰

#### Command å®šä¹‰

\`\`\`csharp
public sealed record PauseSession(Guid SessionId, string? Reason);
public sealed record ResumeSession(Guid SessionId);
\`\`\`

#### PauseSessionHandler

\`\`\`csharp
public sealed class PauseSessionHandler
{
    [Transactional]
    public async Task<Result> Handle(
        PauseSession command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        var tableSession = await session.LoadAsync<TableSession>(command.SessionId, ct);
        if (tableSession == null)
            return Result.Fail("Sessions:SessionNotFound", "æ—¶æ®µä¸å­˜åœ¨");
        
        if (tableSession.Status != SessionStatus.Active)
            return Result.Fail("Sessions:SessionNotActive", "åªèƒ½æš‚åœè¿›è¡Œä¸­çš„æ—¶æ®µ");
        
        tableSession.Status = SessionStatus.Paused;
        tableSession.PauseRecords.Add(new PauseRecord
        {
            PausedAt = DateTimeOffset.UtcNow,
            Reason = command.Reason
        });
        
        session.Store(tableSession);
        await session.SaveChangesAsync(ct);
        
        await bus.PublishAsync(new SessionPaused(tableSession.Id, tableSession.TableId), ct);
        
        return Result.Ok();
    }
}
\`\`\`

#### ResumeSessionHandler

\`\`\`csharp
public sealed class ResumeSessionHandler
{
    [Transactional]
    public async Task<Result> Handle(
        ResumeSession command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        var tableSession = await session.LoadAsync<TableSession>(command.SessionId, ct);
        if (tableSession == null)
            return Result.Fail("Sessions:SessionNotFound", "æ—¶æ®µä¸å­˜åœ¨");
        
        if (tableSession.Status != SessionStatus.Paused)
            return Result.Fail("Sessions:SessionNotPaused", "åªèƒ½æ¢å¤å·²æš‚åœçš„æ—¶æ®µ");
        
        var lastPause = tableSession.PauseRecords.LastOrDefault(p => !p.ResumedAt.HasValue);
        if (lastPause != null)
            lastPause.ResumedAt = DateTimeOffset.UtcNow;
        
        tableSession.Status = SessionStatus.Active;
        
        session.Store(tableSession);
        await session.SaveChangesAsync(ct);
        
        await bus.PublishAsync(new SessionResumed(tableSession.Id, tableSession.TableId), ct);
        
        return Result.Ok();
    }
}
\`\`\`

---

## ğŸ—ï¸ Billing æ¨¡å—ç»“æ„

### ç›®å½•ç»„ç»‡

\`\`\`
src/Modules/Billing/
â”œâ”€â”€ CalculateBill/
â”‚   â”œâ”€â”€ CalculateBill.cs               # Command
â”‚   â”œâ”€â”€ CalculateBillHandler.cs        # Handlerï¼ˆå†…éƒ¨ç›‘å¬ SessionEndedï¼‰
â”‚   â””â”€â”€ BillCalculationService.cs      # è®¡è´¹ç®—æ³•å°è£…
â”‚
â”œâ”€â”€ ApplyDiscount/
â”‚   â”œâ”€â”€ ApplyDiscount.cs
â”‚   â”œâ”€â”€ ApplyDiscountHandler.cs
â”‚   â””â”€â”€ ApplyDiscountEndpoint.cs
â”‚
â”œâ”€â”€ GenerateInvoice/
â”‚   â”œâ”€â”€ GenerateInvoice.cs
â”‚   â”œâ”€â”€ GenerateInvoiceHandler.cs
â”‚   â””â”€â”€ GenerateInvoiceEndpoint.cs
â”‚
â”œâ”€â”€ GetBill/
â”‚   â”œâ”€â”€ GetBill.cs                     # Query
â”‚   â”œâ”€â”€ GetBillHandler.cs
â”‚   â””â”€â”€ GetBillEndpoint.cs
â”‚
â”œâ”€â”€ GetPricingRules/
â”‚   â”œâ”€â”€ GetPricingRules.cs
â”‚   â””â”€â”€ GetPricingRulesHandler.cs
â”‚
â”œâ”€â”€ UpdatePricingRule/
â”‚   â”œâ”€â”€ UpdatePricingRule.cs
â”‚   â”œâ”€â”€ UpdatePricingRuleHandler.cs
â”‚   â””â”€â”€ UpdatePricingRuleEndpoint.cs
â”‚
â”œâ”€â”€ Events/
â”‚   â”œâ”€â”€ BillCalculated.cs              # è´¦å•å·²è®¡ç®—
â”‚   â””â”€â”€ InvoiceGenerated.cs            # å‘ç¥¨å·²ç”Ÿæˆ
â”‚
â”œâ”€â”€ Handlers/
â”‚   â””â”€â”€ SessionEndedHandler.cs         # ç›‘å¬ SessionEnded äº‹ä»¶ â†’ è‡ªåŠ¨è®¡ç®—è´¦å•
â”‚
â”œâ”€â”€ Bill.cs                             # èšåˆæ ¹
â”œâ”€â”€ BillItem.cs                         # å€¼å¯¹è±¡
â”œâ”€â”€ PricingRule.cs                      # å®ä½“
â”œâ”€â”€ BillItemType.cs                     # æšä¸¾
â””â”€â”€ BillingModule.cs                    # æ¨¡å—æ ‡è®°
\`\`\`

---

## ğŸ’» Billing æ¨¡å—åŠŸèƒ½åˆ‡ç‰‡

### 1. CalculateBillï¼ˆè®¡ç®—è´¦å•ï¼‰

#### Command å®šä¹‰

\`\`\`csharp
public sealed record CalculateBill(
    Guid SessionId,
    Guid TableId,
    TimeSpan Duration
);
\`\`\`

#### Handler å®ç°

\`\`\`csharp
public sealed class CalculateBillHandler
{
    private readonly BillCalculationService _calculator;
    
    public CalculateBillHandler(BillCalculationService calculator)
    {
        _calculator = calculator;
    }
    
    [Transactional]
    public async Task<Result<Guid>> Handle(
        CalculateBill command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        // 1. è·å–æ¡Œå°ä¿¡æ¯å’Œè®¡è´¹è§„åˆ™
        var table = await session.LoadAsync<Table>(command.TableId, ct);
        if (table == null)
            return Result.Fail<Guid>("Billing:TableNotFound", "æ¡Œå°ä¸å­˜åœ¨");
        
        var pricingRules = await session.Query<PricingRule>()
            .Where(r => r.TableType == table.Type)
            .ToListAsync(ct);
        
        // 2. è®¡ç®—è´¦å•
        var calculation = _calculator.Calculate(command.Duration, table.HourlyRate, pricingRules);
        
        // 3. åˆ›å»ºè´¦å•
        var bill = new Bill
        {
            Id = Guid.NewGuid(),
            SessionId = command.SessionId,
            TableId = command.TableId,
            Duration = command.Duration,
            HourlyRate = table.HourlyRate,
            BaseAmount = calculation.BaseAmount,
            DiscountAmount = 0,
            TotalAmount = calculation.BaseAmount,
            Items = calculation.Items,
            CreatedAt = DateTimeOffset.UtcNow
        };
        
        session.Store(bill);
        await session.SaveChangesAsync(ct);
        
        // 4. å‘å¸ƒäº‹ä»¶
        await bus.PublishAsync(new BillCalculated(
            bill.Id,
            command.SessionId,
            bill.TotalAmount
        ), ct);
        
        return Result.Ok(bill.Id);
    }
}
\`\`\`

#### è®¡è´¹ç®—æ³•æœåŠ¡

\`\`\`csharp
public sealed class BillCalculationService
{
    public BillCalculationResult Calculate(
        TimeSpan duration,
        decimal hourlyRate,
        List<PricingRule> rules)
    {
        var hours = Math.Ceiling(duration.TotalHours);
        var baseAmount = (decimal)hours * hourlyRate;
        
        var items = new List<BillItem>
        {
            new BillItem
            {
                Description = $"æ¡Œå°è´¹ç”¨ï¼ˆ{hours:F2}å°æ—¶ Ã— {hourlyRate:F2}å…ƒ/å°æ—¶ï¼‰",
                Amount = baseAmount,
                Type = BillItemType.TableFee
            }
        };
        
        // TODO: åº”ç”¨é«˜å³°æ—¶æ®µä»·æ ¼ã€ä¼šå‘˜æŠ˜æ‰£ç­‰è§„åˆ™
        
        return new BillCalculationResult
        {
            BaseAmount = baseAmount,
            Items = items
        };
    }
}

public sealed record BillCalculationResult
{
    public decimal BaseAmount { get; init; }
    public List<BillItem> Items { get; init; } = new();
}
\`\`\`

---

### 2. SessionEndedHandlerï¼ˆç›‘å¬æ—¶æ®µç»“æŸäº‹ä»¶ï¼‰

\`\`\`csharp
public sealed class SessionEndedHandler
{
    public async Task Handle(
        SessionEnded @event,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        // è‡ªåŠ¨è§¦å‘è´¦å•è®¡ç®—
        await bus.InvokeAsync(new CalculateBill(
            @event.SessionId,
            @event.TableId,
            @event.Duration
        ), ct);
    }
}
\`\`\`

---

## ğŸ“Š é¢†åŸŸæ¨¡å‹

### TableSessionï¼ˆèšåˆæ ¹ï¼‰

\`\`\`csharp
public class TableSession
{
    public Guid Id { get; set; }
    public Guid TableId { get; set; }
    public Guid? MemberId { get; set; }
    public string? CustomerName { get; set; }       // æ•£å®¢å§“å
    public SessionStatus Status { get; set; }
    public DateTimeOffset StartTime { get; set; }
    public DateTimeOffset? EndTime { get; set; }
    public List<PauseRecord> PauseRecords { get; set; } = new();
    public TimeSpan CalculatedDuration { get; set; }
    public DateTimeOffset CreatedAt { get; set; }
}

public class PauseRecord
{
    public DateTimeOffset PausedAt { get; set; }
    public DateTimeOffset? ResumedAt { get; set; }
    public string? Reason { get; set; }
}

public enum SessionStatus
{
    Active,         // è¿›è¡Œä¸­
    Paused,         // æš‚åœä¸­
    Ended,          // å·²ç»“æŸï¼ˆç­‰å¾…æ”¯ä»˜ï¼‰
    Completed       // å·²å®Œæˆï¼ˆå·²æ”¯ä»˜ï¼‰
}
\`\`\`

### Billï¼ˆèšåˆæ ¹ï¼‰

\`\`\`csharp
public class Bill
{
    public Guid Id { get; set; }
    public Guid SessionId { get; set; }
    public Guid TableId { get; set; }
    public TimeSpan Duration { get; set; }
    public decimal HourlyRate { get; set; }
    public decimal BaseAmount { get; set; }
    public decimal DiscountAmount { get; set; }
    public decimal TotalAmount { get; set; }
    public List<BillItem> Items { get; set; } = new();
    public DateTimeOffset CreatedAt { get; set; }
}

public class BillItem
{
    public string Description { get; set; } = string.Empty;
    public decimal Amount { get; set; }
    public BillItemType Type { get; set; }
}

public enum BillItemType
{
    TableFee,       // æ¡Œå°è´¹
    Discount,       // æŠ˜æ‰£
    Coupon,         // ä¼˜æƒ åˆ¸
    MemberDiscount  // ä¼šå‘˜æŠ˜æ‰£
}

public class PricingRule
{
    public Guid Id { get; set; }
    public TableType TableType { get; set; }
    public decimal HourlyRate { get; set; }
    public TimeSpan? PeakTimeStart { get; set; }
    public TimeSpan? PeakTimeEnd { get; set; }
    public decimal PeakTimeMultiplier { get; set; }
}
\`\`\`

---

## ğŸ”” é¢†åŸŸäº‹ä»¶

### Sessions æ¨¡å—äº‹ä»¶

\`\`\`csharp
public sealed record SessionStarted(
    Guid SessionId,
    Guid TableId,
    Guid? MemberId,
    DateTimeOffset StartTime
);

public sealed record SessionEnded(
    Guid SessionId,
    Guid TableId,
    TimeSpan Duration
);

public sealed record SessionPaused(
    Guid SessionId,
    Guid TableId
);

public sealed record SessionResumed(
    Guid SessionId,
    Guid TableId
);
\`\`\`

### Billing æ¨¡å—äº‹ä»¶

\`\`\`csharp
public sealed record BillCalculated(
    Guid BillId,
    Guid SessionId,
    decimal TotalAmount
);

public sealed record InvoiceGenerated(
    Guid InvoiceId,
    Guid BillId
);
\`\`\`

---

## ğŸ”— è·¨æ¨¡å—é€šä¿¡

### Sessions æ¨¡å—é€šä¿¡

**å‘é€å‘½ä»¤**:
- â†’ `ReserveTable` (åˆ° Tables æ¨¡å—) - å¼€å§‹æ—¶æ®µæ—¶æ ‡è®°æ¡Œå°å ç”¨
- â†’ `ReleaseTable` (åˆ° Tables æ¨¡å—) - ç»“æŸæ—¶æ®µæ—¶é‡Šæ”¾æ¡Œå°

**å‘å¸ƒäº‹ä»¶**:
- `SessionStarted` â†’ Devices æ¨¡å—ç›‘å¬ï¼ˆè‡ªåŠ¨å¼€ç¯/å¼€é—¨ï¼‰
- `SessionEnded` â†’ Billing æ¨¡å—ç›‘å¬ï¼ˆè‡ªåŠ¨è®¡ç®—è´¦å•ï¼‰

**ç›‘å¬äº‹ä»¶**:
- `PaymentCompleted` (æ¥è‡ª Payments æ¨¡å—) â†’ æ ‡è®°æ—¶æ®µä¸ºå·²å®Œæˆ

### Billing æ¨¡å—é€šä¿¡

**ç›‘å¬äº‹ä»¶**:
- `SessionEnded` (æ¥è‡ª Sessions æ¨¡å—) â†’ è‡ªåŠ¨è§¦å‘è´¦å•è®¡ç®—

**å‘å¸ƒäº‹ä»¶**:
- `BillCalculated` â†’ Payments æ¨¡å—ç›‘å¬ï¼ˆåˆ›å»ºæ”¯ä»˜å•ï¼‰

---

## ğŸ¯ TableSessionSagaï¼ˆæ—¶æ®µç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼‰

\`\`\`csharp
public sealed class TableSessionSaga : Saga
{
    public Guid SessionId { get; set; }
    public Guid TableId { get; set; }
    public Guid? BillId { get; set; }
    public SessionStatus Status { get; set; }
    
    // æ—¶æ®µå¼€å§‹
    public void Handle(SessionStarted @event)
    {
        SessionId = @event.SessionId;
        TableId = @event.TableId;
        Status = SessionStatus.Active;
    }
    
    // æ—¶æ®µç»“æŸ â†’ ç­‰å¾…è´¦å•è®¡ç®—
    public void Handle(SessionEnded @event)
    {
        Status = SessionStatus.Ended;
    }
    
    // è´¦å•è®¡ç®—å®Œæˆ â†’ ç­‰å¾…æ”¯ä»˜
    public void Handle(BillCalculated @event)
    {
        BillId = @event.BillId;
    }
    
    // æ”¯ä»˜å®Œæˆ â†’ æ—¶æ®µå®Œæˆ
    public void Handle(PaymentCompleted @event)
    {
        if (@event.SessionId == SessionId)
        {
            Status = SessionStatus.Completed;
            Complete();  // å®Œæˆ Saga
        }
    }
}
\`\`\`

---

## ğŸ§ª å•å…ƒæµ‹è¯•ç¤ºä¾‹

### StartSessionHandler æµ‹è¯•

\`\`\`csharp
public class StartSessionHandlerTests
{
    [Fact]
    public async Task Handle_ValidTable_StartsSession()
    {
        // Arrange
        var store = DocumentStore.For(opts =>
        {
            opts.Connection("connection string");
            opts.DatabaseSchemaName = "sessions_test";
        });
        
        await using var session = store.LightweightSession();
        var bus = Substitute.For<IMessageBus>();
        
        var table = new Table
        {
            Id = Guid.NewGuid(),
            Name = "1å·æ¡Œ",
            Type = TableType.Chinese,
            Status = TableStatus.Available,
            HourlyRate = 30m
        };
        session.Store(table);
        await session.SaveChangesAsync();
        
        var handler = new StartSessionHandler();
        var command = new StartSession(table.Id, null, "å¼ ä¸‰");
        
        // Act
        var result = await handler.Handle(command, session, bus, CancellationToken.None);
        
        // Assert
        Assert.True(result.IsSuccess);
        Assert.NotEqual(Guid.Empty, result.Value);
        
        var createdSession = await session.LoadAsync<TableSession>(result.Value);
        Assert.NotNull(createdSession);
        Assert.Equal(table.Id, createdSession.TableId);
        Assert.Equal(SessionStatus.Active, createdSession.Status);
        
        await bus.Received(1).PublishAsync(
            Arg.Is<SessionStarted>(e => e.SessionId == result.Value),
            Arg.Any<CancellationToken>()
        );
    }
    
    [Fact]
    public async Task Handle_TableOccupied_ReturnsFailure()
    {
        // Arrange
        var store = DocumentStore.For(opts =>
        {
            opts.Connection("connection string");
            opts.DatabaseSchemaName = "sessions_test";
        });
        
        await using var session = store.LightweightSession();
        var bus = Substitute.For<IMessageBus>();
        
        var table = new Table
        {
            Id = Guid.NewGuid(),
            Name = "1å·æ¡Œ",
            Status = TableStatus.Occupied
        };
        session.Store(table);
        await session.SaveChangesAsync();
        
        var handler = new StartSessionHandler();
        var command = new StartSession(table.Id, null, "æå››");
        
        // Act
        var result = await handler.Handle(command, session, bus, CancellationToken.None);
        
        // Assert
        Assert.False(result.IsSuccess);
        Assert.Equal("Tables:TableUnavailable", result.Error?.Code);
    }
}
\`\`\`

---

## ğŸ“ å¼€å‘è§„èŒƒ

### å‘½åçº¦å®š

- **Command**: åŠ¨è¯å¼€å¤´ï¼Œæè¿°æ“ä½œï¼ˆå¦‚ `StartSession`, `EndSession`ï¼‰
- **Query**: `Get` å¼€å¤´ï¼ˆå¦‚ `GetSession`, `GetBill`ï¼‰
- **Event**: è¿‡å»å¼ï¼Œæè¿°äº‹å®ï¼ˆå¦‚ `SessionStarted`, `BillCalculated`ï¼‰
- **Handler**: `{CommandName}Handler`
- **Endpoint**: `{CommandName}Endpoint`

### éªŒè¯è§„åˆ™

- æ‰€æœ‰å…¬å¼€å‘½ä»¤å¿…é¡»æœ‰ Validator
- ä¸šåŠ¡è§„åˆ™éªŒè¯åœ¨ Handler ä¸­
- ä½¿ç”¨ FluentValidation è¿›è¡Œè¾“å…¥éªŒè¯

### æ—¥å¿—è§„èŒƒ

\`\`\`csharp
_logger.LogInformation(
    "Session {SessionId} started for Table {TableId} by {Customer}",
    sessionId, tableId, customerName ?? $"Member:{memberId}"
);

_logger.LogWarning(
    "Failed to start session for Table {TableId}: {Reason}",
    tableId, errorReason
);
\`\`\`

### é”™è¯¯å¤„ç†

- ä½¿ç”¨ Result æ¨¡å¼è¿”å›é”™è¯¯
- é”™è¯¯ä»£ç æ ¼å¼ï¼š`{ModuleName}:{ErrorKey}`
- ç¤ºä¾‹ï¼š`Sessions:SessionNotFound`, `Billing:InvalidDuration`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)
- [ç³»ç»Ÿæ¨¡å—åˆ’åˆ†](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md)
- [Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—.md)
- [ä¼šå‘˜ç®¡ç†æ¨¡å—](ä¼šå‘˜ç®¡ç†æ¨¡å—.md)
- [æ”¯ä»˜æ¨¡å—](æ”¯ä»˜æ¨¡å—.md)

---

*æœ€åæ›´æ–°: 2024-01-15 | ç‰ˆæœ¬: v2.0.0 | æ¶æ„: Wolverine + å‚ç›´åˆ‡ç‰‡*
