---
title: "æ”¯ä»˜æ¨¡å—"
description: "è‡ªåŠ©å°çƒç³»ç»Ÿæ”¯ä»˜æ¨¡å—è¯¦ç»†è®¾è®¡è¯´æ˜"
version: "2.0.0"
author: "ä¸šåŠ¡æ¶æ„å¸ˆ"
maintainer: "åç«¯å¼€å‘å›¢é˜Ÿ"
created: "2024-01-01"
updated: "2024-01-15"
category: "æ¨¡å—è®¾è®¡"
level: "æ ¸å¿ƒ"
audience: ["åç«¯å¼€å‘å·¥ç¨‹å¸ˆ", "æ”¯ä»˜å·¥ç¨‹å¸ˆ"]
keywords: ["æ”¯ä»˜æ¨¡å—", "æ”¯ä»˜ç½‘å…³", "å¹‚ç­‰æ€§", "é€€æ¬¾ç®¡ç†", "Wolverine", "å‚ç›´åˆ‡ç‰‡"]
tags: ["payment", "gateway", "idempotency", "refund", "vertical-slice"]
dependencies: ["è®¡è´¹æ¨¡å—", "ä¼šå‘˜ç®¡ç†"]
estimated_reading_time: "16åˆ†é’Ÿ"
architecture_status: "æ¶æ„å®ç°å·²æ›´æ–°è‡³ Wolverine"
---

# 4.3 æ”¯ä»˜æ¨¡å—ï¼ˆPaymentsï¼‰

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“¦ æ¨¡å—è®¾è®¡](README.md) > ğŸ’³ æ”¯ä»˜æ¨¡å—

<!-- Keywords for Search -->
**å…³é”®è¯**: `æ”¯ä»˜æ¨¡å—` `æ”¯ä»˜ç½‘å…³` `å¹‚ç­‰æ€§` `é€€æ¬¾ç®¡ç†` `Wolverine` `å‚ç›´åˆ‡ç‰‡`

---

> ## âš ï¸ æ¶æ„å®ç°è¯´æ˜
> 
> æœ¬æ–‡æ¡£æè¿°æ”¯ä»˜æ¨¡å—çš„**ä¸šåŠ¡éœ€æ±‚å’ŒåŠŸèƒ½è¯´æ˜**ã€‚
> 
> **æ¶æ„å®ç°å·²è¿ç§»è‡³ Wolverine + å‚ç›´åˆ‡ç‰‡æ¶æ„**ã€‚ä¸‹æ–‡ä¸­çš„æ¶æ„å›¾å’Œä»£ç ç¤ºä¾‹ä½¿ç”¨æ—§çš„ ABP åˆ†å±‚æ¶æ„æœ¯è¯­ä½œä¸ºä¸šåŠ¡ç†è§£å‚è€ƒã€‚
> 
> ### ğŸ“š å®é™…æ¶æ„å®ç°è¯·å‚è€ƒï¼š
> 
> 1. **[Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)** â­â­â­
>    - æŸ¥çœ‹ Payments æ¨¡å—çš„å®Œæ•´å‚ç›´åˆ‡ç‰‡å®ç°æ–¹å¼
> 
> 2. **[ç³»ç»Ÿæ¨¡å—åˆ’åˆ† - Payments æ¨¡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#6-payments-æ¨¡å—æ”¯ä»˜å¯¹è´¦)** â­â­
>    - Payments æ¨¡å—çš„åŠŸèƒ½åˆ‡ç‰‡ã€é¢†åŸŸæ¨¡å‹ã€å¹‚ç­‰æ€§è®¾è®¡
> 
> 3. **[Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å— - 3.4èŠ‚ Result æ¨¡å¼](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineå¿«é€Ÿä¸Šæ‰‹æŒ‡å—.md#34-åœºæ™¯-4ä½¿ç”¨-result-æ¨¡å¼å¤„ç†é”™è¯¯)** â­â­
>    - æ”¯ä»˜é”™è¯¯å¤„ç†æœ€ä½³å®è·µ
> 
> ### ğŸ“ æ–°æ¶æ„ç›®å½•ç»“æ„ï¼š
> 
> ```
> src/Modules/Payments/
> â”œâ”€â”€ ProcessPayment/
> â”‚   â”œâ”€â”€ ProcessPayment.cs
> â”‚   â”œâ”€â”€ ProcessPaymentHandler.cs
> â”‚   â”œâ”€â”€ ProcessPaymentEndpoint.cs
> â”‚   â””â”€â”€ ProcessPaymentValidator.cs
> â”œâ”€â”€ RefundPayment/
> â”‚   â”œâ”€â”€ RefundPayment.cs
> â”‚   â””â”€â”€ RefundPaymentHandler.cs
> â”œâ”€â”€ ReconcilePayments/
> â”œâ”€â”€ GetPayment/
> â”œâ”€â”€ Events/
> â”‚   â”œâ”€â”€ PaymentCompleted.cs
> â”‚   â”œâ”€â”€ PaymentFailed.cs
> â”‚   â””â”€â”€ PaymentRefunded.cs
> â””â”€â”€ Payment.cs                    # èšåˆæ ¹
> ```
> 
> ### ğŸ”„ æ¶æ„å˜æ›´è¦ç‚¹ï¼š
> 
> | æ—§æ¶æ„ï¼ˆæœ¬æ–‡æ¡£ï¼‰ | æ–°æ¶æ„ï¼ˆWolverineï¼‰ | è¯´æ˜ |
> |----------------|-------------------|------|
> | æ”¯ä»˜æœåŠ¡ (PaymentAppService) | ProcessPaymentHandler | æŒ‰åŠŸèƒ½åˆ‡ç‰‡ |
> | æ”¯ä»˜ç½‘å…³é€‚é…å™¨ | IPaymentGatewayï¼ˆæ³¨å…¥ Handlerï¼‰ | ä¾èµ–æ³¨å…¥ç®€åŒ– |
> | å¹‚ç­‰æ€§æ§åˆ¶ | Handler å†…æ£€æŸ¥ OrderId | ä¸šåŠ¡é€»è¾‘å†…èš |
> | ä»“å‚¨ (Repository) | IDocumentSession (Marten) | ç›´æ¥ä½¿ç”¨ Marten |
> | é‡è¯•ç­–ç•¥ | Wolverine ç­–ç•¥é…ç½® | æ¡†æ¶çº§æ”¯æŒ |

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

æ”¯ä»˜æ¨¡å—æ˜¯è‡ªåŠ©å°çƒç³»ç»Ÿçš„å…³é”®è´¢åŠ¡æ¨¡å—ï¼Œè´Ÿè´£é›†æˆå¤šç§æ”¯ä»˜æ–¹å¼ã€ç¡®ä¿æ”¯ä»˜å®‰å…¨ã€å¤„ç†é€€æ¬¾ç”³è¯·ã€å®ç°å¹‚ç­‰æ€§æ§åˆ¶ç­‰åŠŸèƒ½ã€‚è¯¥æ¨¡å—ä¸ºç”¨æˆ·æä¾›ä¾¿æ·ã€å®‰å…¨çš„æ”¯ä»˜ä½“éªŒï¼Œä¸ºä¸šåŠ¡æä¾›å¯é çš„èµ„é‡‘ç»“ç®—ä¿éšœã€‚

### æ ¸å¿ƒèŒè´£

- ğŸ’° **å¤šæ¸ é“æ”¯ä»˜**: æ”¯æŒå¾®ä¿¡æ”¯ä»˜ã€æ”¯ä»˜å®ã€é“¶è”ç­‰ä¸»æµæ”¯ä»˜æ–¹å¼
- ğŸ”’ **æ”¯ä»˜å®‰å…¨**: æ”¯ä»˜æ•°æ®åŠ å¯†ã€é˜²é‡æ”¾æ”»å‡»ã€é£æ§æ£€æµ‹
- ğŸ”„ **å¹‚ç­‰æ€§æ§åˆ¶**: é˜²é‡å¤æ”¯ä»˜ã€è®¢å•çŠ¶æ€ä¸€è‡´æ€§ä¿éšœ
- ğŸ’¸ **é€€æ¬¾ç®¡ç†**: è‡ªåŠ¨/æ‰‹åŠ¨é€€æ¬¾ã€é€€æ¬¾çŠ¶æ€è·Ÿè¸ª
- ğŸ“Š **å¯¹è´¦ç»“ç®—**: æ”¯ä»˜æ•°æ®å¯¹è´¦ã€è´¢åŠ¡ç»“ç®—æŠ¥è¡¨

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ¨¡å—æ¶æ„å›¾

```mermaid
graph TB
    subgraph "æ”¯ä»˜æ¨¡å—"
        subgraph "åº”ç”¨æœåŠ¡å±‚"
            AS1[æ”¯ä»˜æœåŠ¡]
            AS2[é€€æ¬¾æœåŠ¡]
            AS3[å¯¹è´¦æœåŠ¡]
            AS4[é€šçŸ¥æœåŠ¡]
        end
        
        subgraph "é¢†åŸŸæœåŠ¡å±‚"
            DS1[æ”¯ä»˜å¼•æ“]
            DS2[æ”¯ä»˜ç½‘å…³é€‚é…å™¨]
            DS3[å¹‚ç­‰æ€§æ§åˆ¶å™¨]
            DS4[é£æ§æ£€æµ‹å™¨]
        end
        
        subgraph "é¢†åŸŸæ¨¡å‹å±‚"
            E1[æ”¯ä»˜è®¢å•å®ä½“]
            E2[é€€æ¬¾è®°å½•å®ä½“]
            E3[æ”¯ä»˜é€šé“å®ä½“]
            VO1[æ”¯ä»˜ç»“æœå€¼å¯¹è±¡]
        end
        
        subgraph "åŸºç¡€è®¾æ–½å±‚"
            R1[æ”¯ä»˜è®¢å•ä»“å‚¨]
            R2[é€€æ¬¾è®°å½•ä»“å‚¨]
            G1[å¾®ä¿¡æ”¯ä»˜ç½‘å…³]
            G2[æ”¯ä»˜å®ç½‘å…³]
            G3[é“¶è”æ”¯ä»˜ç½‘å…³]
            MQ1[æ¶ˆæ¯é˜Ÿåˆ—]
        end
    end
    
    AS1 --> DS1
    AS2 --> DS1
    AS3 --> DS2
    AS4 --> MQ1
    
    DS1 --> DS2
    DS1 --> DS3
    DS1 --> DS4
    
    DS1 --> E1
    DS1 --> VO1
    DS2 --> E2
    
    E1 --> R1
    E2 --> R2
    
    DS2 --> G1
    DS2 --> G2
    DS2 --> G3
```

### æ”¯ä»˜ä¸šåŠ¡æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant P as æ”¯ä»˜æœåŠ¡
    participant I as å¹‚ç­‰æ€§æ§åˆ¶å™¨
    participant G as æ”¯ä»˜ç½‘å…³
    participant B as è®¡è´¹æ¨¡å—
    participant N as é€šçŸ¥æœåŠ¡
    
    U->>P: å‘èµ·æ”¯ä»˜è¯·æ±‚
    P->>I: å¹‚ç­‰æ€§æ£€æŸ¥
    I-->>P: é€šè¿‡æ£€æŸ¥
    P->>P: åˆ›å»ºæ”¯ä»˜è®¢å•
    P->>G: è°ƒç”¨æ”¯ä»˜ç½‘å…³
    G-->>P: è¿”å›æ”¯ä»˜é“¾æ¥
    P-->>U: è¿”å›æ”¯ä»˜ä¿¡æ¯
    
    U->>G: å®Œæˆæ”¯ä»˜
    G->>P: æ”¯ä»˜å›è°ƒé€šçŸ¥
    P->>I: å¹‚ç­‰æ€§éªŒè¯
    I-->>P: éªŒè¯é€šè¿‡
    P->>P: æ›´æ–°è®¢å•çŠ¶æ€
    P->>B: é€šçŸ¥è®¡è´¹å®Œæˆ
    P->>N: å‘é€æ”¯ä»˜é€šçŸ¥
    N-->>U: æ”¯ä»˜æˆåŠŸé€šçŸ¥
```

---

## ğŸ“Š æ•°æ®æ¨¡å‹è®¾è®¡

### æ ¸å¿ƒå®ä½“

#### æ”¯ä»˜è®¢å•å®ä½“ (PaymentOrder)

```csharp
public class PaymentOrder : AuditedAggregateRoot<Guid>
{
    public string OrderNumber { get; set; }
    public Guid UserId { get; set; }
    public Guid? BillingSessionId { get; set; }
    public PaymentChannel Channel { get; set; }
    public decimal Amount { get; set; }
    public string Currency { get; set; }
    public PaymentStatus Status { get; set; }
    public string Subject { get; set; }
    public string Description { get; set; }
    public string ExternalOrderId { get; set; }
    public string ExternalTransactionId { get; set; }
    public DateTime? PaidTime { get; set; }
    public DateTime ExpireTime { get; set; }
    public string NotifyUrl { get; set; }
    public string ReturnUrl { get; set; }
    public string ClientIp { get; set; }
    public string RiskInfo { get; set; }
    
    // å¯¼èˆªå±æ€§
    public User User { get; set; }
    public BillingSession BillingSession { get; set; }
    public ICollection<PaymentNotification> Notifications { get; set; }
    public ICollection<RefundRecord> RefundRecords { get; set; }
}

public enum PaymentChannel
{
    WeChat = 1,      // å¾®ä¿¡æ”¯ä»˜
    Alipay = 2,      // æ”¯ä»˜å®
    UnionPay = 3,    // é“¶è”æ”¯ä»˜
    Balance = 4      // ä½™é¢æ”¯ä»˜
}

public enum PaymentStatus
{
    Pending = 1,     // å¾…æ”¯ä»˜
    Processing = 2,  // å¤„ç†ä¸­
    Paid = 3,        // å·²æ”¯ä»˜
    Failed = 4,      // æ”¯ä»˜å¤±è´¥
    Cancelled = 5,   // å·²å–æ¶ˆ
    Refunded = 6,    // å·²é€€æ¬¾
    PartialRefund = 7 // éƒ¨åˆ†é€€æ¬¾
}
```

#### é€€æ¬¾è®°å½•å®ä½“ (RefundRecord)

```csharp
public class RefundRecord : AuditedAggregateRoot<Guid>
{
    public Guid PaymentOrderId { get; set; }
    public string RefundNumber { get; set; }
    public decimal RefundAmount { get; set; }
    public RefundReason Reason { get; set; }
    public string ReasonDescription { get; set; }
    public RefundStatus Status { get; set; }
    public RefundType Type { get; set; }
    public string ExternalRefundId { get; set; }
    public DateTime? RefundTime { get; set; }
    public string ApprovalUser { get; set; }
    public DateTime? ApprovalTime { get; set; }
    public string ApprovalNotes { get; set; }
    
    // å¯¼èˆªå±æ€§
    public PaymentOrder PaymentOrder { get; set; }
    public ICollection<RefundNotification> Notifications { get; set; }
}

public enum RefundReason
{
    UserRequest = 1,     // ç”¨æˆ·ç”³è¯·
    DeviceFailure = 2,   // è®¾å¤‡æ•…éšœ
    SystemError = 3,     // ç³»ç»Ÿé”™è¯¯
    ServiceIssue = 4     // æœåŠ¡é—®é¢˜
}

public enum RefundStatus
{
    Pending = 1,     // å¾…å¤„ç†
    Processing = 2,  // å¤„ç†ä¸­
    Completed = 3,   // å·²å®Œæˆ
    Failed = 4,      // é€€æ¬¾å¤±è´¥
    Cancelled = 5    // å·²å–æ¶ˆ
}

public enum RefundType
{
    Automatic = 1,   // è‡ªåŠ¨é€€æ¬¾
    Manual = 2       // æ‰‹åŠ¨é€€æ¬¾
}
```

#### æ”¯ä»˜é€šçŸ¥å®ä½“ (PaymentNotification)

```csharp
public class PaymentNotification : CreationAuditedEntity<Guid>
{
    public Guid PaymentOrderId { get; set; }
    public PaymentChannel Channel { get; set; }
    public string NotificationId { get; set; }
    public string NotificationData { get; set; }
    public string Signature { get; set; }
    public bool IsVerified { get; set; }
    public bool IsProcessed { get; set; }
    public string ProcessResult { get; set; }
    public DateTime? ProcessTime { get; set; }
    public int RetryCount { get; set; }
    
    // å¯¼èˆªå±æ€§
    public PaymentOrder PaymentOrder { get; set; }
}
```

### å®ä½“å…³ç³»å›¾

```mermaid
erDiagram
    PaymentOrder ||--o{ RefundRecord : has
    PaymentOrder ||--o{ PaymentNotification : receives
    User ||--o{ PaymentOrder : creates
    BillingSession ||--o{ PaymentOrder : generates
    
    PaymentOrder {
        guid Id PK
        string OrderNumber
        guid UserId FK
        guid BillingSessionId FK
        int Channel
        decimal Amount
        int Status
        datetime PaidTime
        datetime ExpireTime
    }
    
    RefundRecord {
        guid Id PK
        guid PaymentOrderId FK
        string RefundNumber
        decimal RefundAmount
        int Reason
        int Status
        datetime RefundTime
    }
    
    PaymentNotification {
        guid Id PK
        guid PaymentOrderId FK
        string NotificationId
        string NotificationData
        bool IsProcessed
        datetime ProcessTime
    }
```

---

## ğŸ”§ æ¥å£è®¾è®¡

### æ”¯ä»˜ç®¡ç†æ¥å£

```csharp
public interface IPaymentAppService : IApplicationService
{
    Task<PaymentOrderDto> CreatePaymentOrderAsync(CreatePaymentOrderDto input);
    Task<PaymentResultDto> ProcessPaymentAsync(ProcessPaymentDto input);
    Task<PaymentOrderDto> GetPaymentOrderAsync(Guid orderId);
    Task<PaymentOrderDto> GetPaymentOrderByNumberAsync(string orderNumber);
    Task<string> HandlePaymentNotificationAsync(PaymentChannel channel, string notificationData);
    Task<List<PaymentOrderDto>> GetUserPaymentHistoryAsync(GetPaymentHistoryDto input);
}
```

### é€€æ¬¾ç®¡ç†æ¥å£

```csharp
public interface IRefundAppService : IApplicationService
{
    Task<RefundRecordDto> CreateRefundAsync(CreateRefundDto input);
    Task<RefundRecordDto> ProcessRefundAsync(ProcessRefundDto input);
    Task<RefundRecordDto> GetRefundRecordAsync(Guid refundId);
    Task<List<RefundRecordDto>> GetRefundHistoryAsync(GetRefundHistoryDto input);
    Task ApproveRefundAsync(Guid refundId, ApproveRefundDto input);
    Task RejectRefundAsync(Guid refundId, RejectRefundDto input);
}
```

### æ”¯ä»˜ç½‘å…³æ¥å£

```csharp
public interface IPaymentGateway
{
    PaymentChannel Channel { get; }
    Task<PaymentResponseDto> CreatePaymentAsync(PaymentRequestDto request);
    Task<PaymentStatusDto> QueryPaymentStatusAsync(string externalOrderId);
    Task<RefundResponseDto> CreateRefundAsync(RefundRequestDto request);
    Task<RefundStatusDto> QueryRefundStatusAsync(string externalRefundId);
    bool VerifyNotification(string notificationData, string signature);
    PaymentNotificationDto ParseNotification(string notificationData);
}
```

---

## ğŸ”’ æ”¯ä»˜å®‰å…¨è®¾è®¡

### å¹‚ç­‰æ€§æ§åˆ¶

```csharp
public class PaymentIdempotencyService
{
    private readonly IDistributedCache _cache;
    
    public async Task<bool> CheckIdempotencyAsync(string idempotencyKey, TimeSpan expiration)
    {
        var cacheKey = $"payment_idempotency:{idempotencyKey}";
        var existingValue = await _cache.GetStringAsync(cacheKey);
        
        if (existingValue != null)
        {
            return false; // å·²å­˜åœ¨ï¼Œä¸å…è®¸é‡å¤æ‰§è¡Œ
        }
        
        await _cache.SetStringAsync(cacheKey, DateTime.UtcNow.ToString(), 
            new DistributedCacheEntryOptions { AbsoluteExpirationRelativeToNow = expiration });
        
        return true; // å…è®¸æ‰§è¡Œ
    }
}
```

### ç­¾åéªŒè¯

```csharp
public class PaymentSignatureVerifier
{
    public bool VerifyWeChatSignature(string data, string signature, string key)
    {
        var computedSignature = ComputeHmacSha256(data, key);
        return string.Equals(signature, computedSignature, StringComparison.OrdinalIgnoreCase);
    }
    
    public bool VerifyAlipaySignature(string data, string signature, string publicKey)
    {
        using var rsa = RSA.Create();
        rsa.ImportFromPem(publicKey);
        
        var dataBytes = Encoding.UTF8.GetBytes(data);
        var signatureBytes = Convert.FromBase64String(signature);
        
        return rsa.VerifyData(dataBytes, signatureBytes, HashAlgorithmName.SHA256, RSASignaturePadding.Pkcs1);
    }
}
```

### é£æ§æ£€æµ‹

```csharp
public class PaymentRiskDetector
{
    public async Task<RiskAssessmentResult> AssessPaymentRiskAsync(PaymentOrder order)
    {
        var riskScore = 0;
        var riskFactors = new List<string>();
        
        // æ£€æŸ¥ç”¨æˆ·æ”¯ä»˜é¢‘ç‡
        if (await IsHighFrequencyUserAsync(order.UserId))
        {
            riskScore += 20;
            riskFactors.Add("é«˜é¢‘æ”¯ä»˜ç”¨æˆ·");
        }
        
        // æ£€æŸ¥æ”¯ä»˜é‡‘é¢å¼‚å¸¸
        if (await IsAbnormalAmountAsync(order.UserId, order.Amount))
        {
            riskScore += 30;
            riskFactors.Add("å¼‚å¸¸æ”¯ä»˜é‡‘é¢");
        }
        
        // æ£€æŸ¥IPåœ°å€é£é™©
        if (await IsRiskyIpAsync(order.ClientIp))
        {
            riskScore += 40;
            riskFactors.Add("é£é™©IPåœ°å€");
        }
        
        return new RiskAssessmentResult
        {
            RiskScore = riskScore,
            RiskLevel = GetRiskLevel(riskScore),
            RiskFactors = riskFactors
        };
    }
}
```

---

## ğŸ“‹ ä¸šåŠ¡è§„åˆ™

### æ”¯ä»˜è§„åˆ™

| æ”¯ä»˜æ–¹å¼ | æœ€å°é‡‘é¢ | æœ€å¤§é‡‘é¢ | æ‰‹ç»­è´¹ | åˆ°è´¦æ—¶é—´ |
|----------|----------|----------|---------|----------|
| å¾®ä¿¡æ”¯ä»˜ | 0.01å…ƒ | 5000å…ƒ | 0.6% | å®æ—¶ |
| æ”¯ä»˜å® | 0.01å…ƒ | 5000å…ƒ | 0.55% | å®æ—¶ |
| é“¶è”æ”¯ä»˜ | 1å…ƒ | 10000å…ƒ | 0.5% | T+1 |
| ä½™é¢æ”¯ä»˜ | 0.01å…ƒ | è´¦æˆ·ä½™é¢ | å…è´¹ | å®æ—¶ |

### é€€æ¬¾è§„åˆ™

**è‡ªåŠ¨é€€æ¬¾æ¡ä»¶**:
- ğŸ”§ è®¾å¤‡æ•…éšœå¯¼è‡´æ— æ³•æ­£å¸¸ä½¿ç”¨
- âš ï¸ ç³»ç»Ÿé”™è¯¯å¯¼è‡´é‡å¤æ‰£è´¹
- ğŸ• æœåŠ¡æœªå¼€å§‹å‰çš„å–æ¶ˆç”³è¯·
- ğŸ’° å……å€¼åç«‹å³ç”³è¯·é€€æ¬¾ï¼ˆ7å¤©å†…ï¼‰

**é€€æ¬¾å¤„ç†æ—¶é—´**:
- ğŸ’³ å¾®ä¿¡æ”¯ä»˜ï¼š1-3ä¸ªå·¥ä½œæ—¥
- ğŸ’³ æ”¯ä»˜å®ï¼š1-7ä¸ªå·¥ä½œæ—¥  
- ğŸ’³ é“¶è”æ”¯ä»˜ï¼š3-15ä¸ªå·¥ä½œæ—¥
- ğŸ’° ä½™é¢é€€æ¬¾ï¼šå®æ—¶åˆ°è´¦

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å¼‚æ­¥å¤„ç†

```csharp
public class PaymentEventHandler : IEventHandler<PaymentCompletedEvent>
{
    public async Task HandleEventAsync(PaymentCompletedEvent eventData)
    {
        // å¼‚æ­¥å¤„ç†æ”¯ä»˜å®Œæˆåçš„ä¸šåŠ¡é€»è¾‘
        await Task.Run(async () =>
        {
            // æ›´æ–°ç”¨æˆ·ç§¯åˆ†
            await _memberService.AddPointsAsync(eventData.UserId, eventData.Points);
            
            // å‘é€æ”¯ä»˜æˆåŠŸé€šçŸ¥
            await _notificationService.SendPaymentSuccessNotificationAsync(eventData.OrderId);
            
            // æ›´æ–°è´¢åŠ¡ç»Ÿè®¡
            await _statisticsService.UpdatePaymentStatisticsAsync(eventData);
        });
    }
}
```

### ç¼“å­˜ç­–ç•¥

```csharp
// æ”¯ä»˜è®¢å•ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
[CachePut(CacheNames.PaymentOrder, "{orderId}", Duration = 1800)]
public async Task<PaymentOrder> GetPaymentOrderAsync(Guid orderId)

// æ”¯ä»˜ç½‘å…³é…ç½®ç¼“å­˜ï¼ˆ1å°æ—¶ï¼‰
[CachePut(CacheNames.PaymentGatewayConfig, Duration = 3600)]
public async Task<List<PaymentGatewayConfig>> GetGatewayConfigsAsync()
```

---

## ğŸ“Š ç›‘æ§ä¸å¯¹è´¦

### ç›‘æ§æŒ‡æ ‡

```csharp
public class PaymentMetrics
{
    // æ”¯ä»˜æˆåŠŸç‡
    public decimal PaymentSuccessRate { get; set; }
    
    // å¹³å‡æ”¯ä»˜æ—¶é—´
    public TimeSpan AveragePaymentTime { get; set; }
    
    // æ”¯ä»˜é‡‘é¢ç»Ÿè®¡
    public PaymentAmountStatistics AmountStatistics { get; set; }
    
    // æ¸ é“åˆ†å¸ƒ
    public Dictionary<PaymentChannel, int> ChannelDistribution { get; set; }
    
    // å¼‚å¸¸è®¢å•æ•°é‡
    public int ExceptionOrderCount { get; set; }
}
```

### å¯¹è´¦æµç¨‹

```mermaid
graph LR
    A[è·å–ç¬¬ä¸‰æ–¹å¯¹è´¦å•] --> B[è§£æå¯¹è´¦æ•°æ®]
    B --> C[ä¸æœ¬åœ°è®¢å•æ¯”å¯¹]
    C --> D{æ•°æ®æ˜¯å¦ä¸€è‡´}
    
    D -->|æ˜¯| E[å¯¹è´¦æˆåŠŸ]
    D -->|å¦| F[æ ‡è®°å·®å¼‚è®¢å•]
    
    F --> G[äººå·¥å®¡æ ¸]
    G --> H[å·®å¼‚å¤„ç†]
    H --> I[æ›´æ–°è®¢å•çŠ¶æ€]
    
    E --> J[ç”Ÿæˆå¯¹è´¦æŠ¥è¡¨]
    I --> J
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- **ä¸Šçº§æ–‡æ¡£**: [æ¨¡å—è®¾è®¡æ€»è§ˆ](README.md)
- **å…³è”æ–‡æ¡£**: [å°çƒæ¡Œè®¡è´¹æ¨¡å—](å°çƒæ¡Œè®¡è´¹æ¨¡å—.md) | [ä¼šå‘˜ç®¡ç†æ¨¡å—](ä¼šå‘˜ç®¡ç†æ¨¡å—.md)
- **æŠ€æœ¯æ–‡æ¡£**: [æ”¯ä»˜ç½‘å…³é›†æˆ](../07_APIæ–‡æ¡£/æ”¯ä»˜æ¥å£.md)
- **è¿”å›**: [é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md)

---

*æœ€åæ›´æ–°: 2024-01-15 | ç‰ˆæœ¬: v1.0.0*
