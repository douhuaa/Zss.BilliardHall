---
title: "æ”¯ä»˜æ¨¡å—ï¼ˆPaymentsï¼‰"
description: "åŸºäº Wolverine å‚ç›´åˆ‡ç‰‡æ¶æ„çš„æ”¯ä»˜æµç¨‹ä¸å¯¹è´¦ç®¡ç†æ¨¡å—è®¾è®¡"
version: "2.0.0"
author: "æ¶æ„å›¢é˜Ÿ"
maintainer: "åç«¯å¼€å‘å›¢é˜Ÿ"
created: "2024-01-15"
updated: "2024-01-15"
category: "æ¨¡å—è®¾è®¡"
level: "æ ¸å¿ƒ"
audience: ["åç«¯å¼€å‘å·¥ç¨‹å¸ˆ", "æ”¯ä»˜å·¥ç¨‹å¸ˆ"]
keywords: ["Payments", "æ”¯ä»˜", "å¹‚ç­‰æ€§", "é€€æ¬¾", "Wolverine", "å‚ç›´åˆ‡ç‰‡"]
tags: ["payments", "gateway", "idempotency", "refund", "vertical-slice", "wolverine"]
dependencies: ["ç³»ç»Ÿæ¶æ„è®¾è®¡", "Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾"]
estimated_reading_time: "22åˆ†é’Ÿ"
architecture: "Wolverine + å‚ç›´åˆ‡ç‰‡"
---

# æ”¯ä»˜æ¨¡å—ï¼ˆPaymentsï¼‰

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“¦ æ¨¡å—è®¾è®¡](README.md) > ğŸ’³ æ”¯ä»˜æ¨¡å—

<!-- Keywords for Search -->
**å…³é”®è¯**: `Payments` `æ”¯ä»˜æ¨¡å—` `å¹‚ç­‰æ€§` `é€€æ¬¾ç®¡ç†` `Wolverine` `å‚ç›´åˆ‡ç‰‡`

---

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

æ”¯ä»˜æ¨¡å—ï¼ˆPaymentsï¼‰è´Ÿè´£ç®¡ç†æ”¯ä»˜æµç¨‹ã€å¯¹è´¦ã€é€€æ¬¾å’Œæ”¯ä»˜å†å²ï¼Œé‡‡ç”¨ **Wolverine + å‚ç›´åˆ‡ç‰‡æ¶æ„**ã€‚

### æ ¸å¿ƒèŒè´£

- ğŸ’³ **æ”¯ä»˜å¤„ç†**: æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼ï¼ˆç°é‡‘/æ”¯ä»˜å®/å¾®ä¿¡/ä¼šå‘˜ä½™é¢ï¼‰
- ğŸ”’ **å¹‚ç­‰æ€§ä¿è¯**: ä½¿ç”¨å¹‚ç­‰æ€§å¯†é’¥é˜²æ­¢é‡å¤æ”¯ä»˜
- ğŸ’° **é€€æ¬¾ç®¡ç†**: é€€æ¬¾ç”³è¯·ã€å®¡æ ¸ã€æ‰§è¡Œ
- ğŸ“Š **å¯¹è´¦ç®¡ç†**: æ—¥å¯¹è´¦ã€æœˆå¯¹è´¦ã€å¼‚å¸¸å¤„ç†
- ğŸ“ˆ **è¥æ”¶æŠ¥è¡¨**: æ—¥è¥æ”¶ã€æœˆè¥æ”¶ã€æ”¯ä»˜æ–¹å¼ç»Ÿè®¡

### æ¶æ„å‚è€ƒ

> ğŸ“š **å®Œæ•´æ¶æ„å®ç°**: [Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)
> 
> ğŸ“š **æ¨¡å—è¾¹ç•Œå®šä¹‰**: [ç³»ç»Ÿæ¨¡å—åˆ’åˆ† - Payments æ¨¡å—](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md#6-payments-æ¨¡å—æ”¯ä»˜å¯¹è´¦)

---

## ğŸ—ï¸ æ¨¡å—ç»“æ„ï¼ˆå‚ç›´åˆ‡ç‰‡ï¼‰

### ç›®å½•ç»„ç»‡

\`\`\`
src/Modules/Payments/
â”œâ”€â”€ ProcessPayment/
â”‚   â”œâ”€â”€ ProcessPayment.cs              # Command
â”‚   â”œâ”€â”€ ProcessPaymentHandler.cs       # Handler
â”‚   â”œâ”€â”€ ProcessPaymentEndpoint.cs      # HTTP Endpoint
â”‚   â””â”€â”€ ProcessPaymentValidator.cs     # Validator
â”‚
â”œâ”€â”€ RefundPayment/
â”‚   â”œâ”€â”€ RefundPayment.cs
â”‚   â”œâ”€â”€ RefundPaymentHandler.cs
â”‚   â””â”€â”€ RefundPaymentEndpoint.cs
â”‚
â”œâ”€â”€ ReconcilePayments/
â”‚   â”œâ”€â”€ ReconcilePayments.cs
â”‚   â”œâ”€â”€ ReconcilePaymentsHandler.cs
â”‚   â””â”€â”€ ReconciliationService.cs       # å¯¹è´¦æœåŠ¡
â”‚
â”œâ”€â”€ GetPayment/
â”‚   â”œâ”€â”€ GetPayment.cs                  # Query
â”‚   â”œâ”€â”€ GetPaymentHandler.cs
â”‚   â””â”€â”€ GetPaymentEndpoint.cs
â”‚
â”œâ”€â”€ GetPaymentHistory/
â”‚   â”œâ”€â”€ GetPaymentHistory.cs
â”‚   â””â”€â”€ GetPaymentHistoryHandler.cs
â”‚
â”œâ”€â”€ GetDailyRevenue/
â”‚   â”œâ”€â”€ GetDailyRevenue.cs
â”‚   â””â”€â”€ GetDailyRevenueHandler.cs
â”‚
â”œâ”€â”€ Events/
â”‚   â”œâ”€â”€ PaymentCompleted.cs            # æ”¯ä»˜å®Œæˆ
â”‚   â”œâ”€â”€ PaymentFailed.cs               # æ”¯ä»˜å¤±è´¥
â”‚   â””â”€â”€ PaymentRefunded.cs             # å·²é€€æ¬¾
â”‚
â”œâ”€â”€ Handlers/
â”‚   â””â”€â”€ BillCalculatedHandler.cs       # ç›‘å¬ BillCalculated äº‹ä»¶ â†’ åˆ›å»ºæ”¯ä»˜å•
â”‚
â”œâ”€â”€ Payment.cs                          # èšåˆæ ¹
â”œâ”€â”€ PaymentMethod.cs                    # æšä¸¾ï¼šæ”¯ä»˜æ–¹å¼
â”œâ”€â”€ PaymentStatus.cs                    # æšä¸¾ï¼šæ”¯ä»˜çŠ¶æ€
â””â”€â”€ PaymentsModule.cs                   # æ¨¡å—æ ‡è®°
\`\`\`

---

## ğŸ’» åŠŸèƒ½åˆ‡ç‰‡å®ç°

### 1. ProcessPaymentï¼ˆå¤„ç†æ”¯ä»˜ï¼‰

#### Command å®šä¹‰

\`\`\`csharp
public sealed record ProcessPayment(
    Guid BillId,
    Guid SessionId,
    decimal Amount,
    PaymentMethod Method,
    Guid? MemberId,
    string IdempotencyKey           // å¹‚ç­‰æ€§å¯†é’¥
);
\`\`\`

#### Handler å®ç°

\`\`\`csharp
public sealed class ProcessPaymentHandler
{
    [Transactional]
    public async Task<Result<Guid>> Handle(
        ProcessPayment command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        // 1. å¹‚ç­‰æ€§æ£€æŸ¥ï¼šæ£€æŸ¥æ˜¯å¦å·²å¤„ç†ç›¸åŒçš„å¹‚ç­‰æ€§å¯†é’¥
        var existingPayment = await session.Query<Payment>()
            .FirstOrDefaultAsync(p => p.IdempotencyKey == command.IdempotencyKey, ct);
        
        if (existingPayment != null)
        {
            if (existingPayment.Status == PaymentStatus.Completed)
                return Result.Ok(existingPayment.Id);  // å·²å®Œæˆï¼Œè¿”å›åŸæ”¯ä»˜ID
            
            if (existingPayment.Status == PaymentStatus.Processing)
                return Result.Fail<Guid>("Payments:PaymentProcessing", "æ”¯ä»˜æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å");
        }
        
        // 2. éªŒè¯è´¦å•
        var bill = await session.LoadAsync<Bill>(command.BillId, ct);
        if (bill == null)
            return Result.Fail<Guid>("Payments:BillNotFound", "è´¦å•ä¸å­˜åœ¨");
        
        if (bill.TotalAmount != command.Amount)
            return Result.Fail<Guid>("Payments:AmountMismatch", "æ”¯ä»˜é‡‘é¢ä¸è´¦å•ä¸ç¬¦");
        
        // 3. åˆ›å»ºæ”¯ä»˜è®°å½•
        var payment = new Payment
        {
            Id = Guid.NewGuid(),
            BillId = command.BillId,
            SessionId = command.SessionId,
            MemberId = command.MemberId,
            Amount = command.Amount,
            Method = command.Method,
            Status = PaymentStatus.Processing,
            IdempotencyKey = command.IdempotencyKey,
            CreatedAt = DateTimeOffset.UtcNow
        };
        
        session.Store(payment);
        await session.SaveChangesAsync(ct);
        
        // 4. å¤„ç†ä¸åŒæ”¯ä»˜æ–¹å¼
        var result = command.Method switch
        {
            PaymentMethod.MemberBalance => await ProcessMemberBalancePayment(
                command.MemberId!.Value, command.Amount, session, bus, ct),
            PaymentMethod.Cash => ProcessCashPayment(),
            PaymentMethod.Alipay => await ProcessAlipayPayment(payment.Id, command.Amount),
            PaymentMethod.WeChatPay => await ProcessWeChatPayment(payment.Id, command.Amount),
            _ => Result.Fail("Payments:UnsupportedMethod", "ä¸æ”¯æŒçš„æ”¯ä»˜æ–¹å¼")
        };
        
        if (!result.IsSuccess)
        {
            payment.Status = PaymentStatus.Failed;
            payment.FailureReason = result.Error?.Message;
            session.Store(payment);
            await session.SaveChangesAsync(ct);
            
            await bus.PublishAsync(new PaymentFailed(payment.Id, command.SessionId), ct);
            return Result.Fail<Guid>(result.Error!.Code, result.Error.Message);
        }
        
        // 5. æ ‡è®°æ”¯ä»˜å®Œæˆ
        payment.Status = PaymentStatus.Completed;
        payment.CompletedAt = DateTimeOffset.UtcNow;
        payment.TransactionId = result.Value as string;
        
        session.Store(payment);
        await session.SaveChangesAsync(ct);
        
        // 6. å‘å¸ƒæ”¯ä»˜å®Œæˆäº‹ä»¶
        await bus.PublishAsync(new PaymentCompleted(
            payment.Id,
            command.SessionId,
            command.MemberId,
            command.Amount
        ), ct);
        
        return Result.Ok(payment.Id);
    }
    
    private async Task<Result> ProcessMemberBalancePayment(
        Guid memberId,
        decimal amount,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct)
    {
        // å‘é€å‘½ä»¤åˆ° Members æ¨¡å—æ‰£å‡ä½™é¢
        return await bus.InvokeAsync<Result>(
            new DeductBalance(memberId, amount, "å°çƒæ¶ˆè´¹"),
            ct
        );
    }
    
    private Result ProcessCashPayment()
    {
        // ç°é‡‘æ”¯ä»˜ç›´æ¥æˆåŠŸ
        return Result.Ok();
    }
    
    private async Task<Result> ProcessAlipayPayment(Guid paymentId, decimal amount)
    {
        // TODO: è°ƒç”¨æ”¯ä»˜å® SDK
        await Task.Delay(100);  // æ¨¡æ‹Ÿè°ƒç”¨
        return Result.Ok($"ALIPAY_{paymentId}");
    }
    
    private async Task<Result> ProcessWeChatPayment(Guid paymentId, decimal amount)
    {
        // TODO: è°ƒç”¨å¾®ä¿¡æ”¯ä»˜ SDK
        await Task.Delay(100);  // æ¨¡æ‹Ÿè°ƒç”¨
        return Result.Ok($"WECHAT_{paymentId}");
    }
}
\`\`\`

#### HTTP Endpoint

\`\`\`csharp
public sealed class ProcessPaymentEndpoint
{
    [WolverinePost("/api/payments/process")]
    public static ProcessPayment Post(ProcessPaymentRequest request, HttpContext httpContext)
    {
        // ä»è¯·æ±‚å¤´è·å–å¹‚ç­‰æ€§å¯†é’¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”Ÿæˆ
        var idempotencyKey = httpContext.Request.Headers["X-Idempotency-Key"].FirstOrDefault()
            ?? Guid.NewGuid().ToString();
        
        return new ProcessPayment(
            request.BillId,
            request.SessionId,
            request.Amount,
            request.Method,
            request.MemberId,
            idempotencyKey
        );
    }
}

public sealed record ProcessPaymentRequest(
    Guid BillId,
    Guid SessionId,
    decimal Amount,
    PaymentMethod Method,
    Guid? MemberId
);
\`\`\`

#### Validator

\`\`\`csharp
public sealed class ProcessPaymentValidator : AbstractValidator<ProcessPayment>
{
    public ProcessPaymentValidator()
    {
        RuleFor(x => x.BillId)
            .NotEmpty().WithMessage("BillId ä¸èƒ½ä¸ºç©º");
        
        RuleFor(x => x.SessionId)
            .NotEmpty().WithMessage("SessionId ä¸èƒ½ä¸ºç©º");
        
        RuleFor(x => x.Amount)
            .GreaterThan(0).WithMessage("æ”¯ä»˜é‡‘é¢å¿…é¡»å¤§äº0");
        
        RuleFor(x => x.IdempotencyKey)
            .NotEmpty().WithMessage("å¹‚ç­‰æ€§å¯†é’¥ä¸èƒ½ä¸ºç©º");
        
        When(x => x.Method == PaymentMethod.MemberBalance, () =>
        {
            RuleFor(x => x.MemberId)
                .NotEmpty().WithMessage("ä½¿ç”¨ä¼šå‘˜ä½™é¢æ”¯ä»˜æ—¶å¿…é¡»æä¾›ä¼šå‘˜ID");
        });
    }
}
\`\`\`

---

### 2. RefundPaymentï¼ˆé€€æ¬¾ï¼‰

#### Command å®šä¹‰

\`\`\`csharp
public sealed record RefundPayment(
    Guid PaymentId,
    decimal Amount,
    string Reason
);
\`\`\`

#### Handler å®ç°

\`\`\`csharp
public sealed class RefundPaymentHandler
{
    [Transactional]
    public async Task<Result<Guid>> Handle(
        RefundPayment command,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct = default)
    {
        var payment = await session.LoadAsync<Payment>(command.PaymentId, ct);
        if (payment == null)
            return Result.Fail<Guid>("Payments:PaymentNotFound", "æ”¯ä»˜è®°å½•ä¸å­˜åœ¨");
        
        if (payment.Status != PaymentStatus.Completed)
            return Result.Fail<Guid>("Payments:PaymentNotCompleted", "åªèƒ½é€€æ¬¾å·²å®Œæˆçš„æ”¯ä»˜");
        
        if (payment.Status == PaymentStatus.Refunded)
            return Result.Fail<Guid>("Payments:AlreadyRefunded", "è¯¥æ”¯ä»˜å·²é€€æ¬¾");
        
        if (command.Amount > payment.Amount)
            return Result.Fail<Guid>("Payments:RefundAmountExceeded", "é€€æ¬¾é‡‘é¢è¶…è¿‡åŸæ”¯ä»˜é‡‘é¢");
        
        // åˆ›å»ºé€€æ¬¾è®°å½•
        var refund = new Refund
        {
            Id = Guid.NewGuid(),
            PaymentId = payment.Id,
            Amount = command.Amount,
            Reason = command.Reason,
            Status = RefundStatus.Processing,
            CreatedAt = DateTimeOffset.UtcNow
        };
        
        // æ ¹æ®æ”¯ä»˜æ–¹å¼å¤„ç†é€€æ¬¾
        var refundResult = payment.Method switch
        {
            PaymentMethod.MemberBalance => await RefundToMemberBalance(
                payment.MemberId!.Value, command.Amount, session, bus, ct),
            PaymentMethod.Cash => ProcessCashRefund(),
            PaymentMethod.Alipay => await ProcessAlipayRefund(payment.TransactionId!, command.Amount),
            PaymentMethod.WeChatPay => await ProcessWeChatRefund(payment.TransactionId!, command.Amount),
            _ => Result.Fail("Payments:UnsupportedRefundMethod", "ä¸æ”¯æŒçš„é€€æ¬¾æ–¹å¼")
        };
        
        if (!refundResult.IsSuccess)
        {
            refund.Status = RefundStatus.Failed;
            refund.FailureReason = refundResult.Error?.Message;
        }
        else
        {
            refund.Status = RefundStatus.Completed;
            refund.CompletedAt = DateTimeOffset.UtcNow;
            payment.Status = PaymentStatus.Refunded;
            payment.RefundedAt = DateTimeOffset.UtcNow;
        }
        
        session.Store(refund);
        session.Store(payment);
        await session.SaveChangesAsync(ct);
        
        await bus.PublishAsync(new PaymentRefunded(payment.Id, refund.Id, command.Amount), ct);
        
        return Result.Ok(refund.Id);
    }
    
    private async Task<Result> RefundToMemberBalance(
        Guid memberId,
        decimal amount,
        IDocumentSession session,
        IMessageBus bus,
        CancellationToken ct)
    {
        return await bus.InvokeAsync<Result>(
            new TopUpBalance(memberId, amount, "é€€æ¬¾"),
            ct
        );
    }
    
    private Result ProcessCashRefund()
    {
        return Result.Ok();
    }
    
    private async Task<Result> ProcessAlipayRefund(string transactionId, decimal amount)
    {
        // TODO: è°ƒç”¨æ”¯ä»˜å®é€€æ¬¾ API
        await Task.Delay(100);
        return Result.Ok();
    }
    
    private async Task<Result> ProcessWeChatRefund(string transactionId, decimal amount)
    {
        // TODO: è°ƒç”¨å¾®ä¿¡é€€æ¬¾ API
        await Task.Delay(100);
        return Result.Ok();
    }
}
\`\`\`

---

### 3. BillCalculatedHandlerï¼ˆç›‘å¬è´¦å•è®¡ç®—äº‹ä»¶ï¼‰

\`\`\`csharp
public sealed class BillCalculatedHandler
{
    public async Task Handle(
        BillCalculated @event,
        IDocumentSession session,
        CancellationToken ct = default)
    {
        // è´¦å•ç”Ÿæˆåï¼Œåˆ›å»ºå¾…æ”¯ä»˜è®°å½•
        var paymentRecord = new PaymentRecord
        {
            Id = Guid.NewGuid(),
            BillId = @event.BillId,
            SessionId = @event.SessionId,
            Amount = @event.TotalAmount,
            Status = PaymentRecordStatus.Pending,
            CreatedAt = DateTimeOffset.UtcNow
        };
        
        session.Store(paymentRecord);
        await session.SaveChangesAsync(ct);
    }
}
\`\`\`

---

## ğŸ“Š é¢†åŸŸæ¨¡å‹

### Paymentï¼ˆèšåˆæ ¹ï¼‰

\`\`\`csharp
public class Payment
{
    public Guid Id { get; set; }
    public Guid BillId { get; set; }
    public Guid SessionId { get; set; }
    public Guid? MemberId { get; set; }
    public decimal Amount { get; set; }
    public PaymentMethod Method { get; set; }
    public PaymentStatus Status { get; set; }
    public string? TransactionId { get; set; }      // ç¬¬ä¸‰æ–¹äº¤æ˜“å·
    public string IdempotencyKey { get; set; } = string.Empty;
    public string? FailureReason { get; set; }
    public DateTimeOffset CreatedAt { get; set; }
    public DateTimeOffset? CompletedAt { get; set; }
    public DateTimeOffset? RefundedAt { get; set; }
}

public enum PaymentMethod
{
    Cash,           // ç°é‡‘
    Alipay,         // æ”¯ä»˜å®
    WeChatPay,      // å¾®ä¿¡æ”¯ä»˜
    MemberBalance,  // ä¼šå‘˜ä½™é¢
    BankCard        // é“¶è¡Œå¡
}

public enum PaymentStatus
{
    Pending,    // å¾…æ”¯ä»˜
    Processing, // å¤„ç†ä¸­
    Completed,  // å·²å®Œæˆ
    Failed,     // å¤±è´¥
    Refunded    // å·²é€€æ¬¾
}
\`\`\`

### Refundï¼ˆé€€æ¬¾è®°å½•ï¼‰

\`\`\`csharp
public class Refund
{
    public Guid Id { get; set; }
    public Guid PaymentId { get; set; }
    public decimal Amount { get; set; }
    public string Reason { get; set; } = string.Empty;
    public RefundStatus Status { get; set; }
    public string? FailureReason { get; set; }
    public DateTimeOffset CreatedAt { get; set; }
    public DateTimeOffset? CompletedAt { get; set; }
}

public enum RefundStatus
{
    Processing,  // å¤„ç†ä¸­
    Completed,   // å·²å®Œæˆ
    Failed       // å¤±è´¥
}
\`\`\`

---

## ğŸ”” é¢†åŸŸäº‹ä»¶

\`\`\`csharp
public sealed record PaymentCompleted(
    Guid PaymentId,
    Guid SessionId,
    Guid? MemberId,
    decimal Amount
);

public sealed record PaymentFailed(
    Guid PaymentId,
    Guid SessionId
);

public sealed record PaymentRefunded(
    Guid PaymentId,
    Guid RefundId,
    decimal Amount
);
\`\`\`

---

## ğŸ”— è·¨æ¨¡å—é€šä¿¡

**ç›‘å¬äº‹ä»¶**:
- `BillCalculated` (æ¥è‡ª Billing æ¨¡å—) â†’ åˆ›å»ºå¾…æ”¯ä»˜è®°å½•

**å‘é€å‘½ä»¤**:
- â†’ `DeductBalance` (åˆ° Members æ¨¡å—) - ä½¿ç”¨ä¼šå‘˜ä½™é¢æ”¯ä»˜
- â†’ `TopUpBalance` (åˆ° Members æ¨¡å—) - é€€æ¬¾è‡³ä¼šå‘˜ä½™é¢

**å‘å¸ƒäº‹ä»¶**:
- `PaymentCompleted` â†’ Sessions æ¨¡å—ç›‘å¬ï¼ˆæ ‡è®°æ—¶æ®µå®Œæˆï¼‰
- `PaymentCompleted` â†’ Members æ¨¡å—ç›‘å¬ï¼ˆèµ é€ç§¯åˆ†ï¼‰

---

## ğŸ§ª å•å…ƒæµ‹è¯•ç¤ºä¾‹

### ProcessPaymentHandler æµ‹è¯•

\`\`\`csharp
public class ProcessPaymentHandlerTests
{
    [Fact]
    public async Task Handle_CashPayment_Succeeds()
    {
        // Arrange
        var store = DocumentStore.For(opts =>
        {
            opts.Connection("connection string");
            opts.DatabaseSchemaName = "payments_test";
        });
        
        await using var session = store.LightweightSession();
        var bus = Substitute.For<IMessageBus>();
        
        var bill = new Bill
        {
            Id = Guid.NewGuid(),
            SessionId = Guid.NewGuid(),
            TotalAmount = 50m
        };
        session.Store(bill);
        await session.SaveChangesAsync();
        
        var handler = new ProcessPaymentHandler();
        var command = new ProcessPayment(
            bill.Id,
            bill.SessionId,
            50m,
            PaymentMethod.Cash,
            null,
            Guid.NewGuid().ToString()
        );
        
        // Act
        var result = await handler.Handle(command, session, bus, CancellationToken.None);
        
        // Assert
        Assert.True(result.IsSuccess);
        
        var payment = await session.LoadAsync<Payment>(result.Value);
        Assert.NotNull(payment);
        Assert.Equal(PaymentStatus.Completed, payment.Status);
        Assert.Equal(50m, payment.Amount);
        
        await bus.Received(1).PublishAsync(
            Arg.Is<PaymentCompleted>(e => e.PaymentId == result.Value),
            Arg.Any<CancellationToken>()
        );
    }
    
    [Fact]
    public async Task Handle_IdempotencyCheck_ReturnsSamePaymentId()
    {
        // Arrange
        var store = DocumentStore.For(opts =>
        {
            opts.Connection("connection string");
            opts.DatabaseSchemaName = "payments_test";
        });
        
        await using var session = store.LightweightSession();
        var bus = Substitute.For<IMessageBus>();
        
        var idempotencyKey = Guid.NewGuid().ToString();
        var existingPayment = new Payment
        {
            Id = Guid.NewGuid(),
            BillId = Guid.NewGuid(),
            SessionId = Guid.NewGuid(),
            Amount = 50m,
            Method = PaymentMethod.Cash,
            Status = PaymentStatus.Completed,
            IdempotencyKey = idempotencyKey,
            CreatedAt = DateTimeOffset.UtcNow,
            CompletedAt = DateTimeOffset.UtcNow
        };
        session.Store(existingPayment);
        await session.SaveChangesAsync();
        
        var handler = new ProcessPaymentHandler();
        var command = new ProcessPayment(
            existingPayment.BillId,
            existingPayment.SessionId,
            50m,
            PaymentMethod.Cash,
            null,
            idempotencyKey  // ä½¿ç”¨ç›¸åŒçš„å¹‚ç­‰æ€§å¯†é’¥
        );
        
        // Act
        var result = await handler.Handle(command, session, bus, CancellationToken.None);
        
        // Assert
        Assert.True(result.IsSuccess);
        Assert.Equal(existingPayment.Id, result.Value);  // è¿”å›åŸæ”¯ä»˜ID
        
        // ä¸åº”å‘å¸ƒæ–°çš„äº‹ä»¶
        await bus.DidNotReceive().PublishAsync(
            Arg.Any<PaymentCompleted>(),
            Arg.Any<CancellationToken>()
        );
    }
}
\`\`\`

---

## ğŸ“ å¼€å‘è§„èŒƒ

### å‘½åçº¦å®š

- **Command**: åŠ¨è¯å¼€å¤´ï¼ˆ`ProcessPayment`, `RefundPayment`ï¼‰
- **Query**: `Get` å¼€å¤´ï¼ˆ`GetPayment`, `GetPaymentHistory`ï¼‰
- **Event**: è¿‡å»å¼ï¼ˆ`PaymentCompleted`, `PaymentRefunded`ï¼‰

### å¹‚ç­‰æ€§å®ç°

**å…³é”®ç‚¹**:
1. æ¯ä¸ªæ”¯ä»˜è¯·æ±‚å¿…é¡»æºå¸¦å”¯ä¸€çš„å¹‚ç­‰æ€§å¯†é’¥
2. å¤„ç†å‰æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒå¯†é’¥çš„æ”¯ä»˜è®°å½•
3. å¦‚æœå·²å®Œæˆï¼Œç›´æ¥è¿”å›åŸæ”¯ä»˜ID
4. å¦‚æœæ­£åœ¨å¤„ç†ï¼Œè¿”å›"å¤„ç†ä¸­"é”™è¯¯

**Wolverine é…ç½®**:
\`\`\`csharp
opts.Policies.Add<RetryPolicy>(policy =>
{
    policy.MaxAttempts = 3;
    policy.Exceptions.Add<HttpRequestException>();
    policy.Exceptions.Add<TimeoutException>();
});
\`\`\`

### æ—¥å¿—è§„èŒƒ

\`\`\`csharp
_logger.LogInformation(
    "Payment {PaymentId} for Session {SessionId} completed with {Method}, Amount: {Amount:F2}",
    paymentId, sessionId, method, amount
);

_logger.LogWarning(
    "Payment {PaymentId} failed: {Reason}",
    paymentId, failureReason
);
\`\`\`

### é”™è¯¯å¤„ç†

- é”™è¯¯ä»£ç æ ¼å¼ï¼š`Payments:{ErrorKey}`
- ç¤ºä¾‹ï¼š`Payments:AmountMismatch`, `Payments:PaymentProcessing`

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/Wolverineæ¨¡å—åŒ–æ¶æ„è“å›¾.md)
- [ç³»ç»Ÿæ¨¡å—åˆ’åˆ†](../03_ç³»ç»Ÿæ¶æ„è®¾è®¡/ç³»ç»Ÿæ¨¡å—åˆ’åˆ†.md)
- [å°çƒæ¡Œè®¡è´¹æ¨¡å—](å°çƒæ¡Œè®¡è´¹æ¨¡å—.md)
- [ä¼šå‘˜ç®¡ç†æ¨¡å—](ä¼šå‘˜ç®¡ç†æ¨¡å—.md)

---

*æœ€åæ›´æ–°: 2024-01-15 | ç‰ˆæœ¬: v2.0.0 | æ¶æ„: Wolverine + å‚ç›´åˆ‡ç‰‡*
