---
title: "è¡¨ç»“æ„å®šä¹‰"
description: "EF Core å®ä½“å»ºæ¨¡è§„èŒƒå’Œæ•°æ®åº“è¡¨ç»“æ„å®šä¹‰"
section: "5.2"
version: "1.0.0"
author: "æ•°æ®åº“å›¢é˜Ÿ"
maintainer: "å¼€å‘å·¥ç¨‹å¸ˆ"
created: "2024-01-01"
updated: "2024-01-15"
category: "æ•°æ®åº“è®¾è®¡"
level: "å¿…è¯»"
audience: ["å¼€å‘å·¥ç¨‹å¸ˆ", "DBA"]
keywords: ["è¡¨ç»“æ„", "å®ä½“å»ºæ¨¡", "EF Coreå®ä½“", "DbContexté…ç½®", "æ•°æ®åº“æ˜ å°„", "ABPæ¡†æ¶"]
tags: ["efcore", "entities", "database-schema", "abp-framework"]
status: "å®Œæˆ"
dependencies: []
related_docs: ["05_æ•°æ®åº“è®¾è®¡/å…³é”®è¡¨è¯´æ˜.md", "05_æ•°æ®åº“è®¾è®¡/æ•°æ®è¿ç§»æ–¹æ¡ˆ.md"]
reading_time: "25åˆ†é’Ÿ"
difficulty: "ä¸­çº§"
---

# 5.2 è¡¨ç»“æ„å®šä¹‰

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md) > [ğŸ“Š æ•°æ®åº“è®¾è®¡](README.md) > ğŸ—ï¸ è¡¨ç»“æ„å®šä¹‰

<!-- Keywords for Search -->
**å…³é”®è¯**: `è¡¨ç»“æ„` `å®ä½“å»ºæ¨¡` `EF Coreå®ä½“` `DbContexté…ç½®` `æ•°æ®åº“æ˜ å°„` `ABPæ¡†æ¶`

## æ¦‚è¿°

æœ¬æ–‡æ¡£å®šä¹‰äº†è‡ªåŠ©å°çƒç³»ç»Ÿçš„æ•°æ®åº“è¡¨ç»“æ„ï¼ŒåŸºäº EF Core Code First æ–¹å¼è®¾è®¡ã€‚æ‰€æœ‰å®ä½“ç±»éƒ½ç»§æ‰¿è‡ª ABP æ¡†æ¶çš„åŸºç±»ï¼Œæä¾›å®¡è®¡ã€è½¯åˆ é™¤ç­‰é€šç”¨åŠŸèƒ½ã€‚

> ğŸ’¡ **ç›¸å…³ç« èŠ‚**ï¼š
> - ä¸šåŠ¡é€»è¾‘è¯¦ç»†è¯´æ˜è¯·å‚è€ƒ [5.3 å…³é”®è¡¨è¯´æ˜](å…³é”®è¡¨è¯´æ˜.md)
> - æ•°æ®åº“è¿ç§»æ“ä½œè¯·å‚è€ƒ [5.5 æ•°æ®è¿ç§»æ–¹æ¡ˆ](æ•°æ®è¿ç§»æ–¹æ¡ˆ.md)
> - å®Œæ•´å¼€å‘æµç¨‹è¯·å‚è€ƒ [5.6 EF Core å¼€å‘å·¥ä½œæµç¨‹](EFCoreå¼€å‘å·¥ä½œæµç¨‹.md)

## æ ¸å¿ƒå®ä½“è¡¨ç»“æ„

### 1. é—¨åº—è¡¨ (Stores)

```csharp
public class Store : FullAuditedAggregateRoot<long>
{
    [Required]
    [MaxLength(100)]
    public string Name { get; set; }
    
    [MaxLength(500)]
    public string Address { get; set; }
    
    [MaxLength(20)]
    public string ContactPhone { get; set; }
    
    [MaxLength(100)]
    public string ContactEmail { get; set; }
    
    public StoreStatus Status { get; set; }
    
    [MaxLength(2000)]
    public string Description { get; set; }
    
    // è¥ä¸šæ—¶é—´
    public TimeSpan OpenTime { get; set; }
    public TimeSpan CloseTime { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual ICollection<BilliardTable> Tables { get; set; }
    public virtual ICollection<Employee> Employees { get; set; }
}

public enum StoreStatus
{
    Active = 1,     // è¥ä¸šä¸­
    Inactive = 0,   // æš‚åœè¥ä¸š  
    Maintenance = 2 // ç»´æŠ¤ä¸­
}
```

**æ•°æ®åº“æ˜ å°„**ï¼š
```sql
CREATE TABLE Stores (
    Id BIGINT PRIMARY KEY IDENTITY(1,1),
    Name NVARCHAR(100) NOT NULL,
    Address NVARCHAR(500),
    ContactPhone NVARCHAR(20),
    ContactEmail NVARCHAR(100),
    Status INT NOT NULL DEFAULT 1,
    Description NVARCHAR(2000),
    OpenTime TIME NOT NULL,
    CloseTime TIME NOT NULL,
    CreationTime DATETIME2 NOT NULL,
    CreatorId UNIQUEIDENTIFIER,
    LastModificationTime DATETIME2,
    LastModifierId UNIQUEIDENTIFIER,
    IsDeleted BIT NOT NULL DEFAULT 0,
    DeleterId UNIQUEIDENTIFIER,
    DeletionTime DATETIME2
);
```

### 2. çƒå°è¡¨ (BilliardTables)

```csharp
public class BilliardTable : FullAuditedAggregateRoot<long>
{
    [Required]
    [MaxLength(20)]
    public string TableNumber { get; set; }
    
    public long StoreId { get; set; }
    
    public TableStatus Status { get; set; }
    
    public TableType Type { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal HourlyRate { get; set; }
    
    [MaxLength(500)]
    public string Location { get; set; }
    
    [MaxLength(1000)]
    public string Equipment { get; set; }
    
    public bool IsOnline { get; set; }
    
    public DateTime? LastHeartbeatTime { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual Store Store { get; set; }
    public virtual ICollection<TableSession> Sessions { get; set; }
    public virtual ICollection<Device> Devices { get; set; }
}

public enum TableStatus
{
    Available = 1,   // å¯ç”¨
    Occupied = 2,    // ä½¿ç”¨ä¸­
    Reserved = 3,    // å·²é¢„çº¦
    Maintenance = 4, // ç»´æŠ¤ä¸­
    OutOfOrder = 5   // æ•…éšœ
}

public enum TableType
{
    Standard = 1,    // æ ‡å‡†å°
    Snooker = 2,     // æ–¯è¯ºå…‹å°
    American = 3     // ç¾å¼å°
}
```

### 3. ç”¨æˆ·è¡¨ (Users)

```csharp
public class User : FullAuditedAggregateRoot<long>
{
    [MaxLength(50)]
    public string Phone { get; set; }
    
    [MaxLength(100)]
    public string Email { get; set; }
    
    [MaxLength(50)]
    public string NickName { get; set; }
    
    [MaxLength(500)]
    public string Avatar { get; set; }
    
    public Gender? Gender { get; set; }
    
    public DateTime? Birthday { get; set; }
    
    public UserStatus Status { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal Balance { get; set; }
    
    public int PlayCount { get; set; }
    
    public int TotalPlayMinutes { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal TotalSpent { get; set; }
    
    public DateTime? LastLoginTime { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual ICollection<TableSession> Sessions { get; set; }
    public virtual ICollection<PaymentOrder> PaymentOrders { get; set; }
    public virtual ICollection<Membership> Memberships { get; set; }
}

public enum Gender
{
    Male = 1,
    Female = 2
}

public enum UserStatus
{
    Active = 1,
    Inactive = 0,
    Blocked = 2
}
```

### 4. å°çƒä¼šè¯è¡¨ (TableSessions)

```csharp
public class TableSession : FullAuditedAggregateRoot<long>
{
    public long UserId { get; set; }
    
    public long TableId { get; set; }
    
    public DateTime StartTime { get; set; }
    
    public DateTime? EndTime { get; set; }
    
    public SessionStatus Status { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal HourlyRate { get; set; }
    
    public int PlayMinutes { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal TotalAmount { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal DiscountAmount { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal FinalAmount { get; set; }
    
    [MaxLength(36)]
    public string SessionToken { get; set; }
    
    [MaxLength(1000)]
    public string Remarks { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual User User { get; set; }
    public virtual BilliardTable Table { get; set; }
    public virtual ICollection<PaymentOrder> PaymentOrders { get; set; }
    public virtual ICollection<BillingSnapshot> BillingSnapshots { get; set; }
}

public enum SessionStatus
{
    Active = 1,      // è¿›è¡Œä¸­
    Completed = 2,   // å·²å®Œæˆ
    Cancelled = 3,   // å·²å–æ¶ˆ
    Paused = 4       // æš‚åœ
}
```

### 5. æ”¯ä»˜è®¢å•è¡¨ (PaymentOrders)

```csharp
public class PaymentOrder : FullAuditedAggregateRoot<long>
{
    [MaxLength(32)]
    public string OrderNo { get; set; }
    
    public long UserId { get; set; }
    
    public long? SessionId { get; set; }
    
    public PaymentType PaymentType { get; set; }
    
    public PaymentMethod PaymentMethod { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal Amount { get; set; }
    
    public PaymentStatus Status { get; set; }
    
    [MaxLength(100)]
    public string ThirdPartyOrderNo { get; set; }
    
    [MaxLength(100)]
    public string ThirdPartyTransactionId { get; set; }
    
    public DateTime? PaidTime { get; set; }
    
    public DateTime? RefundTime { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal RefundAmount { get; set; }
    
    [MaxLength(500)]
    public string FailureReason { get; set; }
    
    public string CallbackData { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual User User { get; set; }
    public virtual TableSession Session { get; set; }
}

public enum PaymentType
{
    SessionPayment = 1, // ä¼šè¯æ”¯ä»˜
    Recharge = 2,      // å……å€¼
    Refund = 3         // é€€æ¬¾
}

public enum PaymentMethod
{
    WeChatPay = 1,     // å¾®ä¿¡æ”¯ä»˜
    Alipay = 2,        // æ”¯ä»˜å®
    Balance = 3,       // ä½™é¢æ”¯ä»˜
    Cash = 4           // ç°é‡‘æ”¯ä»˜
}

public enum PaymentStatus
{
    Pending = 1,       // å¾…æ”¯ä»˜
    Paid = 2,         // å·²æ”¯ä»˜
    Failed = 3,       // æ”¯ä»˜å¤±è´¥
    Cancelled = 4,    // å·²å–æ¶ˆ
    Refunded = 5      // å·²é€€æ¬¾
}
```

### 6. è®¡è´¹å¿«ç…§è¡¨ (BillingSnapshots)

```csharp
public class BillingSnapshot : Entity<long>
{
    public long SessionId { get; set; }
    
    public DateTime SnapshotTime { get; set; }
    
    public int PlayMinutes { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal HourlyRate { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal BaseAmount { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal DiscountAmount { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal FinalAmount { get; set; }
    
    public string PricingRules { get; set; } // JSONæ ¼å¼å­˜å‚¨å®šä»·è§„åˆ™
    
    // å¯¼èˆªå±æ€§
    public virtual TableSession Session { get; set; }
}
```

### 7. è®¾å¤‡è¡¨ (Devices)

```csharp
public class Device : FullAuditedAggregateRoot<long>
{
    public long StoreId { get; set; }
    
    public long? TableId { get; set; }
    
    public DeviceType Type { get; set; }
    
    [MaxLength(50)]
    public string SerialNumber { get; set; }
    
    [MaxLength(100)]
    public string Name { get; set; }
    
    [MaxLength(50)]
    public string FirmwareVersion { get; set; }
    
    public DeviceStatus Status { get; set; }
    
    public bool IsOnline { get; set; }
    
    public DateTime? LastHeartbeatTime { get; set; }
    
    [MaxLength(500)]
    public string Location { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual Store Store { get; set; }
    public virtual BilliardTable Table { get; set; }
    public virtual ICollection<DeviceHeartbeat> Heartbeats { get; set; }
}

public enum DeviceType
{
    LightController = 1, // ç¯æ§è®¾å¤‡
    Camera = 2,         // æ‘„åƒå¤´
    Gateway = 3,        // ç½‘å…³è®¾å¤‡
    Sensor = 4          // ä¼ æ„Ÿå™¨
}

public enum DeviceStatus
{
    Active = 1,
    Inactive = 0,
    Fault = 2
}
```

### 8. è®¾å¤‡å¿ƒè·³è¡¨ (DeviceHeartbeats)

```csharp
public class DeviceHeartbeat : Entity<long>
{
    public long DeviceId { get; set; }
    
    public DateTime Timestamp { get; set; }
    
    public string MetricsJson { get; set; } // JSONæ ¼å¼å­˜å‚¨è®¾å¤‡æŒ‡æ ‡
    
    public bool IsOnline { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual Device Device { get; set; }
}
```

### 9. ä¼šå‘˜è¡¨ (Memberships)

```csharp
public class Membership : FullAuditedAggregateRoot<long>
{
    public long UserId { get; set; }
    
    public MembershipType Type { get; set; }
    
    public DateTime StartDate { get; set; }
    
    public DateTime EndDate { get; set; }
    
    public MembershipStatus Status { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal PaidAmount { get; set; }
    
    public int? TotalMinutes { get; set; }
    
    public int? UsedMinutes { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal? TotalAmount { get; set; }
    
    [Column(TypeName = "decimal(18,2)")]
    public decimal? UsedAmount { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual User User { get; set; }
}

public enum MembershipType
{
    Monthly = 1,    // æœˆå¡
    Quarterly = 2,  // å­£å¡
    Annual = 3,     // å¹´å¡
    TimePack = 4,   // æ—¶é—´åŒ…
    AmountPack = 5  // é‡‘é¢åŒ…
}

public enum MembershipStatus
{
    Active = 1,
    Expired = 2,
    Suspended = 3
}
```

## EF Core é…ç½®ç¤ºä¾‹

### DbContext é…ç½®

```csharp
protected override void OnModelCreating(ModelBuilder builder)
{
    base.OnModelCreating(builder);
    
    // é—¨åº—é…ç½®
    builder.Entity<Store>(b =>
    {
        b.ToTable("Stores");
        b.ConfigureByConvention();
        b.Property(x => x.Name).IsRequired().HasMaxLength(100);
        b.HasIndex(x => x.Name);
    });
    
    // çƒå°é…ç½®
    builder.Entity<BilliardTable>(b =>
    {
        b.ToTable("BilliardTables");
        b.ConfigureByConvention();
        b.Property(x => x.HourlyRate).HasColumnType("decimal(18,2)");
        b.HasIndex(x => new { x.StoreId, x.TableNumber }).IsUnique();
        
        // å¤–é”®å…³ç³»
        b.HasOne(x => x.Store)
         .WithMany(x => x.Tables)
         .HasForeignKey(x => x.StoreId)
         .OnDelete(DeleteBehavior.Cascade);
    });
    
    // ç”¨æˆ·é…ç½®
    builder.Entity<User>(b =>
    {
        b.ToTable("Users");
        b.ConfigureByConvention();
        b.Property(x => x.Balance).HasColumnType("decimal(18,2)");
        b.Property(x => x.TotalSpent).HasColumnType("decimal(18,2)");
        b.HasIndex(x => x.Phone).IsUnique();
    });
    
    // ä¼šè¯é…ç½®
    builder.Entity<TableSession>(b =>
    {
        b.ToTable("TableSessions");
        b.ConfigureByConvention();
        b.Property(x => x.HourlyRate).HasColumnType("decimal(18,2)");
        b.Property(x => x.TotalAmount).HasColumnType("decimal(18,2)");
        b.Property(x => x.DiscountAmount).HasColumnType("decimal(18,2)");
        b.Property(x => x.FinalAmount).HasColumnType("decimal(18,2)");
        
        b.HasIndex(x => x.SessionToken).IsUnique();
        b.HasIndex(x => new { x.TableId, x.StartTime });
    });
    
    // æ”¯ä»˜è®¢å•é…ç½®
    builder.Entity<PaymentOrder>(b =>
    {
        b.ToTable("PaymentOrders");
        b.ConfigureByConvention();
        b.Property(x => x.Amount).HasColumnType("decimal(18,2)");
        b.Property(x => x.RefundAmount).HasColumnType("decimal(18,2)");
        
        b.HasIndex(x => x.OrderNo).IsUnique();
        b.HasIndex(x => x.ThirdPartyOrderNo);
        b.HasIndex(x => new { x.UserId, x.Status });
    });
}
```

## ç´¢å¼•ç­–ç•¥

### æŸ¥è¯¢ä¼˜åŒ–ç´¢å¼•

```sql
-- é—¨åº—ç›¸å…³
CREATE INDEX IX_Stores_Status ON Stores (Status);

-- çƒå°ç›¸å…³  
CREATE UNIQUE INDEX IX_BilliardTables_Store_TableNumber ON BilliardTables (StoreId, TableNumber);
CREATE INDEX IX_BilliardTables_Status ON BilliardTables (Status);

-- ç”¨æˆ·ç›¸å…³
CREATE UNIQUE INDEX IX_Users_Phone ON Users (Phone) WHERE Phone IS NOT NULL;
CREATE INDEX IX_Users_Status ON Users (Status);

-- ä¼šè¯ç›¸å…³
CREATE INDEX IX_TableSessions_Table_StartTime ON TableSessions (TableId, StartTime);
CREATE INDEX IX_TableSessions_User_CreationTime ON TableSessions (UserId, CreationTime);
CREATE INDEX IX_TableSessions_Status ON TableSessions (Status);

-- æ”¯ä»˜ç›¸å…³
CREATE INDEX IX_PaymentOrders_User_Status ON PaymentOrders (UserId, Status);
CREATE INDEX IX_PaymentOrders_CreationTime ON PaymentOrders (CreationTime);
CREATE INDEX IX_PaymentOrders_Status_PaymentMethod ON PaymentOrders (Status, PaymentMethod);

-- è®¾å¤‡ç›¸å…³
CREATE INDEX IX_Devices_Store_Type ON Devices (StoreId, Type);
CREATE INDEX IX_Devices_Status_IsOnline ON Devices (Status, IsOnline);

-- å¿ƒè·³ç›¸å…³ï¼ˆåˆ†åŒºè¡¨è€ƒè™‘ï¼‰
CREATE INDEX IX_DeviceHeartbeats_Device_Timestamp ON DeviceHeartbeats (DeviceId, Timestamp);
CREATE INDEX IX_DeviceHeartbeats_Timestamp ON DeviceHeartbeats (Timestamp);
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### åŒçº§æ–‡æ¡£
- [5.1 æ¦‚å¿µæ¨¡å‹ï¼ˆER å›¾ï¼‰](æ¦‚å¿µæ¨¡å‹_ERå›¾.md)
- [5.3 å…³é”®è¡¨è¯´æ˜](å…³é”®è¡¨è¯´æ˜.md)
- [5.4 ç´¢å¼•ä¸ä¼˜åŒ–](ç´¢å¼•ä¸ä¼˜åŒ–.md)
- [5.5 æ•°æ®è¿ç§»æ–¹æ¡ˆ](æ•°æ®è¿ç§»æ–¹æ¡ˆ.md)
- [5.6 EF Core å¼€å‘å·¥ä½œæµç¨‹](EFCoreå¼€å‘å·¥ä½œæµç¨‹.md)

### è¿”å›ä¸Šçº§
- [ğŸ”™ æ•°æ®åº“è®¾è®¡æ€»è§ˆ](README.md)
- [ğŸ  é¡¹ç›®æ–‡æ¡£é¦–é¡µ](../è‡ªåŠ©å°çƒç³»ç»Ÿé¡¹ç›®æ–‡æ¡£.md)

### ç›¸å…³ç« èŠ‚
- [4. æ¨¡å—è®¾è®¡è¯´æ˜](../04_æ¨¡å—è®¾è®¡è¯´æ˜/README.md)
- [6. å¼€å‘è§„èŒƒ](../06_å¼€å‘è§„èŒƒ/README.md)
