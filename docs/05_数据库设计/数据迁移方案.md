---
title: "æ•°æ®è¿ç§»æ–¹æ¡ˆ"
description: "EF Core Code First æ•°æ®è¿ç§»å®Œæ•´æŒ‡å—å’Œæœ€ä½³å®è·µ"
section: "5.5"
version: "1.0.0"
author: "å¼€å‘å›¢é˜Ÿ"
maintainer: "å¼€å‘å·¥ç¨‹å¸ˆ"
created: "2024-01-01"
updated: "2024-01-15"
category: "æ•°æ®åº“è®¾è®¡"
level: "å¿…è¯»"
audience: ["å¼€å‘å·¥ç¨‹å¸ˆ", "è¿ç»´å·¥ç¨‹å¸ˆ"]
keywords: ["EF Core Migrations", "æ•°æ®è¿ç§»", "Code First", "æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†", "è¿ç§»è„šæœ¬", "æ•°æ®ç§å­"]
tags: ["efcore", "migrations", "database", "version-control"]
status: "å®Œæˆ"
dependencies: ["05_æ•°æ®åº“è®¾è®¡/è¡¨ç»“æ„å®šä¹‰.md"]
related_docs: ["05_æ•°æ®åº“è®¾è®¡/å…³é”®è¡¨è¯´æ˜.md", "05_æ•°æ®åº“è®¾è®¡/æ•°æ®è®¿é—®æœ€ä½³å®è·µ.md"]
reading_time: "15åˆ†é’Ÿ"
difficulty: "ä¸­çº§"
---

# 5.5 æ•°æ®è¿ç§»æ–¹æ¡ˆ

<!-- Breadcrumb Navigation -->
**å¯¼èˆªè·¯å¾„**: [ğŸ  é¡¹ç›®é¦–é¡µ](../../README.md) > [ğŸ“Š æ•°æ®åº“è®¾è®¡](README.md) > ğŸ”„ æ•°æ®è¿ç§»æ–¹æ¡ˆ

<!-- Keywords for Search -->
**å…³é”®è¯**: `EF Core Migrations` `æ•°æ®è¿ç§»` `Code First` `æ•°æ®åº“ç‰ˆæœ¬ç®¡ç†` `è¿ç§»è„šæœ¬` `æ•°æ®ç§å­`

## æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨ EF Core Code First æ–¹å¼è¿›è¡Œæ•°æ®åº“è®¾è®¡å’Œç‰ˆæœ¬ç®¡ç†ï¼Œé€šè¿‡ Entity Framework Core Migrations å®ç°æ•°æ®åº“ç»“æ„çš„ç‰ˆæœ¬åŒ–ç®¡ç†ã€‚

> ğŸ’¡ **ç›¸å…³ç« èŠ‚**ï¼šè¯¦ç»†çš„å®ä½“å®šä¹‰è¯·å‚è€ƒ [5.2 è¡¨ç»“æ„å®šä¹‰](è¡¨ç»“æ„å®šä¹‰.md)ï¼Œä¸šåŠ¡é€»è¾‘è¯´æ˜è¯·å‚è€ƒ [5.3 å…³é”®è¡¨è¯´æ˜](å…³é”®è¡¨è¯´æ˜.md)ã€‚

## EF Core Code First å¼€å‘æµç¨‹

### 1. å®ä½“æ¨¡å‹è®¾è®¡

```csharp
// ç¤ºä¾‹ï¼šçƒå°å®ä½“å®šä¹‰
public class BilliardTable : Entity<long>
{
    public string TableNumber { get; set; }
    public long StoreId { get; set; }
    public TableStatus Status { get; set; }
    public decimal HourlyRate { get; set; }
    public DateTime CreationTime { get; set; }
    
    // å¯¼èˆªå±æ€§
    public virtual Store Store { get; set; }
    public virtual ICollection<TableSession> Sessions { get; set; }
}
```

### 2. æ•°æ®åº“ä¸Šä¸‹æ–‡é…ç½®

```csharp
public class BilliardHallDbContext : AbpDbContext<BilliardHallDbContext>
{
    public DbSet<Store> Stores { get; set; }
    public DbSet<BilliardTable> BilliardTables { get; set; }
    public DbSet<User> Users { get; set; }
    public DbSet<TableSession> TableSessions { get; set; }
    public DbSet<PaymentOrder> PaymentOrders { get; set; }
    
    protected override void OnModelCreating(ModelBuilder builder)
    {
        base.OnModelCreating(builder);
        
        // é…ç½®å®ä½“æ˜ å°„
        builder.ConfigurePersistedGrantContext(storeOptions);
        builder.ConfigureIdentityContext();
        builder.ConfigureTenantManagementContext();
        builder.ConfigureSettingManagementContext();
        builder.ConfigureAuditLoggingContext();
        
        // è‡ªå®šä¹‰é…ç½®
        ConfigureBilliardHall(builder);
    }
    
    private void ConfigureBilliardHall(ModelBuilder builder)
    {
        // é…ç½®çƒå°è¡¨
        builder.Entity<BilliardTable>(b =>
        {
            b.ToTable("BilliardTables");
            b.ConfigureByConvention();
            
            b.Property(x => x.TableNumber)
                .IsRequired()
                .HasMaxLength(20);
                
            b.Property(x => x.HourlyRate)
                .HasColumnType("decimal(18,2)");
                
            // åˆ›å»ºç´¢å¼•
            b.HasIndex(x => new { x.StoreId, x.TableNumber })
                .IsUnique();
        });
    }
}
```

### 3. è¿ç§»å‘½ä»¤æ“ä½œ

#### æ·»åŠ æ–°è¿ç§»

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
dotnet ef migrations add InitialCreate -p src/Zss.BilliardHall.EntityFrameworkCore -s src/Zss.BilliardHall.DbMigrator

# æ·»åŠ ç‰¹å®šåŠŸèƒ½çš„è¿ç§»
dotnet ef migrations add AddPaymentModule -p src/Zss.BilliardHall.EntityFrameworkCore -s src/Zss.BilliardHall.DbMigrator
```

#### æ›´æ–°æ•°æ®åº“

```bash
# æ›´æ–°åˆ°æœ€æ–°è¿ç§»
dotnet ef database update -p src/Zss.BilliardHall.EntityFrameworkCore -s src/Zss.BilliardHall.DbMigrator

# æ›´æ–°åˆ°æŒ‡å®šè¿ç§»ç‰ˆæœ¬
dotnet ef database update AddPaymentModule -p src/Zss.BilliardHall.EntityFrameworkCore -s src/Zss.BilliardHall.DbMigrator
```

#### å›æ»šè¿ç§»

```bash
# å›æ»šåˆ°æŒ‡å®šè¿ç§»
dotnet ef database update PreviousMigrationName -p src/Zss.BilliardHall.EntityFrameworkCore -s src/Zss.BilliardHall.DbMigrator

# å®Œå…¨ç§»é™¤æ•°æ®åº“
dotnet ef database drop -p src/Zss.BilliardHall.EntityFrameworkCore -s src/Zss.BilliardHall.DbMigrator
```

#### ç§»é™¤è¿ç§»

```bash
# ç§»é™¤æœ€åä¸€ä¸ªè¿ç§»ï¼ˆæœªåº”ç”¨åˆ°æ•°æ®åº“çš„ï¼‰
dotnet ef migrations remove -p src/Zss.BilliardHall.EntityFrameworkCore -s src/Zss.BilliardHall.DbMigrator
```

### 4. æ•°æ®ç§å­ï¼ˆData Seedingï¼‰

```csharp
public class BilliardHallDataSeeder : IDataSeeder
{
    private readonly IRepository<Store, long> _storeRepository;
    private readonly IRepository<BilliardTable, long> _tableRepository;
    
    public BilliardHallDataSeeder(
        IRepository<Store, long> storeRepository,
        IRepository<BilliardTable, long> tableRepository)
    {
        _storeRepository = storeRepository;
        _tableRepository = tableRepository;
    }
    
    public async Task SeedAsync(DataSeedContext context)
    {
        // åˆ›å»ºé»˜è®¤é—¨åº—
        if (await _storeRepository.GetCountAsync() == 0)
        {
            var defaultStore = new Store
            {
                Name = "æµ‹è¯•é—¨åº—",
                Address = "æµ‹è¯•åœ°å€",
                ContactPhone = "13800138000",
                Status = StoreStatus.Active
            };
            
            await _storeRepository.InsertAsync(defaultStore);
            
            // ä¸ºé—¨åº—åˆ›å»ºé»˜è®¤çƒå°
            var tables = new List<BilliardTable>();
            for (int i = 1; i <= 10; i++)
            {
                tables.Add(new BilliardTable
                {
                    TableNumber = $"å°{i:D2}",
                    StoreId = defaultStore.Id,
                    Status = TableStatus.Available,
                    HourlyRate = 30.00m
                });
            }
            
            await _tableRepository.InsertManyAsync(tables);
        }
    }
}
```

## è¿ç§»æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

- è¿ç§»åç§°ä½¿ç”¨è‹±æ–‡é©¼å³°å‘½åï¼š`AddUserModule`ã€`UpdatePaymentSchema`
- æäº¤ä¿¡æ¯ä½¿ç”¨ä¸­æ–‡ï¼š`feat: æ·»åŠ ç”¨æˆ·æ¨¡å—æ•°æ®åº“è¿ç§»`

### 2. è¿ç§»æ–‡ä»¶ç®¡ç†

- æ¯ä¸ªåŠŸèƒ½æ¨¡å—çš„è¿ç§»åº”è¯¥ç‹¬ç«‹
- ä¸è¦åœ¨å•ä¸ªè¿ç§»ä¸­æ··åˆå¤šä¸ªä¸ç›¸å…³çš„å˜æ›´
- å¤§å‹æ•°æ®è¿ç§»åº”è¯¥åˆ†æ‰¹è¿›è¡Œ

### 3. æ•°æ®åº“å…¼å®¹æ€§

```csharp
// åœ¨è¿ç§»ä¸­å¤„ç†æ•°æ®è½¬æ¢
protected override void Up(MigrationBuilder migrationBuilder)
{
    // å…ˆæ·»åŠ æ–°åˆ—ï¼ˆå¯ä¸ºç©ºï¼‰
    migrationBuilder.AddColumn<string>(
        name: "NewColumn",
        table: "Users",
        type: "nvarchar(255)",
        maxLength: 255,
        nullable: true);
    
    // æ›´æ–°ç°æœ‰æ•°æ®
    migrationBuilder.Sql("UPDATE Users SET NewColumn = 'é»˜è®¤å€¼' WHERE NewColumn IS NULL");
    
    // è®¾ç½®ä¸ºå¿…å¡«
    migrationBuilder.AlterColumn<string>(
        name: "NewColumn",
        table: "Users",
        type: "nvarchar(255)",
        maxLength: 255,
        nullable: false,
        oldClrType: typeof(string),
        oldType: "nvarchar(255)",
        oldMaxLength: 255,
        oldNullable: true);
}
```

### 4. æµ‹è¯•ç¯å¢ƒæ•°æ®è¿ç§»

```bash
# å¼€å‘ç¯å¢ƒ
export ASPNETCORE_ENVIRONMENT=Development
dotnet run --project src/Zss.BilliardHall.DbMigrator

# æµ‹è¯•ç¯å¢ƒ
export ASPNETCORE_ENVIRONMENT=Staging
dotnet run --project src/Zss.BilliardHall.DbMigrator

# ç”Ÿäº§ç¯å¢ƒï¼ˆè°¨æ…æ“ä½œï¼‰
export ASPNETCORE_ENVIRONMENT=Production
dotnet run --project src/Zss.BilliardHall.DbMigrator
```

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿ç§»å†²çª**ï¼šå¤šäººå¼€å‘æ—¶è¿ç§»æ–‡ä»¶å†²çª
   - è§£å†³æ–¹æ¡ˆï¼šé‡æ–°ç”Ÿæˆè¿ç§»æˆ–æ‰‹åŠ¨åˆå¹¶

2. **æ•°æ®ä¸¢å¤±é£é™©**ï¼šåˆ é™¤åˆ—æˆ–è¡¨çš„è¿ç§»
   - è§£å†³æ–¹æ¡ˆï¼šå…ˆå¤‡ä»½æ•°æ®ï¼Œä½¿ç”¨ `Down` æ–¹æ³•æä¾›å›æ»šé€»è¾‘

3. **æ€§èƒ½é—®é¢˜**ï¼šå¤§è¡¨çš„ç»“æ„å˜æ›´
   - è§£å†³æ–¹æ¡ˆï¼šåˆ†æ‰¹æ‰§è¡Œï¼Œä½¿ç”¨åŸç”Ÿ SQL è¯­å¥

### å›æ»šç­–ç•¥

```csharp
protected override void Down(MigrationBuilder migrationBuilder)
{
    // æä¾›å®Œæ•´çš„å›æ»šé€»è¾‘
    migrationBuilder.DropTable("NewTable");
    
    migrationBuilder.DropColumn(
        name: "NewColumn",
        table: "ExistingTable");
}
```

## ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

1. **å¤‡ä»½æ•°æ®åº“**
2. **åœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯è¿ç§»**
3. **åœ¨ç»´æŠ¤çª—å£æ‰§è¡Œè¿ç§»**
4. **éªŒè¯åº”ç”¨åŠŸèƒ½æ­£å¸¸**
5. **ç›‘æ§ç³»ç»Ÿæ€§èƒ½**

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

### åŒçº§æ–‡æ¡£
- [5.1 æ¦‚å¿µæ¨¡å‹ï¼ˆER å›¾ï¼‰](æ¦‚å¿µæ¨¡å‹_ERå›¾.md)
- [5.2 è¡¨ç»“æ„å®šä¹‰](è¡¨ç»“æ„å®šä¹‰.md) 
- [5.3 å…³é”®è¡¨è¯´æ˜](å…³é”®è¡¨è¯´æ˜.md)
- [5.4 ç´¢å¼•ä¸ä¼˜åŒ–](ç´¢å¼•ä¸ä¼˜åŒ–.md)
- [5.6 æ•°æ®è®¿é—®æœ€ä½³å®è·µ](æ•°æ®è®¿é—®æœ€ä½³å®è·µ.md)

### è¿”å›ä¸Šçº§
- [ğŸ”™ æ•°æ®åº“è®¾è®¡æ€»è§ˆ](README.md)
- [ğŸ  é¡¹ç›®é¦–é¡µ](../../README.md)

### ç›¸å…³ç« èŠ‚
- [6.4 Git åˆ†æ”¯è§„èŒƒ](../06_å¼€å‘è§„èŒƒ/Gitåˆ†æ”¯è§„èŒƒ.md)
- [6.5 Code Review æµç¨‹](../06_å¼€å‘è§„èŒƒ/CodeReviewæµç¨‹.md)
