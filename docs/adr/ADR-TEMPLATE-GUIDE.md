# ADR 终极模板使用指南

> 本指南解释如何使用 `ADR-TEMPLATE-ULTIMATE.md` 编写可落地、不可滥用、三年后仍然成立的 ADR。

---

## 一、核心原则

### ADR 不是什么

❌ **不是**教学文档  
❌ **不是**技术博客  
❌ **不是**设计说明书  
❌ **不是**方案对比报告  

### ADR 是什么

✅ **系统的法律条文**  
✅ **可自动执法的规则**  
✅ **不依赖作者解释的裁决源**  
✅ **三年后仍然有效的架构宪法**  

---

## 二、六段式结构详解

### 第 1 段：规则本体（Rule）

**目的**：这是本 ADR 唯一具有裁决力的部分。

**写作要求**：

1. **必须用不可协商的语气**
   - ✅ 使用：必须（MUST）/ 禁止（MUST NOT）/ 应当（SHALL）/ 不应（SHALL NOT）
   - ❌ 禁止：建议 / 推荐 / 通常 / 尽量 / 可以

2. **必须可判真伪**
   - ✅ "Platform **禁止**依赖 Application"
   - ❌ "Platform 应该避免依赖 Application"

3. **必须独立于作者解释**
   - ✅ "模块**禁止**直接引用其他模块"
   - ❌ "为了保持模块独立性，我们建议..."

4. **必须简洁（≤ 1 页）**
   - 超过 1 页说明你在写设计说明，不是 ADR

**示例（合格）**：

```markdown
## 1. 规则本体

Platform **禁止**依赖 Application、Host 或任何模块。

模块**禁止**：
- 直接引用其他模块
- 跨模块边界共享领域对象
- 进行同步跨模块调用

所有跨模块通信**必须**使用以下方式之一：
- 领域事件（异步）
- 数据契约（只读 DTO）
- 原始类型（Guid、string、int）
```

**反例（不合格）**：

```markdown
## 1. 规则本体

为了保持系统的模块化，我们建议 Platform 层不要依赖 Application 层。
通常情况下，模块之间应该避免直接引用。
如果需要跨模块通信，可以考虑使用事件或契约。
```

---

### 第 2 段：执法模型（Enforcement）

**目的**：规则如果无法执法，就不配存在。

**写作要求**：

1. **必须标注执行级别**
   - L1：静态可执行（自动化测试，CI 阻断）
   - L2：语义半自动（Analyzer，人工复核）
   - L3：人工 Gate（Review/Checklist，架构裁决）

2. **必须映射到具体测试/手段**
   - 列出测试类名、方法名
   - 不列示例代码（那是说明文档的事）

**示例（合格）**：

```markdown
## 2. Enforcement

### 执行级别

| Level | 名称      | 执法方式               | 后果    |
| ----- | ------- | ------------------ | ----- |
| L1    | 静态可执行   | 自动化测试              | CI 阻断 |
| L2    | 语义半自动   | Analyzer / 启发式     | 人工复核  |
| L3    | 人工 Gate | Review / Checklist | 架构裁决  |

### 测试映射

| Rule 编号    | 执行级 | 测试 / 手段                                    |
| ---------- | --- | ------------------------------------------ |
| ADR-0001.1 | L1  | `Platform_Should_Not_Depend_On_Application` |
| ADR-0001.2 | L1  | `Modules_Should_Not_Reference_Each_Other`   |
| ADR-0001.3 | L2  | Roslyn Analyzer + Code Review              |
```

---

### 第 3 段：破例与归还（Exception）

**目的**：破例不是逃避，而是债务。

**写作要求**：

1. **明确破例的前提条件**
   - 技术限制
   - 性能约束
   - 迁移期遗留问题
   - 外部系统强制约束

2. **明确破例的要求**
   - 必须记录在 `ARCH-VIOLATIONS.md`
   - 必须指明 ADR 编号 + Rule 编号
   - 必须指定失效日期
   - 必须给出归还计划

**示例（合格）**：

```markdown
## 3. Exception

### 允许破例的前提

破例 **仅在以下情况允许**：

* 第三方库的技术限制（如必须在 Platform 层引用某个依赖 Application 的包）
* 迁移期遗留代码（必须在 6 个月内归还）
* 性能关键路径的特殊优化（需架构委员会审批）

### 破例要求

每个破例 **必须**：

* 记录在 `docs/summaries/ARCH-VIOLATIONS.md`
* 指明 ADR-0001 + Rule 编号（如 ADR-0001.1）
* 指定失效日期（不超过 6 个月）
* 给出归还计划（具体到季度）

**未记录的破例 = 未授权架构违规。**
```

---

### 第 4 段：变更政策（Change Policy）

**目的**：ADR 不是"随时可改"的文档。

**写作要求**：

1. **明确变更流程**
   - 宪法层 ADR：需架构修宪流程
   - 决策层 ADR：可 Superseded，但不得悄然修改

2. **明确失效机制**
   - Superseded ADR 必须指向替代 ADR
   - 不允许"隐性废弃"

**示例（合格）**：

```markdown
## 4. Change Policy

### 变更规则

* **宪法层 ADR**（ADR-0001~0005）

  * 修改 = 架构修宪
  * 需要架构委员会 100% 同意
  * 需要 2 周公示期
  * 需要全量回归测试

* **决策层 ADR**（ADR-100~999）

  * 可 Superseded
  * 不得悄然修改 Rule
  * 需要 Tech Lead 审批

### 失效与替代

* Superseded ADR **必须**：
  - 状态标记为 "Superseded by ADR-YYYY"
  - 指向替代 ADR
  - 保留在仓库中（不删除）
  
* 不允许"隐性废弃"（偷偷删除或不标记状态）
```

---

### 第 5 段：明确不管什么（Non-Goals）

**目的**：防止 ADR 膨胀的关键段落。

**写作要求**：

1. **明确列出本 ADR 不负责的事项**
2. **防止 ADR 被滥用为"万能规范"**

**示例（合格）**：

```markdown
## 5. Non-Goals

本 ADR **不负责**：

* 代码风格（如缩进、命名约定）
* 命名美学（如是否使用 I 前缀）
* 教学示例（参见 docs/copilot/）
* 实现细节（如具体使用哪个 ORM）
* 临时约定（如 Sprint 内的短期共识）

这些事项应在其他文档中处理：
- 代码风格 → `.editorconfig`
- 教学示例 → `docs/copilot/*.prompts.md`
- 实现细节 → `docs/technical/`
```

---

### 第 6 段：非裁决性参考（References）

**目的**：仅供理解，不具裁决力。

**写作要求**：

1. **明确标注"非裁决性"**
2. **仅列出相关资料，不作为规则依据**

**示例（合格）**：

```markdown
## 6. References

> **仅供理解，不具裁决力。**

* 相关 ADR
  - ADR-0002：Platform/Application/Host 边界
  - ADR-0005：应用交互模型

* 规范文档
  - docs/copilot/adr-0001.prompts.md

* 背景材料
  - [Modular Monolith Architecture](https://example.com)
  - [Vertical Slice Architecture](https://example.com)

* 历史讨论
  - GitHub Issue #123
  - RFC-001
```

---

## 三、写作红线（强制检查）

**出现以下任一项，说明你在写"说明文"，不是 ADR：**

### ❌ 长背景故事

```markdown
## 背景

在过去的两年中，我们的系统经历了多次重构...
团队讨论了很多方案，最终我们决定...
这个决策的背景是因为...
```

**正确做法**：背景放在 References，Rule 直接陈述规则。

---

### ❌ 方案对比表

```markdown
| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| A    | ...  | ...  | ✅   |
| B    | ...  | ...  | ❌   |
```

**正确做法**：方案对比放在 RFC 或历史文档，ADR 只陈述最终规则。

---

### ❌ 大段 Why 论证

```markdown
为什么我们选择模块化单体？因为...
为什么不用微服务？因为...
这样做的好处是...
```

**正确做法**：Why 放在 References，Rule 直接陈述规则。

---

### ❌ 示例代码

```csharp
// ✅ 正确示例
public class OrderHandler
{
    // ...
}

// ❌ 错误示例
public class OrderService
{
    // ...
}
```

**正确做法**：示例代码放在 `docs/copilot/*.prompts.md`，ADR 只陈述规则。

---

### ❌ "建议 / 推荐 / 尽量"

```markdown
我们建议模块之间不要直接引用。
推荐使用事件进行跨模块通信。
尽量避免在 Platform 层依赖 Application。
```

**正确做法**：用 MUST / MUST NOT。

---

### ❌ 读者假设

```markdown
为了帮助理解，我们先解释一下什么是模块化单体...
如果你不熟悉垂直切片，可以参考...
下面我们将详细说明...
```

**正确做法**：ADR 不负责教学，教学内容放在 `docs/copilot/` 或 `docs/guides/`。

---

## 四、写作流程

### 步骤 1：确认需要写 ADR

**问自己**：

1. 这是架构约束吗？（不是代码风格、不是临时约定）
2. 这需要自动化执法吗？（不只是建议）
3. 这会影响 3 年后的系统吗？（不是短期方案）

**如果有任何一个答案是"否"，就不要写 ADR。**

---

### 步骤 2：确定 ADR 层级

| 层级 | 编号范围 | 特征 | 示例 |
|------|---------|------|------|
| 宪法层 | 0001-0005 | 系统根基，不可推翻 | 模块隔离、层级边界 |
| 治理层 | 0000, 900-999 | 流程、CI、测试 | 架构测试、ADR 流程 |
| 结构层 | 100-199 | 结构细化 | 模块组织细节 |
| 运行层 | 200-299 | 运行时行为 | 协议、通信细节 |
| 技术层 | 300-399 | 技术选型 | ORM、日志框架 |

---

### 步骤 3：填写模板（只填 Rule）

1. **先写 Rule**，只写规则本体
2. **不写 Why**，不写背景，不写示例
3. **检查是否 ≤ 1 页**

---

### 步骤 4：设计执法机制

1. **标注每条规则的执行级别**（L1/L2/L3）
2. **设计自动化测试**（L1）
3. **设计 Analyzer 或 Checklist**（L2/L3）

---

### 步骤 5：明确破例机制

1. **什么情况允许破例？**
2. **破例如何记录？**
3. **破例如何归还？**

---

### 步骤 6：定义变更政策

1. **这个 ADR 可以修改吗？**
2. **修改需要什么流程？**
3. **废弃如何处理？**

---

### 步骤 7：标注 Non-Goals

1. **这个 ADR 不管什么？**
2. **防止被滥用为万能规范**

---

### 步骤 8：添加 References

1. **相关 ADR**
2. **背景材料**
3. **历史讨论**

---

## 五、质量检查清单

### ✅ Rule 段落检查

- [ ] 是否用 MUST / MUST NOT？
- [ ] 是否可判真伪？
- [ ] 是否独立于作者解释？
- [ ] 是否 ≤ 1 页？
- [ ] 是否没有"建议/推荐/尽量"？

### ✅ Enforcement 段落检查

- [ ] 是否标注了执行级别？
- [ ] 是否映射到具体测试/手段？
- [ ] 是否没有示例代码？

### ✅ Exception 段落检查

- [ ] 是否明确破例前提？
- [ ] 是否明确破例要求？
- [ ] 是否要求记录在 ARCH-VIOLATIONS.md？

### ✅ Change Policy 段落检查

- [ ] 是否明确变更流程？
- [ ] 是否明确失效机制？

### ✅ Non-Goals 段落检查

- [ ] 是否明确列出不负责的事项？
- [ ] 是否防止 ADR 膨胀？

### ✅ References 段落检查

- [ ] 是否标注"非裁决性"？
- [ ] 是否仅列出相关资料？

### ✅ 红线检查

- [ ] 是否没有长背景故事？
- [ ] 是否没有方案对比表？
- [ ] 是否没有大段 Why 论证？
- [ ] 是否没有示例代码？
- [ ] 是否没有"建议/推荐/尽量"？
- [ ] 是否没有读者假设？

---

## 六、ADR 终极一句话定义

> **ADR 是系统的法律条文，不是架构师的解释说明。**

---

## 七、现在可以开始

你现在可以：

1. ✅ **使用这个模板编写新 ADR**
2. ✅ **拒绝不符合模板的 ADR**
3. ✅ **要求现有 ADR 重构为这个格式**

**记住**：凡是不适合放进这个模板的内容，都不配叫 ADR。

---

## 附录：常见错误示例

### 错误示例 1：Rule 不够明确

❌ **错误**：

```markdown
## 1. Rule

模块之间应该保持独立，避免直接依赖。
```

✅ **正确**：

```markdown
## 1. Rule

Modules **MUST NOT** reference each other directly.
```

---

### 错误示例 2：缺少执法机制

❌ **错误**：

```markdown
## 2. Enforcement

我们会通过 Code Review 来确保这一点。
```

✅ **正确**：

```markdown
## 2. Enforcement

### 执行级别

| Level | 名称      | 执法方式   | 后果    |
| ----- | ------- | -------- | ----- |
| L1    | 静态可执行 | 自动化测试 | CI 阻断 |

### 测试映射

| Rule 编号    | 执行级 | 测试 / 手段                              |
| ---------- | --- | ------------------------------------ |
| ADR-0001.1 | L1  | `Modules_Should_Not_Reference_Each_Other` |
```

---

### 错误示例 3：包含示例代码

❌ **错误**：

```markdown
## 1. Rule

Modules MUST NOT reference each other directly.

示例：

```csharp
// ✅ 正确
await _eventBus.Publish(new OrderCreated(...));

// ❌ 错误
var member = await _memberRepository.GetByIdAsync(...);
```
```

✅ **正确**：

```markdown
## 1. Rule

Modules **MUST NOT** reference each other directly.

## 6. References

* 示例代码：docs/copilot/adr-0001.prompts.md
```

---

## 结语

这个模板的核心思想是：

1. **ADR = 法律条文**，不是说明文档
2. **Rule = 唯一裁决源**，不依赖作者解释
3. **Enforcement = 执法机制**，规则必须可执行
4. **Exception = 债务管理**，破例不是逃避
5. **Change Policy = 修宪流程**，不是随意修改
6. **Non-Goals = 边界声明**，防止 ADR 膨胀

**最后一句实话**：

> **你现在可以开始拒绝不符合模板的 ADR 了。**
