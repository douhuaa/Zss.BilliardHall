# ADR-0005：应用内交互模型与执行边界（Application Interaction Model）

**状态**：✅ Final（运行时宪法，不依赖具体技术栈）  
**级别**：架构根约束（Runtime Constitutional Rule）  
**适用范围**：Application / Modules / Host（不含 Platform 实现细节）  
**生效时间**：即刻  

---

## 摘要

- **目的**：在“垂直切片 + 模块隔离”的架构前提下，定义应用在**运行时**的明确规则：
  - 谁拥有业务决策权
  - 一个请求如何被执行
  - 模块之间如何协作
  - 同步 / 异步的边界在哪里
- **核心立场**：本 ADR **不绑定任何框架或库**，只规定“行为语义”。
- **约束级别**：违反即视为架构违规，需显式破例审批。

---

## 背景

前序 ADR（0001–0004）已经解决了以下**静态问题**：

- 代码如何组织（模块、层级、命名）
- 项目如何启动（Platform / Application / Host）
- 依赖如何管理（CPM、引用规则）

但系统是否**长期可演进**，取决于运行时是否有清晰规则：

- 业务决策在哪里发生？
- Handler 能不能随意调用别的模块？
- 同步与异步的语义是否统一？

如果缺失这层约束，系统会不可避免地演化为：

- Endpoint 偷跑业务逻辑
- Handler 变成万能 Service
- 模块边界被同步调用击穿
- Saga / 事务被滥用

因此，本 ADR 定义“应用内交互模型”，作为运行时的**宪法级约束**。

---

## 决策（核心规则）

### 1. 最小执行单元：Use Case + Handler

- **最小执行单元**是一个明确的业务用例（Use Case）。
- 每个 Use Case **必须对应一个 Handler**，且该 Handler 是该业务意图的**唯一权威**。
- Endpoint / Controller / Adapter 仅负责：
  - 接收外部请求
  - 映射为 Use Case
  - 转发给 Handler

**禁止**：
- 在 Endpoint 中执行业务规则
- 在多个 Handler 中分散同一业务决策

---

### 2. Handler 职责边界（不可模糊）

Handler 必须满足以下条件：

**允许**：
- 执行业务规则与决策
- 协调持久化、消息发布、外部调用
- 返回结果或发布事件

**禁止**：
- 承载长期状态
- 作为跨模块同步粘合层
- 返回领域实体作为跨模块 DTO

**约束**：
- 一个 Handler 只处理一个业务意图
- Handler 应为短生命周期、无状态、可重入

---

### 3. 同步 / 异步原则（硬规则）

- **模块内**：允许同步调用
- **模块间**：默认异步通信（事件 / 消息）

**明确禁止**：
- 未审批的跨模块同步调用

**例外（需审批）**：
- 明确的远程调用契约（HTTP / RPC 等）
- 必须视为不可靠远端调用（超时、失败、降级）

异步通信语义：**最终一致性**。

---

### 4. 模块通信契约（Contracts）

- 模块间只能通过显式、版本化的契约通信
- 禁止引用其他模块的内部类型或领域模型

契约分层：

- Domain Event：模块内部事实
- Module Event：模块级公开契约
- Integration Event：跨系统契约（只增不改）

共享仅限 DTO，不共享实体或 VO。

---

### 5. 查询（Read）与命令（Write）

- Query：只读投影 / DTO
- Command：通过 Handler 执行业务决策

**禁止**：
- 通过跨模块同步查询驱动写操作

---

### 6. 事务与一致性语义

- 不使用全局分布式事务
- 跨模块一致性通过：
  - 事件驱动
  - 幂等消费
  - 补偿流程（Saga）

Saga 仅用于：跨模块 + 跨时间 + 需补偿 的场景。

---

### 7. 错误与失败语义

- 错误必须结构化（ErrorCode + Message）
- 异步失败必须可观测（死信、告警、重试策略）

---

### 8. 自动化校验（CI）

必须自动化检查：

- 模块间非法依赖
- Handler 复杂度 / 行数
- Host / Platform 引用业务代码
- 未声明的跨模块同步调用

违规 = CI 失败。

---

### 9. 破例流程（治理）

- 所有破例必须显式记录
- 必须包含：理由、范围、期限、归还计划
- 破例默认有失效期

---

## 不遵守的后果

- 模块边界被侵蚀
- 架构退化为“同步泥球”
- 复杂度失控，重构成本指数级上升

---

## 结论

ADR-0005 定义的不是技术选型，而是**运行时秩序**：

> 谁能做决定、如何协作、失败如何承担。

只要这份 ADR 仍被遵守，底层技术可自由演进，系统仍然站得住。

