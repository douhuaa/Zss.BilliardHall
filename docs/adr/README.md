# 架构决策记录（Architecture Decision Records）

**版本**：2.0  
**最后更新**：2026-01-21  
**状态**：Active  

---

## 概述

本目录包含 Zss.BilliardHall 项目的所有架构决策记录（ADR）。ADR 按照职责分为三个层次：

```
                    架构决策记录（ADR）体系
                    =====================

┌──────────────────────────────────────────────────────────────┐
│                    宪法层（ADR-0000 ~ 0005）                 │
│                 (不可推翻，只能细化，破例必审)               │
└──────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        ▼                     ▼                     ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ 静态结构层    │   │ 运行时行为层  │   │ 架构治理层    │
│   (WHAT)      │   │    (HOW)      │   │ (GUARDRAIL)   │
├───────────────┤   ├───────────────┤   ├───────────────┤
│ ADR-0001      │   │ ADR-0005      │   │ ADR-0000      │
│ 模块与切片    │   │ 交互模型      │   │ 架构测试      │
│               │   │               │   │               │
│ ADR-0002      │   │               │   │ + 辅助文档    │
│ 启动体系      │   │               │   │ - Levels      │
│               │   │               │   │ - Layer       │
│ ADR-0003      │   │               │   │               │
│ 命名空间      │   │               │   │               │
│               │   │               │   │               │
│ ADR-0004      │   │               │   │               │
│ 包管理        │   │               │   │               │
└───────────────┘   └───────────────┘   └───────────────┘
```

1. **静态结构层（WHAT）**：定义系统的组织结构、模块划分、命名规范等静态约束
2. **运行时行为层（HOW）**：定义系统的执行模型、模块通信、一致性保障等动态行为
3. **架构治理层（GUARDRAIL）**：定义架构自动化校验、破例流程、CI 治理等保障机制

---

## 快速导航

### 我该从哪里开始？

| 如果你想了解...                | 请阅读              | 简要说明                          |
|--------------------------------|---------------------|-----------------------------------|
| 系统的整体架构风格             | ADR-0001            | 模块化单体与垂直切片架构          |
| 系统如何启动和装配             | ADR-0002            | 三层启动体系                      |
| 命名空间和项目如何组织         | ADR-0003            | 命名空间与工程映射规范            |
| 依赖包如何管理                 | ADR-0004            | 中央包管理（CPM）                 |
| 业务用例如何执行               | ADR-0005            | 应用内运行模型                    |
| 架构如何自动化校验             | ADR-0000            | 架构测试与 CI 治理                |

---

## A. 静态结构层（WHAT）

定义系统的组织结构、边界划分和静态约束。

### [ADR-0001：模块化单体与垂直切片架构](ADR-0001-modular-monolith-vertical-slice-architecture.md)

**主轴**：模块组织 + 垂直切片  
**聚焦内容**：
- 功能模块的划分方式
- 垂直切片的组织原则
- 模块隔离规则
- 契约使用规则（Contracts）
- 模块通信约束（事件、契约、原始类型）

**禁止内容**：
- ❌ 模块间直接引用
- ❌ 横向 Service 层
- ❌ 跨模块共享领域模型

---

### [ADR-0002：Platform / Application / Host 三层启动体系](ADR-0002-platform-application-host-bootstrap.md)

**主轴**：启动体系 / 层级模型  
**聚焦内容**：
- 三层装配模型（Platform / Application / Host）
- 层级依赖方向（单向依赖）
- 唯一入口规范（Bootstrapper）
- 目录结构标准

**禁止内容**：
- ❌ Platform 依赖 Application
- ❌ Application 依赖 Host
- ❌ Host 包含业务逻辑
- ❌ Program.cs 超过 30 行

---

### [ADR-0003：命名空间与项目边界规范](ADR-0003-namespace-rules.md)

**主轴**：命名空间与工程映射  
**聚焦内容**：
- BaseNamespace 固定规则
- 目录 → RootNamespace 自动推导
- MSBuild 策略
- 防御性规则

**禁止内容**：
- ❌ 手动覆盖 BaseNamespace
- ❌ 不规范命名空间（Common、Shared、Utils）
- ❌ 命名空间与物理结构不一致

---

### [ADR-0004：中央包管理（CPM）规范](ADR-0004-Cpm-Final.md)

**主轴**：中央包管理与依赖分层规则  
**聚焦内容**：
- Directory.Packages.props 集中管理
- 层级依赖规则（Platform / Application / Modules / Host）
- 包分组策略
- 防御性规则

**禁止内容**：
- ❌ 项目手动指定包版本
- ❌ 层级越界引用包
- ❌ 未批准的依赖

---

## B. 运行时行为层（HOW）

定义系统的执行模型、模块协作和一致性保障。

### [ADR-0005：应用内交互模型与执行边界](ADR-0005-Application-Interaction-Model-Final.md)

**主轴**：应用内运行模型  
**聚焦内容**：
- Use Case + Handler 执行模型
- 模块通信方式（同步 vs 异步）
- 查询与命令分离（CQRS）
- 事务与一致性语义
- 错误与失败语义

**禁止内容**：
- ❌ Endpoint 包含业务逻辑
- ❌ Handler 承载长期状态
- ❌ 模块间未审批的同步调用
- ❌ 模块共享领域实体
- ❌ 全局分布式事务

**辅助文档**：
- [ADR-0005-Enforcement-Levels.md](ADR-0005-Enforcement-Levels.md)：执行级别分类（静态可执行 / 语义半自动 / 人工 Gate）

---

## C. 架构治理层（GUARDRAIL）

定义架构自动化校验、破例流程和 CI 治理机制。

### [ADR-0000：架构测试与 CI 治理](ADR-0000-architecture-tests.md)

**主轴**：架构测试与 CI 治理宪法  
**聚焦内容**：
- 架构测试的定义与边界
- ADR 与测试的映射关系
- 测试组织原则
- CI 阻断策略
- 破例流程与记录

**核心原则**：
- ✅ 每条 ADR 必须有对应测试
- ✅ 测试失败 = 构建失败
- ✅ 破例必须显式记录

---

## 宪法层约束

### [ARCHITECTURE-CONSTITUTIONAL-LAYER.md](ARCHITECTURE-CONSTITUTIONAL-LAYER.md)

定义 ADR-0000 至 ADR-0005 构成的"架构宪法层"：
- **不可推翻**：后续 ADR 不得与宪法层冲突
- **只能细化**：后续 ADR 只能补充细节，不能削弱约束
- **破例必审**：所有违反宪法层的破例必须经过审批
- **永久记录**：所有破例记录在案，可追溯

---

## ADR 编写规范

每个 ADR 必须包含以下标准结构：

### 1. 头部元信息
```markdown
# ADR-XXXX：标题

**状态**：✅ 已采纳 / ⚠️ 草稿 / ❌ 已废弃  
**级别**：架构约束 / 技术选型 / 最佳实践  
**适用范围**：...  
**生效时间**：...  
```

### 2. 本章聚焦内容（Focus）
明确说明本 ADR 的主轴和边界。

### 3. 术语表（Glossary）
定义本 ADR 使用的关键术语，避免误解。

### 4. 核心决策（Decision）
明确的决策内容，包括"允许"和"禁止"。

### 5. 与其他 ADR 关系（Related ADRs）
说明本 ADR 与其他 ADR 的关系（依赖、补充、引用）。

### 6. 章末参考表（Quick Reference）
提供快速查询的表格或清单。

---

## 快速查询索引

### 按关注点查询

| 关注点                     | 相关 ADR                        |
|----------------------------|---------------------------------|
| 模块如何划分               | ADR-0001                        |
| 模块如何通信               | ADR-0001, ADR-0005              |
| 系统如何启动               | ADR-0002                        |
| 命名空间规则               | ADR-0003                        |
| 依赖包管理                 | ADR-0004                        |
| Use Case 如何执行          | ADR-0005                        |
| 同步 vs 异步               | ADR-0005                        |
| 架构如何校验               | ADR-0000                        |
| 如何申请破例               | ADR-0000                        |

### 按角色查询

| 角色                       | 必读 ADR                        | 选读 ADR                        |
|----------------------------|---------------------------------|---------------------------------|
| 新成员 Onboarding          | ADR-0001, ADR-0002, ADR-0005    | ADR-0000, ADR-0003, ADR-0004    |
| 前端开发                   | ADR-0001, ADR-0005              | ADR-0002                        |
| 后端开发                   | 全部                            | -                               |
| DevOps / SRE               | ADR-0000, ADR-0002, ADR-0004    | ADR-0001, ADR-0003, ADR-0005    |
| 架构师                     | 全部                            | -                               |
| Tech Lead                  | 全部                            | -                               |

---

## 文档维护

### 修订流程

1. **宪法层 ADR（ADR-0000 ~ 0005）**：
   - 需架构委员会全体一致同意
   - 至少 2 周公示期
   - 修订历史永久记录

2. **后续 ADR（ADR-0006+）**：
   - 提交 RFC（Request for Comments）
   - 经 Tech Lead 或架构师审批
   - 记录在 ADR 中

### 文档归档

废弃的 ADR 不删除，而是：
1. 修改状态为 `❌ 已废弃`
2. 说明废弃理由和替代方案
3. 保留在目录中，供历史查询

---

## 常见问题（FAQ）

### Q: 为什么要分三个层次？

**A:** 静态结构、运行时行为和治理机制是三种不同性质的约束：
- 静态结构关注"是什么"（WHAT）
- 运行时行为关注"怎么做"（HOW）
- 治理机制关注"如何保障"（GUARDRAIL）

分层可以避免内容混杂，便于查阅和维护。

---

### Q: 如果后续 ADR 与宪法层冲突怎么办？

**A:** 宪法层优先级最高：
1. 冲突的后续 ADR 条款自动无效
2. 必须修订后续 ADR，使其符合宪法层
3. 不允许以"折中"方式削弱宪法层

---

### Q: 如何判断应该放在哪个 ADR？

**A:** 使用以下决策树：

```
是否关于架构测试或治理？
├─ 是 → ADR-0000
└─ 否 → 是否关于运行时行为？
    ├─ 是 → ADR-0005
    └─ 否 → 是否关于启动和装配？
        ├─ 是 → ADR-0002
        └─ 否 → 是否关于命名空间？
            ├─ 是 → ADR-0003
            └─ 否 → 是否关于依赖管理？
                ├─ 是 → ADR-0004
                └─ 否 → ADR-0001
```

---

### Q: 架构测试在哪里？

**A:** 架构测试代码位于 `/src/tests/ArchitectureTests/ADR/` 目录：
- `ADR_0000_Architecture_Tests.cs`
- `ADR_0001_Architecture_Tests.cs`
- `ADR_0002_Architecture_Tests.cs`
- `ADR_0003_Architecture_Tests.cs`
- `ADR_0004_Architecture_Tests.cs`
- `ADR_0005_Architecture_Tests.cs`

每个 ADR 都有对应的测试类，测试失败会阻断 CI。

---

## 参考资料

- [ADR 模板](https://github.com/joelparkerhenderson/architecture-decision-record)
- [Vertical Slice Architecture](https://www.jimmybogard.com/vertical-slice-architecture/)
- [Modular Monolith Architecture](https://www.kamilgrzybek.com/blog/posts/modular-monolith-primer)
- [NetArchTest](https://github.com/BenMorris/NetArchTest)

---

## 版本历史

| 版本  | 日期       | 变更说明                          |
|-------|------------|-----------------------------------|
| 2.0   | 2026-01-21 | 优化 ADR 结构，分离静态/动态/治理层 |
| 1.0   | 2026-01-20 | 初始版本                          |
