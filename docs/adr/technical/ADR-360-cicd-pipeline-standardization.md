# ADR-360：CI/CD Pipeline 流程标准化

**状态**：Draft  
**级别**：技术层  
**影响范围**：所有 CI/CD 流程  
**生效时间**：待审批通过后

---

## 规则本体（Rule）

> **这是本 ADR 唯一具有裁决力的部分。**

### ADR-360.1：所有 PR 必须通过架构测试

Pull Request **必须**通过所有架构测试才能合并。

**强制要求**：
- ✅ 架构测试在 CI 中自动运行
- ✅ 架构测试失败阻止 PR 合并
- ❌ 禁止跳过架构测试
- ❌ 禁止在 CI 中标记架构测试为可选

### ADR-360.2：PR 必须包含变更类型标签

所有 PR 标题**必须**以 Conventional Commits 类型前缀开头。

**允许的前缀**：
- ✅ `feat:`、`fix:`、`docs:`、`refactor:`、`test:`、`chore:`
- ❌ 无前缀或自定义前缀

**验证**：
- CI 自动检查 PR 标题格式
- 不符合格式的 PR 无法合并

### ADR-360.3：main 分支必须受保护

`main` 分支**必须**启用分支保护规则。

**保护规则**：
- ✅ 禁止直接推送
- ✅ 要求 PR 审查
- ✅ 要求状态检查通过
- ✅ 要求分支为最新状态

### ADR-360.4：CI 失败必须提供清晰的错误信息

CI 失败时**必须**提供清晰、可操作的错误信息。

**错误信息要求**：
- ✅ 明确指出失败的步骤
- ✅ 提供失败原因和修复建议
- ✅ 包含相关文档链接（如 ADR 编号）
- ❌ 禁止仅输出堆栈跟踪

### ADR-360.5：构建产物必须包含版本信息

所有构建产物**必须**包含完整的版本和构建信息。

**版本信息要求**：
- ✅ Git commit SHA
- ✅ 构建时间
- ✅ 分支名称
- ✅ 版本号（如适用）

---

## 执法模型（Enforcement）

> **规则如果无法执法，就不配存在。**

### 测试映射

| 规则编号 | 执行级 | 测试/手段 |
|---------|--------|----------|
| ADR-360.1 | L1 | GitHub Actions 强制检查 |
| ADR-360.2 | L1 | CI Workflow 自动验证 |
| ADR-360.3 | L1 | GitHub 分支保护规则 |
| ADR-360.4 | L2 | 人工审查 CI 配置 |
| ADR-360.5 | L1 | 构建脚本验证 |

---

## 破例与归还（Exception）

> **破例不是逃避，而是债务。**

### 允许破例的前提

破例**仅在以下情况允许**：

1. **紧急热修复**：生产环境重大故障
2. **CI 系统故障**：CI 服务本身不可用
3. **测试误报**：测试存在已知 Bug 待修复

### 破例要求（不可省略）

每个破例**必须**：

- 获得 Tech Lead 明确批准
- 记录在 `docs/summaries/arch-violations.md`
- 在 24 小时内修复或归还

---

## 变更政策（Change Policy）

> **ADR 不是"随时可改"的文档。**

### 变更规则

* **技术层 ADR**
  * 修改需 Tech Lead 审批
  * CI/CD 工具升级可触发更新

---

## 明确不管什么（Non-Goals）

> **防止 ADR 膨胀的关键段落。**

本 ADR **不负责**：

- ✗ 具体的 CI 工具选择（GitHub Actions/Jenkins/GitLab CI）
- ✗ 部署策略（蓝绿/金丝雀）
- ✗ 代码覆盖率阈值
- ✗ 性能测试的 CI 集成

---

## 非裁决性参考（References）

> **仅供理解，不具裁决力。**

### 相关 ADR
- ADR-0000：架构测试与 CI 治理
- ADR-930：代码审查与 ADR 合规自检流程

### 实践指导
- CI 配置示例参见 `.github/workflows/`
- 常见问题参见 `docs/copilot/adr-0360.prompts.md`

---

## 版本历史

| 版本 | 日期 | 变更说明 | 修订人 |
|-----|------|---------|--------|
| 1.0 Draft | 2026-01-24 | 初始版本 | GitHub Copilot |

---

# ADR 终极一句话定义

> **ADR 是系统的法律条文，不是架构师的解释说明。**
