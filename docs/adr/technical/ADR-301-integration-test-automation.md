# ADR-301：集成测试环境自动化与隔离约束

**状态**：Draft  
**级别**：技术层  
**影响范围**：所有集成测试  
**生效时间**：待审批通过后

---

## 规则本体（Rule）

> **这是本 ADR 唯一具有裁决力的部分。**

### ADR-301.1：集成测试必须使用 TestContainers 管理外部依赖

所有集成测试**必须**使用 TestContainers 或等效容器化方案管理外部依赖（数据库、消息队列等）。

**强制要求**：
- ✅ 数据库使用 TestContainers（如 PostgreSQL、SQL Server）
- ✅ 消息队列使用 TestContainers（如 RabbitMQ、Kafka）
- ❌ 禁止依赖开发者本地安装的外部服务
- ❌ 禁止依赖共享的远程测试环境

**例外情况**：
- 纯内存数据库（如 SQLite InMemory）可不使用容器
- 轻量级嵌入式服务可不使用容器

### ADR-301.2：每个测试类必须使用独立的数据库实例

每个测试类**必须**使用独立的数据库实例或独立的数据库 Schema。

**隔离要求**：
- ✅ 不同测试类之间数据完全隔离
- ✅ 测试失败不影响其他测试
- ❌ 禁止多个测试类共享同一数据库实例

**实现方式**：
- 方式 1：每个测试类启动独立容器
- 方式 2：共享容器但使用不同 Schema/Database
- 方式 3：使用事务回滚（仅限特定场景）

### ADR-301.3：测试数据必须在测试结束后自动清理

测试数据**必须**在测试结束后自动清理，不得残留。

**清理策略**：
- ✅ 容器销毁（推荐）
- ✅ 数据库删除
- ✅ 事务回滚
- ❌ 禁止手动清理（不可靠）

### ADR-301.4：集成测试必须支持并行执行

集成测试**必须**设计为可并行执行，不得有顺序依赖。

**并行要求**：
- ✅ 测试类之间可并行
- ✅ 同一测试类内的测试可并行（如果技术允许）
- ❌ 禁止使用全局静态状态
- ❌ 禁止依赖特定的测试执行顺序

**xUnit 实现**：
```csharp
[Collection("Integration")] // 定义集合进行隔离
public class OrderTests : IClassFixture<DatabaseFixture>
{
    // 测试实现
}
```

### ADR-301.5：容器启动必须有超时和健康检查

TestContainer 启动**必须**设置合理的超时时间和健康检查。

**配置要求**：
- ✅ 设置启动超时（推荐 60-120 秒）
- ✅ 配置健康检查策略
- ✅ 失败时输出清晰的错误信息
- ❌ 禁止无限等待容器启动

### ADR-301.6：集成测试执行策略必须区分本地与 CI

集成测试**必须**支持本地开发和 CI 环境的差异化策略。

**本地环境策略**：
- ✅ 允许复用容器实例（提高开发效率）
- ✅ 允许使用长生命周期容器
- ✅ 可使用本地缓存加速
- ❌ 不强制每次完全隔离（开发体验优先）

**CI 环境策略**：
- ✅ 严格隔离，每次全新容器
- ✅ 禁止复用状态
- ✅ 确保测试确定性
- ❌ 不优化启动时间（正确性优先）

**配置切换**：
```csharp
// 通过环境变量区分
var reuseContainers = Environment.GetEnvironmentVariable("CI") != "true";
```

**原因**：避免本地开发缓慢导致开发者绕过测试，同时确保 CI 的严格性和确定性。

---

## 执法模型（Enforcement）

> **规则如果无法执法，就不配存在。**

### 测试映射

| 规则编号 | 执行级 | 测试/手段 |
|---------|--------|----------|
| ADR-301.1 | L2 | Code Review + CI 检查 |
| ADR-301.2 | L2 | Code Review |
| ADR-301.3 | L3 | 人工审查 + Runtime 监控 |
| ADR-301.4 | L2 | CI 并行执行验证 |
| ADR-301.5 | L2 | Code Review |
| ADR-301.6 | L2 | CI 配置验证 |

### 架构测试说明

**L2 测试**：
- 检查集成测试项目是否引用 TestContainers
- 验证测试类是否正确使用 Fixture 模式
- CI 中运行并行测试验证

**L3 测试**：
- 检查测试环境清理的完整性
- 监控测试数据库的状态

---

## 破例与归还（Exception）

> **破例不是逃避，而是债务。**

### 允许破例的前提

破例**仅在以下情况允许**：

1. **CI 环境限制**：CI 环境不支持 Docker
2. **性能关键测试**：容器启动开销不可接受
3. **遗留测试迁移期**：大规模重构的过渡阶段

### 破例要求（不可省略）

每个破例**必须**：

- 记录在 `docs/summaries/arch-violations.md`
- 说明技术限制和替代方案
- 提供迁移计划（不超过 6 个月）

---

## 变更政策（Change Policy）

> **ADR 不是"随时可改"的文档。**

### 变更规则

* **技术层 ADR**
  * 修改需 Tech Lead 审批
  * 可因技术栈升级而调整
  * 必须提供迁移指南

---

## 明确不管什么（Non-Goals）

> **防止 ADR 膨胀的关键段落。**

本 ADR **不负责**：

- ✗ 单元测试的组织（仅管集成测试）
- ✗ 测试数据的生成策略
- ✗ Mock 框架的选择
- ✗ 性能测试的环境配置
- ✗ E2E 测试的基础设施

---

## 非裁决性参考（References）

> **仅供理解，不具裁决力。**

### 相关 ADR
- ADR-122：测试代码组织与命名规范
- ADR-360：CI/CD Pipeline 流程标准化

### 技术资源
- [TestContainers 官方文档](https://testcontainers.com/)
- [xUnit Fixtures 文档](https://xunit.net/docs/shared-context)

### 实践指导
- 详细配置示例参见 `docs/copilot/adr-0301.prompts.md`

---

## 版本历史

| 版本 | 日期 | 变更说明 | 修订人 |
|-----|------|---------|--------|
| 1.0 Draft | 2026-01-24 | 初始版本 | GitHub Copilot |

---

# ADR 终极一句话定义

> **ADR 是系统的法律条文，不是架构师的解释说明。**
