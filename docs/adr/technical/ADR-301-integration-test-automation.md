---
adr: ADR-301
title: "集成测试环境自动化与隔离约束"
status: Final
level: Technical
version: "2.0"
deciders: "Architecture Board"
date: 2026-01-26
maintainer: "Architecture Board"
primary_enforcement: L1
reviewer: "GitHub Copilot"
supersedes: null
superseded_by: null
---


# ADR-301：集成测试环境自动化与隔离约束

**影响范围**：所有集成测试、测试基础设施  
## Focus（聚焦内容）

- 集成测试的外部依赖管理规则
- 测试环境隔离与并行执行约束
- 测试数据清理与容器生命周期管理
- 本地开发与 CI 环境差异化策略

---

---

## Glossary（术语表）


| 术语 | 定义 | 英文对照 |
|------|------|----------|
| 待补充 | 待补充 | TBD |


---

---

## Decision（裁决）

### ADR-301.1：外部依赖容器化管理【必须架构测试覆盖】

集成测试**必须**使用容器化方案管理外部依赖。

**规则**：
- 数据库**必须**使用 TestContainers 或等效容器
- 消息队列**必须**使用 TestContainers 或等效容器
- **禁止**依赖开发者本地安装服务
- **禁止**依赖共享远程测试环境

**例外**：
- 纯内存数据库（如 SQLite InMemory）可不使用容器
- 轻量级嵌入式服务可不使用容器

**判定**：
- ❌ 集成测试引用本地数据库连接字符串
- ❌ 测试依赖远程共享测试服务
- ✅ 使用 TestContainers 启动独立容器

---

### ADR-301.2：测试类隔离规则【必须架构测试覆盖】

每个测试类**必须**使用独立数据库实例或 Schema。

**规则**：
- 不同测试类**必须**完全隔离数据
- 测试失败**不得**影响其他测试
- **禁止**多个测试类共享数据库实例

**实现方式**（三选一）：
1. 每个测试类独立容器
2. 共享容器使用不同 Schema/Database
3. 事务回滚（限特定场景）

**判定**：
- ❌ 多个测试类使用同一数据库无隔离
- ❌ 测试 A 失败导致测试 B 失败
- ✅ 每个测试类独立数据环境

---

### ADR-301.3：测试数据自动清理【必须架构测试覆盖】

测试数据**必须**在测试结束后自动清理。

**规则**：
- **必须**通过容器销毁、数据库删除或事务回滚清理
- **禁止**依赖手动清理
- **禁止**测试数据残留

**判定**：
- ❌ 测试结束后数据仍在数据库中
- ❌ 需要手动清理测试环境
- ✅ 容器销毁或事务回滚自动清理

---

### ADR-301.4：并行执行支持【必须架构测试覆盖】

集成测试**必须**支持并行执行。

**规则**：
- 测试类之间**必须**可并行执行
- **禁止**全局静态状态依赖
- **禁止**测试执行顺序依赖

**判定**：
- ❌ 测试 A 必须在测试 B 之前执行
- ❌ 测试使用全局静态变量共享状态
- ✅ 任意顺序并行执行结果一致

---

### ADR-301.5：容器启动超时与健康检查【必须架构测试覆盖】

TestContainer 启动**必须**配置超时和健康检查。

**规则**：
- **必须**设置启动超时（推荐 60-120 秒）
- **必须**配置健康检查策略
- 失败时**必须**输出清晰错误信息
- **禁止**无限等待容器启动

**判定**：
- ❌ 容器启动无超时无限等待
- ❌ 容器启动失败无错误信息
- ✅ 配置超时和健康检查

---

### ADR-301.6：本地与 CI 环境差异化策略【必须架构测试覆盖】

集成测试**必须**区分本地开发和 CI 环境策略。

**本地环境规则**：
- 允许复用容器实例（开发效率优先）
- 允许长生命周期容器
- 允许本地缓存加速
- 不强制每次完全隔离

**CI 环境规则**：
- **必须**严格隔离，每次全新容器
- **禁止**复用状态
- **必须**确保测试确定性
- 不优化启动时间（正确性优先）

**判定**：
- ❌ CI 环境复用容器导致测试不稳定
- ❌ 本地环境强制隔离导致开发缓慢
- ✅ 通过环境变量区分策略

---

---

## Enforcement（执法模型）

### 测试实现

**L2 测试**：
- 检查集成测试项目引用 TestContainers 包
- 验证测试类使用 Fixture 模式
- CI 中运行并行测试验证隔离性

**L3 测试**：
- 人工审查测试清理完整性
- 监控测试数据库状态

**CI 阻断条件**：
- 集成测试项目未引用 TestContainers → CI 失败
- 并行执行失败 → CI 失败
- 测试类未使用隔离机制 → Code Review 阻断

---
---

## Non-Goals（明确不管什么）

本 ADR 明确不涉及以下内容：

- 待补充

---

## Prohibited（禁止行为）


以下行为明确禁止：

- 待补充


---

---

## Relationships（关系声明）

**依赖（Depends On）**：
- [ADR-0000：架构测试与 CI 治理宪法](../governance/ADR-0000-architecture-tests.md) - 集成测试基于测试治理机制
- [ADR-122：测试组织与命名](../structure/ADR-122-test-organization-naming.md) - 集成测试遵循测试组织规范

**被依赖（Depended By）**：
- 无

**替代（Supersedes）**：
- 无

**被替代（Superseded By）**：
- 无

**相关（Related）**：
- 无

---

---

## References（非裁决性参考）

### 相关 ADR
- ADR-122：测试代码组织与命名规范
- ADR-360：CI/CD Pipeline 流程标准化

### 技术资源
- [TestContainers 官方文档](https://testcontainers.com/)
- [xUnit Fixtures 文档](https://xunit.net/docs/shared-context)

### 实践指导
- 详细配置示例参见 `docs/copilot/adr-0301.prompts.md`（待创建）

---

---

## History（版本历史）


| 版本  | 日期         | 变更说明   |
|-----|------------|--------|
| 1.0 | 待补充 | 初始版本 |
