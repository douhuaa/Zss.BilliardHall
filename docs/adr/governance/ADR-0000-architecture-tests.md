# ADR-0000：架构测试与 CI 治理宪法

> **唯一架构执法元规则**：本文件定义架构合法性评判的唯一基准。所有架构测试、CI 校验、Prompt 映射、破例治理均以本 ADR 正文为裁定源。

**状态**：✅ Final（不可随意修改）  
**级别**：架构治理 / 宪法层  
**生效时间**：即刻  
**适用范围**：全体代码仓库及所有 ADR（ADR-0001 ~ 0005）

---

## 聚焦内容（Focus）

- ADR-测试一一映射与唯一性
- 自动化校验与 CI 阻断机制
- 架构约束的分级测试与溯源跟踪
- 破例治理与到期归还
- Prompts/流程/文档合规自检闭环

---

## 术语表（Glossary）

| 术语       | 定义                         |
|------------|------------------------------|
| 架构测试   | 可自动执行的结构约束型测试   |
| ADR-测试映射 | ADR 【必须架构测试覆盖】→ 测试用例 |
| CI 阻断    | 测试失败即阻断 PR / 发布     |
| 破例       | 已批准的临时性违规（需归还） |

---

## 核心决策（Decision）

- 所有【必须架构测试覆盖】的 ADR 条款，须有自动化测试（静态/语义/人工 Gate）
- 测试类、方法名、失败消息必须显式标注 ADR 编号
- 架构测试失败 = 架构违规，CI 阻断，无例外
- 所有 Prompts、流程、辅助材料以 ADR-0000 条款为准，发现冲突应修订辅导材料
- 测试组织须按 ADR 编号、内容、类型归档
- 三级执行级（L1静态、L2语义半自动、L3人工Gate），覆盖范围与映射表公开

---

## 测试映射与执行分级

### 1. ADR-测试映射

| ADR 编号   | 测试类     | 关键测试用例                             | 必须测试 |
|------------|------------|------------------------------------------|---------|
| ADR-0001   | ADR_0001_Architecture_Tests.cs | 模块隔离、契约合规、垂直切片         | ✅      |
| ADR-0002   | ADR_0002_Architecture_Tests.cs | 层级依赖、Host 装配边界               | ✅      |
| ADR-0003   | ADR_0003_Architecture_Tests.cs | 命名空间映射、防御性规则              | ✅      |
| ADR-0004   | ADR_0004_Architecture_Tests.cs | CPM、层级依赖、版本唯一性              | ✅      |
| ADR-0005   | ADR_0005_Architecture_Tests.cs | Handler、CQRS、模块通信、状态约束       | ✅      |

> 新增ADR/变更，必须同步补测。遗漏即视为流程错误。

### 2. 执行分级（Enforcement Level）

- **Level 1 静态可执行**：NetArchTest 强制，CI 阻断
- **Level 2 语义半自动**：Roslyn Analyzer 等启发式，需人工二次确认
- **Level 3 人工 Gate**：不可程控的约束，长期破例流程审计

具体标准参见 [ADR-0005-Enforcement-Levels.md](ADR-0005-Enforcement-Levels.md)

---

## 测试组织与自治原则

- 所有架构测试目录、类、用例均以 `ADR-XXXX` 前缀命名
- 测试失败消息格式：`ADR-XXXX 违规：{原因} 修复建议：{建议}`
- 禁止架构测试跳过（需显式记录在ARCH-VIOLATIONS，季度审计）
- 登录、变更、废弃测试用例，均需同步更新ADR映射表及Prompts

---

## 破例治理与归还

- 破例需在 PR 标题和描述中声明，填写《破例表单》
- 本地和CI均需预警破例到期
- 所有破例记录归档于 [`ARCH-VIOLATIONS.md`](../summaries/arch-violations.md)
- 连续破例三次未归还，自动触发架构审查

---

## 自动校验与CI策略

- 所有 PR、主分支合并前自动执行所有架构测试
- 失败即阻断，无例外
- 映射脚本/shell同步比对 ADR→Test→Prompt → 显示不一致列表，强制责任人修正

---

## 企业级行动建议

- 建议设定每季度架构健康度报告，统计测试失效、破例量、CI 通过率
- Copilot Prompts 与测试、ADR 同步迭代维护
- 新增/变更ADR时，严格全链更新自检（ADR文档、测试代码、Prompts文件、映射脚本）
- Onboarding 必须培训ADR-0000机制

---

## 版本历史

| 版本 | 日期 | 变更说明             |
|------|------|----------------------|
| 2.0  | 2026-01-23 | 聚焦自动化与治理闭环，细化执行分级 |
| 1.0  | 2026-01-20 | 初版               |

---

## 附件与参考

- [ADR-0005-Enforcement-Levels.md](ADR-0005-Enforcement-Levels.md)
- [ARCH-VIOLATIONS.md](../summaries/arch-violations.md)
