# ADR-0900：ADR 新增与修订流程

> ⚖️ 本流程是 Zss.BilliardHall 唯一有效 ADR 生命周期闭环规范。任何未走本流程的 ADR 在本项目中视为无效，不具约束力。

**状态**：✅ Final（裁决型ADR）  
**级别**：治理层 / 生命周期最高约束  
**版本**：1.2  
**修订日期**：2026-01-23  
**适用范围**：所有 ADR（0000~999）  
**生效时间**：即刻

---

## 本章聚焦内容（Focus）

- ADR 新增/修订/废弃全流程唯一标准
- 分层权限表与破例登记机制
- 三位一体（文档/测试/Prompt）交付与校验
- Copilot + 人工审查闭环
- 提交、审查、归档快速清单

---

## 术语表（Glossary）

| 术语        | 定义                                  |
|-----------|-------------------------------------|
| ADR       | Architecture Decision Record，架构决策记录 |
| 宪法层 ADR   | ADR-0001~0005，系统根基不可推翻约束            |
| 治理层 ADR   | ADR-0000, 900~999，架构过程、CI、审批相关      |
| 结构/运行/技术层 | ADR-100~399，架构细化和技术落地               |
| RFC       | Request for Comments，架构决策草案         |
| 架构委员会     | 宪法层唯一审批主体                           |

---

## ADR 层级与修订权限（Hard Limits）

| 层级/类型     | 新增权限          | 修订权限          | 公示期 | 审批要求 |
|-----------|---------------|---------------|-----|------|
| 宪法层 ADR   | 架构委员会         | 架构委员会全体       | 2 周 | 全体一致 |
| 治理层 ADR   | Tech Lead/架构师 | Tech Lead/架构师 | 1 周 | 多数同意 |
| 结构/运行/技术层 | Tech Lead/架构师 | Tech Lead/架构师 | 无   | 单人批准 |

- 宪法层仅可细化，不得削弱/推翻，特批需走破例登记流程
- 治理与细化层任何试图更改宪法层规则者，自动无效

---

## 新增 ADR 流程

1. **需求识别与分级分类**
  - 影响全局/跨模块/将被依赖 → 宪法层
  - 仅改进流程/治理 → 治理层
  - 特定领域/实现细节 → 结构/运行/技术层

2. **RFC 草案与公示**
  - 使用标准 RFC 模板，提交至 GitHub Issues
  - 宪法/治理层需严格公示，记录讨论与决议

3. **审查与审批**
  - 宪法层：架构委员会 100% 同意
  - 治理层：Tech Lead/架构师大多数
  - 结构/运行/技术层：单人可批，但留审计记录

4. **文档/测试/Prompt 三位一体交付**
  - 标准结构 ADR 文档，关键约束带【必须架构测试覆盖】标记
  - 同步生成架构测试、Prompt 触发自查/CI
  - 漏任一项，视为未完成，PR 不得合并

5. **映射校验与最终审查**
  - 执行映射校验脚本，确保 ADR、测试、Prompt 一致
  - Copilot 先自检，最终责任由人工负责人确认并签字

6. **合并与团队公告**
  - 合并后 README/导航必须更新
  - 团队渠道公告上线，必要时培训同步

---

## ADR 修订与废弃流程

### 修订（必须走完整流程）

- 发现歧义、错误或重大演进需求时，走 RFC→公示→审批→文档/测试/Prompt 三位一体→映射校验闭环
- 禁止通过简易变更、直接编辑、只补测试/Prompt 不补正文等方式“修订ADR”
- 所有修改（包括细节）须更新版本历史，简要记录影响面

### 废弃

- 新建替代 ADR 并链接废弃原因，原文标记已废弃，不可删除
- 废弃时同步移除相关测试/Prompt，并更新导航/映射表

---

## 权限与破例管理

- 仅架构委员会有权特批宪法层规则的破例
- 所有破例需归档于 ARCH-VIOLATIONS.md，每季度审计
- 连续延续三次以上必须强制归还或专项审议

---

## 三位一体校验清单（Checklist）

- [ ] 是否有完整 ADR（包含 Focus、术语、决策、关系、版本历史）
- [ ] 关键约束均带【必须架构测试覆盖】标记
- [ ] 是否已同步生成/更新架构测试
- [ ] 是否有对应 Prompt 文件，并覆盖所有主场景
- [ ] 映射校验/CI 流程全部通过
- [ ] Copilot 及人工审查报告均已归档

---

## Copilot 的角色

- 生成 RFC/ADR/Prompt/测试结构与范例
- 触发映射一致性自检和报告
- 提供典型决策树、流程提醒和重点清单
- 最终结论和审批权归人工

---

## FAQ（高频决策解答）

- Q：只提交 ADR 文档，测试和 Prompt 可以后补吗？  
  A：❌ 不可以，三位一体缺一不可，缺任一项视为无效 ADR。

- Q：Copilot 审查结果可直接视为审批结论吗？  
  A：❌ 不能，必须有人工责任人签字/记录。

- Q：架构委员会可以随意调整宪法层规则吗？  
  A：❌ 必须走 2 周公示与全体一致流程，留历史与公告。

- Q：废弃的 ADR 可以删除吗？  
  A：❌ 永远只做废弃标记和链路，不允许物理删除。

- Q：如何辨别一个决策是否应为宪法层？  
  A：只要它影响系统基础结构、依赖方向、约束开放性，或会被跨模块持久依赖，就应为宪法层。

---

## 版本历史

| 版本  | 日期         | 变更说明              | 修订人      | 影响级别 |
|-----|------------|-------------------|----------|------|
| 1.2 | 2026-01-23 | 企业级闭环重构、三位一体交付与校验 | @douhuaa | High |
| 1.1 | 2026-01-21 | 强调测试/Prompt/审查闭环  | @copilot | High |
| 1.0 | 2026-01-21 | 定义ADR新增修订流程       | @douhuaa | None |

---

## 附录

- [RFC 模板](/docs/templates/rcf-template.md)
- [ADR 模板](/docs/templates/adr-template.md)
- [Prompt 模板](/docs/templates/copilot-pormpts-template.md)
