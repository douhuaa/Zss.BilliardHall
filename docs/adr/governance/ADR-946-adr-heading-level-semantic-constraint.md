---
adr: ADR-946
title: "ADR 标题级别即语义级别约束"
status: Accepted
level: Governance
deciders: "Architecture Board"
date: 2026-01-26
version: "1.0"
maintainer: "架构委员会"
primary_enforcement: L1
reviewer: "@douhuaa"
supersedes: null
superseded_by: null
---

# ADR-946：ADR 标题级别即语义级别约束

> ⚖️ **本 ADR 定义 ADR 文档中标题层级与机器可解析语义之间的强制对应关系，用于防止解析歧义和治理规则污染。**

**状态**：✅ Accepted  
**版本**：1.0  
**级别**：治理层 / 结构约束（Structural Constraint）  
**适用范围**：所有 ADR 文档  
**生效时间**：即刻

---

## Focus（聚焦内容）

- ADR 标题层级的语义含义
- 机器解析边界的明确化
- 模板 / 示例 / 说明性内容的结构约束
- 防止关系、自引用、版本等解析歧义

---

## Decision（裁决）

### 标题级别即语义级别（条款 1）

**规则**：

在 ADR 文档中，**标题层级本身即为语义与权威边界**，必须严格遵守以下约定：

| 标题级别 | 语义含义 | 机器可解析 | 裁决力 | 强制约束 |
|---------|---------|-----------|-------|---------|
| `#` | ADR 文档本体 | ❌ | ❌ | 每个 ADR 文件必须且仅有一个 `#` 标题 |
| `##` | 机器可裁决的一级语义块 | ✅ | ✅ | 仅用于 ADR 正文章节（决策、执法、关系声明等） |
| `###` | 人类阅读的说明 / 细化 | ❌ | ❌ | 用于子章节说明，不被解析工具识别为语义边界 |
| `####` 及以下 | 示例 / 注释 / 非结构内容 | ❌ | ❌ | 仅用于补充说明、示例代码等 |

**判定**：
- ✅ 所有机器解析的语义块必须使用 `##` 级别
- ❌ 模板、示例、说明性内容禁止使用 `##` 级别
- ❌ 代码块（```markdown ... ```）内的标题不得使用与正文相同的 `##` 语义块名称

---

### 关键语义块的标题级别约束（条款 2）

**规则**：

以下 ADR 标准章节**必须**使用 `##` 级别，且**禁止**在其他位置（如模板、示例）使用相同的 `##` 标题：

| 语义块名称 | 标准标题 | 英文备选 | 机器解析用途 |
|----------|---------|---------|-------------|
| 关系声明 | `## Relationships（关系声明）` | `## Relationships` | 提取 ADR 间依赖、替代等关系 |
| 决策 | `## Decision（裁决）` | `## Decision` | 识别裁决性规则 |
| 执法模型 | `## 执法模型（Enforcement）` | `## Enforcement` | 提取测试映射和执行级别 |
| 术语表 | `## Glossary（术语表）` | `## Glossary` | 提取技术术语定义 |

**判定**：
- ✅ 正文中使用 `## Relationships（关系声明）`
- ❌ 模板中使用 `## 关系声明` 或 `## Relationships`（应改为 `Relationships Example` 或使用 `###` 级别）
- ❌ 代码块内使用 `## 关系声明`（应改为英文或占位符）

---

### 模板与示例的结构约束（条款 3）

**规则**：

在 ADR 文档中包含模板或示例时，**必须**采用以下方式之一避免解析歧义：

1. **方式一：使用英文或占位符标题**
   ```markdown
   ```markdown
   ## Relationships Example
   或
   ## 〈关系声明示例〉
   ```
   ```

2. **方式二：降低标题级别**
   ```markdown
   ```markdown
   ### 关系声明示例
   ```
   ```

3. **方式三：使用代码块且不含语义标题**
   ```markdown
   示例格式：
   ```
   **依赖（Depends On）**：
   - [ADR-XXXX：标题](相对路径)
   ```
   ```

**判定**：
- ✅ 模板使用 `## Relationships` 而非 `## Relationships（关系声明）`
- ✅ 示例使用 `### 关系声明示例`
- ❌ 代码块内使用 `## Relationships（关系声明）`

---

### 解析工具的语义边界（条款 4）

**规则**：

所有 ADR 解析工具（bash 脚本、C# 解析器、验证工具等）**必须**遵守以下边界：

1. **仅解析 `##` 级别的标准语义块**
   - 工具应使用正则 `/^## 关系声明/` 而非 `/## 关系声明/`（锚定行首）
   - 或使用 `/^## Relationships$/` 精确匹配

2. **忽略代码块内容**
   - 解析前应过滤掉 ````markdown ... ```` 块
   - 或在解析逻辑中跳过 fence block 标记之间的内容

3. **仅提取第一个匹配的 `##` 语义块**
   - 如 `## 关系声明` 只应解析文档中第一个正文出现位置
   - 忽略后续同名 `##` 块（通常为错误或重复）

**判定**：
- ✅ 使用 `sed -n '/^## 关系声明/,/^##/p'`（锚定行首）
- ❌ 使用 `sed -n '/## 关系声明/,/^##/p'`（可能匹配 `###`）
- ✅ 在解析前过滤代码块

---

## 背后的原理（Rationale）

### 为什么标题级别是语义边界

ADR 文档不是普通的 Markdown 文档，而是一种**机器可裁决的治理语言**：

1. **`##` 不是排版，是 AST 节点**
   - 解析工具将 `##` 标题视为语义块的边界标记
   - 标题文本本身是语义类型的标识符（如 `关系声明` = 关系语义块）

2. **模板使用 `##` = 在语法树中注入假节点**
   - 就像在 C# 代码中 new 一个假的 Domain 对象
   - 解析工具无法区分"正文"和"示例"

3. **解析歧义导致治理规则污染**
   - ADR-940 模板中的 `## 关系声明` 被 bash 脚本解析
   - 导致虚假的自引用错误（ADR-940 → ADR-940）
   - 浪费大量诊断时间

### 从"文档体系"到"语言级治理系统"

此 ADR 标志着 ADR 体系从**文档化管理**正式升级为**语言级治理**：

- **文档阶段**：人类阅读、手动检查、主观判断
- **语言阶段**：机器解析、自动验证、客观裁决

标题级别约束是这一转变的基石规则。

---

## 执法模型（Enforcement）

| 规则编号 | 执行级别 | 测试/手段 | 说明 |
|---------|---------|----------|------|
| 条款 1 | **L1** | `scripts/verify-adr-heading-semantics.sh` | CI 阻断：检测模板/示例中的 `##` 语义块误用 |
| 条款 2 | **L1** | `scripts/verify-adr-heading-semantics.sh` | CI 阻断：检测关键语义块标题的重复或误用 |
| 条款 3 | **L2** | Code Review | 人工审查：确保新 ADR 遵守模板约束 |
| 条款 4 | **L1** | 解析工具单元测试 | 验证解析工具正确处理标题边界 |

**执行时机**：
- CI 阶段：每次 PR 提交时运行 `verify-adr-heading-semantics.sh`
- Code Review：架构委员会审查新 ADR 时检查标题结构

---

## Relationships（关系声明）

**依赖（Depends On）**：
- [ADR-940：ADR 关系与溯源管理宪法](./ADR-940-adr-relationship-traceability-management.md) - 关系解析依赖标题语义
- [ADR-0008：文档编写与维护宪法](../constitutional/ADR-0008-documentation-governance-constitution.md) - ADR 文档结构规范

**被依赖（Depended By）**：
- [ADR-947：关系声明区的结构与解析安全规则](./ADR-947-relationship-section-structure-parsing-safety.md)

**替代（Supersedes）**：
- 无

**被替代（Superseded By）**：
- 无

**相关（Related）**：
- [ADR-0006：术语与编号宪法](../constitutional/ADR-0006-terminology-numbering-constitution.md) - 同为 ADR 结构约束

---

## 破例与归还（Exception）

### 允许破例的前提

此规则为**结构级约束**，原则上**不允许破例**。

特殊情况（如技术文档迁移）需破例时，必须：
1. 在 PR 中明确标注 `[STRUCT-VIOLATION: ADR-946]`
2. 提供详细的迁移计划和时间表
3. 获得架构委员会 2/3 以上同意

### 归还机制

- 破例的 ADR 文档必须在 30 天内修正结构
- 逾期未修正的 ADR 状态自动标记为 `⚠️ Structural Debt`

---

## 版本历史

| 版本 | 日期 | 变更说明 | 作者 |
|------|------|----------|------|
| 1.0 | 2026-01-26 | 初始版本，定义标题级别语义约束 | GitHub Copilot |




---

## References（非裁决性参考）


- 待补充


---

## Prohibited（禁止行为）


以下行为明确禁止：

- 待补充


---

## Non-Goals（明确不管什么）


本 ADR 明确不涉及以下内容：

- 待补充


---

## Enforcement（执法模型）


### 执行方式

待补充...


---

## Glossary（术语表）


| 术语 | 定义 | 英文对照 |
|------|------|----------|
| 待补充 | 待补充 | TBD |


---

## History（版本历史）


| 版本  | 日期         | 变更说明   |
|-----|------------|--------|
| 1.0 | 待补充 | 初始版本 |
