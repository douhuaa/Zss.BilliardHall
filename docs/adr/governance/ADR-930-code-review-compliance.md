# ADR-930：代码审查与 ADR 合规自检流程

**状态**：Draft  
**级别**：治理层  
**影响范围**：所有 PR 和代码审查流程  
**生效时间**：待审批通过后

---

## 规则本体（Rule）

> **这是本 ADR 唯一具有裁决力的部分。**

### ADR-930.1：PR 必须填写变更类型和影响范围

所有 Pull Request **必须**在描述中明确标注变更类型和影响范围。

**必填信息**：
- ✅ 变更类型：feat/fix/docs/refactor/test/chore
- ✅ 影响模块：明确列出受影响的模块或层
- ✅ ADR 相关性：如变更涉及 ADR，必须标注 ADR 编号
- ❌ 禁止空白 PR 描述

**PR 模板强制字段**：
```markdown
## 变更类型
- [ ] feat: 新功能
- [ ] fix: Bug 修复
- [ ] docs: 文档更新
- [ ] refactor: 重构
- [ ] test: 测试
- [ ] chore: 构建/工具

## 影响范围
- 模块：[列出]
- ADR：[编号或无]
```

### ADR-930.2：ADR 相关 PR 必须通过 Copilot 自检

涉及架构约束的 PR **必须**运行 Copilot 自检，并将结果附在 PR 中。

**触发条件**：
- 修改 ADR 文档
- 修改架构测试
- 新增模块或重大重构
- 变更核心基础设施

**自检要求**：
- ✅ 使用 `code_review` 工具进行自检
- ✅ 在 PR 描述中附上自检结果
- ✅ 解决所有标记为"必须修复"的问题
- ❌ 禁止跳过 Copilot 自检

### ADR-930.3：架构测试失败必须说明原因和计划

如果 PR 中存在架构测试失败，**必须**在 PR 中说明原因和修复计划。

**说明要求**：
- ✅ 失败的具体测试和 ADR 编号
- ✅ 失败原因分析
- ✅ 修复计划或破例申请
- ❌ 禁止静默忽略测试失败

**允许的情况**：
- 测试本身有 Bug（需创建 Issue 修复测试）
- 合法的破例场景（需记录在 arch-violations.md）

### ADR-930.4：每个 PR 必须至少一名责任人审查

Pull Request **必须**至少获得一名具有审查权限的责任人批准。

**责任人定义**：
- Tech Lead
- 模块负责人
- 架构师

**审查职责**：
- ✅ 验证变更符合相关 ADR
- ✅ 检查代码质量和安全性
- ✅ 确认测试覆盖充分
- ❌ 禁止机械式批准（无实质审查）

### ADR-930.5：破例必须在 PR 中明确标注

如果 PR 包含架构破例，**必须**在 PR 描述和代码中明确标注。

**标注要求**：
- ✅ PR 描述中说明破例的 ADR 和规则
- ✅ 代码中添加 `// ARCH-EXCEPTION: ADR-XXX.Y` 注释
- ✅ 更新 `docs/summaries/arch-violations.md`
- ❌ 禁止未声明的破例

---

## 执法模型（Enforcement）

> **规则如果无法执法，就不配存在。**

### 测试映射

| 规则编号 | 执行级 | 测试/手段 |
|---------|--------|----------|
| ADR-930.1 | L1 | PR 模板强制验证 |
| ADR-930.2 | L2 | 人工检查 + CI 提醒 |
| ADR-930.3 | L2 | 人工审查 |
| ADR-930.4 | L1 | GitHub Branch Protection |
| ADR-930.5 | L2 | 人工审查 + 脚本检查 |

---

## 破例与归还（Exception）

> **破例不是逃避，而是债务。**

### 允许破例的前提

破例**仅在以下情况允许**：

1. **紧急热修复**：生产环境重大故障
2. **自动化工具故障**：Copilot 或 CI 系统不可用
3. **小型文档修正**：纯文档拼写或格式修正

### 破例要求（不可省略）

紧急破例后**必须**：

- 在 24 小时内补充完整的审查流程
- 记录破例原因和时间
- 创建 Follow-up Issue 跟踪

---

## 变更政策（Change Policy）

> **ADR 不是"随时可改"的文档。**

### 变更规则

* **治理层 ADR**
  * 修改需架构师大多数同意
  * 需评估对团队工作流的影响
  * 必须提供过渡期方案

---

## 明确不管什么（Non-Goals）

> **防止 ADR 膨胀的关键段落。**

本 ADR **不负责**：

- ✗ 代码风格检查（由 linter 负责）
- ✗ 具体的编码规范
- ✗ 性能优化建议
- ✗ 业务逻辑的正确性验证

---

## 非裁决性参考（References）

> **仅供理解，不具裁决力。**

### 相关 ADR
- ADR-0000：架构测试与 CI 治理
- ADR-0900：ADR 新增与修订流程
- ADR-360：CI/CD Pipeline 流程标准化

### 实践指导
- PR 模板参见 `.github/PULL_REQUEST_TEMPLATE.md`
- 审查清单参见 `docs/copilot/adr-0930.prompts.md`

---

## 版本历史

| 版本 | 日期 | 变更说明 | 修订人 |
|-----|------|---------|--------|
| 1.0 Draft | 2026-01-24 | 初始版本 | GitHub Copilot |

---

# ADR 终极一句话定义

> **ADR 是系统的法律条文，不是架构师的解释说明。**
