# 架构宪法层（Architecture Constitutional Layer）

> **注意**：本文档定义 ADR-0000 至 ADR-0005 的宪法地位和演进规则。  
> 建议配合 [ADR 索引（README.md）](README.md) 和各主 ADR 一起阅读。  

**状态**：✅ Active  
**生效日期**：2026-01-20  
**级别**：系统根约束（System Root Constraint）  

---

## 宪法层定义

**ADR-0000 至 ADR-0005 构成本系统的"架构宪法层"（Architecture Constitutional Layer）。**

这意味着：

1. **不可推翻**：后续 ADR 不得与宪法层 ADR 冲突
2. **只能细化**：后续 ADR 只能补充细节，不能削弱约束
3. **破例必审**：任何违反宪法层的破例必须经过架构委员会审批
4. **永久记录**：所有破例必须记录在案，可追溯

---

## 宪法层 ADR 清单

### ADR-0000：架构测试元规则

**地位**：架构治理的自我约束  
**核心原则**：每条 ADR 必须有对应的可执行测试  
**不可变约束**：
- ADR 与测试类一一对应
- 测试不能被跳过（禁止 Skip）
- 测试必须包含实质性断言
- 测试失败消息必须包含 ADR 编号

**为什么不可推翻**：  
如果允许 ADR 没有测试，或测试可以随意跳过，架构约束将形同虚设。

---

### ADR-0001：模块化单体与垂直切片架构

**地位**：系统架构的根基  
**核心原则**：
- 模块隔离（模块间不能互相引用）
- 垂直切片组织（禁止传统分层命名空间）
- 契约使用规则（Command Handler 不依赖 IQuery）
- Handler 自包含（不依赖横向 Service）

**不可变约束**：
- 模块边界不可被同步引用打破
- 不允许创建跨模块的横向 Service 层
- 契约必须是简单数据结构，不含业务方法

**为什么不可推翻**：  
模块化单体的价值在于"模块内高内聚，模块间松耦合"。如果允许模块直接引用，系统将退化为"分布式泥球"。

**未来 ADR 的边界**：
- ✅ 允许：细化模块划分策略、定义新的契约类型
- ❌ 禁止：允许模块间直接依赖、创建全局 Service 层

---

### ADR-0002：Platform / Application / Host 三层启动体系

**地位**：系统启动的三权分立  
**核心原则**：
- Platform 提供技术能力，不依赖业务
- Application 提供横切关注点，不依赖具体模块
- Host 组装启动，不包含业务逻辑

**不可变约束**：
- Platform 不得依赖 Application 或 Host
- Application 不得依赖 Host 或 Modules
- Host 不得依赖 Modules（业务契约应在 Platform）
- Program.cs 保持简洁，只调用 Bootstrapper

**为什么不可推翻**：  
依赖方向的单向性是系统可测试性、可替换性的基础。如果允许反向依赖，将无法独立测试各层。

**未来 ADR 的边界**：
- ✅ 允许：细化 Bootstrapper 职责、定义新的 Platform 组件
- ❌ 禁止：Platform 依赖业务模块、Host 包含业务逻辑

---

### ADR-0003：命名空间与项目边界规范

**地位**：代码组织的语法规则  
**核心原则**：
- 所有类型命名空间以 `Zss.BilliardHall` 开头
- Platform/Application/Modules/Host 命名空间严格对应物理结构
- 使用 Directory.Build.props 统一配置

**不可变约束**：
- 命名空间必须反映真实的架构层次
- 禁止不规范命名空间模式（如 `Common`、`Shared`、`Utils`）

**为什么不可推翻**：  
命名空间是架构的"可见表达"。混乱的命名空间会破坏架构的可理解性。

**未来 ADR 的边界**：
- ✅ 允许：添加新的模块命名空间、细化命名规则
- ❌ 禁止：放松命名空间规范、允许不规范命名

---

### ADR-0004：中央包管理（CPM）规范

**地位**：依赖管理的统一规则  
**核心原则**：
- 使用 Directory.Packages.props 集中管理包版本
- 项目文件不手动指定版本号
- 传递依赖固定（CentralPackageTransitivePinningEnabled）

**不可变约束**：
- 所有 NuGet 包版本必须在 Directory.Packages.props 中定义
- 禁止项目文件中出现 `<PackageReference Version="...">`
- 测试框架版本必须一致

**为什么不可推翻**：  
依赖版本冲突是单体应用的主要故障源。集中管理是避免"依赖地狱"的唯一可靠方法。

**未来 ADR 的边界**：
- ✅ 允许：定义包分组策略、升级策略
- ❌ 禁止：放弃 CPM、允许项目自行管理版本

---

### ADR-0005：应用内交互模型与执行边界

**地位**：运行时秩序的宪法  
**核心原则**：
- Use Case + Handler 是最小执行单元
- 模块内同步，模块间异步
- 查询与命令分离（CQRS）
- 不使用全局分布式事务

**不可变约束**：
- Handler 不得承载长期状态
- 模块间未审批的同步调用被禁止
- 模块不共享领域实体
- Endpoint 不包含业务逻辑

**为什么不可推翻**：  
这是系统长期可演进性的根本保障。如果允许模块间随意同步调用，模块边界将被击穿，最终退化为"同步泥球"。

**未来 ADR 的边界**：
- ✅ 允许：定义新的 Handler 类型、细化事件契约
- ❌ 禁止：允许模块间默认同步调用、放弃 CQRS 原则

---

## 宪法层的演进规则

### 1. 修订条件

宪法层 ADR 只能在以下情况下修订：

1. **发现根本性设计缺陷**：经架构委员会一致同意
2. **技术栈重大变更**：如从单体迁移到微服务（需要新的宪法层）
3. **法规/合规要求**：外部强制性要求

### 2. 修订流程

1. **提案**：提交 RFC（Request for Comments），详细说明修订理由
2. **公示**：至少 2 周公示期，所有团队成员可提出意见
3. **审批**：架构委员会全体成员投票，需 100% 同意
4. **记录**：修订历史永久记录，不得删除原文

### 3. 禁止的修订

以下修订方式被明确禁止：

- ❌ 通过后续 ADR 推翻宪法层约束
- ❌ 通过"临时破例"绕过宪法层
- ❌ 通过"特殊情况"削弱宪法层
- ❌ 通过"技术选型"架空宪法层

### 4. 破例处理

宪法层的破例必须满足：

1. **明确记录**：在 [`ARCH-VIOLATIONS.md`](../summaries/arch-violations.md) 中永久记录
2. **时限约束**：破例必须有明确的失效期
3. **归还计划**：临时破例必须有归还路径
4. **最高审批**：需要架构委员会审批，不得委托

---

## 宪法层与后续 ADR 的关系

### 后续 ADR 的定位

- **细化规则**：如 "ADR-0007: Handler 异常处理规范"
- **技术选型**：如 "ADR-0008: 使用 Wolverine 作为消息总线"
- **最佳实践**：如 "ADR-0009: 日志记录规范"

### 冲突处理原则

如果后续 ADR 与宪法层冲突：

1. **自动无效**：冲突的后续 ADR 条款自动无效
2. **强制修订**：必须修订后续 ADR，使其符合宪法层
3. **不得妥协**：不允许以"折中"方式削弱宪法层

### 示例

#### ✅ 合法的后续 ADR

```
ADR-0017: 模块间事件契约版本管理规范

本 ADR 细化 ADR-0005 中"模块间异步通信"的实现细节，
定义事件契约的版本化策略、向后兼容规则和升级流程。

与宪法层关系：补充细节，不冲突
```

#### ❌ 非法的后续 ADR

```
ADR-0017: 在特殊情况下允许模块间同步调用

理由：某些查询场景需要实时数据...

违反宪法层：ADR-0005 明确规定"模块间默认异步"
裁决：本 ADR 无效，必须修订为"定义同步调用的审批流程"
```

---

## 宪法层的守护机制

### 1. 自动化守护

- ✅ ADR-0000 的测试确保所有宪法层 ADR 都有对应测试
- ✅ CI 中架构测试失败 = 构建失败 = PR 阻断
- ✅ 禁止跳过架构测试（ADR-0000 反作弊规则）

### 2. 人工守护

- ✅ PR Template 强制架构违规声明
- ✅ 架构师 Code Review 必须检查宪法层合规性
- ✅ 所有破例记录在 [`ARCH-VIOLATIONS.md`](../summaries/arch-violations.md)

### 3. 审计机制

- 每季度审计 [`ARCH-VIOLATIONS.md`](../summaries/arch-violations.md)，检查破例是否归还
- 每年度评估宪法层是否需要修订

---

## ⚠️ 关键边界：不要再扩展宪法层

**ADR-0000 至 ADR-0005 已经到达关键边界。**

### 收益递减原则

再往宪法层（ADR-0000 ~ 0005）添加更多"原则条款"，会导致：

1. **收益急剧下降**：核心原则已经覆盖，新增条款边际价值低
2. **复杂度上升**：规则越多，理解成本越高，执行难度越大
3. **被推翻概率增加**：条款越多，出现矛盾的可能性越大，导致整个体系被质疑

### 接下来只能做两类事情

✅ **允许的改进方向**：

1. **工具实现**
   - 实现 Roslyn Analyzer 以支持 Level 2 语义检查
   - 自动化违规检测和报告
   - CI/CD 集成优化

2. **审计与可视化**
   - 架构健康度趋势分析
   - 破例统计和可视化
   - 架构债务预警

3. **流程优化**
   - 破例审批流程细化
   - 季度审计流程标准化
   - 培训和文档改进

❌ **禁止的扩展**：

1. **不要再添加"原则条款"到 ADR-0000 ~ 0005**
   - 例如：不要添加"日志记录规范"到 ADR-0005
   - 例如：不要添加"异常处理约束"到 ADR-0001
   - 这些应该作为后续 ADR（如 ADR-0006、ADR-0007）

2. **不要让宪法层测试过于细碎**
   - 宪法层测试应该关注"核心约束"
   - 细节规则应该在后续 ADR 的测试中实现

3. **不要将技术选型写入宪法层**
   - 宪法层应该是"技术无关"的原则
   - 具体技术选择应该在实现层 ADR 中定义

### 如何判断是否应该加入宪法层？

问自己三个问题：

1. **这个约束是否"三年不变"？**
   - 如果不是，不应该加入宪法层

2. **这个约束违反后，是否"系统退化"？**
   - 如果不是，不应该加入宪法层

3. **这个约束是否"技术无关"？**
   - 如果不是，不应该加入宪法层

**示例判断**：

| 约束 | 应该加入宪法层？ | 理由 |
|-----|----------------|------|
| 模块隔离 | ✅ 是 | 三年不变、违反会退化、技术无关 |
| 日志必须用结构化格式 | ❌ 否 | 技术相关、可能变化 |
| Handler 不能有状态 | ✅ 是 | 三年不变、违反会导致并发问题、技术无关 |
| 使用 Wolverine 作为消息总线 | ❌ 否 | 技术选型、可能替换 |

---

## 结论

> **ADR-0000 至 ADR-0005 是本系统的"不可协商条款"。**

这不是技术独裁，而是长期稳定性的保障：

1. **技术可演进**：底层技术栈可以自由替换
2. **架构不退化**：核心约束不因"特殊情况"而被侵蚀
3. **决策可追溯**：所有破例都有完整的记录和审批流程
4. **原则保持简洁**：宪法层已封闭，不再扩展，避免复杂度膨胀

三年后，如果这份宪法层仍然被遵守，系统仍然站得住。
