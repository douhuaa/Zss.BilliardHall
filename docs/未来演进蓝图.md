# Zss.BilliardHall 未来演进蓝图

> **文档性质**：长期规划，非当前阶段  
> **目标**：指导系统在 MVP 之后的扩展方向  
> **最后更新**：2026-01-18

---

## 一、Phase 2：生产就绪（Week 7–12）

### 目标
将 MVP 系统升级到可上线生产环境

---

### 1.1 消息可靠性增强

**Durable Messaging（持久化消息）**
- [ ] 配置 Wolverine Inbox/Outbox Pattern
- [ ] 消息持久化到 PostgreSQL
- [ ] 自动重试机制
- [ ] 死信队列处理

**实现示例：**
```csharp
builder.Host.UseWolverine(opts =>
{
    opts.PublishAllMessages()
        .ToLocalQueue("events")
        .UseDurableInbox() // 启用持久化
        .UseDurableOutbox();
    
    opts.UseMarten(connectionString);
});
```

---

### 1.2 认证授权

**JWT Token 认证**
- [ ] 用户登录接口
- [ ] Token 生成与验证
- [ ] 基于角色的访问控制（RBAC）
  - 管理员：全部权限
  - 收银员：开台/结账
  - 会员：查询自己的信息

**示例角色定义：**
```csharp
public static class Roles
{
    public const string Admin = "admin";
    public const string Cashier = "cashier";
    public const string Member = "member";
}

// API 保护
[Authorize(Roles = Roles.Cashier)]
public async Task<IActionResult> StartSession(...)
```

---

### 1.3 会员卡功能

**Members 模块扩展：**
- [ ] 会员卡类型（普通卡/金卡/钻石卡）
- [ ] 会员卡开卡
- [ ] 会员卡充值
- [ ] 会员卡余额查询
- [ ] 会员卡冻结/解冻

**数据模型：**
```sql
-- members.member_card
{
  "id": "uuid",
  "member_id": "uuid",
  "card_type": "string", -- "regular" | "gold" | "diamond"
  "balance": "decimal",
  "status": "string", -- "active" | "frozen"
  "issued_at": "timestamp"
}
```

---

### 1.4 复杂计费规则

**Orders 模块扩展：**
- [ ] 计费方式配置（按小时/按局/包时段）
- [ ] 价格策略（会员折扣/时段差价）
  - 高峰时段：50 元/小时
  - 低谷时段：30 元/小时
  - 金卡会员：8 折
- [ ] 超时费用计算
- [ ] 最低消费设置

**示例计费引擎：**
```csharp
public class PricingEngine
{
    public decimal Calculate(Session session, Member member)
    {
        var baseRate = GetRateByTime(session.StartTime);
        var discount = GetMemberDiscount(member.CardType);
        var duration = (session.EndTime - session.StartTime).TotalHours;
        
        return baseRate * duration * discount;
    }
}
```

---

### 1.5 性能优化

- [ ] 查询索引优化（Marten）
- [ ] Redis 缓存（热点数据）
- [ ] 接口响应时间监控
- [ ] 数据库连接池调优

---

## 二、Phase 3：扩展模块（Month 4–6）

### 目标
添加辅助业务模块

---

### 2.1 商品管理模块（Products）

**核心功能：**
- [ ] 商品信息管理（饮料/零食/台球用品）
- [ ] 库存管理
- [ ] 采购入库
- [ ] 库存预警

**数据模型：**
```sql
-- products.product
{
  "id": "uuid",
  "name": "string",
  "category": "string", -- "drink" | "snack" | "equipment"
  "price": "decimal",
  "stock": "int"
}
```

**与 Orders 集成：**
```csharp
// 结账时可购买商品
public record EndSession(
    Guid SessionId,
    List<ProductPurchase> Products // 新增
);

public record ProductPurchase(Guid ProductId, int Quantity);
```

---

### 2.2 员工管理模块（Staff）

**核心功能：**
- [ ] 员工信息管理
- [ ] 排班管理
- [ ] 权限管理（关联认证系统）
- [ ] 考勤统计

**数据模型：**
```sql
-- staff.employee
{
  "id": "uuid",
  "name": "string",
  "phone": "string",
  "role": "string", -- "cashier" | "manager"
  "status": "string" -- "active" | "inactive"
}
```

---

### 2.3 营销管理模块（Marketing）

**核心功能：**
- [ ] 优惠券管理
- [ ] 活动管理（满减/折扣）
- [ ] 会员推广（邀请奖励）
- [ ] 短信通知

**示例：满减活动**
```csharp
public record Campaign
{
    public string Name { get; init; } // "满100减20"
    public decimal MinAmount { get; init; } // 100
    public decimal DiscountAmount { get; init; } // 20
    public DateTime StartDate { get; init; }
    public DateTime EndDate { get; init; }
}
```

---

## 三、Phase 4：高级特性（Month 7–12）

### 目标
系统能力增强，支撑规模化运营

---

### 3.1 会员等级体系

**自动升降级：**
- [ ] 积分累计规则
- [ ] 等级自动升级（Bronze → Silver → Gold → Diamond）
- [ ] 等级权益配置
- [ ] 会员流失预警

**实现方式：**
```csharp
// Worker Host 定时任务
public class MemberTierUpgradeJob : IJob
{
    public async Task Execute()
    {
        // 每天凌晨检查会员积分
        // 达到阈值自动升级
        var members = await GetMembersEligibleForUpgrade();
        foreach (var member in members)
        {
            await _messageBus.SendAsync(new UpgradeTier(member.Id));
        }
    }
}
```

---

### 3.2 统计分析

**Reports 模块：**
- [ ] 营业额统计（日/周/月）
- [ ] 台桌使用率分析
- [ ] 高峰时段分析
- [ ] 会员消费排行
- [ ] 商品销售统计

**实现方式：**
- 使用 Marten 的投影功能（Projections）
- 预聚合数据到只读模型

---

### 3.3 Worker Host 开发

**后台任务：**
- [ ] 会员等级自动升级（每日）
- [ ] 数据统计报表生成（每日）
- [ ] 数据清理归档（每月）
- [ ] 会员生日提醒（每日）

**技术方案：**
- Quartz.NET 定时任务调度
- Wolverine 异步消息处理

---

### 3.4 读写分离

**查询优化：**
- [ ] 使用 Marten 的只读视图
- [ ] 将复杂查询分离到专用数据库
- [ ] 实现 CQRS 完整形态
  - 写：命令处理器更新主库
  - 读：查询处理器读取只读副本

---

## 四、Phase 5：微服务演进（如果需要）

### 何时考虑拆分？

**触发条件：**
- 某个模块需要独立扩容（如 Orders 高峰期压力大）
- 不同模块有不同的发布周期
- 团队规模扩大，需要独立交付

---

### 拆分步骤

#### Step 1：消息队列外部化

```csharp
// 之前：进程内
opts.PublishAllMessages().ToLocalQueue("events");

// 之后：RabbitMQ
opts.PublishAllMessages().ToRabbitQueue("events");
```

**影响：**
- Handler 代码无需修改
- 事件仍然异步发布/订阅

---

#### Step 2：提取模块为独立服务

**Members Service：**
```
MembersService/
  ├── Host/
  │   └── Program.cs       # 独立宿主
  ├── Modules/Members/     # 移动到这里
  └── Platform/            # 复制一份
```

**Orders Service：**
```
OrdersService/
  ├── Host/
  │   └── Program.cs
  ├── Modules/Orders/
  └── Platform/
```

---

#### Step 3：Contracts 调用改为 HTTP

```csharp
// 之前：进程内调用
public class StartSessionHandler
{
    private readonly IMemberQueries _queries; // 直接注入
    
    public async Task Handle(StartSession cmd)
    {
        var member = await _queries.GetByIdAsync(cmd.MemberId);
        // ...
    }
}

// 之后：HTTP 调用
public class StartSessionHandler
{
    private readonly HttpClient _memberClient;
    
    public async Task Handle(StartSession cmd)
    {
        var response = await _memberClient.GetAsync($"/members/{cmd.MemberId}");
        var member = await response.Content.ReadFromJsonAsync<MemberDto>();
        // ...
    }
}
```

---

## 五、技术债务管理

### 5.1 已知技术债（MVP 阶段）

| 债务项 | 影响 | 计划偿还时间 |
|--------|------|------------|
| 无消息持久化 | 消息可能丢失 | Phase 2 Week 1 |
| 无认证授权 | 接口暴露风险 | Phase 2 Week 2 |
| 单机部署 | 无高可用 | Phase 4 |
| 硬编码配置 | 不灵活 | Phase 2 Week 3 |

---

### 5.2 预防性措施

- **代码审查：** 每个 PR 必须经过审查
- **架构测试：** 每次 CI 自动运行
- **重构窗口：** 每个 Phase 结束后预留 1 周重构时间

---

## 六、容器化与部署

### 6.1 Docker 化（Phase 2）

**Dockerfile：**
```dockerfile
FROM mcr.microsoft.com/dotnet/aspnet:10.0
WORKDIR /app
COPY published/ .
ENTRYPOINT ["dotnet", "WebHost.dll"]
```

**docker-compose.yml：**
```yaml
version: '3.8'
services:
  app:
    build: .
    ports:
      - "5000:8080"
    environment:
      - ConnectionStrings__Postgres=...
  
  postgres:
    image: postgres:16
    environment:
      - POSTGRES_DB=billiard_hall
```

---

### 6.2 Kubernetes 部署（Phase 5）

- [ ] Deployment 配置
- [ ] Service 暴露
- [ ] ConfigMap 配置管理
- [ ] Secret 敏感信息管理
- [ ] 自动扩缩容（HPA）

---

## 七、监控与运维

### 7.1 可观测性（Phase 3）

**日志：**
- Serilog → Elasticsearch
- 集中式日志查询

**指标：**
- Prometheus + Grafana
- 监控 API 响应时间
- 监控数据库连接池

**追踪：**
- OpenTelemetry
- 分布式追踪（微服务阶段）

---

### 7.2 告警（Phase 3）

- [ ] API 错误率超过 5% 告警
- [ ] 数据库连接池耗尽告警
- [ ] 消息队列积压告警
- [ ] 磁盘空间不足告警

---

## 八、团队协作

### 8.1 分支策略

- `main`：生产就绪代码
- `develop`：开发分支
- `feature/*`：功能分支
- `hotfix/*`：紧急修复

---

### 8.2 提交规范

使用 Conventional Commits：
- `feat:` 新功能
- `fix:` 修复
- `refactor:` 重构
- `test:` 测试
- `docs:` 文档

---

### 8.3 代码审查标准

- [ ] 架构测试通过
- [ ] 单元测试覆盖率 > 80%
- [ ] 遵循命名约定
- [ ] 无硬编码配置
- [ ] 有必要的日志

---

## 九、长期演进方向

### 可能的技术升级

- **缓存：** 引入 Redis
- **搜索：** 引入 Elasticsearch（会员搜索）
- **消息队列：** RabbitMQ / Kafka
- **API Gateway：** Ocelot / YARP
- **移动端：** Flutter / React Native
- **管理后台：** React / Vue

---

### 业务扩展方向

- **多门店支持：** 每个门店独立数据
- **预订系统：** 提前预订台桌
- **会员推荐：** 邀请新会员奖励
- **第三方支付：** 微信/支付宝集成
- **小程序：** 会员自助查询

---

## 十、参考案例

### 类似架构的成功案例

- [eShopOnContainers](https://github.com/dotnet-architecture/eShopOnContainers)：微软官方示例
- [Modular Monolith Sample](https://github.com/kgrzybek/modular-monolith-with-ddd)：Kamil Grzybek 的模块化单体示例
- [Wolverine Samples](https://github.com/JasperFx/wolverine)：官方示例代码

---

**文档结束**

**重要提醒：** 这些特性都是 **未来规划**，不是当前 MVP 阶段的工作。请专注于 MVP 开发计划！
