# Zss.BilliardHall 台球厅管理系统 - 详细开发计划

## 一、项目概述

### 1.1 项目定位
Zss.BilliardHall 是一个现代化的台球厅管理系统，采用模块化单体架构（Modular Monolith），基于 .NET 10.0 平台开发。系统旨在提供完整的台球厅运营管理解决方案。

### 1.2 核心架构原则
- **模块隔离**：各业务模块之间严格隔离，避免直接依赖
- **垂直切片**：每个模块包含其完整的业务逻辑，避免分层架构
- **消息驱动**：使用 Wolverine 框架实现模块间的异步消息通信
- **平台共享**：通用能力沉淀到 Platform 层，供各模块使用
- **架构约束**：通过自动化测试强制执行架构规则

### 1.3 技术栈
- **运行时**：.NET 10.0
- **Web 框架**：ASP.NET Core
- **消息框架**：Wolverine（进程内消息总线 + CQRS）
- **数据存储**：Marten (PostgreSQL 文档数据库) / EF Core
- **测试框架**：xUnit + NetArchTest
- **构建工具**：MSBuild / .NET CLI

### 1.4 为什么选择 Wolverine？

Wolverine 是专为模块化单体架构设计的现代消息框架，具有以下优势：

**核心优势**：
- **低代码仪式感**：无需定义接口或注册服务，Convention-based 自动发现
- **进程内消息总线**：模块间通过消息解耦，避免直接引用
- **CQRS 原生支持**：命令、事件、查询的清晰分离
- **持久化消息**：Inbox/Outbox Pattern 保证消息可靠性
- **平滑演进路径**：轻松从单体切换到分布式系统（RabbitMQ/Azure Service Bus）

**与本项目的契合点**：
- ✅ 模块隔离：Orders 和 Members 通过事件通信，无直接依赖
- ✅ 垂直切片：每个功能一个命令/事件 Handler，代码组织清晰
- ✅ 可测试性：Handler 是纯函数，易于单元测试
- ✅ 性能优秀：进程内通信，无网络开销
- ✅ 可观测性：内置诊断、追踪、日志集成

---

## 二、当前项目结构

```
Zss.BilliardHall/
├── src/
│   ├── Platform/           # 平台层：共享基础设施和能力
│   ├── Application/        # 应用层：跨模块编排和集成
│   ├── Modules/           # 业务模块层
│   │   ├── Members/       # 会员管理模块
│   │   └── Orders/        # 订单管理模块
│   ├── Host/              # 托管层
│   │   ├── WebHost/       # Web API 宿主
│   │   └── Worker/        # 后台任务宿主
│   └── tests/
│       └── ArchitectureTests/  # 架构约束测试
└── docs/                  # 文档项目
```

---

## 三、模块开发计划

### 3.1 会员管理模块 (Members)

#### 3.1.1 核心功能
- [ ] **会员注册与认证**
  - 会员信息注册（姓名、手机号、身份证等）
  - 会员登录认证（手机号 + 验证码 / 密码）
  - 会员信息修改
  
- [ ] **会员卡管理**
  - 会员卡类型定义（普通卡、金卡、钻石卡等）
  - 会员卡开卡
  - 会员卡充值
  - 会员卡余额查询
  - 会员卡冻结 / 解冻
  
- [ ] **会员等级体系**
  - 积分规则配置
  - 会员等级自动升降级
  - 等级权益配置
  
- [ ] **会员统计分析**
  - 会员消费统计
  - 会员活跃度分析
  - 会员流失预警

#### 3.1.2 技术实现要点（基于 Wolverine 垂直切片架构）
```csharp
// Wolverine 模块化架构推荐结构
Modules/Members/
  ├── Features/              # 按功能垂直切片
  │   ├── Registration/      # 会员注册
  │   │   ├── RegisterMember.cs        # Command
  │   │   ├── RegisterMemberHandler.cs # Command Handler
  │   │   └── MemberRegistered.cs      # Domain Event
  │   ├── Cards/            # 会员卡管理
  │   │   ├── IssueCard.cs
  │   │   ├── RechargeCard.cs
  │   │   └── CardHandlers.cs
  │   ├── Loyalty/          # 积分与等级
  │   │   ├── AddPoints.cs
  │   │   ├── UpgradeTier.cs
  │   │   └── LoyaltyHandlers.cs
  │   └── Analytics/        # 统计分析
  │       └── MemberStatisticsQuery.cs
  ├── Events/               # 领域事件（跨模块发布）
  │   ├── MemberRegistered.cs
  │   ├── CardRecharged.cs
  │   └── TierUpgraded.cs
  ├── Contracts/            # 对外契约（供其他模块消费）
  │   └── IMemberQueries.cs
  └── Members.csproj

// 使用 Wolverine 命令处理示例
public record RegisterMember(string Name, string Phone);

public static class RegisterMemberHandler
{
    // Wolverine 自动发现并注册此 handler
    public static async Task<MemberRegistered> Handle(
        RegisterMember command, 
        IDocumentSession session)
    {
        var member = new Member(command.Name, command.Phone);
        session.Store(member);
        await session.SaveChangesAsync();
        
        // 返回事件，Wolverine 自动发布
        return new MemberRegistered(member.Id, member.Name);
    }
}
```

#### 3.1.3 数据模型设计
- **Member**（会员实体）
  - Id, Name, Phone, IdCard, RegisteredAt, Status
- **MemberCard**（会员卡）
  - Id, MemberId, CardType, Balance, Status, IssuedAt
- **MemberLevel**（会员等级）
  - Id, Name, RequiredPoints, Benefits
- **LoyaltyPoints**（积分记录）
  - Id, MemberId, Points, Source, CreatedAt

---

### 3.2 订单管理模块 (Orders)

#### 3.2.1 核心功能
- [ ] **台桌管理**
  - 台桌信息维护（编号、类型、状态）
  - 台桌实时状态监控
  - 台桌预订管理
  
- [ ] **计费规则**
  - 计费方式配置（按小时、按局、包时段）
  - 价格策略配置（会员折扣、时段差价）
  - 超时费用计算
  
- [ ] **开台与结账**
  - 开台登记（台桌、会员、开始时间）
  - 计时计费
  - 商品消费（饮料、小食等）
  - 结账（现金、会员卡、移动支付）
  
- [ ] **订单查询与统计**
  - 订单历史查询
  - 营业额统计
  - 高峰时段分析

#### 3.2.2 技术实现要点（基于 Wolverine 垂直切片架构）
```csharp
Modules/Orders/
  ├── Features/
  │   ├── Tables/           # 台桌管理
  │   │   ├── ReserveTable.cs
  │   │   └── TableHandlers.cs
  │   ├── Pricing/          # 计费规则
  │   │   ├── ConfigurePricing.cs
  │   │   └── PricingHandlers.cs
  │   ├── Sessions/         # 开台结账
  │   │   ├── StartSession.cs          # Command
  │   │   ├── EndSession.cs            # Command
  │   │   ├── SessionHandlers.cs       # Handlers
  │   │   └── SessionStarted.cs        # Event
  │   └── Reporting/        # 报表统计
  │       └── OrderStatisticsQuery.cs
  ├── Events/               # 领域事件
  │   ├── SessionStarted.cs
  │   ├── SessionEnded.cs
  │   └── PaymentCompleted.cs
  ├── Contracts/
  └── Orders.csproj

// 模块间通信示例：订单完成后更新会员积分
// Orders 模块发布事件
public record PaymentCompleted(Guid MemberId, decimal Amount);

// Members 模块订阅事件（Wolverine 自动路由）
public static class PaymentCompletedHandler
{
    public static AddPoints Handle(PaymentCompleted evt)
    {
        // 消费 1 元获得 1 积分
        var points = (int)evt.Amount;
        return new AddPoints(evt.MemberId, points, "消费积分");
    }
}
```

#### 3.2.3 数据模型设计
- **Table**（台桌）
  - Id, Number, Type, Status, HourlyRate
- **PricingRule**（计费规则）
  - Id, Name, Type, BaseRate, MemberDiscount
- **Session**（开台记录）
  - Id, TableId, MemberId, StartTime, EndTime, Status
- **Order**（订单）
  - Id, SessionId, TotalAmount, PaymentMethod, PaidAt

---

### 3.3 未来模块规划

#### 3.3.1 商品管理模块 (Products)
- 商品信息管理（饮料、零食、台球用品）
- 库存管理
- 采购入库
- 库存预警

#### 3.3.2 员工管理模块 (Staff)
- 员工信息管理
- 排班管理
- 权限管理
- 考勤统计

#### 3.3.3 营销管理模块 (Marketing)
- 优惠券管理
- 活动管理
- 会员推广
- 短信通知

---

## 四、平台层 (Platform) 开发计划

### 4.1 基础设施能力

- [ ] **Wolverine 消息框架集成**
  - 进程内消息总线配置
  - 命令/事件路由规则
  - 消息处理管道（中间件）
  - 消息持久化（Inbox/Outbox Pattern）
  - 延迟消息与重试策略
  - 未来支持外部消息队列（RabbitMQ/Azure Service Bus）

- [ ] **数据访问（推荐 Marten + PostgreSQL）**
  - Marten 作为文档数据库 + 事件存储
  - Entity Framework Core（可选，用于关系型场景）
  - 工作单元（Unit of Work）
  - 数据库迁移管理

- [ ] **领域事件（通过 Wolverine）**
  - 使用 Wolverine 的事件发布/订阅
  - 模块间通过异步消息解耦
  - 事件持久化（Durable Messaging）
  - 事件版本控制

- [ ] **认证授权**
  - JWT Token 生成与验证
  - 基于角色的访问控制（RBAC）
  - 资源权限控制

- [ ] **日志与监控**
  - 结构化日志（Serilog）
  - Wolverine 诊断与追踪
  - 性能指标收集
  - 异常追踪

- [ ] **缓存**
  - 内存缓存（IMemoryCache）
  - 分布式缓存（Redis）
  - 缓存策略封装

- [ ] **验证与错误处理**
  - FluentValidation 集成
  - Wolverine 中间件进行验证
  - 统一异常处理
  - 错误响应标准化

### 4.2 技术实现结构
```csharp
Platform/
  ├── Messaging/            # Wolverine 配置与扩展
  │   ├── WolverineConfiguration.cs
  │   ├── MessageHandlerConventions.cs
  │   └── OutboxConfiguration.cs
  ├── Data/                 # 数据访问（Marten/EF Core）
  │   ├── MartenConfiguration.cs
  │   └── Repositories/
  ├── Events/               # 事件相关基础设施
  │   ├── EventMetadata.cs
  │   └── EventSerializer.cs
  ├── Auth/                 # 认证授权
  ├── Logging/              # 日志
  ├── Caching/              # 缓存
  ├── Validation/           # 验证
  └── Platform.csproj

// Wolverine 配置示例
builder.Host.UseWolverine(opts =>
{
    // 配置消息路由
    opts.PublishAllMessages()
        .ToLocalQueue("events")
        .UseDurableInbox();
    
    // 自动发现所有模块的 Handler
    opts.Discovery.IncludeAssembly(typeof(Members.Module).Assembly);
    opts.Discovery.IncludeAssembly(typeof(Orders.Module).Assembly);
    
    // 持久化配置（Marten）
    opts.UseMarten(connectionString);
});
```

---

## 五、应用层 (Application) 开发计划

### 5.1 核心职责
- 模块初始化与编排
- 跨模块流程协调
- 全局配置管理

### 5.2 实现内容
- [ ] **模块注册**
  - 自动发现并注册各模块
  - 依赖注入配置

- [ ] **全局中间件**
  - 请求日志
  - 异常处理
  - 性能监控

- [ ] **配置管理**
  - appsettings.json 管理
  - 环境变量配置
  - 配置热更新

---

## 六、宿主层 (Host) 开发计划

### 6.1 WebHost 开发
- [ ] **API 设计**
  - RESTful API 规范
  - Swagger / OpenAPI 文档
  - API 版本控制

- [ ] **中间件配置**
  - CORS 跨域
  - 压缩
  - 限流

- [ ] **健康检查**
  - 数据库连接检查
  - 依赖服务检查
  - 就绪探针

### 6.2 Worker 开发
- [ ] **后台任务**
  - 会员等级自动升级
  - 数据统计报表生成
  - 数据清理归档

- [ ] **定时任务**
  - Quartz.NET 集成
  - 任务调度管理

---

## 七、测试策略

### 7.1 架构测试 (ArchitectureTests)
- [x] 模块隔离测试
- [x] 命名空间约束
- [x] 依赖边界检查
- [ ] 增强测试覆盖率

### 7.2 单元测试
- [ ] Members 模块单元测试
- [ ] Orders 模块单元测试
- [ ] Platform 工具类测试

### 7.3 集成测试
- [ ] API 端到端测试
- [ ] 数据库集成测试
- [ ] 跨模块集成测试

### 7.4 性能测试
- [ ] 高并发场景测试
- [ ] 压力测试
- [ ] 性能瓶颈分析

---

## 八、数据库设计

### 8.1 数据库选型
- **主库**：PostgreSQL / SQL Server
- **缓存**：Redis
- **消息队列**：RabbitMQ / Azure Service Bus（可选）

### 8.2 数据库架构
- **每模块独立 Schema**：实现逻辑隔离
  - `members.*` - 会员模块表
  - `orders.*` - 订单模块表
  - `platform.*` - 平台共享表

### 8.3 迁移策略
- 使用 EF Core Migrations
- 版本化管理
- 自动化部署脚本

---

## 九、开发阶段与里程碑

### 阶段一：基础设施搭建（2-3周）
- [x] 项目结构搭建
- [x] 架构约束测试
- [ ] Platform 层基础能力开发
  - 数据访问封装
  - 领域事件基础设施
  - 日志与异常处理
- [ ] WebHost 基础配置
- [ ] 数据库初始化

**交付物**：可运行的 Web API 框架，支持健康检查

### 阶段二：会员模块开发（3-4周）
- [ ] 会员注册与认证
- [ ] 会员卡管理
- [ ] 会员等级体系
- [ ] 单元测试与集成测试
- [ ] API 文档

**交付物**：完整的会员管理功能，包含 API 和测试

### 阶段三：订单模块开发（4-5周）
- [ ] 台桌管理
- [ ] 计费规则引擎
- [ ] 开台与结账流程
- [ ] 订单查询与报表
- [ ] 单元测试与集成测试

**交付物**：完整的订单管理功能，支持开台计费结账

### 阶段四：模块集成与优化（2-3周）
- [ ] 会员与订单联动（会员消费积分）
- [ ] 跨模块事件处理
- [ ] 性能优化
- [ ] 压力测试
- [ ] 监控告警配置

**交付物**：集成的系统，性能达标

### 阶段五：扩展功能开发（按需）
- [ ] 商品管理模块
- [ ] 员工管理模块
- [ ] 营销管理模块
- [ ] 移动端 API
- [ ] 管理后台界面

---

## 十、技术债务与优化项

### 10.1 当前待办
- [ ] 完善 Platform 层实现
- [ ] 补充 Members 和 Orders 模块代码
- [ ] 添加数据库迁移
- [ ] 完善测试覆盖

### 10.2 架构优化方向
- [ ] 引入 CQRS 模式（命令查询分离）
- [ ] 实现读写分离
- [ ] 引入分布式缓存
- [ ] 实现异步消息处理
- [ ] 容器化部署（Docker）

### 10.3 工程实践
- [ ] CI/CD 流水线配置
- [ ] 代码质量门禁（SonarQube）
- [ ] 自动化部署脚本
- [ ] 监控告警系统
- [ ] 文档自动生成

---

## 十一、团队协作规范

### 11.1 分支策略
- `main` - 主分支，生产就绪代码
- `develop` - 开发分支
- `feature/*` - 功能分支
- `bugfix/*` - 修复分支

### 11.2 提交规范
使用 Conventional Commits：
- `feat:` - 新功能
- `fix:` - 修复
- `refactor:` - 重构
- `test:` - 测试
- `docs:` - 文档

### 11.3 代码审查
- 所有代码必须经过 PR 审查
- 至少一位团队成员批准
- CI 测试通过
- 架构约束测试通过

---

## 十二、风险与挑战

### 12.1 技术风险
- **.NET 10.0 稳定性**：新版本可能存在未知问题
  - 缓解：关注官方发布说明，及时更新
  
- **模块边界划分**：初期设计可能需要调整
  - 缓解：通过架构测试强制约束，定期评审

### 12.2 业务风险
- **需求变更频繁**：台球厅业务模式可能调整
  - 缓解：模块化架构便于局部调整
  
- **性能要求**：高峰期并发压力
  - 缓解：早期性能测试，预留优化空间

---

## 十三、参考资料

### 13.1 架构设计
- [Modular Monolith: A Primer](https://www.kamilgrzybek.com/design/modular-monolith-primer/)
- [Domain-Driven Design](https://martinfowler.com/bliki/DomainDrivenDesign.html)
- [Vertical Slice Architecture](https://jimmybogard.com/vertical-slice-architecture/)
- [Wolverine 模块化单体教程](https://wolverinefx.net/tutorials/modular-monolith.html)
- [Wolverine 3.6 模块化架构特性](https://jeremydmiller.com/2025/01/12/wolverine-3-6-modular-monolith-and-vertical-slice-architecture-goodies/)

### 13.2 技术文档
- [.NET 10.0 Documentation](https://learn.microsoft.com/en-us/dotnet/)
- [ASP.NET Core Documentation](https://learn.microsoft.com/en-us/aspnet/core/)
- [Wolverine 官方文档](https://wolverinefx.net/)
- [Marten 文档数据库](https://martendb.io/)
- [Entity Framework Core](https://learn.microsoft.com/en-us/ef/core/)

### 13.3 测试
- [xUnit Documentation](https://xunit.net/)
- [NetArchTest](https://github.com/BenMorris/NetArchTest)

---

## 附录：快速开始指南

### 构建项目
```bash
# 克隆仓库
git clone https://github.com/douhuaa/Zss.BilliardHall.git
cd Zss.BilliardHall

# 还原依赖
dotnet restore

# 构建
dotnet build

# 运行架构测试
dotnet test ./src/tests/ArchitectureTests/ArchitectureTests.csproj
```

### 运行 Web API
```bash
cd src/Host/WebHost
dotnet run
```

### 运行 Worker
```bash
cd src/Host/Worker
dotnet run
```

---

**文档版本**：v1.0  
**最后更新**：2026-01-18  
**维护者**：开发团队
