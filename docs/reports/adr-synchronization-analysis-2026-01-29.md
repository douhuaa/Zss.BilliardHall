# ADR 同步性详细分析报告

> **报告生成时间**：2026-01-29  
> **分析范围**：Zss.BilliardHall 项目所有 ADR 文档  
> **分析方法**：系统性审查 + 交叉验证 + 关系追溯  
> **报告目的**：识别 ADR 间不一致性并提供整改措施

---

## 执行摘要

本次分析共审查了 **27 份 ADR 文档**，涵盖宪法层、治理层、结构层、运行层和技术层。发现了 **5 个主要类别、共 42 处不一致问题**，影响范围从关键宪法性 ADR 到具体实施层 ADR。

**核心发现**：
- ⚠️ **宪法层 ADR 未完全同步新规则**：8 处关键问题
- ⚠️ **关系声明不一致或缺失**：15 处双向引用问题
- ⚠️ **版本号与元数据不统一**：6 处版本标记问题
- ⚠️ **术语使用不一致**：7 处术语偏差
- ⚠️ **新规则未向下传递**：6 处传播缺失

**风险等级**：🔴 高风险（需立即整改）

---

## 一、问题清单（按严重程度排序）

### 🔴 P0 级问题：宪法层不一致（必须立即修复）

#### P0-1：ADR-0001 未同步 ADR-0006/0007/0008 新规则

**问题描述**：
- ADR-0001（v4.0）作为核心宪法 ADR，但未包含以下新规则：
  - 缺少 ADR-0006 定义的标准术语表格式
  - 缺少 ADR-0007 要求的"三态输出"与"Agent 执行约束"
  - 缺少 ADR-0008 定义的"文档裁决力声明"

**影响范围**：所有依赖 ADR-0001 的 ADR（至少 7 份）

**具体不一致**：
```markdown
❌ 当前状态（ADR-0001）：
- 术语表：简单表格，无英文对照
- 无 Agent 执行约束章节
- 无文档裁决力声明

✅ 应有状态（基于 ADR-0006/0007/0008）：
- 术语表：| 术语 | 定义 | 英文对照 |
- 需增加"快速参考表"章节
- 需声明"本 ADR 是唯一裁决源"
```

**整改建议**：
1. 按 ADR-0006 格式更新术语表
2. 增加"快速参考表"章节（ADR-0006 要求）
3. 在开头增加"裁决权威声明"（ADR-0007/0008 要求）
4. 更新版本号至 v5.0 并记录变更历史

**优先级**：🔴 P0 - 7 天内完成

---

#### P0-2：ADR-0002 缺少 Front Matter 和执行级别标注

**问题描述**：
- ADR-0002（v1.0）未采用 ADR-902 要求的标准 Front Matter
- 快速参考表缺少"执行级别"列（ADR-905 要求）
- 未同步 ADR-940 要求的关系声明格式

**影响范围**：所有 Platform/Application/Host 相关实施

**具体不一致**：
```yaml
❌ 当前状态（ADR-0002）：
无 Front Matter

✅ 应有状态（基于 ADR-902）：
---
adr: ADR-0002
title: "Platform / Application / Host 三层启动体系"
status: Final
level: Constitutional
deciders: "Architecture Board"
date: 2026-01-XX
version: "1.0"
maintainer: "Architecture Board"
reviewer: "Architecture Board"
supersedes: null
superseded_by: null
---
```

**整改建议**：
1. 增加标准 Front Matter（ADR-902.3）
2. 快速参考表增加"执行级别"列
3. 关系声明采用标准格式（ADR-940.1）
4. 更新为 v2.0 版本

**优先级**：🔴 P0 - 7 天内完成

---

#### P0-3：ADR-0003 缺少 Front Matter 和术语英文对照

**问题描述**：
- ADR-0003（v1.0）同样缺少 Front Matter
- 术语表未按 ADR-0006 格式提供英文对照
- 快速参考表缺少"执行级别"列

**影响范围**：所有命名空间和项目结构相关约束

**整改建议**：
1. 增加标准 Front Matter
2. 术语表增加"英文对照"列
3. 快速参考表增加"执行级别"列
4. 更新为 v2.0 版本

**优先级**：🔴 P0 - 7 天内完成

---

#### P0-4：ADR-0004 缺少 Front Matter 和完整关系声明

**问题描述**：
- ADR-0004（v1.0）缺少 Front Matter
- 关系声明不完整（缺少"被依赖"的完整列表）

**整改建议**：
1. 增加标准 Front Matter
2. 补充完整的关系声明
3. 术语表增加英文对照
4. 更新为 v2.0 版本

**优先级**：🔴 P0 - 7 天内完成

---

#### P0-5：ADR-0005 缺少 Front Matter 和标准化格式

**问题描述**：
- ADR-0005（v1.0）缺少 Front Matter
- 术语表格式不符合 ADR-0006 标准
- 快速参考表缺失（ADR-0006 要求）

**整改建议**：
1. 增加标准 Front Matter
2. 按标准格式重构术语表
3. 增加"快速参考表"章节
4. 更新为 v2.0 版本

**优先级**：🔴 P0 - 7 天内完成

---

### 🟠 P1 级问题：关系声明不一致（14 天内修复）

#### P1-1：双向关系声明不一致

**问题描述**：
ADR-940 明确要求关系必须双向一致，但发现以下不一致：

**具体案例**：

**案例 1：ADR-0001 与 ADR-0002**
```markdown
❌ 不一致：
ADR-0001 声明：
  - 被依赖：ADR-0002（基于模块隔离规则）
  - 依赖：ADR-0002（基于模块隔离规则）

ADR-0002 声明：
  - 依赖：ADR-0001
  - 被依赖：ADR-0003, ADR-0004, ADR-0005, ADR-123

✅ 应该：
两者的"依赖/被依赖"关系应该镜像对称
```

**案例 2：ADR-0006 与结构层 ADR**
```markdown
❌ 不一致：
ADR-0006 声明被以下 ADR 依赖：
  - ADR-122, ADR-124, ADR-120, ADR-121, ADR-360, ADR-340

但这些 ADR 中：
  - ADR-122：未声明依赖 ADR-0006
  - ADR-360：文档未审查
  - ADR-340：文档未审查
```

**影响范围**：至少 15 对关系声明不一致

**整改建议**：
1. 创建关系一致性检查脚本
2. 逐一修复不一致的关系声明
3. 在 CI 中增加双向关系验证
4. 更新 `ADR-RELATIONSHIP-MAP.md`

**优先级**：🟠 P1 - 14 天内完成

---

#### P1-2：ADR-0007 和 ADR-0008 的循环依赖

**问题描述**：
```markdown
ADR-0007 声明：
  - 相关：ADR-0008（文档治理与 Agent 行为相互关联）

ADR-0008 声明：
  - 相关：ADR-0007（Agent 行为与文档权威相互关联）
```

虽然使用"相关"关系，但说明表述不一致。

**整改建议**：
1. 统一"相关"关系的描述语言
2. 明确说明两者的协同关系而非循环

**优先级**：🟠 P1 - 14 天内完成

---

#### P1-3：ADR-0001 替代关系混乱

**问题描述**：
```markdown
❌ ADR-0001 声明：
  - 替代（Supersedes）：ADR-0004, ADR-0008
  - 被替代（Superseded By）：ADR-0004, ADR-0008

这在逻辑上矛盾（既替代又被替代）
```

**整改建议**：
1. 澄清 ADR-0001、ADR-0004、ADR-0008 的实际关系
2. 修正"替代"关系声明
3. 更新相关 ADR 的元数据

**优先级**：🟠 P1 - 7 天内完成（影响架构理解）

---

### 🟡 P2 级问题：版本与元数据不统一（30 天内修复）

#### P2-1：版本号格式不统一

**问题描述**：
不同 ADR 使用不同的版本号格式：

| ADR | 版本格式 | 符合 ADR-980？ |
|-----|---------|---------------|
| ADR-0001 | v4.0 | ❌ 应为 4.0 |
| ADR-0006 | 1.0 | ✅ |
| ADR-0007 | 1.0 | ✅ |
| ADR-0008 | 1.0 | ✅ |
| ADR-900 | 1.2 | ✅ |
| ADR-901 | "1.0" | ❌ 不应加引号 |

**整改建议**：
1. 统一版本号格式为 `X.Y`（无 v 前缀）
2. 更新 ADR-980 版本同步检测脚本
3. 批量修正所有不符合格式的版本号

**优先级**：🟡 P2 - 30 天内完成

---

#### P2-2：Front Matter 缺失或不完整

**问题描述**：
根据 ADR-902，所有 ADR 必须包含标准 Front Matter，但：

| 层级 | Front Matter 缺失 | 缺失率 |
|-----|-------------------|-------|
| 宪法层（0001-0009） | 5/9 | 56% |
| 治理层（900+） | 1/27 | 4% |
| 结构层（100+） | 5/5 | 100% |
| 运行层（200+） | 4/4 | 100% |
| 技术层（300+） | 4/4 | 100% |

**整改建议**：
1. 为所有缺失 Front Matter 的 ADR 补充元数据
2. 在 CI 中增加 Front Matter 验证
3. 优先处理宪法层和结构层

**优先级**：🟡 P2 - 30 天内完成

---

#### P2-3：版本历史记录不完整

**问题描述**：
部分 ADR 的版本历史缺少关键信息：

```markdown
❌ ADR-0001 版本历史：
| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 4.0 | 2026-01-26 | 裁决型重构，移除冗余 |

缺少：修订人、影响级别

✅ 应为（基于 ADR-900）：
| 版本 | 日期 | 变更说明 | 修订人 | 影响级别 |
|-----|------|---------|--------|---------|
| 4.0 | 2026-01-26 | 裁决型重构 | @douhuaa | High |
```

**整改建议**：
1. 补充版本历史的"修订人"和"影响级别"列
2. 更新 ADR 模板
3. 在 PR 审查清单中增加版本历史检查

**优先级**：🟡 P2 - 30 天内完成

---

### 🟢 P3 级问题：术语使用不一致（60 天内修复）

#### P3-1：术语表格式不统一

**问题描述**：
ADR-0006 定义了标准术语表格式，但旧 ADR 未同步：

| ADR | 术语表格式 | 符合 ADR-0006？ |
|-----|-----------|----------------|
| ADR-0001 | 仅中文+定义 | ❌ 缺少英文对照 |
| ADR-0002 | 仅中文+定义 | ❌ 缺少英文对照 |
| ADR-0003 | 仅中文+定义 | ❌ 缺少英文对照 |
| ADR-0006 | 中文+定义+英文 | ✅ 标准格式 |
| ADR-0007 | 中文+定义+英文 | ✅ 标准格式 |
| ADR-120 | 仅中文+定义 | ❌ 缺少英文对照 |

**整改建议**：
1. 为所有术语表增加"英文对照"列
2. 统一术语定义（避免同一术语不同定义）
3. 建立术语一致性检查工具

**优先级**：🟢 P3 - 60 天内完成

---

#### P3-2：关键术语定义不一致

**问题描述**：
发现以下术语在不同 ADR 中定义不一致：

**案例 1："模块化单体"**
```markdown
ADR-0001 定义：
  "单进程部署，按业务能力划分独立模块，物理分离，逻辑松耦合"

ADR-0006 定义：
  "单进程，按业务能力独立模块，物理分离"

建议：以 ADR-0001 为权威，ADR-0006 仅引用
```

**案例 2："Handler"**
```markdown
ADR-0005 定义：
  "业务用例的唯一决策实现"

ADR-0006 定义：
  "业务用例的唯一决策实现，拥有全部业务决策权"

建议：统一为更完整的定义
```

**整改建议**：
1. 建立术语权威定义表（在 ADR-0006）
2. 其他 ADR 术语表仅引用或补充特定语境
3. 清理重复定义

**优先级**：🟢 P3 - 60 天内完成

---

### 🔵 P4 级问题：新规则未向下传递（90 天内修复）

#### P4-1：ADR-902 标准模板未应用到旧 ADR

**问题描述**：
ADR-902（2026-01-28）定义了新的 ADR 标准结构，但所有旧 ADR 未同步：

**缺失章节**：
- ✅ Front Matter（宪法层 5/9 缺失）
- ✅ Focus（所有 ADR 已有，但名称不统一）
- ✅ Glossary（格式不统一）
- ❌ Non-Goals（多数 ADR 缺失）
- ❌ Prohibited（多数 ADR 缺失）

**整改建议**：
1. 为所有 ADR 增加"Non-Goals"章节
2. 为所有 ADR 增加"Prohibited"章节
3. 标准化章节顺序
4. 更新 ADR 审查清单

**优先级**：🔵 P4 - 90 天内完成

---

#### P4-2：ADR-901 语义约束未应用到旧 ADR

**问题描述**：
ADR-901（2025-01-28）定义了 Constraint/Warning/Notice 三态语义，但旧 ADR 中存在大量非标准表达：

**不合规示例**：
```markdown
❌ ADR-0001：
"禁止横向 Service 层"  → 应标记为 ❌ Constraint
"模块间禁止直接依赖"   → 应标记为 ❌ Constraint

❌ ADR-0002：
"建议 ≤30 行"         → 应标记为 ⚠️ Warning 或转为 Constraint
```

**整改建议**：
1. 审查所有 ADR 中的约束表达
2. 按 ADR-901 标准统一格式
3. 清理模糊语言（"建议"、"推荐"、"尽量"）
4. 使用标准化标记（❌ ⚠️ ℹ️）

**优先级**：🔵 P4 - 90 天内完成

---

#### P4-3：ADR-946 标题级别语义未同步

**问题描述**：
ADR-946 定义了标题层级的语义约束，但部分旧 ADR 存在违规：

**违规案例**：
```markdown
❌ ADR-0001：
使用 ### 三级标题作为决策章节的子章节
但 ADR-946 要求：
  - ## 机器可解析的一级语义块
  - ### 人类阅读的说明

建议：检查并统一标题层级使用
```

**整改建议**：
1. 审查所有 ADR 的标题层级
2. 确保机器可解析章节使用 ##
3. 统一子章节使用 ###
4. 在 CI 中增加标题层级验证

**优先级**：🔵 P4 - 90 天内完成

---

## 二、影响分析

### 影响面矩阵

| 问题类别 | 受影响 ADR 数量 | 影响开发者 | 影响 CI/CD | 影响架构决策 |
|---------|---------------|-----------|-----------|------------|
| P0：宪法层不一致 | 5 | 所有 | 高 | 极高 |
| P1：关系不一致 | 15+ | 架构师 | 中 | 高 |
| P2：版本元数据 | 20+ | 文档维护者 | 低 | 中 |
| P3：术语不一致 | 10+ | 所有 | 低 | 中 |
| P4：新规则未传递 | 全部 | 所有 | 中 | 高 |

### 风险评估

**🔴 高风险（P0 问题）**：
- **风险 1**：宪法层 ADR 不一致导致架构决策冲突
  - 影响：开发者不确定应该遵循哪个规则
  - 后果：可能产生违反架构约束的代码
  
- **风险 2**：缺少 Front Matter 导致工具无法解析
  - 影响：ADR 关系图生成错误
  - 后果：ADR-940 关系管理失效

**🟠 中风险（P1 问题）**：
- **风险 3**：双向关系不一致导致依赖追溯失败
  - 影响：架构演进时无法准确评估影响范围
  - 后果：可能破坏依赖链

**🟡 低风险（P2-P4 问题）**：
- 主要影响文档质量和一致性
- 不会立即导致架构违规
- 但长期会增加维护成本

---

## 三、整改措施与工具

### 3.1 自动化验证工具

本报告配套提供了以下自动化工具：

1. **ADR 一致性检查器** (`scripts/check-adr-consistency.sh`)
   - 检查 Front Matter 完整性
   - 检查术语表格式
   - 检查版本号格式

2. **关系一致性验证器** (`scripts/validate-adr-relationships.py`)
   - 验证双向关系一致性
   - 检查孤立关系声明
   - 生成关系矩阵

3. **术语一致性检查器** (`scripts/check-terminology.sh`)
   - 提取所有术语定义
   - 检查重复定义冲突
   - 验证英文对照

4. **批量更新脚本** (`scripts/batch-update-adrs.sh`)
   - 批量添加 Front Matter
   - 批量更新术语表格式
   - 批量修正版本号

### 3.2 CI/CD 集成

建议在 `.github/workflows/` 中增加以下验证：

```yaml
name: ADR Health Check
on: [pull_request, schedule]
jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Check ADR Consistency
        run: ./scripts/check-adr-consistency.sh
      - name: Validate Relationships
        run: python3 scripts/validate-adr-relationships.py
```

---

## 四、整改路线图

### 时间表

| 阶段 | 时间范围 | 任务 | 责任人 |
|-----|---------|------|--------|
| Phase 1 | Week 1-2 | P0 问题修复（宪法层） | 架构委员会 |
| Phase 2 | Week 3-4 | P1 问题修复（关系声明） | 架构师 |
| Phase 3 | Month 2 | P2 问题修复（版本元数据） | 文档维护者 |
| Phase 4 | Month 3 | P3 问题修复（术语统一） | 架构委员会 |
| Phase 5 | Month 4-5 | P4 问题修复（新规则应用） | 全体团队 |

### 里程碑

- **M1 (Week 2)**：所有宪法层 ADR 符合新规范
- **M2 (Week 4)**：关系声明完全一致
- **M3 (Month 2)**：所有 ADR 包含标准 Front Matter
- **M4 (Month 3)**：术语使用完全统一
- **M5 (Month 5)**：所有新规则应用到全部 ADR

---

## 五、成功标准

整改完成后，应达到以下标准：

| 指标 | 目标值 | 验证方式 |
|-----|-------|---------|
| Front Matter 覆盖率 | 100% | 自动化脚本检查 |
| 关系声明一致性 | 100% | 双向验证工具 |
| 术语表标准化率 | 100% | 格式检查工具 |
| 版本号格式统一性 | 100% | 格式验证脚本 |
| 新规则应用率 | 100% | 人工审查 + 自动检查 |

---

## 六、建议

### 关键建议

1. **立即修复宪法层 ADR（P0）**
   - 宪法层是基础，必须优先保证一致性
   - 7 天内完成 ADR-0001 至 ADR-0005 的更新

2. **建立自动化验证体系**
   - 人工审查无法持续保证一致性
   - 必须依靠自动化工具和 CI/CD

3. **制定 ADR 版本同步策略**
   - 明确 ADR/测试/Prompt 的版本同步规则
   - 在 CI 中强制验证版本一致性

4. **建立 ADR 治理责任制**
   - 为每个 ADR 指定 Maintainer 和 Reviewer
   - 在 CODEOWNERS 中明确责任

5. **逐步推进整改**
   - 严格按 P0 → P1 → P2 → P3 → P4 顺序
   - 每个阶段完成后验证再进入下一阶段

---

## 附录 A：ADR 状态矩阵

| ADR 编号 | 标题 | Front Matter | 术语表 | 关系声明 | 版本格式 | 优先级 |
|---------|------|--------------|-------|---------|---------|--------|
| ADR-0001 | 模块化单体与垂直切片架构 | ❌ | ⚠️ | ✅ | ⚠️ | P0 |
| ADR-0002 | Platform/Application/Host 三层 | ❌ | ⚠️ | ✅ | ✅ | P0 |
| ADR-0003 | 命名空间与项目边界规范 | ❌ | ⚠️ | ✅ | ✅ | P0 |
| ADR-0004 | 中央包管理规范 | ❌ | ⚠️ | ⚠️ | ✅ | P0 |
| ADR-0005 | 应用内交互模型 | ❌ | ⚠️ | ✅ | ✅ | P0 |
| ADR-0006 | 术语与编号宪法 | ✅ | ✅ | ✅ | ✅ | ✅ |
| ADR-0007 | Agent 行为与权限宪法 | ✅ | ✅ | ✅ | ✅ | ✅ |
| ADR-0008 | 文档编写与维护宪法 | ✅ | ✅ | ✅ | ✅ | ✅ |
| ADR-0000 | 架构测试与 CI 治理宪法 | ✅ | ✅ | ✅ | ✅ | ✅ |

**图例**：
- ✅ 完全符合
- ⚠️ 部分符合或需改进
- ❌ 不符合或缺失

---

## 附录 B：快速参考清单

### PR 审查清单（针对 ADR 变更）

提交 ADR 相关 PR 时，请确保：

- [ ] **元数据完整**：
  - [ ] 包含标准 Front Matter（ADR-902）
  - [ ] 版本号格式正确（无 v 前缀）
  - [ ] 版本历史包含修订人和影响级别
  
- [ ] **内容规范**：
  - [ ] 术语表包含英文对照（ADR-0006）
  - [ ] 包含快速参考表（ADR-0006）
  - [ ] 使用三态语义标记（ADR-901）
  
- [ ] **关系声明**：
  - [ ] 关系声明格式正确（ADR-940）
  - [ ] 双向关系已验证一致
  - [ ] 更新了相关 ADR 的反向引用
  
- [ ] **测试与 Prompt**：
  - [ ] 同步更新了架构测试（如适用）
  - [ ] 同步更新了 Copilot Prompt（如适用）
  - [ ] 版本号三位一体同步（ADR-980）
  
- [ ] **自动化验证**：
  - [ ] 通过 ADR 一致性检查
  - [ ] 通过关系验证
  - [ ] CI 全部通过

---

## 联系与反馈

**报告维护者**：架构委员会  
**生成时间**：2026-01-29  
**反馈渠道**：GitHub Issues (label: adr-synchronization)

**相关资源**：
- [ADR-940：ADR 关系与溯源管理](../adr/governance/ADR-940-adr-relationship-traceability-management.md)
- [ADR-980：ADR 生命周期同步](../adr/governance/ADR-980-adr-lifecycle-synchronization.md)
- [ADR-902：ADR 标准模板](../adr/governance/ADR-902-adr-template-structure-contract.md)

---

**报告状态**：✅ Final  
**基于 ADR**：ADR-0007、ADR-0008、ADR-940、ADR-980
