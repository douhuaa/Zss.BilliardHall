# ADR-010: Handler è¡Œæ•°é™åˆ¶

## çŠ¶æ€

**æ¥å—**

## ä¸Šä¸‹æ–‡

åœ¨å‚ç›´åˆ‡ç‰‡æ¶æ„ä¸­ï¼ŒHandler æ˜¯ä¸šåŠ¡é€»è¾‘çš„æ ¸å¿ƒè½½ä½“ã€‚éšç€ä¸šåŠ¡å¤æ‚åº¦å¢åŠ ï¼ŒHandler å¯èƒ½å˜å¾—è‡ƒè‚¿ï¼Œå¯¼è‡´ç»´æŠ¤å›°éš¾ã€‚

### é¢ä¸´çš„é—®é¢˜

1. **è®¤çŸ¥è´Ÿæ‹…**ï¼š
   - è¶…é•¿ Handlerï¼ˆ> 100 è¡Œï¼‰éš¾ä»¥ç†è§£
   - æ–°äººéœ€è¦èŠ±è´¹å¤§é‡æ—¶é—´ç†è§£å•ä¸ª Handler
   - è°ƒè¯•å’Œæµ‹è¯•å˜å¾—å›°éš¾

2. **èŒè´£ä¸æ¸…**ï¼š
   - è‡ƒè‚¿çš„ Handler å¾€å¾€æ‰¿æ‹…è¿‡å¤šèŒè´£
   - ä¸šåŠ¡é€»è¾‘ã€æ•°æ®è®¿é—®ã€å¤–éƒ¨è°ƒç”¨æ··æ‚åœ¨ä¸€èµ·
   - è¿åå•ä¸€èŒè´£åŸåˆ™

3. **æµ‹è¯•å¤æ‚**ï¼š
   - è¶…é•¿ Handler éœ€è¦å¤§é‡æµ‹è¯•ç”¨ä¾‹è¦†ç›–åˆ†æ”¯
   - Mock ä¾èµ–å¢å¤šï¼Œæµ‹è¯•å˜å¾—è„†å¼±
   - éš¾ä»¥ç¼–å†™æ¸…æ™°çš„æµ‹è¯•

4. **ç°å®æ¡ˆä¾‹**ï¼š
   ```csharp
   // âŒ 80+ è¡Œçš„ Handlerï¼ˆè®¤çŸ¥å´©æºƒï¼‰
   public class ProcessOrderHandler  
   {
       public async Task Handle(ProcessOrder cmd)
       {
           // åº“å­˜æ£€æŸ¥ï¼ˆ15 è¡Œï¼‰
           // ä»·æ ¼è®¡ç®—ï¼ˆ20 è¡Œï¼‰
           // ä¼˜æƒ åˆ¸å¤„ç†ï¼ˆ15 è¡Œï¼‰
           // ç§¯åˆ†è®¡ç®—ï¼ˆ15 è¡Œï¼‰
           // æ”¯ä»˜å¤„ç†ï¼ˆ15 è¡Œï¼‰
           // æ€»è®¡ï¼š80+ è¡Œï¼Œå¤ªå¤æ‚ï¼
       }
   }
   ```

## å†³ç­–

**å»ºç«‹ Handler è¡Œæ•°é™åˆ¶çš„ä¸‰å±‚æ ‡å‡†ï¼š**

| è¡Œæ•°èŒƒå›´ | å¤„ç†ç­–ç•¥ | è¯´æ˜ |
|---------|---------|------|
| â‰¤ 40 è¡Œ | âœ… **é€šè¿‡** | æ ‡å‡† Handlerï¼Œæ— éœ€ç‰¹æ®Šå¤„ç† |
| 41-60 è¡Œ | âš ï¸ **Review** | éœ€è¦ Code Review ç¡®è®¤å¤æ‚åº¦åˆç† |
| 61-80 è¡Œ | âŒ **ç¦æ­¢åˆå¹¶** | å¿…é¡»é‡æ„åæ‰èƒ½åˆå¹¶ |
| > 80 è¡Œ | ğŸš¨ **æ¶æ„é—®é¢˜** | è¯´æ˜æ¶æ„è®¾è®¡æœ‰é—®é¢˜ï¼Œéœ€è¦é‡æ–°å®¡è§† |

### è¡Œæ•°è®¡ç®—è§„åˆ™

**åªè®¡ç®— Handler æ–¹æ³•å†…çš„æœ‰æ•ˆä»£ç è¡Œ**ï¼š
- âœ… åŒ…å«ï¼šä¸šåŠ¡é€»è¾‘ã€æ•°æ®è®¿é—®ã€æ–¹æ³•è°ƒç”¨
- âŒ ä¸åŒ…å«ï¼šç©ºè¡Œã€æ³¨é‡Šã€èŠ±æ‹¬å·ã€ç±»å®šä¹‰ã€æ–¹æ³•ç­¾å

**ç¤ºä¾‹**ï¼š
```csharp
// è¿™ä¸ª Handler å®é™…è®¡ç®—çº¦ 30 è¡Œ
public class ReserveTableHandler
{
    public async Task<Result<Guid>> Handle(  // ä¸è®¡å…¥
        ReserveTable command,                // ä¸è®¡å…¥
        IDocumentSession session,           // ä¸è®¡å…¥
        IMessageBus bus,                    // ä¸è®¡å…¥
        CancellationToken ct = default)     // ä¸è®¡å…¥
    {                                       // ä¸è®¡å…¥
        // 1. åŠ è½½èšåˆæ ¹                     // ä¸è®¡å…¥æ³¨é‡Š
        var table = await session            // è®¡å…¥ï¼šç¬¬ 1 è¡Œ
            .LoadAsync<Table>(command.TableId, ct)  // è®¡å…¥ï¼šç¬¬ 2 è¡Œ
            ?? throw new NotFoundException("å°çƒæ¡Œä¸å­˜åœ¨");  // è®¡å…¥ï¼šç¬¬ 3 è¡Œ
                                            // ä¸è®¡å…¥ç©ºè¡Œ
        // 2. ä¸šåŠ¡è§„åˆ™æ ¡éªŒ                   // ä¸è®¡å…¥æ³¨é‡Š
        if (table.Status != TableStatus.Available)  // è®¡å…¥ï¼šç¬¬ 4 è¡Œ
            return Result.Fail<Guid>(       // è®¡å…¥ï¼šç¬¬ 5 è¡Œ
                "å°çƒæ¡Œä¸å¯ç”¨",              // è®¡å…¥ï¼šç¬¬ 6 è¡Œ
                ErrorCodes.Tables.Unavailable);  // è®¡å…¥ï¼šç¬¬ 7 è¡Œ
                                            // ä¸è®¡å…¥ç©ºè¡Œ
        // ... å…¶ä½™é€»è¾‘
        return Result.Ok(reservationId);    // è®¡å…¥ï¼šç¬¬ 30 è¡Œ
    }                                       // ä¸è®¡å…¥
}
```

### è¶…è¿‡é™åˆ¶æ—¶çš„é‡æ„ç­–ç•¥

#### ç­–ç•¥ 1ï¼šæå–é¢†åŸŸæœåŠ¡

**é€‚ç”¨åœºæ™¯**ï¼šå¤æ‚çš„ä¸šåŠ¡è§„åˆ™æˆ–ç®—æ³•

```csharp
// âŒ Before: 80 è¡Œ
public class ProcessOrderHandler
{
    public async Task Handle(ProcessOrder cmd)
    {
        // å¤æ‚çš„ä»·æ ¼è®¡ç®—ï¼ˆ30 è¡Œï¼‰
        // å¤æ‚çš„ä¼˜æƒ åˆ¸é€»è¾‘ï¼ˆ25 è¡Œï¼‰
        // å¤æ‚çš„ç§¯åˆ†è®¡ç®—ï¼ˆ25 è¡Œï¼‰
    }
}

// âœ… After: 30 è¡Œ
public class ProcessOrderHandler
{
    public async Task Handle(
        ProcessOrder cmd,
        OrderPricingService pricingService,    // é¢†åŸŸæœåŠ¡
        CouponService couponService,           // é¢†åŸŸæœåŠ¡
        PointsService pointsService)           // é¢†åŸŸæœåŠ¡
    {
        var price = await pricingService.CalculateAsync(cmd);      // 3 è¡Œ
        var discount = await couponService.ApplyAsync(cmd);        // 3 è¡Œ
        var points = await pointsService.CalculateAsync(cmd);      // 3 è¡Œ
        // ç»„è£…å’ŒæŒä¹…åŒ–ï¼ˆ20 è¡Œï¼‰
    }
}
```

#### ç­–ç•¥ 2ï¼šæ‹†åˆ†æˆå¤šä¸ª Handler

**é€‚ç”¨åœºæ™¯**ï¼šHandler æ‰¿æ‹…å¤šä¸ªèŒè´£

```csharp
// âŒ Before: å•ä¸ª Handler åšå¤ªå¤šäº‹
public class ProcessOrderHandler { /* 80 è¡Œ */ }

// âœ… After: æ‹†åˆ†æˆç‹¬ç«‹çš„ Handler
public class CheckStockHandler { /* 15 è¡Œ */ }
public class CalculatePriceHandler { /* 20 è¡Œ */ }
public class ApplyCouponHandler { /* 15 è¡Œ */ }
public class ProcessPaymentHandler { /* 20 è¡Œ */ }
```

#### ç­–ç•¥ 3ï¼šä½¿ç”¨ Saga ç¼–æ’

**é€‚ç”¨åœºæ™¯**ï¼šè·¨æ¨¡å—é•¿æµç¨‹ï¼ˆæ»¡è¶³ ADR-007 çš„ 3 æ¡é“å¾‹ï¼‰

```csharp
// âœ… ä½¿ç”¨ Saga ç¼–æ’å¤šä¸ªæ­¥éª¤
public class OrderProcessingSaga : Saga
{
    public void Handle(OrderCreated evt) => /* è§¦å‘åº“å­˜æ£€æŸ¥ï¼ˆ10 è¡Œï¼‰*/;
    public void Handle(StockReserved evt) => /* è§¦å‘ä»·æ ¼è®¡ç®—ï¼ˆ10 è¡Œï¼‰*/;
    public void Handle(PriceCalculated evt) => /* è§¦å‘æ”¯ä»˜ï¼ˆ10 è¡Œï¼‰*/;
}
```

### è­¦å‘Šä¿¡å·ï¼ˆé™¤äº†è¡Œæ•°ï¼‰

ä»¥ä¸‹æƒ…å†µå³ä½¿è¡Œæ•°æœªè¶…æ ‡ï¼Œä¹Ÿåº”è€ƒè™‘é‡æ„ï¼š

- âŒ åŒ…å« 5+ ä¸ª if/else åˆ†æ”¯
- âŒ éœ€è¦æ³¨å…¥ 5+ ä¸ªä¾èµ–
- âŒ åµŒå¥—æ·±åº¦ > 3 å±‚
- âŒ åŒ…å«å¤æ‚çš„ç®—æ³•é€»è¾‘ï¼ˆå¦‚æ’åºã€å›¾éå†ï¼‰

## åæœ

### æ­£é¢å½±å“

1. **æé«˜å¯è¯»æ€§**ï¼š
   - çŸ­å°çš„ Handler ä¸€ç›®äº†ç„¶
   - é™ä½è®¤çŸ¥è´Ÿæ‹…

2. **æ˜“äºæµ‹è¯•**ï¼š
   - æµ‹è¯•ç”¨ä¾‹å°‘è€Œç²¾
   - æµ‹è¯•æ„å›¾æ¸…æ™°

3. **ä¿ƒè¿›é‡æ„**ï¼š
   - å¼ºåˆ¶æ€è€ƒèŒè´£è¾¹ç•Œ
   - é¼“åŠ±æå–é¢†åŸŸæœåŠ¡

4. **é™ä½ Bug ç‡**ï¼š
   - ç®€å•çš„ä»£ç å°‘å‡ºé”™
   - æ˜“äº Code Review

### è´Ÿé¢å½±å“

1. **å¢åŠ æ–‡ä»¶æ•°é‡**ï¼š
   - æ‹†åˆ†åæ–‡ä»¶å¢å¤š
   - éœ€è¦åœ¨å¤šä¸ªæ–‡ä»¶é—´è·³è½¬

2. **å¯èƒ½è¿‡åº¦æ‹†åˆ†**ï¼š
   - è¿‡åº¦è¿½æ±‚è¡Œæ•°é™åˆ¶ï¼Œå¯¼è‡´è¿‡åº¦è®¾è®¡
   - éœ€è¦å¹³è¡¡

### é£é™©ç¼“è§£

1. **åˆç†ä¾‹å¤–**ï¼š
   - CRUD å¯†é›†çš„åå°ç®¡ç†å¯æ”¾å®½åˆ° 60 è¡Œ
   - ä½†ç»ä¸å…è®¸è¶…è¿‡ 80 è¡Œ

2. **Code Review**ï¼š
   - å®¡æŸ¥æ—¶å…³æ³¨èŒè´£æ¸…æ™°åº¦ï¼Œè€Œéä»…çœ‹è¡Œæ•°
   - è¡Œæ•°åªæ˜¯è¾…åŠ©æŒ‡æ ‡

3. **æä¾›é‡æ„æŒ‡å¯¼**ï¼š
   - åœ¨æ–‡æ¡£ä¸­æä¾›é‡æ„ç¤ºä¾‹
   - åŸ¹è®­å›¢é˜ŸæŒæ¡é‡æ„æŠ€å·§

## æ›¿ä»£æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: æ— è¡Œæ•°é™åˆ¶

**æè¿°**: ä¸è®¾è¡Œæ•°é™åˆ¶ï¼Œå›¢é˜Ÿè‡ªè¡Œæ§åˆ¶

**ä¼˜ç‚¹**: çµæ´»ï¼Œä¸é™åˆ¶å¼€å‘è€…

**ç¼ºç‚¹**:
- Handler æ— é™è†¨èƒ€
- ä»£ç è´¨é‡å‚å·®ä¸é½
- æ–°äººéš¾ä»¥ç»´æŠ¤

**ä¸ºä»€ä¹ˆæœªé‡‡çº³**: ç»éªŒè¡¨æ˜ï¼Œæ— é™åˆ¶ä¼šå¯¼è‡´ä»£ç è´¨é‡ä¸‹é™ã€‚

### æ–¹æ¡ˆ B: æ›´ä¸¥æ ¼é™åˆ¶ï¼ˆ30 è¡Œï¼‰

**æè¿°**: é™åˆ¶ Handler åœ¨ 30 è¡Œä»¥å†…

**ä¼˜ç‚¹**: å¼ºåˆ¶æ›´å¥½çš„è®¾è®¡

**ç¼ºç‚¹**:
- è¿‡åº¦ä¿å®ˆï¼Œå¢åŠ å¿ƒç†è´Ÿæ‹…
- å¾ˆå¤šåˆç†çš„ Handler éœ€è¦é‡æ„
- å¯èƒ½å¯¼è‡´è¿‡åº¦æ‹†åˆ†

**ä¸ºä»€ä¹ˆæœªé‡‡çº³**: 40 è¡Œæ˜¯ç»éªŒå€¼ï¼Œå¹³è¡¡äº†å¯è¯»æ€§å’Œå®ç”¨æ€§ã€‚

### æ–¹æ¡ˆ C: åªæç¤ºï¼Œä¸å¼ºåˆ¶

**æè¿°**: è¶…è¿‡ 40 è¡Œç»™å‡ºè­¦å‘Šï¼Œä½†ä¸é˜»æ­¢åˆå¹¶

**ä¼˜ç‚¹**: å‡å°‘å¼€å‘é˜»åŠ›

**ç¼ºç‚¹**:
- ç¼ºä¹çº¦æŸåŠ›
- è­¦å‘Šå®¹æ˜“è¢«å¿½è§†
- ä»£ç è´¨é‡æ— æ³•ä¿è¯

**ä¸ºä»€ä¹ˆæœªé‡‡çº³**: è½¯æ€§å»ºè®®æ•ˆæœæœ‰é™ï¼Œéœ€è¦ç¡¬æ€§æ ‡å‡†ã€‚

## Code Review æ£€æŸ¥æ¸…å•

å®¡æŸ¥ Handler æ—¶ï¼Œæ£€æŸ¥ä»¥ä¸‹é¡¹ï¼š

- [ ] Handler è¡Œæ•° â‰¤ 40 è¡Œï¼Ÿ
- [ ] å¦‚æœ > 40 è¡Œï¼Œæ˜¯å¦æœ‰åˆç†ç†ç”±ï¼Ÿ
- [ ] æ˜¯å¦å¯ä»¥æå–é¢†åŸŸæœåŠ¡ï¼Ÿ
- [ ] æ˜¯å¦å¯ä»¥æ‹†åˆ†æˆå¤šä¸ª Handlerï¼Ÿ
- [ ] æ˜¯å¦åº”è¯¥ä½¿ç”¨ Sagaï¼Ÿ
- [ ] æ˜¯å¦æœ‰è¶…è¿‡ 5 ä¸ª if/else åˆ†æ”¯ï¼Ÿ
- [ ] æ˜¯å¦æ³¨å…¥è¶…è¿‡ 5 ä¸ªä¾èµ–ï¼Ÿ
- [ ] åµŒå¥—æ·±åº¦æ˜¯å¦ â‰¤ 3 å±‚ï¼Ÿ

## ç›¸å…³å†³ç­–

- [ADR-001: é‡‡ç”¨å‚ç›´åˆ‡ç‰‡æ¶æ„](./ADR-001-é‡‡ç”¨å‚ç›´åˆ‡ç‰‡æ¶æ„.md)
- [ADR-002: Handler å³ Application Service](./ADR-002-Handlerå³ApplicationService.md)
- [ADR-007: Saga ä½¿ç”¨ä¸‰æ¡é“å¾‹](./ADR-007-Sagaä½¿ç”¨ä¸‰æ¡é“å¾‹.md)

## å‚è€ƒèµ„æ–™

- [Clean Code - Robert C. Martin](https://www.oreilly.com/library/view/clean-code-a/9780136083238/)
- [Cognitive Complexity - SonarSource](https://www.sonarsource.com/docs/CognitiveComplexity.pdf)
- ã€ŠWolverine æ¨¡å—åŒ–æ¶æ„è“å›¾ã€‹- 8.4 Handler è¡Œæ•°é™åˆ¶

---

**æ—¥æœŸ**: 2026-01-19  
**å†³ç­–è€…**: æ¶æ„å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-19
