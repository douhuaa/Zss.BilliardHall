# ADR-007: Saga ä½¿ç”¨çš„ä¸‰æ¡é“å¾‹

## çŠ¶æ€

**æ¥å—**

## ä¸Šä¸‹æ–‡

Wolverine æä¾›äº†å¼ºå¤§çš„ Saga æœºåˆ¶ï¼Œç”¨äºç¼–æ’è·¨æ¨¡å—ã€è·¨æ—¶é—´çš„é•¿äº‹åŠ¡æµç¨‹ã€‚ä½† Saga æ˜¯"é‡æ­¦å™¨"ï¼Œè¯¯ç”¨ä¼šå¯¼è‡´"çŠ¶æ€æœºåœ°ç‹±"ã€‚

### é¢ä¸´çš„é—®é¢˜

1. **Saga è¢«æ»¥ç”¨**ï¼š
   - å›¢é˜Ÿçœ‹åˆ° Saga çš„å¼ºå¤§åŠŸèƒ½ï¼Œå€¾å‘äºç”¨ Saga è§£å†³æ‰€æœ‰é—®é¢˜
   - ç®€å•çš„å‘½ä»¤é“¾ä¹Ÿç”¨ Sagaï¼Œè¿‡åº¦è®¾è®¡
   - å¯¼è‡´å¤§é‡ Saga çŠ¶æ€éœ€è¦ç®¡ç†ï¼Œç³»ç»Ÿå¤æ‚åº¦çˆ†ç‚¸

2. **åˆ¤æ–­æ ‡å‡†ä¸æ¸…æ™°**ï¼š
   - ä»€ä¹ˆæ—¶å€™è¯¥ç”¨ Sagaï¼Ÿ
   - ä»€ä¹ˆæ—¶å€™ç”¨æ™®é€š Handler å°±å¤Ÿäº†ï¼Ÿ
   - ä»€ä¹ˆæ—¶å€™ç”¨äº‹ä»¶é©±åŠ¨æ›´åˆé€‚ï¼Ÿ

3. **ç°å®æ¡ˆä¾‹**ï¼š
   ```csharp
   // âŒ è¯¯ç”¨ç¤ºä¾‹ 1ï¼šåªæ˜¯ä¸ºäº†æ‹†åˆ†ä»£ç è€Œç”¨ Saga
   public class CreateOrderSaga : Saga
   {
       public void Handle(CreateOrderCommand cmd)
       {
           // è¿™åªæ˜¯ä¸€ä¸ªæ™®é€šçš„å‘½ä»¤å¤„ç†ï¼Œä¸éœ€è¦ Sagaï¼
       }
   }
   
   // âŒ è¯¯ç”¨ç¤ºä¾‹ 2ï¼šåŒæ­¥æµç¨‹ç”¨ Saga
   public class RegisterMemberSaga : Saga
   {
       public void Handle(RegisterMember cmd)
       {
           // åˆ›å»ºä¼šå‘˜
           // å‘é€æ¬¢è¿é‚®ä»¶
           // å³æ—¶å®Œæˆï¼Œä¸éœ€è¦ Sagaï¼
       }
   }
   ```

### å¿ƒç†åˆ¹è½¦

> **ğŸ’¡ é»„é‡‘æ³•åˆ™**: å¦‚æœä½ åœ¨çŠ¹è±«è¦ä¸è¦ç”¨ Sagaï¼Œç­”æ¡ˆé€šå¸¸æ˜¯ï¼š**ä¸è¦**

## å†³ç­–

**Saga ä½¿ç”¨å¿…é¡»åŒæ—¶æ»¡è¶³ä»¥ä¸‹ 3 æ¡é“å¾‹ï¼Œç¼ºä¸€ä¸å¯ã€‚**

### 3 æ¡é“å¾‹

1. âœ… **è·¨æ¨¡å—**ï¼šæ¶‰åŠ 2 ä¸ªä»¥ä¸Šæ¨¡å—çš„åä½œ
2. âœ… **è·¨æ—¶é—´**ï¼šæµç¨‹æŒç»­æ—¶é—´ > 1 åˆ†é’Ÿï¼ˆéœ€è¦ç­‰å¾…å¤–éƒ¨äº‹ä»¶ï¼‰
3. âœ… **éœ€è¦è¡¥å¿**ï¼šå¤±è´¥æ—¶éœ€è¦è¡¥å¿è€Œä¸æ˜¯ç®€å•å›æ»š

### å†³ç­–æ ‘

```
éœ€è¦ç¼–æ’å¤šä¸ªæ­¥éª¤ï¼Ÿ
  â”œâ”€ æ˜¯å¦è·¨æ¨¡å—ï¼Ÿ
  â”‚   â”œâ”€ å¦ â†’ ä½¿ç”¨æ™®é€š Handler
  â”‚   â””â”€ æ˜¯ â†’ æ˜¯å¦è·¨æ—¶é—´ï¼ˆ> 1åˆ†é’Ÿï¼‰ï¼Ÿ
  â”‚       â”œâ”€ å¦ â†’ ä½¿ç”¨ Command é“¾ï¼ˆInvokeAsyncï¼‰
  â”‚       â””â”€ æ˜¯ â†’ æ˜¯å¦éœ€è¦è¡¥å¿ï¼Ÿ
  â”‚           â”œâ”€ å¦ â†’ ä½¿ç”¨äº‹ä»¶é©±åŠ¨ï¼ˆPublishAsyncï¼‰
  â”‚           â””â”€ æ˜¯ â†’ âœ… ä½¿ç”¨ Saga
  â””â”€ å¦ â†’ å•æ­¥æ“ä½œï¼Œæ— éœ€ Saga
```

### âœ… é€‚åˆ Saga çš„åœºæ™¯

**åœºæ™¯ 1ï¼šè®¢å•å¤„ç†æµç¨‹**
```
è®¢å•åˆ›å»º â†’ åº“å­˜é”å®šï¼ˆç­‰å¾…ï¼‰ â†’ æ”¯ä»˜ï¼ˆç­‰å¾…ç”¨æˆ·ï¼‰ â†’ å‘è´§
âœ… è·¨æ¨¡å—ï¼šOrders + Inventory + Payments + Shipping
âœ… è·¨æ—¶é—´ï¼šç­‰å¾…ç”¨æˆ·æ”¯ä»˜ï¼ˆåˆ†é’Ÿåˆ°å°æ—¶çº§ï¼‰
âœ… éœ€è¦è¡¥å¿ï¼šæ”¯ä»˜å¤±è´¥éœ€è¦é‡Šæ”¾åº“å­˜
```

**åœºæ™¯ 2ï¼šæ‰“çƒä¼šè¯ç”Ÿå‘½å‘¨æœŸ**
```
å¼€å° â†’ è®¡æ—¶ï¼ˆç­‰å¾…ï¼‰ â†’ æš‚åœ/æ¢å¤ â†’ ç»“è´¦ï¼ˆç­‰å¾…ï¼‰ â†’ æ”¯ä»˜ â†’ å…³å°
âœ… è·¨æ¨¡å—ï¼šSessions + Tables + Billing + Payments
âœ… è·¨æ—¶é—´ï¼šç”¨æˆ·æ‰“çƒæ—¶é—´ï¼ˆå°æ—¶çº§ï¼‰
âœ… éœ€è¦è¡¥å¿ï¼šæ”¯ä»˜å¤±è´¥éœ€è¦æ¢å¤ä¼šè¯æˆ–æ ‡è®°æ¬ è´¹
```

**å®ç°ç¤ºä¾‹**:
```csharp
public sealed class TableSessionSaga : Saga
{
    public Guid SessionId { get; set; }
    public Guid TableId { get; set; }
    public SessionStatus Status { get; set; }
    
    public void Start(SessionStarted @event)
    {
        SessionId = @event.SessionId;
        Status = SessionStatus.Active;
    }

    public void End(SessionEnded @event)
    {
        Status = SessionStatus.PendingPayment;
    }

    public void Complete(PaymentCompleted @event)
    {
        if (@event.SessionId != SessionId) return;
        Status = SessionStatus.Completed;
        MarkCompleted();  // ç»“æŸ Saga
    }
    
    // è¡¥å¿é€»è¾‘
    public void HandleTimeout(PaymentTimeout @event)
    {
        Status = SessionStatus.PaymentFailed;
        // è§¦å‘è¡¥å¿ï¼šæ¢å¤ä¼šè¯æˆ–æ ‡è®°æ¬ è´¹
    }
}
```

### âŒ ä¸é€‚åˆ Saga çš„åœºæ™¯

**åœºæ™¯ 1ï¼šç”¨æˆ·æ³¨å†Œåå‘é€æ¬¢è¿é‚®ä»¶**
```
âŒ ä¸è·¨æ—¶é—´ï¼šå³æ—¶æ“ä½œ
âŒ æ— éœ€è¡¥å¿ï¼šé‚®ä»¶å‘é€å¤±è´¥ä¸å½±å“æ³¨å†Œ
â†’ è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨äº‹ä»¶ï¼ˆPublishAsyncï¼‰

// âœ… æ­£ç¡®åšæ³•
public class RegisterMemberHandler
{
    public async Task<MemberRegistered> Handle(RegisterMember cmd)
    {
        // æ³¨å†Œä¼šå‘˜
        // è¿”å›äº‹ä»¶ï¼ŒWolverine è‡ªåŠ¨å‘å¸ƒ
        return new MemberRegistered(member.Id);
    }
}

public class MemberRegisteredHandler
{
    public async Task Handle(MemberRegistered evt, IEmailService email)
    {
        // ç›‘å¬äº‹ä»¶ï¼Œå‘é€é‚®ä»¶
        await email.SendWelcomeAsync(evt.MemberId);
    }
}
```

**åœºæ™¯ 2ï¼šåˆ›å»ºè®¢å•å¹¶åˆå§‹åŒ–åº“å­˜**
```
âŒ ä¸è·¨æ—¶é—´ï¼šåŒæ­¥å®Œæˆ
âŒ æ— éœ€è¡¥å¿ï¼šäº‹åŠ¡å†…åŸå­æ“ä½œ
â†’ è§£å†³æ–¹æ¡ˆï¼šåœ¨ Handler å†…ç›´æ¥è°ƒç”¨ï¼ˆInvokeAsyncï¼‰

// âœ… æ­£ç¡®åšæ³•
public class CreateOrderHandler
{
    public async Task<Guid> Handle(
        CreateOrder cmd,
        IMessageBus bus,
        IDocumentSession session)
    {
        var order = new Order { /* ... */ };
        session.Store(order);
        
        // åŒæ­¥è°ƒç”¨å…¶ä»–æ¨¡å—
        await bus.InvokeAsync(new ReserveInventory(order.Id));
        
        return order.Id;
    }
}
```

**åœºæ™¯ 3ï¼šæŸ¥è¯¢èšåˆæ•°æ®**
```
âŒ æ— çŠ¶æ€ï¼šçº¯æŸ¥è¯¢æ“ä½œ
â†’ è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨æŠ•å½±/è§†å›¾

// âœ… æ­£ç¡®åšæ³•ï¼šåˆ›å»ºæŸ¥è¯¢è§†å›¾
public class SessionSummaryView
{
    public Guid SessionId { get; set; }
    public string TableName { get; set; }
    public string MemberName { get; set; }
    // èšåˆå¤šä¸ªæ¨¡å—çš„æ•°æ®
}
```

## åæœ

### æ­£é¢å½±å“

1. **é˜²æ­¢ Saga æ»¥ç”¨**ï¼š
   - ä¸¥æ ¼æ ‡å‡†é¿å…è¿‡åº¦è®¾è®¡
   - åªåœ¨çœŸæ­£éœ€è¦æ—¶ä½¿ç”¨ Saga

2. **é™ä½ç³»ç»Ÿå¤æ‚åº¦**ï¼š
   - å‡å°‘ Saga çŠ¶æ€ç®¡ç†è´Ÿæ‹…
   - ç®€å•æµç¨‹ç”¨ç®€å•æ–¹æ¡ˆ

3. **æé«˜å¯ç»´æŠ¤æ€§**ï¼š
   - Saga æ•°é‡å¯æ§
   - æ¯ä¸ª Saga éƒ½æœ‰æ˜ç¡®çš„ä¸šåŠ¡ä»·å€¼

### è´Ÿé¢å½±å“

1. **åˆ¤æ–­æˆæœ¬**ï¼š
   - å¼€å‘è€…éœ€è¦é€æ¡è¯„ä¼° 3 æ¡é“å¾‹
   - å¯èƒ½éœ€è¦é‡æ–°è®¾è®¡æµç¨‹

2. **æ½œåœ¨äº‰è®®**ï¼š
   - "è·¨æ—¶é—´ > 1 åˆ†é’Ÿ"æ ‡å‡†å¯èƒ½æœ‰äº‰è®®
   - éœ€è¦å›¢é˜Ÿè¾¾æˆå…±è¯†

### é£é™©ç¼“è§£

1. **æä¾›å†³ç­–æ ‘**ï¼š
   - æ¸…æ™°çš„æµç¨‹å›¾è¾…åŠ©åˆ¤æ–­
   - åœ¨æ–‡æ¡£ä¸­æä¾›å¤§é‡ç¤ºä¾‹

2. **Code Review å¼ºåŒ–**ï¼š
   - æ–°å¢ Saga å¿…é¡»åœ¨ PR ä¸­è¯´æ˜æ»¡è¶³ 3 æ¡é“å¾‹
   - ä¸æ»¡è¶³æ—¶å»ºè®®æ›¿ä»£æ–¹æ¡ˆ

3. **å®šæœŸå®¡æŸ¥**ï¼š
   - å­£åº¦å®¡æŸ¥ç°æœ‰ Saga
   - è¯†åˆ«å¯ç®€åŒ–ä¸º Handler æˆ–äº‹ä»¶çš„ Saga

## æ›¿ä»£æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: æ— é™åˆ¶ä½¿ç”¨ Saga

**æè¿°**: ä¸è®¾ä½¿ç”¨é™åˆ¶ï¼Œå›¢é˜Ÿè‡ªè¡Œåˆ¤æ–­

**ä¼˜ç‚¹**: çµæ´»ï¼Œå¼€å‘è€…è‡ªç”±åº¦é«˜

**ç¼ºç‚¹**:
- Saga æ³›æ»¥ï¼Œç³»ç»Ÿå¤æ‚åº¦çˆ†ç‚¸
- çŠ¶æ€æœºåœ°ç‹±ï¼Œéš¾ä»¥è°ƒè¯•å’Œç»´æŠ¤
- è¿‡åº¦è®¾è®¡ï¼Œç®€å•é—®é¢˜å¤æ‚åŒ–

**ä¸ºä»€ä¹ˆæœªé‡‡çº³**: Saga æ˜¯é‡æ­¦å™¨ï¼Œå¿…é¡»ä¸¥æ ¼æ§åˆ¶ä½¿ç”¨åœºæ™¯ã€‚

### æ–¹æ¡ˆ B: å®Œå…¨ç¦æ­¢ Saga

**æè¿°**: ä¸å…è®¸ä½¿ç”¨ Sagaï¼Œåªç”¨äº‹ä»¶é©±åŠ¨

**ä¼˜ç‚¹**: ç³»ç»Ÿç®€å•ï¼Œæ— çŠ¶æ€æœº

**ç¼ºç‚¹**:
- æ— æ³•ä¼˜é›…å¤„ç†é•¿äº‹åŠ¡å’Œè¡¥å¿
- è·¨æ¨¡å—æµç¨‹ç¼–æ’å›°éš¾
- é‡è¦ä¸šåŠ¡åœºæ™¯ï¼ˆå¦‚æ”¯ä»˜æµç¨‹ï¼‰ç¼ºä¹ä¿éšœ

**ä¸ºä»€ä¹ˆæœªé‡‡çº³**: çŸ«æ‰è¿‡æ­£ï¼ŒSaga åœ¨ç‰¹å®šåœºæ™¯æœ‰ä¸å¯æ›¿ä»£çš„ä»·å€¼ã€‚

### æ–¹æ¡ˆ C: å®½æ¾æ ‡å‡†ï¼ˆ2 æ¡é“å¾‹ï¼‰

**æè¿°**: é™ä½æ ‡å‡†ï¼Œåªéœ€æ»¡è¶³"è·¨æ¨¡å— + è·¨æ—¶é—´"

**ä¼˜ç‚¹**: æ›´å®¹æ˜“åˆ¤æ–­ï¼Œé™ä½å†³ç­–æˆæœ¬

**ç¼ºç‚¹**:
- å»æ‰"éœ€è¦è¡¥å¿"ä¼šå¯¼è‡´ä¸éœ€è¦ Saga çš„åœºæ™¯ä¹Ÿç”¨ Saga
- æ— æ³•åŒºåˆ† Saga ä¸äº‹ä»¶é©±åŠ¨çš„è¾¹ç•Œ

**ä¸ºä»€ä¹ˆæœªé‡‡çº³**: 3 æ¡é“å¾‹ç¼ºä¸€ä¸å¯ï¼Œéƒ½æ˜¯å¿…è¦æ¡ä»¶ã€‚

## æ£€æŸ¥æ¸…å•

åˆ›å»º Saga å‰ï¼Œå¿…é¡»å›ç­”ä»¥ä¸‹é—®é¢˜ï¼š

- [ ] æ˜¯å¦æ¶‰åŠ 2 ä¸ªä»¥ä¸Šæ¨¡å—ï¼Ÿ
- [ ] æµç¨‹æ˜¯å¦æŒç»­ > 1 åˆ†é’Ÿï¼Ÿï¼ˆç­‰å¾…ç”¨æˆ·æ“ä½œã€å¤–éƒ¨ç³»ç»Ÿå“åº”ï¼‰
- [ ] å¤±è´¥æ—¶æ˜¯å¦éœ€è¦è¡¥å¿é€»è¾‘ï¼Ÿï¼ˆä¸æ˜¯ç®€å•çš„äº‹åŠ¡å›æ»šï¼‰
- [ ] æ˜¯å¦è€ƒè™‘è¿‡ç”¨ Handler + InvokeAsyncï¼Ÿ
- [ ] æ˜¯å¦è€ƒè™‘è¿‡ç”¨äº‹ä»¶é©±åŠ¨ï¼Ÿ
- [ ] Saga çš„ç”Ÿå‘½å‘¨æœŸå’Œç»“æŸæ¡ä»¶æ˜¯å¦æ˜ç¡®ï¼Ÿ

## ç›¸å…³å†³ç­–

- [ADR-003: æ¨¡å—é—´æ¶ˆæ¯é€šä¿¡](./ADR-003-æ¨¡å—é—´æ¶ˆæ¯é€šä¿¡.md)
- [ADR-006: InvokeAsync ä½¿ç”¨é™åˆ¶](./ADR-006-InvokeAsyncä½¿ç”¨é™åˆ¶.md)
- [ADR-008: çº§è”æ¶ˆæ¯ä¼˜å…ˆç­–ç•¥](./ADR-008-çº§è”æ¶ˆæ¯ä¼˜å…ˆç­–ç•¥.md)

## å‚è€ƒèµ„æ–™

- [Wolverine Saga Documentation](https://wolverine.netlify.app/guide/durability/sagas.html)
- [Saga Pattern - Microservices.io](https://microservices.io/patterns/data/saga.html)
- ã€ŠWolverine æ¨¡å—åŒ–æ¶æ„è“å›¾ã€‹- äº”ã€Sagaï¼ˆè·¨æ­¥éª¤ä¸šåŠ¡æµç¨‹ï¼‰
- ã€ŠSaga ä½¿ç”¨æŒ‡å—ã€‹- docs/06_å¼€å‘è§„èŒƒ/Sagaä½¿ç”¨æŒ‡å—.md

---

**æ—¥æœŸ**: 2026-01-19  
**å†³ç­–è€…**: æ¶æ„å›¢é˜Ÿ  
**æœ€åæ›´æ–°**: 2026-01-19
