# 系统模块划分

## 1. 概述

基于垂直切片架构和业务能力，本系统划分为 6 个核心模块。每个模块代表一个独立的业务能力（Bounded Context），模块间通过消息（Command/Event）通信，保持低耦合。

**设计原则**:
- 模块按业务能力划分，而非技术层次
- 每个模块有清晰的职责边界
- 模块内高内聚，模块间低耦合
- 通过消息总线实现跨模块通信

---

## 2. 模块总览

```
src/Modules/
├── Tables/         # 台球桌管理
├── Sessions/       # 打球时段
├── Billing/        # 计费管理
├── Payments/       # 支付对账
├── Members/        # 会员体系
└── Devices/        # 硬件集成
```

---

## 3. Tables 模块（台球桌管理）

### 3.1 职责

管理台球桌的生命周期，包括桌台基础信息、状态管理和预订。

### 3.2 核心功能切片

| 功能切片 | 类型 | 说明 |
|---------|------|------|
| `CreateTable` | Command | 创建台球桌 |
| `UpdateTable` | Command | 更新台球桌信息（名称、类型、费率） |
| `DeleteTable` | Command | 删除台球桌 |
| `ReserveTable` | Command | 预订台球桌 |
| `ReleaseTable` | Command | 释放台球桌 |
| `GetTable` | Query | 获取单个台球桌信息 |
| `ListTables` | Query | 查询台球桌列表（支持过滤） |
| `GetAvailableTables` | Query | 获取可用台球桌 |

### 3.3 领域模型

```csharp
public class Table
{
    public Guid Id { get; set; }
    public string Name { get; set; }          // 桌台名称（如"1号桌"）
    public TableType Type { get; set; }       // 类型（中式/美式/斯诺克）
    public TableStatus Status { get; set; }   // 状态（可用/占用/维护）
    public decimal HourlyRate { get; set; }   // 小时费率
    public Guid? CurrentSessionId { get; set; } // 当前会话ID（如果占用）
    public DateTimeOffset CreatedAt { get; set; }
    public DateTimeOffset? UpdatedAt { get; set; }
}

public enum TableType
{
    Chinese,    // 中式
    American,   // 美式
    Snooker     // 斯诺克
}

public enum TableStatus
{
    Available,  // 可用
    Occupied,   // 占用中
    Maintenance // 维护中
}
```

### 3.4 发布的事件

- `TableCreated`: 台球桌已创建
- `TableReserved`: 台球桌已预订
- `TableReleased`: 台球桌已释放
- `TableStatusChanged`: 台球桌状态变更

### 3.5 依赖的外部命令/事件

- 监听 `SessionEnded`（来自 Sessions 模块）→ 自动释放桌台

---

## 4. Sessions 模块（打球时段）

### 4.1 职责

管理用户的打球时段，包括开始、暂停、恢复、结束等生命周期管理。

### 4.2 核心功能切片

| 功能切片 | 类型 | 说明 |
|---------|------|------|
| `StartSession` | Command | 开始打球时段 |
| `EndSession` | Command | 结束打球时段 |
| `PauseSession` | Command | 暂停时段（临时离开） |
| `ResumeSession` | Command | 恢复时段 |
| `ExtendSession` | Command | 延长时段 |
| `GetSession` | Query | 获取时段详情 |
| `GetActiveSessionByTable` | Query | 根据桌台查询活跃时段 |
| `GetSessionHistory` | Query | 获取会员历史时段 |

### 4.3 领域模型

```csharp
public class TableSession
{
    public Guid Id { get; set; }
    public Guid TableId { get; set; }
    public Guid? MemberId { get; set; }         // 会员ID（散客为null）
    public SessionStatus Status { get; set; }
    public DateTimeOffset StartTime { get; set; }
    public DateTimeOffset? EndTime { get; set; }
    public List<PauseRecord> PauseRecords { get; set; } // 暂停记录
    public TimeSpan CalculatedDuration { get; set; }    // 计费时长
    public DateTimeOffset CreatedAt { get; set; }
}

public class PauseRecord
{
    public DateTimeOffset PausedAt { get; set; }
    public DateTimeOffset? ResumedAt { get; set; }
}

public enum SessionStatus
{
    Active,         // 进行中
    Paused,         // 暂停中
    Ended,          // 已结束（等待支付）
    Completed       // 已完成（已支付）
}
```

### 4.4 发布的事件

- `SessionStarted`: 时段已开始
- `SessionEnded`: 时段已结束
- `SessionPaused`: 时段已暂停
- `SessionResumed`: 时段已恢复

### 4.5 Saga

**TableSessionSaga**: 管理时段完整生命周期（开始 → 暂停 → 恢复 → 结束 → 支付完成）

### 4.6 依赖的外部命令/事件

- 发送 `ReleaseTable` 命令（到 Tables 模块）→ 时段结束后释放桌台
- 监听 `PaymentCompleted`（来自 Payments 模块）→ 标记时段为已完成

---

## 5. Billing 模块（计费管理）

### 5.1 职责

负责计费规则、价格计算、账单生成和优惠券管理。

### 5.2 核心功能切片

| 功能切片 | 类型 | 说明 |
|---------|------|------|
| `CalculateBill` | Command | 计算账单 |
| `ApplyDiscount` | Command | 应用折扣/优惠券 |
| `GenerateInvoice` | Command | 生成发票 |
| `GetBill` | Query | 获取账单详情 |
| `GetPricingRules` | Query | 获取当前计费规则 |
| `UpdatePricingRule` | Command | 更新计费规则 |

### 5.3 领域模型

```csharp
public class Bill
{
    public Guid Id { get; set; }
    public Guid SessionId { get; set; }
    public Guid TableId { get; set; }
    public TimeSpan Duration { get; set; }      // 计费时长
    public decimal HourlyRate { get; set; }     // 适用费率
    public decimal BaseAmount { get; set; }     // 基础金额
    public decimal DiscountAmount { get; set; } // 优惠金额
    public decimal TotalAmount { get; set; }    // 应付金额
    public List<BillItem> Items { get; set; }   // 明细
    public DateTimeOffset CreatedAt { get; set; }
}

public class BillItem
{
    public string Description { get; set; }  // 明细说明
    public decimal Amount { get; set; }      // 金额
    public BillItemType Type { get; set; }   // 类型
}

public enum BillItemType
{
    TableFee,       // 桌台费
    Discount,       // 折扣
    Coupon,         // 优惠券
    MemberDiscount  // 会员折扣
}

public class PricingRule
{
    public Guid Id { get; set; }
    public TableType TableType { get; set; }
    public decimal HourlyRate { get; set; }
    public TimeSpan? PeakTimeStart { get; set; }  // 高峰时段开始
    public TimeSpan? PeakTimeEnd { get; set; }    // 高峰时段结束
    public decimal PeakTimeMultiplier { get; set; } // 高峰倍率
}
```

### 5.4 发布的事件

- `BillCalculated`: 账单已计算
- `InvoiceGenerated`: 发票已生成

### 5.5 依赖的外部命令/事件

- 监听 `SessionEnded`（来自 Sessions 模块）→ 自动计算账单

---

## 6. Payments 模块（支付对账）

### 6.1 职责

管理支付流程、支付对账、退款和支付历史记录。

### 6.2 核心功能切片

| 功能切片 | 类型 | 说明 |
|---------|------|------|
| `ProcessPayment` | Command | 处理支付 |
| `RefundPayment` | Command | 退款 |
| `ReconcilePayments` | Command | 对账 |
| `GetPayment` | Query | 获取支付详情 |
| `GetPaymentHistory` | Query | 获取支付历史 |
| `GetDailyRevenue` | Query | 获取日营收报表 |

### 6.3 领域模型

```csharp
public class Payment
{
    public Guid Id { get; set; }
    public Guid BillId { get; set; }
    public Guid SessionId { get; set; }
    public Guid? MemberId { get; set; }
    public decimal Amount { get; set; }
    public PaymentMethod Method { get; set; }
    public PaymentStatus Status { get; set; }
    public string? TransactionId { get; set; }  // 第三方交易号
    public DateTimeOffset CreatedAt { get; set; }
    public DateTimeOffset? CompletedAt { get; set; }
}

public enum PaymentMethod
{
    Cash,           // 现金
    Alipay,         // 支付宝
    WeChatPay,      // 微信支付
    MemberBalance,  // 会员余额
    BankCard        // 银行卡
}

public enum PaymentStatus
{
    Pending,    // 待支付
    Processing, // 处理中
    Completed,  // 已完成
    Failed,     // 失败
    Refunded    // 已退款
}
```

### 6.4 发布的事件

- `PaymentCompleted`: 支付完成
- `PaymentFailed`: 支付失败
- `PaymentRefunded`: 已退款

### 6.5 依赖的外部命令/事件

- 监听 `BillCalculated`（来自 Billing 模块）→ 创建待支付记录
- 发送命令到 Members 模块 → 扣减会员余额（如果使用余额支付）

---

## 7. Members 模块（会员体系）

### 7.1 职责

管理会员信息、会员等级、余额、积分和会员卡。

### 7.2 核心功能切片

| 功能切片 | 类型 | 说明 |
|---------|------|------|
| `RegisterMember` | Command | 注册会员 |
| `UpdateMemberProfile` | Command | 更新会员资料 |
| `TopUpBalance` | Command | 充值余额 |
| `DeductBalance` | Command | 扣减余额（内部） |
| `AwardPoints` | Command | 赠送积分 |
| `UpgradeMemberTier` | Command | 升级会员等级 |
| `GetMember` | Query | 获取会员信息 |
| `GetMemberBalance` | Query | 查询会员余额 |
| `GetMemberHistory` | Query | 获取消费历史 |

### 7.3 领域模型

```csharp
public class Member
{
    public Guid Id { get; set; }
    public string Name { get; set; }
    public string Phone { get; set; }
    public string? Email { get; set; }
    public MemberTier Tier { get; set; }
    public decimal Balance { get; set; }        // 余额
    public int Points { get; set; }             // 积分
    public DateTimeOffset RegisteredAt { get; set; }
    public DateTimeOffset? LastActiveAt { get; set; }
}

public enum MemberTier
{
    Regular,    // 普通会员
    Silver,     // 银卡
    Gold,       // 金卡
    Platinum    // 白金卡
}
```

### 7.4 发布的事件

- `MemberRegistered`: 会员已注册
- `BalanceToppedUp`: 余额已充值
- `BalanceDeducted`: 余额已扣减
- `MemberTierUpgraded`: 会员等级已升级

### 7.5 依赖的外部命令/事件

- 监听 `PaymentCompleted`（来自 Payments 模块）→ 计算积分

---

## 8. Devices 模块（硬件集成）

### 8.1 职责

管理门禁、灯控等硬件设备的控制和状态监控。

### 8.2 核心功能切片

| 功能切片 | 类型 | 说明 |
|---------|------|------|
| `ControlDoorLock` | Command | 控制门禁 |
| `ControlLighting` | Command | 控制灯光 |
| `GetDeviceStatus` | Query | 获取设备状态 |
| `RegisterDevice` | Command | 注册设备 |
| `GetDeviceHistory` | Query | 获取设备操作历史 |

### 8.3 领域模型

```csharp
public class Device
{
    public Guid Id { get; set; }
    public string Name { get; set; }
    public DeviceType Type { get; set; }
    public Guid? AssociatedTableId { get; set; }  // 关联桌台
    public DeviceStatus Status { get; set; }
    public string? IpAddress { get; set; }
    public DateTimeOffset LastCommunicatedAt { get; set; }
}

public enum DeviceType
{
    DoorLock,   // 门禁
    Light,      // 灯光
    Camera      // 摄像头
}

public enum DeviceStatus
{
    Online,     // 在线
    Offline,    // 离线
    Error       // 故障
}
```

### 8.4 发布的事件

- `DeviceStatusChanged`: 设备状态变更
- `DoorLockControlled`: 门禁已操作
- `LightingControlled`: 灯光已操作

### 8.5 依赖的外部命令/事件

- 监听 `SessionStarted`（来自 Sessions 模块）→ 自动开灯/开门
- 监听 `SessionEnded`（来自 Sessions 模块）→ 自动关灯

---

## 9. 模块间通信矩阵

| 源模块 | 目标模块 | 通信方式 | 触发场景 |
|--------|---------|---------|----------|
| Sessions | Tables | Command | 时段结束 → 释放桌台 |
| Sessions | Billing | Event | 时段结束 → 触发计费 |
| Sessions | Devices | Event | 时段开始/结束 → 控制硬件 |
| Billing | Payments | Event | 账单生成 → 创建支付单 |
| Payments | Members | Command | 余额支付 → 扣减余额 |
| Payments | Sessions | Event | 支付完成 → 标记时段完成 |
| Members | - | - | 独立模块，不主动发送命令 |
| Tables | - | - | 被动接收命令，不主动通信 |

---

## 10. 模块边界约束

### 10.1 强约束

✅ **必须遵守**:
1. 模块间**禁止直接引用**其他模块的实体类
2. 模块间**禁止直接调用**其他模块的 Handler
3. 跨模块操作**必须通过消息总线**（Command/Event）
4. 共享的基础类型（Result、Clock）放在 BuildingBlocks

### 10.2 数据访问约束

✅ **允许**:
- 每个模块访问自己的实体
- 通过 ID 引用其他模块的实体

❌ **禁止**:
- 跨模块的数据库 Join 查询
- 直接访问其他模块的数据表

### 10.3 示例：正确与错误的跨模块访问

❌ **错误示例**:
```csharp
// Sessions 模块中直接访问 Tables 模块实体
public class EndSessionHandler
{
    public async Task Handle(EndSession cmd, IDocumentSession session)
    {
        var tableSession = await session.LoadAsync<TableSession>(cmd.SessionId);
        
        // ❌ 错误：直接查询 Tables 模块的实体
        var table = await session.LoadAsync<Table>(tableSession.TableId);
        table.Status = TableStatus.Available;
    }
}
```

✅ **正确示例**:
```csharp
// Sessions 模块中通过消息通信
public class EndSessionHandler
{
    public async Task Handle(
        EndSession cmd,
        IDocumentSession session,
        IMessageBus bus)
    {
        var tableSession = await session.LoadAsync<TableSession>(cmd.SessionId);
        tableSession.End();
        
        session.Store(tableSession);
        await session.SaveChangesAsync();
        
        // ✅ 正确：通过消息总线发送命令
        await bus.InvokeAsync(new ReleaseTable(tableSession.TableId));
    }
}
```

---

## 11. 参考

- [Wolverine模块化架构蓝图](./Wolverine模块化架构蓝图.md) - 详细实现指南
- [垂直切片架构说明](./垂直切片架构说明.md) - 架构理念
- [Wolverine框架介绍](./Wolverine框架介绍.md) - 技术框架

---

**最后更新**: 2024-01-15  
**负责人**: 架构团队  
**审核状态**: ✅ 已审核
