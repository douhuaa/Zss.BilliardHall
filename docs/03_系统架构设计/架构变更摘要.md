# 垂直切片架构文档更新摘要

## 更新时间
2024-01-15

## 架构转型
从 **ABP 分层架构** 迁移到 **垂直切片架构 (Vertical Slice Architecture)**

## 技术栈变更

### 之前（ABP 技术栈）
- **框架**: ABP Framework
- **数据访问**: Entity Framework Core
- **架构模式**: 分层架构（Domain/Application/HttpApi/Infrastructure）
- **数据库**: MySQL 或 PostgreSQL

### 现在（Wolverine + Marten 技术栈）
- **框架**: Wolverine 3.x（消息处理）
- **数据访问**: Marten 7.x（文档数据库）
- **架构模式**: 垂直切片架构（功能切片）
- **数据库**: PostgreSQL 16+（JSONB）

## 新增文档

### 1. 核心架构文档
- **垂直切片架构说明.md** (`doc/03_系统架构设计/`)
  - 垂直切片架构核心理念
  - 与传统分层架构对比
  - 实际应用示例
  - 迁移指南
  
- **Wolverine框架介绍.md** (`doc/03_系统架构设计/`)
  - Wolverine 核心特性
  - 命令/查询处理
  - 消息总线使用
  - HTTP 集成
  - 后台任务
  - 持久化收件箱/发件箱
  
- **Marten数据访问.md** (`doc/03_系统架构设计/`)
  - Marten 文档存储
  - 强类型查询
  - 事件溯源
  - 性能优化
  - 与 EF Core 对比

### 2. 开发流程文档
- **数据访问最佳实践.md** (`doc/05_数据库设计/`)
  - Marten vs EF Core 选择指南
  - Marten 实体定义、配置、CRUD、查询
  - EF Core 实体建模、迁移管理、查询优化
  - 事务处理和迁移管理
  - 通用最佳实践

### 3. 开发规范文档
- **切片约束.md** (`doc/06_开发规范/`)
  - 切片独立性约束
  - 切片间通信规则
  - 命名约定
  - 文件组织
  - 共享代码原则
  - 违规示例与修正

## 更新的文档

### 1. 系统架构设计
- **技术选型.md** - 完全重写
  - 更新技术栈选择理由
  - Wolverine vs MediatR 对比
  - Marten vs EF Core 对比
  - 技术决策记录
  
- **设计原则.md** - 完全重写
  - 垂直切片架构原则
  - CQRS 原则
  - DDD Light 原则
  - 消息驱动架构
  - 可测试性和可观测性

### 2. 模块设计
- **README.md** - 重大更新
  - 更新架构关系图（垂直切片）
  - 更新业务流程图
  - 添加功能切片示例代码
  - 更新技术栈说明
  - 更新开发规范

### 3. 项目概述
- **README.md** - 部分更新
  - 更新技术特色描述
  - 强调垂直切片架构
  
- **约束与假设条件.md** - 部分更新
  - 更新技术栈约束
  - PostgreSQL 要求

### 4. 主文档
- **自助台球系统项目文档.md** - 关键词更新
  - 移除 ABP、EF Core 关键词
  - 添加 Wolverine、Marten、垂直切片架构关键词

## 文档结构

```
doc/
├── 01_项目概述/
│   ├── README.md ✏️ (已更新)
│   └── 约束与假设条件.md ✏️ (已更新)
├── 03_系统架构设计/
│   ├── 技术选型.md ✏️ (已更新)
│   ├── 设计原则.md ✏️ (已更新)
│   ├── 垂直切片架构说明.md ✨ (新增)
│   ├── Wolverine框架介绍.md ✨ (新增)
│   └── Marten数据访问.md ✨ (新增)
├── 04_模块设计/
│   └── README.md ✏️ (已更新)
├── 05_数据库设计/
│   └── 数据访问最佳实践.md ✨ (新增)
├── 06_开发规范/
│   └── 切片约束.md ✨ (新增)
└── 自助台球系统项目文档.md ✏️ (已更新)
```

## 主要变更点

### 代码组织
**之前（分层）**:
```
src/
  Domain/
  Application/
  HttpApi/
  EntityFrameworkCore/
```

**现在（切片）**:
```
src/
  Features/
    Members/
      CreateMember/
      UpdateMember/
    TableSessions/
      StartSession/
      EndSession/
  Domain/  (共享领域模型)
  Infrastructure/
```

### 数据访问
**之前（EF Core + 仓储）**:
```csharp
public interface IMemberRepository
{
    Task<Member> GetByIdAsync(Guid id);
}

public class MemberAppService
{
    private readonly IMemberRepository _repository;
}
```

**现在（Marten 直接注入）**:
```csharp
public class GetMemberByIdHandler
{
    public async Task<Member?> Handle(
        GetMemberByIdQuery query,
        IDocumentSession session)
    {
        return await session.LoadAsync<Member>(query.Id);
    }
}
```

### 消息处理
**之前（MediatR）**:
```csharp
public class CreateMemberCommand : IRequest<Guid> { }

public class CreateMemberHandler : IRequestHandler<CreateMemberCommand, Guid>
{
    public CreateMemberHandler(IRepository<Member> repository)
    {
        // 构造函数注入
    }
    
    public async Task<Guid> Handle(CreateMemberCommand request, CancellationToken ct)
    {
        // ...
    }
}
```

**现在（Wolverine）**:
```csharp
public record CreateMemberCommand(string Name, string Phone);

public class CreateMemberHandler
{
    // Wolverine 自动注入方法参数
    public async Task<Guid> Handle(
        CreateMemberCommand command,
        IDocumentSession session,
        CancellationToken ct)
    {
        // ...
    }
}
```

## 核心概念

### 1. 垂直切片架构
- 按功能组织代码，而非技术层次
- 每个切片独立、自包含
- 减少跨层依赖和耦合

### 2. Wolverine
- 约定优于配置
- 命令/查询/事件处理
- 持久化消息队列
- 自动事务管理

### 3. Marten
- PostgreSQL 文档数据库
- JSONB 灵活存储
- LINQ 强类型查询
- 事件溯源支持

### 4. 设计原则
- 功能内聚
- 独立演化
- 接受适度重复
- CQRS 分离
- 异步优先

## 迁移指南参考

详细的迁移指南请参阅：
- [垂直切片架构说明](doc/03_系统架构设计/垂直切片架构说明.md) - 第 6 节
- [技术选型](doc/03_系统架构设计/技术选型.md) - 技术决策记录

## 后续待完成

以下文档需要在后续进一步更新：
- [ ] API 文档 - 更新 OpenIddict 认证说明
- [ ] 测试方案 - 更新 Wolverine 测试示例
- [ ] 部署文档 - 更新 PostgreSQL 部署配置
- [ ] 具体模块设计文档 - 添加切片示例

## 贡献者
- 架构团队
- 文档维护小组

## 反馈
如有问题或建议，请联系架构团队。

---

**版本**: 1.0.0  
**更新日期**: 2024-01-15  
**状态**: 完成初版
