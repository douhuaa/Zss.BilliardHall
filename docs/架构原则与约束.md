# Zss.BilliardHall æ¶æ„åŸåˆ™ä¸çº¦æŸ

> **æ–‡æ¡£æ€§è´¨**ï¼šé•¿æœŸç¨³å®šï¼Œå‡ ä¹ä¸æ”¹  
> **æœ€åæ›´æ–°**ï¼š2026-01-18

---

## ä¸€ã€æ ¸å¿ƒæ¶æ„å†³ç­–

### 1.1 æ¶æ„é£æ ¼

æœ¬ç³»ç»Ÿé‡‡ç”¨ **æ¨¡å—åŒ–å•ä½“æ¶æ„ï¼ˆModular Monolithï¼‰**ï¼Œç»“åˆä»¥ä¸‹æ¨¡å¼ï¼š

- **å‚ç›´åˆ‡ç‰‡æ¶æ„ï¼ˆVertical Slice Architectureï¼‰**ï¼šæ¯ä¸ªåŠŸèƒ½ä» API åˆ°æ•°æ®åº“å®Œæ•´å®ç°
- **æ¶ˆæ¯é©±åŠ¨ï¼ˆMessage-Drivenï¼‰**ï¼šæ¨¡å—é—´é€šè¿‡å¼‚æ­¥æ¶ˆæ¯é€šä¿¡ï¼Œé¿å…ç›´æ¥ä¾èµ–
- **é¢†åŸŸé©±åŠ¨è®¾è®¡ï¼ˆDDDï¼‰è½»é‡åº”ç”¨**ï¼šèšç„¦é¢†åŸŸæ¨¡å‹ï¼Œæ‹’ç»è¿‡åº¦è®¾è®¡

### 1.2 ä¸ºä»€ä¹ˆé€‰æ‹©è¿™ä¸ªæ¶æ„ï¼Ÿ

#### âœ… ç›¸æ¯”å¾®æœåŠ¡çš„ä¼˜åŠ¿
- **å¼€å‘æ•ˆç‡é«˜**ï¼šå•ä¸€éƒ¨ç½²å•å…ƒï¼Œè°ƒè¯•å®¹æ˜“
- **è¿ç»´æˆæœ¬ä½**ï¼šæ— éœ€ç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿå¤æ‚æ€§
- **é‡æ„æˆæœ¬ä½**ï¼šæ¨¡å—è¾¹ç•Œæ˜ç¡®ï¼Œå¯éšæ—¶æ‹†åˆ†

#### âœ… ç›¸æ¯”ä¼ ç»Ÿåˆ†å±‚æ¶æ„çš„ä¼˜åŠ¿
- **ä»£ç ç»„ç»‡æ›´æ¸…æ™°**ï¼šæŒ‰åŠŸèƒ½è€ŒéæŠ€æœ¯å±‚ç»„ç»‡
- **é¿å…è´«è¡€æ¨¡å‹**ï¼šä¸šåŠ¡é€»è¾‘èšåˆåœ¨ä¸€èµ·
- **æ˜“äºæ¼”è¿›**ï¼šå‚ç›´åˆ‡ç‰‡å¯ç‹¬ç«‹ä¿®æ”¹

---

## äºŒã€æ¨¡å—éš”ç¦»åŸåˆ™ï¼ˆç¡¬æ€§çº¦æŸï¼‰

### ğŸ”´ é“å¾‹ 1ï¼šç¦æ­¢è·¨æ¨¡å—ç›´æ¥å¼•ç”¨ä¸šåŠ¡ç±»å‹

**ç¦æ­¢ï¼š**
```csharp
// âŒ Orders æ¨¡å—ç›´æ¥å¼•ç”¨ Members çš„å®ä½“
using Zss.BilliardHall.Modules.Members.Features.Registration;
var member = new Member(); // ç»å¯¹ç¦æ­¢
```

**å…è®¸ï¼š**
```csharp
// âœ… é€šè¿‡äº‹ä»¶é€šä¿¡
public record PaymentCompleted(Guid MemberId, decimal Amount);

// âœ… é€šè¿‡ Contractsï¼ˆåªåŒ…å«åŸå§‹ç±»å‹ï¼‰
public interface IMemberQueries
{
    Task<MemberDto> GetByIdAsync(Guid id);
}

public record MemberDto(Guid Id, string Name); // åªæœ‰åŸå§‹ç±»å‹
```

---

### ğŸ”´ é“å¾‹ 2ï¼šæ¨¡å—é—´åªèƒ½é€šè¿‡ä»¥ä¸‹æ–¹å¼é€šä¿¡

#### æ–¹å¼ 1ï¼šå¼‚æ­¥äº‹ä»¶ï¼ˆæ¨èï¼‰
```csharp
// Orders å‘å¸ƒäº‹ä»¶
public record PaymentCompleted(Guid MemberId, decimal Amount);

// Members è®¢é˜…äº‹ä»¶ï¼ˆWolverine è‡ªåŠ¨è·¯ç”±ï¼‰
public static class PaymentCompletedHandler
{
    public static AddPoints Handle(PaymentCompleted evt)
    {
        return new AddPoints(evt.MemberId, (int)evt.Amount, "æ¶ˆè´¹ç§¯åˆ†");
    }
}
```

#### æ–¹å¼ 2ï¼šContracts æ¥å£ï¼ˆæŸ¥è¯¢åœºæ™¯ï¼‰
```csharp
// Members æ¨¡å—æä¾›
public interface IMemberQueries
{
    Task<MemberDto> GetByIdAsync(Guid id);
}

// Orders æ¨¡å—ä½¿ç”¨
public class StartSessionHandler
{
    private readonly IMemberQueries _memberQueries;
    
    public async Task Handle(StartSession cmd)
    {
        var member = await _memberQueries.GetByIdAsync(cmd.MemberId);
        // ...
    }
}
```

---

### ğŸ”´ é“å¾‹ 3ï¼šæ¨¡å—å†…ç¦æ­¢ä¼ ç»Ÿåˆ†å±‚å‘½å

**ç¦æ­¢å‡ºç°ï¼š**
- `Application/` æ–‡ä»¶å¤¹
- `Domain/` æ–‡ä»¶å¤¹
- `Infrastructure/` æ–‡ä»¶å¤¹
- `Repository/` ç±»å
- `Service/` ç±»å
- `Manager/` ç±»å

**æ¨èç»“æ„ï¼š**
```
Modules/Members/
  â”œâ”€â”€ Features/              # æŒ‰åŠŸèƒ½å‚ç›´åˆ‡ç‰‡
  â”‚   â”œâ”€â”€ Registration/      # ä¼šå‘˜æ³¨å†Œ
  â”‚   â”‚   â”œâ”€â”€ RegisterMember.cs        # Command
  â”‚   â”‚   â”œâ”€â”€ RegisterMemberHandler.cs # Handler
  â”‚   â”‚   â””â”€â”€ MemberRegistered.cs      # Event
  â”‚   â””â”€â”€ Cards/
  â”œâ”€â”€ Events/                # å¯¹å¤–å‘å¸ƒçš„äº‹ä»¶
  â””â”€â”€ Contracts/             # å¯¹å¤–å¥‘çº¦
```

---

## ä¸‰ã€Wolverine ä½¿ç”¨çº¦å®š

### 3.1 å‘½ä»¤ï¼ˆCommandï¼‰

```csharp
// å‘½ä»¤ = æ„å›¾è¡¨è¾¾
public record RegisterMember(string Name, string Phone);

// Handler = ä¸šåŠ¡å®ç°ï¼ˆè‡ªåŠ¨å‘ç°ï¼‰
public static class RegisterMemberHandler
{
    public static async Task<MemberRegistered> Handle(
        RegisterMember command, 
        IDocumentSession session)
    {
        var member = new Member(command.Name, command.Phone);
        session.Store(member);
        await session.SaveChangesAsync();
        
        // è¿”å›äº‹ä»¶ï¼ŒWolverine è‡ªåŠ¨å‘å¸ƒ
        return new MemberRegistered(member.Id, member.Name);
    }
}
```

**çº¦å®šï¼š**
- Command ç”¨ `record` å®šä¹‰
- Handler å‘½åï¼š`{Command}Handler`
- Handler æ–¹æ³•ç­¾åï¼š`public static Task<TResult> Handle(...)`
- Wolverine é€šè¿‡åå°„è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œ

---

### 3.2 äº‹ä»¶ï¼ˆEventï¼‰

```csharp
// äº‹ä»¶ = å·²å‘ç”Ÿçš„äº‹å®
public record MemberRegistered(Guid MemberId, string Name);

// äº‹ä»¶è®¢é˜…è€…ï¼ˆè‡ªåŠ¨è·¯ç”±ï¼‰
public static class MemberRegisteredHandler
{
    public static Task Handle(MemberRegistered evt)
    {
        // å¤„ç†é€»è¾‘
        return Task.CompletedTask;
    }
}
```

**çº¦å®šï¼š**
- Event ç”¨ `record` å®šä¹‰
- å‘½åç”¨è¿‡å»å¼ï¼ˆå¦‚ `MemberRegistered` è€Œé `MemberRegister`ï¼‰
- å¯ä»¥æœ‰å¤šä¸ªè®¢é˜…è€…
- å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡å‘å¸ƒè€…

---

### 3.3 æŸ¥è¯¢ï¼ˆQueryï¼‰

```csharp
// æŸ¥è¯¢è¯·æ±‚
public record GetMemberById(Guid MemberId);

// æŸ¥è¯¢ç»“æœ
public record MemberDto(Guid Id, string Name, string Phone);

// æŸ¥è¯¢å¤„ç†å™¨
public static class GetMemberByIdHandler
{
    public static async Task<MemberDto> Handle(
        GetMemberById query,
        IDocumentSession session)
    {
        var member = await session.LoadAsync<Member>(query.MemberId);
        return new MemberDto(member.Id, member.Name, member.Phone);
    }
}
```

---

## å››ã€æ•°æ®è®¿é—®çº¦å®š

### 4.1 ä½¿ç”¨ Marten ä½œä¸ºä¸»å­˜å‚¨

**ç†ç”±ï¼š**
- æ”¯æŒæ–‡æ¡£æ¨¡å‹ï¼ˆé€‚åˆå‚ç›´åˆ‡ç‰‡ï¼‰
- åŸç”Ÿæ”¯æŒäº‹ä»¶å­˜å‚¨
- ä¸ Wolverine æ·±åº¦é›†æˆ
- å‡å°‘ ORM é…ç½®è´Ÿæ‹…

**ç¤ºä¾‹ï¼š**
```csharp
public static class RegisterMemberHandler
{
    public static async Task<MemberRegistered> Handle(
        RegisterMember command,
        IDocumentSession session) // Marten ä¼šè¯
    {
        var member = new Member(command.Name, command.Phone);
        session.Store(member); // ä¿å­˜æ–‡æ¡£
        await session.SaveChangesAsync();
        
        return new MemberRegistered(member.Id, member.Name);
    }
}
```

---

### 4.2 æ¯ä¸ªæ¨¡å—é€»è¾‘éš”ç¦»

è™½ç„¶ä½¿ç”¨åŒä¸€ä¸ª PostgreSQL æ•°æ®åº“ï¼Œä½†**é€»è¾‘ä¸Š**æ¯ä¸ªæ¨¡å—æœ‰ç‹¬ç«‹çš„ Schemaï¼š

```sql
-- Members æ¨¡å—
members.member
members.member_card
members.loyalty_points

-- Orders æ¨¡å—
orders.table
orders.session
orders.order
```

**ç¦æ­¢ï¼š**
- è·¨ Schema çš„ JOIN æŸ¥è¯¢
- è·¨ Schema çš„å¤–é”®çº¦æŸ

---

## äº”ã€æ¶æ„æµ‹è¯•ï¼ˆè‡ªåŠ¨åŒ–çº¦æŸï¼‰

### 5.1 æ¨¡å—éš”ç¦»æµ‹è¯•

ä½ç½®ï¼š`src/tests/ArchitectureTests/ModuleIsolationTests.cs`

**éªŒè¯è§„åˆ™ï¼š**
1. Modules ç¨‹åºé›†ä¸å¾—ä¾èµ–å…¶ä»– Modules ç¨‹åºé›†
2. Modules å†…ä¸å¾—å‡ºç° `.Application/.Domain/.Infrastructure` å‘½åç©ºé—´
3. Modules å†…ä¸å¾—å‡ºç° `Repository/Service/Manager` ç±»å
4. Modules åªèƒ½ä¾èµ– Platformï¼Œä¸èƒ½ä¾èµ– Application æˆ– Host

**å¦‚ä½•è¿è¡Œï¼š**
```bash
dotnet build
dotnet test ./src/tests/ArchitectureTests/ArchitectureTests.csproj
```

---

### 5.2 æµ‹è¯•å¤±è´¥æ—¶æ€ä¹ˆåŠï¼Ÿ

#### ç¤ºä¾‹ 1ï¼šè·¨æ¨¡å—å¼•ç”¨
```
âŒ Orders å¼•ç”¨äº† Members.Features.Registration
```
**ä¿®å¤ï¼š** æ”¹ç”¨äº‹ä»¶æˆ– Contracts æ¥å£

#### ç¤ºä¾‹ 2ï¼šå‡ºç°ç¦ç”¨å‘½å
```
âŒ å‘ç°ç±»å‹ï¼šMemberRepository
```
**ä¿®å¤ï¼š** åˆ é™¤è¯¥ç±»ï¼ŒHandler ç›´æ¥ä½¿ç”¨ IDocumentSession

---

## å…­ã€ä¾èµ–è¾¹ç•Œ

### 6.1 å…è®¸çš„ä¾èµ–å…³ç³»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Host                    â”‚  â† å¯åŠ¨å’Œé…ç½®
â”‚          (WebHost / Worker)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Application                â”‚  â† æ¨¡å—æ³¨å†Œå’Œç¼–æ’
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Modules                   â”‚  â† ä¸šåŠ¡æ¨¡å—ï¼ˆäº’ç›¸éš”ç¦»ï¼‰
â”‚   (Members / Orders / ...)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Platform                  â”‚  â† å…±äº«åŸºç¡€è®¾æ–½
â”‚  (Wolverine / Marten / Logging)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 6.2 ç¦æ­¢çš„ä¾èµ–å…³ç³»

```
âŒ Modules â†’ Host
âŒ Modules â†’ Application
âŒ Members â†’ Orders
âŒ Orders â†’ Members
âŒ Platform â†’ Modules
```

---

## ä¸ƒã€æ¼”è¿›è·¯å¾„

### 7.1 å•ä½“ â†’ å¾®æœåŠ¡ï¼ˆå¦‚æœéœ€è¦ï¼‰

å½“æŸä¸ªæ¨¡å—éœ€è¦ç‹¬ç«‹éƒ¨ç½²æ—¶ï¼š

**æ­¥éª¤ 1ï¼š** å°†è¿›ç¨‹å†…æ¶ˆæ¯æ”¹ä¸ºå¤–éƒ¨æ¶ˆæ¯é˜Ÿåˆ—
```csharp
// ä¹‹å‰ï¼šè¿›ç¨‹å†…
opts.PublishAllMessages().ToLocalQueue("events");

// ä¹‹åï¼šRabbitMQ
opts.PublishAllMessages().ToRabbitQueue("events");
```

**æ­¥éª¤ 2ï¼š** å°†æ¨¡å—æå–ä¸ºç‹¬ç«‹æœåŠ¡
- æ¨¡å—ä»£ç æ— éœ€ä¿®æ”¹ï¼ˆè¾¹ç•Œå·²ç»æ¸…æ™°ï¼‰
- åªéœ€è°ƒæ•´å®¿ä¸»é…ç½®

**æ­¥éª¤ 3ï¼š** è°ƒæ•´ Contracts è°ƒç”¨ä¸º HTTP
```csharp
// ä¹‹å‰ï¼šè¿›ç¨‹å†…è°ƒç”¨
private readonly IMemberQueries _memberQueries;

// ä¹‹åï¼šHTTP è°ƒç”¨
private readonly HttpClient _memberClient;
```

---

## å…«ã€å‚è€ƒèµ„æ–™

### æ¶æ„è®¾è®¡
- [Modular Monolith: A Primer](https://www.kamilgrzybek.com/design/modular-monolith-primer/)
- [Vertical Slice Architecture](https://jimmybogard.com/vertical-slice-architecture/)
- [Wolverine æ¨¡å—åŒ–å•ä½“æ•™ç¨‹](https://wolverinefx.net/tutorials/modular-monolith.html)

### æŠ€æœ¯æ–‡æ¡£
- [Wolverine å®˜æ–¹æ–‡æ¡£](https://wolverinefx.net/)
- [Marten æ–‡æ¡£æ•°æ®åº“](https://martendb.io/)

---

## ä¹ã€ADRï¼ˆæ¶æ„å†³ç­–è®°å½•ï¼‰

### ADR-001ï¼šé‡‡ç”¨æ¨¡å—åŒ–å•ä½“è€Œéå¾®æœåŠ¡

**èƒŒæ™¯ï¼š** é¡¹ç›®åˆæœŸï¼Œå›¢é˜Ÿè§„æ¨¡å°ï¼Œéœ€æ±‚å°šæœªç¨³å®š

**å†³ç­–ï¼š** ä½¿ç”¨ Modular Monolith

**ç†ç”±ï¼š**
- å¼€å‘æ•ˆç‡ä¼˜å…ˆ
- è¿ç»´æˆæœ¬å¯æ§
- ä¿ç•™æœªæ¥æ‹†åˆ†å¯èƒ½æ€§

**åæœï¼š**
- âœ… å¿«é€Ÿè¿­ä»£
- âœ… ç»Ÿä¸€éƒ¨ç½²
- âš ï¸ éœ€è¦ä¸¥æ ¼çš„æ¶æ„çº¦æŸæµ‹è¯•

---

### ADR-002ï¼šé€‰æ‹© Wolverine è€Œé MediatR

**èƒŒæ™¯ï¼š** éœ€è¦æ¨¡å—é—´æ¶ˆæ¯é€šä¿¡

**å†³ç­–ï¼š** ä½¿ç”¨ Wolverine

**ç†ç”±ï¼š**
- åŸç”Ÿæ”¯æŒå¼‚æ­¥æ¶ˆæ¯
- ä¸ Marten æ·±åº¦é›†æˆ
- æ”¯æŒ Durable Messaging
- å¹³æ»‘æ¼”è¿›åˆ°åˆ†å¸ƒå¼

**åæœï¼š**
- âœ… ä½ä»£ç ä»ªå¼æ„Ÿ
- âœ… æ€§èƒ½æ›´ä¼˜
- âš ï¸ å­¦ä¹ æ›²çº¿ï¼ˆæ–‡æ¡£è¾ƒå°‘ï¼‰

---

### ADR-003ï¼šä½¿ç”¨ Marten ä½œä¸ºä¸»å­˜å‚¨

**èƒŒæ™¯ï¼š** éœ€è¦çµæ´»çš„æ•°æ®å­˜å‚¨æ–¹æ¡ˆ

**å†³ç­–ï¼š** Marten + PostgreSQL

**ç†ç”±ï¼š**
- æ–‡æ¡£æ¨¡å‹é€‚åˆå‚ç›´åˆ‡ç‰‡
- æ”¯æŒäº‹ä»¶å­˜å‚¨
- å‡å°‘ Schema è¿ç§»è´Ÿæ‹…

**åæœï¼š**
- âœ… å¼€å‘é€Ÿåº¦å¿«
- âœ… æ”¯æŒå¤æ‚æŸ¥è¯¢
- âš ï¸ éœ€è¦åˆç†è®¾è®¡æ–‡æ¡£ç»“æ„

---

**æ–‡æ¡£ç»“æŸ**
