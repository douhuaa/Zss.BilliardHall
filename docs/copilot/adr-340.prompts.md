# ADR-340：结构化日志与监控约束 - Copilot 提示词库

**关联 ADR**：[ADR-340](../adr/technical/ADR-340-structured-logging-monitoring-constraints.md)（裁决性规则）  
**工程指南**：[结构化日志与监控工程标准](../guides/structured-logging-monitoring-standard.md)（非裁决性）  
**测试类**：`ADR_340_Architecture_Tests.cs`  
**版本**：1.0  
**最后更新**：2026-01-24

---

## 重要说明

> **ADR-340 是技术层裁决型规则（5条可自动判定的规则）。**
>
> 详细的日志配置指导、日志字段推荐、监控指标建议等内容已在《结构化日志与监控工程标准》中提供。

---

## 一、当我在写什么时，你应该提醒我哪些 ADR-340 约束？

### 场景 1：在 PlatformBootstrapper 中配置日志

**触发条件**：

- 修改 `PlatformBootstrapper.cs`
- 配置 Serilog 或其他日志框架
- 设置日志输出目标（Sink）

**你应该提醒的约束**：

```
✅ 必须在 PlatformBootstrapper 中配置 Serilog：
1. 引用 Serilog 和 Serilog.AspNetCore
2. 在 Configure() 方法中配置 Log.Logger
3. 至少配置一个 Sink（Console 或 File）
4. 配置合理的日志级别

示例：
private static void ConfigureSerilog(IConfiguration configuration, IHostEnvironment environment)
{
    Log.Logger = new LoggerConfiguration()
        .ReadFrom.Configuration(configuration)
        .Enrich.FromLogContext()
        .Enrich.WithEnvironmentName()
        .Enrich.WithProperty("Application", "Zss.BilliardHall")
        .MinimumLevel.Information()
        .WriteTo.Console(
            outputTemplate: "[{Timestamp:HH:mm:ss} {Level:u3}] {Message:lj} {Properties:j}{NewLine}{Exception}")
        .WriteTo.File(
            path: "logs/log-.txt",
            rollingInterval: RollingInterval.Day,
            retainedFileCountLimit: 30)
        .CreateLogger();
}

// 在 Program.cs 中启用
builder.Host.UseSerilog();

❌ 禁止：
- 在 Application 或 Modules 层配置 Serilog
- 在 Host 层直接配置日志（应通过 Platform 层）
- 只配置日志但不添加任何 Sink
```

**相关测试**：
- `ADR_340_Architecture_Tests.Platform_Should_Reference_Serilog()`
- `ADR_340_Architecture_Tests.PlatformBootstrapper_Should_Configure_Serilog()`

---

### 场景 2：在 PlatformBootstrapper 中配置 OpenTelemetry

**触发条件**：

- 配置追踪（Tracing）和指标（Metrics）
- 添加插桩（Instrumentation）
- 配置 OTLP 导出器

**你应该提醒的约束**：

```
✅ 必须在 PlatformBootstrapper 中配置 OpenTelemetry：
1. 同时配置 Tracing 和 Metrics
2. 添加 AspNetCore、Http、Runtime 插桩
3. 配置 OTLP 导出器端点

示例：
private static void ConfigureOpenTelemetry(
    IServiceCollection services,
    IConfiguration configuration,
    IHostEnvironment environment)
{
    services.AddOpenTelemetry()
        .ConfigureResource(resource => resource
            .AddService(
                serviceName: "Zss.BilliardHall",
                serviceVersion: "1.0.0")
            .AddAttributes(new Dictionary<string, object>
            {
                ["deployment.environment"] = environment.EnvironmentName
            }))
        .WithTracing(tracing => tracing
            .AddAspNetCoreInstrumentation(options =>
            {
                options.RecordException = true;
            })
            .AddHttpClientInstrumentation()
            .AddSource("Wolverine")
            .AddOtlpExporter(options =>
            {
                options.Endpoint = new Uri(
                    configuration["OpenTelemetry:Endpoint"] ?? "http://localhost:4317");
            }))
        .WithMetrics(metrics => metrics
            .AddAspNetCoreInstrumentation()
            .AddHttpClientInstrumentation()
            .AddRuntimeInstrumentation()
            .AddOtlpExporter(options =>
            {
                options.Endpoint = new Uri(
                    configuration["OpenTelemetry:Endpoint"] ?? "http://localhost:4317");
            }));
}

❌ 禁止：
- 只配置 Tracing 或只配置 Metrics（必须两者都配）
- 在 Application 或 Modules 层配置 OpenTelemetry
- 缺少核心插桩（AspNetCore、Http、Runtime）
```

**相关测试**：
- `ADR_340_Architecture_Tests.Platform_Should_Reference_OpenTelemetry()`
- `ADR_340_Architecture_Tests.PlatformBootstrapper_Should_Configure_OpenTelemetry()`

---

### 场景 3：在 Handler 中记录日志

**触发条件**：

- 实现 Command Handler、Query Handler 或 Event Handler
- 需要记录业务操作日志
- 需要记录关键事件和错误

**你应该提醒的约束**：

```
✅ 使用结构化日志：
1. 注入 ILogger<T>
2. 使用消息模板（而非字符串插值）
3. 记录关键业务事件
4. 使用合适的日志级别

示例：
public class CreateOrderHandler
{
    private readonly ILogger<CreateOrderHandler> _logger;
    
    public CreateOrderHandler(ILogger<CreateOrderHandler> logger)
    {
        _logger = logger;
    }
    
    public async Task<Guid> Handle(CreateOrder command)
    {
        // ✅ 正确：使用消息模板
        _logger.LogInformation(
            "开始处理创建订单命令，会员ID {MemberId}，商品数量 {ItemCount}",
            command.MemberId, command.Items.Count);
        
        // ... 业务逻辑 ...
        
        _logger.LogInformation(
            "订单创建成功，订单ID {OrderId}，金额 {Amount}",
            orderId, order.TotalAmount);
        
        return orderId;
    }
}

❌ 禁止：
// ❌ 字符串插值
_logger.LogInformation($"订单 {orderId} 创建成功");

// ❌ 字符串拼接
_logger.LogInformation("订单 " + orderId + " 创建成功");

// ❌ 使用 Console.WriteLine
Console.WriteLine("订单创建成功");

// ❌ 直接依赖 Serilog
using Serilog;
Log.Information("订单创建成功");
```

**日志级别指导**：

| 级别 | 使用场景 | 示例 |
|------|---------|------|
| **Information** | 关键业务事件 | 订单创建、支付完成 |
| **Warning** | 警告但不影响运行 | 库存不足、配置缺失 |
| **Error** | 错误但系统可恢复 | 业务异常、验证失败 |
| **Critical** | 严重错误需立即处理 | 数据库连接失败、系统崩溃 |

**相关测试**：
- `ADR_340_Architecture_Tests.Modules_Cannot_Reference_Serilog_Directly()`（将在 L2 Roslyn Analyzer 中实现）

---

### 场景 4：在 Modules 或 Application 层中配置日志

**触发条件**：

- 在 Module 项目中添加 Serilog 引用
- 在 Application 项目中配置日志
- 尝试直接使用 Serilog API

**你应该提醒的约束**：

```
❌ 禁止在 Modules/Application 层配置日志：

1. 不得在项目文件中引用 Serilog 包
2. 不得在代码中配置日志框架
3. 不得直接使用 Serilog 静态类

✅ 正确做法：
1. 仅使用 Microsoft.Extensions.Logging.ILogger<T>
2. 通过依赖注入获取 ILogger<T>
3. 日志配置由 Platform 层的 PlatformBootstrapper 负责

示例：
// ❌ 错误：在 Module 中
// Module.csproj
<PackageReference Include="Serilog.AspNetCore" />

// ❌ 错误：在 Handler 中
using Serilog;
Log.Logger = new LoggerConfiguration()...

// ✅ 正确：只使用接口
public class CreateOrderHandler
{
    private readonly ILogger<CreateOrderHandler> _logger;
    
    public CreateOrderHandler(ILogger<CreateOrderHandler> logger)
    {
        _logger = logger;  // ✅ 通过依赖注入
    }
    
    public async Task Handle(CreateOrder command)
    {
        _logger.LogInformation("处理订单 {OrderId}", orderId);  // ✅ 使用接口
    }
}
```

**架构原因**：
- Platform 层负责技术基础设施配置（ADR-002）
- Application/Modules 层只使用抽象接口
- 保持业务层对日志实现的无感知

**相关测试**：
- `ADR_340_Architecture_Tests.Modules_Cannot_Reference_Serilog_Directly()`
- `ADR_340_Architecture_Tests.Application_Cannot_Configure_Serilog()`
- `ADR_340_Architecture_Tests.Modules_Cannot_Reference_OpenTelemetry_Directly()`
- `ADR_340_Architecture_Tests.Application_Cannot_Configure_OpenTelemetry()`

---

### 场景 5：创建自定义追踪 Span

**触发条件**：

- 需要追踪特定业务操作
- 想要为关键流程创建自定义 Span
- 需要添加自定义标签（Tags）

**你应该提醒的约束**：

```
✅ 使用 System.Diagnostics.Activity（允许）：
1. 可以在 Modules 层使用 ActivitySource
2. 使用 Activity 创建自定义 Span
3. 添加业务相关的 Tags

示例：
// ✅ 正确：使用 BCL 的 Activity
using System.Diagnostics;

public class CreateOrderHandler
{
    private static readonly ActivitySource ActivitySource = 
        new("Zss.BilliardHall.Orders");
    
    public async Task<Guid> Handle(CreateOrder command)
    {
        using var activity = ActivitySource.StartActivity("CreateOrder");
        activity?.SetTag("order.member_id", command.MemberId);
        activity?.SetTag("order.items_count", command.Items.Count);
        
        // ... 业务逻辑 ...
        
        activity?.SetTag("order.total_amount", order.TotalAmount);
        activity?.SetTag("order.status", "Created");
        
        return order.Id;
    }
}

❌ 禁止：
// ❌ 直接引用 OpenTelemetry 配置包
using OpenTelemetry.Trace;
var tracerProvider = Sdk.CreateTracerProviderBuilder()...

// ❌ 在 Module 中配置 OpenTelemetry
services.AddOpenTelemetry()...
```

**说明**：
- `System.Diagnostics.Activity` 是 .NET BCL 的一部分，不违反 ADR-340
- Platform 层的 OpenTelemetry 配置会自动收集这些 Activity
- Modules 层可以使用 Activity 创建业务追踪

**参考**：
- 工程标准：`docs/guides/structured-logging-monitoring-standard.md`（五、监控指标和告警建议）

---

## 二、常见违规示例与修复建议

### 违规 1：在 Module 中直接配置 Serilog

```csharp
// ❌ 违规代码
// Members/MembersBootstrapper.cs
using Serilog;

public static class MembersBootstrapper
{
    public static void Configure(IServiceCollection services)
    {
        Log.Logger = new LoggerConfiguration()
            .WriteTo.Console()
            .CreateLogger();
    }
}
```

**修复建议**：

```csharp
// ✅ 修复：移除日志配置，只使用 ILogger<T>
public class CreateMemberHandler
{
    private readonly ILogger<CreateMemberHandler> _logger;
    
    public CreateMemberHandler(ILogger<CreateMemberHandler> logger)
    {
        _logger = logger;
    }
    
    public async Task<Guid> Handle(CreateMember command)
    {
        _logger.LogInformation("创建会员 {MemberName}", command.Name);
        // ... 业务逻辑 ...
    }
}
```

**违反的规则**：ADR-340.5  
**相关测试**：`ADR_340_Architecture_Tests.Modules_Cannot_Reference_Serilog_Directly()`

---

### 违规 2：使用字符串插值而非消息模板

```csharp
// ❌ 违规代码
_logger.LogInformation($"订单 {orderId} 创建成功，金额 {amount}");
```

**修复建议**：

```csharp
// ✅ 修复：使用消息模板
_logger.LogInformation("订单 {OrderId} 创建成功，金额 {Amount}", orderId, amount);
```

**原因**：
- 消息模板支持结构化日志
- 可以高效搜索和过滤日志
- 减少字符串分配，提高性能

**违反的规则**：ADR-340.4（将在 L2 Roslyn Analyzer 中检测）

---

### 违规 3：Platform 层缺少 OpenTelemetry 配置

```csharp
// ❌ 违规代码
// PlatformBootstrapper.cs
public static void Configure(IServiceCollection services, ...)
{
    // 只配置了 Serilog，没有配置 OpenTelemetry
    Log.Logger = new LoggerConfiguration()...
}
```

**修复建议**：

```csharp
// ✅ 修复：添加 OpenTelemetry 配置
public static void Configure(IServiceCollection services, IConfiguration configuration, ...)
{
    ConfigureSerilog(configuration, environment);
    ConfigureOpenTelemetry(services, configuration, environment);  // ✅ 添加
}

private static void ConfigureOpenTelemetry(...)
{
    services.AddOpenTelemetry()
        .WithTracing(tracing => tracing
            .AddAspNetCoreInstrumentation()
            .AddHttpClientInstrumentation())
        .WithMetrics(metrics => metrics
            .AddAspNetCoreInstrumentation()
            .AddRuntimeInstrumentation());
}
```

**违反的规则**：ADR-340.2  
**相关测试**：`ADR_340_Architecture_Tests.PlatformBootstrapper_Should_Configure_OpenTelemetry()`

---

## 三、架构测试失败诊断

### 测试失败：`Platform_Should_Reference_Serilog`

**错误信息**：
```
❌ ADR-340.1 违规: Platform 层必须引用 Serilog.AspNetCore 包。
当前状态: Platform.csproj 未引用 Serilog.AspNetCore
```

**修复步骤**：
1. 打开 `src/Platform/Platform.csproj`
2. 添加 PackageReference：
   ```xml
   <PackageReference Include="Serilog.AspNetCore" />
   ```
3. 确保 `Directory.Packages.props` 中定义了版本：
   ```xml
   <PackageVersion Include="Serilog.AspNetCore" Version="10.0.0" />
   ```

---

### 测试失败：`PlatformBootstrapper_Should_Configure_Serilog`

**错误信息**：
```
❌ ADR-340.3 违规: PlatformBootstrapper 必须配置 Serilog。
当前状态: 未发现 Serilog 配置代码
```

**修复步骤**：
1. 在 `PlatformBootstrapper.cs` 中添加：
   ```csharp
   using Serilog;
   
   private static void ConfigureSerilog(...)
   {
       Log.Logger = new LoggerConfiguration()
           .WriteTo.Console()
           .CreateLogger();
   }
   ```
2. 在 `Configure()` 方法中调用：
   ```csharp
   public static void Configure(...)
   {
       ConfigureSerilog(configuration, environment);
   }
   ```
3. 在 `Program.cs` 中启用：
   ```csharp
   builder.Host.UseSerilog();
   ```

---

### 测试失败：`Modules_Cannot_Reference_Serilog_Directly`

**错误信息**：
```
❌ ADR-340.5 违规: Modules 层禁止直接引用 Serilog。
违规类型:
  - Zss.BilliardHall.Modules.Orders.CreateOrderHandler
```

**修复步骤**：
1. 从 Module 的 `.csproj` 中移除 Serilog 引用
2. 移除代码中的 `using Serilog;`
3. 改用 `ILogger<T>` 接口：
   ```csharp
   // ❌ 移除
   using Serilog;
   Log.Information("...");
   
   // ✅ 改为
   using Microsoft.Extensions.Logging;
   _logger.LogInformation("...");
   ```

---

## 四、快速参考

### 日志级别选择

| 场景 | 级别 | 示例 |
|------|------|------|
| 订单创建成功 | Information | `_logger.LogInformation("订单 {OrderId} 创建成功", orderId)` |
| 库存不足警告 | Warning | `_logger.LogWarning("库存不足，商品 {ProductId}", productId)` |
| 业务异常 | Error | `_logger.LogError(ex, "订单创建失败 {OrderId}", orderId)` |
| 数据库连接失败 | Critical | `_logger.LogCritical(ex, "数据库连接失败")` |

### 推荐的日志字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| `CorrelationId` | Guid | 请求关联 ID |
| `UserId` / `MemberId` | Guid | 当前用户/会员 ID |
| `CommandId` / `QueryId` / `EventId` | Guid | 消息唯一标识 |
| `HandlerName` | string | Handler 类型名称 |
| `ElapsedMs` | long | 操作耗时（毫秒） |

### 配置位置约束

| 层级 | Serilog 配置 | OpenTelemetry 配置 | 使用 ILogger |
|------|-------------|-------------------|-------------|
| **Platform** | ✅ 必须 | ✅ 必须 | ✅ 可以 |
| **Application** | ❌ 禁止 | ❌ 禁止 | ✅ 可以 |
| **Modules** | ❌ 禁止 | ❌ 禁止 | ✅ 可以 |
| **Host** | ❌ 禁止 | ❌ 禁止 | ✅ 可以 |

---

## 五、相关文档

- [ADR-340：结构化日志与监控约束](../adr/technical/ADR-340-structured-logging-monitoring-constraints.md)（裁决性）
- [结构化日志与监控工程标准](../guides/structured-logging-monitoring-standard.md)（非裁决性）
- [ADR-002：Platform/Application/Host 启动体系](../adr/constitutional/ADR-002-platform-application-host-bootstrap.md)
- [Serilog 官方文档](https://serilog.net/)（技术参考）
- [OpenTelemetry .NET 文档](https://opentelemetry.io/docs/languages/net/)（技术参考）

---

## 版本历史

| 版本 | 日期 | 变更说明 | 作者 |
|------|------|----------|------|
| 1.0 | 2026-01-24 | 初始版本，提供 ADR-340 的 Copilot 指导 | @copilot |
