# ADR-940 Copilot Prompts：ADR 关系与溯源管理

> ⚠️ **权威声明**  
> 本文档不具备裁决权，仅提供场景化指导。  
> 所有架构决策以 [ADR-940 正文](../adr/governance/ADR-940-adr-relationship-traceability-management.md) 为准。

**版本**：1.0  
**最后更新**：2026-01-26  
**关联 ADR**：ADR-940  
**用途**：为 GitHub Copilot 提供 ADR 关系声明场景的具体指导

---

## 概述

本文件为 GitHub Copilot 提供关于 ADR 关系声明的场景化示例和常见问题处理。

**核心原则（来自 ADR-940）**：
- 每个 ADR 必须包含关系声明章节
- 依赖和替代关系必须双向一致
- 禁止循环依赖
- 自动生成全局关系图
- 已废弃 ADR 不能被新 ADR 引用

---

## 场景 1：创建新 ADR 时添加关系声明

### 用户问："我创建了新 ADR，需要添加关系声明吗？"

**Copilot 应该**：

1. **确认必须添加**：

```
根据 ADR-940.1，所有 ADR 必须包含"关系声明（Relationships）"章节。
即使没有任何关系，也需要添加该章节并标注"无"。
```

2. **提供标准模板**：

```markdown
## 关系声明（Relationships）

**依赖（Depends On）**：
- [ADR-0001：模块化单体与垂直切片架构](../constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md) - 本 ADR 基于模块隔离规则

**被依赖（Depended By）**：
无（新创建的 ADR 通常暂时无被依赖）

**替代（Supersedes）**：
无

**被替代（Superseded By）**：
无

**相关（Related）**：
- [ADR-0005：应用内交互模型](../constitutional/ADR-0005-Application-Interaction-Model-Final.md) - 相关的通信模式
```

3. **检查章节位置**：

```
关系声明章节必须位于"决策（Decision）"章节之后。

正确结构：
1. 聚焦内容（Focus）
2. 术语表（Glossary）
3. 决策（Decision）
4. 关系声明（Relationships）  ← 这里
5. 验证方法（Verification）
```

---

## 场景 2：判断 ADR 之间的关系类型

### 用户问："我的 ADR 应该依赖 ADR-0001 还是相关？"

**Copilot 应该**：

根据 ADR-940.2 的定义，帮助用户判断：

| 关系类型 | 使用场景 | 示例 |
|---------|---------|------|
| **依赖（Depends On）** | 你的 ADR 基于另一 ADR 的规则或概念 | 你的 ADR 定义 Handler 生命周期，需要基于 ADR-0005 的 CQRS 规则 |
| **相关（Related）** | 两个 ADR 相关但不存在依赖 | 你的 ADR 定义日志格式，ADR-0970 定义日志集成，两者相关但不依赖 |

**判断标准**：

```
✅ 应该使用"依赖"：
- 你的决策基于另一 ADR 的规则
- 违反另一 ADR 会使你的 ADR 失效
- 你引用了另一 ADR 的概念或术语

✅ 应该使用"相关"：
- 两个 ADR 涉及类似主题
- 读者可能需要同时参考
- 但不存在规则上的依赖
```

**示例判断**：

```markdown
❓ 问题：ADR-0201 定义 Handler 生命周期，是否依赖 ADR-0005？

✅ 答案：是，应该依赖
理由：Handler 生命周期基于 ADR-0005 的 CQRS 规则，必须遵循 Command/Query 的定义

❓ 问题：ADR-0340 定义领域事件，是否依赖 ADR-0240 的数据库事务？

❌ 答案：否，应该相关
理由：领域事件和事务相关，但领域事件的定义不基于事务规则
```

---

## 场景 3：确保关系双向一致性

### 用户说："我在 ADR-0201 中声明依赖 ADR-0005"

**Copilot 应该**：

1. **提醒双向一致性要求**：

```
根据 ADR-940.3，依赖关系必须双向一致。

你需要：
1. 在 ADR-0201 中添加：依赖 ADR-0005
2. 在 ADR-0005 中添加：被依赖 ADR-0201
```

2. **提供修改示例**：

**在 ADR-0201 中**：
```markdown
## 关系声明（Relationships）

**依赖（Depends On）**：
- [ADR-0005：应用内交互模型](../constitutional/ADR-0005-Application-Interaction-Model-Final.md) - 本 ADR 基于 CQRS 规则定义 Handler 生命周期
```

**在 ADR-0005 中需要添加**：
```markdown
## 关系声明（Relationships）

**被依赖（Depended By）**：
- [ADR-0201：Handler 生命周期管理](../runtime/ADR-0201-handler-lifecycle.md)
```

3. **说明 CI 检查**：

```
CI 会自动检查双向一致性（ADR-940.3）：
- 运行 scripts/check-relationship-consistency.sh
- 不一致会导致构建失败
- PR 无法合并
```

---

## 场景 4：避免引用已废弃的 ADR

### 用户问："我可以依赖 ADR-0005-v1 吗？"

**Copilot 应该**：

1. **检查 ADR 状态**：

```bash
# 检查 ADR-0005-v1 的状态
grep "状态" docs/adr/constitutional/ADR-0005-v1.md
```

2. **如果已废弃，明确拒绝**：

```
❌ 禁止依赖已废弃的 ADR

根据 ADR-940.2：
- ADR-0005-v1 已被 ADR-0005-v2 替代（状态：Superseded）
- 标记为 Superseded 的 ADR 禁止作为新变更的依据
- 新 ADR 禁止引用已废弃 ADR

✅ 正确做法：
依赖替代后的版本 ADR-0005-v2
```

3. **提供正确引用**：

```markdown
❌ 错误：
**依赖（Depends On）**：
- [ADR-0005-v1](链接) 

✅ 正确：
**依赖（Depends On）**：
- [ADR-0005-v2：应用内交互模型（最新版）](../constitutional/ADR-0005-v2.md)
```

---

## 场景 5：检测和解决循环依赖

### 用户说："CI 报告循环依赖错误"

**Copilot 应该**：

1. **解释循环依赖**：

```
根据 ADR-940.4，ADR 禁止形成循环依赖。

循环依赖示例：
❌ ADR-A 依赖 ADR-B
   ADR-B 依赖 ADR-C
   ADR-C 依赖 ADR-A  ← 形成环

这会导致：
- 依赖关系不清晰
- 无法确定阅读顺序
- 修改影响范围难以追踪
```

2. **运行检测脚本**：

```bash
# 检测循环依赖
./scripts/detect-circular-dependencies.sh

# 输出示例：
❌ 发现循环依赖：
ADR-0201 → ADR-0005 → ADR-0340 → ADR-0201
```

3. **提供解决方案**：

```
解决循环依赖的方法：

方案 1：提取公共规则
- 如果 A 和 B 相互依赖，说明有公共规则
- 创建新 ADR-X 包含公共规则
- A 和 B 都依赖 X

方案 2：重新设计依赖关系
- 分析哪个依赖是必要的
- 移除不必要的依赖
- 保持单向依赖

方案 3：改为相关关系
- 如果不是真正的依赖
- 将"依赖"改为"相关"
- 相关关系不参与循环检测
```

**示例**：

```markdown
❌ 循环依赖：
ADR-0201（Handler 生命周期）依赖 ADR-0340（领域事件）
ADR-0340（领域事件）依赖 ADR-0201（Handler 发布事件）

✅ 解决方案：
创建 ADR-0199（事件基础架构）包含公共规则
ADR-0201 和 ADR-0340 都依赖 ADR-0199
```

---

## 场景 6：查看 ADR 关系图

### 用户问："如何查看所有 ADR 的关系？"

**Copilot 应该**：

1. **指向关系图**：

```
根据 ADR-940.5，系统自动生成全局关系图：

📊 查看关系图：
docs/adr/ADR-RELATIONSHIP-MAP.md

包含：
1. Mermaid 可视化图表
2. 详细的关系列表表格
3. 统计信息
```

2. **生成关系图命令**：

```bash
# 手动生成关系图
./scripts/generate-adr-relationship-map.sh

# 输出位置
docs/adr/ADR-RELATIONSHIP-MAP.md
```

3. **说明自动更新**：

```
关系图自动更新时机：
- 每次 PR 合并到主分支
- 手动运行生成脚本
- CI 流程中自动触发
```

---

## 场景 7：修改已存在的关系声明

### 用户问："ADR-0005 新增了一个被依赖，如何更新？"

**Copilot 应该**：

1. **定位章节**：

```markdown
在 ADR-0005 中找到"关系声明（Relationships）"章节：

## 关系声明（Relationships）

**被依赖（Depended By）**：
- [ADR-0201：Handler 生命周期](../runtime/ADR-0201-handler-lifecycle.md)
```

2. **添加新关系**：

```markdown
## 关系声明（Relationships）

**被依赖（Depended By）**：
- [ADR-0201：Handler 生命周期](../runtime/ADR-0201-handler-lifecycle.md)
- [ADR-0340：领域事件模式](../runtime/ADR-0340-domain-events.md)  ← 新增
```

3. **确保双向一致**：

```
提醒：你还需要在 ADR-0340 中添加：

## 关系声明（Relationships）

**依赖（Depends On）**：
- [ADR-0005：应用内交互模型](../constitutional/ADR-0005-Application-Interaction-Model-Final.md)
```

4. **运行验证**：

```bash
# 验证双向一致性
./scripts/check-relationship-consistency.sh

# 重新生成关系图
./scripts/generate-adr-relationship-map.sh
```

---

## 常见错误和修正

### ❌ 错误 1：缺少关系声明章节

**错误示例**：
```markdown
# ADR-0123

## 决策
...

## 验证方法
...
```

**问题**：缺少"关系声明"章节

**修正**：
```markdown
# ADR-0123

## 决策
...

## 关系声明（Relationships）

**依赖（Depends On）**：
无

**被依赖（Depended By）**：
无

**相关（Related）**：
无

## 验证方法
...
```

---

### ❌ 错误 2：关系不双向

**错误示例**：

ADR-0201：
```markdown
**依赖（Depends On）**：
- [ADR-0005](链接)
```

ADR-0005：
```markdown
**被依赖（Depended By）**：
（没有列出 ADR-0201）
```

**问题**：依赖关系未双向声明

**修正**：在 ADR-0005 中添加：
```markdown
**被依赖（Depended By）**：
- [ADR-0201：Handler 生命周期](../runtime/ADR-0201-handler-lifecycle.md)
```

---

### ❌ 错误 3：引用已废弃 ADR

**错误示例**：
```markdown
**依赖（Depends On）**：
- [ADR-0005-Enforcement-Levels](链接)  ← 已被废弃
```

**问题**：引用了状态为 Superseded 的 ADR

**修正**：
```markdown
**依赖（Depends On）**：
- [ADR-0005：应用内交互模型（最新版）](链接)
```

---

### ❌ 错误 4：循环依赖

**错误示例**：
```
ADR-A 依赖 ADR-B
ADR-B 依赖 ADR-A
```

**问题**：形成循环依赖

**修正方案**：
1. 提取公共规则到新 ADR-C
2. A 和 B 都依赖 C
3. 移除 A 和 B 之间的直接依赖

---

## 工具和命令速查

| 任务 | 命令 | 说明 |
|------|------|------|
| 验证关系声明章节 | `./scripts/verify-adr-relationships.sh` | 检查所有 ADR 是否包含关系声明章节 |
| 检查双向一致性 | `./scripts/check-relationship-consistency.sh` | 验证依赖关系双向一致 |
| 检测循环依赖 | `./scripts/detect-circular-dependencies.sh` | 使用 DFS 算法检测循环依赖 |
| 生成关系图 | `./scripts/generate-adr-relationship-map.sh` | 生成 Mermaid 图表和表格 |
| 全面验证 | `./scripts/verify-all.sh` | 运行所有验证（包括关系检查） |

---

## 参考资料

- [ADR-940 正文](../adr/governance/ADR-940-adr-relationship-traceability-management.md) - 权威规则
- [ADR 关系图](../adr/ADR-RELATIONSHIP-MAP.md) - 当前关系可视化
- [P0 实施总结](../summaries/p0-adr-implementation-summary.md) - 实施背景

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| 1.0 | 2026-01-26 | 初始版本 |

---

**维护**：架构委员会  
**审核**：@douhuaa  
**状态**：✅ Active
