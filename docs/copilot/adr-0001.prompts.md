# ADR-0001ï¼šæ¨¡å—åŒ–å•ä½“ä¸å‚ç›´åˆ‡ç‰‡æ¶æ„ - Copilot æç¤ºè¯åº“

**å…³è” ADR**ï¼š[ADR-0001](../adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md)  
**æµ‹è¯•ç±»**ï¼š`ADR_0001_Architecture_Tests.cs`  
**ç‰ˆæœ¬**ï¼š4.0  
**æœ€åæ›´æ–°**ï¼š2026-01-23  
**å¯¹åº” ADR ç‰ˆæœ¬**ï¼šv4.0  
**å¯¹é½çŠ¶æ€**ï¼šâœ… 100% å®Œæˆ

---

## ä¸€ã€å½“æˆ‘åœ¨å†™ä»€ä¹ˆæ—¶ï¼Œä½ åº”è¯¥æé†’æˆ‘å“ªäº› ADR-0001 çº¦æŸï¼Ÿ

### åœºæ™¯ 1ï¼šåˆ›å»ºæ–°æ¨¡å—

**è§¦å‘æ¡ä»¶**ï¼š

- åœ¨ `src/Modules/` ä¸‹åˆ›å»ºæ–°ç›®å½•
- æ·»åŠ æ–°çš„ä¸šåŠ¡æ¨¡å—ç¨‹åºé›†

**ä½ åº”è¯¥æé†’çš„çº¦æŸ**ï¼š

```
âœ… æ£€æŸ¥æ¸…å•ï¼š
1. æ¨¡å—æ˜¯å¦æŒ‰ä¸šåŠ¡èƒ½åŠ›åˆ’åˆ†ï¼Ÿï¼ˆå¦‚ Membersã€Ordersã€Paymentsï¼‰
2. æ¨¡å—æ˜¯å¦æœ‰ç‹¬ç«‹çš„ç¨‹åºé›†è¾¹ç•Œï¼Ÿ
3. æ¨¡å—æ˜¯å¦åªæš´éœ²å—æ§çš„é›†æˆç‚¹ï¼Ÿ
4. æ¨¡å—å†…éƒ¨æ˜¯å¦é‡‡ç”¨å‚ç›´åˆ‡ç‰‡ç»„ç»‡ï¼Ÿ

âŒ ç¦æ­¢ï¼š
- åˆ›å»º"Common"ã€"Shared"ã€"Utils"ç­‰æ¨ªå‘æ¨¡å—
- æ¨¡å—å‘½åä¸åæ˜ ä¸šåŠ¡èƒ½åŠ›
- æ¨¡å—å¯¹å¤–æš´éœ²å†…éƒ¨å®ç°
```

---

### åœºæ™¯ 2ï¼šå®ç°æ–°çš„ä¸šåŠ¡ç”¨ä¾‹

**è§¦å‘æ¡ä»¶**ï¼š

- æ·»åŠ æ–°çš„ Use Case æ–‡ä»¶å¤¹
- åˆ›å»º Command/Query å’Œ Handler

**ä½ åº”è¯¥æé†’çš„çº¦æŸ**ï¼š

```
âœ… æ£€æŸ¥æ¸…å•ï¼š
1. Use Case æ˜¯å¦åŒ…å«å®Œæ•´çš„å‚ç›´åˆ‡ç‰‡ï¼Ÿ
   - Endpoint/API
   - Command/Query
   - Handler
   - ä¸šåŠ¡è§„åˆ™ä¸æ ¡éªŒ
   - æŒä¹…åŒ–é€»è¾‘
2. ä¸šåŠ¡é€»è¾‘æ˜¯å¦åœ¨ Handler ä¸­ï¼Œè€ŒéæŠ½è±¡ä¸º Serviceï¼Ÿ

âŒ ç¦æ­¢ï¼š
- åˆ›å»ºæ¨ªå‘ Service å±‚ï¼ˆå¦‚ OrderServiceï¼‰
- åœ¨ Endpoint ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘
- å¤šä¸ª Use Case å…±äº« Service
```

---

### åœºæ™¯ 3ï¼šæ¨¡å—é—´é€šä¿¡

**è§¦å‘æ¡ä»¶**ï¼š

- åœ¨ä¸€ä¸ªæ¨¡å—ä¸­å¼•ç”¨å¦ä¸€ä¸ªæ¨¡å—
- åœ¨ Handler ä¸­è°ƒç”¨å…¶ä»–æ¨¡å—çš„ä»£ç 
- éœ€è¦è·¨æ¨¡å—ä¼ é€’æ•°æ®

**ä½ åº”è¯¥æé†’çš„çº¦æŸ**ï¼š

```
âœ… ä»…å…è®¸ä¸‰ç§æ¨¡å—é—´é€šä¿¡æ–¹å¼ï¼š

1. **é¢†åŸŸäº‹ä»¶ï¼ˆDomain Eventsï¼‰**
   - å¼‚æ­¥é€šä¿¡
   - å‘å¸ƒè€…ä¸çŸ¥é“è®¢é˜…è€…
   - ç¤ºä¾‹ï¼šOrderCreatedã€MemberRegistered

2. **æ•°æ®å¥‘çº¦ï¼ˆContractsï¼‰**
   - åªè¯»çš„ DTO
   - ä¸åŒ…å«ä¸šåŠ¡è¡Œä¸º
   - ç¤ºä¾‹ï¼šMemberDtoã€OrderSummaryDto

3. **åŸå§‹ç±»å‹**
   - æ ‡å‡†åº“ç±»å‹ï¼šintã€stringã€Guid
   - ç¤ºä¾‹ï¼šMemberIdï¼ˆas Guidï¼‰ã€OrderNumberï¼ˆas stringï¼‰

âŒ ç»å¯¹ç¦æ­¢ï¼š
- ç›´æ¥å¼•ç”¨å…¶ä»–æ¨¡å—çš„ Entity/Aggregate/ValueObject
- å…±äº«é¢†åŸŸæ¨¡å‹
- é€šè¿‡ Service å±‚è·¨æ¨¡å—è°ƒç”¨
- ä½¿ç”¨ Contracts é©±åŠ¨ä¸šåŠ¡å†³ç­–ï¼ˆCommand Handler ä¾èµ– Contractsï¼‰
```

---

### åœºæ™¯ 4ï¼šæ·»åŠ å…±äº«ä»£ç 

**è§¦å‘æ¡ä»¶**ï¼š

- åˆ›å»º BuildingBlocks æˆ–å…±äº«ç±»åº“
- å¤šä¸ªæ¨¡å—éœ€è¦ä½¿ç”¨ç›¸åŒçš„ä»£ç 

**ä½ åº”è¯¥æé†’çš„çº¦æŸ**ï¼š

```
âœ… æ£€æŸ¥æ¸…å•ï¼š
1. å…±äº«ä»£ç æ˜¯å¦æ˜¯**æŠ€æœ¯æ€§çš„**ï¼Œè€Œéä¸šåŠ¡æ€§çš„ï¼Ÿ
2. æ˜¯å¦æ”¾åœ¨ BuildingBlocks æˆ– Platform ä¸­ï¼Ÿ
3. æ˜¯å¦åªåŒ…å«é€šç”¨æŠ½è±¡ï¼Œä¸åŒ…å«ä¸šåŠ¡è§„åˆ™ï¼Ÿ

âŒ ç¦æ­¢ï¼š
- åœ¨ BuildingBlocks ä¸­æ”¾ç½®ä¸šåŠ¡è§„åˆ™
- åˆ›å»º"Shared Domain Model"
- Platform å±‚åŒ…å«ä¸šåŠ¡åˆ¤æ–­é€»è¾‘
```

---

## äºŒã€å“ªäº›å†™æ³•å¿…é¡»é˜»æ­¢ï¼Ÿ

### åæ¨¡å¼ 1ï¼šè·¨æ¨¡å—ç›´æ¥å¼•ç”¨å†…éƒ¨å®ç°

**âŒ é”™è¯¯ç¤ºä¾‹**ï¼š

```csharp
// åœ¨ Orders æ¨¡å—ä¸­
using Zss.BilliardHall.Modules.Members.Domain;

public class CreateOrderHandler
{
    public async Task Handle(CreateOrder command)
    {
        var member = await _memberRepository.GetByIdAsync(command.MemberId);
        // âŒ ç›´æ¥ä½¿ç”¨å…¶ä»–æ¨¡å—çš„ Entity
    }
}
```

**âœ… æ­£ç¡®åšæ³•**ï¼š

```csharp
// é€šè¿‡åŸå§‹ç±»å‹ä¼ é€’æ ‡è¯†
public class CreateOrderHandler
{
    public async Task Handle(CreateOrder command)
    {
        var memberId = command.MemberId; // Guid
        // âœ… åªä¼ é€’æ ‡è¯†ï¼Œä¸è®¿é—®å†…éƒ¨å®ç°
    }
}

// æˆ–é€šè¿‡å¥‘çº¦æŸ¥è¯¢æ•°æ®
public class CreateOrderHandler
{
    public async Task Handle(CreateOrder command)
    {
        var memberDto = await _queryBus.Send(new GetMemberById(command.MemberId));
        // âœ… é€šè¿‡å¥‘çº¦ï¼ˆDTOï¼‰è·å–æ•°æ®
    }
}
```

---

### åæ¨¡å¼ 2ï¼šåˆ›å»ºæ¨ªå‘ Service å±‚

**âŒ é”™è¯¯ç¤ºä¾‹**ï¼š

```csharp
// âŒ ä¸è¦åˆ›å»ºæ¨ªå‘ Service
public class OrderService
{
    public async Task CreateOrder(CreateOrderRequest request) { }
    public async Task CancelOrder(Guid orderId) { }
    public async Task UpdateOrder(UpdateOrderRequest request) { }
}

// âŒ ä¸è¦åœ¨å¤šä¸ª Use Case ä¸­å…±äº« Service
public class CreateOrderHandler
{
    private readonly OrderService _orderService;
    
    public async Task Handle(CreateOrder command)
    {
        await _orderService.CreateOrder(...);
    }
}
```

**âœ… æ­£ç¡®åšæ³•**ï¼š

```csharp
// âœ… æ¯ä¸ª Use Case æœ‰ç‹¬ç«‹çš„ Handler
public class CreateOrderHandler
{
    public async Task Handle(CreateOrder command)
    {
        // ä¸šåŠ¡é€»è¾‘ç›´æ¥åœ¨ Handler ä¸­
        var order = new Order(command.MemberId, command.Items);
        await _repository.SaveAsync(order);
    }
}

public class CancelOrderHandler
{
    public async Task Handle(CancelOrder command)
    {
        // ç‹¬ç«‹çš„ä¸šåŠ¡é€»è¾‘
        var order = await _repository.GetByIdAsync(command.OrderId);
        order.Cancel();
        await _repository.SaveAsync(order);
    }
}
```

---

### åæ¨¡å¼ 3ï¼šCommand Handler ä¾èµ– Contracts

**âŒ é”™è¯¯ç¤ºä¾‹**ï¼š

```csharp
// âŒ Command Handler ä¸åº”è¯¥ä¾èµ– Contracts è¿›è¡Œä¸šåŠ¡å†³ç­–
public class RechargeBalanceHandler
{
    public async Task Handle(RechargeBalance command)
    {
        var memberDto = await _queryBus.Send(new GetMemberById(command.MemberId));
        if (memberDto.Balance + command.Amount > 10000)
        {
            // âŒ åŸºäº DTO çš„æ•°æ®è¿›è¡Œä¸šåŠ¡åˆ¤æ–­
            throw new InvalidOperationException("ä½™é¢è¶…é™");
        }
    }
}
```

**âœ… æ­£ç¡®åšæ³•**ï¼š

```csharp
// âœ… Command Handler åº”è¯¥æ“ä½œé¢†åŸŸæ¨¡å‹
public class RechargeBalanceHandler
{
    public async Task Handle(RechargeBalance command)
    {
        var member = await _repository.GetByIdAsync(command.MemberId);
        member.Recharge(command.Amount); // âœ… ä¸šåŠ¡é€»è¾‘åœ¨é¢†åŸŸæ¨¡å‹ä¸­
        await _repository.SaveAsync(member);
    }
}
```

---

### åæ¨¡å¼ 4ï¼šPlatform å±‚åŒ…å«ä¸šåŠ¡è§„åˆ™

**âŒ é”™è¯¯ç¤ºä¾‹**ï¼š

```csharp
// âŒ Platform å±‚ä¸åº”è¯¥åŒ…å«ä¸šåŠ¡åˆ¤æ–­
public class PaymentValidator
{
    public bool ValidatePaymentAmount(decimal amount)
    {
        return amount > 0 && amount < 10000; // âŒ ä¸šåŠ¡è§„åˆ™
    }
}
```

**âœ… æ­£ç¡®åšæ³•**ï¼š

```csharp
// âœ… ä¸šåŠ¡è§„åˆ™æ”¾åœ¨æ¨¡å—å†…
// åœ¨ Payments æ¨¡å—ä¸­
public class Payment
{
    public void ValidateAmount(decimal amount)
    {
        if (amount <= 0 || amount > 10000)
        {
            throw new InvalidPaymentAmountException();
        }
    }
}
```

---

## ä¸‰ã€CI å¤±è´¥æ—¶ï¼Œä½ åº”è¯¥å¦‚ä½•è§£é‡Šï¼Ÿ

### å¤±è´¥æ¶ˆæ¯ï¼šæ¨¡å—é—´éæ³•ä¾èµ–

**CI è¾“å‡ºç¤ºä¾‹**ï¼š

```
âŒ Test Failed: Modules_Should_Not_Reference_Other_Modules
   Expected: No references from 'Orders' to 'Members'
   Actual: Found reference to 'Zss.BilliardHall.Modules.Members.Domain'
```

**ä½ åº”è¯¥è¿™æ ·è§£é‡Š**ï¼š

```
æ ¹æ® ADR-0001ï¼Œæ¨¡å—ä¹‹é—´ä¸å…è®¸ç›´æ¥å¼•ç”¨å†…éƒ¨å®ç°ã€‚

é—®é¢˜åˆ†æï¼š
- Orders æ¨¡å—å¼•ç”¨äº† Members æ¨¡å—çš„ Domain å±‚
- è¿™è¿åäº†æ¨¡å—éš”ç¦»åŸåˆ™

ä¿®å¤å»ºè®®ï¼š
1. ç§»é™¤å¯¹ Members.Domain çš„å¼•ç”¨
2. å¦‚æœéœ€è¦ä¼ é€’ MemberIdï¼Œä½¿ç”¨åŸå§‹ç±»å‹ï¼ˆGuidï¼‰
3. å¦‚æœéœ€è¦æŸ¥è¯¢ Member æ•°æ®ï¼Œé€šè¿‡ Contractsï¼ˆDTOï¼‰
4. å¦‚æœéœ€è¦é€šçŸ¥ Memberï¼Œå‘å¸ƒé¢†åŸŸäº‹ä»¶

ç¤ºä¾‹ä¿®å¤ï¼š
- åŸå§‹ç±»å‹ï¼šcommand.MemberIdï¼ˆGuidï¼‰
- å¥‘çº¦æŸ¥è¯¢ï¼šawait _queryBus.Send(new GetMemberById(memberId))
- é¢†åŸŸäº‹ä»¶ï¼šawait _eventBus.Publish(new OrderCreated(orderId, memberId))
```

---

### å¤±è´¥æ¶ˆæ¯ï¼šå‘ç°æ¨ªå‘ Service å±‚

**CI è¾“å‡ºç¤ºä¾‹**ï¼š

```
âŒ Test Failed: Modules_Should_Not_Have_Service_Layer
   Expected: No types ending with 'Service'
   Actual: Found 'OrderService' in Orders module
```

**ä½ åº”è¯¥è¿™æ ·è§£é‡Š**ï¼š

```
æ ¹æ® ADR-0001ï¼Œæ¨¡å—å†…ä¸å…è®¸åˆ›å»ºæ¨ªå‘ Service å±‚ã€‚

é—®é¢˜åˆ†æï¼š
- å‘ç° OrderServiceï¼Œè¿™è¿åäº†å‚ç›´åˆ‡ç‰‡æ¶æ„
- ä¸šåŠ¡é€»è¾‘åº”è¯¥åœ¨ Handler ä¸­ï¼Œè€ŒéæŠ½è±¡ä¸º Service

ä¿®å¤å»ºè®®ï¼š
1. åˆ é™¤ OrderService
2. å°†ä¸šåŠ¡é€»è¾‘åˆ†æ•£åˆ°å„ä¸ª Use Case çš„ Handler ä¸­
3. å¦‚æœæœ‰å…±äº«é€»è¾‘ï¼Œè€ƒè™‘ï¼š
   - æ”¾å…¥é¢†åŸŸæ¨¡å‹ï¼ˆEntity/ValueObjectï¼‰
   - åˆ›å»º BuildingBlocks ä¸­çš„æŠ€æœ¯æŠ½è±¡ï¼ˆéä¸šåŠ¡ï¼‰

ç¤ºä¾‹é‡æ„ï¼š
OrderService.CreateOrder() 
  â†’ CreateOrderHandler.Handle()
OrderService.CancelOrder() 
  â†’ CancelOrderHandler.Handle()
```

---

### å¤±è´¥æ¶ˆæ¯ï¼šPlatform å±‚åŒ…å«ä¸šåŠ¡é€»è¾‘

**CI è¾“å‡ºç¤ºä¾‹**ï¼š

```
âŒ Test Failed: Platform_Should_Not_Contain_Business_Logic
   Expected: No business-related types in Platform
   Actual: Found 'PaymentValidator' with business rules
```

**ä½ åº”è¯¥è¿™æ ·è§£é‡Š**ï¼š

```
æ ¹æ® ADR-0001ï¼ŒPlatform å±‚ä¸åº”è¯¥åŒ…å«ä¸šåŠ¡è§„åˆ™æˆ–åˆ¤æ–­ã€‚

é—®é¢˜åˆ†æï¼š
- PaymentValidator åŒ…å«ä¸šåŠ¡é‡‘é¢åˆ¤æ–­
- Platform å±‚åº”è¯¥åªæä¾›æŠ€æœ¯èƒ½åŠ›ï¼Œä¸æ„ŸçŸ¥ä¸šåŠ¡

ä¿®å¤å»ºè®®ï¼š
1. å°† PaymentValidator ç§»åˆ° Payments æ¨¡å—
2. Platform å±‚åªä¿ç•™æŠ€æœ¯æ€§éªŒè¯ï¼ˆå¦‚æ ¼å¼ã€éç©ºï¼‰
3. ä¸šåŠ¡è§„åˆ™åœ¨é¢†åŸŸæ¨¡å‹æˆ– Handler ä¸­å®ç°

ç¤ºä¾‹ä¿®å¤ï¼š
Platformï¼šåªéªŒè¯æŠ€æœ¯è§„åˆ™ï¼ˆéç©ºã€æ ¼å¼ï¼‰
Moduleï¼šéªŒè¯ä¸šåŠ¡è§„åˆ™ï¼ˆé‡‘é¢é™åˆ¶ã€çŠ¶æ€åˆ¤æ–­ï¼‰
```

---

## å››ã€Contracts è¯­ä¹‰çº¦æŸæ²»ç†ï¼ˆæ²»ç†è·¯çº¿å›¾ï¼‰

### èƒŒæ™¯

æ ¹æ® ADR-0001 ç¬¬ 6 èŠ‚ï¼Œ**Command Handler ä¸å¾—ä¾èµ– Contracts è¿›è¡Œä¸šåŠ¡å†³ç­–**ï¼Œè¿™æ˜¯å®ªæ³•å±‚çš„æ ¸å¿ƒçº¦æŸä¹‹ä¸€ã€‚

ç„¶è€Œï¼Œæ­¤çº¦æŸå±äº**è¯­ä¹‰çº§åˆ«**ï¼Œä»…é€šè¿‡é™æ€ç±»å‹ä¾èµ–æ£€æŸ¥ï¼ˆå¦‚ NetArchTestï¼‰æ— æ³•å®Œå…¨è¦†ç›–ã€‚ä¾‹å¦‚ï¼š

```csharp
// âœ… ç±»å‹ä¾èµ–æ£€æŸ¥é€šè¿‡ï¼ˆHandler æœªç›´æ¥ä¾èµ– Contractsï¼‰
// âŒ ä½†è¯­ä¹‰è¿è§„ï¼šé€šè¿‡ Query è·å–å¥‘çº¦å¹¶ç”¨äºä¸šåŠ¡å†³ç­–
public class CreateOrderHandler
{
    public async Task Handle(CreateOrder command)
    {
        var memberDto = await _queryBus.Send(new GetMemberById(command.MemberId));
        
        // âŒ è¯­ä¹‰è¿è§„ï¼šåŸºäºå¥‘çº¦æ•°æ®åšä¸šåŠ¡å†³ç­–
        if (memberDto.VipLevel > 3)
        {
            order.ApplyDiscount(10);
        }
    }
}
```

### æ²»ç†è·¯çº¿å›¾

**çŸ­æœŸï¼ˆå½“å‰ï¼‰**ï¼š

- **æ‰§è¡Œçº§åˆ«**ï¼šL2ï¼ˆè¯­ä¹‰åŠè‡ªåŠ¨ï¼Œéœ€äººå·¥è¯„å®¡ï¼‰
- **æ£€æµ‹æ–¹å¼**ï¼š
  - NetArchTest æ£€æµ‹ç±»å‹ä¾èµ–ï¼ˆå·²è‡ªåŠ¨åŒ–ï¼‰
  - Code Review ä¸­äººå·¥å®¡æŸ¥è¯­ä¹‰è¿è§„
  - Copilot é€šè¿‡æœ¬ Prompts æ–‡ä»¶æä¾›æ—©æœŸæé†’

**ä¸­æœŸï¼ˆè§„åˆ’ä¸­ï¼‰**ï¼š

- **å·¥å…·å»ºè®¾**ï¼šå¼€å‘ Roslyn Analyzer æ’ä»¶
- **æ£€æµ‹èƒ½åŠ›**ï¼š
  - æ£€æµ‹ Command Handler ä¸­è°ƒç”¨ `IQueryBus.Send<TDto>`
  - æ£€æµ‹å¥‘çº¦ç±»å‹ï¼ˆ`Contracts` å‘½åç©ºé—´ï¼‰åœ¨ä¸šåŠ¡å†³ç­–ä¸­çš„ä½¿ç”¨
  - æä¾› IDE å†…å®æ—¶è¯Šæ–­å’Œä»£ç ä¿®å¤å»ºè®®
- **æ‰§è¡Œçº§åˆ«**ï¼šå°†å‡çº§ä¸º **L1ï¼ˆé™æ€å¯æ‰§è¡Œï¼ŒCI å¿…é¡»é˜»æ–­ï¼‰**

**é•¿æœŸï¼ˆæŒç»­æ¼”è¿›ï¼‰**ï¼š

- æ‰©å±• Analyzer è¦†ç›–æ›´å¤šè¯­ä¹‰çº¦æŸ
- é›†æˆåˆ° CI/CD æµç¨‹çš„æ›´æ—©é˜¶æ®µï¼ˆå¦‚ PR æäº¤å‰æœ¬åœ°æ£€æŸ¥ï¼‰
- ç§¯ç´¯æœ€ä½³å®è·µå’Œåæ¨¡å¼åº“

### å‡çº§æ¡ä»¶

**ä¸€æ—¦ Roslyn Analyzer å·¥å…·å°±ç»ªå¹¶éªŒè¯ç¨³å®šï¼Œæœ¬çº¦æŸå°†è‡ªåŠ¨å‡çº§ä¸º L1 å¼ºåˆ¶æ¡æ¬¾ï¼š**

- âœ… å·¥å…·èƒ½å‡†ç¡®è¯†åˆ« 90% ä»¥ä¸Šçš„è¿è§„æ¨¡å¼
- âœ… è¯¯æŠ¥ç‡ä½äº 5%
- âœ… å›¢é˜Ÿå®Œæˆå·¥å…·ä½¿ç”¨åŸ¹è®­
- ğŸš¨ å‡çº§åï¼ŒCI æ„å»ºå°†å¯¹æ­¤ç±»è¿è§„ç›´æ¥å¤±è´¥ï¼Œä¸æ¥å—ç ´ä¾‹

### å½“å‰æœ€ä½³å®è·µ

åœ¨ Roslyn Analyzer å°±ç»ªä¹‹å‰ï¼Œè¯·éµå¾ªä»¥ä¸‹å®è·µï¼š

**Command Handler ä¸­ï¼š**

```csharp
// âœ… æ­£ç¡®ï¼šåªä¼ é€’æ ‡è¯†ï¼ˆåŸå§‹ç±»å‹ï¼‰
public async Task Handle(CreateOrder command)
{
    var memberId = command.MemberId; // Guid
    var order = new Order(memberId, command.Items);
    // ä¸šåŠ¡é€»è¾‘åœ¨é¢†åŸŸæ¨¡å‹ä¸­
}

// âŒ é”™è¯¯ï¼šæŸ¥è¯¢å¥‘çº¦å¹¶ç”¨äºä¸šåŠ¡å†³ç­–
public async Task Handle(CreateOrder command)
{
    var memberDto = await _queryBus.Send(new GetMemberById(command.MemberId));
    if (memberDto.VipLevel > 3) { /* ä¸šåŠ¡å†³ç­– */ } // âŒ
}
```

**Query Handler ä¸­ï¼š**

```csharp
// âœ… æ­£ç¡®ï¼šQuery Handler å¯ä»¥è¿”å› Contracts
public async Task<OrderDto> Handle(GetOrderById query)
{
    var order = await _repository.GetByIdAsync(query.OrderId);
    return new OrderDto(order.Id, order.Total, order.Status);
}
```

### å‚è€ƒèµ„æ–™

- [ADR-0005 æ‰§è¡Œçº§åˆ«åˆ†ç±»](../adr/constitutional/ADR-0005-Enforcement-Levels.md)
- [ADR-0001 ç¬¬ 6 èŠ‚ï¼šContracts ä½¿ç”¨è§„åˆ™](../adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md#6-æ•°æ®å¥‘çº¦contractsä½¿ç”¨è§„åˆ™)

---

## äº”ã€å…¸å‹é—®ç­”ï¼ˆFAQï¼‰

### Q1: æˆ‘æƒ³åœ¨ Orders æ¨¡å—ä¸­è·å– Member çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ€ä¹ˆåšï¼Ÿ

**A:**
æ ¹æ® ADR-0001ï¼Œæœ‰ä¸¤ç§åˆè§„æ–¹å¼ï¼š

1. **é€šè¿‡ Contracts æŸ¥è¯¢**ï¼ˆæ¨èç”¨äºæŸ¥è¯¢åœºæ™¯ï¼‰ï¼š
   ```csharp
   var memberDto = await _queryBus.Send(new GetMemberById(memberId));
   // ä½¿ç”¨ memberDto.Nameã€memberDto.Email ç­‰
   ```

2. **é€šè¿‡åŸå§‹ç±»å‹ä¼ é€’æ ‡è¯†**ï¼ˆæ¨èç”¨äºå‘½ä»¤åœºæ™¯ï¼‰ï¼š
   ```csharp
   var orderId = command.MemberId; // åªä¼ é€’ Guid
   // ä¸éœ€è¦è®¿é—® Member çš„è¯¦ç»†ä¿¡æ¯
   ```

âŒ **ä¸å…è®¸**ï¼š

```csharp
// âŒ ç›´æ¥å¼•ç”¨ Members æ¨¡å—çš„ Entity
using Zss.BilliardHall.Modules.Members.Domain;
var member = await _memberRepository.GetByIdAsync(memberId);
```

---

### Q2: æˆ‘æœ‰ä¸€æ®µé€»è¾‘éœ€è¦åœ¨å¤šä¸ª Use Case ä¸­å…±äº«ï¼Œåº”è¯¥æ€ä¹ˆåšï¼Ÿ

**A:**
å–å†³äºé€»è¾‘çš„æ€§è´¨ï¼š

1. **ä¸šåŠ¡è§„åˆ™** â†’ æ”¾å…¥é¢†åŸŸæ¨¡å‹ï¼ˆEntity/ValueObjectï¼‰
   ```csharp
   public class Order
   {
       public void ApplyDiscount(decimal percentage)
       {
           // å…±äº«çš„ä¸šåŠ¡è§„åˆ™
       }
   }
   ```

2. **æŠ€æœ¯æŠ½è±¡** â†’ æ”¾å…¥ BuildingBlocks
   ```csharp
   // BuildingBlocks.Domain
   public interface IRepository<T> { }
   ```

3. **æ¨¡å—é—´å…±äº«** â†’ è€ƒè™‘æ˜¯å¦åº”è¯¥å…±äº«
  - å¦‚æœæ˜¯ä¸šåŠ¡è§„åˆ™ï¼Œ**ä¸åº”è¯¥è·¨æ¨¡å—å…±äº«**
  - å¦‚æœæ˜¯æ•°æ®æŸ¥è¯¢ï¼Œé€šè¿‡ Contracts

âŒ **ä¸å…è®¸**ï¼š

```csharp
// âŒ åˆ›å»ºæ¨ªå‘ Service
public class SharedOrderService { }
```

---

### Q3: ä»€ä¹ˆæ—¶å€™åº”è¯¥å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼Ÿ

**A:**
å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œåº”è¯¥å‘å¸ƒé¢†åŸŸäº‹ä»¶ï¼š

1. **æ¨¡å—éœ€è¦é€šçŸ¥å…¶ä»–æ¨¡å—**
2. **é€šçŸ¥æ˜¯å¼‚æ­¥çš„**ï¼ˆä¸éœ€è¦ç«‹å³å“åº”ï¼‰
3. **ä¸æ¶‰åŠè·¨æ¨¡å—çš„ä¸€è‡´æ€§ä¿éšœ**

ç¤ºä¾‹ï¼š

```csharp
// Orders æ¨¡å—
public class CreateOrderHandler
{
    public async Task Handle(CreateOrder command)
    {
        var order = new Order(command.MemberId, command.Items);
        await _repository.SaveAsync(order);
        
        // âœ… å‘å¸ƒäº‹ä»¶é€šçŸ¥å…¶ä»–æ¨¡å—
        await _eventBus.Publish(new OrderCreated(order.Id, order.MemberId));
    }
}

// Members æ¨¡å—è®¢é˜…äº‹ä»¶
public class OrderCreatedHandler
{
    public async Task Handle(OrderCreated @event)
    {
        // æ›´æ–°ä¼šå‘˜çš„è®¢å•ç»Ÿè®¡
    }
}
```

---

## å…­ã€å¿«é€Ÿæ£€æŸ¥æ¸…å•

åœ¨æäº¤ PR å‰ï¼Œè¯·å¯¹ç…§ä»¥ä¸‹æ¸…å•ï¼š

- [ ] æ¨¡å—æ˜¯å¦æŒ‰ä¸šåŠ¡èƒ½åŠ›åˆ’åˆ†ï¼Ÿ
- [ ] æ¨¡å—å†…éƒ¨æ˜¯å¦é‡‡ç”¨å‚ç›´åˆ‡ç‰‡ç»„ç»‡ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†è·¨æ¨¡å—ç›´æ¥å¼•ç”¨å†…éƒ¨å®ç°ï¼Ÿ
- [ ] æ˜¯å¦é¿å…äº†åˆ›å»ºæ¨ªå‘ Service å±‚ï¼Ÿ
- [ ] Command Handler æ˜¯å¦é¿å…ä¾èµ– Contracts è¿›è¡Œä¸šåŠ¡å†³ç­–ï¼Ÿ
- [ ] Platform å±‚æ˜¯å¦é¿å…åŒ…å«ä¸šåŠ¡è§„åˆ™ï¼Ÿ
- [ ] æ¨¡å—é—´é€šä¿¡æ˜¯å¦åªä½¿ç”¨ä¸‰ç§åˆè§„æ–¹å¼ï¼Ÿ
- [ ] æ¶æ„æµ‹è¯•æ˜¯å¦å…¨éƒ¨é€šè¿‡ï¼Ÿ

---

## ä¸ƒã€æµ‹è¯•è¦†ç›–è‡ªæ£€æ¸…å•

### 7.1 ADR-æµ‹è¯•æ˜ å°„è¡¨

åœ¨å®¡æŸ¥ä¸ ADR-0001 ç›¸å…³çš„ PR æ—¶ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹æ˜ å°„å…³ç³»ï¼ˆå¯¹åº” ADR-0001 v3.2ï¼‰ï¼š

| çº¦æŸç¼–å·       | æè¿°                | å±‚çº§    | æµ‹è¯•æ–¹æ³•                                               | æµ‹è¯•æ–‡ä»¶                           | çŠ¶æ€    |
|------------|-------------------|-------|----------------------------------------------------|--------------------------------|-------|
| ADR-0001.1 | æ¨¡å—ä¸å¯ç›¸äº’å¼•ç”¨          | L1    | `Modules_Should_Not_Reference_Other_Modules`       | ADR_0001_Architecture_Tests.cs | âœ… å·²å®ç° |
| ADR-0001.2 | é¡¹ç›®æ–‡ä»¶/ç¨‹åºé›†ç¦æ­¢å¼•ç”¨å…¶ä»–æ¨¡å—  | L1    | `Module_Csproj_Should_Not_Reference_Other_Modules` | ADR_0001_Architecture_Tests.cs | âœ… å·²å®ç° |
| ADR-0001.3 | å‚ç›´åˆ‡ç‰‡/ç”¨ä¾‹ä¸ºæœ€å°å•å…ƒ      | L2    | `Handlers_Should_Be_In_UseCases_Namespace`         | ADR_0001_Architecture_Tests.cs | âœ… å·²å®ç° |
| ADR-0001.4 | ç¦æ­¢æ¨ªå‘ Service æŠ½è±¡   | L1    | `Modules_Should_Not_Contain_Service_Classes`       | ADR_0001_Architecture_Tests.cs | âœ… å·²å®ç° |
| ADR-0001.5 | åªå…è®¸äº‹ä»¶/å¥‘çº¦/åŸå§‹ç±»å‹é€šä¿¡   | L2    | `Contract_Rules_Semantic_Check`                    | ADR_0001_Architecture_Tests.cs | âœ… å·²å®ç° |
| ADR-0001.6 | Contract ä¸å«ä¸šåŠ¡åˆ¤æ–­å­—æ®µ | L2/L3 | `Contract_Business_Field_Analyzer`                 | ADR_0001_Architecture_Tests.cs | âœ… å·²å®ç° |
| ADR-0001.7 | å‘½åç©ºé—´/ç›®å½•å¼ºåˆ¶éš”ç¦»       | L1    | `Namespace_Should_Match_Module_Boundaries`         | ADR_0001_Architecture_Tests.cs | âœ… å·²å®ç° |

**è¯´æ˜**ï¼š

- âœ… å·²å®ç°ï¼šæµ‹è¯•å·²å®Œæˆä¸”é€šè¿‡éªŒè¯ï¼ˆ13/13 tests passedï¼‰
- L1: é™æ€å¯æ‰§è¡Œè‡ªåŠ¨åŒ–ï¼ˆArchitectureTestsï¼‰ï¼ŒCI ç›´æ¥é˜»æ–­
- L2: è¯­ä¹‰åŠè‡ªåŠ¨ï¼ˆRoslyn/å¯å‘å¼ï¼‰ï¼Œéœ€äººå·¥è¯„å®¡é…åˆ
- L3: äººå·¥ Gateï¼Œcode review æŠŠå…³

**v3.2 å®Œæ•´å¯¹é½è¯´æ˜**ï¼š

- æ‰€æœ‰ 7 é¡¹æ ¸å¿ƒçº¦æŸéƒ½æœ‰å¯¹åº”æµ‹è¯•å®ç°
- æ—§çš„ 11 ä¸ªæµ‹è¯•å·²å®Œå…¨åˆ é™¤ï¼Œæ›¿æ¢ä¸ºç²¾ç¡®çš„ 7 ä¸ªæµ‹è¯•
- æµ‹è¯•ä»£ç ä» 300 è¡Œä¼˜åŒ–åˆ° 246 è¡Œ
- æ‰€æœ‰æµ‹è¯•é€šè¿‡éªŒè¯ï¼ˆPassed: 13, Failed: 0ï¼‰
- æµ‹è¯•æ–¹æ³•å‘½åå®Œå…¨ç¬¦åˆ ADR-0001 v3.2 æ ‡å‡†

### 7.2 è‡ªæ£€é—®é¢˜

å½“å®¡æŸ¥ä¸ ADR-0001 ç›¸å…³çš„ä»£ç å˜æ›´æ—¶ï¼Œè¯¢é—®è‡ªå·±ï¼š

1. âœ… **æ‰€æœ‰æ ‡è®°ä¸ºã€å¿…é¡»æ¶æ„æµ‹è¯•è¦†ç›–ã€‘çš„çº¦æŸæ˜¯å¦éƒ½æœ‰å¯¹åº”çš„æµ‹è¯•æ–¹æ³•ï¼Ÿ**
  - æ£€æŸ¥ ADR-0001 æ–‡æ¡£ä¸­æ‰€æœ‰ã€å¿…é¡»æ¶æ„æµ‹è¯•è¦†ç›–ã€‘æ ‡è®°
  - éªŒè¯æ˜¯å¦æ¯æ¡çº¦æŸéƒ½æœ‰å¯¹åº”çš„æµ‹è¯•

2. âœ… **æµ‹è¯•æ–¹æ³•åæ˜¯å¦æ¸…æ™°åæ˜ äº† ADR çº¦æŸå†…å®¹ï¼Ÿ**
  - æµ‹è¯•æ–¹æ³•ååº”åŒ…å« ADR å¼•ç”¨ï¼ˆå¦‚ `ADR_0001`ï¼‰
  - DisplayName åº”æ˜ç¡®è¯´æ˜éªŒè¯çš„çº¦æŸ

3. âœ… **æµ‹è¯•å¤±è´¥æ¶ˆæ¯æ˜¯å¦åŒ…å« ADR ç¼–å·å’Œä¿®å¤å»ºè®®ï¼Ÿ**
  - æ ¼å¼ï¼š`âŒ ADR-0001 è¿è§„ï¼š{çº¦æŸæè¿°}`
  - å¿…é¡»æä¾›å…·ä½“çš„ä¿®å¤å»ºè®®å’Œå‚è€ƒæ–‡æ¡£

4. âœ… **å¦‚æœ ADR æ–°å¢äº†çº¦æŸï¼Œæ˜¯å¦åŒæ­¥æ–°å¢äº†æµ‹è¯•ï¼Ÿ**
  - ADR æ–‡æ¡£å˜æ›´åº”åŒæ­¥æµ‹è¯•å˜æ›´
  - åœ¨ PR ä¸­æ£€æŸ¥æµ‹è¯•è¦†ç›–æ˜¯å¦å®Œæ•´

5. âœ… **æµ‹è¯•å†…å®¹æ˜¯å¦çœŸæ­£éªŒè¯äº† ADR çš„è¯­ä¹‰çº¦æŸï¼Ÿ**
  - é¿å…ä»…æµ‹è¯•å½¢å¼ï¼ˆå¦‚å‘½åï¼‰è€Œå¿½ç•¥è¯­ä¹‰
  - ç¡®ä¿æµ‹è¯•èƒ½æ•è·çœŸå®çš„è¿è§„åœºæ™¯

### 7.3 å¦‚ä½•ç¼–å†™ç¬¦åˆæ˜ å°„è¦æ±‚çš„æµ‹è¯•

#### ç¤ºä¾‹ 1ï¼šæ¨¡å—éš”ç¦»æµ‹è¯•

```csharp
/// <summary>
/// ADR-0001.1: éªŒè¯æ¨¡å—ä¸å¾—ç›¸äº’å¼•ç”¨ï¼ˆç¨‹åºé›†çº§ä¾èµ–ï¼‰
/// </summary>
[Theory(DisplayName = "ADR-0001.1: æ¨¡å—ä¸åº”ç›¸äº’å¼•ç”¨")]
[ClassData(typeof(ModuleAssemblyData))]
public void Modules_Should_Not_Reference_Other_Modules(Assembly moduleAssembly)
{
    var moduleName = moduleAssembly.GetName().Name!.Split('.').Last();
    
    foreach (var other in ModuleAssemblyData.ModuleNames.Where(m => m != moduleName))
    {
        var result = Types.InAssembly(moduleAssembly)
            .ShouldNot()
            .HaveDependencyOn($"Zss.BilliardHall.Modules.{other}")
            .GetResult();

        Assert.True(result.IsSuccessful,
            $"âŒ ADR-0001.1 è¿è§„: æ¨¡å— {moduleName} ä¸åº”ä¾èµ–æ¨¡å— {other}ã€‚\n" +
            $"è¿è§„ç±»å‹: {string.Join(", ", result.FailingTypes?.Select(t => t.FullName))}ã€‚\n" +
            $"ä¿®å¤å»ºè®®ï¼š\n" +
            $"  1. ä½¿ç”¨é¢†åŸŸäº‹ä»¶è¿›è¡Œå¼‚æ­¥é€šä¿¡\n" +
            $"  2. ä½¿ç”¨æ•°æ®å¥‘çº¦è¿›è¡Œåªè¯»æŸ¥è¯¢\n" +
            $"  3. ä¼ é€’åŸå§‹ç±»å‹ï¼ˆGuidã€stringï¼‰è€Œéé¢†åŸŸå¯¹è±¡\n" +
            $"å‚è€ƒï¼šdocs/copilot/adr-0001.prompts.md åœºæ™¯ 3");
    }
}
```

**è¦ç‚¹è¯´æ˜**ï¼š

- âœ… DisplayName æ˜ç¡®æ ‡æ³¨ `ADR-0001.1`
- âœ… æµ‹è¯•æ–¹æ³•åæ¸…æ™°è¡¨è¾¾çº¦æŸå†…å®¹
- âœ… å¤±è´¥æ¶ˆæ¯åŒ…å« ADR ç¼–å·ã€è¿è§„è¯¦æƒ…å’Œå…·ä½“ä¿®å¤å»ºè®®
- âœ… æä¾›å‚è€ƒæ–‡æ¡£é“¾æ¥

#### ç¤ºä¾‹ 2ï¼šç¦æ­¢ Service å±‚æµ‹è¯•

```csharp
/// <summary>
/// ADR-0001.4: éªŒè¯æ¨¡å—å†…ç¦æ­¢åˆ›å»ºæ¨ªå‘ Service å±‚
/// </summary>
[Theory(DisplayName = "ADR-0001.4: æ¨¡å—ä¸åº”åŒ…å« Service ç±»")]
[ClassData(typeof(ModuleAssemblyData))]
public void Modules_Should_Not_Contain_Service_Classes(Assembly moduleAssembly)
{
    var result = Types.InAssembly(moduleAssembly)
        .That().ResideInNamespaceStartingWith("Zss.BilliardHall.Modules")
        .And().AreClasses()
        .ShouldNot().HaveNameEndingWith("Service")
        .GetResult();

    Assert.True(result.IsSuccessful,
        $"âŒ ADR-0001.4 è¿è§„: æ¨¡å— {moduleAssembly.GetName().Name} åŒ…å« Service ç±»ã€‚\n" +
        $"è¿è§„ç±»å‹: {string.Join(", ", result.FailingTypes?.Select(t => t.FullName))}ã€‚\n" +
        $"ä¿®å¤å»ºè®®ï¼š\n" +
        $"  1. å°†ä¸šåŠ¡é€»è¾‘ç§»åˆ°å¯¹åº”çš„ Handler ä¸­\n" +
        $"  2. å¦‚æœæ˜¯æŠ€æœ¯æ€§åŠŸèƒ½ï¼Œç§»è‡³ Platform/BuildingBlocks\n" +
        $"  3. é‡‡ç”¨å‚ç›´åˆ‡ç‰‡æ¶æ„ï¼Œæ¯ä¸ªç”¨ä¾‹æœ‰ç‹¬ç«‹çš„ Handler\n" +
        $"å‚è€ƒï¼šdocs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md ç¬¬ 2 èŠ‚");
}
```

### 7.4 éªŒè¯è„šæœ¬

åœ¨æäº¤ PR å‰ï¼Œè¿è¡Œ ADR-æµ‹è¯•æ˜ å°„éªŒè¯è„šæœ¬ï¼š

```bash
# Bash
./scripts/validate-adr-test-mapping.sh

# PowerShell
./scripts/validate-adr-test-mapping.ps1
```

è„šæœ¬ä¼šè‡ªåŠ¨æ£€æŸ¥ï¼š

- ADR æ–‡æ¡£ä¸­æ‰€æœ‰ã€å¿…é¡»æ¶æ„æµ‹è¯•è¦†ç›–ã€‘çš„çº¦æŸ
- æµ‹è¯•ä»£ç ä¸­çš„ ADR å¼•ç”¨
- æ˜ å°„å…³ç³»çš„å®Œæ•´æ€§

### 7.5 æ›´æ–°æç¤º

å½“ ADR-0001 çš„çº¦æŸå‘ç”Ÿå˜åŒ–æ—¶ï¼Œ**å¿…é¡»åŒæ­¥æ›´æ–°**ï¼š

1. **ADR æ–‡æ¡£**ï¼š
  - ä¸ºæ–°å¢çº¦æŸæ·»åŠ ã€å¿…é¡»æ¶æ„æµ‹è¯•è¦†ç›–ã€‘æ ‡è®°
  - æ›´æ–°å¿«é€Ÿå‚è€ƒè¡¨çš„æµ‹è¯•è¦†ç›–åˆ—

2. **æ¶æ„æµ‹è¯•**ï¼š
  - æ–°å¢æˆ–ä¿®æ”¹å¯¹åº”çš„æµ‹è¯•æ–¹æ³•
  - æ›´æ–°æµ‹è¯•ç±»å¤´éƒ¨çš„æ˜ å°„æ¸…å•æ³¨é‡Š

3. **Prompts æ–‡ä»¶**ï¼ˆæœ¬æ–‡ä»¶ï¼‰ï¼š
  - æ›´æ–° 7.1 èŠ‚çš„æ˜ å°„è¡¨
  - æ·»åŠ æ–°çº¦æŸçš„æµ‹è¯•ç¤ºä¾‹

4. **éªŒè¯**ï¼š
  - è¿è¡Œ `./scripts/validate-adr-test-mapping.sh`
  - è¿è¡Œ `dotnet test src/tests/ArchitectureTests/`
  - ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡

---

## å…«ã€ç›¸å…³èµ„æº

- [ADR-0001 å®Œæ•´æ–‡æ¡£](../adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md)
- [æ¶æ„æµ‹è¯•ç±»](../../src/tests/ArchitectureTests/ADR/ADR_0001_Architecture_Tests.cs)
- [ADR-0005 åº”ç”¨å†…äº¤äº’æ¨¡å‹](../adr/constitutional/ADR-0005-Application-Interaction-Model-Final.md)
- [å‚ç›´åˆ‡ç‰‡æ¶æ„å‚è€ƒ](https://www.jimmybogard.com/vertical-slice-architecture/)

---

## ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬  | æ—¥æœŸ         | å˜æ›´è¯´æ˜                                                         |
|-----|------------|--------------------------------------------------------------|
| 1.4 | 2026-01-23 | å®Œæˆ v3.2 å®Œæ•´å¯¹é½ï¼šå®ç°å…¨éƒ¨ 7 é¡¹æ ¸å¿ƒçº¦æŸæµ‹è¯•ï¼Œåˆ é™¤æ—§æµ‹è¯•ï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡éªŒè¯                   |
| 1.3 | 2026-01-23 | å¯¹é½ ADR-0001 v3.2ï¼šæ›´æ–°æµ‹è¯•æ˜ å°„è¡¨ï¼ŒåŒ¹é…æ–°çš„ 7 é¡¹çº¦æŸç¼–å·å’Œæ‰§è¡Œçº§åˆ«                   |
| 1.2 | 2026-01-23 | æ–°å¢"Contracts è¯­ä¹‰çº¦æŸæ²»ç†ï¼ˆæ²»ç†è·¯çº¿å›¾ï¼‰"ç« èŠ‚ï¼Œè¯´æ˜ Roslyn Analyzer å·¥å…·è§„åˆ’ï¼›è°ƒæ•´ç« èŠ‚ç¼–å· |
| 1.1 | 2026-01-23 | æ–°å¢"æµ‹è¯•è¦†ç›–è‡ªæ£€æ¸…å•"ç« èŠ‚ï¼Œè¡¥å…… ADR-æµ‹è¯•æ˜ å°„è¦æ±‚                                 |
| 1.0 | 2026-01-21 | åˆå§‹ç‰ˆæœ¬                                                         |
