# ADR-0008 Copilot Prompts：文档编写与维护

> ⚖️ **权威声明**：本文件仅为辅助理解 ADR-0008 的场景化示例，**不具备裁决权**。
>
> **所有架构判定必须基于 [ADR-0008 正文](../adr/constitutional/ADR-0008-documentation-governance-constitution.md)。**

**版本**：1.0  
**对应 ADR**：ADR-0008（文档编写与维护宪法）  
**最后更新**：2026-01-25

---

## 一、什么时候参考本文件

### ✅ 应该参考的场景

- 需要创建或修改任何类型的文档（ADR、README、Guide、Prompts、Instructions、Skills）
- 不确定某个内容应该写在哪种文档中
- 文档之间出现冲突，需要判断优先级
- 需要理解各类文档的权限边界
- Review PR 时检查文档是否越界

### ❌ 不应依赖的场景

- 架构裁决（必须参考相关 ADR 正文）
- 最终判定文档是否合规（以 ADR-0008 正文为准）
- 文档分级的权威定义（参考 ADR-0008 决策 1）

---

## 二、核心概念速查

### 文档分级与裁决力（ADR-0008 决策 1）

```
文档层级从高到低：

1. 宪法级（ADR）
   裁决力：最高
   权限：定义规则、明确约束、裁决冲突
   示例：ADR-0001、ADR-0005
   ✅ 可以：定义"必须"/"禁止"
   ❌ 不可：包含操作步骤、示例代码细节

2. 治理级（Instructions/Agents）
   裁决力：中
   权限：定义流程、行为规范
   示例：copilot-instructions.md
   ✅ 可以：解释如何应用 ADR
   ❌ 不可：覆盖或弱化 ADR

3. 执行级（Skills）
   裁决力：低（仅事实）
   权限：输出事实
   示例：scan-cross-module-refs
   ✅ 可以：报告"模块 A 引用模块 B"
   ❌ 不可：判断"违规"或"合规"

4. 说明级（README/Guide）
   裁决力：无
   权限：解释使用方法
   示例：docs/*.md
   ✅ 可以：操作步骤、示例代码
   ❌ 不可：定义架构规则
```

### 冲突裁决优先级

```
ADR 正文 > Instructions > Agents > Skills > Prompts > README/Guide
```

**规则**：发现冲突时，必须修正低优先级文档。

---

## 三、常见场景与示例

### 场景 1：在 README 中定义了架构规则

#### ❌ 错误示例

**文件**：`docs/modules/Orders/README.md`

```markdown
## 架构规则

模块必须使用事件通信，禁止直接引用其他模块。

所有 Handler 必须是 Scoped 生命周期。
```

**问题**：

- README 属于说明级文档，无裁决力
- 定义了"必须"/"禁止"规则，越界行为
- 违反 ADR-0008.2（文档内容边界）

#### ✅ 正确示例

**文件**：`docs/modules/Orders/README.md`

```markdown
> ⚠️ **无裁决力声明**：本文档仅供参考，不具备架构裁决权。
> 所有架构决策以相关 ADR 正文为准。

## 架构说明

本模块遵循以下 ADR：
- [ADR-0001](../../adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md)：模块隔离
- [ADR-0005](../../adr/constitutional/ADR-0005-Application-Interaction-Model-Final.md)：Handler 模式

关于模块通信的具体规则，请参考 ADR-0001 第 3.2 节。
```

**为什么正确**：

- 明确声明无裁决力
- 只解释如何应用 ADR，不定义规则
- 引用 ADR 正文作为权威依据

---

### 场景 2：Skill 输出了判断性结论

#### ❌ 错误的 Skill 输出

**文件**：`src/skills/module-boundary-check/output.md`

```markdown
## 检查结果

❌ 违规：模块 Orders 不应引用模块 Members

建议：使用领域事件替代直接引用

根据 ADR-0001，这是明确的架构违规。
```

**问题**：

- Skill 只能输出事实，不能输出判断
- 使用了"违规"、"建议"等判断性词汇
- 解释了 ADR，越界行为
- 违反 ADR-0008 决策 3.2

#### ✅ 正确的 Skill 输出

**文件**：`src/skills/module-boundary-check/output.md`

```markdown
## 扫描结果

事实：模块 Orders 引用了模块 Members 的类型 Customer

位置：
- Orders/UseCases/CreateOrder/CreateOrderHandler.cs:15
- Orders/Domain/OrderAggregate.cs:42

引用链：
Orders.Domain.Order -> Members.Domain.Customer
```

**为什么正确**：

- 只输出事实（"引用了"）
- 不包含判断（"违规"、"建议"）
- 不解释 ADR
- 提供精确位置供人工判定

---

### 场景 3：Instructions 试图弱化 ADR 约束

#### ❌ 错误示例

**文件**：`.github/instructions/backend.instructions.md`

```markdown
## 模块通信

ADR-0001 规定模块间禁止直接引用，但在以下情况下可以例外：

- 性能关键路径
- 临时性代码
- 测试代码

建议开发者根据实际情况灵活处理。
```

**问题**：

- Instructions 试图修改 ADR 规则
- 发明了"例外"，ADR 未授权
- 使用"建议"弱化"禁止"
- 违反 ADR-0008 决策 3.1

#### ✅ 正确示例

**文件**：`.github/instructions/backend.instructions.md`

```markdown
## 权威依据

本文档服从以下 ADR：
- ADR-0001：模块隔离

**冲突裁决**：若本文档与 ADR 正文冲突，以 ADR 正文为准。

---

## 模块通信

根据 ADR-0001 第 3.2 节，模块间通信仅允许：

1. 领域事件（异步）
2. 数据契约（只读）
3. 原始类型（ID）

**禁止**直接引用其他模块的类型。

**破例流程**：如需破例，必须按 ADR-0000 的破例流程申请，记录在 ARCH-VIOLATIONS.md。

详见：[ADR-0001 正文](../docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md)
```

**为什么正确**：

- 显式声明服从 ADR
- 只解释如何应用，不修改规则
- 指引破例流程，不自行授权
- 引用 ADR 正文作为权威

---

### 场景 4：ADR 中包含了操作步骤

#### ❌ 错误的 ADR 内容

**文件**：`docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md`

```markdown
## 如何创建新模块

1. 在 `src/Modules/` 下创建新文件夹
2. 运行命令：`dotnet new classlib -n YourModule`
3. 添加必要的依赖包
4. 创建 `UseCases/` 目录
5. 创建第一个用例：
   ```csharp
   public class CreateOrder : ICommand
   {
       // ...
   }
   ```
```

**问题**：

- ADR 包含了操作步骤（应在 Guide 中）
- 包含了示例代码实现细节
- ADR 应该只回答"是否允许、为什么、如何裁决"
- 违反 ADR-0008 决策 2.2

#### ✅ 正确的 ADR 内容

**文件**：`docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md`

```markdown
## 规则本体（Rule）

### 模块组织规则

**必须**：

- ✅ 每个模块必须位于 `src/Modules/{ModuleName}/` 目录
- ✅ 每个模块必须包含 `UseCases/` 目录
- ✅ 每个用例必须实现 `ICommand` 或 `IQuery` 接口

**禁止**：

- ❌ 模块间直接引用其他模块的类型
- ❌ 跨模块共享领域模型

> 操作指南参见：[模块创建指南](../../guides/module-creation-guide.md)
```

**为什么正确**：

- 只定义规则（必须/禁止）
- 不包含操作步骤
- 引用外部 Guide 获取操作说明
- 符合"ADR 只立法"原则

**配套 Guide**：

**文件**：`docs/guides/module-creation-guide.md`

```markdown
> ⚠️ **无裁决力声明**：本文档仅供参考，不具备架构裁决权。
> 所有架构决策以 [ADR-0001](../adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md) 为准。

## 如何创建新模块

### 步骤 1：创建模块目录

```bash
cd src/Modules/
mkdir YourModule
cd YourModule
dotnet new classlib -n Zss.BilliardHall.Modules.YourModule
```

### 步骤 2：添加依赖

编辑 `YourModule.csproj`...

（详细步骤）
```

---

### 场景 5：Prompts 文件与 ADR 正文冲突

#### 问题场景

**ADR-0001 正文**（权威）：

```markdown
模块间**禁止**直接引用，无例外。
```

**adr-0001.prompts.md**（辅导材料）：

```markdown
在测试代码中可以直接引用其他模块，以便快速验证。
```

#### 处理方式

```markdown
## 冲突检测

发现冲突：
- ADR-0001 正文：禁止直接引用（无例外）
- adr-0001.prompts.md：允许测试代码例外

裁决：以 ADR-0001 正文为准

处理：修正 adr-0001.prompts.md，删除错误建议
```

**修正后的 Prompts**：

```markdown
> ⚖️ **权威声明**：本文件仅为辅助理解，若与 ADR-0001 正文冲突，以正文为准。

## 测试中的模块引用

根据 ADR-0001，模块间禁止直接引用，**测试代码也不例外**。

测试中访问其他模块数据，应该通过：
- 契约查询（只读）
- 测试专用的 Test Fixture（不包含业务逻辑）

详见：[ADR-0001 第 3.2 节](../adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md#32-模块通信约束)
```

---

## 四、文档编写检查清单

### 创建 ADR 时

- [ ] 包含状态、级别、聚焦内容、术语表、核心决策
- [ ] 只使用裁决性语言（必须、禁止、允许）
- [ ] 不包含"建议"、"推荐"、"通常"等模糊词汇
- [ ] 不包含操作步骤和示例代码实现细节
- [ ] 定义了执法模型（如何验证）
- [ ] 明确了破例条件和归还机制

### 创建 Instructions/Agents 时

- [ ] 显式声明所服从的 ADR 编号
- [ ] 包含冲突裁决声明
- [ ] 只解释如何应用 ADR，不定义新规则
- [ ] 不覆盖或弱化 ADR 约束
- [ ] 引用 ADR 正文作为权威依据

### 创建 Skills 时

- [ ] 只输出事实，不输出判断
- [ ] 不使用"违规"、"合规"、"建议"等判断性词汇
- [ ] 不解释 ADR
- [ ] 提供精确位置供人工判定
- [ ] 不包含"推荐"或"修复方案"

### 创建 README/Guide 时

- [ ] 在首部包含"无裁决力声明"
- [ ] 只解释使用方法，不定义架构规则
- [ ] 引用相关 ADR 作为权威依据
- [ ] 可以包含操作步骤和示例代码
- [ ] 不使用"必须"、"禁止"等裁决性语言

---

## 五、PR Review 时的检查点

### 检查 ADR 变更

- [ ] 是否遵循 ADR 模板
- [ ] 是否只使用裁决性语言
- [ ] 是否包含操作步骤（应移除）
- [ ] 是否定义了执法机制
- [ ] 是否需要架构委员会审批（宪法层）

### 检查 Instructions/Agents 变更

- [ ] 是否包含权威依据声明
- [ ] 是否引入了新规则（应拒绝）
- [ ] 是否弱化了 ADR 约束（应拒绝）
- [ ] 是否与 ADR 正文冲突（应修正）

### 检查 README/Guide 变更

- [ ] 是否包含"无裁决力声明"
- [ ] 是否使用了裁决性语言（应改为解释性）
- [ ] 是否定义了架构规则（应移除）
- [ ] 是否引用了相关 ADR

### 检查文档冲突

- [ ] 是否有多个文档定义同一规则
- [ ] 冲突是否已按优先级裁决
- [ ] 低优先级文档是否已修正

---

## 六、常见错误与修正

### 错误 1：README 定义架构规则

```markdown
❌ 错误：模块必须使用事件通信

✅ 修正：根据 ADR-0001，模块使用事件通信。详见：[ADR-0001](link)
```

### 错误 2：Skill 输出判断

```markdown
❌ 错误：违规：模块 A 引用模块 B

✅ 修正：事实：模块 A 引用了模块 B 的类型 Customer
        位置：A/Handler.cs:15
```

### 错误 3：Instructions 发明例外

```markdown
❌ 错误：性能关键路径可以直接引用

✅ 修正：如需破例，必须按 ADR-0000 流程申请，记录在 ARCH-VIOLATIONS.md
```

### 错误 4：ADR 包含操作步骤

```markdown
❌ 错误：运行 `dotnet new classlib`...

✅ 修正：每个模块必须是独立的 .NET 项目
        操作指南参见：[模块创建指南](link)
```

### 错误 5：Prompts 覆盖 ADR 语义

```markdown
❌ 错误：虽然 ADR 说禁止，但实际可以...

✅ 修正：根据 ADR-XXXX 第 X 节，此行为被禁止。
```

---

## 七、快速决策流程

### 我该把内容写在哪里？

```
内容是定义规则？
  ├─ 是 → 写在 ADR
  └─ 否 → 继续

内容是行为规范或流程？
  ├─ 是 → 写在 Instructions/Agents
  └─ 否 → 继续

内容是事实扫描结果？
  ├─ 是 → 写在 Skills
  └─ 否 → 继续

内容是操作步骤或示例？
  ├─ 是 → 写在 README/Guide
  └─ 否 → 重新思考内容定位
```

### 我该如何表达？

```
我在写 ADR？
  └─ 使用：必须、禁止、允许
     避免：建议、推荐、通常

我在写 Instructions/Agents？
  └─ 使用：根据 ADR-XXXX，应该...
     避免：定义新规则

我在写 Skills？
  └─ 使用：事实：X 引用了 Y
     避免：违规、合规、建议

我在写 README/Guide？
  └─ 使用：操作步骤、示例代码
     避免：必须、禁止
```

---

## 八、参考资料

- [ADR-0008 正文](../adr/constitutional/ADR-0008-documentation-governance-constitution.md)（权威）
- [ADR-0006：术语与编号宪法](../adr/constitutional/ADR-0006-terminology-numbering-constitution.md)
- [ADR-0007：Agent 行为与权限宪法](../adr/constitutional/ADR-0007-agent-behavior-permissions-constitution.md)
- [ADR 模板](../templates/adr-template.md)
- [Copilot Prompts 模板](../templates/copilot-prompts-template.md)

---

## 九、核心原则提醒

> **没有裁决权的文档，只能解释；拥有裁决权的文档，只能立法。**

- 📌 ADR 是系统的法律条文，不是架构师的解释说明
- 📌 文档不是"知识沉淀工具"，而是治理体系的一部分
- 📌 防止文档成为隐性规则源，是 ADR-0008 的核心目标
- 📌 唯一裁决权归属 ADR 正文，无例外

---

**维护**：架构委员会  
**最后审核**：2026-01-25  
**状态**：✅ Active
