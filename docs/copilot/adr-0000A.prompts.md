# ADR-0000A：ADR 新增与修订流程 - Copilot 提示词库

**版本**：1.0  
**最后更新**：2026-01-21  
**对应 ADR**：[ADR-0000A](../adr/ADR-0000A-adr-process.md)  

---

## 一、当我在写什么时，你应该提醒我哪些约束？

### 场景 1：开发者想创建新 ADR

**触发条件**：
- 开发者提出"我想创建一个 ADR 关于 XXX"
- 开发者询问"这个决策需要 ADR 吗"
- 开发者开始编写 ADR 文档

**你应该提醒**：

1. **判断 ADR 类型**
   ```
   请先判断这应该是：
   - 宪法层 ADR（ADR-0000~0005）- 影响系统基础结构
   - 普通 ADR（ADR-0006+）- 具体技术选型和实践
   
   判断标准：
   ✓ 是否影响系统的基础结构？
   ✓ 是否定义模块间的核心约束？
   ✓ 是否后续 ADR 都会依赖它？
   
   如果 3 个问题中有 2 个回答"是"，则为宪法层。
   ```

2. **完整的创建流程**
   ```
   根据 ADR-0000A，创建 ADR 需要：
   
   ✅ 第一步：提交 RFC（Request for Comments）
      - 创建 docs/rfc/RFC-XXXX-title.md
      - 使用标准 RFC 模板
   
   ✅ 第二步：审查与讨论
      - 宪法层：架构委员会全体一致，至少 2 周公示
      - 普通 ADR：Tech Lead/架构师审批
   
   ✅ 第三步：创建 ADR 文档
      - 使用标准 ADR 模板
      - 包含完整的结构（Focus, Glossary, Decision, etc.）
   
   ✅ 第四步：创建架构测试
      - src/tests/ArchitectureTests/ADR/ADR_XXXX_Architecture_Tests.cs
   
   ✅ 第五步：创建 Copilot Prompts
      - docs/copilot/adr-XXXX.prompts.md
   
   ✅ 第六步：Copilot 审查
   
   ✅ 第七步：提交 PR
   
   ✅ 第八步：合并与公告
   ```

3. **必须创建的配套文件**
   ```
   每个新 ADR 必须包含：
   1. ADR 文档本身（docs/adr/ADR-XXXX-xxx.md）
   2. 架构测试（src/tests/ArchitectureTests/ADR/ADR_XXXX_Architecture_Tests.cs）
   3. Copilot Prompts（docs/copilot/adr-XXXX.prompts.md）
   ```

### 场景 2：开发者想修订现有 ADR

**触发条件**：
- 开发者说"ADR-XXXX 有错误，我想修改"
- 开发者询问"如何更新 ADR"
- 开发者打开现有 ADR 进行编辑

**你应该提醒**：

1. **判断是否应该修订**
   ```
   先确认这是否真的需要修订 ADR：
   
   ✅ 应该修订：
   - 发现 ADR 中的歧义或错误
   - 需要补充细节或示例
   - 技术环境变化，需要调整决策
   
   ❌ 不应该修订：
   - 临时性破例 → 使用破例流程（ADR-0000）
   - 推翻核心决策 → 废弃旧 ADR，创建新 ADR
   ```

2. **修订权限**
   ```
   检查权限要求：
   
   - 宪法层 ADR（0000-0005）：
     ✓ 需要架构委员会全体一致同意
     ✓ 至少 2 周公示期
   
   - 普通 ADR（0006+）：
     ✓ Tech Lead 或架构师审批
     ✓ 无需公示期
   ```

3. **修订流程**
   ```
   1. 创建修订 Issue（宪法层）或直接 PR（普通）
   2. 更新 ADR 文档
   3. 更新架构测试（如需要）
   4. 更新 Copilot Prompts
   5. 在版本历史中记录变更
   6. Copilot 审查修订
   7. 提交 PR
   ```

### 场景 3：开发者问"这个决策需要 ADR 吗"

**触发条件**：
- 开发者描述一个技术决策
- 开发者不确定是否需要文档化
- 开发者询问 ADR 的适用范围

**你应该提醒**：

使用决策树判断：

```
这个决策是否影响多个模块或全局架构？
├─ 是 → ✅ 需要 ADR
└─ 否 → 这个决策是否会被其他开发者参考？
    ├─ 是 → ⚠️ 考虑创建 ADR
    └─ 否 → ❌ 不需要 ADR，可以在模块内文档化
```

**需要 ADR 的典型场景**：
- ✅ 引入新的架构约束
- ✅ 选择影响全局的技术方案
- ✅ 定义跨模块的协作规范
- ✅ 建立新的最佳实践

**不需要 ADR 的典型场景**：
- ❌ 单个模块内的实现细节
- ❌ 临时的技术试验
- ❌ 已有 ADR 的细化（更新现有 ADR）

---

## 二、哪些写法必须阻止？

### ❌ 反模式 1：跳过 RFC 直接创建 ADR

**错误示例**：
```
开发者："我直接写个 ADR 文档提交 PR"
```

**为什么错误**：
- RFC 是讨论和达成共识的过程
- 跳过 RFC 可能导致 ADR 质量不高
- 缺少公示和讨论，团队可能不理解

**✅ 正确做法**：
```
1. 先创建 RFC（docs/rfc/RFC-XXXX-title.md）
2. 在 GitHub Issues 中讨论
3. 达成共识后再创建正式 ADR
```

---

### ❌ 反模式 2：创建 ADR 但不创建架构测试

**错误示例**：
```markdown
# ADR-0010：新的架构约束

## 决策
模块间通信必须设置超时...

## 实施
请大家自觉遵守...
```

**为什么错误**：
- 没有自动化验证，约束无法强制执行
- 违反 ADR-0000 的要求（每条 ADR 必须有对应测试）
- 容易被遗忘或忽视

**✅ 正确做法**：
```csharp
// src/tests/ArchitectureTests/ADR/ADR_0010_Architecture_Tests.cs
public class ADR_0010_Architecture_Tests
{
    [Fact]
    public void AsyncCalls_Should_Have_Timeout_Configuration()
    {
        // 验证所有异步调用都配置了超时
        ...
    }
}
```

---

### ❌ 反模式 3：创建 ADR 但不创建 Copilot Prompts

**错误示例**：
只创建了 ADR 文档，没有对应的 Prompts 文件。

**为什么错误**：
- Copilot 无法有效参与这个 ADR 的执行
- 新人无法通过 Copilot 学习这个 ADR
- 违反 ADR-0000A 的要求

**✅ 正确做法**：
```markdown
# docs/copilot/adr-0010.prompts.md

## 一、当我在写什么时，你应该提醒我哪些约束？

[场景化的触发条件]

## 二、哪些写法必须阻止？

[反模式和正确模式对比]

## 三、CI 失败时，你应该如何解释？

[人话解释失败原因]
```

---

### ❌ 反模式 4：修订宪法层 ADR 时不遵循流程

**错误示例**：
```
开发者："ADR-0001 的某个规则不合理，我直接提 PR 改掉"
```

**为什么错误**：
- 宪法层 ADR 需要架构委员会全体一致同意
- 需要至少 2 周公示期
- 直接修订会破坏架构治理体系

**✅ 正确做法**：
```
1. 创建修订 Issue，说明修订理由
2. 架构委员会讨论（至少 2 周）
3. 全体一致同意后，才能提 PR
4. PR 中必须记录修订历史
```

---

### ❌ 反模式 5：删除废弃的 ADR

**错误示例**：
```bash
git rm docs/adr/ADR-0008-xxx.md
```

**为什么错误**：
- ADR 是历史记录，不应删除
- 未来可能需要查看历史决策
- 删除会丢失上下文

**✅ 正确做法**：
```markdown
# ADR-0008：[标题]

**状态**：❌ 已废弃  
**废弃日期**：2026-01-21  
**废弃理由**：[理由]  
**替代 ADR**：[ADR-0015](ADR-0015-xxx.md)  

> ⚠️ **废弃通知**
> 
> 本 ADR 已于 2026-01-21 废弃。
> 请参考新的 ADR-0015。

[原文档内容保留]
```

---

### ❌ 反模式 6：ADR 文档结构不完整

**错误示例**：
```markdown
# ADR-0010：超时策略

我们决定所有异步调用都要设置超时。

超时时间是 30 秒。
```

**为什么错误**：
- 缺少标准结构
- 没有术语表
- 没有说明与其他 ADR 的关系
- 没有快速参考表

**✅ 正确做法**：
```markdown
# ADR-0010：模块间异步通信超时策略

**状态**：✅ 已采纳  
**级别**：最佳实践  
**适用范围**：所有模块间异步通信  
**生效时间**：2026-01-21  

## 本章聚焦内容（Focus）

定义模块间异步通信的超时策略和配置规范。

## 术语表（Glossary）

| 术语 | 定义 |
|------|------|
| **超时（Timeout）** | 异步操作等待响应的最大时间 |
| **熔断（Circuit Breaker）** | 当失败率超过阈值时自动中断请求 |

## 决策（Decision）

所有模块间异步通信必须：
- ✅ 配置超时时间
- ✅ 处理超时异常
- ✅ 记录超时日志

禁止：
- ❌ 无限等待
- ❌ 忽略超时异常

## 与其他 ADR 关系（Related ADRs）

- **ADR-0001**：定义了模块隔离，本 ADR 细化异步通信的超时规范
- **ADR-0005**：定义了应用内交互模型，本 ADR 是其补充

## 快速参考表（Quick Reference）

| 通信类型 | 推荐超时时间 | 重试策略 |
|---------|-------------|---------|
| 查询 | 5-10 秒 | 不重试 |
| 命令 | 30 秒 | 重试 1 次 |
| 长操作 | 60 秒+ | 考虑异步化 |
```

---

## 三、CI 失败时，你应该如何解释？

### 场景 1：PR 中缺少架构测试

**CI 错误信息**：
```
Error: ADR-0010 requires corresponding architecture tests
File expected: src/tests/ArchitectureTests/ADR/ADR_0010_Architecture_Tests.cs
```

**人话解释**：
```
🔍 **问题诊断**

你创建了 ADR-0010，但没有创建对应的架构测试。

根据 ADR-0000A，每个新 ADR 必须有架构测试来自动验证约束。

📝 **修复步骤**

1. 创建测试文件：
   src/tests/ArchitectureTests/ADR/ADR_0010_Architecture_Tests.cs

2. 参考现有测试模式：
   - ADR_0001_Architecture_Tests.cs
   - ADR_0005_Architecture_Tests.cs

3. 如果需要帮助，询问：
   "为 ADR-0010 生成架构测试，验证：[列出需要验证的约束]"

📚 **参考资料**
- ADR-0000A: ADR 新增与修订流程
- ADR-0000: 架构测试与 CI 治理
```

---

### 场景 2：PR 中缺少 Copilot Prompts

**CI 错误信息**：
```
Error: ADR-0010 requires corresponding Copilot prompts
File expected: docs/copilot/adr-0010.prompts.md
```

**人话解释**：
```
🔍 **问题诊断**

你创建了 ADR-0010，但没有创建对应的 Copilot Prompts 文件。

根据 ADR-0000A，每个新 ADR 必须有 Prompts 文件，以便 Copilot 能够：
- 在开发时提醒约束
- 解释 CI 失败
- 回答开发者问题

📝 **修复步骤**

1. 创建 Prompts 文件：
   docs/copilot/adr-0010.prompts.md

2. 使用标准结构：
   - 一、当我在写什么时，你应该提醒我哪些约束？
   - 二、哪些写法必须阻止？
   - 三、CI 失败时，你应该如何解释？
   - 四、典型问答（FAQ）
   - 五、快速检查清单

3. 如果需要帮助，询问：
   "为 ADR-0010 生成 Copilot Prompts 文件"

📚 **参考资料**
- docs/copilot/adr-0001.prompts.md（参考示例）
- docs/templates/copilot-prompts-template.md（模板）
```

---

### 场景 3：尝试修订宪法层 ADR 但权限不足

**CI 错误信息**：
```
Error: Attempt to modify constitutional ADR (ADR-0001) without proper approval
Constitutional ADRs require unanimous approval from architecture committee
```

**人话解释**：
```
🔍 **问题诊断**

你尝试修订宪法层 ADR（ADR-0001），但没有经过正确的审批流程。

根据 ADR-0000A：
- 宪法层 ADR（ADR-0000~0005）的修订需要：
  ✓ 架构委员会全体一致同意
  ✓ 至少 2 周公示期
  ✓ 充分的理由和影响评估

📝 **正确流程**

1. **确认是否真的需要修订**
   - 如果是临时破例 → 使用破例流程（ADR-0000）
   - 如果是推翻决策 → 创建新 ADR 并废弃旧 ADR
   - 如果是修正错误 → 继续修订流程

2. **启动修订流程**
   - 创建修订 Issue，说明理由
   - 架构委员会讨论（至少 2 周）
   - 获得全体一致同意
   - 提交 PR，记录修订历史

3. **如果不是宪法层问题**
   - 考虑是否可以在普通 ADR 中补充细节
   - 或者在模块内文档化

📚 **参考资料**
- ADR-0000A: 修订 ADR 流程
- ADR-0000: 破例流程
```

---

## 四、典型问答（FAQ）

### Q1: 我想创建一个 ADR，但不知道从哪里开始

**A:** 使用这个清单：

```
✅ 第一步：确认需要 ADR
   询问："这个决策是否影响多个模块或全局架构？"

✅ 第二步：判断 ADR 类型
   询问："这应该是宪法层还是普通 ADR？"

✅ 第三步：创建 RFC
   使用 RFC 模板：docs/templates/rfc-template.md
   
✅ 第四步：询问 Copilot
   "我想创建一个 ADR 关于 [主题]，请帮我：
    1. 判断它应该是宪法层还是普通 ADR
    2. 生成 RFC 框架
    3. 列出需要考虑的关键点"
```

---

### Q2: ADR 编写过程中，Copilot 能帮我做什么？

**A:** Copilot 可以在多个阶段辅助：

| 阶段 | Copilot 能做什么 | 你可以这样问 |
|------|---------------|------------|
| **RFC 创建** | 生成 RFC 框架、识别关键问题 | "为 [主题] 生成 RFC 框架" |
| **ADR 编写** | 生成标准结构、补充术语表 | "基于 RFC-XXXX 生成 ADR 文档" |
| **测试生成** | 生成架构测试模板 | "为 ADR-XXXX 生成架构测试" |
| **Prompts 编写** | 生成 Prompts 文件 | "为 ADR-XXXX 生成 Prompts 文件" |
| **审查** | 检查文档质量和一致性 | "请审查 ADR-XXXX 草稿" |

**重要**：Copilot 是辅助工具，最终决策仍由人类做出。

---

### Q3: 我发现 ADR-XXXX 有错误，应该直接修改还是创建新 ADR？

**A:** 使用这个决策树：

```
错误的性质是？
├─ 文档表述错误（如错别字、歧义）
│  └─ → 直接修订 ADR，记录修订历史
│
├─ 决策本身有问题，但可以修正
│  └─ → 修订 ADR（遵循修订流程）
│
└─ 决策已过时，需要推翻
   └─ → 废弃旧 ADR，创建新 ADR
```

---

### Q4: 宪法层 ADR 和普通 ADR 的区别是什么？

**A:** 关键差异：

| 维度 | 宪法层 ADR | 普通 ADR |
|------|-----------|---------|
| **编号** | ADR-0000~0005 | ADR-0006+ |
| **影响** | 系统基础结构 | 具体技术选型 |
| **修订权限** | 架构委员会全体 | Tech Lead/架构师 |
| **公示期** | 至少 2 周 | 无 |
| **约束力** | 不可推翻 | 可废弃替代 |

**判断标准**（3 选 2）：
1. 是否影响系统的基础结构？
2. 是否定义模块间的核心约束？
3. 是否后续 ADR 都会依赖它？

---

### Q5: 我需要违反 ADR 怎么办？

**A:** 不要修订 ADR，而是：

```
1. 使用破例流程（ADR-0000）
   - PR 标题加 [ARCH-VIOLATION]
   - 填写破例说明和归还计划
   - 获得架构师批准

2. 如果经常需要破例
   - 说明 ADR 本身可能有问题
   - 考虑启动修订流程
   - 或者你的实现方式需要调整
```

---

## 五、快速检查清单

### 创建新 ADR 前的检查清单

使用此清单确保流程正确：

```markdown
## ADR 创建检查清单

### 前期准备
- [ ] 确认这个决策确实需要 ADR
- [ ] 判断 ADR 类型（宪法层 / 普通）
- [ ] 了解对应的审批流程

### RFC 阶段
- [ ] 创建 RFC 文档（docs/rfc/RFC-XXXX-title.md）
- [ ] RFC 包含完整的结构（Background, Problem, Proposal, etc.)
- [ ] 已提交 RFC Issue 到 GitHub
- [ ] 询问 Copilot 生成 RFC 框架（可选）

### 审查阶段
- [ ] 宪法层：架构委员会已开始讨论，公示至少 2 周
- [ ] 普通 ADR：已提交给 Tech Lead/架构师审查
- [ ] Copilot 已审查 RFC 并提供反馈
- [ ] 已根据反馈修订 RFC

### 文档创建
- [ ] ADR 文档结构完整（Focus, Glossary, Decision, etc.）
- [ ] 术语表定义了所有关键术语
- [ ] 决策部分包含允许和禁止内容
- [ ] 说明了与其他 ADR 的关系
- [ ] 提供了快速参考表

### 测试与 Prompts
- [ ] 创建了架构测试（ADR_XXXX_Architecture_Tests.cs）
- [ ] 测试覆盖了所有关键约束
- [ ] 创建了 Copilot Prompts 文件（adr-XXXX.prompts.md）
- [ ] Prompts 包含标准五个部分

### Copilot 审查
- [ ] Copilot 已审查 ADR 文档
- [ ] Copilot 已审查架构测试
- [ ] Copilot 已审查 Prompts 文件
- [ ] 已根据 Copilot 反馈修复问题

### PR 提交
- [ ] PR 标题清晰（feat(adr): Add ADR-XXXX）
- [ ] PR 描述包含 ADR 信息部分
- [ ] 已更新 ADR README（docs/adr/README.md）
- [ ] 所有测试通过

### 合并后
- [ ] 已公告团队
- [ ] 已准备培训材料（如需要）
- [ ] 已在团队频道分享
```

### 修订 ADR 时的检查清单

```markdown
## ADR 修订检查清单

### 前期判断
- [ ] 确认这确实需要修订（而非破例或创建新 ADR）
- [ ] 识别 ADR 类型（宪法层 / 普通）
- [ ] 了解修订权限要求

### 修订流程
- [ ] 宪法层：已创建修订 Issue 并开始讨论
- [ ] 宪法层：公示期至少 2 周
- [ ] 宪法层：获得架构委员会全体一致同意
- [ ] 普通 ADR：已通知 Tech Lead/架构师

### 文档更新
- [ ] 已更新 ADR 文档内容
- [ ] 已在版本历史中记录修订
- [ ] 如果结构变化，已更新相关部分
- [ ] 已更新架构测试（如需要）
- [ ] 已更新 Copilot Prompts（如需要）

### 审查
- [ ] Copilot 已审查修订内容
- [ ] 已评估对现有代码的影响
- [ ] 已评估对团队的影响

### PR 提交
- [ ] PR 标题说明修订（fix(adr): Update ADR-XXXX）
- [ ] PR 描述包含修订理由和影响评估
- [ ] 所有测试通过
```

---

## 六、与其他文档的关系

### 相关 ADR
- **ADR-0000**：定义架构测试要求，ADR-0000A 要求每个新 ADR 都有测试
- **所有 ADR**：ADR-0000A 定义了所有 ADR 的生命周期管理

### 相关 Instructions
- `.github/instructions/architecture-review.instructions.md`：在 PR Review 时检查 ADR 合规性
- `.github/instructions/documentation.instructions.md`：ADR 文档编写规范

### 相关 Templates
- `docs/templates/rfc-template.md`：RFC 模板
- `docs/templates/adr-template.md`：ADR 模板
- `docs/templates/copilot-prompts-template.md`：Prompts 模板

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| 1.0 | 2026-01-21 | 初始版本 |
