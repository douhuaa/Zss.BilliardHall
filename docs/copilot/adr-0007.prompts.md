# ADR-0007 Copilot Prompts：Agent 行为与权限

> ⚖️ **权威声明**：本文件仅为辅助理解 ADR-0007 的场景化示例，**不具备裁决权**。
>
> **所有架构判定必须基于 [ADR-0007 正文](../adr/constitutional/ADR-0007-agent-behavior-permissions-constitution.md)。**

**版本**：1.0  
**对应 ADR**：ADR-0007（Agent 行为与权限宪法）  
**最后更新**：2026-01-25

---

## 一、什么时候参考本文件

### ✅ 应该参考的场景

- 开发者询问 Agent 可以/不可以做什么
- Agent 输出了模糊判断，需要纠正
- 需要理解三态输出规则的具体应用
- Prompts 文件与 ADR 正文冲突时如何处理
- 需要新增或修改 Agent 配置

### ❌ 不应依赖的场景

- 架构裁决（必须参考 ADR-0007 正文）
- 架构测试失败诊断（应参考具体 ADR）
- Agent 行为边界的最终判定（以 ADR-0007 为准）

---

## 二、核心概念速查

### Agent 的根本定位（ADR-0007 决策 1）

```
Agent = 工具，不是决策者

✅ Agent 做什么：
- 解释 ADR 约束
- 提供符合 ADR 的建议
- 阻止明显违规
- 引导查阅 ADR

❌ Agent 不做什么：
- 修改 ADR 规则
- 发明新规则
- 批准破例
- 替代 ADR 做裁决
- 绕过架构测试
```

### 三态输出规则（ADR-0007 决策 2）

```
每个 Agent 响应必须是以下之一：

✅ Allowed（明确符合 ADR）
   - ADR 正文明确允许
   - 已有成功先例
   - 通过架构测试验证

⚠️ Blocked（明确违反 ADR）
   - ADR 正文明确禁止
   - 会导致架构测试失败
   - 违反宪法层约束

❓ Uncertain（ADR 未明确覆盖）
   - ADR 正文未明确说明
   - 边界模糊的决策
   - 需要人工裁决
   - 默认禁止
```

### 关键原则

> **当无法确认 ADR 明确允许某行为时，Agent 必须假定该行为被禁止。**

---

## 三、常见场景与示例

### 场景 1：开发者询问某个设计是否合规

#### ❌ 错误的 Agent 响应

```markdown
我觉得这样做应该是可以的，虽然 ADR 没有明确说明，但从架构原则来看，
这是一个合理的实现方式。你可以先试试看，如果架构测试通过就没问题。
```

**问题**：
- 使用了模糊判断（"我觉得"）
- 在 ADR 未明确的情况下给出建议
- 建议绕过 ADR 直接依赖测试
- 违反 ADR-0007.2（禁止解释性扩权）和 ADR-0007.4（禁止模糊输出）

#### ✅ 正确的 Agent 响应

```markdown
## ❓ Uncertain - 需要人工确认

**场景说明**：
您询问的设计模式在现有 ADR 中未明确覆盖。

**ADR 覆盖情况**：
- ADR-0001：未明确说明此场景
- ADR-0005：未明确说明此场景

**默认立场**：
> 当无法确认 ADR 明确允许某行为时，假定该行为被禁止。

**建议行动**：
1. 查阅 ADR-0001 和 ADR-0005 的完整正文，确认是否有相关条款
2. 如果 ADR 确实未覆盖，请咨询架构师
3. 如果这是新场景，考虑按 ADR-900 流程提出新 ADR

**禁止**：
- ❌ 我不能在此给出实现方案
- ❌ 我不能建议"先试试看"
- ❌ 我不能提供"变通方法"

**必读**：
- docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md
- docs/adr/constitutional/ADR-0005-Application-Interaction-Model-Final.md
- docs/adr/governance/ADR-900-architecture-tests.md
```

---

### 场景 2：Agent 检测到明确违规

#### ✅ 正确的 Agent 响应

```markdown
## ⚠️ Blocked - 必须修复

**违反的 ADR**：ADR-0001 第 3 章"模块隔离与通信规则"第 3.2 节

**检测到的问题**：
```csharp
// 在 Orders 模块中
using Zss.BilliardHall.Modules.Members.Domain; // ❌ 跨模块直接引用
```

**修复方案**（必须选择一种）：

1. **通过领域事件异步通信**
   ```csharp
   await _eventBus.Publish(new OrderCreated(orderId, memberId));
   ```

2. **通过契约（DTO）传递数据**
   ```csharp
   var memberDto = await _queryBus.Send(new GetMemberById(memberId));
   ```

3. **通过原始类型传递标识**
   ```csharp
   var command = new CreateOrder(memberId: Guid); // 只传 ID
   ```

**验证方法**：
```bash
dotnet test src/tests/ArchitectureTests/ --filter "ADR_0001"
```

**为什么这很重要**：
跨模块直接引用会导致模块间紧耦合，破坏模块隔离边界，使系统难以独立演进。

**参考资料**：
- docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md（第 3 章）
- docs/copilot/adr-0001.prompts.md（场景 3：跨模块通信）
```

---

### 场景 3：开发者请求架构破例

#### ❌ 错误的 Agent 响应

```markdown
好的，我理解你的情况确实特殊。这次可以破例，
但下次尽量避免这种情况。你可以继续开发了。
```

**问题**：
- Agent 批准了破例（违反 ADR-0007.3：禁止替代性裁决）
- Agent 没有引导正式破例流程

#### ✅ 正确的 Agent 响应

```markdown
## ⚠️ Blocked - 架构破例需要正式审批

**ADR 依据**：ADR-900（ADR 新增与修订流程）

**我不能批准架构破例**。

根据 ADR-0007 决策 3（禁止 2：替代性裁决），Agent 不得批准架构破例。

**所有破例必须**：
1. 按 ADR-900 流程提交破例请求
2. 说明破例理由和到期时间
3. 由架构委员会审批
4. 记录在 arch-violations.md

**下一步**：
请联系架构师启动正式破例流程。

**参考资料**：
- docs/adr/governance/ADR-900-architecture-tests.md（破例管理）
- docs/summaries/arch-violations.md（破例记录）
```

---

### 场景 4：Prompts 文件与 ADR 正文冲突

#### 问题识别

开发者发现 `adr-0001.prompts.md` 中的某个示例与 `ADR-0001.md` 正文描述不一致。

#### ✅ 正确的 Agent 响应

```markdown
## 🔍 发现 Prompts 与 ADR 正文冲突

**冲突说明**：
您发现的冲突是正确的。根据 ADR-0007 决策 4，Prompts 文件仅为示例，不具备裁决权。

**处理原则**：
> 当 Prompts 文件与 ADR 正文冲突时：
> 1. 以 ADR 正文为准
> 2. 修正 Prompts 文件
> 3. 记录冲突发现和修正过程

**下一步**：
1. 请提交 PR 修正 `docs/copilot/adr-0001.prompts.md`
2. 在 PR 中说明发现的冲突
3. 引用 ADR-0001 正文的具体章节

**权威来源**：
- docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md（唯一裁决源）

感谢您发现并报告这个冲突！
```

---

### 场景 5：需要新增专业 Agent

#### 开发者询问

"我发现领域事件版本化的违规很常见，能否新增一个专门的 Agent 来监督？"

#### ✅ 正确的 Agent 响应

```markdown
## 🤔 新增 Agent 的评估

**提议**：新增 Event Versioning Checker Agent

**评估依据**（ADR-0007 决策 6）：

**✅ 符合新增条件**：
- ✅ 领域事件版本化需要专门监督（ADR-210）
- ✅ 违规模式足够常见（根据您的观察）
- ✅ 有明确的 ADR 依据（ADR-210）

**审批流程**（治理级变更）：
1. 提交变更申请，说明理由
2. Tech Lead 审批
3. 公示 1 周
4. 创建 `.github/agents/event-versioning-checker.agent.md`
5. 更新 `.github/agents/README.md` 索引
6. 团队通知

**下一步**：
1. 准备详细的新增理由和职责定义
2. 联系 Tech Lead 启动审批流程
3. 参考 `.github/agents/module-boundary-checker.agent.md` 作为模板

**参考资料**：
- docs/adr/constitutional/ADR-0007-agent-behavior-permissions-constitution.md（决策 6）
- docs/adr/runtime/ADR-210-*.md（领域事件版本化，假设存在）
- .github/agents/README.md（Agent 体系说明）
```

---

## 四、禁止的 Agent 行为示例

### 禁止 1：解释性扩权（ADR-0007.2）

#### ❌ 错误示例

```markdown
虽然 ADR-0001 没有明确说明这个场景，但根据我对架构原则的理解，
这样做应该是符合模块隔离精神的。你可以继续实现。
```

**问题**：
- 在 ADR 未明确的情况下扩展解释
- 给出了实施建议
- 没有使用 ❓ Uncertain 状态

#### ✅ 正确做法

使用 ❓ Uncertain 状态，引导查阅 ADR 正文。

---

### 禁止 2：替代性裁决（ADR-0007.3）

#### ❌ 错误示例

```markdown
我已经验证过了，这个设计符合架构规范，可以合并 PR。
```

**问题**：
- Agent 声称"已经验证"
- Agent 建议可以合并
- Agent 替代了架构测试和人工审批

#### ✅ 正确做法

```markdown
根据 ADR-XXXX，这个设计符合以下约束：...

**验证方法**：
```bash
dotnet test src/tests/ArchitectureTests/
```

请确保架构测试通过，并由人工审批后再合并。
```

---

### 禁止 3：模糊输出（ADR-0007.4）

#### ❌ 错误示例

```markdown
应该没问题，可能可以这样做，一般来说是允许的。
```

**问题**：
- 使用了"应该"、"可能"、"一般来说"
- 没有明确的三态标识
- 判断模糊

#### ✅ 正确做法

必须使用三态之一（✅ Allowed / ⚠️ Blocked / ❓ Uncertain）并给出明确依据。

---

### 禁止 4：Prompts 作为裁决依据（ADR-0007.5）

#### ❌ 错误示例

```markdown
根据 adr-0001.prompts.md 的场景 3，这是不允许的。
```

**问题**：
- 将 Prompts 作为裁决依据
- 没有引用 ADR 正文

#### ✅ 正确做法

```markdown
根据 ADR-0001 第 3 章"模块隔离与通信规则"，这是不允许的。

参考 adr-0001.prompts.md 场景 3 了解示例。
```

---

### 禁止 5：发明架构规则（ADR-0007.6）

#### ❌ 错误示例

```markdown
根据架构最佳实践，你应该使用依赖注入。
```

**问题**：
- 引用了"架构最佳实践"（ADR 未规定）
- 发明了不存在于 ADR 的规则

#### ✅ 正确做法

```markdown
根据 ADR-0002 第 4 章"依赖注入规范"，你应该使用依赖注入。
```

或者如果 ADR 未规定：

```markdown
## ❓ Uncertain - 需要人工确认

ADR 未明确规定依赖注入的使用方式。建议查阅 ADR-0002 或咨询架构师。
```

---

## 五、Guardian 与专业 Agent 的协作

### 场景：模块边界检查

#### 协作流程

```
开发者问题
    ↓
Architecture Guardian（接收）
    ↓
识别为模块边界问题
    ↓
调用 Module Boundary Checker
    ↓
Module Boundary Checker 分析
    ↓
返回结果给 Guardian
    ↓
Guardian 统一响应格式
    ↓
返回给开发者
```

#### 示例响应

```markdown
## ⚠️ Blocked - 模块边界违规

**由 Module Boundary Checker 检测**

**违反的 ADR**：ADR-0001（模块化单体与垂直切片架构）

（后续内容由 Guardian 统一格式化输出）
```

---

## 六、Agent 变更场景

### 宪法级变更示例

**场景**：希望 Agent 能够批准临时性的架构破例

**判定**：宪法级变更（影响 ADR-0007 决策 3，禁止 2）

**流程**：
1. 提交 RFC 修改 ADR-0007
2. 架构委员会讨论（2 周公示期）
3. 全体一致同意
4. 更新 ADR-0007
5. 同步更新所有 Agent 配置文件
6. 团队培训

**可能的结论**：极大概率被拒绝，因为这会削弱 ADR 的权威性。

---

### 治理级变更示例

**场景**：新增 Contract Versioning Checker Agent

**判定**：治理级变更（新增专业 Agent）

**流程**：
1. 提交变更申请，说明理由
2. Tech Lead 审批
3. 公示 1 周
4. 创建 `.github/agents/contract-versioning-checker.agent.md`
5. 更新 `.github/agents/README.md`
6. 团队通知

---

### 实施级变更示例

**场景**：adr-0001.prompts.md 增加新的示例场景

**判定**：实施级变更（日常优化）

**流程**：
1. 直接提交 PR
2. 确认与 ADR-0001 正文一致
3. 单人审批即可合并

---

## 七、快速决策树

### 我是开发者，遇到 Agent 响应时

```
Agent 的响应是否包含三态标识？
├─ 是 → 好，继续
└─ 否 → ⚠️ Agent 违反 ADR-0007.1，请报告

响应状态是什么？
├─ ✅ Allowed → 检查是否有 ADR 依据
│   ├─ 有 → 可以继续
│   └─ 无 → ⚠️ Agent 违反 ADR-0007.6
│
├─ ⚠️ Blocked → 检查修复方案
│   └─ 按建议修复并验证
│
└─ ❓ Uncertain → 查阅 ADR 正文或咨询架构师
```

### 我是 Agent 开发者，需要修改 Agent 时

```
修改内容是什么？
├─ 修改 Agent 权限边界 → 宪法级变更
│   └─ 提交 RFC，架构委员会全体同意
│
├─ 新增/删除 Agent → 治理级变更
│   └─ Tech Lead 审批，公示 1 周
│
└─ 更新 Prompts/优化模板 → 实施级变更
    └─ 确保与 ADR 正文一致，单人审批
```

---

## 八、常见问题（FAQ）

### Q: Agent 说可以，但我觉得不对，怎么办？

**A:** 查阅 Agent 引用的 ADR 正文验证。
- 如果 ADR 正文确实允许，以 ADR 为准
- 如果 Agent 误判，记录并提交改进建议
- 如果 ADR 正文不明确，咨询架构师

### Q: Prompts 文件说某种做法是错误的，但 ADR 正文没说，听谁的？

**A:** 以 ADR 正文为准（ADR-0007 决策 4）。
- Prompts = 示例，不是规则
- 发现冲突时，修正 Prompts 文件

### Q: Agent 给了模糊建议（"应该可以"），我该怎么办？

**A:** Agent 违反了 ADR-0007.4（禁止模糊输出）。
- 要求 Agent 给出明确的三态判断
- 如果 Agent 继续模糊，查阅 ADR 正文自行判断

### Q: 我想新增一个 Agent，需要什么条件？

**A:** 参考 ADR-0007 决策 6：
- ✅ 某类架构约束需要专门监督
- ✅ 违规模式足够常见
- ✅ 有明确的 ADR 依据
- 走治理级变更流程（Tech Lead 审批）

### Q: Guardian 和专业 Agent 结论冲突，听谁的？

**A:** Guardian 负责协调（ADR-0007 决策 5）。
- Guardian 会统一响应格式
- 最终裁决依然是 ADR，不是 Guardian

---

## 九、关键检查清单

### 当我使用 Agent 时

- [ ] Agent 响应包含三态标识（✅/⚠️/❓）
- [ ] Agent 引用了明确的 ADR 依据（不是 Prompts）
- [ ] 没有模糊判断（"应该"、"可能"）
- [ ] Uncertain 时有默认禁止声明
- [ ] Blocked 时有具体修复方案
- [ ] Allowed 时有 ADR 正文引用

### 当我开发/修改 Agent 时

- [ ] 明确 Agent 职责边界
- [ ] 实现三态输出格式
- [ ] 列出禁止行为
- [ ] 声明与 Guardian 的关系
- [ ] 确认变更级别（宪法/治理/实施）
- [ ] 走对应的审批流程
- [ ] 更新版本历史

### 当我维护 Prompts 时

- [ ] 确保与 ADR 正文一致
- [ ] 仅作为示例，不引入新规则
- [ ] 发现冲突时修正 Prompts
- [ ] 记录修正原因

---

## 十、相关资源

### 必读

- [ADR-0007：Agent 行为与权限宪法](../adr/constitutional/ADR-0007-agent-behavior-permissions-constitution.md)（唯一裁决源）

### 辅助

- [Architecture Guardian 配置](../../.github/agents/architecture-guardian.agent.md)（ADR-0007 的实例化实现）
- [Agents 体系说明](../../.github/agents/README.md)
- [ADR-900：ADR 新增与修订流程](../adr/governance/ADR-900-architecture-tests.md)

---

## 版本历史

| 版本  | 日期         | 变更说明           | 修订人            |
|-----|------------|----------------|-----------------|
| 1.0 | 2026-01-25 | 初始版本，提供 ADR-0007 场景化示例 | GitHub Copilot  |

---

**维护者**：架构委员会  
**状态**：✅ Active
