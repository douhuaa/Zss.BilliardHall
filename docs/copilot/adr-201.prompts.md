# ADR-201 Copilot 提示词

**版本**：2.0  
**创建日期**：2026-01-24  
**更新日期**：2026-01-25  
**ADR**: docs/adr/runtime/ADR-201-handler-lifecycle-management.md

---

## 核心升级：执行上下文感知

### Handler 生命周期必须与执行上下文匹配

**Request-driven（HTTP/gRPC）**：
- ✅ 必须 Scoped
- ❌ 禁止 Transient

**Message-driven/Background**：
- ✅ Scoped（推荐）或 Transient（需注释）

**Context-free（无状态）**：
- ✅ Transient（需标注 `// STATELESS-HANDLER`）

---

## 必须阻止的反模式

### ❌ 反模式 1：后台任务强制 Scoped

**错误代码**：
```csharp
// ❌ 后台任务也用 Scoped 不合理
services.AddScoped<BackgroundJobHandler>();
```

**正确代码**：
```csharp
// ✅ 后台任务可用 Transient
services.AddTransient<BackgroundJobHandler>();
// STATELESS-HANDLER: 无状态后台任务
```

### ❌ 反模式 2：使用静态字段

```csharp
// ❌ 错误
private static List<Order> _cache = new();

// ✅ 正确
private readonly IOrderCache _cache;
```

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 2.0 | 2026-01-25 | 增加执行上下文感知规则 |
| 1.0 | 2026-01-24 | 初始版本 |
