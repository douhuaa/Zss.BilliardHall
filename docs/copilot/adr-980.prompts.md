# ADR-980 Copilot Prompts：ADR 生命周期一体化同步机制

> ⚠️ **权威声明**  
> 本文档不具备裁决权，仅提供场景化指导。  
> 所有架构决策以 [ADR-980 正文](../adr/governance/ADR-980-adr-lifecycle-synchronization.md) 为准。

**版本**：1.0  
**最后更新**：2026-01-26  
**关联 ADR**：ADR-980  
**用途**：为 GitHub Copilot 提供 ADR/测试/Prompt 版本同步场景的具体指导

---

## 概述

本文件为 GitHub Copilot 提供关于 ADR/测试/Prompt 三位一体版本同步的场景化示例和常见问题处理。

**核心原则（来自 ADR-980）**：
- ADR/测试/Prompt 版本号必须一致
- 自动检测版本同步
- 变更时遵循标准传播清单
- CODEOWNERS 责任人通知
- 版本不一致阻断构建

---

## 场景 1：修改 ADR 时同步版本号

### 用户说："我修改了 ADR-0001，需要更新版本号吗？"

**Copilot 应该**：

1. **确认需要更新版本号**：

```
根据 ADR-980.1，修改 ADR 时必须更新版本号。

版本号更新规则：
- 小改（修正、补充示例）：+0.1（如 3.1 → 3.2）
- 大改（新增规则、修改决策）：+1.0（如 3.2 → 4.0）
```

2. **提供三位一体同步清单**：

```markdown
## ADR-0001 变更清单

✅ 必须完成的步骤：
- [ ] 更新 ADR 正文版本号：3.1 → 3.2
      位置：docs/adr/constitutional/ADR-0001-modular-monolith-vertical-slice-architecture.md
      
- [ ] 更新架构测试版本号：3.1 → 3.2
      位置：src/tests/ArchitectureTests/ADR/ADR_0001_Architecture_Tests.cs
      格式：// Version: 3.2
      
- [ ] 更新 Copilot Prompt 版本号：3.1 → 3.2
      位置：docs/copilot/adr-0001.prompts.md
      格式：**版本**：3.2
      
- [ ] 更新 ADR 正文的"版本历史"章节
      记录本次变更内容
      
- [ ] 运行验证脚本：
      ./scripts/validate-adr-version-sync.sh
```

3. **示例：更新 ADR 正文版本号**：

```markdown
# ADR-0001：模块化单体与垂直切片架构

**状态**：✅ Accepted
**版本**：3.2  ← 从 3.1 更新到 3.2
```

4. **示例：更新测试文件版本号**：

```csharp
// Version: 3.2  ← 从 3.1 更新到 3.2
// ADR: ADR-0001
// 模块化单体与垂直切片架构测试
public class ADR_0001_Architecture_Tests
{
    // ...
}
```

5. **示例：更新 Prompt 文件版本号**：

```markdown
# ADR-0001 Copilot Prompts

**版本**：3.2  ← 从 3.1 更新到 3.2
**对应 ADR**：ADR-0001-modular-monolith-vertical-slice-architecture
```

---

## 场景 2：创建新 ADR 时设置版本号

### 用户问："新创建的 ADR 版本号应该是多少？"

**Copilot 应该**：

```
新创建的 ADR 版本号从 1.0 开始。

必须在三个文件中设置：
1. ADR 正文：**版本**：1.0
2. 架构测试：// Version: 1.0
3. Copilot Prompt：**版本**：1.0
```

**示例**：

ADR 正文：
```markdown
# ADR-0123：新功能规范

**状态**：✅ Accepted
**版本**：1.0  ← 新 ADR 从 1.0 开始
```

架构测试：
```csharp
// Version: 1.0  ← 新 ADR 从 1.0 开始
// ADR: ADR-0123
public class ADR_0123_Architecture_Tests
{
    // ...
}
```

Copilot Prompt：
```markdown
# ADR-0123 Copilot Prompts

**版本**：1.0  ← 新 ADR 从 1.0 开始
```

---

## 场景 3：检测版本同步问题

### 用户说："CI 报告版本同步失败"

**Copilot 应该**：

1. **运行检测脚本**：

```bash
./scripts/validate-adr-version-sync.sh
```

2. **解读错误信息**：

```
示例错误输出：
❌ 版本同步检测失败

ADR-0001 版本不一致：
- ADR 正文：3.2
- 架构测试：3.1  ← 版本落后
- Copilot Prompt：3.2

请将架构测试版本号更新至 3.2
```

3. **提供修复步骤**：

```markdown
## 修复版本不一致

1. 找到对应的测试文件：
   src/tests/ArchitectureTests/ADR/ADR_0001_Architecture_Tests.cs

2. 修改版本号注释：
   // Version: 3.1  → // Version: 3.2

3. 重新运行验证：
   ./scripts/validate-adr-version-sync.sh

4. 确认 CI 通过
```

---

## 场景 4：理解版本号增长规则

### 用户问："什么情况下版本号 +0.1，什么情况下 +1.0？"

**Copilot 应该**：

根据 ADR-980.3，提供判断标准：

| 变更类型 | 版本增长 | 示例 |
|---------|---------|------|
| **小改（Minor）** | +0.1 | 修正错别字、补充示例、优化措辞 |
| **大改（Major）** | +1.0 | 新增规则、修改决策、删除约束 |

**判断标准**：

```
✅ 小改 (+0.1)：
- 不改变规则语义
- 补充说明或示例
- 修正错误但不影响理解
- 优化表达但不改变决策

✅ 大改 (+1.0)：
- 新增架构约束
- 修改现有规则
- 删除或废弃规则
- 影响依赖此 ADR 的其他 ADR
```

**示例判断**：

```markdown
❓ 问题：在 ADR-0001 中新增一个示例代码，版本如何更新？

✅ 答案：小改，版本 3.1 → 3.2
理由：仅补充示例，不改变规则

❓ 问题：在 ADR-0001 中新增"禁止跨模块事务"规则，版本如何更新？

✅ 答案：大改，版本 3.2 → 4.0
理由：新增架构约束，影响所有模块实现
```

---

## 场景 5：使用 CODEOWNERS 通知责任人

### 用户问："我修改了 ADR，需要通知谁？"

**Copilot 应该**：

1. **说明自动通知机制**：

```
根据 ADR-980.4，CODEOWNERS 会自动通知责任人。

当你修改以下文件时：
- docs/adr/**/*.md → 自动添加架构委员会为 Reviewer
- src/tests/ArchitectureTests/** → 自动添加测试负责人为 Reviewer
- docs/copilot/**/*.prompts.md → 自动添加文档维护者为 Reviewer
```

2. **查看 CODEOWNERS 配置**：

```
查看责任人配置：
cat .github/CODEOWNERS

示例内容：
# ADR 文档
docs/adr/**/*.md @douhuaa @architecture-team

# 架构测试
src/tests/ArchitectureTests/** @douhuaa @test-team

# Copilot Prompts
docs/copilot/**/*.prompts.md @douhuaa @doc-team
```

3. **提醒手动通知**：

```
虽然 CODEOWNERS 自动通知，但对于重大变更，建议：
1. 在 PR 描述中 @ 相关人员
2. 说明变更原因和影响范围
3. 提供迁移指南（如适用）
```

---

## 场景 6：处理依赖 ADR 的级联更新

### 用户问："我修改了 ADR-0001（宪法层），其他 ADR 需要更新吗？"

**Copilot 应该**：

1. **检查依赖关系**：

```bash
# 查看哪些 ADR 依赖 ADR-0001
grep -r "ADR-0001" docs/adr/ | grep "依赖"

# 或查看关系图
cat docs/adr/ADR-RELATIONSHIP-MAP.md
```

2. **评估影响范围**：

```
根据 ADR-980.3 变更传播清单：

如果 ADR-0001 的变更影响了依赖它的 ADR：

依赖 ADR-0001 的 ADR（示例）：
- ADR-0002：平台架构
- ADR-0005：交互模型
- ADR-0201：Handler 生命周期

需要检查：
1. 这些 ADR 的规则是否仍然有效
2. 是否需要更新示例或说明
3. 是否需要更新版本号
```

3. **提供更新建议**：

```markdown
## 级联更新检查清单

对于依赖 ADR-0001 的每个 ADR：

- [ ] 阅读该 ADR，确认规则仍然有效
- [ ] 检查示例代码是否需要更新
- [ ] 如需更新：
      - 更新 ADR 内容
      - 更新版本号（三位一体）
      - 在变更日志中注明"因 ADR-0001 v4.0 变更而更新"
- [ ] 如无需更新：
      - 在 PR 评论中说明已检查
```

---

## 场景 7：验证完整的同步状态

### 用户问："如何确认所有 ADR/测试/Prompt 版本都同步？"

**Copilot 应该**：

1. **运行完整验证**：

```bash
# 运行全面验证脚本
./scripts/verify-all.sh

# 或仅验证版本同步
./scripts/validate-adr-version-sync.sh
```

2. **解读验证结果**：

```
✅ 成功输出示例：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
4. 版本同步检查（ADR-980）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 验证 ADR/测试/Prompt 版本同步...

✅ 版本同步检查通过
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

❌ 失败输出示例：
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
4. 版本同步检查（ADR-980）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
🔍 验证 ADR/测试/Prompt 版本同步...

❌ ADR-0001 版本不一致：
   - ADR 正文：3.2
   - 架构测试：3.1
   - Copilot Prompt：3.2

❌ 版本同步检查失败
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

3. **CI 检查点**：

```
CI 中的版本同步检查：
- Workflow：.github/workflows/adr-version-sync.yml
- 触发：PR、主分支推送、每日定时
- 失败：阻断合并
```

---

## 场景 8：版本历史记录

### 用户问："如何在 ADR 中记录版本历史？"

**Copilot 应该**：

提供标准格式：

```markdown
## 版本历史

| 版本 | 日期 | 变更说明 | 影响范围 |
|------|------|---------|---------|
| 4.0 | 2026-01-26 | 新增"禁止跨模块事务"约束 | 所有模块实现 |
| 3.2 | 2026-01-20 | 补充事件通信示例 | 无破坏性变更 |
| 3.1 | 2026-01-15 | 修正契约定义措辞 | 无破坏性变更 |
| 3.0 | 2026-01-10 | 重构模块隔离规则 | 重大变更 |
| 2.0 | 2026-01-05 | 初始正式版本 | - |
```

**每次版本更新时必须添加新行**：
- 版本号：与 ADR/测试/Prompt 一致
- 日期：变更日期
- 变更说明：简要描述修改内容
- 影响范围：是否破坏性变更

---

## 常见错误和修正

### ❌ 错误 1：仅更新 ADR 正文版本号

**错误示例**：
```
修改了 ADR-0001.md，版本号 3.1 → 3.2
但测试和 Prompt 仍是 3.1
```

**问题**：违反三位一体同步（ADR-980.1）

**修正**：
```markdown
必须同步更新：
1. ADR 正文：3.1 → 3.2
2. 架构测试：3.1 → 3.2
3. Copilot Prompt：3.1 → 3.2
```

---

### ❌ 错误 2：版本号格式不一致

**错误示例**：
```
ADR 正文：**版本**：3.2.0
架构测试：// Version: 3.2
```

**问题**：版本号格式不一致（应使用 X.Y 格式）

**修正**：
```
统一使用 X.Y 格式：
ADR 正文：**版本**：3.2
架构测试：// Version: 3.2
Copilot Prompt：**版本**：3.2
```

---

### ❌ 错误 3：忘记更新版本历史

**错误示例**：
```markdown
修改了 ADR 内容并更新版本号，但未记录版本历史
```

**问题**：违反变更传播清单（ADR-980.3）

**修正**：
```markdown
## 版本历史

| 版本 | 日期 | 变更说明 | 影响范围 |
|------|------|---------|---------|
| 3.2 | 2026-01-26 | 补充跨模块通信示例 | 无破坏性变更 |  ← 新增
| 3.1 | 2026-01-20 | 修正措辞 | 无破坏性变更 |
```

---

## 工具和命令速查

| 任务 | 命令 | 说明 |
|------|------|------|
| 验证版本同步 | `./scripts/validate-adr-version-sync.sh` | 检查 ADR/测试/Prompt 版本一致性 |
| 全面验证 | `./scripts/verify-all.sh` | 运行所有验证（包括版本同步） |
| 查看 CODEOWNERS | `cat .github/CODEOWNERS` | 查看责任人配置 |
| 查看 CI 状态 | GitHub Actions 页面 | 检查版本同步检测结果 |

---

## 参考资料

- [ADR-980 正文](../adr/governance/ADR-980-adr-lifecycle-synchronization.md) - 权威规则
- [P0 实施总结](../summaries/p0-adr-implementation-summary.md) - 实施背景
- [CODEOWNERS 文件](../../.github/CODEOWNERS) - 责任人配置

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| 1.0 | 2026-01-26 | 初始版本 |

---

**维护**：架构委员会  
**审核**：@douhuaa  
**状态**：✅ Active
