# ADR-0210 Copilot 提示词

**版本**：2.0  
**创建日期**：2026-01-24  
**更新日期**：2026-01-25  
**ADR**: docs/adr/runtime/ADR-210-event-versioning-compatibility.md

---

## 核心原则

**事件系统第一原则：不死**
- 版本错误是数据问题，不是系统故障
- 必须降级处理，不得中断消费

---

## 必须阻止的反模式

### ❌ 反模式 1：版本异常导致崩溃

**错误代码**：
```csharp
if (evt.SchemaVersion != "2.0") 
    throw new Exception("Unknown version");  // ❌ 中断消费
```

**正确代码**：
```csharp
if (evt.SchemaVersion != "2.0") 
{
    _logger.LogWarning("Unknown event version");
    await _fallbackHandler.Handle(evt);  // ✅ 降级处理
}
```

### ❌ 反模式 2：立即删除旧版本

```csharp
// ❌ V2 发布后立即删除 V1
public record OrderCreatedV2 { }

// ✅ 保留至少 2 个大版本
[Obsolete("Use V2", false)]
public record OrderCreated { }
public record OrderCreatedV2 { }
```

---

## 生产容错检查清单

- [ ] 所有事件包含 SchemaVersion
- [ ] 提供 Fallback Handler
- [ ] 反序列化失败移入死信队列
- [ ] 订阅者处理所有活跃版本

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|---------|
| 2.0 | 2026-01-25 | 增加生产容错策略 |
| 1.0 | 2026-01-24 | 初始版本 |
