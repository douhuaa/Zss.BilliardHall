# ADR-0004：中央包管理（CPM）规范 - Copilot 提示词库

**关联 ADR**：[ADR-0004](../adr/constitutional/ADR-0004-Cpm-Final.md)  
**测试类**：`ADR_0004_Architecture_Tests.cs`  
**版本**：1.0  
**最后更新**：2026-01-21

---

## 一、当我在写什么时，你应该提醒我哪些 ADR-0004 约束？

### 场景 1：添加新的 NuGet 包

**触发条件**：

- 需要引入新的依赖包
- 在项目文件中添加 PackageReference

**你应该提醒的约束**：

```
✅ 检查清单：
1. 是否在 Directory.Packages.props 中定义了包版本？
2. 项目文件中是否没有指定 Version 属性？
3. 包是否符合层级依赖规则？
4. 包是否在正确的分组中？

步骤：
1. 在 Directory.Packages.props 中添加包定义：
   <PackageVersion Include="PackageName" Version="x.y.z" />

2. 在项目文件中引用（不带 Version）：
   <PackageReference Include="PackageName" />

❌ 禁止：
- 在项目文件中指定 Version
- 绕过 Directory.Packages.props
- 违反层级依赖规则
```

---

### 场景 2：升级现有包版本

**触发条件**：

- 需要升级依赖包版本
- 修改 Directory.Packages.props

**你应该提醒的约束**：

```
✅ 升级流程：
1. 在 Directory.Packages.props 中更新版本号
2. 运行架构测试验证
3. 如果影响多个项目，需要全面测试

⚠️ 注意事项：
- CPM 确保所有项目使用相同版本
- 升级一个包会影响所有引用它的项目
- 谨慎升级主要框架包（如 ASP.NET Core）

❌ 禁止：
- 在单个项目中覆盖版本
- 使用不同版本号
```

---

### 场景 3：在特定层级添加依赖

**触发条件**：

- 在 Platform / Application / Modules / Host 中添加包引用

**你应该提醒的约束**：

```
✅ 层级依赖规则：

Platform 层（技术基座）：
- ✅ 允许：Serilog、OpenTelemetry、HealthChecks
- ❌ 禁止：ASP.NET Core、Entity Framework、Wolverine

Application 层（应用装配）：
- ✅ 允许：Wolverine、Marten、框架包
- ❌ 禁止：HttpContext、Host 特定类型

Modules 层（业务模块）：
- ✅ 允许：Platform 包、业务库
- ❌ 禁止：其他 Module 的包、Host 包

Host 层（进程外壳）：
- ✅ 允许：ASP.NET Core、协议相关包
- ❌ 禁止：Module 特定的包

检查方法：
参考 Directory.Packages.props 中的分组注释
```

---

### 场景 4：解决依赖冲突

**触发条件**：

- 遇到版本冲突
- 传递依赖版本不一致

**你应该提醒的约束**：

```
✅ CPM 的传递依赖固定机制：

1. 启用 CentralPackageTransitivePinningEnabled
   - 所有传递依赖使用 CPM 指定的版本
   - 避免版本冲突

2. 如果遇到冲突：
   - 在 Directory.Packages.props 中显式声明版本
   - 所有项目将使用统一版本

3. 验证：
   - 运行 dotnet build
   - 检查是否还有警告

❌ 不要：
- 在项目中使用 <PackageReference Update>
- 尝试在单个项目中解决冲突
```

---

## 二、哪些写法必须阻止？

### 反模式 1：在项目文件中指定版本

**❌ 错误示例**：

```xml
<!-- Orders.csproj -->
<!-- ❌ 不要在项目中指定 Version -->
<ItemGroup>
  <PackageReference Include="Marten" Version="7.0.0" />
</ItemGroup>
```

**✅ 正确做法**：

```xml
<!-- Directory.Packages.props -->
<ItemGroup>
  <PackageVersion Include="Marten" Version="7.0.0" />
</ItemGroup>

<!-- Orders.csproj -->
<!-- ✅ 项目中不指定 Version -->
<ItemGroup>
  <PackageReference Include="Marten" />
</ItemGroup>
```

---

### 反模式 2：Platform 依赖业务框架

**❌ 错误示例**：

```xml
<!-- Platform/Logging/Logging.csproj -->
<!-- ❌ Platform 不应该依赖 Wolverine -->
<ItemGroup>
  <PackageReference Include="Wolverine" />
</ItemGroup>
```

**✅ 正确做法**：

```xml
<!-- Platform/Logging/Logging.csproj -->
<!-- ✅ Platform 只依赖技术基础包 -->
<ItemGroup>
  <PackageReference Include="Serilog" />
  <PackageReference Include="Serilog.Sinks.Console" />
</ItemGroup>
```

---

### 反模式 3：Host 直接依赖 Module 的包

**❌ 错误示例**：

```xml
<!-- Host/Web/Web.csproj -->
<!-- ❌ Host 不应该直接依赖 Module 特定的包 -->
<ItemGroup>
  <PackageReference Include="Orders.Domain" />
</ItemGroup>
```

**✅ 正确做法**：

```xml
<!-- Host/Web/Web.csproj -->
<!-- ✅ Host 只引用 Application -->
<ItemGroup>
  <ProjectReference Include="..\..\Application\Application.csproj" />
</ItemGroup>

<!-- Application 负责引入所有 Modules -->
```

---

### 反模式 4：Module 间直接依赖

**❌ 错误示例**：

```xml
<!-- Modules/Orders/Orders.csproj -->
<!-- ❌ Module 不应该直接依赖其他 Module -->
<ItemGroup>
  <ProjectReference Include="..\Members\Members.csproj" />
</ItemGroup>
```

**✅ 正确做法**：

```xml
<!-- Modules/Orders/Orders.csproj -->
<!-- ✅ Module 只依赖 Platform 和 BuildingBlocks -->
<ItemGroup>
  <ProjectReference Include="..\..\Platform\Platform.csproj" />
  <ProjectReference Include="..\..\BuildingBlocks\Domain\Domain.csproj" />
</ItemGroup>

<!-- 模块间通过事件或 Contracts 通信 -->
```

---

## 三、CI 失败时，你应该如何解释？

### 失败消息：项目中指定了版本号

**CI 输出示例**：

```
❌ Test Failed: Projects_Should_Not_Specify_Package_Version
   Expected: No Version attribute in PackageReference
   Actual: Found Version="7.0.0" in Orders.csproj
```

**你应该这样解释**：

```
根据 ADR-0004，所有包版本必须在 Directory.Packages.props 中集中管理。

问题分析：
- Orders.csproj 中发现 Version 属性
- 这违反了中央包管理（CPM）规范

修复建议：
1. 在 Directory.Packages.props 中定义版本：
   <PackageVersion Include="Marten" Version="7.0.0" />

2. 在 Orders.csproj 中移除 Version：
   <PackageReference Include="Marten" />

验证：
dotnet restore
dotnet build
```

---

### 失败消息：Platform 依赖了业务框架

**CI 输出示例**：

```
❌ Test Failed: Platform_Should_Not_Depend_On_Business_Frameworks
   Expected: Platform only depends on technical packages
   Actual: Found reference to 'Wolverine' in Platform
```

**你应该这样解释**：

```
根据 ADR-0004，Platform 层不应该依赖业务框架。

问题分析：
- Platform 层引用了 Wolverine
- Wolverine 是应用框架，应该在 Application 层

层级依赖规则：
- Platform：只能依赖技术基础包（Serilog、OpenTelemetry 等）
- Application：可以依赖框架包（Wolverine、Marten 等）

修复建议：
1. 从 Platform 项目中移除 Wolverine 引用
2. 将 Wolverine 配置移到 Application 层
3. Platform 只保留技术服务（日志、追踪等）
```

---

### 失败消息：Module 间直接依赖

**CI 输出示例**：

```
❌ Test Failed: Modules_Should_Not_Reference_Each_Other
   Expected: No direct module references
   Actual: Orders module references Members module
```

**你应该这样解释**：

```
根据 ADR-0004 和 ADR-0001，模块之间不允许直接引用。

问题分析：
- Orders 模块直接引用了 Members 模块
- 这违反了模块隔离原则

修复建议：
1. 移除 Orders 对 Members 的直接引用

2. 使用合规的通信方式：
   - 领域事件：异步通知
   - Contracts：数据查询（只读 DTO）
   - 原始类型：传递标识（Guid、string 等）

示例：
// ❌ 直接引用
using Members.Domain;
var member = await _memberRepo.GetByIdAsync(id);

// ✅ 通过契约查询
var memberDto = await _queryBus.Send(new GetMemberById(id));

// ✅ 通过事件通知
await _eventBus.Publish(new OrderCreated(orderId, memberId));
```

---

### 失败消息：传递依赖版本冲突

**CI 输出示例**：

```
⚠️ Warning: Package 'System.Text.Json' has conflicting versions
   Required by: Marten (7.0.0) → 8.0.0
   Required by: ASP.NET Core (8.0.0) → 8.0.1
```

**你应该这样解释**：

```
根据 ADR-0004，使用 CPM 可以固定传递依赖版本。

问题分析：
- 不同的包引入了不同版本的 System.Text.Json
- 需要显式指定版本

修复建议：
1. 在 Directory.Packages.props 中显式声明版本：
   <PackageVersion Include="System.Text.Json" Version="8.0.1" />

2. CentralPackageTransitivePinningEnabled 会确保所有项目使用此版本

3. 重新构建验证：
   dotnet clean
   dotnet restore
   dotnet build
```

---

## 四、典型问答（FAQ）

### Q1: 我想添加一个新的 NuGet 包，正确的步骤是什么？

**A:**
遵循以下步骤：

1. **在 Directory.Packages.props 中定义版本**：
   ```xml
   <ItemGroup>
     <!-- 在合适的分组中添加 -->
     <PackageVersion Include="NewtonSoft.Json" Version="13.0.3" />
   </ItemGroup>
   ```

2. **在项目文件中引用（不带版本）**：
   ```xml
   <ItemGroup>
     <PackageReference Include="Newtonsoft.Json" />
   </ItemGroup>
   ```

3. **验证是否符合层级规则**：
  - Platform → 只能是技术包
  - Application → 可以是框架包
  - Modules → 只能是业务相关包
  - Host → 只能是协议相关包

4. **运行架构测试**：
   ```bash
   dotnet test src/tests/ArchitectureTests/
   ```

---

### Q2: 我想在不同项目中使用不同版本的包，可以吗？

**A:**
**不可以**。CPM 的核心原则是统一版本管理。

**原因**：

- 避免版本冲突
- 降低维护成本
- 确保一致性

**替代方案**：
如果确实需要不同版本：

1. 评估是否真的需要
2. 考虑升级所有项目到最新版本
3. 如果无法避免，可能需要创建独立的解决方案

**最佳实践**：

- 统一升级所有项目
- 定期更新到最新稳定版本

---

### Q3: Directory.Packages.props 中的包分组有什么作用？

**A:**
包分组有助于：

1. **清晰的组织**：
   ```xml
   <!-- Aspire -->
   <PackageVersion Include="Aspire.Hosting" Version="9.0.0" />
   
   <!-- Wolverine -->
   <PackageVersion Include="Wolverine" Version="3.5.0" />
   
   <!-- Marten -->
   <PackageVersion Include="Marten" Version="7.35.1" />
   ```

2. **快速定位**：
  - 需要升级某类包时，快速找到相关包
  - 添加新包时，知道应该放在哪个组

3. **依赖关系理解**：
  - 了解项目使用了哪些技术栈
  - 评估技术债务

**建议的分组**：

- Aspire（云原生）
- Wolverine（消息框架）
- Marten（事件溯源）
- Logging（日志）
- Testing（测试）
- Code Analysis（代码分析）

---

### Q4: 如何处理 NuGet 包的传递依赖？

**A:**
CPM 通过 `CentralPackageTransitivePinningEnabled` 自动处理：

```xml
<!-- Directory.Build.props -->
<PropertyGroup>
  <ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>
  <CentralPackageTransitivePinningEnabled>true</CentralPackageTransitivePinningEnabled>
</PropertyGroup>
```

**效果**：

- 所有传递依赖都使用 Directory.Packages.props 中指定的版本
- 避免版本冲突
- 提高构建可重复性

**如果遇到冲突**：

1. 在 Directory.Packages.props 中显式声明版本
2. 让 CPM 自动固定传递依赖

---

## 五、快速检查清单

在提交 PR 前，请对照以下清单：

- [ ] 所有包版本都在 Directory.Packages.props 中定义？
- [ ] 项目文件中的 PackageReference 没有 Version 属性？
- [ ] 包引用符合层级依赖规则？
- [ ] 没有 Module 间的直接依赖？
- [ ] Platform 没有依赖业务框架？
- [ ] 架构测试是否全部通过？

---

## 六、层级依赖规则快速参考

| 层级              | 允许的包类型                               | 禁止的包类型                          |
|-----------------|--------------------------------------|---------------------------------|
| **Platform**    | Serilog, OpenTelemetry, HealthChecks | Wolverine, Marten, ASP.NET Core |
| **Application** | Wolverine, Marten, 框架包               | HttpContext, Host 特定类型          |
| **Modules**     | Platform 包, 业务库                      | 其他 Module 的包, Host 包            |
| **Host**        | ASP.NET Core, 协议包                    | Module 特定的包                     |

---

## 六、测试覆盖自检清单

### 6.1 ADR-测试映射表

| ADR 约束     | 测试方法                                                            | 测试内容                                        |
|------------|-----------------------------------------------------------------|---------------------------------------------|
| ADR-0004.1 | `Repository_Should_Have_Directory_Packages_Props`               | Directory.Packages.props 必须存在于仓库根目录         |
| ADR-0004.2 | `CPM_Should_Be_Enabled`                                         | ManagePackageVersionsCentrally 必须启用         |
| ADR-0004.3 | `CPM_Should_Enable_Transitive_Pinning`                          | CentralPackageTransitivePinningEnabled 建议启用 |
| ADR-0004.4 | `Projects_Should_Not_Specify_Package_Versions`                  | 项目文件不应手动指定包版本                               |
| ADR-0004.5 | `Directory_Packages_Props_Should_Contain_Package_Groups`        | Directory.Packages.props 应使用 Label 分组       |
| ADR-0004.6 | `Directory_Packages_Props_Should_Contain_Common_Package_Groups` | 应包含常见包分组（如 Testing, Logging）                |
| ADR-0004.7 | `Platform_Projects_Should_Not_Reference_Business_Packages`      | Platform 不应引用业务包                            |
| ADR-0004.8 | `All_Test_Projects_Should_Use_Same_Test_Framework_Versions`     | 所有测试项目应使用相同的测试框架版本                          |
| ADR-0004.9 | `Directory_Packages_Props_Should_Define_All_Used_Packages`      | Directory.Packages.props 应定义所有项目使用的包        |

### 6.2 自检问题

在提交代码前，请确认：

**Directory.Packages.props**：

- [ ] 是否启用了 ManagePackageVersionsCentrally？
- [ ] 是否启用了 CentralPackageTransitivePinningEnabled？
- [ ] 是否使用了 Label 属性对包进行分组？
- [ ] 是否包含了所有项目使用的包？

**项目文件**：

- [ ] 是否所有 PackageReference 都没有 Version 属性？
- [ ] 是否只引用了符合层级规则的包？

**Platform 层**：

- [ ] 是否只引用了技术基础包（Serilog, OpenTelemetry 等）？
- [ ] 是否没有引用业务框架包（Wolverine, Marten 等）？

**测试项目**：

- [ ] 是否所有测试项目使用相同的测试框架版本？

### 6.3 如何编写符合映射要求的测试

#### 示例 1：验证 CPM 基础配置

```csharp
[Fact(DisplayName = "ADR-0004.2: CPM 应被启用")]
public void CPM_Should_Be_Enabled()
{
    var root = ModuleAssemblyData.GetSolutionRoot();
    var cpmFile = Path.Combine(root, "Directory.Packages.props");

    Assert.True(File.Exists(cpmFile), "Directory.Packages.props 文件不存在");

    var content = File.ReadAllText(cpmFile);

    Assert.True(content.Contains("ManagePackageVersionsCentrally"),
        $"❌ ADR-0004.2 违规: Directory.Packages.props 必须包含 ManagePackageVersionsCentrally 设置。\n\n" +
        $"当前状态: 未找到 ManagePackageVersionsCentrally 配置\n\n" +
        $"修复建议:\n" +
        $"1. 在 Directory.Packages.props 中添加 <PropertyGroup> 节点\n" +
        $"2. 添加 <ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>\n" +
        $"3. 重新构建项目验证配置生效\n\n" +
        $"参考: docs/copilot/adr-0004.prompts.md (场景 1)");

    Assert.True(content.Contains("true"),
        $"❌ ADR-0004.2 违规: Directory.Packages.props 中的 ManagePackageVersionsCentrally 应该设置为 true。\n\n" +
        $"当前状态: ManagePackageVersionsCentrally 值不正确\n\n" +
        $"修复建议:\n" +
        $"1. 确保 <ManagePackageVersionsCentrally>true</ManagePackageVersionsCentrally>\n" +
        $"2. 检查拼写和大小写是否正确\n" +
        $"3. 删除所有项目文件中的手动 Version 属性\n\n" +
        $"参考: docs/copilot/adr-0004.prompts.md (场景 1)");
}
```

**关键点**：

- 测试名称包含 ADR 编号（ADR-0004.2）
- 失败消息包含清晰的违规描述和当前状态
- 提供具体的修复建议（编号列表，2-3 项）
- 引用相关文档章节

#### 示例 2：验证项目不手动指定版本

```csharp
[Fact(DisplayName = "ADR-0004.4: 项目文件不应手动指定包版本")]
public void Projects_Should_Not_Specify_Package_Versions()
{
    var root = ModuleAssemblyData.GetSolutionRoot();
    var projectFiles = Directory.GetFiles(root, "*.csproj", SearchOption.AllDirectories)
        .Where(p => !p.Contains("/obj/") && !p.Contains("/bin/"))
        .ToList();

    var violations = new List<string>();

    foreach (var projectFile in projectFiles)
    {
        var doc = new XmlDocument();
        try
        {
            doc.Load(projectFile);
        }
        catch
        {
            continue;
        }

        var mgr = new XmlNamespaceManager(doc.NameTable);
        mgr.AddNamespace("msb", doc.DocumentElement!.NamespaceURI);

        // 检查 PackageReference 是否有 Version 属性
        var packageRefsWithVersion = doc.SelectNodes("//msb:PackageReference[@Version]", mgr);
        if (packageRefsWithVersion != null && packageRefsWithVersion.Count > 0)
        {
            foreach (XmlNode node in packageRefsWithVersion)
            {
                var packageName = node.Attributes?["Include"]?.Value ?? "未知包";
                var version = node.Attributes?["Version"]?.Value ?? "未知版本";
                violations.Add($"  • {Path.GetFileName(projectFile)}: {packageName} (Version={version})");
            }
        }
    }

    Assert.True(violations.Count == 0,
        $"❌ ADR-0004.4 违规: 发现 {violations.Count} 个项目手动指定了包版本，应使用 CPM 统一管理。\n\n" +
        $"违规项目:\n{string.Join("\n", violations)}\n\n" +
        $"修复建议:\n" +
        $"1. 在 Directory.Packages.props 中定义包版本: <PackageVersion Include=\"包名\" Version=\"版本号\" />\n" +
        $"2. 从项目文件中移除 Version 属性，只保留 <PackageReference Include=\"包名\" />\n" +
        $"3. 运行 dotnet restore 和 dotnet build 验证配置正确\n\n" +
        $"参考: docs/copilot/adr-0004.prompts.md (场景 1, 反模式 1)");
}
```

**关键点**：

- 收集所有违规项并一次性报告
- 提供详细的违规列表
- 给出明确的修复步骤
- 关联到反模式文档

### 6.4 验证脚本

运行以下命令验证所有 ADR-0004 测试：

```bash
# 运行所有 ADR-0004 测试
dotnet test --filter "FullyQualifiedName~ADR_0004"

# 运行特定约束测试
dotnet test --filter "DisplayName~ADR-0004.1"
dotnet test --filter "DisplayName~ADR-0004.4"

# 查看详细输出
dotnet test --filter "FullyQualifiedName~ADR_0004" --logger "console;verbosity=detailed"
```

### 6.5 更新提示

**何时需要更新测试**：

1. **添加新的 NuGet 包**
  - 确保包在 Directory.Packages.props 中定义
  - 验证层级依赖规则

2. **升级包版本**
  - 只在 Directory.Packages.props 中修改版本号
  - 重新运行所有测试验证兼容性

3. **新增项目**
  - 确保不手动指定包版本
  - 只引用符合层级规则的包

4. **修改 CPM 配置**
  - 重新运行所有 ADR-0004 测试
  - 确保所有项目构建成功

**测试失败时的处理流程**：

```
1. 查看失败消息中的 ADR 编号
2. 参考 docs/copilot/adr-0004.prompts.md 对应场景或反模式
3. 按照修复建议逐步修复
4. 重新运行测试验证
5. 如有疑问，参考 ADR-0004 完整文档
```

---

## 七、相关资源

- [ADR-0004 完整文档](../adr/constitutional/ADR-0004-Cpm-Final.md)
- [架构测试类](../../src/tests/ArchitectureTests/ADR/ADR_0004_Architecture_Tests.cs)
- [Directory.Packages.props](../../Directory.Packages.props)
- [CPM 官方文档](https://learn.microsoft.com/en-us/nuget/consume-packages/central-package-management)

---

## 版本历史

| 版本  | 日期         | 变更说明                   |
|-----|------------|------------------------|
| 1.1 | 2026-01-21 | 添加测试覆盖自检清单（六、测试覆盖自检清单） |
| 1.0 | 2026-01-21 | 初始版本                   |
