# ADR-0110：测试目录组织规范 - Copilot 提示词库

本文档为 GitHub Copilot 提供 **ADR-0110（测试目录组织规范）** 的执行指南。

---

## 一、当我在写什么时，你应该提醒我哪些约束？

### 场景 1：创建新的测试文件

**触发条件**：
- 创建 `*Tests.cs` 文件
- 在 `tests/` 目录下工作

**检查清单**：
- ✅ 测试项目命名是否遵循 `{命名空间}.Tests` 模式？
- ✅ 测试文件是否镜像源码目录结构？
- ✅ 测试类命名是否遵循 `{被测类名}Tests` 模式？
- ✅ 测试方法命名是否遵循 `{方法名}_{场景}_{预期结果}` 模式？

**示例对话**：
```
用户："帮我为 CreateMemberHandler 创建测试"
Copilot：
"我将创建单元测试文件。根据 ADR-0110，测试应该镜像源码结构：
- 源码位置：src/Modules/Members/Features/CreateMember/CreateMemberHandler.cs
- 测试位置：tests/Modules.Members.Tests/Features/CreateMember/CreateMemberHandlerTests.cs

测试类命名：CreateMemberHandlerTests
测试方法命名示例：
- Handle_ValidCommand_CreatesMember
- Handle_InvalidEmail_ThrowsException
- Handle_DuplicateEmail_ThrowsException

是否按此结构创建？"
```

### 场景 2：创建架构测试

**触发条件**：
- 需要为新 ADR 创建架构测试
- 修改 `ArchitectureTests` 项目

**检查清单**：
- ✅ 测试类是否遵循 `ADR_{编号:D4}_Architecture_Tests` 命名？
- ✅ 测试方法是否使用 `[Theory(DisplayName = "ADR-{编号}.{子编号}: {约束描述}")]`？
- ✅ 测试是否放在 `ArchitectureTests/ADR/` 目录？
- ✅ 是否使用共享的测试数据提供者（如 `ModuleAssemblyData`）？

**示例对话**：
```
用户："帮我为 ADR-0110 创建架构测试"
Copilot：
"根据 ADR-0110，架构测试应该：
1. 文件名：ADR_0110_Architecture_Tests.cs
2. 位置：tests/ArchitectureTests/ADR/
3. 测试方法示例：
   [Theory(DisplayName = "ADR-0110.1: 测试项目应遵循命名约定")]
   [ClassData(typeof(TestProjectData))]
   public void TestProjects_Should_Follow_NamingConventions(Assembly assembly)
   
是否创建此架构测试？"
```

### 场景 3：重组测试目录

**触发条件**：
- 移动或重命名测试文件
- 重构测试项目结构

**检查清单**：
- ✅ 测试目录是否保持与源码镜像？
- ✅ 架构测试是否保持在集中位置（`ArchitectureTests/`）？
- ✅ 单元测试是否仍然按模块组织？

---

## 二、哪些写法必须阻止？

### ❌ 反模式 1：不镜像源码的测试结构

```csharp
// ❌ 错误：所有测试混在一起
tests/Modules.Members.Tests/
└── UnitTests/
    └── AllMemberTests.cs  // 包含所有会员相关测试

// ✅ 正确：镜像源码结构
tests/Modules.Members.Tests/
└── Features/
    ├── CreateMember/
    │   └── CreateMemberHandlerTests.cs
    └── GetMemberById/
        └── GetMemberByIdQueryHandlerTests.cs
```

**建议**：
"您的测试结构不符合 ADR-0110。测试应该镜像源码结构：
- 为每个 Handler 创建独立的测试类
- 测试文件应放在与源码对应的目录中
请重新组织测试结构。"

### ❌ 反模式 2：分散的架构测试

```csharp
// ❌ 错误：在模块中分散架构测试
tests/Modules.Members.Tests/
└── ArchitectureTests/
    └── IsolationTests.cs  // 应该在集中的 ArchitectureTests 项目中

// ✅ 正确：集中管理架构测试
tests/ArchitectureTests/
└── ADR/
    └── ADR_0001_Architecture_Tests.cs
```

**建议**：
"根据 ADR-0110，架构测试必须集中在 `ArchitectureTests` 项目中。
请将此测试移动到 `tests/ArchitectureTests/ADR/` 目录。"

### ❌ 反模式 3：横向分类的测试项目

```csharp
// ❌ 错误：按测试类型分类
tests/
├── UnitTests/          // 所有单元测试
├── IntegrationTests/   // 所有集成测试
└── ArchitectureTests/

// ✅ 正确：按模块组织
tests/
├── Modules.Members.Tests/      // Members 模块测试
├── Modules.Orders.Tests/       // Orders 模块测试
├── Integration.Tests/          // 集成测试（按场景）
└── ArchitectureTests/          // 架构测试（集中）
```

**建议**：
"根据 ADR-0110，测试应该按模块组织，而非按测试类型分类。
请重构测试项目结构，为每个模块创建独立的测试项目。"

### ❌ 反模式 4：错误的命名约定

```csharp
// ❌ 错误的命名
tests/MembersTest/                    // 应该是 Modules.Members.Tests
tests/Members_Tests/                  // 不要用下划线
tests/Test.Members/                   // 顺序错误

public class CreateMemberTest { }     // 应该是 CreateMemberHandlerTests
public class TestCreateMember { }     // Test 前缀错误

// ✅ 正确的命名
tests/Modules.Members.Tests/
public class CreateMemberHandlerTests { }
```

**建议**：
"测试项目和类命名不符合 ADR-0110 规范：
- 测试项目应命名为 `{命名空间}.Tests`
- 测试类应命名为 `{被测类名}Tests`
请修正命名。"

---

## 三、CI 失败时，你应该如何解释？

### 失败场景 1：测试项目命名不规范

**CI 错误信息**：
```
ADR-0110.1: 测试项目应遵循命名约定
Failed: Project 'MembersTest' does not follow naming convention '{Namespace}.Tests'
Expected: Modules.Members.Tests
```

**人话翻译**：
"您的测试项目名称不符合规范。
- 当前项目名：MembersTest
- 应该命名为：Modules.Members.Tests

修复方法：
1. 重命名项目为 `Modules.Members.Tests`
2. 更新项目文件中的 `<RootNamespace>` 为 `Zss.BilliardHall.Tests.Modules.Members`
3. 确保目录结构与命名空间一致"

### 失败场景 2：测试文件未镜像源码结构

**CI 错误信息**：
```
ADR-0110.2: 单元测试应镜像源码目录结构
Failed: Test file 'AllMemberTests.cs' does not mirror source structure
Expected location: tests/Modules.Members.Tests/Features/CreateMember/CreateMemberHandlerTests.cs
```

**人话翻译**：
"测试文件位置不正确，应该镜像源码结构。

源码位置：
src/Modules/Members/Features/CreateMember/CreateMemberHandler.cs

测试应该在：
tests/Modules.Members.Tests/Features/CreateMember/CreateMemberHandlerTests.cs

修复方法：
1. 创建对应的目录结构
2. 将测试拆分为独立的测试类
3. 每个 Handler 对应一个测试类"

### 失败场景 3：架构测试未集中管理

**CI 错误信息**：
```
ADR-0110.3: 架构测试应集中在 ArchitectureTests 项目
Failed: Architecture test found in 'Modules.Members.Tests/ArchitectureTests/IsolationTests.cs'
All architecture tests must be in: tests/ArchitectureTests/
```

**人话翻译**：
"架构测试不应该分散在各模块的测试项目中。

当前位置（错误）：
tests/Modules.Members.Tests/ArchitectureTests/IsolationTests.cs

应该放在（正确）：
tests/ArchitectureTests/ADR/ADR_0001_Architecture_Tests.cs

修复方法：
1. 将所有架构测试移动到 `tests/ArchitectureTests/ADR/` 目录
2. 遵循 ADR 映射命名：`ADR_{编号:D4}_Architecture_Tests.cs`
3. 删除模块中的 ArchitectureTests 目录"

---

## 四、典型问答（FAQ）

### Q1: 为什么测试要镜像源码结构？

**A:** ADR-0110 要求测试镜像源码结构，带来以下好处：
1. **可发现性**：快速找到对应的测试文件
2. **一致性**：团队形成统一的心智模型
3. **可维护性**：源码重构时测试同步重构

示例：
```
源码：src/Modules/Members/Features/CreateMember/CreateMemberHandler.cs
测试：tests/Modules.Members.Tests/Features/CreateMember/CreateMemberHandlerTests.cs
```

### Q2: 架构测试为什么要集中管理？

**A:** 架构测试验证**全局性约束**，不属于特定模块：
- 集中管理便于统一维护
- 避免在各模块重复相同的架构测试
- 单一职责：专注于架构约束验证

所有架构测试都在 `tests/ArchitectureTests/` 项目中。

### Q3: 集成测试应该如何组织？

**A:** 根据 ADR-0110，集成测试按**业务场景**组织：
```
Integration.Tests/
└── Scenarios/
    ├── MemberRegistration/    # 会员注册场景
    └── OrderProcessing/       # 订单处理场景
```

不要按模块或技术层组织集成测试。

### Q4: 测试方法应该如何命名？

**A:** 使用 `{方法名}_{场景}_{预期结果}` 模式：
```csharp
// ✅ 正确的测试方法命名
[Fact]
public async Task Handle_ValidCommand_CreatesMember() { }

[Fact]
public async Task Handle_InvalidEmail_ThrowsException() { }

[Fact]
public async Task Handle_DuplicateEmail_ThrowsException() { }
```

方法名应该清晰描述测试场景和预期结果。

---

## 五、快速检查清单

### PR 前自检（测试组织）

- [ ] 每个测试项目命名遵循 `{命名空间}.Tests` 模式
- [ ] 单元测试文件镜像源码目录结构
- [ ] 测试类命名遵循 `{被测类名}Tests` 模式
- [ ] 架构测试集中在 `ArchitectureTests` 项目
- [ ] 架构测试类遵循 `ADR_{编号:D4}_Architecture_Tests` 命名
- [ ] 测试方法命名清晰描述场景和预期

### 创建新测试时

1. **确定测试类型**：单元测试 / 架构测试 / 集成测试
2. **确定位置**：
   - 单元测试：镜像源码结构
   - 架构测试：`ArchitectureTests/ADR/`
   - 集成测试：`Integration.Tests/Scenarios/`
3. **遵循命名约定**：项目名、类名、方法名
4. **运行测试**：确保新测试通过

---

## 六、相关 ADR 和文档

- [ADR-0110：测试目录组织规范](/docs/adr/structure/ADR-0110-test-directory-organization.md)
- [ADR-0000：架构测试与 CI 治理](/docs/adr/governance/ADR-0000-architecture-tests.md)
- [Testing Guide](/docs/TESTING-GUIDE.md)

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|------|------|---------|
| 1.0 | 2026-01-22 | 初始版本，配合 ADR-0110 创建 |
