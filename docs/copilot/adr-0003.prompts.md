# ADR-0003：命名空间与项目边界规范 - Copilot 提示词库

**关联 ADR**：[ADR-0003](../adr/ADR-0003-namespace-rules.md)  
**测试类**：`ADR_0003_Architecture_Tests.cs`  
**版本**：1.0  
**最后更新**：2026-01-21

---

## 一、当我在写什么时，你应该提醒我哪些 ADR-0003 约束？

### 场景 1：创建新项目

**触发条件**：
- 添加新的 .csproj 文件
- 在 src/ 下创建新目录

**你应该提醒的约束**：
```
✅ 检查清单：
1. 项目名称是否等于目录最后一级名称？
2. 是否遵循目录结构规范？
   - Platform/XXX
   - Application/XXX
   - Modules/XXX
   - Host/XXX
   - Tests/XXX
3. 是否没有手动设置 RootNamespace？
4. 是否依赖 Directory.Build.props 自动推导命名空间？

❌ 禁止：
- 项目名与目录名不一致
- 手动覆盖 BaseNamespace
- 在项目文件中设置 RootNamespace
- 使用 Common、Shared、Utils 等不规范名称
```

**标准项目文件模板**：
```xml
<!-- src/Modules/Orders/Orders.csproj -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <!-- ✅ 不要手动设置 RootNamespace -->
    <!-- ✅ 让 Directory.Build.props 自动推导 -->
  </PropertyGroup>
</Project>

<!-- 自动推导结果：Zss.BilliardHall.Modules.Orders -->
```

---

### 场景 2：编写代码时的命名空间

**触发条件**：
- 创建新的 C# 文件
- 需要声明命名空间

**你应该提醒的约束**：
```
✅ 命名空间规则：
1. 命名空间必须与目录结构一致
2. BaseNamespace 固定为 Zss.BilliardHall
3. 命名空间格式：BaseNamespace + 相对路径

示例：
文件路径：src/Modules/Orders/Domain/Order.cs
命名空间：Zss.BilliardHall.Modules.Orders.Domain

❌ 禁止：
- 命名空间与目录结构不一致
- 硬编码 Zss.BilliardHall
- 使用 Common、Shared、Utils
```

**标准命名空间模板**：
```csharp
// src/Modules/Orders/Domain/Order.cs
namespace Zss.BilliardHall.Modules.Orders.Domain;

public class Order { }

// ✅ 命名空间 = BaseNamespace + Modules.Orders.Domain
// ✅ 与目录结构完全一致
```

---

### 场景 3：引用其他项目

**触发条件**：
- 添加 ProjectReference
- 需要跨项目引用类型

**你应该提醒的约束**：
```
✅ 引用规则检查：
1. 是否遵循层级依赖规则？
   - Platform → 不依赖其他层
   - Application → 只依赖 Platform
   - Modules → 只依赖 Platform、BuildingBlocks
   - Host → 只依赖 Application、Platform
2. 命名空间引用是否正确？

❌ 禁止：
- 越界依赖（如 Platform 依赖 Modules）
- 模块间直接引用（Modules 间）
- 使用不存在的命名空间
```

---

### 场景 4：重命名项目或目录

**触发条件**：
- 重构项目结构
- 重命名目录或项目

**你应该提醒的约束**：
```
⚠️ 重命名影响：
1. 项目名必须与目录名同步更新
2. 命名空间会自动更新（由 Directory.Build.props 推导）
3. 所有引用该项目的地方需要更新

步骤：
1. 重命名目录
2. 重命名 .csproj 文件
3. 更新所有 ProjectReference
4. 运行架构测试验证

❌ 不要：
- 只改目录名不改项目名
- 只改项目名不改目录名
- 手动设置 RootNamespace "修复"不一致
```

---

## 二、哪些写法必须阻止？

### 反模式 1：手动覆盖 BaseNamespace

**❌ 错误示例**：
```xml
<!-- ❌ 不要在项目文件中设置 BaseNamespace -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <BaseNamespace>MyApp.Orders</BaseNamespace>
  </PropertyGroup>
</Project>
```

**✅ 正确做法**：
```xml
<!-- ✅ 依赖 Directory.Build.props 自动推导 -->
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net9.0</TargetFramework>
    <!-- 不设置任何命名空间属性 -->
  </PropertyGroup>
</Project>
```

---

### 反模式 2：命名空间与目录结构不一致

**❌ 错误示例**：
```csharp
// 文件路径：src/Modules/Orders/Domain/Order.cs
// ❌ 命名空间不匹配目录结构
namespace Zss.BilliardHall.Orders;

public class Order { }
```

**✅ 正确做法**：
```csharp
// 文件路径：src/Modules/Orders/Domain/Order.cs
// ✅ 命名空间与目录结构完全一致
namespace Zss.BilliardHall.Modules.Orders.Domain;

public class Order { }
```

---

### 反模式 3：使用不规范的命名

**❌ 错误示例**：
```
// ❌ 不规范的目录命名
src/
  Common/           ← 不允许
  Shared/           ← 不允许
  Utils/            ← 不允许
  Helpers/          ← 不允许
```

**✅ 正确做法**：
```
// ✅ 规范的目录命名
src/
  Platform/         ← 技术基座
  Application/      ← 应用层
  Modules/          ← 业务模块
    Orders/
    Members/
  BuildingBlocks/   ← 技术抽象
```

---

### 反模式 4：项目名与目录名不一致

**❌ 错误示例**：
```
// 目录：src/Modules/OrderManagement/
// 项目：Orders.csproj  ← ❌ 不一致
```

**✅ 正确做法**：
```
// 目录：src/Modules/Orders/
// 项目：Orders.csproj  ← ✅ 一致
```

---

## 三、CI 失败时，你应该如何解释？

### 失败消息：命名空间与目录不一致

**CI 输出示例**：
```
❌ Test Failed: Namespace_Should_Match_Directory_Structure
   Expected: Zss.BilliardHall.Modules.Orders.Domain
   Actual: Zss.BilliardHall.Orders
```

**你应该这样解释**：
```
根据 ADR-0003，命名空间必须与目录结构完全一致。

问题分析：
- 文件位于：src/Modules/Orders/Domain/Order.cs
- 期望命名空间：Zss.BilliardHall.Modules.Orders.Domain
- 实际命名空间：Zss.BilliardHall.Orders

修复建议：
1. 更新文件的命名空间声明
2. 确保命名空间 = BaseNamespace + 相对路径

修复示例：
// ❌ 错误
namespace Zss.BilliardHall.Orders;

// ✅ 正确
namespace Zss.BilliardHall.Modules.Orders.Domain;
```

---

### 失败消息：项目名与目录名不一致

**CI 输出示例**：
```
❌ Test Failed: Project_Name_Should_Match_Directory_Name
   Expected: Orders.csproj
   Actual: OrderManagement.csproj
   Directory: src/Modules/Orders/
```

**你应该这样解释**：
```
根据 ADR-0003，项目名必须与目录最后一级名称完全一致。

问题分析：
- 目录名：Orders
- 项目名：OrderManagement
- 两者不一致

修复建议：
1. 将项目文件重命名为 Orders.csproj
2. 更新所有 ProjectReference 引用
3. 运行架构测试验证

或者：
1. 将目录重命名为 OrderManagement
2. 同步更新命名空间
3. 运行架构测试验证

推荐使用第一种方案（重命名项目），因为目录名通常更符合业务语义。
```

---

### 失败消息：手动覆盖了 BaseNamespace

**CI 输出示例**：
```
❌ Test Failed: Should_Not_Override_BaseNamespace
   Expected: No BaseNamespace override
   Actual: Found BaseNamespace in Orders.csproj
```

**你应该这样解释**：
```
根据 ADR-0003，不允许在项目文件中手动设置 BaseNamespace。

问题分析：
- 项目文件中发现 <BaseNamespace> 设置
- 这会破坏自动推导机制

修复建议：
1. 删除项目文件中的 <BaseNamespace> 设置
2. 依赖 Directory.Build.props 自动推导
3. 如果命名空间不正确，检查目录结构是否符合规范

正确的推导规则：
- BaseNamespace: Zss.BilliardHall (统一定义)
- RootNamespace: BaseNamespace + 相对路径
- 示例：src/Modules/Orders/ → Zss.BilliardHall.Modules.Orders
```

---

### 失败消息：使用了不规范的命名

**CI 输出示例**：
```
❌ Test Failed: Should_Not_Use_Irregular_Names
   Expected: No Common/Shared/Utils directories
   Actual: Found 'src/Common/'
```

**你应该这样解释**：
```
根据 ADR-0003，不允许使用 Common、Shared、Utils 等不规范命名。

问题分析：
- 发现 src/Common/ 目录
- 这类命名通常导致代码组织混乱

修复建议：
1. 评估 Common 中的代码性质：
   - 技术性抽象 → 移到 Platform 或 BuildingBlocks
   - 业务性代码 → 移到具体的 Module
   - 跨模块共享 → 考虑是否违反了模块隔离原则

2. 删除 Common 目录

3. 更新所有引用

规范的组织方式：
✅ Platform/       ← 技术基座
✅ BuildingBlocks/ ← 技术抽象
✅ Modules/        ← 业务模块
❌ Common/         ← 不允许
❌ Shared/         ← 不允许
❌ Utils/          ← 不允许
```

---

## 四、典型问答（FAQ）

### Q1: 我想创建一个新的业务模块，应该如何组织目录和命名空间？

**A:**
遵循以下步骤：

1. **创建目录结构**：
   ```
   src/
     Modules/
       MyNewModule/        ← 模块名（业务能力）
         Domain/           ← 领域模型
         UseCases/         ← 用例
         Contracts/        ← 对外契约
         MyNewModule.csproj
   ```

2. **创建项目文件**（不设置任何命名空间属性）：
   ```xml
   <Project Sdk="Microsoft.NET.Sdk">
     <PropertyGroup>
       <TargetFramework>net9.0</TargetFramework>
     </PropertyGroup>
   </Project>
   ```

3. **编写代码时的命名空间**：
   ```csharp
   // src/Modules/MyNewModule/Domain/MyEntity.cs
   namespace Zss.BilliardHall.Modules.MyNewModule.Domain;
   
   public class MyEntity { }
   ```

4. **验证**：
   ```bash
   dotnet test src/tests/ArchitectureTests/
   ```

---

### Q2: 我的命名空间自动推导不正确，应该怎么办？

**A:**
检查以下几点：

1. **确认 Directory.Build.props 存在且正确**：
   ```xml
   <PropertyGroup>
     <BaseNamespace>Zss.BilliardHall</BaseNamespace>
   </PropertyGroup>
   ```

2. **确认目录结构符合规范**：
   - Platform/XXX
   - Application/XXX
   - Modules/XXX
   - Host/XXX

3. **确认项目名与目录名一致**：
   - 目录：src/Modules/Orders/
   - 项目：Orders.csproj

4. **删除项目文件中的手动设置**：
   ```xml
   <!-- ❌ 删除这些 -->
   <RootNamespace>...</RootNamespace>
   <BaseNamespace>...</BaseNamespace>
   ```

5. **重新构建并验证**：
   ```bash
   dotnet clean
   dotnet build
   ```

---

### Q3: 我可以在子目录中再创建子项目吗？

**A:**
可以，但要遵循规则：

**✅ 允许的结构**：
```
src/
  Modules/
    Orders/
      Orders.csproj              ← Zss.BilliardHall.Modules.Orders
      Infrastructure/
        Infrastructure.csproj    ← Zss.BilliardHall.Modules.Orders.Infrastructure
```

**命名空间自动推导**：
- Orders.csproj → Zss.BilliardHall.Modules.Orders
- Infrastructure.csproj → Zss.BilliardHall.Modules.Orders.Infrastructure

**注意**：
- 项目名必须与目录名一致
- 命名空间会自动包含完整路径

---

### Q4: 为什么不允许使用 Common、Shared 等命名？

**A:**
因为这类命名通常导致：

1. **职责不清**：
   - Common 是什么？技术？业务？
   - 所有人都往里扔代码

2. **依赖混乱**：
   - 所有项目都依赖 Common
   - 形成循环依赖

3. **架构腐化**：
   - 模块隔离被打破
   - 无法清晰划分边界

**正确做法**：
- 技术性代码 → Platform 或 BuildingBlocks
- 业务性代码 → 归属到具体的 Module
- 跨模块共享 → 通过 Contracts 或事件

---

## 五、快速检查清单

在提交 PR 前，请对照以下清单：

- [ ] 项目名是否等于目录最后一级名称？
- [ ] 命名空间是否与目录结构一致？
- [ ] 是否没有手动设置 BaseNamespace 或 RootNamespace？
- [ ] 是否没有使用 Common、Shared、Utils 等不规范命名？
- [ ] 目录结构是否符合规范（Platform/Application/Modules/Host/Tests）？
- [ ] 架构测试是否全部通过？

---

## 六、命名空间推导规则快速参考

| 目录路径 | 项目名 | 自动推导的命名空间 |
|---------|--------|-------------------|
| src/Platform/Logging/ | Logging.csproj | Zss.BilliardHall.Platform.Logging |
| src/Application/ | Application.csproj | Zss.BilliardHall.Application |
| src/Modules/Orders/ | Orders.csproj | Zss.BilliardHall.Modules.Orders |
| src/Host/Web/ | Web.csproj | Zss.BilliardHall.Host.Web |
| src/Tests/ArchitectureTests/ | ArchitectureTests.csproj | Zss.BilliardHall.Tests.ArchitectureTests |

---

## 七、相关资源

- [ADR-0003 完整文档](../adr/ADR-0003-namespace-rules.md)
- [架构测试类](../../src/tests/ArchitectureTests/ADR/ADR_0003_Architecture_Tests.cs)
- [Directory.Build.props](../../Directory.Build.props)

---

## 版本历史

| 版本 | 日期       | 变更说明 |
|------|------------|----------|
| 1.0  | 2026-01-21 | 初始版本 |
