# ADR-946 Copilot 提示词：ADR 标题级别即语义级别约束

**适用场景**：编写 ADR、编写 ADR 模板、开发 ADR 解析工具、验证脚本开发、架构文档评审

**权威依据**：[ADR-946 ADR 标题级别即语义级别约束](../adr/governance/ADR-946-adr-heading-level-semantic-constraint.md)

---

## ⚖️ 核心提醒

**ADR-946 的地位**：

- 📌 ADR 文档结构的语法规则
- 📌 机器解析的边界定义
- 📌 防止解析歧义和治理规则污染
- 📌 所有 ADR 解析工具的基础约束

**一句话定位**：

> **ADR 标题层级不是排版，而是语义边界。`##` 级别的标题是机器可裁决的语义块。**

---

## 场景 1：编写新的 ADR

### 用户意图

"我想创建一个新的 ADR，标题应该如何组织？"

### Copilot 必须做的

1. **检查标题层级是否符合语义边界**：
   ```
   标题级别语义规则（ADR-946 条款 1）：
   
   # - ADR 文档本体（每个文件必须且仅有一个）
   ## - 机器可裁决的一级语义块（如：决策、关系声明、执法模型）
   ### - 人类阅读的说明/细化（不被解析工具识别）
   #### - 示例/注释/非结构内容
   ```

2. **确认关键语义块使用正确的标题级别**：
   ```
   以下章节必须使用 ## 级别（ADR-946 条款 2）：
   
   - ## 关系声明（Relationships）
   - ## 决策（Decision）
   - ## 执法模型（Enforcement）
   - ## 术语表（Glossary）
   ```

3. **检查模板和示例是否造成解析歧义**：
   ```
   模板/示例中的标题必须（ADR-946 条款 3）：
   
   方式一：使用英文或占位符
   ```markdown
   ## Relationships Example
   ## 〈关系声明示例〉
   ```
   
   方式二：降低标题级别
   ```markdown
   ### 关系声明示例
   ```
   
   方式三：使用代码块且不含语义标题
   ```markdown
   示例格式：
   ```
   **依赖（Depends On）**：
   - [ADR-XXXX：标题](相对路径)
   ```
   ```
   ```

### 示例对话

**开发者**："我想在 ADR 中添加一个'如何使用'章节，应该用什么级别的标题？"

**Copilot**：
```
根据 ADR-946 标题级别语义约束：

1. **判断是否为机器可裁决的语义块**：
   - "如何使用"是人类阅读的指导内容
   - 不是机器解析的语义块
   - 不需要强制执行或自动验证

2. **推荐标题级别**：
   ```markdown
   ## 决策（Decision）
   
   ### 如何使用
   
   详细说明...
   ```
   
   或作为决策章节的子章节：
   ```markdown
   ## 决策（Decision）
   
   规则 1：...
   
   ### 使用指南
   
   步骤 1：...
   ```

3. **禁止**：
   ```markdown
   ❌ ## 如何使用
   ```
   原因：这会被解析工具误认为是一级语义块

参考：ADR-946 条款 1 标题级别语义表
```

---

## 场景 2：在 ADR 中包含模板或示例

### 用户意图

"我想在 ADR 中展示'关系声明'的示例格式，应该如何写？"

### Copilot 必须做的

1. **警告：直接使用 `## 关系声明` 会造成解析歧义**：
   ```
   ❌ 错误写法：
   
   以下是关系声明的示例：
   
   ```markdown
   ## 关系声明（Relationships）
   
   **依赖（Depends On）**：
   - [ADR-XXXX](路径)
   ```
   ```
   
   问题：
   - 解析工具会将示例中的 ## 关系声明 误认为实际的关系声明
   - 导致提取到错误的依赖关系
   - 可能引发自引用或循环依赖误报
   ```

2. **提供正确的三种方式**（ADR-946 条款 3）：

**方式一：使用英文或占位符标题**
```markdown
以下是关系声明的示例：

```markdown
## Relationships

**依赖（Depends On）**：
- [ADR-XXXX：标题](相对路径)
```
```

**方式二：降低标题级别**
```markdown
以下是关系声明的示例：

```markdown
### 关系声明示例

**依赖（Depends On）**：
- [ADR-XXXX：标题](相对路径)
```
```

**方式三：不使用标题，直接展示格式**
```markdown
关系声明格式示例：

```
**依赖（Depends On）**：
- [ADR-XXXX：标题](相对路径)

**被依赖（Depended By）**：
- [ADR-YYYY：标题](相对路径)
```
```

3. **推荐最佳实践**：
   ```
   最佳实践：方式一（使用英文标题）
   
   优点：
   - 清晰区分示例和实际内容
   - 解析工具可以明确识别
   - 保持层级结构一致
   
   示例：
   ```markdown
   ## 如何编写关系声明
   
   关系声明必须遵循以下格式：
   
   ```markdown
   ## Relationships
   
   **依赖（Depends On）**：
   - [ADR-XXXX：标题](../path/to/adr.md)
   ```
   ```
   ```

### 示例对话

**开发者**："我在 ADR-940 中写了关系声明的模板，但验证脚本报错说有自引用，为什么？"

**Copilot**：
```
根据 ADR-946 标题级别语义约束：

问题分析：
1. 你的 ADR 中可能有类似这样的内容：
   ```markdown
   ## 关系声明（Relationships）
   
   实际依赖...
   
   ## 如何使用关系声明
   
   模板示例：
   ```markdown
   ## 关系声明（Relationships）
   ...
   ```
   ```
   
2. 解析工具读取到两个 `## 关系声明`：
   - 第一个是实际的关系声明
   - 第二个是代码块中的示例
   
3. 解析工具无法区分，导致：
   - 提取到重复的关系声明
   - 可能引发自引用或依赖混乱

修复方案（ADR-946 条款 3）：

**方式一：使用英文标题**（推荐）
```markdown
## 如何使用关系声明

模板示例：

```markdown
## Relationships

**依赖（Depends On）**：
- [ADR-XXXX：标题](路径)
```
```

**方式二：降低标题级别**
```markdown
## 如何使用关系声明

模板示例：

```markdown
### 关系声明示例

**依赖（Depends On）**：
- [ADR-XXXX：标题](路径)
```
```

**方式三：不使用标题**
```markdown
## 如何使用关系声明

关系声明必须包含以下部分：

```
**依赖（Depends On）**：
- [ADR-XXXX：标题](路径)

**被依赖（Depended By）**：
- [ADR-YYYY：标题](路径)
```
```

验证：
修复后运行：`./scripts/verify-adr-heading-semantics.sh`

参考：
- ADR-946 条款 3 模板与示例的结构约束
- ADR-947 关系声明区的结构与解析安全规则
```

---

## 场景 3：开发 ADR 解析工具或验证脚本

### 用户意图

"我想开发一个脚本提取 ADR 的关系声明，应该如何解析？"

### Copilot 必须做的

1. **提醒遵守解析工具的语义边界**（ADR-946 条款 4）：
   ```
   解析工具必须遵守以下规则：
   
   1. 仅解析 ## 级别的标准语义块
   2. 忽略代码块内容
   3. 仅提取第一个匹配的 ## 语义块
   ```

2. **提供正确的解析模式**：

**正确的解析方式**：
```bash
# 方式一：锚定行首，精确匹配
sed -n '/^## 关系声明/,/^##/p' adr-file.md

# 方式二：使用正则精确匹配
grep -E '^## 关系声明（Relationships）$' adr-file.md

# 方式三：过滤代码块后再解析
awk '
/^```/ { in_code = !in_code; next }
!in_code && /^## 关系声明/ { print; in_section = 1; next }
!in_code && in_section && /^##/ { exit }
!in_code && in_section { print }
' adr-file.md
```

**错误的解析方式**：
```bash
# ❌ 错误：未锚定行首，会匹配 ###
sed -n '/## 关系声明/,/^##/p' adr-file.md

# ❌ 错误：未过滤代码块，会提取示例
grep -A 20 "## 关系声明" adr-file.md

# ❌ 错误：提取所有匹配，包括示例
sed -n '/## 关系声明/,/^##/p' adr-file.md | grep -v "^```"
```

3. **提供完整的解析脚本示例**：

```bash
#!/bin/bash
# extract-adr-relationships.sh

set -euo pipefail

ADR_FILE="$1"

# 函数：过滤代码块
filter_code_blocks() {
    awk '
    /^```/ {
        in_code = !in_code
        next
    }
    !in_code { print }
    '
}

# 函数：提取关系声明
extract_relationships() {
    local file="$1"
    
    # 过滤代码块后提取关系声明
    filter_code_blocks < "$file" | sed -n '
        /^## 关系声明（Relationships）$/, /^##/ {
            /^## 关系声明（Relationships）$/d
            /^##/q
            p
        }
    '
}

# 主逻辑
if [[ ! -f "$ADR_FILE" ]]; then
    echo "错误：文件不存在：$ADR_FILE" >&2
    exit 1
fi

# 提取关系声明
relationships=$(extract_relationships "$ADR_FILE")

if [[ -z "$relationships" ]]; then
    echo "警告：未找到关系声明" >&2
    exit 0
fi

echo "$relationships"
```

### 示例对话

**开发者**："我的脚本总是提取到代码块中的关系声明示例，应该如何修复？"

**Copilot**：
```
根据 ADR-946 解析工具的语义边界（条款 4）：

问题原因：
你的脚本没有过滤代码块（````markdown ... ````），导致：
- 提取到示例中的 ## 关系声明
- 误判为实际的依赖关系
- 引发虚假的自引用或循环依赖错误

修复方案：

**方法一：解析前过滤代码块**（推荐）
```bash
# 先过滤代码块，再提取关系声明
awk '
/^```/ { in_code = !in_code; next }
!in_code && /^## 关系声明（Relationships）/ { in_section = 1; next }
!in_code && in_section && /^##/ { exit }
!in_code && in_section { print }
' "$ADR_FILE"
```

**方法二：精确匹配行首**
```bash
# 锚定行首，避免匹配代码块内的标题
sed -n '/^## 关系声明（Relationships）$/,/^##/p' "$ADR_FILE" | \
    grep -v '^## 关系声明（Relationships）$' | \
    grep -v '^##'
```

**方法三：仅提取第一个匹配**
```bash
# 提取第一个 ## 关系声明，忽略后续的
sed -n '/^## 关系声明（Relationships）$/,/^##/ {
    /^## 关系声明（Relationships）$/d
    /^##/q
    p
}' "$ADR_FILE"
```

验证：
1. 测试解析包含模板的 ADR（如 ADR-940）
2. 确认不会提取到代码块中的示例
3. 运行完整的验证脚本套件

参考：
- ADR-946 条款 4 解析工具的语义边界
- ADR-947 关系声明区的结构与解析安全规则
```

---

## 场景 4：评审包含 ADR 文档的 PR

### 用户意图

"这个 PR 修改了 ADR 文档，应该检查哪些标题级别问题？"

### Copilot 必须做的

1. **检查标题层级是否符合语义规则**：
   ```
   检查清单（ADR-946 条款 1）：
   
   ✅ 每个 ADR 文件有且仅有一个 # 标题
   ✅ 关键语义块使用 ## 级别
   ✅ 说明性内容使用 ### 或更低级别
   ❌ 模板/示例使用与正文相同的 ## 标题
   ```

2. **检查关键语义块标题是否正确**（ADR-946 条款 2）：
   ```
   关键语义块检查：
   
   - [ ] 关系声明：`## 关系声明（Relationships）`
   - [ ] 决策：`## 决策（Decision）`
   - [ ] 执法模型：`## 执法模型（Enforcement）`
   - [ ] 术语表：`## 术语表（Glossary）`
   
   ❌ 禁止：
   - 使用不同的标题文字（如 `## 关系` 而非 `## 关系声明（Relationships）`）
   - 使用 ### 级别
   - 在代码块中使用相同的 ## 标题
   ```

3. **检查模板和示例是否造成解析歧义**（ADR-946 条款 3）：
   ```
   模板/示例检查：
   
   ✅ 正确：
   - 使用英文或占位符：`## Relationships Example`
   - 降低标题级别：`### 关系声明示例`
   - 不使用标题，直接展示格式
   
   ❌ 错误：
   - 代码块中使用 `## 关系声明（Relationships）`
   - 多个 ## 级别的同名语义块
   ```

4. **运行验证脚本**：
   ```bash
   # 检查标题语义
   ./scripts/verify-adr-heading-semantics.sh
   
   # 检查关系声明解析
   ./scripts/validate-three-way-mapping.sh
   ```

### 示例对话

**开发者**："这个 PR 在 ADR-952 中添加了模板示例，CI 报错说有解析歧义，应该如何修复？"

**Copilot**：
```
根据 ADR-946 标题级别语义约束：

检查问题：
1. 查看 PR diff，找到添加的模板示例
2. 检查是否在代码块中使用了 ## 级别的语义标题

常见问题模式：
```markdown
## 如何使用

模板格式：

```markdown
## 关系声明（Relationships）  ← 问题在这里

**依赖（Depends On）**：
- [ADR-XXXX](路径)
```
```

修复方案（选择一种）：

**方案一：使用英文标题**（推荐）
```markdown
## 如何使用

模板格式：

```markdown
## Relationships  ← 修改为英文

**依赖（Depends On）**：
- [ADR-XXXX](路径)
```
```

**方案二：降低标题级别**
```markdown
## 如何使用

模板格式：

```markdown
### 关系声明示例  ← 降为三级标题

**依赖（Depends On）**：
- [ADR-XXXX](路径)
```
```

**方案三：移除标题**
```markdown
## 如何使用

关系声明必须包含以下部分：

```
**依赖（Depends On）**：  ← 直接展示格式，无标题
- [ADR-XXXX](路径)
```
```

验证修复：
```bash
# 运行验证脚本
./scripts/verify-adr-heading-semantics.sh

# 检查关系声明提取
./scripts/extract-adr-relationships.sh docs/adr/governance/ADR-952-xxx.md
```

参考：
- ADR-946 条款 3 模板与示例的结构约束
```

---

## 常见误区

### 误区 1："标题级别只是排版问题"

❌ **错误理解**：
"我用 ## 还是 ### 无所谓，只要好看就行。"

✅ **正确理解**：
根据 ADR-946：
- 标题级别是语义边界，不是排版
- ## 级别的标题是机器可裁决的语义块
- 解析工具依赖标题级别识别语义块

**结论**：标题级别是 ADR 文档的语法规则，必须严格遵守。

---

### 误区 2："代码块中的标题不影响解析"

❌ **错误理解**：
"只要放在代码块里，解析工具就不会读取。"

✅ **正确理解**：
根据 ADR-946：
- 简单的解析工具（如 sed/grep）无法识别代码块
- 代码块中的 ## 标题会被误读为实际的语义块
- 必须过滤代码块或使用不同的标题格式

**结论**：代码块中的标题必须避免与正文语义块冲突。

---

### 误区 3："我的 ADR 不需要机器解析"

❌ **错误理解**：
"我的 ADR 不会被工具解析，可以随意写。"

✅ **正确理解**：
根据 ADR-946：
- 所有 ADR 都会被验证脚本解析
- 关系声明、术语表等会被自动提取
- 不符合规范的 ADR 会导致治理工具失效

**结论**：所有 ADR 必须遵守标题级别语义约束。

---

## 快速参考

### 标题级别语义表

| 标题级别   | 语义含义           | 机器可解析 | 裁决力 | 示例                    |
|--------|----------------|-------|-----|------------------------------|
| `#`    | ADR 文档本体      | ❌     | ❌   | `# ADR-0001：模块化单体架构`       |
| `##`   | 一级语义块（可裁决）    | ✅     | ✅   | `## 关系声明（Relationships）`    |
| `###`  | 人类阅读的说明/细化    | ❌     | ❌   | `### 使用指南`                  |
| `####` | 示例/注释/非结构内容   | ❌     | ❌   | `#### 代码示例`                 |

### 关键语义块标准标题

| 语义块  | 标准标题                        | 英文备选            |
|------|------------------------------|-------------------|
| 关系声明 | `## 关系声明（Relationships）`    | `## Relationships` |
| 决策   | `## 决策（Decision）`           | `## Decision`      |
| 执法模型 | `## 执法模型（Enforcement）`      | `## Enforcement`   |
| 术语表  | `## 术语表（Glossary）`          | `## Glossary`      |

### 模板示例的正确写法

| 场景        | 正确写法                   | 错误写法                        |
|-----------|------------------------|--------------------------------|
| 英文标题      | `## Relationships`     | `## 关系声明（Relationships）`     |
| 降级标题      | `### 关系声明示例`           | `## 关系声明示例`                   |
| 无标题       | 直接展示格式，不使用标题           | 使用与正文相同的 ## 标题               |

---

## 相关资源

- [ADR-946 ADR 标题级别即语义级别约束](../adr/governance/ADR-946-adr-heading-level-semantic-constraint.md)
- [ADR-947 关系声明区的结构与解析安全规则](../adr/governance/ADR-947-relationship-section-structure-parsing-safety.md)
- [ADR-940 ADR 关系与溯源管理宪法](../adr/governance/ADR-940-adr-relationship-traceability-management.md)
- [ADR-0008 文档编写与维护宪法](../adr/constitutional/ADR-0008-documentation-governance-constitution.md)

---

**版本**：1.0  
**最后更新**：2026-01-27  
**维护**：GitHub Copilot Team
