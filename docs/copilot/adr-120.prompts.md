# ADR-120：领域事件命名规范 - Copilot 提示词库

**关联 ADR**：[ADR-120](../adr/structure/ADR-120-domain-event-naming-convention.md)  
**测试类**：`ADR_120_Architecture_Tests.cs`  
**版本**：1.0  
**最后更新**：2026-01-24  
**对应 ADR 版本**：v1.2  
**对齐状态**：✅ 100% 完成

---

## 一、当我在写什么时，你应该提醒我哪些 ADR-120 约束？

### 场景 1：创建领域事件

**触发条件**：

- 在模块 Events 命名空间下创建新类型
- 定义事件描述业务事实

**你应该提醒的约束**：

```
✅ 检查清单：
1. 命名遵循 {AggregateRoot}{Action}Event 模式
2. 动词使用过去式（Created、Paid、Cancelled）
3. 包含 Event 后缀
4. 在 Zss.BilliardHall.Modules.{ModuleName}.Events 命名空间
5. 使用 record 定义
6. 只包含原始类型和 DTO
7. 不包含业务方法

❌ 禁止：
- 缺少 Event 后缀
- 使用现在时/进行时
- 包含领域实体
- 包含业务方法
- 嵌入跨模块语义
```

**标准模板**：

```csharp
namespace Zss.BilliardHall.Modules.Orders.Events;

public record OrderCreatedEvent(
    Guid OrderId,
    Guid MemberId,
    DateTime CreatedAt
);
```

---

### 场景 2：实现事件处理器

**触发条件**：

- 创建订阅事件的类
- 实现 IEventHandler<TEvent> 接口

**你应该提醒的约束**：

```
✅ 检查清单：
1. 类名以 Handler 后缀结尾
2. 实现 IEventHandler<TEvent>
3. 在 {ModuleName}.EventHandlers 命名空间
4. 多订阅场景使用扩展命名：{EventName}{Purpose}Handler

❌ 禁止：
- 使用 Processor、Service 后缀
- 命名与事件不对应
- Purpose 含糊不清（Handler1、Handler2）
```

**标准模板**：

```csharp
// 基础模式
namespace Zss.BilliardHall.Modules.Orders.EventHandlers;

public class OrderCreatedEventHandler : IEventHandler<OrderCreatedEvent>
{
    public async Task Handle(OrderCreatedEvent @event) { }
}

// 扩展模式（多订阅）
namespace Zss.BilliardHall.Modules.Members.EventHandlers;

public class OrderPaidEventAddPointsHandler : IEventHandler<OrderPaidEvent>
{
    public async Task Handle(OrderPaidEvent @event) { }
}
```

---

### 场景 3：发布领域事件

**触发条件**：

- 在 Handler 中发布事件
- 需要通知其他模块

**你应该提醒的约束**：

```
✅ 检查清单：
1. 只传递必要数据
2. 只传递原始类型和 DTO
3. 不传递领域实体
4. 发布者不关心订阅者

❌ 禁止：
- 事件包含领域实体
- 基于事件发布结果做业务决策
- 发布者等待订阅者响应
```

**标准模板**：

```csharp
// 发布事件
public class CreateOrderHandler
{
    public async Task Handle(CreateOrder command)
    {
        var order = new Order(command.MemberId, command.Items);
        await _repository.SaveAsync(order);
        
        await _eventBus.PublishAsync(new OrderCreatedEvent(
            order.Id,
            order.MemberId,
            DateTime.UtcNow
        ));
    }
}

// 订阅事件
public class OrderCreatedEventHandler : IEventHandler<OrderCreatedEvent>
{
    public async Task Handle(OrderCreatedEvent @event)
    {
        // 使用原始类型更新状态
        await _memberRepository.UpdateStatisticsAsync(@event.MemberId);
    }
}
```

---

### 场景 4：事件版本演进

**触发条件**：

- 需要修改现有事件结构
- 添加新字段

**你应该提醒的约束**：

```
✅ 检查清单：
1. 使用 V{N} 后缀标识新版本（从 V2 开始）
2. 提供版本转换适配器
3. 明确废弃策略

⚠️ 重要：类型版本 ≠ 序列化兼容性

❌ 禁止：
- 直接修改现有事件
- 不提供转换适配器
- 版本号不一致
```

**标准模板**：

```csharp
// V1（不带版本后缀）
public record OrderCreatedEvent(Guid OrderId, Guid MemberId, DateTime CreatedAt);

// V2
public record OrderCreatedEventV2(
    Guid OrderId,
    Guid MemberId,
    DateTime CreatedAt,
    string Source,
    string Channel
);

// 转换适配器
public class OrderCreatedEventAdapter
{
    public static OrderCreatedEventV2 ToV2(OrderCreatedEvent v1Event)
    {
        return new OrderCreatedEventV2(
            v1Event.OrderId,
            v1Event.MemberId,
            v1Event.CreatedAt,
            Source: "Unknown",
            Channel: "Web"
        );
    }
}
```

---

## 二、哪些写法必须阻止？

### 反模式 1：事件命名违规

**❌ 错误**：

```csharp
public record OrderCreated(Guid OrderId);  // 缺少 Event 后缀
public record OrderCreating(Guid OrderId);  // 进行时
public record OrderCreateEvent(Guid OrderId);  // 动词原形
public record OrderCreatedAndMemberPointsAddedEvent(...);  // 跨模块语义
```

**✅ 正确**：

```csharp
public record OrderCreatedEvent(Guid OrderId, Guid MemberId, DateTime CreatedAt);
public record OrderPaidEvent(Guid OrderId, decimal Amount, DateTime PaidAt);
```

**违反**：ADR-120.1, ADR-120.2

---

### 反模式 2：事件包含领域实体

**❌ 错误**：

```csharp
public record OrderCreatedEvent(Order Order, Member Member);  // 领域实体
```

**✅ 正确**：

```csharp
public record OrderCreatedEvent(
    Guid OrderId, Guid MemberId, DateTime CreatedAt,
    List<OrderItemDto> Items
);
public record OrderItemDto(string ProductId, int Quantity, decimal Price);
```

**违反**：ADR-120.5

---

### 反模式 3：事件包含业务方法

**❌ 错误**：

```csharp
public record OrderCreatedEvent(Guid OrderId, DateTime CreatedAt)
{
    public bool CanBeCancelled() => DateTime.UtcNow - CreatedAt < TimeSpan.FromHours(24);
}
```

**✅ 正确**：

```csharp
public record OrderCreatedEvent(Guid OrderId, DateTime CreatedAt);

// 业务逻辑在领域模型
public class Order
{
    public bool CanBeCancelled() => DateTime.UtcNow - CreatedAt < TimeSpan.FromHours(24);
}
```

**违反**：ADR-120.6

---

### 反模式 4：处理器命名不规范

**❌ 错误**：

```csharp
public class OrderCreatedProcessor { }  // 错误后缀
public class OrderEventHandler { }  // 命名不对应
public class OrderPaidEventHandler1 { }  // Purpose 不清晰
```

**✅ 正确**：

```csharp
public class OrderCreatedEventHandler : IEventHandler<OrderCreatedEvent> { }
public class OrderPaidEventAddPointsHandler : IEventHandler<OrderPaidEvent> { }
```

**违反**：ADR-120.4

---

### 反模式 5：错误的命名空间

**❌ 错误**：

```csharp
namespace Zss.BilliardHall.Events;  // 不在模块内
namespace Zss.BilliardHall.Modules.Orders.Domain.Events;  // 非标准
namespace Zss.BilliardHall.Shared.Events;  // 共享目录
```

**✅ 正确**：

```csharp
namespace Zss.BilliardHall.Modules.Orders.Events;
public record OrderCreatedEvent(Guid OrderId, Guid MemberId, DateTime CreatedAt);
```

**违反**：ADR-120.3

---

## 三、CI 失败时，你应该如何解释？

### ADR-120.1：Event_Types_Should_End_With_Event_Suffix

**失败原因**：事件类型缺少 'Event' 后缀

**修复**：
1. 重命名：`OrderCreated` → `OrderCreatedEvent`
2. 更新文件名和所有引用
3. 遵循模式：`{AggregateRoot}{Action}Event`

---

### ADR-120.2：Event_Names_Should_Use_Past_Tense_Verbs

**失败原因**：事件名称未使用动词过去式

**修复**：
1. 改为过去式：Creating → Created, Updating → Updated
2. 或使用明确过去式：Cancelled, Shipped, Paid
3. 记住：命令=原形（CreateOrder），事件=过去式（OrderCreatedEvent）

---

### ADR-120.3：Events_Should_Be_In_Events_Namespace

**失败原因**：事件不在正确命名空间

**修复**：
1. 移到 `Zss.BilliardHall.Modules.{ModuleName}.Events`
2. 更新文件路径与命名空间对应
3. 禁止：Domain.Events, Shared.Events

---

### ADR-120.4：Event_Handlers_Should_End_With_Handler_Suffix

**失败原因**：事件处理器缺少 'Handler' 后缀

**修复**：
1. 基础模式：`{EventName}Handler`
2. 扩展模式：`{EventName}{Purpose}Handler`
3. 禁止：Processor, Service 后缀

---

### ADR-120.5：Events_Should_Not_Contain_Domain_Entities

**失败原因**：事件包含领域实体类型

**修复**：
1. 用原始类型替换：`Guid OrderId` 替代 `Order` 对象
2. 用 DTO 替换：`OrderItemDto` 替代 `OrderItem` 实体
3. 事件应是数据快照，不包含行为

---

### ADR-120.6：Events_Should_Not_Contain_Business_Methods

**失败原因**：事件包含业务方法

**修复**：
1. 移除事件中所有方法
2. 判断逻辑移到领域模型
3. 协调逻辑移到 Handler

---

## 四、快速参考卡片

### 事件命名检查清单

创建或修改领域事件时，快速检查：

```
□ 事件名称遵循 {AggregateRoot}{Action}Event 模式
□ 动词使用过去式（Created、Paid、Cancelled）
□ 包含 Event 后缀
□ 在 Zss.BilliardHall.Modules.{ModuleName}.Events 命名空间
□ 文件路径与命名空间严格对应
□ 使用 record 定义（不可变）
□ 属性只包含原始类型、DTO，不包含领域实体
□ 不包含业务方法或判断逻辑
□ 事件处理器命名为 {EventName}Handler
□ 跨模块订阅仅通过事件，不直接依赖其他模块
```

### 常见错误速查表

| 错误模式 | 违反约束 | 正确做法 |
|---------|---------|---------|
| `OrderCreated` | ADR-120.1 | `OrderCreatedEvent` |
| `OrderCreating` | ADR-120.2 | `OrderCreatedEvent` |
| `OrderCreateEvent` | ADR-120.2 | `OrderCreatedEvent` |
| `Zss.BilliardHall.Modules.Orders.Domain` | ADR-120.3 | `Zss.BilliardHall.Modules.Orders.Events` |
| `OrderCreatedProcessor` | ADR-120.4 | `OrderCreatedEventHandler` |
| `Order Order` 属性 | ADR-120.5 | `Guid OrderId` |
| `CanBeCancelled()` 方法 | ADR-120.6 | 移到领域模型 |

### 命名模板

```csharp
// 事件定义模板
namespace Zss.BilliardHall.Modules.{ModuleName}.Events;

public record {AggregateRoot}{Action}Event(
    Guid {AggregateRoot}Id,
    // 其他原始类型属性
    DateTime {Action}At
);

// 事件处理器模板（基础模式）
namespace Zss.BilliardHall.Modules.{ModuleName}.EventHandlers;

public class {EventName}Handler : IEventHandler<{EventName}>
{
    public async Task Handle({EventName} @event)
    {
        // 处理逻辑
    }
}

// 事件处理器模板（扩展模式）
public class {EventName}{Purpose}Handler : IEventHandler<{EventName}>
{
    public async Task Handle({EventName} @event)
    {
        // 处理逻辑
    }
}
```

---

## 五、相关文档

- **ADR 正文**：[ADR-120](../adr/structure/ADR-120-domain-event-naming-convention.md)
- **架构测试**：`src/tests/ArchitectureTests/ADR/ADR_120_Architecture_Tests.cs`
- **相关 ADR**：
  - [ADR-001](../adr/constitutional/ADR-001-modular-monolith-vertical-slice-architecture.md) - 模块隔离和通信
  - [ADR-003](../adr/constitutional/ADR-003-namespace-rules.md) - 命名空间规范
  - [ADR-005](../adr/constitutional/ADR-005-Application-Interaction-Model-Final.md) - 事件通信机制
- **其他 Prompts**：
  - [ADR-001 提示词](adr-001.prompts.md) - 模块间通信
  - [ADR-005 提示词](adr-005.prompts.md) - Handler 规则

---

## 版本历史

| 版本 | 日期 | 变更说明 |
|-----|------|----------|
| 1.0 | 2026-01-24 | 初始版本，基于 ADR-120 v1.2 创建 |
